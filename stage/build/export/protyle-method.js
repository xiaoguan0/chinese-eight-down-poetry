(()=>{var Ri=(Et,Be)=>()=>(Be||Et((Be={exports:{}}).exports,Be),Be.exports);var Oi=Ri((Rt,pn)=>{(function(Be,ke){typeof Rt=="object"&&typeof pn=="object"?pn.exports=ke():typeof define=="function"&&define.amd?define([],ke):typeof Rt=="object"?Rt.Protyle=ke():Be.Protyle=ke()})(self,()=>(()=>{var Et={680:function(Ce){(function(J,ue){Ce.exports=ue()})(this,function(){"use strict";var J=1e3,ue=6e4,ot=36e5,Me="millisecond",ae="second",I="minute",M="hour",F="day",j="week",G="month",q="quarter",z="year",te="date",ye="Invalid Date",me=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,oe=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,Qe={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},re=function(K,R,N){var Z=String(K);return!Z||Z.length>=R?K:""+Array(R+1-Z.length).join(N)+K},xe={s:re,z:function(K){var R=-K.utcOffset(),N=Math.abs(R),Z=Math.floor(N/60),P=N%60;return(R<=0?"+":"-")+re(Z,2,"0")+":"+re(P,2,"0")},m:function K(R,N){if(R.date()<N.date())return-K(N,R);var Z=12*(N.year()-R.year())+(N.month()-R.month()),P=R.clone().add(Z,G),Q=N-P<0,X=R.clone().add(Z+(Q?-1:1),G);return+(-(Z+(N-P)/(Q?P-X:X-P))||0)},a:function(K){return K<0?Math.ceil(K)||0:Math.floor(K)},p:function(K){return{M:G,y:z,w:j,d:F,D:te,h:M,m:I,s:ae,ms:Me,Q:q}[K]||String(K||"").toLowerCase().replace(/s$/,"")},u:function(K){return K===void 0}},L="en",ve={};ve[L]=Qe;var lt=function(K){return K instanceof rt},Ye=function K(R,N,Z){var P;if(!R)return L;if(typeof R=="string"){var Q=R.toLowerCase();ve[Q]&&(P=Q),N&&(ve[Q]=N,P=Q);var X=R.split("-");if(!P&&X.length>1)return K(X[0])}else{var se=R.name;ve[se]=R,P=se}return!Z&&P&&(L=P),P||!Z&&L},pe=function(K,R){if(lt(K))return K.clone();var N=typeof R=="object"?R:{};return N.date=K,N.args=arguments,new rt(N)},le=xe;le.l=Ye,le.i=lt,le.w=function(K,R){return pe(K,{locale:R.$L,utc:R.$u,x:R.$x,$offset:R.$offset})};var rt=function(){function K(N){this.$L=Ye(N.locale,null,!0),this.parse(N)}var R=K.prototype;return R.parse=function(N){this.$d=function(Z){var P=Z.date,Q=Z.utc;if(P===null)return new Date(NaN);if(le.u(P))return new Date;if(P instanceof Date)return new Date(P);if(typeof P=="string"&&!/Z$/i.test(P)){var X=P.match(me);if(X){var se=X[2]-1||0,ce=(X[7]||"0").substring(0,3);return Q?new Date(Date.UTC(X[1],se,X[3]||1,X[4]||0,X[5]||0,X[6]||0,ce)):new Date(X[1],se,X[3]||1,X[4]||0,X[5]||0,X[6]||0,ce)}}return new Date(P)}(N),this.$x=N.x||{},this.init()},R.init=function(){var N=this.$d;this.$y=N.getFullYear(),this.$M=N.getMonth(),this.$D=N.getDate(),this.$W=N.getDay(),this.$H=N.getHours(),this.$m=N.getMinutes(),this.$s=N.getSeconds(),this.$ms=N.getMilliseconds()},R.$utils=function(){return le},R.isValid=function(){return this.$d.toString()!==ye},R.isSame=function(N,Z){var P=pe(N);return this.startOf(Z)<=P&&P<=this.endOf(Z)},R.isAfter=function(N,Z){return pe(N)<this.startOf(Z)},R.isBefore=function(N,Z){return this.endOf(Z)<pe(N)},R.$g=function(N,Z,P){return le.u(N)?this[Z]:this.set(P,N)},R.unix=function(){return Math.floor(this.valueOf()/1e3)},R.valueOf=function(){return this.$d.getTime()},R.startOf=function(N,Z){var P=this,Q=!!le.u(Z)||Z,X=le.p(N),se=function(We,he){var Pe=le.w(P.$u?Date.UTC(P.$y,he,We):new Date(P.$y,he,We),P);return Q?Pe:Pe.endOf(F)},ce=function(We,he){return le.w(P.toDate()[We].apply(P.toDate("s"),(Q?[0,0,0,0]:[23,59,59,999]).slice(he)),P)},de=this.$W,be=this.$M,Ae=this.$D,De="set"+(this.$u?"UTC":"");switch(X){case z:return Q?se(1,0):se(31,11);case G:return Q?se(1,be):se(0,be+1);case j:var qe=this.$locale().weekStart||0,Je=(de<qe?de+7:de)-qe;return se(Q?Ae-Je:Ae+(6-Je),be);case F:case te:return ce(De+"Hours",0);case M:return ce(De+"Minutes",1);case I:return ce(De+"Seconds",2);case ae:return ce(De+"Milliseconds",3);default:return this.clone()}},R.endOf=function(N){return this.startOf(N,!1)},R.$set=function(N,Z){var P,Q=le.p(N),X="set"+(this.$u?"UTC":""),se=(P={},P[F]=X+"Date",P[te]=X+"Date",P[G]=X+"Month",P[z]=X+"FullYear",P[M]=X+"Hours",P[I]=X+"Minutes",P[ae]=X+"Seconds",P[Me]=X+"Milliseconds",P)[Q],ce=Q===F?this.$D+(Z-this.$W):Z;if(Q===G||Q===z){var de=this.clone().set(te,1);de.$d[se](ce),de.init(),this.$d=de.set(te,Math.min(this.$D,de.daysInMonth())).$d}else se&&this.$d[se](ce);return this.init(),this},R.set=function(N,Z){return this.clone().$set(N,Z)},R.get=function(N){return this[le.p(N)]()},R.add=function(N,Z){var P,Q=this;N=Number(N);var X=le.p(Z),se=function(be){var Ae=pe(Q);return le.w(Ae.date(Ae.date()+Math.round(be*N)),Q)};if(X===G)return this.set(G,this.$M+N);if(X===z)return this.set(z,this.$y+N);if(X===F)return se(1);if(X===j)return se(7);var ce=(P={},P[I]=ue,P[M]=ot,P[ae]=J,P)[X]||1,de=this.$d.getTime()+N*ce;return le.w(de,this)},R.subtract=function(N,Z){return this.add(-1*N,Z)},R.format=function(N){var Z=this,P=this.$locale();if(!this.isValid())return P.invalidDate||ye;var Q=N||"YYYY-MM-DDTHH:mm:ssZ",X=le.z(this),se=this.$H,ce=this.$m,de=this.$M,be=P.weekdays,Ae=P.months,De=function(he,Pe,et,$e){return he&&(he[Pe]||he(Z,Q))||et[Pe].slice(0,$e)},qe=function(he){return le.s(se%12||12,he,"0")},Je=P.meridiem||function(he,Pe,et){var $e=he<12?"AM":"PM";return et?$e.toLowerCase():$e},We={YY:String(this.$y).slice(-2),YYYY:this.$y,M:de+1,MM:le.s(de+1,2,"0"),MMM:De(P.monthsShort,de,Ae,3),MMMM:De(Ae,de),D:this.$D,DD:le.s(this.$D,2,"0"),d:String(this.$W),dd:De(P.weekdaysMin,this.$W,be,2),ddd:De(P.weekdaysShort,this.$W,be,3),dddd:be[this.$W],H:String(se),HH:le.s(se,2,"0"),h:qe(1),hh:qe(2),a:Je(se,ce,!0),A:Je(se,ce,!1),m:String(ce),mm:le.s(ce,2,"0"),s:String(this.$s),ss:le.s(this.$s,2,"0"),SSS:le.s(this.$ms,3,"0"),Z:X};return Q.replace(oe,function(he,Pe){return Pe||We[he]||X.replace(":","")})},R.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},R.diff=function(N,Z,P){var Q,X=le.p(Z),se=pe(N),ce=(se.utcOffset()-this.utcOffset())*ue,de=this-se,be=le.m(this,se);return be=(Q={},Q[z]=be/12,Q[G]=be,Q[q]=be/3,Q[j]=(de-ce)/6048e5,Q[F]=(de-ce)/864e5,Q[M]=de/ot,Q[I]=de/ue,Q[ae]=de/J,Q)[X]||de,P?be:le.a(be)},R.daysInMonth=function(){return this.endOf(G).$D},R.$locale=function(){return ve[this.$L]},R.locale=function(N,Z){if(!N)return this.$L;var P=this.clone(),Q=Ye(N,Z,!0);return Q&&(P.$L=Q),P},R.clone=function(){return le.w(this.$d,this)},R.toDate=function(){return new Date(this.valueOf())},R.toJSON=function(){return this.isValid()?this.toISOString():null},R.toISOString=function(){return this.$d.toISOString()},R.toString=function(){return this.$d.toUTCString()},K}(),Oe=rt.prototype;return pe.prototype=Oe,[["$ms",Me],["$s",ae],["$m",I],["$H",M],["$W",F],["$M",G],["$y",z],["$D",te]].forEach(function(K){Oe[K[1]]=function(R){return this.$g(R,K[0],K[1])}}),pe.extend=function(K,R){return K.$i||(K(R,rt,pe),K.$i=!0),pe},pe.locale=Ye,pe.isDayjs=lt,pe.unix=function(K){return pe(1e3*K)},pe.en=ve[L],pe.Ls=ve,pe.p={},pe})},5:Ce=>{"use strict";function J(ae){if(typeof ae!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(ae))}function ue(ae,I){for(var M="",F=0,j=-1,G=0,q,z=0;z<=ae.length;++z){if(z<ae.length)q=ae.charCodeAt(z);else{if(q===47)break;q=47}if(q===47){if(!(j===z-1||G===1))if(j!==z-1&&G===2){if(M.length<2||F!==2||M.charCodeAt(M.length-1)!==46||M.charCodeAt(M.length-2)!==46){if(M.length>2){var te=M.lastIndexOf("/");if(te!==M.length-1){te===-1?(M="",F=0):(M=M.slice(0,te),F=M.length-1-M.lastIndexOf("/")),j=z,G=0;continue}}else if(M.length===2||M.length===1){M="",F=0,j=z,G=0;continue}}I&&(M.length>0?M+="/..":M="..",F=2)}else M.length>0?M+="/"+ae.slice(j+1,z):M=ae.slice(j+1,z),F=z-j-1;j=z,G=0}else q===46&&G!==-1?++G:G=-1}return M}function ot(ae,I){var M=I.dir||I.root,F=I.base||(I.name||"")+(I.ext||"");return M?M===I.root?M+F:M+ae+F:F}var Me={resolve:function(){for(var I="",M=!1,F,j=arguments.length-1;j>=-1&&!M;j--){var G;j>=0?G=arguments[j]:(F===void 0&&(F=process.cwd()),G=F),J(G),G.length!==0&&(I=G+"/"+I,M=G.charCodeAt(0)===47)}return I=ue(I,!M),M?I.length>0?"/"+I:"/":I.length>0?I:"."},normalize:function(I){if(J(I),I.length===0)return".";var M=I.charCodeAt(0)===47,F=I.charCodeAt(I.length-1)===47;return I=ue(I,!M),I.length===0&&!M&&(I="."),I.length>0&&F&&(I+="/"),M?"/"+I:I},isAbsolute:function(I){return J(I),I.length>0&&I.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var I,M=0;M<arguments.length;++M){var F=arguments[M];J(F),F.length>0&&(I===void 0?I=F:I+="/"+F)}return I===void 0?".":Me.normalize(I)},relative:function(I,M){if(J(I),J(M),I===M||(I=Me.resolve(I),M=Me.resolve(M),I===M))return"";for(var F=1;F<I.length&&I.charCodeAt(F)===47;++F);for(var j=I.length,G=j-F,q=1;q<M.length&&M.charCodeAt(q)===47;++q);for(var z=M.length,te=z-q,ye=G<te?G:te,me=-1,oe=0;oe<=ye;++oe){if(oe===ye){if(te>ye){if(M.charCodeAt(q+oe)===47)return M.slice(q+oe+1);if(oe===0)return M.slice(q+oe)}else G>ye&&(I.charCodeAt(F+oe)===47?me=oe:oe===0&&(me=0));break}var Qe=I.charCodeAt(F+oe),re=M.charCodeAt(q+oe);if(Qe!==re)break;Qe===47&&(me=oe)}var xe="";for(oe=F+me+1;oe<=j;++oe)(oe===j||I.charCodeAt(oe)===47)&&(xe.length===0?xe+="..":xe+="/..");return xe.length>0?xe+M.slice(q+me):(q+=me,M.charCodeAt(q)===47&&++q,M.slice(q))},_makeLong:function(I){return I},dirname:function(I){if(J(I),I.length===0)return".";for(var M=I.charCodeAt(0),F=M===47,j=-1,G=!0,q=I.length-1;q>=1;--q)if(M=I.charCodeAt(q),M===47){if(!G){j=q;break}}else G=!1;return j===-1?F?"/":".":F&&j===1?"//":I.slice(0,j)},basename:function(I,M){if(M!==void 0&&typeof M!="string")throw new TypeError('"ext" argument must be a string');J(I);var F=0,j=-1,G=!0,q;if(M!==void 0&&M.length>0&&M.length<=I.length){if(M.length===I.length&&M===I)return"";var z=M.length-1,te=-1;for(q=I.length-1;q>=0;--q){var ye=I.charCodeAt(q);if(ye===47){if(!G){F=q+1;break}}else te===-1&&(G=!1,te=q+1),z>=0&&(ye===M.charCodeAt(z)?--z===-1&&(j=q):(z=-1,j=te))}return F===j?j=te:j===-1&&(j=I.length),I.slice(F,j)}else{for(q=I.length-1;q>=0;--q)if(I.charCodeAt(q)===47){if(!G){F=q+1;break}}else j===-1&&(G=!1,j=q+1);return j===-1?"":I.slice(F,j)}},extname:function(I){J(I);for(var M=-1,F=0,j=-1,G=!0,q=0,z=I.length-1;z>=0;--z){var te=I.charCodeAt(z);if(te===47){if(!G){F=z+1;break}continue}j===-1&&(G=!1,j=z+1),te===46?M===-1?M=z:q!==1&&(q=1):M!==-1&&(q=-1)}return M===-1||j===-1||q===0||q===1&&M===j-1&&M===F+1?"":I.slice(M,j)},format:function(I){if(I===null||typeof I!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof I);return ot("/",I)},parse:function(I){J(I);var M={root:"",dir:"",base:"",ext:"",name:""};if(I.length===0)return M;var F=I.charCodeAt(0),j=F===47,G;j?(M.root="/",G=1):G=0;for(var q=-1,z=0,te=-1,ye=!0,me=I.length-1,oe=0;me>=G;--me){if(F=I.charCodeAt(me),F===47){if(!ye){z=me+1;break}continue}te===-1&&(ye=!1,te=me+1),F===46?q===-1?q=me:oe!==1&&(oe=1):q!==-1&&(oe=-1)}return q===-1||te===-1||oe===0||oe===1&&q===te-1&&q===z+1?te!==-1&&(z===0&&j?M.base=M.name=I.slice(1,te):M.base=M.name=I.slice(z,te)):(z===0&&j?(M.name=I.slice(1,q),M.base=I.slice(1,te)):(M.name=I.slice(z,q),M.base=I.slice(z,te)),M.ext=I.slice(q,te)),z>0?M.dir=I.slice(0,z-1):j&&(M.dir="/"),M},sep:"/",delimiter:":",win32:null,posix:null};Me.posix=Me,Ce.exports=Me}},Be={};function ke(Ce){var J=Be[Ce];if(J!==void 0)return J.exports;var ue=Be[Ce]={exports:{}};return Et[Ce].call(ue.exports,ue,ue.exports,ke),ue.exports}ke.d=(Ce,J)=>{for(var ue in J)ke.o(J,ue)&&!ke.o(Ce,ue)&&Object.defineProperty(Ce,ue,{enumerable:!0,get:J[ue]})},ke.o=(Ce,J)=>Object.prototype.hasOwnProperty.call(Ce,J);var kt={};return(()=>{"use strict";ke.d(kt,{default:()=>Pi});const Ce=(e,t)=>{if(document.getElementById(t))return!1;const n=new XMLHttpRequest;n.open("GET",e,!1),n.setRequestHeader("Accept","text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01"),n.send("");const s=document.createElement("script");s.type="text/javascript",s.text=n.responseText,s.id=t,document.head.appendChild(s)},J=(e,t)=>new Promise(n=>{if(document.getElementById(t))return n(!1),!1;const s=document.createElement("script");s.src=e,s.async=!0,document.head.appendChild(s),s.onload=()=>{if(document.getElementById(t))return s.remove(),n(!1),!1;s.id=t,n(!0)}}),ue=()=>!!document.getElementById("sidebar"),ot=()=>["docker","ios","android"].includes(window.siyuan.config.system.container)?window.siyuan.config.system.container:window.siyuan.config.system.os,Me=()=>window.navigator.userAgent.startsWith("SiYuan/")?"mobile":"browser-mobile",ae=()=>!document.getElementById("toolbar"),I=()=>"ontouchstart"in window&&navigator.maxTouchPoints>1,M=(e,t)=>e.length===t.length&&e.every(n=>t.includes(n)),F=(e,t)=>Math.floor(Math.random()*(t-e+1))+e,j=(e,t=window.location.search)=>{const n=t.substring(t.indexOf("?")),s=n.indexOf("#");return new URLSearchParams(n.substring(0,s>=0?s:void 0)).get(e)},G=()=>!0,q=e=>/^\(\(\d{14}-\w{7} '.*'\)\)$/.test(e),z=e=>/^<<assets\/.+\/\d{14}-\w{7} ".+">>$/.test(e),te=e=>/^[_a-zA-Z][_.\-0-9a-zA-Z]*$/.test(e),ye=e=>Function(`"use strict";return (${e})`)(),me=(e,t)=>{if(e===t||typeof e=="number"&&isNaN(e)&&typeof t=="number"&&isNaN(t))return!0;if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime();if(!e||!t||typeof e!="object"&&typeof t!="object")return e===t;if(e.prototype!==t.prototype)return!1;const n=Object.keys(e);return n.length!==Object.keys(t).length?!1:n.every(s=>me(e[s],t[s]))},oe="2.12.5",Qe="production",re=navigator.platform.toUpperCase().indexOf("MAC")>-1?"\u2303":"\u2325",xe=class{};let L=xe;L.SIYUAN_VERSION=oe,L.NODE_ENV=Qe,L.SIYUAN_APPID=Math.random().toString(36).substring(8),L.ASSETS_ADDRESS="https://assets.b3logfile.com/siyuan/",L.PROTYLE_CDN="/stage/protyle",L.UPLOAD_ADDRESS="/upload",L.SERVICE_WORKER_PATH="/service-worker.js",L.SIYUAN_DROP_FILE="application/siyuan-file",L.SIYUAN_DROP_GUTTER="application/siyuan-gutter",L.SIYUAN_DROP_TAB="application/siyuan-tab",L.SIYUAN_DROP_EDITOR="application/siyuan-editor",L.SIYUAN_CMD="siyuan-cmd",L.SIYUAN_GET="siyuan-get",L.SIYUAN_EVENT="siyuan-event",L.SIYUAN_CONFIG_TRAY="siyuan-config-tray",L.SIYUAN_QUIT="siyuan-quit",L.SIYUAN_HOTKEY="siyuan-hotkey",L.SIYUAN_INIT="siyuan-init",L.SIYUAN_SEND_WINDOWS="siyuan-send-windows",L.SIYUAN_SAVE_CLOSE="siyuan-save-close",L.SIYUAN_AUTO_LAUNCH="siyuan-auto-launch",L.SIYUAN_OPEN_WORKSPACE="siyuan-open-workspace",L.SIYUAN_OPEN_URL="siyuan-open-url",L.SIYUAN_OPEN_WINDOW="siyuan-open-window",L.SIYUAN_OPEN_FOLDER="siyuan-open-folder",L.SIYUAN_OPEN_FILE="siyuan-open-file",L.SIYUAN_EXPORT_PDF="siyuan-export-pdf",L.SIYUAN_EXPORT_NEWWINDOW="siyuan-export-newwindow",L.CUSTOM_SY_READONLY="custom-sy-readonly",L.CUSTOM_SY_FULLWIDTH="custom-sy-fullwidth",L.CUSTOM_REMINDER_WECHAT="custom-reminder-wechat",L.CUSTOM_RIFF_DECKS="custom-riff-decks",L.SIZE_SCROLL_TB=24,L.SIZE_SCROLL_STEP=256,L.SIZE_LINK_TEXT_MAX=24,L.SIZE_TOOLBAR_HEIGHT=ue()?0:32,L.SIZE_GET_MAX=102400,L.SIZE_UNDO=64,L.SIZE_TITLE=512,L.SIZE_EDITOR_WIDTH=760,L.SIZE_ZOOM=[.25,.33,.5,.67,.75,.8,.9,1,1.1,1.25,1.5,1.75,2,2.5,3],L.CB_MOVE_NOLIST="cb-move-nolist",L.CB_MOUNT_REMOVE="cb-mount-remove",L.CB_GET_APPEND="cb-get-append",L.CB_GET_BEFORE="cb-get-before",L.CB_GET_UNCHANGEID="cb-get-unchangeid",L.CB_GET_HL="cb-get-hl",L.CB_GET_FOCUS="cb-get-focus",L.CB_GET_FOCUSFIRST="cb-get-focusfirst",L.CB_GET_SETID="cb-get-setid",L.CB_GET_ALL="cb-get-all",L.CB_GET_BACKLINK="cb-get-backlink",L.CB_GET_UNUNDO="cb-get-unundo",L.CB_GET_SCROLL="cb-get-scroll",L.CB_GET_CONTEXT="cb-get-context",L.CB_GET_ROOTSCROLL="cb-get-rootscroll",L.CB_GET_HTML="cb-get-html",L.CB_GET_HISTORY="cb-get-history",L.LOCAL_ZOOM="local-zoom",L.LOCAL_SEARCHDATA="local-searchdata",L.LOCAL_SEARCHKEYS="local-searchkeys",L.LOCAL_SEARCHASSET="local-searchasset",L.LOCAL_DOCINFO="local-docinfo",L.LOCAL_DAILYNOTEID="local-dailynoteid",L.LOCAL_HISTORYNOTEID="local-historynoteid",L.LOCAL_CODELANG="local-codelang",L.LOCAL_FONTSTYLES="local-fontstyles",L.LOCAL_EXPORTPDF="local-exportpdf",L.LOCAL_EXPORTWORD="local-exportword",L.LOCAL_EXPORTIMG="local-exportimg",L.LOCAL_BAZAAR="local-bazaar",L.LOCAL_PDFTHEME="local-pdftheme",L.LOCAL_LAYOUTS="local-layouts",L.LOCAL_AI="local-ai",L.LOCAL_PLUGINTOPUNPIN="local-plugintopunpin",L.LOCAL_FLASHCARD="local-flashcard",L.LOCAL_FILEPOSITION="local-fileposition",L.LOCAL_DIALOGPOSITION="local-dialogposition",L.LOCAL_SESSION_FIRSTLOAD="local-session-firstload",L.DIALOG_OPENCARD="dialog-opencard",L.DIALOG_MAKECARD="dialog-makecard",L.DIALOG_VIEWCARDS="dialog-viewcards",L.DIALOG_DIALYNOTE="dialog-dialynote",L.DIALOG_RECENTDOCS="dialog-recentdocs",L.DIALOG_SWITCHTAB="dialog-switchtab",L.DIALOG_SEARCH="dialog-search",L.DIALOG_REPLACE="dialog-replace",L.DIALOG_GLOBALSEARCH="dialog-globalsearch",L.DIALOG_HISTORYCOMPARE="dialog-historycompare",L.DIALOG_ACCESSAUTHCODE="dialog-accessauthcode",L.DIALOG_AICUSTOMACTION="dialog-aicustomaction",L.DIALOG_AIUPDATECUSTOMACTION="dialog-aiupdatecustomaction",L.DIALOG_BACKGROUNDLINK="dialog-backgroundlink",L.DIALOG_BACKGROUNDRANDOM="dialog-backgroundrandom",L.DIALOG_CHANGELOG="dialog-changelog",L.DIALOG_COMMANDPANEL="dialog-commandpanel",L.DIALOG_DEACTIVATEUSER="dialog-deactivateuser",L.DIALOG_EMOJIS="dialog-emojis",L.DIALOG_EXPORTIMAGE="dialog-exportimage",L.DIALOG_EXPORTTEMPLATE="dialog-exporttemplate",L.DIALOG_EXPORTWORD="dialog-exportword",L.DIALOG_HISTORY="dialog-history",L.DIALOG_HISTORYDOC="dialog-historydoc",L.DIALOG_MOVEPATHTO="dialog-movepathto",L.DIALOG_RENAME="dialog-rename",L.DIALOG_RENAMEASSETS="dialog-renameassets",L.DIALOG_RENAMEBOOKMARK="dialog-renamebookmark",L.DIALOG_RENAMETAG="dialog-renametag",L.DIALOG_REPLACETYPE="dialog-replacetype",L.DIALOG_SAVECRITERION="dialog-savecriterion",L.DIALOG_SEARCHTYPE="dialog-searchtype",L.DIALOG_SEARCHASSETSTYPE="dialog-searchassetstype",L.DIALOG_SETTING="dialog-setting",L.DIALOG_SNAPSHOTTAG="dialog-snapshottag",L.DIALOG_SNAPSHOTMEMO="dialog-snapshotmemo",L.DIALOG_SNIPPETS="dialog-snippets",L.DIALOG_SYNCADDCLOUDDIR="dialog-syncaddclouddir",L.DIALOG_SYNCCHOOSEDIR="dialog-syncchoosedir",L.DIALOG_SYNCCHOOSEDIRECTION="dialog-syncchoosedirection",L.DIALOG_TRANSFERBLOCKREF="dialog-transferblockref",L.DIALOG_WECHATREMINDER="dialog-wechatreminder",L.DIALOG_PASSWORD="dialog-password",L.DIALOG_SETPASSWORD="dialog-setpassword",L.DIALOG_BOOTSYNCFAILED="dialog-bootsyncfailed",L.DIALOG_KERNELFAULT="dialog-kernelfault",L.DIALOG_STATEEXCEPTED="dialog-stateexcepted",L.DIALOG_ATTR="dialog-attr",L.DIALOG_SETCUSTOMATTR="dialog-setcustomattr",L.DIALOG_CREATENOTEBOOK="dialog-createnotebook",L.DIALOG_NOTEBOOKCONF="dialog-notebookconf",L.DIALOG_CREATEWORKSPACE="dialog-createworkspace",L.DIALOG_OPENWORKSPACE="dialog-openworkspace",L.DIALOG_SAVEWORKSPACE="dialog-saveworkspace",L.TIMEOUT_DBLCLICK=190,L.TIMEOUT_INPUT=256,L.TIMEOUT_LOAD=300,L.TIMEOUT_TRANSITION=300,L.TIMEOUT_COUNT=1e3,L.HELP_PATH={zh_CN:"20210808180117-czj9bvb",zh_CHT:"20211226090932-5lcq56f",en_US:"20210808180117-6v0mkxr",fr_FR:"20210808180117-6v0mkxr"},L.QUICK_DECK_ID="20230218211946-2kw8jgx",L.KEYCODELIST={8:"\u232B",9:"\u21E5",13:"\u21A9",16:"\u21E7",17:"\u2303",18:"\u2325",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"\u2190",38:"\u2191",39:"\u2192",40:"\u2193",44:"PrintScreen",45:"Insert",46:"\u2326",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"\u2318",92:"\u2318",93:"ContextMenu",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",182:"MyComputer",183:"MyCalculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},L.SIYUAN_KEYMAP={general:{mainMenu:{default:"\u2325\\",custom:"\u2325\\"},commandPanel:{default:"\u2325\u21E7P",custom:"\u2325\u21E7P"},editReadonly:{default:"\u21E7\u2318G",custom:"\u21E7\u2318G"},syncNow:{default:"F9",custom:"F9"},enterBack:{default:"\u2325\u2190",custom:"\u2325\u2190"},enter:{default:"\u2325\u2192",custom:"\u2325\u2192"},goForward:{default:"\u2318]",custom:"\u2318]"},goBack:{default:"\u2318[",custom:"\u2318["},newFile:{default:"\u2318N",custom:"\u2318N"},search:{default:"\u2318F",custom:"\u2318F"},globalSearch:{default:"\u2318P",custom:"\u2318P"},stickSearch:{default:"\u21E7\u2318F",custom:"\u21E7\u2318F"},replace:{default:"\u2318R",custom:"\u2318R"},closeTab:{default:"\u2318W",custom:"\u2318W"},fileTree:{default:re+"1",custom:re+"1"},outline:{default:re+"2",custom:re+"2"},bookmark:{default:re+"3",custom:re+"3"},tag:{default:re+"4",custom:re+"4"},dailyNote:{default:re+"5",custom:re+"5"},inbox:{default:re+"6",custom:re+"6"},backlinks:{default:re+"7",custom:re+"7"},graphView:{default:re+"8",custom:re+"8"},globalGraph:{default:re+"9",custom:re+"9"},riffCard:{default:re+"0",custom:re+"0"},config:{default:"\u2325P",custom:"\u2325P"},dataHistory:{default:"\u2325H",custom:"\u2325H"},toggleWin:{default:"\u2325M",custom:"\u2325M"},lockScreen:{default:"\u2325N",custom:"\u2325N"},recentDocs:{default:"\u2318E",custom:"\u2318E"},goToTab1:{default:"\u23181",custom:"\u23181"},goToTab2:{default:"\u23182",custom:"\u23182"},goToTab3:{default:"\u23183",custom:"\u23183"},goToTab4:{default:"\u23184",custom:"\u23184"},goToTab5:{default:"\u23185",custom:"\u23185"},goToTab6:{default:"\u23186",custom:"\u23186"},goToTab7:{default:"\u23187",custom:"\u23187"},goToTab8:{default:"\u23188",custom:"\u23188"},goToTab9:{default:"\u23189",custom:"\u23189"},goToTabNext:{default:"\u21E7\u2318]",custom:"\u21E7\u2318]"},goToTabPrev:{default:"\u21E7\u2318[",custom:"\u21E7\u2318["},goToEditTabNext:{default:"\u2303\u21E5",custom:"\u2303\u21E5"},goToEditTabPrev:{default:"\u2303\u21E7\u21E5",custom:"\u2303\u21E7\u21E5"},move:{default:"",custom:""},selectOpen1:{default:"",custom:""},toggleDock:{default:"",custom:""},splitLR:{default:"",custom:""},splitMoveR:{default:"",custom:""},splitTB:{default:"",custom:""},splitMoveB:{default:"",custom:""},closeOthers:{default:"",custom:""},closeAll:{default:"",custom:""},closeUnmodified:{default:"",custom:""},closeLeft:{default:"",custom:""},closeRight:{default:"",custom:""},tabToWindow:{default:"",custom:""}},editor:{general:{duplicate:{default:"\u2318D",custom:"\u2318D"},expandDown:{default:"\u2325\u21E7\u2193",custom:"\u2325\u21E7\u2193"},expandUp:{default:"\u2325\u21E7\u2191",custom:"\u2325\u21E7\u2191"},copyPlainText:{default:"",custom:""},copyID:{default:"",custom:""},copyProtocolInMd:{default:"",custom:""},netImg2LocalAsset:{default:"",custom:""},netAssets2LocalAssets:{default:"",custom:""},optimizeTypography:{default:"",custom:""},hLayout:{default:"",custom:""},vLayout:{default:"",custom:""},refPopover:{default:"",custom:""},copyText:{default:"",custom:""},exitFocus:{default:"",custom:""},switchReadonly:{default:"",custom:""},expand:{default:"\u2318\u2193",custom:"\u2318\u2193"},collapse:{default:"\u2318\u2191",custom:"\u2318\u2191"},insertBottom:{default:"\u2325\u2318.",custom:"\u2325\u2318."},refTab:{default:"\u21E7\u2318.",custom:"\u21E7\u2318."},openBy:{default:"\u2325,",custom:"\u2325,"},insertRight:{default:"\u2325.",custom:"\u2325."},attr:{default:"\u2325\u2318A",custom:"\u2325\u2318A"},quickMakeCard:{default:"\u2325\u2318F",custom:"\u2325\u2318F"},refresh:{default:"F5",custom:"F5"},copyBlockRef:{default:"\u21E7\u2318C",custom:"\u21E7\u2318C"},copyProtocol:{default:"\u21E7\u2318H",custom:"\u21E7\u2318H"},copyBlockEmbed:{default:"\u21E7\u2318E",custom:"\u21E7\u2318E"},copyHPath:{default:"\u21E7\u2318P",custom:"\u21E7\u2318P"},undo:{default:"\u2318Z",custom:"\u2318Z"},redo:{default:"\u2318Y",custom:"\u2318Y"},rename:{default:"F2",custom:"F2"},newNameFile:{default:"F3",custom:"F3"},newContentFile:{default:"F4",custom:"F4"},newNameSettingFile:{default:"\u2318F3",custom:"\u2318F3"},showInFolder:{default:"\u2325A",custom:"\u2325A"},outline:{default:"\u2325O",custom:"\u2325O"},backlinks:{default:"\u2325B",custom:"\u2325B"},graphView:{default:"\u2325G",custom:"\u2325G"},spaceRepetition:{default:"\u2325F",custom:"\u2325F"},fullscreen:{default:"\u2325Y",custom:"\u2325Y"},alignLeft:{default:"\u2325L",custom:"\u2325L"},alignCenter:{default:"\u2325C",custom:"\u2325C"},alignRight:{default:"\u2325R",custom:"\u2325R"},wysiwyg:{default:"\u2325\u23187",custom:"\u2325\u23187"},preview:{default:"\u2325\u23189",custom:"\u2325\u23189"},insertBefore:{default:"\u21E7\u2318B",custom:"\u21E7\u2318B"},insertAfter:{default:"\u21E7\u2318A",custom:"\u21E7\u2318A"},jumpToParentNext:{default:"\u21E7\u2318N",custom:"\u21E7\u2318N"},moveToUp:{default:"\u21E7\u2318\u2191",custom:"\u21E7\u2318\u2191"},moveToDown:{default:"\u21E7\u2318\u2193",custom:"\u21E7\u2318\u2193"}},insert:{appearance:{default:"\u2325\u2318X",custom:"\u2325\u2318X"},lastUsed:{default:"\u2325X",custom:"\u2325X"},ref:{default:"\u2325[",custom:"\u2325["},kbd:{default:"\u2318'",custom:"\u2318'"},sup:{default:"\u2318H",custom:"\u2318H"},sub:{default:"\u2318J",custom:"\u2318J"},bold:{default:"\u2318B",custom:"\u2318B"},"inline-math":{default:"\u2318M",custom:"\u2318M"},memo:{default:"\u2325\u2318M",custom:"\u2325\u2318M"},underline:{default:"\u2318U",custom:"\u2318U"},italic:{default:"\u2318I",custom:"\u2318I"},mark:{default:"\u2325D",custom:"\u2325D"},tag:{default:"\u2318T",custom:"\u2318T"},strike:{default:"\u21E7\u2318S",custom:"\u21E7\u2318S"},"inline-code":{default:"\u2318G",custom:"\u2318G"},link:{default:"\u2318K",custom:"\u2318K"},check:{default:"\u2318L",custom:"\u2318L"},table:{default:"\u2318O",custom:"\u2318O"},code:{default:"\u21E7\u2318K",custom:"\u21E7\u2318K"},clearInline:{default:"\u2318\\",custom:"\u2318\\"}},heading:{paragraph:{default:"\u2325\u23180",custom:"\u2325\u23180"},heading1:{default:"\u2325\u23181",custom:"\u2325\u23181"},heading2:{default:"\u2325\u23182",custom:"\u2325\u23182"},heading3:{default:"\u2325\u23183",custom:"\u2325\u23183"},heading4:{default:"\u2325\u23184",custom:"\u2325\u23184"},heading5:{default:"\u2325\u23185",custom:"\u2325\u23185"},heading6:{default:"\u2325\u23186",custom:"\u2325\u23186"}},list:{indent:{default:"\u21E5",custom:"\u21E5"},outdent:{default:"\u21E7\u21E5",custom:"\u21E7\u21E5"},checkToggle:{default:"\u2318\u21A9",custom:"\u2318\u21A9"}},table:{insertRowAbove:{default:"\u21E7\u2318T",custom:"\u21E7\u2318T"},insertRowBelow:{default:"\u21E7\u2318D",custom:"\u21E7\u2318D"},insertColumnLeft:{default:"\u21E7\u2318L",custom:"\u21E7\u2318L"},insertColumnRight:{default:"\u21E7\u2318R",custom:"\u21E7\u2318R"},moveToUp:{default:"\u2325\u2318T",custom:"\u2325\u2318T"},moveToDown:{default:"\u2325\u2318B",custom:"\u2325\u2318B"},moveToLeft:{default:"\u2325\u2318L",custom:"\u2325\u2318L"},moveToRight:{default:"\u2325\u2318R",custom:"\u2325\u2318R"},"delete-row":{default:"\u2318-",custom:"\u2318-"},"delete-column":{default:"\u21E7\u2318-",custom:"\u21E7\u2318-"}}},plugin:{}},L.SIYUAN_EMPTY_LAYOUT={hideDock:!1,layout:{direction:"tb",size:"0px",type:"normal",instance:"Layout",children:[{direction:"lr",size:"auto",type:"normal",instance:"Layout",children:[{direction:"tb",size:"0px",type:"left",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]},{direction:"lr",resize:"lr",size:"auto",type:"center",instance:"Layout",children:[{instance:"Wnd",children:[{instance:"Tab",children:[]}]}]},{direction:"tb",size:"0px",resize:"lr",type:"right",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]}]},{direction:"lr",size:"0px",resize:"tb",type:"bottom",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"lr",children:[]}]}]},bottom:{pin:!0,data:[]},left:{pin:!0,data:[[{type:"file",size:{width:227,height:0},show:!0,icon:"iconFiles",hotkeyLangId:"fileTree"},{type:"outline",size:{width:227,height:0},show:!1,icon:"iconAlignCenter",hotkeyLangId:"outline"},{type:"inbox",size:{width:320,height:0},show:!1,icon:"iconInbox",hotkeyLangId:"inbox"}],[{type:"bookmark",size:{width:227,height:0},show:!1,icon:"iconBookmark",hotkeyLangId:"bookmark"},{type:"tag",size:{width:227,height:0},show:!1,icon:"iconTags",hotkeyLangId:"tag"}]]},right:{pin:!0,data:[[{type:"graph",size:{width:320,height:0},show:!1,icon:"iconGraph",hotkeyLangId:"graphView"},{type:"globalGraph",size:{width:320,height:0},show:!1,icon:"iconGlobalGraph",hotkeyLangId:"globalGraph"}],[{type:"backlink",size:{width:320,height:0},show:!1,icon:"iconLink",hotkeyLangId:"backlinks"}]]}},L.SIYUAN_DEFAULT_REPLACETYPES={text:!0,imgText:!0,imgTitle:!0,imgSrc:!1,aText:!0,aTitle:!0,aHref:!1,code:!1,em:!0,strong:!0,inlineMath:!1,inlineMemo:!0,kbd:!0,mark:!0,s:!0,sub:!0,sup:!0,tag:!0,u:!0,docTitle:!0,codeBlock:!1,mathBlock:!1,htmlBlock:!1},L.SIYUAN_IMAGE_VIP=`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
<path fill="#ffd00f" d="M2.288 12.643l23.487 12.853c0.286 0.153 0.477 0.45 0.477 0.791 0 0.082-0.011 0.161-0.032 0.237l0.001-0.006c-0.119 0.395-0.479 0.678-0.905 0.678-0.004 0-0.009-0-0.013-0h-19.439c-0.958 0-1.766-0.684-1.885-1.595l-1.691-12.956z"></path>
<path fill="#ffd00f" d="M29.676 12.643l-1.691 12.957c-0.119 0.911-0.927 1.594-1.884 1.594h-19.442c-0.004 0-0.009 0-0.013 0-0.425 0-0.785-0.281-0.903-0.668l-0.002-0.007c-0.019-0.070-0.031-0.15-0.031-0.232 0-0.341 0.191-0.638 0.472-0.788l0.005-0.002 23.487-12.853z"></path>
<path fill="#ffe668" d="M15.413 8.369l10.394 15.921c0.378 0.579 0.407 1.317 0.076 1.924-0.328 0.591-0.948 0.985-1.66 0.985-0 0-0.001 0-0.001 0h-17.617c-0.694 0-1.331-0.378-1.661-0.985-0.144-0.26-0.229-0.569-0.229-0.899 0-0.382 0.114-0.736 0.31-1.033l-0.004 0.007 10.394-15.921z"></path>
<path fill="#ffdd4e" d="M15.396 8.403l11.659 15.921c0.401 0.579 0.432 1.317 0.081 1.924-0.361 0.594-1.005 0.985-1.741 0.985-0.008 0-0.017-0-0.025-0h-9.344l-0.63-18.83z"></path>
<path fill="#ffd00f" d="M13.868 6.478c0 0.946 0.767 1.712 1.712 1.712s1.712-0.767 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM28.577 10.818c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM0 10.822c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0z"></path>
</svg>`,L.SIYUAN_IMAGE_FILE="1f4c4",L.SIYUAN_IMAGE_NOTE="1f5c3",L.SIYUAN_IMAGE_FOLDER="1f4d1",L.SIYUAN_ASSETS_IMAGE=[".apng",".ico",".cur",".jpg",".jpe",".jpeg",".jfif",".pjp",".pjpeg",".png",".gif",".webp",".bmp",".svg",".avif"],L.SIYUAN_ASSETS_AUDIO=[".mp3",".wav",".ogg",".m4a"],L.SIYUAN_ASSETS_VIDEO=[".mov",".weba",".mkv",".mp4",".webm"],L.SIYUAN_ASSETS_EXTS=[".pdf"].concat(xe.SIYUAN_ASSETS_IMAGE).concat(xe.SIYUAN_ASSETS_AUDIO).concat(xe.SIYUAN_ASSETS_VIDEO),L.SIYUAN_ASSETS_SEARCH=[".txt",".md",".markdown",".docx",".xlsx",".pptx",".pdf",".json",".log",".sql",".html",".xml",".java",".h",".c",".cpp",".go",".rs",".swift",".kt",".py",".php",".js",".css",".ts",".sh",".bat",".cmd",".ini",".yaml",".rst",".adoc",".textile",".opml",".org",".wiki",".epub"],L.SIYUAN_CONFIG_APPEARANCE_DARK_CODE=["a11y-dark","agate","an-old-hope","androidstudio","arta","atom-one-dark","atom-one-dark-reasonable","base16/3024","base16/apathy","base16/apprentice","base16/ashes","base16/atelier-cave","base16/atelier-dune","base16/atelier-estuary","base16/atelier-forest","base16/atelier-heath","base16/atelier-lakeside","base16/atelier-plateau","base16/atelier-savanna","base16/atelier-seaside","base16/atelier-sulphurpool","base16/atlas","base16/bespin","base16/black-metal","base16/black-metal-bathory","base16/black-metal-burzum","base16/black-metal-dark-funeral","base16/black-metal-gorgoroth","base16/black-metal-immortal","base16/black-metal-khold","base16/black-metal-marduk","base16/black-metal-mayhem","base16/black-metal-nile","base16/black-metal-venom","base16/brewer","base16/bright","base16/brogrammer","base16/brush-trees-dark","base16/chalk","base16/circus","base16/classic-dark","base16/codeschool","base16/colors","base16/danqing","base16/darcula","base16/dark-violet","base16/darkmoss","base16/darktooth","base16/decaf","base16/default-dark","base16/dracula","base16/edge-dark","base16/eighties","base16/embers","base16/equilibrium-dark","base16/equilibrium-gray-dark","base16/espresso","base16/eva","base16/eva-dim","base16/flat","base16/framer","base16/gigavolt","base16/google-dark","base16/grayscale-dark","base16/green-screen","base16/gruvbox-dark-hard","base16/gruvbox-dark-medium","base16/gruvbox-dark-pale","base16/gruvbox-dark-soft","base16/hardcore","base16/harmonic16-dark","base16/heetch-dark","base16/helios","base16/hopscotch","base16/horizon-dark","base16/humanoid-dark","base16/ia-dark","base16/icy-dark","base16/ir-black","base16/isotope","base16/kimber","base16/london-tube","base16/macintosh","base16/marrakesh","base16/materia","base16/material","base16/material-darker","base16/material-palenight","base16/material-vivid","base16/mellow-purple","base16/mocha","base16/monokai","base16/nebula","base16/nord","base16/nova","base16/ocean","base16/oceanicnext","base16/onedark","base16/outrun-dark","base16/papercolor-dark","base16/paraiso","base16/pasque","base16/phd","base16/pico","base16/pop","base16/porple","base16/qualia","base16/railscasts","base16/rebecca","base16/ros-pine","base16/ros-pine-moon","base16/sandcastle","base16/seti-ui","base16/silk-dark","base16/snazzy","base16/solar-flare","base16/solarized-dark","base16/spacemacs","base16/summercamp","base16/summerfruit-dark","base16/synth-midnight-terminal-dark","base16/tango","base16/tender","base16/tomorrow-night","base16/twilight","base16/unikitty-dark","base16/vulcan","base16/windows-10","base16/windows-95","base16/windows-high-contrast","base16/windows-nt","base16/woodland","base16/xcode-dusk","base16/zenburn","codepen-embed","dark","devibeans","far","felipec","github-dark","github-dark-dimmed","gml","gradient-dark","hybrid","ir-black","isbl-editor-dark","kimbie-dark","lioshi","monokai","monokai-sublime","night-owl","nnfx-dark","nord","obsidian","panda-syntax-dark","paraiso-dark","pojoaque","qtcreator-dark","rainbow","shades-of-purple","srcery","stackoverflow-dark","sunburst","tomorrow-night-blue","tomorrow-night-bright","tokyo-night-dark","vs2015","xt256"],L.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE=["ant-design","a11y-light","arduino-light","ascetic","atom-one-light","base16/atelier-cave-light","base16/atelier-dune-light","base16/atelier-estuary-light","base16/atelier-forest-light","base16/atelier-heath-light","base16/atelier-lakeside-light","base16/atelier-plateau-light","base16/atelier-savanna-light","base16/atelier-seaside-light","base16/atelier-sulphurpool-light","base16/brush-trees","base16/classic-light","base16/cupcake","base16/cupertino","base16/default-light","base16/dirtysea","base16/edge-light","base16/equilibrium-gray-light","base16/equilibrium-light","base16/fruit-soda","base16/github","base16/google-light","base16/grayscale-light","base16/gruvbox-light-hard","base16/gruvbox-light-medium","base16/gruvbox-light-soft","base16/harmonic16-light","base16/heetch-light","base16/humanoid-light","base16/horizon-light","base16/ia-light","base16/material-lighter","base16/mexico-light","base16/one-light","base16/papercolor-light","base16/ros-pine-dawn","base16/sagelight","base16/shapeshifter","base16/silk-light","base16/solar-flare-light","base16/solarized-light","base16/summerfruit-light","base16/synth-midnight-terminal-light","base16/tomorrow","base16/unikitty-light","base16/windows-10-light","base16/windows-95-light","base16/windows-high-contrast-light","brown-paper","base16/windows-nt-light","color-brewer","docco","foundation","github","googlecode","gradient-light","grayscale","idea","intellij-light","isbl-editor-light","kimbie-light","lightfair","magula","mono-blue","nnfx-light","panda-syntax-light","paraiso-light","purebasic","qtcreator-light","routeros","school-book","stackoverflow-light","tokyo-night-light","vs","xcode","default"],L.ZWSP="\u200B",L.INLINE_TYPE=["block-ref","kbd","text","file-annotation-ref","a","strong","em","u","s","mark","sup","sub","tag","code","inline-math","inline-memo","clear"],L.BLOCK_HINT_KEYS=["((","[[","\uFF08\uFF08","\u3010\u3010"],L.BLOCK_HINT_CLOSE_KEYS={"((":"))","[[":"]]","\uFF08\uFF08":"\uFF09\uFF09","\u3010\u3010":"\u3011\u3011"},L.ALIAS_CODE_LANGUAGES=["js","ts","html","toml","c#","bat"],L.ANALYTICS_EVT_ON_GET_CONFIG="siyuan.onGetConfig";const ve=()=>`<div class="protyle-icons">
    <span aria-label="${window.siyuan.languages.edit}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>`,lt=(e,t=L.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="graphviz"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="graphviz"]')),n.length!==0&&J(`${t}/js/graphviz/viz.js?v=0.0.0`,"protyleGraphVizScript").then(()=>{n.forEach(s=>{if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",ve());const a=s.firstElementChild.nextElementSibling;try{const i=new Blob([`importScripts('${document.getElementById("protyleGraphVizScript").src.replace("viz.js","full.render.js")}');`],{type:"application/javascript"}),o=(window.URL||window.webkitURL).createObjectURL(i),r=new Worker(o);new Viz({worker:r}).renderSVGElement(Lute.UnEscapeHTMLStr(s.getAttribute("data-content"))).then(c=>{a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${L.ZWSP}</span><div contenteditable="false">${c.outerHTML}</div>`}).catch(c=>{a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${L.ZWSP}</span><div class="ft__error" contenteditable="false">graphviz render error: <br>${c}</div>`})}catch(i){console.error("Graphviz error",i)}s.setAttribute("data-render","true")})})},Ye=(e,t)=>{if(!e)return!1;e.nodeType===3&&(e=e.parentElement);let n=e,s=!1;for(;n&&!s&&!n.classList.contains("b3-typography");)n.nodeName.indexOf(t)===0?s=!0:n=n.parentElement;return s&&n},pe=(e,t,n=!1)=>{let s=N(e,t,n),a=!1,i=!1;for(;s&&(n?s.tagName!=="BODY":!s.classList.contains("protyle-wysiwyg"))&&!i;)a=N(s.parentElement,t,n),a?s=a:i=!0;return s||!1},le=(e,t)=>{let n=Ye(e,t),s=!1,a=!1;for(;n&&!n.classList.contains("protyle-wysiwyg")&&!a;)s=Ye(n.parentElement,t),s?n=s:a=!0;return n||!1},rt=(e,t,n,s=!1)=>{let a=Oe(e,t,n,s),i=!1,l=!1;for(;a&&!a.classList.contains("protyle-wysiwyg")&&!l;)i=Oe(a.parentElement,t,n,s),i?a=i:l=!0;return a||!1},Oe=(e,t,n,s=!1)=>{var a;if(!e)return!1;e.nodeType===3&&(e=e.parentElement);let i=e,l=!1;for(;i&&!l&&(s?i.tagName!=="BODY":!i.classList.contains("protyle-wysiwyg"));)typeof n=="string"&&((a=i.getAttribute(t))!=null&&a.split(" ").includes(n))||typeof n!="string"&&i.hasAttribute(t)?l=!0:i=i.parentElement;return l&&i},K=e=>{var t;const n=Oe(e,"data-node-id",null);return n&&n.tagName!=="BUTTON"&&((t=n.getAttribute("data-type"))!=null&&t.startsWith("Node"))?n:!1},R=(e,t)=>{if(!e)return!1;e.nodeType===3&&(e=e.parentElement);let n=e,s=!1;for(;n&&!s&&!n.classList.contains("protyle-wysiwyg");)n.nodeName===t?s=!0:n=n.parentElement;return s&&n},N=(e,t,n=!1)=>{var s;if(!e)return!1;e.nodeType===3&&(e=e.parentElement);let a=e,i=!1;for(;a&&!i&&(n?a.tagName!=="BODY":!a.classList.contains("protyle-wysiwyg"));)(s=a.classList)!=null&&s.contains(t)?i=!0:a=a.parentElement;return i&&a},Z=e=>{let t=e;for(;t;){if(t.previousElementSibling&&t.previousElementSibling.getAttribute("data-node-id"))return t.previousElementSibling;const n=K(t.parentElement);if(n)t=n;else return!1}},P=e=>{let t;return Array.from(e.querySelectorAll("[data-node-id]")).reverse().find(n=>{if(!hasClosestByAttribute(n.parentElement,"data-type","NodeBlockQueryEmbed"))return t=n,!0}),t||e},Q=e=>{let t;return Array.from(e.querySelectorAll("[data-node-id]")).find(n=>{if(!hasClosestByAttribute(n.parentElement,"data-type","NodeBlockQueryEmbed")&&!n.classList.contains("li")&&!n.classList.contains("sb"))return t=n,!0}),t||e},X=e=>{let t=e;for(;t;){if(t.nextElementSibling&&!t.nextElementSibling.classList.contains("protyle-attr"))return t.nextElementSibling;const n=K(t.parentElement);if(n)t=n;else return!1}return!1},se=e=>{let t=e;for(;t;)if(t.classList.contains("list")||t.classList.contains("li")||t.classList.contains("bq")||t.classList.contains("sb"))t=t.querySelector("[data-node-id]");else return t;return!1},ce=e=>!e||e.getAttribute("contenteditable")==="true"&&!e.classList.contains("protyle-wysiwyg")?e:e.querySelector('[contenteditable="true"]'),de=e=>["NodeBlockQueryEmbed","NodeThematicBreak","NodeMathBlock","NodeHTMLBlock","NodeIFrame","NodeWidget","NodeVideo","NodeAudio"].includes(e.getAttribute("data-type"))||e.getAttribute("data-type")==="NodeCodeBlock"&&e.classList.contains("render-node"),be=e=>{var t,n;let s=e;for(;s.parentElement&&!s.parentElement.classList.contains("protyle-wysiwyg");)if(!s.parentElement.getAttribute("data-node-id"))s=s.parentElement;else{let a=!1;if(Array.from(s.parentElement.querySelectorAll('[contenteditable="true"]')).find(i=>{if(i.textContent.replace(Constants.ZWSP,"").replace(`
`,"")!=="")return a=!0,!0}),a||(t=s.previousElementSibling)!=null&&t.getAttribute("data-node-id")||(n=s.nextElementSibling)!=null&&n.getAttribute("data-node-id"))break;s=s.parentElement}return s},Ae=e=>{if(e.parentElement.getAttribute("data-type")==="NodeBlockquote"&&e.parentElement.childElementCount===2)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeBlockquote"&&e.parentElement.childElementCount===2)e=e.parentElement;else{e=Ae(e);break}else if(e.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&e.parentElement.childElementCount===2)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&e.parentElement.childElementCount===2)e=e.parentElement;else{e=Ae(e);break}else if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&e.parentElement.childElementCount===3)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&e.parentElement.childElementCount===3)e=e.parentElement;else if(e.parentElement.getAttribute("data-type")==="NodeList"&&e.parentElement.childElementCount===2)e=e.parentElement;else{e=Ae(e);break}else if(e.parentElement.getAttribute("data-type")==="NodeList"&&e.parentElement.childElementCount===2)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeList"&&e.parentElement.childElementCount===2)e=e.parentElement;else if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&e.parentElement.childElementCount===3)e=e.parentElement;else{e=Ae(e);break}return e},De=e=>{let t=e.nextSibling;for(;t;)if(t.textContent===""&&t.nodeType===3)t=t.nextSibling;else return t;return!1},qe=e=>{let t=e.previousSibling;for(;t;)if(t.textContent===""&&t.nodeType===3)t=t.previousSibling;else return t;return!1},Je=e=>{let t=e.nextElementSibling;if(t)return t.tagName==="LI"?t:t.tagName==="UL"?t.firstElementChild:!1;for(t=e.parentElement;t.tagName==="UL";)if(!t.nextElementSibling)t=t.parentElement;else{if(t.nextElementSibling.tagName==="LI")return t.nextElementSibling;if(t.nextElementSibling.tagName==="UL")return t.nextElementSibling.firstElementChild}return!1},We=e=>{let t=e.previousElementSibling;if(t)return t.tagName==="LI"?t:t.tagName==="UL"?t.lastElementChild:!1;for(t=e.parentElement;t.tagName==="UL";)if(!t.previousElementSibling)t=t.parentElement;else{if(t.previousElementSibling.tagName==="LI")return t.previousElementSibling;if(t.previousElementSibling.tagName==="UL"){const n=t.previousElementSibling.querySelectorAll(".b3-list-item");return n[n.length-1]}}return!1},he=()=>([1e7].toString()+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(parseInt(e,10)^window.crypto.getRandomValues(new Uint32Array(1))[0]&15>>parseInt(e,10)/4).toString(16)),Pe=()=>{const e=document.getElementById("message");e.innerHTML=`<div class="fn__flex-1"></div>
<button class="b3-button--cancel b3-button b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.clearMessage}"><svg style="margin-right: 0"><use xlink:href="#iconSelect"></use></svg></button>`,e.addEventListener("click",t=>{let n=t.target;for(;n&&!n.isEqualNode(e);){if(n.classList.contains("b3-snackbar__close")){$e(n.parentElement.getAttribute("data-id")),t.preventDefault();break}else if(n.isSameNode(e.lastElementChild)){n.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{n.parentElement.firstElementChild.innerHTML=""},Constants.TIMEOUT_INPUT),t.preventDefault();break}else{if(n.tagName==="A"||n.tagName==="BUTTON")break;if(n.classList.contains("b3-snackbar")){$e(n.getAttribute("data-id")),t.preventDefault(),t.stopPropagation();break}}n=n.parentElement}})},et=(e,t=6e3,n="info",s)=>{const a=document.getElementById("message").firstElementChild;if(!a){alert(e);return}const i=s||he(),l=a.querySelector(`.b3-snackbar[data-id="${i}"]`),o=e+(n==="error"?" v"+L.SIYUAN_VERSION:"");if(l){if(window.clearTimeout(parseInt(l.getAttribute("data-timeoutid"))),l.innerHTML=`<div class="b3-snackbar__content${t===0?" b3-snackbar__content--close":""}">${o}</div>${t===0?'<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>':""}`,n==="error"?l.classList.add("b3-snackbar--error"):l.classList.remove("b3-snackbar--error"),t>0){const c=window.setTimeout(()=>{$e(i)},t);l.setAttribute("data-timeoutid",c.toString())}return}let r=`<div data-id="${i}" class="b3-snackbar--hide b3-snackbar${n==="error"?" b3-snackbar--error":""}"><div class="b3-snackbar__content${t===0?" b3-snackbar__content--close":""}">${o}</div>`;if(t===0)r+='<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>';else if(t!==-1){const c=window.setTimeout(()=>{$e(i)},t);r=r.replace("<div data-id",`<div data-timeoutid="${c}" data-id`)}return a.parentElement.classList.add("b3-snackbars--show"),a.insertAdjacentHTML("afterbegin",r+"</div>"),setTimeout(()=>{a.querySelectorAll(".b3-snackbar--hide").forEach(c=>{c.classList.remove("b3-snackbar--hide")})}),a.firstElementChild.nextElementSibling&&a.firstElementChild.nextElementSibling.innerHTML===a.firstElementChild.innerHTML&&a.firstElementChild.nextElementSibling.remove(),a.scrollTo({top:0,behavior:"smooth"}),i},$e=e=>{const t=document.getElementById("message").firstElementChild;if(t)if(e){const n=t.querySelector(`[data-id="${e}"]`);n&&(n.classList.add("b3-snackbar--hide"),setTimeout(()=>{n.remove(),t.childElementCount===0&&$e()},L.TIMEOUT_INPUT));let s=!1;Array.from(t.children).find(a=>{if(!a.classList.contains("b3-snackbar--hide"))return s=!0,!0}),s?t.parentElement.classList.add("b3-snackbars--show"):t.parentElement.classList.remove("b3-snackbars--show")}else t.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{t.innerHTML=""},L.TIMEOUT_INPUT)};var Ta=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const qi=e=>{e&&(window.siyuan.config.system.container==="ios"?window.location.href=e:Ct()?window.JSAndroid.openExternal(e):window.open(e))},Fi=()=>Ct()?window.JSAndroid.readClipboard():navigator.clipboard.readText(),Ia=e=>{let t;getSelection().rangeCount>0&&(t=getSelection().getRangeAt(0).cloneRange());try{if(Ct()){window.JSAndroid.writeClipboard(e);return}if(Ot()){window.webkit.messageHandlers.setClipboard.postMessage(e);return}navigator.clipboard.writeText(e)}catch(n){if(Ot())window.webkit.messageHandlers.setClipboard.postMessage(e);else if(Ct())window.JSAndroid.writeClipboard(e);else{const s=document.createElement("textarea");s.value=e,s.style.position="fixed",document.body.appendChild(s),s.focus(),s.select(),document.execCommand("copy"),document.body.removeChild(s),t&&focusByRange(t)}}},Yi=e=>Ta(void 0,null,function*(){e=e.replace(new RegExp(Constants.ZWSP,"g"),""),yield Ia(e)}),Wi=()=>Da()?"touchstart":"click",ji=e=>mn()?!!(e.metaKey&&!e.ctrlKey):!!(!e.metaKey&&e.ctrlKey),Ma=e=>!e.metaKey&&!e.ctrlKey,Ui=()=>window.siyuan.config.system.osPlatform.toLowerCase().indexOf("huawei")>-1,Da=()=>navigator.userAgent.indexOf("iPhone")>-1,Vi=()=>navigator.userAgent.indexOf("iPad")>-1,mn=()=>navigator.platform.toUpperCase().indexOf("MAC")>-1,Ct=()=>window.siyuan.config.system.container==="android"&&window.JSAndroid,Ot=()=>{var e;return window.siyuan.config.system.container==="ios"&&((e=window.webkit)==null?void 0:e.messageHandlers)},Gi=e=>{if(mn())return e;const t=new Map(Object.entries({"\u2318":"Ctrl","\u2303":"Ctrl","\u21E7":"Shift","\u2325":"Alt","\u21E5":"Tab","\u232B":"Backspace","\u2326":"Delete","\u21A9":"Enter"})),n=[];(e.indexOf("\u2318")>-1||e.indexOf("\u2303")>-1)&&n.push(t.get("\u2318")),e.indexOf("\u21E7")>-1&&n.push(t.get("\u21E7")),e.indexOf("\u2325")>-1&&n.push(t.get("\u2325"));const s=e.replace(/⌘|⇧|⌥|⌃/g,"");return s&&n.push(t.get(s)||s),n.join("+")},zi=e=>{fetchPost("/api/storage/getLocalStorage",void 0,t=>{window.siyuan.storage=t.data;const n={};n[Constants.LOCAL_SEARCHASSET]={keys:[],col:"",row:"",layout:0,method:0,types:{},sort:0,k:""},Constants.SIYUAN_ASSETS_SEARCH.forEach(s=>{n[Constants.LOCAL_SEARCHASSET].types[s]=!0}),n[Constants.LOCAL_SEARCHKEYS]={keys:[],replaceKeys:[],col:"",row:"",layout:0,colTab:"",rowTab:"",layoutTab:0},n[Constants.LOCAL_PDFTHEME]={light:"light",dark:"dark",annoColor:"var(--b3-pdf-background1)"},n[Constants.LOCAL_LAYOUTS]=[],n[Constants.LOCAL_AI]=[],n[Constants.LOCAL_PLUGINTOPUNPIN]=[],n[Constants.LOCAL_FILEPOSITION]={},n[Constants.LOCAL_DIALOGPOSITION]={},n[Constants.LOCAL_FLASHCARD]={fullscreen:!1},n[Constants.LOCAL_BAZAAR]={theme:"0",template:"0",icon:"0",widget:"0"},n[Constants.LOCAL_EXPORTWORD]={removeAssets:!1,mergeSubdocs:!1},n[Constants.LOCAL_EXPORTPDF]={landscape:!1,marginType:"0",scale:1,pageSize:"A4",removeAssets:!0,keepFold:!1,mergeSubdocs:!1,watermark:!1},n[Constants.LOCAL_EXPORTIMG]={keepFold:!1,watermark:!1},n[Constants.LOCAL_DOCINFO]={id:""},n[Constants.LOCAL_FONTSTYLES]=[],n[Constants.LOCAL_SEARCHDATA]={page:1,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock},replaceTypes:Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)},n[Constants.LOCAL_ZOOM]=1,[Constants.LOCAL_EXPORTIMG,Constants.LOCAL_SEARCHKEYS,Constants.LOCAL_PDFTHEME,Constants.LOCAL_BAZAAR,Constants.LOCAL_EXPORTWORD,Constants.LOCAL_EXPORTPDF,Constants.LOCAL_DOCINFO,Constants.LOCAL_FONTSTYLES,Constants.LOCAL_SEARCHDATA,Constants.LOCAL_ZOOM,Constants.LOCAL_LAYOUTS,Constants.LOCAL_AI,Constants.LOCAL_PLUGINTOPUNPIN,Constants.LOCAL_SEARCHASSET,Constants.LOCAL_FLASHCARD,Constants.LOCAL_DIALOGPOSITION,Constants.LOCAL_FILEPOSITION].forEach(s=>{if(typeof t.data[s]=="string")try{const a=JSON.parse(t.data[s]);typeof a=="number"?window.siyuan.storage[s]=a:window.siyuan.storage[s]=Object.assign(n[s],a)}catch(a){window.siyuan.storage[s]=n[s]}else typeof t.data[s]=="undefined"&&(window.siyuan.storage[s]=n[s])}),(!window.siyuan.storage[Constants.LOCAL_SEARCHDATA].replaceTypes||Object.keys(window.siyuan.storage[Constants.LOCAL_SEARCHDATA].replaceTypes).length===0)&&(window.siyuan.storage[Constants.LOCAL_SEARCHDATA].replaceTypes=Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)),e()})},$a=(e,t)=>{pa("/api/storage/setLocalStorageVal",{app:L.SIYUAN_APPID,key:e,val:t})},Ha=e=>{var t;if(e.cmd==="msg")return et(e.msg,e.data.closeTimeout,e.code===0?"info":"error",e.data.id),!1;if(e.cmd==="cmsg")return $e(e.data.id),!1;if(e.cmd==="cprogress"){const n=document.getElementById("progress");return n&&n.remove(),!1}return e.cmd==="reloadui"?((t=e.data)!=null&&t.resetScroll&&(window.siyuan.storage[L.LOCAL_FILEPOSITION]={},$a(L.LOCAL_FILEPOSITION,window.siyuan.storage[L.LOCAL_FILEPOSITION])),window.location.reload(),!1):e.code<0?(et(e.msg,e.data&&e.data.closeTimeout||0,e.code===-1?"error":"info"),!1):e};class Na{constructor(t){this.disableClose=t.disableClose,this.id=he(),window.siyuan.dialogs.push(this),this.destroyCallback=t.destroyCallback,this.element=document.createElement("div");let n,s;if(!ue()&&t.positionId){const a=window.siyuan.storage[L.LOCAL_DIALOGPOSITION][t.positionId];a&&a.left+a.width+34<=window.innerWidth&&a.top+a.height<=window.innerHeight&&(n=a.left+"px",s=a.top+"px",t.width=a.width+"px",t.height=a.height+"px")}this.element.innerHTML=`<div class="b3-dialog" style="z-index: ${++window.siyuan.zIndex};${typeof n=="string"?"display:block":""}">
<div class="b3-dialog__scrim"${t.transparent?'style="background-color:transparent"':""}></div>
<div class="b3-dialog__container" style="width:${t.width||"auto"};height:${t.height||"auto"};left:${n};top:${s}">
  <svg ${ue()&&t.title?'style="top:0;right:0;"':""} class="b3-dialog__close${this.disableClose||t.hideCloseIcon?" fn__none":""}"><use xlink:href="#iconCloseRound"></use></svg>
  <div class="resize__move b3-dialog__header${t.title?"":" fn__none"}" onselectstart="return false;">${t.title||""}</div>
  <div class="b3-dialog__body">${t.content}</div>
  <div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>
</div></div>`,this.element.querySelector(".b3-dialog__scrim").addEventListener("click",a=>{this.disableClose||this.destroy(),a.preventDefault(),a.stopPropagation()}),this.disableClose||this.element.querySelector(".b3-dialog__close").addEventListener("click",a=>{this.destroy(),a.preventDefault(),a.stopPropagation()}),document.body.append(this.element),t.disableAnimation?this.element.classList.add("b3-dialog--open"):setTimeout(()=>{this.element.classList.add("b3-dialog--open")})}destroy(t){this.element.querySelector(".b3-dialog").style.zIndex<window.siyuan.menus.menu.element.style.zIndex&&window.siyuan.menus.menu.remove(),this.element.remove(),this.destroyCallback&&this.destroyCallback(t),window.siyuan.dialogs.find((n,s)=>{if(n.id===this.id)return window.siyuan.dialogs.splice(s,1),!0})}bindInput(t,n,s=!0){t.focus(),t.addEventListener("keydown",a=>{if(a.isComposing){a.preventDefault();return}if(a.key==="Escape"){this.destroy(),a.preventDefault(),a.stopPropagation();return}!a.shiftKey&&Ma(a)&&a.key==="Enter"&&n&&s&&(n(),a.preventDefault(),a.stopPropagation())})}}const Ki=(e,t,n,s)=>{const a=new Dialog({title:e,content:`<div class="b3-dialog__content">
    <div class="ft__breakword">${t}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text" id="confirmDialogConfirmBtn">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),i=a.element.querySelectorAll(".b3-button");i[0].addEventListener("click",()=>{s&&s(a),a.destroy()}),i[1].addEventListener("click",()=>{n&&n(a),a.destroy()})},Zi=e=>{const t=new Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value="${e}"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});t.element.setAttribute("data-key",Constants.DIALOG_RENAMETAG);const n=t.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{t.destroy()});const s=t.element.querySelector("input");t.bindInput(s,()=>{n[1].click()}),s.focus(),s.select(),n[1].addEventListener("click",()=>{fetchPost("/api/tag/renameTag",{oldLabel:e,newLabel:s.value})})},Xi=()=>window.siyuan.config.system.workspaceDir.replace(/^.*[\\\/]/,""),Qi=(e,t)=>{e&&fetchPost("/api/block/checkBlockFold",{id:e},n=>{t(n.data,n.data?[Constants.CB_GET_FOCUS,Constants.CB_GET_ALL]:[Constants.CB_GET_FOCUS,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL])})},Ji=()=>{const e=new Dialog({title:window.siyuan.languages.about5,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.about5}" value="${window.siyuan.config.accessAuthCode}">
    <div class="b3-label__text">${window.siyuan.languages.about6}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),t=e.element.querySelector("input"),n=e.element.querySelectorAll(".b3-button");e.element.setAttribute("data-key",Constants.DIALOG_ACCESSAUTHCODE),e.bindInput(t,()=>{n[1].click()}),t.select(),n[0].addEventListener("click",()=>{e.destroy()}),n[1].addEventListener("click",()=>{fetchPost("/api/system/setAccessAuthCode",{accessAuthCode:t.value})})},eo=e=>`${window.siyuan.config.cloudRegion===0?"https://ld246.com":"https://liuyun.io"}/${e}`,to=e=>`https://b3log.org/siyuan${window.siyuan.config.lang==="zh_CN"?"":"/en"}/${e}`,no=(e=window.siyuan.languages._kernel[29])=>window.siyuan.user&&(window.siyuan.user.userSiYuanProExpireTime===-1||window.siyuan.user.userSiYuanProExpireTime>0)?!1:(e&&(e===window.siyuan.languages._kernel[29]&&window.siyuan.config.system.container==="ios"?showMessage(window.siyuan.languages._kernel[122]):(e===window.siyuan.languages._kernel[29]&&(e=window.siyuan.languages._kernel[29].replace("${url}",getCloudURL("subscribe/siyuan"))),showMessage(e))),!0),ao=()=>window.siyuan.user&&(window.siyuan.user.userSiYuanSubscriptionStatus===0||window.siyuan.user.userSiYuanOneTimePayStatus===1);var so=ke(5);const io=(e,t,n,s=0,a=0)=>{e.style.top=n+"px",e.style.left=t+"px";const i=e.getBoundingClientRect();if(i.bottom>window.innerHeight||i.top<Constants.SIZE_TOOLBAR_HEIGHT){const l=n-i.height-s;l>Constants.SIZE_TOOLBAR_HEIGHT&&l+i.height<window.innerHeight?e.style.top=l+"px":l<=Constants.SIZE_TOOLBAR_HEIGHT?e.style.top=Constants.SIZE_TOOLBAR_HEIGHT+"px":e.style.top=Math.max(Constants.SIZE_TOOLBAR_HEIGHT,window.innerHeight-i.height)+"px"}i.right>window.innerWidth?e.style.left=`${window.innerWidth-i.width-a}px`:i.left<0&&(e.style.left="0")},Ba=()=>{const e=window.siyuan.emojis[getRandom(0,window.siyuan.emojis.length-1)];return typeof e.items[getRandom(0,e.items.length-1)]=="undefined"?"1f600":e.items[getRandom(0,e.items.length-1)].unicode},fe=(e,t="",n=!1,s=!1)=>{if(!e)return"";let a="";if(e.indexOf(".")>-1)a=`<img class="${t}" ${s?"data-":""}src="/emojis/${e}"/>`;else try{e.split("-").forEach(i=>{i.length<5?a+=String.fromCodePoint(parseInt("0"+i,16)):a+=String.fromCodePoint(parseInt(i,16))}),n&&(a=`<span class="${t}">${a}</span>`)}catch(i){}return a},qt=e=>{const t=new IntersectionObserver(n=>{n.forEach(s=>{const a=s.target.getAttribute("data-index");if((typeof s.isIntersecting=="undefined"?s.intersectionRatio!==0:s.isIntersecting)&&a){let i="";window.siyuan.emojis[parseInt(a)].items.forEach(l=>{i+=`<button data-unicode="${l.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?l.description_zh_cn:l.description}">
${fe(l.unicode)}</button>`}),s.target.innerHTML=i,s.target.removeAttribute("data-index")}})});e.querySelectorAll(".emojis__content").forEach(n=>{t.observe(n)})},Ft=e=>{const t=new IntersectionObserver(n=>{n.forEach(s=>{const a=s.target.getAttribute("data-src");(typeof s.isIntersecting=="undefined"?s.intersectionRatio!==0:s.isIntersecting)&&a&&(s.target.src=a,s.target.removeAttribute("data-src"))})});e.querySelectorAll("img").forEach(n=>{t.observe(n)})},Yt=(e="",t)=>{let n="";const s=[];e&&(n=`<div class="emojis__title">${window.siyuan.languages.emoji}</div><div class="emojis__content">`);let a=0,i="";const l=[];window.siyuan.emojis.forEach((r,c)=>{e||(n+=`<div class="emojis__title" data-type="${c+1}">${window.siyuan.config.lang==="zh_CN"?r.title_zh_cn:r.title}</div><div style="min-height:${c===0?"28px":"336px"}" class="emojis__content"${c>1?' data-index="'+c+'"':""}>`),r.items.length===0&&c===0&&!e&&(n+=`<div style="margin-left: 4px">${window.siyuan.languages.setEmojiTip}</div>`),r.items.forEach(f=>{if(e){if(window.siyuan.config.editor.emoji.includes(f.unicode)&&(fe(f.unicode)===e||f.keywords.toLowerCase().indexOf(e.toLowerCase())>-1||f.description.toLowerCase().indexOf(e.toLowerCase())>-1||f.description_zh_cn.toLowerCase().indexOf(e.toLowerCase())>-1)&&s.push(f),t&&a>t)return;(fe(f.unicode)===e||f.keywords.toLowerCase().indexOf(e.toLowerCase())>-1||f.description.toLowerCase().indexOf(e.toLowerCase())>-1||f.description_zh_cn.toLowerCase().indexOf(e.toLowerCase())>-1)&&(r.id==="custom"?l.push(f):i+=`<button data-unicode="${f.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?f.description_zh_cn:f.description}">
${fe(f.unicode,void 0,!1,!0)}</button>`,a++)}else window.siyuan.config.editor.emoji.includes(f.unicode)&&s.push(f),c<2&&(n+=`<button data-unicode="${f.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?f.description_zh_cn:f.description}">
${fe(f.unicode,void 0,!1,!0)}</button>`)}),e||(n+="</div>")}),e&&(l.sort((r,c)=>{const f=r.keywords.split("/"),u=c.keywords.split("/");return f[f.length-1].toLowerCase().indexOf(e.toLowerCase())<u[u.length-1].toLowerCase().indexOf(e.toLowerCase())?-1:0}).sort((r,c)=>{const f=r.keywords.split("/"),u=c.keywords.split("/");return f[f.length-1].toLowerCase().indexOf(e.toLowerCase())===u[u.length-1].toLowerCase().indexOf(e.toLowerCase())&&f[f.length-1].length<u[u.length-1].length?-1:0}).forEach(r=>{n+=`<button data-unicode="${r.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?r.description_zh_cn:r.description}">
${fe(r.unicode,void 0,!1,!0)}</button>`}),n=n+i+"</div>");let o="";return s.length>0&&(o=`<div class="emojis__title" data-type="0">${window.siyuan.languages.recentEmoji}</div><div class="emojis__content">`,window.siyuan.config.editor.emoji.forEach(r=>{const c=s.filter(f=>f.unicode===r);c[0]&&(o+=`<button data-unicode="${c[0].unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?c[0].description_zh_cn:c[0].description}">
${fe(c[0].unicode,void 0,!1,!0)}
</button>`)}),o+="</div>"),o+n===""?`<div class="emojis__title">${window.siyuan.languages.emptyContent}</div>`:o+n},At=e=>{window.siyuan.config.editor.emoji.unshift(e),window.siyuan.config.editor.emoji.length>Constants.SIZE_UNDO&&window.siyuan.config.editor.emoji.pop(),window.siyuan.config.editor.emoji=Array.from(new Set(window.siyuan.config.editor.emoji)),fetchPost("/api/setting/setEmoji",{emoji:window.siyuan.config.editor.emoji})},oo=(e,t,n,s)=>{t!=="av"?window.siyuan.menus.menu.remove():window.siyuan.menus.menu.removeScrollEvent();const a=new Dialog({disableAnimation:!0,transparent:!0,hideCloseIcon:!0,width:isMobile()?"80vw":"360px",height:"50vh",content:`<div class="emojis">
<div class="fn__flex">
    <span class="fn__space"></span>
    <label class="b3-form__icon fn__flex-1" style="overflow:initial;">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
        <input class="b3-form__icon-input b3-text-field fn__block" placeholder="${window.siyuan.languages.search}">
    </label>
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show fn__flex-center b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show fn__flex-center b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    <span class="fn__space"></span>
</div>
<div class="emojis__panel">${Yt()}</div>
<div class="fn__flex">
    <div data-type="0" class="emojis__type ariaLabel" aria-label="${window.siyuan.languages.recentEmoji}">${fe("2b50")}</div>
    <div data-type="1" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[0][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f527")}</div>
    <div data-type="2" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[1][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f60d")}</div>
    <div data-type="3" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[2][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f433")}</div>
    <div data-type="4" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[3][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f96a")}</div>
    <div data-type="5" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[4][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f3a8")}</div>
    <div data-type="6" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[5][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f3dd-fe0f")}</div>
    <div data-type="7" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[6][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f52e")}</div>
    <div data-type="8" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[7][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("267e-fe0f")}</div>
    <div data-type="9" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[8][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f6a9")}</div>
</div>
</div>`});a.element.setAttribute("data-key",Constants.DIALOG_EMOJIS),a.element.querySelector(".b3-dialog__container").setAttribute("data-menu","true");const i=a.element.querySelector(".b3-dialog");i.style.justifyContent="inherit",i.style.alignItems="inherit",setPosition(a.element.querySelector(".b3-dialog__container"),n.x,n.y,n.h,n.w),a.element.querySelector(".emojis__item").classList.add("emojis__item--current");const l=a.element.querySelector(".b3-text-field"),o=a.element.querySelector(".emojis__panel");l.addEventListener("compositionend",()=>{var r;o.innerHTML=Yt(l.value),l.value?o.nextElementSibling.classList.add("fn__none"):o.nextElementSibling.classList.remove("fn__none"),o.scrollTop=0,(r=a.element.querySelector(".emojis__item"))==null||r.classList.add("emojis__item--current"),l.value===""&&qt(a.element),Ft(a.element)}),l.addEventListener("input",r=>{var c;r.isComposing||(o.innerHTML=Yt(l.value),l.value?o.nextElementSibling.classList.add("fn__none"):o.nextElementSibling.classList.remove("fn__none"),o.scrollTop=0,(c=a.element.querySelector(".emojis__item"))==null||c.classList.add("emojis__item--current"),l.value===""&&qt(a.element),Ft(a.element))}),l.addEventListener("keydown",r=>{var c,f;if(r.isComposing||r.key.indexOf("Arrow")===-1&&r.key!=="Enter")return;const u=a.element.querySelector(".emojis__item--current");if(!u)return;if(r.key==="Enter"){const g=u.getAttribute("data-unicode");t==="notebook"?fetchPost("/api/notebook/setNotebookIcon",{notebook:e,icon:g},()=>{a.destroy(),At(g),tt(g,e,"iconFilesRoot")}):t==="doc"?fetchPost("/api/attr/setBlockAttrs",{id:e,attrs:{icon:g}},()=>{a.destroy(),At(g),tt(g,e),Wt(g,e)}):s(g),r.preventDefault(),r.stopPropagation();return}let d;if(r.key==="ArrowLeft"||r.key==="ArrowUp"?u.previousElementSibling?(u.classList.remove("emojis__item--current"),d=u.previousElementSibling,r.preventDefault(),r.stopPropagation()):(c=u.parentElement.previousElementSibling)!=null&&c.previousElementSibling&&(u.classList.remove("emojis__item--current"),d=u.parentElement.previousElementSibling.previousElementSibling.lastElementChild,r.preventDefault(),r.stopPropagation()):(r.key==="ArrowRight"||r.key==="ArrowDown")&&(u.nextElementSibling?(u.classList.remove("emojis__item--current"),d=u.nextElementSibling,r.preventDefault(),r.stopPropagation()):(f=u.parentElement.nextElementSibling)!=null&&f.nextElementSibling&&(u.classList.remove("emojis__item--current"),d=u.parentElement.nextElementSibling.nextElementSibling.firstElementChild,r.preventDefault(),r.stopPropagation())),d){d.classList.add("emojis__item--current");const g=l.clientHeight+6;d.offsetTop-g<o.scrollTop?o.scrollTop=d.offsetTop-g:d.offsetTop-g-o.clientHeight+d.clientHeight>o.scrollTop&&(o.scrollTop=d.offsetTop-g-o.clientHeight+d.clientHeight)}}),isMobile()||l.focus(),qt(a.element),Ft(a.element),a.element.addEventListener("click",r=>{const c=r.target,f=hasClosestByClassName(c,"emojis__type");if(f){const g=o.querySelector(`[data-type="${f.getAttribute("data-type")}"]`);if(g){const p=g.nextElementSibling.getAttribute("data-index");if(p){let b="";window.siyuan.emojis[parseInt(p)].items.forEach(m=>{b+=`<button data-unicode="${m.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?m.description_zh_cn:m.description}">
${fe(m.unicode)}</button>`}),g.nextElementSibling.innerHTML=b,g.nextElementSibling.removeAttribute("data-index")}o.scrollTo({top:g.offsetTop-34})}return}const u=hasClosestByClassName(c,"block__icon");if(u&&u.getAttribute("aria-label")===window.siyuan.languages.remove){t==="notebook"?fetchPost("/api/notebook/setNotebookIcon",{notebook:e,icon:""},()=>{a.destroy(),tt("",e,"iconFilesRoot")}):t==="doc"?fetchPost("/api/attr/setBlockAttrs",{id:e,attrs:{icon:""}},()=>{a.destroy(),tt("",e),Wt("",e)}):s("");return}const d=hasClosestByClassName(c,"emojis__item");if(d||u){let g="";d?(g=d.getAttribute("data-unicode"),t!=="av"&&a.destroy()):g=Ba(),t==="notebook"?fetchPost("/api/notebook/setNotebookIcon",{notebook:e,icon:g},()=>{At(g),tt(g,e,"iconFilesRoot")}):t==="doc"?fetchPost("/api/attr/setBlockAttrs",{id:e,attrs:{icon:g}},()=>{At(g),tt(g,e),Wt(g,e)}):s(g);return}})},Wt=(e,t)=>{},tt=(e,t,n="iconFile")=>{let s;s=document.querySelector(`#sidebar [data-type="sidebar-file"] [data-node-id="${t}"] .b3-list-item__icon`),s&&(s.innerHTML=fe(e||(n==="iconFile"?s.previousElementSibling.classList.contains("fn__hidden")?Constants.SIYUAN_IMAGE_FILE:Constants.SIYUAN_IMAGE_FOLDER:Constants.SIYUAN_IMAGE_NOTE))),n!=="iconFile"&&setNoteBook()},lo=e=>{},ro=()=>{const e=new URLSearchParams(window.location.search),t=e.get("url");let n="",s=!1;if(/^web\+siyuan:\/\/blocks\/\d{14}-\w{7}/.test(t))n=t.substring(20,20+22),s=getSearch("focus",t)==="1";else if(window.JSAndroid){const a=window.JSAndroid.getBlockURL();n=Pa(a),s=getSearch("focus",a)==="1"}else n=e.get("id"),s=e.get("focus")==="1";return{id:n,isZoomIn:s}},co=e=>/^siyuan:\/\/blocks\/\d{14}-\w{7}/.test(e),Pa=e=>e.substring(16,16+22),uo=(e=window.location.href)=>{const t=new URL(window.location.origin);t.pathname="/check-auth",t.searchParams.set("to",e),window.location.href=t.href},fo=()=>{let e=document.getElementById("baseURL");e||(e=document.createElement("base"),e.id="baseURL"),e.setAttribute("href",location.origin),document.getElementsByTagName("head")[0].appendChild(e)},bn=(e,t=!0,n=!1)=>{let s=e;return t&&(s=hn().basename(e)),n&&s.endsWith(".sy")&&(s=s.substr(0,s.length-3)),s},go=e=>e.substring(7,e.length-hn().extname(e).length-23),po=e=>!e||(e=e.trim(),1>e.length)?!1:(e=e.toLowerCase(),e.startsWith("assets/")||e.startsWith("file://")||e.startsWith("\\\\")?!0:e.indexOf(":")===1),hn=()=>path.posix?path.posix:path,mo=()=>path,bo=e=>{const t=[];return e.forEach(n=>{if(n.getAttribute("data-type")!=="navigation-root"){const s=n.getAttribute("data-path");t.find(i=>{if(s.startsWith(i.replace(".sy","")))return!0})||t.push(s)}}),t},ho=(e,t,n)=>{fetchPost("/api/filetree/moveDocs",{toNotebook:t,fromPaths:e,toPath:n})},yo=(e,t,n,s,a=!1)=>{if(window.siyuan.dialogs.find(d=>{if(d.element.querySelector("#foldList"))return d.destroy(),!0}))return;const l=new Dialog({title:`${s||window.siyuan.languages.move}
<div style="max-height: 16px;overflow: auto;line-height: 14px;-webkit-mask-image: linear-gradient(to top, rgba(0, 0, 0, 0) 0, #000 6px);padding-bottom: 4px;margin-bottom: -4px" class="ft__smaller ft__on-surface fn__hidescrollbar"></div>`,content:`<div class="b3-form__icon" style="margin: 8px">
    <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
    <input class="b3-text-field fn__block b3-form__icon-input" value="" placeholder="${window.siyuan.languages.search}">
</div>
<ul id="foldList" class="fn__flex-1 fn__none b3-list b3-list--background${isMobile()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></ul>
<div id="foldTree" class="fn__flex-1${isMobile()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></div>
<div class="fn__hr"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"50vw",height:isMobile()?"80vh":"70vh",destroyCallback(){n&&focusByRange(n)}});l.element.setAttribute("data-key",Constants.DIALOG_MOVEPATHTO),t&&t.length>0&&fetchPost("/api/filetree/getHPathsByPaths",{paths:t},d=>{l.element.querySelector(".b3-dialog__header .ft__smaller").innerHTML=escapeHtml(d.data.join(" "))});const o=l.element.querySelector("#foldList"),r=l.element.querySelector("#foldTree");Ra(d=>{let g="";d.forEach(p=>{if(!p.closed){let b="";a&&(b=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${p.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardReviewCard}">${p.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${p.flashcardCount}</span>`),g+=`<ul class="b3-list b3-list--background">
<li class="b3-list-item${g===""?" b3-list-item--focus":""}" data-path="/" data-box="${p.id}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${unicode2Emoji(p.icon||Constants.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${escapeHtml(p.name)}</span>
    ${b}
</li></ul>`}}),r.innerHTML=g},a);const c=l.element.querySelector(".b3-text-field");c.focus();const f=d=>{if(!(d&&d.isComposing)){if(c.value.trim()===""){o.classList.add("fn__none"),r.classList.remove("fn__none");return}r.classList.add("fn__none"),o.classList.remove("fn__none"),o.scrollTo(0,0),fetchPost("/api/filetree/searchDocs",{k:c.value,flashcard:a},g=>{let p="";g.data.forEach(b=>{let m="";a&&(m=`<span class="fn__flex-1"></span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${b.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardReviewCard}">${b.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${b.flashcardCount}</span>`),p+=`<li class="b3-list-item${p===""?" b3-list-item--focus":""}" data-path="${b.path}" data-box="${b.box}">
    ${unicode2Emoji(b.boxIcon||Constants.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__showall" style="padding:4px 0">${escapeHtml(b.hPath)}</span>
    ${m}
</li>`}),o.innerHTML=p})}};f(),c.addEventListener("compositionend",d=>{f(d)}),c.addEventListener("input",d=>{f(d)});const u=28;c.addEventListener("keydown",d=>{if(d.isComposing)return;const g=o.classList.contains("fn__none")?r:o,p=g.querySelectorAll(".b3-list-item--focus");if(p.length===0)return;let b=p[0];if(d.key.startsWith("Arrow")&&p.forEach((m,h)=>{h!==0&&m.classList.remove("b3-list-item--focus")}),o.classList.contains("fn__none")){if(d.key==="ArrowRight"&&!b.querySelector(".b3-list-item__arrow--open")&&!b.querySelector(".b3-list-item__toggle").classList.contains("fn__hidden")||d.key==="ArrowLeft"&&b.querySelector(".b3-list-item__arrow--open")){jt(b,a),d.preventDefault();return}if(d.key==="ArrowLeft"){let m=b.parentElement.previousElementSibling;if(m){m.tagName!=="LI"&&(m=g.querySelector(".b3-list-item")),b.classList.remove("b3-list-item--focus"),m.classList.add("b3-list-item--focus");const h=m.getBoundingClientRect(),y=g.getBoundingClientRect();(h.top<y.top||h.bottom>y.bottom)&&m.scrollIntoView(h.top<y.top)}return d.preventDefault(),!0}if(d.key==="ArrowDown"||d.key==="ArrowRight"){let m=b;for(;m;)if(m.nextElementSibling)if(m.nextElementSibling.classList.contains("fn__none"))m=m.nextElementSibling;else{m.nextElementSibling.tagName==="UL"?m=m.nextElementSibling.firstElementChild:m=m.nextElementSibling;break}else{if(m.parentElement.id==="foldTree")break;m=m.parentElement}if(m.classList.contains("b3-list-item")){b.classList.remove("b3-list-item--focus"),m.classList.add("b3-list-item--focus");const h=m.getBoundingClientRect(),y=r.getBoundingClientRect();(h.top<y.top||h.bottom>y.bottom)&&m.scrollIntoView(h.top<y.top)}return d.preventDefault(),!0}if(d.key==="ArrowUp"){let m=b;for(;m;)if(m.previousElementSibling)if(m.previousElementSibling.classList.contains("fn__none"))m=m.previousElementSibling;else{if(m.previousElementSibling.tagName==="LI")m=m.previousElementSibling;else{const h=m.previousElementSibling.querySelectorAll(".b3-list-item");m=h[h.length-1]}break}else{if(m.parentElement.id==="foldTree")break;m=m.parentElement}if(m.classList.contains("b3-list-item")){b.classList.remove("b3-list-item--focus"),m.classList.add("b3-list-item--focus");const h=m.getBoundingClientRect(),y=r.getBoundingClientRect();(h.top<y.top||h.bottom>y.bottom)&&m.scrollIntoView(h.top<y.top)}d.preventDefault()}}else{if(d.key==="ArrowDown"){b.classList.remove("b3-list-item--focus"),b.nextElementSibling?b.nextElementSibling.classList.add("b3-list-item--focus"):g.children[0].classList.add("b3-list-item--focus"),b=g.querySelector(".b3-list-item--focus"),(g.scrollTop<b.offsetTop-g.clientHeight+u||g.scrollTop>b.offsetTop)&&(g.scrollTop=b.offsetTop-g.clientHeight+u),d.preventDefault();return}if(d.key==="ArrowUp"){if(b.classList.remove("b3-list-item--focus"),b.previousElementSibling)b.previousElementSibling.classList.add("b3-list-item--focus");else{const m=g.children.length;g.children[m-1].classList.add("b3-list-item--focus")}b=g.querySelector(".b3-list-item--focus"),(g.scrollTop<b.offsetTop-g.clientHeight+u||g.scrollTop>b.offsetTop-u*2)&&(g.scrollTop=b.offsetTop-u*2),d.preventDefault();return}}if(d.key==="Enter"){const m=g.querySelectorAll(".b3-list-item--focus");if(m.length===0)return;const h=[],y=[];m.forEach(k=>{h.push(k.getAttribute("data-path")),y.push(k.getAttribute("data-box"))}),e(h,y),l.destroy(),d.preventDefault()}}),l.element.addEventListener("click",d=>{let g=d.target;for(;g&&!g.isEqualNode(l.element);){if(g.classList.contains("b3-list-item__toggle")){jt(g.parentElement,a),d.preventDefault(),d.stopPropagation();break}else if(g.classList.contains("b3-button--text")){const b=(o.classList.contains("fn__none")?r:o).querySelectorAll(".b3-list-item--focus");if(b.length===0)return;const m=[],h=[];b.forEach(y=>{m.push(y.getAttribute("data-path")),h.push(y.getAttribute("data-box"))}),e(m,h),l.destroy(),d.preventDefault(),d.stopPropagation();break}else if(g.classList.contains("b3-button--cancel")){l.destroy(),d.preventDefault(),d.stopPropagation();break}else if(g.classList.contains("b3-list-item")){const b=(o.classList.contains("fn__none")?r:o).querySelectorAll(".b3-list-item--focus");if(b.length===0)return;s===window.siyuan.languages.specifyPath&&isOnlyMeta(d)?b.length===1&&b[0].isSameNode(g)||g.classList.toggle("b3-list-item--focus"):(b[0].classList.remove("b3-list-item--focus"),g.classList.add("b3-list-item--focus")),g.getAttribute("data-path")==="/"&&jt(g,a),d.preventDefault(),d.stopPropagation();break}g=g.parentElement}c.focus()})},jt=(e,t)=>{const n=e.querySelector(".b3-list-item__arrow");if(n.classList.contains("b3-list-item__arrow--open")){n.classList.remove("b3-list-item__arrow--open"),e.nextElementSibling&&e.nextElementSibling.tagName==="UL"&&e.nextElementSibling.classList.add("fn__none");return}if(e.nextElementSibling&&e.nextElementSibling.tagName==="UL"){n.classList.add("b3-list-item__arrow--open"),e.nextElementSibling.classList.remove("fn__none");return}const s=e.getAttribute("data-box");fetchPost("/api/filetree/listDocsByPath",{notebook:s,path:e.getAttribute("data-path"),flashcard:t},a=>{if(a.data.path==="/"&&a.data.files.length===0){showMessage(window.siyuan.languages.emptyContent);return}let i="";if(a.data.files.forEach(o=>{let r="";t?r=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${o.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardReviewCard}">${o.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${o.flashcardCount}</span>`:o.count&&o.count>0&&(r=`<span class="popover__block counter b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.ref}">${o.count}</span>`),i+=`<li title="${bn(o.name,!0,!0)} ${o.hSize}${o.bookmark?`
`+window.siyuan.languages.bookmark+" "+o.bookmark:""}${o.name1?`
`+window.siyuan.languages.name+" "+o.name1:""}${o.alias?`
`+window.siyuan.languages.alias+" "+o.alias:""}${o.memo?`
`+window.siyuan.languages.memo+" "+o.memo:""}${o.subFileCount!==0?window.siyuan.languages.includeSubFile.replace("x",o.subFileCount):""}
${window.siyuan.languages.modifiedAt} ${o.hMtime}
${window.siyuan.languages.createdAt} ${o.hCtime}" 
data-box="${s}" class="b3-list-item" data-path="${o.path}">
    <span style="padding-left: ${o.path.split("/").length*8}px" class="b3-list-item__toggle b3-list-item__toggle--hl${o.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${unicode2Emoji(o.icon||(o.subFileCount===0?Constants.SIYUAN_IMAGE_FILE:Constants.SIYUAN_IMAGE_FOLDER),"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${bn(o.name,!0,!0)}</span>
    ${r}
</li>`}),i==="")return;n.classList.add("b3-list-item__arrow--open"),e.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${i}</ul>`);const l=e.nextElementSibling;setTimeout(()=>{l.setAttribute("style",`height:${l.childElementCount*e.clientHeight}px;`),setTimeout(()=>{l.classList.remove("file-tree__sliderDown"),l.removeAttribute("style")},120)},2)})},wo=e=>{let t="";return window.siyuan.notebooks.find(n=>{if(n.id===e)return t=n.name,!0}),t},_o=e=>{let t="";return window.siyuan.notebooks.find(n=>{if(n.id===e)return t=n.icon,!0}),t},vo=(e,t)=>{window.siyuan.notebooks.find(n=>{if(n.id===e)return n.name=t,!0})},Eo=()=>{let e=0;return window.siyuan.notebooks.forEach(t=>{t.closed||e++}),e},Ra=(e,t=!1)=>{fetchPost("/api/notebook/lsNotebooks",{flashcard:t},n=>{t||(window.siyuan.notebooks=n.data.notebooks),e&&e(n.data.notebooks)})},Oa=(e,t=L.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="abc"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="abc"]')),n.length!==0&&n.length>0&&J(`${t}/js/abcjs/abcjs-basic-min.js?v=6.2.2`,"protyleAbcjsScript").then(()=>{n.forEach(s=>{if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",ve());const a=s.firstElementChild.nextElementSibling;a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${L.ZWSP}</span><div contenteditable="false"></div>`,window.ABCJS.renderAbc(a.lastElementChild,Lute.UnEscapeHTMLStr(s.getAttribute("data-content")),{responsive:"resize"}),s.setAttribute("data-render","true")})})};var qa=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const Fa=(e,t=L.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="echarts"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="echarts"]')),n.length!==0&&n.length>0&&J(`${t}/js/echarts/echarts.min.js?v=5.3.2`,"protyleEchartsScript").then(()=>{J(`${t}/js/echarts/echarts-gl.min.js?v=2.0.9`,"protyleEchartsGLScript").then(()=>{let s;if(n[0].firstElementChild.clientWidth===0){const a=N(n[0],"layout-tab-container",!0);a&&Array.from(a.children).find(i=>{if(i.classList.contains("protyle")&&!i.classList.contains("fn__none"))return s=i.querySelector(".protyle-wysiwyg").firstElementChild.clientWidth,!0})}n.forEach(a=>qa(void 0,null,function*(){if(a.getAttribute("data-render")==="true")return;a.firstElementChild.classList.contains("protyle-icons")||a.insertAdjacentHTML("afterbegin",ve());const i=a.firstElementChild.nextElementSibling;try{i.style.height=a.style.height;const l=yield ye(Lute.UnEscapeHTMLStr(a.getAttribute("data-content")));window.echarts.init(i,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:s}).setOption(l),a.setAttribute("data-render","true"),i.classList.remove("ft__error"),i.textContent.endsWith(L.ZWSP)||i.firstElementChild.insertAdjacentText("beforeend",L.ZWSP)}catch(l){window.echarts.dispose(i),i.classList.add("ft__error"),i.innerHTML=`echarts render error: <br>${l}`}}))})})},Ut=(e,t)=>{if(!document.getElementById(t)){const n=document.createElement("link");n.id=t,n.rel="stylesheet",n.type="text/css",n.href=e;const s=document.querySelector("#pluginsStyle");s?s.before(n):document.getElementsByTagName("head")[0].appendChild(n)}},Ya=(e,t=L.PROTYLE_CDN,n=!1)=>{let s=[];e.getAttribute("data-subtype")==="math"?s=[e]:s=Array.from(e.querySelectorAll('[data-subtype="math"]')),s.length!==0&&(Ut(`${t}/js/katex/katex.min.css?v=0.16.0`,"protyleKatexStyle"),J(`${t}/js/katex/katex.min.js?v=0.16.0`,"protyleKatexScript").then(()=>{J(`${t}/js/katex/mhchem.min.js?v=0.16.0`,"protyleKatexMhchemScript").then(()=>{s.forEach(a=>{var i,l;if(a.getAttribute("data-render")==="true")return;a.setAttribute("data-render","true");let o=a;a.tagName==="DIV"&&(o=a.firstElementChild);let r={};try{r=ye(window.siyuan.config.editor.katexMacros||"{}")}catch(c){console.warn("KaTex macros is not JSON",c)}try{o.innerHTML=window.katex.renderToString(Lute.UnEscapeHTMLStr(a.getAttribute("data-content")),{displayMode:a.tagName==="DIV",output:"html",macros:r,trust:!0,strict:f=>f==="unicodeTextInMathMode"?"ignore":"warn"}),o.classList.remove("ft__error");const c=K(a);if(a.tagName==="DIV"){o.firstElementChild.setAttribute("contenteditable","false"),o.childElementCount<2&&o.insertAdjacentHTML("beforeend",`<span style="position: absolute;right: 0;top: 0;">${L.ZWSP}</span>`);const f=o.querySelectorAll(".base");f.length>0&&f[f.length-1].insertAdjacentHTML("afterend","<span class='fn__flex-1'></span>");const u=o.querySelector(".katex-html > .newline");u&&(u.parentElement.style.display="block")}else{c&&a.getBoundingClientRect().width>c.clientWidth?(a.style.maxWidth="100%",a.style.overflowX="auto",a.style.overflowY="hidden",a.style.display="inline-block"):(a.style.maxWidth="",a.style.overflowX="",a.style.overflowY="",a.style.display="");const f=De(a);f?f&&f.nodeType!==3&&((i=f.getAttribute("data-type"))==null?void 0:i.indexOf("inline-math"))>-1?a.after(document.createTextNode(L.ZWSP)):f&&!f.textContent.startsWith(`
`)&&f.textContent!==L.ZWSP&&a.insertAdjacentHTML("beforeend","&#xFEFF;"):a.parentElement.tagName!=="TH"&&a.parentElement.tagName!=="TD"?a.insertAdjacentText("afterend",`
`):a.insertAdjacentText("afterend",L.ZWSP),(l=a.previousSibling)!=null&&l.textContent.endsWith(`
`)?a.insertAdjacentText("beforebegin",L.ZWSP):!qe(a)&&["TH","TD"].includes(a.parentElement.tagName)&&a.insertAdjacentText("afterbegin",L.ZWSP)}n&&setTimeout(()=>{if(a.tagName==="DIV"){const f=a.querySelector(".katex-display");f.clientWidth<f.scrollWidth&&f.firstElementChild.setAttribute("style",`font-size:${f.clientWidth*100/f.scrollWidth}%`)}else c&&a.offsetWidth>c.clientWidth&&a.firstElementChild.setAttribute("style",`font-size:${c.clientWidth*100/a.offsetWidth}%`)})}catch(c){o.innerHTML=c.message,o.classList.add("ft__error")}})})}))},Wa=(e,t=L.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="mermaid"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="mermaid"]')),n.length!==0&&J(`${t}/js/mermaid/mermaid.min.js?v=10.3.0`,"protyleMermaidScript").then(()=>{const s={securityLevel:"loose",altFontFamily:"sans-serif",fontFamily:"sans-serif",startOnLoad:!1,flowchart:{htmlLabels:!0,useMaxWidth:!0},sequence:{useMaxWidth:!0,diagramMarginX:8,diagramMarginY:8,boxMargin:8,showSequenceNumbers:!0},gantt:{leftPadding:75,rightPadding:20}};if(window.siyuan.config.appearance.mode===1&&(s.theme="dark"),window.mermaid.initialize(s),n[0].firstElementChild.clientWidth===0){const a=Oe(n[0],"fold","1");if(!a)return;const i=new MutationObserver(()=>{yn(n),i.disconnect()});i.observe(a,{attributeFilter:["fold"]})}else yn(n)})},yn=e=>{e.forEach((t,n)=>{if(t.getAttribute("data-render")==="true")return;t.firstElementChild.classList.contains("protyle-icons")||t.insertAdjacentHTML("afterbegin",`<div class="protyle-icons">
    <span aria-label="${window.siyuan.languages.edit}" class="b3-tooltips__sw b3-tooltips protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__sw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>`);const s=t.firstElementChild.nextElementSibling;s.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${L.ZWSP}</span><div contenteditable="false">${Lute.UnEscapeHTMLStr(t.getAttribute("data-content"))}</div>`,setTimeout(()=>{window.mermaid.init(void 0,s.lastElementChild)},L.TIMEOUT_LOAD*n),t.setAttribute("data-render","true")})},ja=(e,t=L.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="mindmap"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="mindmap"]')),n.length!==0&&J(`${t}/js/echarts/echarts.min.js?v=0.0.0`,"protyleEchartsScript").then(()=>{let s;if(n[0].firstElementChild.clientWidth===0){const a=N(n[0],"layout-tab-container",!0);a&&Array.from(a.children).find(i=>{if(i.classList.contains("protyle")&&!i.classList.contains("fn__none")&&i.querySelector(".protyle-wysiwyg").firstElementChild)return s=i.querySelector(".protyle-wysiwyg").firstElementChild.clientWidth,!0})}n.forEach(a=>{if(a.getAttribute("data-render")==="true")return;a.firstElementChild.classList.contains("protyle-icons")||a.insertAdjacentHTML("afterbegin",ve());const i=a.firstElementChild.nextElementSibling;try{i.style.height=a.style.height,window.echarts.init(i,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:s}).setOption({series:[{data:[JSON.parse(Lute.EChartsMindmapStr(Lute.UnEscapeHTMLStr(a.getAttribute("data-content"))))],initialTreeDepth:-1,itemStyle:{borderWidth:0,color:"#4285f4"},label:{backgroundColor:"#f6f8fa",borderColor:"#d1d5da",borderRadius:6,borderWidth:.5,color:"#586069",lineHeight:20,offset:[-5,0],padding:[0,5],position:"insideRight"},lineStyle:{color:"#d1d5da",width:1},roam:!0,symbol:(l,o)=>{var r;return(r=o==null?void 0:o.data)!=null&&r.children?"circle":"path://"},type:"tree"}],tooltip:{trigger:"item",triggerOn:"mousemove"},backgroundColor:"transparent"}),a.setAttribute("data-render","true"),i.textContent.endsWith(L.ZWSP)||i.firstElementChild.insertAdjacentText("beforeend",L.ZWSP),i.classList.remove("ft__error")}catch(l){i.classList.add("ft__error"),i.innerHTML=`Mindmap render error: <br>${l}`}})})},Ua=(e,t=L.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="flowchart"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="flowchart"]')),n.length!==0&&J(`${t}/js/flowchart.js/flowchart.min.js?v=0.0.0`,"protyleFlowchartScript").then(()=>{if(n[0].firstElementChild.clientWidth===0){const s=Oe(n[0],"fold","1");if(!s)return;const a=new MutationObserver(()=>{wn(n),a.disconnect()});a.observe(s,{attributeFilter:["fold"]})}else wn(n)})},wn=e=>{e.forEach(t=>{if(t.getAttribute("data-render")==="true")return;t.firstElementChild.classList.contains("protyle-icons")||t.insertAdjacentHTML("afterbegin",ve());const n=t.firstElementChild.nextElementSibling;n.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${L.ZWSP}</span><div class="ft__error" contenteditable="false"></div>`;try{flowchart.parse(Lute.UnEscapeHTMLStr(t.getAttribute("data-content"))).drawSVG(n.lastElementChild)}catch(s){n.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${L.ZWSP}</span><div class="ft__error" contenteditable="false">Flow Chart render error: <br>${s}</div>`}t.setAttribute("data-render","true")})},Va=(e,t=L.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="plantuml"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="plantuml"]')),n.length!==0&&J(`${t}/js/plantuml/plantuml-encoder.min.js?v=0.0.0`,"protylePlantumlScript").then(()=>{n.forEach(s=>{if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",ve());const a=s.firstElementChild.nextElementSibling;try{a.innerHTML=`<img src=${window.siyuan.config.editor.plantUMLServePath}${window.plantumlEncoder.encode(Lute.UnEscapeHTMLStr(s.getAttribute("data-content")))}">`,a.classList.remove("ft__error"),s.setAttribute("data-render","true")}catch(i){a.classList.add("ft__error"),a.innerHTML=`plantuml render error: <br>${i}`}})})},ko=(e,t)=>{const n=document.createElement("div");n.innerHTML=e;let s=!1;if((n.childElementCount===1&&n.lastElementChild.style.fontFamily.indexOf("monospace")>-1||n.childElementCount===1&&n.querySelectorAll("pre").length===1||e.indexOf(`
<p class="p1">`)===0||n.childElementCount===1&&n.firstElementChild.tagName==="TABLE"&&n.querySelector(".line-number")&&n.querySelector(".line-content"))&&(s=!0),s){let a=t||e;return/\n/.test(a)?`<div data-type="NodeCodeBlock" class="code-block" data-node-id="${Lute.NewNodeID()}"><div class="protyle-action"><span class="protyle-action--first protyle-action__language" contenteditable="false">${window.siyuan.storage[Constants.LOCAL_CODELANG]}</span><span class="fn__flex-1"></span><span aria-label="${window.siyuan.languages.copy}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__copy"><svg><use xlink:href="#iconCopy"></use></svg></span><span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--last protyle-action__menu"><svg><use xlink:href="#iconMore"></use></svg></span></div><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${a.replace(/&/g,"&amp;").replace(/</g,"&lt;")}<wbr></div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`:(a=a.replace("<","&lt;").replace(">","&gt;"),"`"+a+"`")}return!1},Co=e=>{const t=e.getAttribute("data-subtype");if(!["abc","plantuml","mermaid","flowchart","echarts","mindmap","graphviz","math"].includes(t)||e.getAttribute("data-type")!=="NodeHTMLBlock"){abcRender(e),htmlRender(e),plantumlRender(e),mermaidRender(e),flowchartRender(e),chartRender(e),mindmapRender(e),graphvizRender(e),mathRender(e);return}t==="abc"?abcRender(e):t==="plantuml"?plantumlRender(e):t==="mermaid"?mermaidRender(e):t==="flowchart"?flowchartRender(e):t==="echarts"?chartRender(e):t==="mindmap"?mindmapRender(e):t==="graphviz"?graphvizRender(e):t==="math"?mathRender(e):e.getAttribute("data-type")==="NodeHTMLBlock"&&htmlRender(e)},Vt=e=>{e.classList.add("protyle-wysiwyg--hl"),setTimeout(function(){e.classList.remove("protyle-wysiwyg--hl")},1024)},Ao=(e,t,n=!1)=>{let s;const a=e.wysiwyg.element;if(!e.preview.element.classList.contains("fn__none")){s=document.getElementById(t),s&&(e.preview.element.scrollTop=s.offsetTop,Vt(s));return}if(Array.from(a.querySelectorAll(`[data-node-id="${t}"]`)).find(i=>{if(!hasClosestByAttribute(i,"data-type","block-render",!0))return s=i,!0}),s)return Ga(e,s,n),Vt(s),s;if(t===e.block.rootID&&e.options.render.title)return Vt(e.title.editElement),e.title.editElement},Ga=(e,t,n=!1,s="auto")=>{if(!e.disabled&&!n&&getSelection().rangeCount>0&&hasClosestBlock(getSelection().getRangeAt(0).startContainer)){const r=e.contentElement,c=getSelectionPosition(r).top-r.getBoundingClientRect().top;let f=0;c<0?f=r.scrollTop+c:c>r.clientHeight-74&&(f=r.scrollTop+(c+74-r.clientHeight)),f!==0&&r.scroll({top:f,behavior:s});return}if(t||(t=hasClosestBlock(getEditorRange(e.wysiwyg.element).startContainer)),!t)return;let a=0,i=t;for(;i&&!i.classList.contains("protyle-wysiwyg");)a+=i.offsetTop,i=i.parentElement;let l=0,o=e.element.firstElementChild;for(;o&&!o.classList.contains("protyle-content");)l+=o.clientHeight,o=o.nextElementSibling;if(n){e.contentElement.scroll({top:a-l,behavior:s});return}e.contentElement.scrollTop>a-32?e.contentElement.scroll({top:a-l,behavior:s}):e.contentElement.scrollTop+e.contentElement.clientHeight<a+t.clientHeight-l&&e.contentElement.scroll({top:a+t.clientHeight-l-e.contentElement.clientHeight,behavior:s})},Lo=e=>{},So=(e,t,n,s)=>{},xo=e=>{if(isInAndroid()){window.JSAndroid.writeImageClipboard(e.getAttribute("src"));return}else{const t=document.createElement("canvas"),n=document.createElement("img");n.onload=s=>{t.width=s.target.width,t.height=s.target.height,t.getContext("2d").drawImage(s.target,0,0,s.target.width,s.target.height),t.toBlob(a=>{navigator.clipboard.write([new ClipboardItem({["image/png"]:a})])},"image/png",1)},n.src=e.getAttribute("src")}};class To{constructor(){this.wheelEvent="onwheel"in document.createElement("div")?"wheel":"mousewheel",this.element=document.getElementById("commonMenu"),this.element.querySelector(".b3-menu__title .b3-menu__label").innerHTML=window.siyuan.languages.back,this.element.addEventListener(isMobile()?"click":"mouseover",t=>{const n=t.target;if(isMobile()&&(hasClosestByClassName(n,"b3-menu__title")||typeof t.detail=="string"&&t.detail==="back")){const l=this.element.querySelectorAll(".b3-menu__item--show");l.length>0?l[l.length-1].classList.remove("b3-menu__item--show"):this.remove();return}const s=hasClosestByClassName(n,"b3-menu__item");if(!s||s.classList.contains("b3-menu__item--readonly"))return;const a=s.querySelector(".b3-menu__submenu");this.element.querySelectorAll(".b3-menu__item--show").forEach(i=>{!i.contains(s)&&!i.isSameNode(s)&&!s.contains(i)&&i.classList.remove("b3-menu__item--show")}),this.element.querySelectorAll(".b3-menu__item--current").forEach(i=>{i.classList.remove("b3-menu__item--current")}),s.classList.add("b3-menu__item--current"),a&&(s.classList.add("b3-menu__item--show"),this.element.classList.contains("b3-menu--fullscreen")||this.showSubMenu(a))})}showSubMenu(t){const n=t.parentElement.getBoundingClientRect();t.style.top=n.top-8+"px",t.style.left=n.right+8+"px",t.style.bottom="auto";const s=t.getBoundingClientRect();s.right>window.innerWidth&&(n.left-8>s.width?t.style.left=n.left-8-s.width+"px":t.style.left=window.innerWidth-s.width+"px"),s.bottom>window.innerHeight&&(t.style.top="auto",t.style.bottom="8px")}preventDefault(t){!hasClosestByClassName(t.target,"b3-menu")&&!hasClosestByClassName(t.target,"keyboard__bar")&&t.preventDefault()}addSeparator(t){return this.addItem({type:"separator",index:t})}addItem(t){const n=new Gt(t);return this.append(n.element,t.index),n.element}removeScrollEvent(){window.removeEventListener(isMobile()?"touchmove":this.wheelEvent,this.preventDefault,!1)}remove(){window.siyuan.menus.menu.removeCB&&(window.siyuan.menus.menu.removeCB(),window.siyuan.menus.menu.removeCB=void 0),this.removeScrollEvent(),this.element.firstElementChild.classList.add("fn__none"),this.element.lastElementChild.innerHTML="",this.element.lastElementChild.removeAttribute("style"),this.element.classList.add("fn__none"),this.element.classList.remove("b3-menu--list","b3-menu--fullscreen"),this.element.removeAttribute("style"),window.siyuan.menus.menu.element.removeAttribute("data-name"),window.siyuan.menus.menu.element.removeAttribute("data-from")}append(t,n){if(t){if(typeof n=="number"){const s=this.element.querySelectorAll(".b3-menu__items > .b3-menu__separator")[n];if(s){s.before(t);return}}this.element.lastElementChild.append(t)}}popup(t){this.element.lastElementChild.innerHTML!==""&&(window.addEventListener(isMobile()?"touchmove":this.wheelEvent,this.preventDefault,{passive:!1}),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.classList.remove("fn__none"),setPosition(this.element,t.x-(t.isLeft?window.siyuan.menus.menu.element.clientWidth:0),t.y,t.h,t.w))}fullscreen(t="all"){this.element.lastElementChild.innerHTML!==""&&(this.element.classList.add("b3-menu--fullscreen"),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.firstElementChild.classList.remove("fn__none"),this.element.classList.remove("fn__none"),window.addEventListener("touchmove",this.preventDefault,{passive:!1}),setTimeout(()=>{t==="bottom"?(this.element.style.transform="translateY(-50vh)",this.element.style.height="50vh"):this.element.style.transform="translateY(-100vh)"}),this.element.lastElementChild.scrollTop=0)}}class Gt{constructor(t){if(t.type==="empty"){this.element=document.createElement("div"),this.element.innerHTML=t.label,t.bind&&t.bind(this.element);return}if(this.element=document.createElement("button"),t.disabled&&this.element.setAttribute("disabled","disabled"),t.type==="separator"){this.element.classList.add("b3-menu__separator");return}if(this.element.classList.add("b3-menu__item"),t.current&&this.element.classList.add("b3-menu__item--selected"),t.click&&this.element.addEventListener("click",n=>{if(this.element.getAttribute("disabled"))return;let s=t.click(this.element,n);s instanceof Promise&&(s=!1),n.preventDefault(),n.stopImmediatePropagation(),n.stopPropagation(),this.element.parentElement&&!s&&window.siyuan.menus.menu.remove()}),t.id&&this.element.setAttribute("data-id",t.id),t.type==="readonly"&&this.element.classList.add("b3-menu__item--readonly"),t.element)this.element.append(t.element);else{let n=`<span class="b3-menu__label">${t.label||"&nbsp;"}</span>`;typeof t.iconHTML=="string"?n=t.iconHTML+n:n=`<svg class="b3-menu__icon ${t.iconClass||""}" style="${t.icon==="iconClose"?"height:10px;":""}"><use xlink:href="#${t.icon||""}"></use></svg>${n}`,t.accelerator&&(n+=`<span class="b3-menu__accelerator">${updateHotkeyTip(t.accelerator)}</span>`),t.action&&(n+=`<svg class="b3-menu__action${t.action==="iconCloseRound"?" b3-menu__action--close":""}"><use xlink:href="#${t.action}"></use></svg>`),this.element.innerHTML=n}if(t.bind&&(this.element.classList.add("b3-menu__item--custom"),t.bind(this.element)),t.submenu){const n=document.createElement("div");n.classList.add("b3-menu__submenu"),n.innerHTML='<div class="b3-menu__items"></div>',t.submenu.forEach(s=>{n.firstElementChild.append(new Gt(s).element)}),this.element.insertAdjacentHTML("beforeend",'<svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>'),this.element.append(n)}}}const je=(e,t)=>{let n=e;for(;n&&(n.classList.contains("b3-menu__separator")||n.classList.contains("b3-menu__item--readonly"))&&!n.querySelector(".b3-text-field");)t?n=n.nextElementSibling:n=n.previousElementSibling;return n},Io=e=>{if(window.siyuan.menus.menu.element.classList.contains("fn__none")||e.altKey||e.shiftKey||e.ctrlKey||e.metaKey)return!1;const t=e.target;if(window.siyuan.menus.menu.element.contains(t)&&["INPUT","TEXTAREA"].includes(t.tagName))return!1;const n=Constants.KEYCODELIST[e.keyCode];if(n==="\u2193"||n==="\u2191"){const s=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");let a;if(s?(s.classList.remove("b3-menu__item--current","b3-menu__item--show"),n==="\u2191"?(a=je(s.previousElementSibling,!1),a||(a=je(s.parentElement.lastElementChild,!1))):(a=je(s.nextElementSibling,!0),a||(a=je(s.parentElement.firstElementChild,!0)))):n==="\u2191"?a=je(window.siyuan.menus.menu.element.lastElementChild.lastElementChild,!1):a=je(window.siyuan.menus.menu.element.lastElementChild.firstElementChild,!0),a){a.classList.add("b3-menu__item--current"),a.classList.remove("b3-menu__item--show");const i=a.parentElement.getBoundingClientRect(),l=a.getBoundingClientRect();(i.top>l.top||i.bottom<l.bottom)&&a.scrollIntoView(i.top>l.top)}return!0}else if(n==="\u2192"){const s=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(!s)return!0;const a=s.querySelector(".b3-menu__submenu");if(!a)return!0;s.classList.remove("b3-menu__item--current"),s.classList.add("b3-menu__item--show");const i=je(a.firstElementChild.firstElementChild,!0);return i&&i.classList.add("b3-menu__item--current"),window.siyuan.menus.menu.showSubMenu(a),!0}else if(n==="\u2190"){const s=window.siyuan.menus.menu.element.querySelector(".b3-menu__submenu .b3-menu__item--current");if(!s)return!0;const a=hasClosestByClassName(s,"b3-menu__item--show");return a&&(a.classList.remove("b3-menu__item--show"),a.classList.add("b3-menu__item--current"),s.classList.remove("b3-menu__item--current")),!0}else if(n==="\u21A9"){const s=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(s){const a=s.querySelector(".b3-text-field"),i=s.querySelector(".b3-switch");if(a)return a.focus(),!0;i?i.click():s.dispatchEvent(new CustomEvent(getEventName())),window.siyuan.menus.menu.remove()}else return!1;return!0}};class Mo{constructor(){this.menus=[]}addSeparator(t){typeof t=="number"?this.menus.splice(t,0,{type:"separator"}):this.menus.push({type:"separator"})}addItem(t){typeof t.index=="number"?this.menus.splice(t.index,0,t):this.menus.push(t)}}const za=(e,t)=>/\r\n|\r|\n|\u2028|\u2029|\t|\//.test(e)?(t?showTooltip(window.siyuan.languages.fileNameRule,t,!0):showMessage(window.siyuan.languages.fileNameRule),!1):e.length>Constants.SIZE_TITLE?(t?showTooltip(window.siyuan.languages._kernel[106],t,!0):showMessage(window.siyuan.languages._kernel[106]),!1):!0,_n=e=>e.replace(/\r\n|\r|\n|\u2028|\u2029|\t|\//g,"").substring(0,Constants.SIZE_TITLE),Do=e=>e.replace(/\\\\|\/|"|:|\*|\?|\\|'|<|>|\|/g,""),$o=e=>{if(window.siyuan.config.readonly)return;const t=new Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px",destroyCallback(){e.range&&focusByRange(e.range)}});t.element.setAttribute("data-key",Constants.DIALOG_RENAME);const n=t.element.querySelector("input"),s=t.element.querySelectorAll(".b3-button");t.bindInput(n,()=>{s[1].click()}),n.value=Lute.UnEscapeHTMLStr(e.name),n.focus(),n.select(),s[0].addEventListener("click",()=>{t.destroy()}),s[1].addEventListener("click",()=>{if(!za(n.value))return!1;if(n.value===e.name)return t.destroy(),!1;n.value.trim()===""?n.value="Untitled":n.value=_n(n.value),e.type==="notebook"?fetchPost("/api/notebook/renameNotebook",{notebook:e.notebookId,name:n.value},()=>{setNotebookName(e.notebookId,n.value)}):fetchPost("/api/filetree/renameDoc",{notebook:e.notebookId,path:e.path,title:n.value}),t.destroy()})},Ho=e=>{const t=new Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});t.element.setAttribute("data-key",Constants.DIALOG_RENAMEASSETS);const n=t.element.querySelector("input"),s=t.element.querySelectorAll(".b3-button");t.bindInput(n,()=>{s[1].click()});const a=getAssetName(e);n.value=a,n.focus(),n.select(),s[0].addEventListener("click",()=>{t.destroy()}),s[1].addEventListener("click",()=>{if(n.value===a||!n.value)return t.destroy(),!1;fetchPost("/api/asset/renameAsset",{oldPath:e,newName:n.value})})},No=e=>{if(getSelection().rangeCount===0)return;const t=getSelection().getRangeAt(0),n=hasClosestBlock(t.startContainer);if(!n)return;let s=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));s.length===0&&(s=[n]);let a="",i=t.toString();if(i===""){if(i=s[0].textContent,s.forEach(l=>{a+=removeEmbed(l)}),!i)return}else{const l=document.createElement("div");l.appendChild(t.cloneContents()),a=l.innerHTML}i.length>10&&(i=i.substr(0,10)+"..."),i=_n(i),fetchPost("/api/filetree/createDoc",{notebook:e.notebookId,path:pathPosix().join(getDisplayName(e.path,!1,!0),Lute.NewNodeID()+".sy"),title:i,md:e.lute.BlockDOM2StdMd(a)})};var ct=ke(680);const Bo=(e,t)=>{},Po=e=>{const t=new Dialog({title:window.siyuan.languages.exportAsImage,content:`<div class="b3-dialog__content" style="${isMobile()?"padding:8px;":""};background-color: var(--b3-theme-background)">
    <div style="${isMobile()?"padding: 16px;margin: 8px 0":"padding: 48px;margin: 8px 0"};" class="export-img">
        <div class="protyle-wysiwyg${window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":""}"></div>
        <div class="export-img__watermark"></div>
    </div>
</div>
<div class="b3-dialog__action">
    <label class="fn__flex">
        ${window.siyuan.languages.exportPDF5}
        <span class="fn__space"></span>
        <input id="keepFold" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[Constants.LOCAL_EXPORTIMG].keepFold?"checked":""}>
    </label>
    <label class="fn__flex" style="margin-left: 24px">
        ${window.siyuan.languages.export9}
        <span class="fn__space"></span>
        <input id="watermark" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[Constants.LOCAL_EXPORTIMG].watermark?"checked":""}>
    </label>
    <span class="fn__flex-1"></span>
    <button disabled class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button disabled class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>
 <div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>`,width:isMobile()?"92vw":"990px",height:"70vh"});t.element.setAttribute("data-key",Constants.DIALOG_EXPORTIMAGE);const n=t.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>{const r=showMessage(window.siyuan.languages.exporting,0);t.element.querySelector(".b3-dialog__container").style.height="",setStorageVal(Constants.LOCAL_EXPORTIMG,window.siyuan.storage[Constants.LOCAL_EXPORTIMG]),setTimeout(()=>{addScript("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{window.html2canvas(t.element.querySelector(".b3-dialog__content"),{useCORS:!0}).then(c=>{c.toBlob(f=>{const u=new FormData;u.append("file",f,n[1].getAttribute("data-title")),u.append("type","image/png"),fetchPost("/api/export/exportAsFile",u,d=>{openByMobile(d.data.file)}),hideMessage(r),t.destroy()})})})},Constants.TIMEOUT_LOAD)});const s=t.element.querySelector(".protyle-wysiwyg"),a=t.element.querySelector("#keepFold");a.addEventListener("change",()=>{n[0].setAttribute("disabled","disabled"),n[1].setAttribute("disabled","disabled"),n[1].parentElement.insertAdjacentHTML("afterend",'<div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>'),window.siyuan.storage[Constants.LOCAL_EXPORTIMG].keepFold=a.checked,fetchPost("/api/export/exportPreviewHTML",{id:e,keepFold:a.checked,image:!0},r=>{o(r)})});const i=t.element.querySelector("#watermark");i.addEventListener("change",()=>{window.siyuan.storage[Constants.LOCAL_EXPORTIMG].watermark=i.checked,i.checked&&!isPaidUser()&&(i.checked=!1,showMessage(window.siyuan.languages._kernel[214])),l()});const l=()=>{if(!isPaidUser())return;const r=t.element.querySelector(".export-img__watermark");r.innerHTML="",i.checked?window.siyuan.config.export.imageWatermarkDesc?r.innerHTML=window.siyuan.config.export.imageWatermarkDesc:window.siyuan.config.export.imageWatermarkStr&&(window.siyuan.config.export.imageWatermarkStr.startsWith("http")?r.setAttribute("style",`background-image: url(${window.siyuan.config.export.imageWatermarkStr});background-repeat: repeat;position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: var(--b3-border-radius-b);`):addScript("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{const c=Math.max(t.element.querySelector(".export-img").clientWidth/3,150);r.setAttribute("style",`width: ${c}px;height: ${c}px;display: flex;justify-content: center;align-items: center;color: var(--b3-border-color);font-size: 14px;`),r.innerHTML=`<div style="transform: rotate(-45deg)">${window.siyuan.config.export.imageWatermarkStr}</div>`,window.html2canvas(r,{useCORS:!0,scale:1}).then(f=>{r.innerHTML="",r.setAttribute("style",`background-image: url(${f.toDataURL("image/png")});background-repeat: repeat;position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: var(--b3-border-radius-b);`)})})):r.removeAttribute("style")},o=r=>{s.innerHTML=r.data.content,s.querySelectorAll('[data-type~="mark"], [data-type~="u"], [data-type~="text"], [data-type~="code"], [data-type~="tag"], [data-type~="kbd"]').forEach(c=>{c.childNodes.forEach(f=>{let u="";Array.from(f.textContent).forEach(g=>{u+=`<span style="${c.getAttribute("style")||""};border-radius: 0;padding-left: 0;padding-right: 0;box-shadow: none;border-left:0;border-right:0;border-top:0" data-type="${c.getAttribute("data-type")}">${g}</span>`});const d=document.createElement("template");d.innerHTML=u,f.after(d.content),f.remove()}),c.childNodes.length>0&&(c.setAttribute("style",""),c.setAttribute("data-type",c.getAttribute("data-type").replace(/mark|u|text|code|tag|kbd/g,"")))}),s.setAttribute("data-doc-type",r.data.type||"NodeDocument"),r.data.attrs.memo&&s.setAttribute("memo",r.data.attrs.memo),r.data.attrs.name&&s.setAttribute("name",r.data.attrs.name),r.data.attrs.bookmark&&s.setAttribute("bookmark",r.data.attrs.bookmark),r.data.attrs.alias&&s.setAttribute("alias",r.data.attrs.alias),processRender(s),highlightRender(s),s.querySelectorAll("table").forEach(c=>{c.clientWidth>c.parentElement.clientWidth&&(c.setAttribute("style",`margin-bottom:${c.parentElement.clientWidth*c.clientHeight/c.clientWidth-c.parentElement.clientHeight+1}px;transform: scale(${c.parentElement.clientWidth/c.clientWidth});transform-origin: top left;`),c.parentElement.style.overflow="hidden")}),s.querySelectorAll(".li > .protyle-action > svg").forEach(c=>{const f=c.firstElementChild.getAttribute("xlink:href"),u=document.querySelectorAll(f);let d="0 0 32 32";f==="#iconDot"&&(d="0 0 20 20"),c.setAttribute("viewBox",d),c.innerHTML=u[u.length-1].innerHTML}),s.querySelectorAll(".img img").forEach(c=>{c.src.endsWith(".svg")&&fetchGet(c.src,f=>{c.src=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(f)))}`})}),l(),n[0].removeAttribute("disabled"),n[1].removeAttribute("disabled"),t.element.querySelector(".fn__loading").remove()};fetchPost("/api/export/exportPreviewHTML",{id:e,keepFold:a.checked,image:!0},r=>{o(r),n[1].setAttribute("data-title",r.data.name+".png")})},Ka=e=>{let t="";switch(e.type){case"block":t=e.block.content;break;case"text":t=e.text.content;break;case"number":t=e.number.formattedContent||e.number.content.toString();break;case"date":e[e.type]&&e[e.type].isNotEmpty&&(t=dayjs(e[e.type].content).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),e[e.type]&&e[e.type].hasEndDate&&e[e.type].isNotEmpty&&e[e.type].isNotEmpty2&&(t+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${dayjs(e[e.type].content2).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),t&&(t=`<span class="av__celltext">${t}</span>`);break;case"url":t=e.url.content?`<a class="fn__a" href="${e.url.content}" target="_blank">${e.url.content}</a>`:"";break;case"phone":t=e.phone.content?`<a class="fn__a" href="tel:${e.phone.content}" target="_blank">${e.phone.content}</a>`:"";break;case"email":t=e.email.content?`<a class="fn__a" href="mailto:${e.email.content}" target="_blank">${e.email.content}</a>`:"";break}return t},vn=e=>{var t,n,s,a,i,l;let o="";switch(e.type){case"block":o=`<div class="fn__flex-1">${e.block.content}</div>`;break;case"text":o=`<textarea rows="${e.text.content.split(`
`).length}" class="b3-text-field b3-text-field--text fn__flex-1">${e.text.content}</textarea>`;break;case"number":o=`<input value="${e.number.content}" type="number" class="b3-text-field b3-text-field--text fn__flex-1">`;break;case"mSelect":case"select":(t=e.mSelect)==null||t.forEach(r=>{o+=`<span class="b3-chip b3-chip--middle" style="background-color:var(--b3-font-background${r.color});color:var(--b3-font-color${r.color})">${r.content}</span>`});break;case"mAsset":(n=e.mAsset)==null||n.forEach(r=>{r.type==="image"?o+=`<img class="av__cellassetimg" src="${r.content}">`:o+=`<span class="b3-chip b3-chip--middle av__celltext--url" data-url="${r.content}">${r.name}</span>`});break;case"date":o=`<span class="av__celltext" data-value='${JSON.stringify(e[e.type])}'>`,e[e.type]&&e[e.type].isNotEmpty&&(o+=dayjs(e[e.type].content).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),e[e.type]&&e[e.type].hasEndDate&&e[e.type].isNotEmpty&&e[e.type].isNotEmpty2&&(o+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${dayjs(e[e.type].content2).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),o+="</span>";break;case"created":case"updated":e[e.type].isNotEmpty&&(o=`<span data-content="${e[e.type].content}">${dayjs(e[e.type].content).format("YYYY-MM-DD HH:mm")}</span>`);break;case"url":o=`<input value="${e.url.content}" class="b3-text-field b3-text-field--text fn__flex-1">
<span class="fn__space"></span>
<a href="${e.url.content}" target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconLink"></use></svg></a>`;break;case"phone":o=`<input value="${e.phone.content}" class="b3-text-field b3-text-field--text fn__flex-1">
<span class="fn__space"></span>
<a href="tel:${e.phone.content}" target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconPhone"></use></svg></a>`;break;case"checkbox":o=`<svg class="av__checkbox" style="height: 17px;"><use xlink:href="#icon${e.checkbox.checked?"Check":"Uncheck"}"></use></svg>`;break;case"template":o=`<div class="fn__flex-1">${e.template.content}</div>`;break;case"email":o=`<input value="${e.email.content}" class="b3-text-field b3-text-field--text fn__flex-1">
<span class="fn__space"></span>
<a href="mailto:${e.email.content}" target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconEmail"></use></svg></a>`;break;case"relation":(a=(s=e.relation)==null?void 0:s.blockIDs)==null||a.forEach((r,c)=>{var f;o+=`<span class="av__celltext--url" style="margin-right: 8px" data-id="${r}">${((f=e.relation)==null?void 0:f.contents[c])||"Untitled"}</span>`});break;case"rollup":(l=(i=e==null?void 0:e.rollup)==null?void 0:i.contents)==null||l.forEach(r=>{const c=["select","mSelect","mAsset","checkbox","relation"].includes(r.type)?vn(r):Ka(r);c&&(o+=c+", ")}),o&&o.endsWith(", ")&&(o=o.substring(0,o.length-2));break}return o},Ro=(e,t,n,s)=>{fetchPost("/api/av/getAttributeViewKeys",{id:t},a=>{let i="";if(a.data.forEach(l=>{var o;i+=`<div data-av-id="${l.avID}" data-node-id="${t}" data-type="NodeAttributeView">
<div class="custom-attr__avheader block__logo popover__block" data-id='${JSON.stringify(l.blockIDs)}'>
    <div class="fn__flex-1"></div>
    <svg class="block__logoicon"><use xlink:href="#iconDatabase"></use></svg><span>${l.avName||window.siyuan.languages.database}</span>
    <div class="fn__flex-1"></div>
</div>`,(o=l.keyValues)==null||o.forEach(r=>{var c;i+=`<div class="block__icons av__row" data-col-id="${r.key.id}">
    <div class="block__icon" draggable="true"><svg><use xlink:href="#iconDrag"></use></svg></div>
    <div class="block__logo ariaLabel${r.values[0].type==="block"?"":" fn__pointer"}" data-type="editCol" data-position="parentW" aria-label="${escapeAttr(r.key.name)}"">
        ${r.key.icon?unicode2Emoji(r.key.icon,"block__logoicon",!0):`<svg class="block__logoicon"><use xlink:href="#${getColIconByType(r.key.type)}"></use></svg>`}
        <span>${r.key.name}</span>
    </div>
    <div data-av-id="${l.avID}" data-col-id="${r.values[0].keyID}" data-block-id="${r.values[0].blockID}" data-id="${r.values[0].id}" data-type="${r.values[0].type}" 
data-options="${(c=r.key)!=null&&c.options?escapeAttr(JSON.stringify(r.key.options)):"[]"}"
class="fn__flex-1 fn__flex${["url","text","number","email","phone","block"].includes(r.values[0].type)?"":" custom-attr__avvalue"}">
        ${vn(r.values[0])}
    </div>
</div>`}),i+=`<div class="fn__hr"></div>
<div class="fn__flex">
    <div class="fn__flex-1"></div>
    <button data-type="addColumn" class="b3-button b3-button--outline"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}</button>
    <div class="fn__space"></div>
</div></div>`}),e.innerHTML===""){let l;e.addEventListener("dragstart",o=>{const r=o.target;window.siyuan.dragElement=r.parentElement,window.siyuan.dragElement.style.opacity=".1",l=hasClosestBlock(window.siyuan.dragElement);const c=document.createElement("div");c.className="block__icons",c.innerHTML=r.nextElementSibling.outerHTML,c.setAttribute("style","width: 160px;position:fixed;opacity:.1;"),document.body.append(c),o.dataTransfer.setDragImage(c,0,0),setTimeout(()=>{c.remove()})}),e.addEventListener("drop",()=>{var o,r;window.siyuan.dragElement.style.opacity="";const c=e.querySelector(".dragover__bottom, .dragover__top");if(c&&l){const f=c.classList.contains("dragover__bottom");transaction(n,[{action:"sortAttrViewCol",avID:l.dataset.avId,previousID:f?c.dataset.colId:(o=c.previousElementSibling)==null?void 0:o.getAttribute("data-col-id"),id:window.siyuan.dragElement.dataset.colId},{action:"sortAttrViewCol",avID:l.dataset.avId,previousID:(r=window.siyuan.dragElement.previousElementSibling)==null?void 0:r.getAttribute("data-col-id"),id:t}]),f?c.after(window.siyuan.dragElement):c.before(window.siyuan.dragElement),c.classList.remove("dragover__bottom","dragover__top")}window.siyuan.dragElement=null}),e.addEventListener("dragover",o=>{const r=o.target;let c=hasClosestByClassName(r,"av__row");if(c||(c=hasClosestByClassName(document.elementFromPoint(o.clientX,o.clientY-1),"av__row")),!c||c.isSameNode(window.siyuan.dragElement)||!l)return;const f=hasClosestBlock(c);if(!f||!f.isSameNode(l))return;o.preventDefault();const u=c.getBoundingClientRect();c.classList.remove("dragover__bottom","dragover__top"),o.clientY>u.top+u.height/2?c.classList.add("dragover__bottom"):c.classList.add("dragover__top")}),e.addEventListener("dragleave",()=>{e.querySelectorAll(".dragover__bottom, .dragover__top").forEach(o=>{o.classList.remove("dragover__bottom","dragover__top")})}),e.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),e.addEventListener("click",o=>{let r=o.target;const c=hasClosestBlock(r);if(c)for(;r&&!e.isSameNode(r);){const f=r.getAttribute("data-type");if(f==="date"){popTextCell(n,[r],"date"),o.stopPropagation(),o.preventDefault();break}else if(f==="select"||f==="mSelect"){popTextCell(n,[r],r.getAttribute("data-type")),o.stopPropagation(),o.preventDefault();break}else if(f==="mAsset"){popTextCell(n,[r],"mAsset"),o.stopPropagation(),o.preventDefault();break}else if(f==="checkbox"){popTextCell(n,[r],"checkbox"),o.stopPropagation(),o.preventDefault();break}else if(f==="relation"){popTextCell(n,[r],"relation"),o.stopPropagation(),o.preventDefault();break}else if(f==="template"){popTextCell(n,[r],"template"),o.stopPropagation(),o.preventDefault();break}else if(f==="rollup"){popTextCell(n,[r],"rollup"),o.stopPropagation(),o.preventDefault();break}else if(f==="addColumn"){const u=c.querySelectorAll(".av__row"),d=addCol(n,c,u[u.length-1].getAttribute("data-col-id")),g=r.getBoundingClientRect();d.open({x:g.left,y:g.bottom,h:g.height}),o.stopPropagation(),o.preventDefault();break}else if(f==="editCol"){r.classList.contains("fn__pointer")&&openMenuPanel({protyle:n,blockElement:c,type:"edit",colId:r.parentElement.dataset.colId}),o.stopPropagation(),o.preventDefault();break}r=r.parentElement}})}e.innerHTML=i,e.querySelectorAll(".b3-text-field--text").forEach(l=>{l.addEventListener("change",()=>{let o;["url","text","email","phone"].includes(l.parentElement.dataset.type)?o={[l.parentElement.dataset.type]:{content:l.value}}:l.parentElement.dataset.type==="number"&&(o={number:{content:parseFloat(l.value)}}),fetchPost("/api/av/setAttributeViewBlockAttr",{avID:l.parentElement.dataset.avId,keyID:l.parentElement.dataset.colId,rowID:l.parentElement.dataset.blockId,cellID:l.parentElement.dataset.id,value:o})})}),s&&s(e)})};var Za=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const En=(e,t)=>{e.addEventListener("change",()=>{fetchPost("/api/attr/setBlockAttrs",{id:t,attrs:{[e.dataset.name]:e.value}})})},Oo=e=>{const t=e.getAttribute("data-node-id"),n=getEditorRange(e),s=e.getAttribute(Constants.CUSTOM_REMINDER_WECHAT);let a="";s&&(a=dayjs(s).format("YYYY-MM-DD HH:mm"));const i=new Dialog({width:isMobile()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" max="9999-12-31 23:59" value="${a}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,destroyCallback(){focusByRange(n)}});i.element.setAttribute("data-key",Constants.DIALOG_WECHATREMINDER);const l=i.element.querySelectorAll(".b3-button");l[0].addEventListener("click",()=>{i.destroy()}),l[1].addEventListener("click",()=>{l[1].getAttribute("disabled")||(l[1].setAttribute("disabled","disabled"),fetchPost("/api/block/setBlockReminder",{id:t,timed:"0"},()=>{e.removeAttribute(Constants.CUSTOM_REMINDER_WECHAT),i.destroy()}))}),l[2].addEventListener("click",()=>{const o=i.element.querySelector("input").value;if(o){if(new Date(o)<=new Date){showMessage(window.siyuan.languages.reminderTip);return}if(l[2].getAttribute("disabled"))return;l[2].setAttribute("disabled","disabled");const r=dayjs(o).format("YYYYMMDDHHmmss");fetchPost("/api/block/setBlockReminder",{id:t,timed:r},()=>{e.setAttribute(Constants.CUSTOM_REMINDER_WECHAT,r),i.destroy()})}else showMessage(window.siyuan.languages.notEmpty)})},qo=e=>{fetchPost("/api/block/getDocInfo",{id:e.block.rootID},t=>{const n=t.data.ial[Constants.CUSTOM_REMINDER_WECHAT];let s="";n&&(s=dayjs(n).format("YYYY-MM-DD HH:mm"));const a=new Dialog({width:isMobile()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" max="9999-12-31 23:59" value="${s}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`});a.element.setAttribute("data-key",Constants.DIALOG_WECHATREMINDER);const i=a.element.querySelectorAll(".b3-button");i[0].addEventListener("click",()=>{a.destroy()}),i[1].addEventListener("click",()=>{fetchPost("/api/block/setBlockReminder",{id:e.block.rootID,timed:"0"},()=>{a.destroy()})}),i[2].addEventListener("click",()=>{const l=a.element.querySelector("input").value;if(l){if(new Date(l)<=new Date){showMessage(window.siyuan.languages.reminderTip);return}fetchPost("/api/block/setBlockReminder",{id:e.block.rootID,timed:dayjs(l).format("YYYYMMDDHHmmss")},()=>{a.destroy()})}else showMessage(window.siyuan.languages.notEmpty)})})},Xa=(e,t="bookmark",n)=>{let s="",a="",i=!1;const l=getSelection().rangeCount>0?getSelection().getRangeAt(0):null;Object.keys(e).forEach(r=>{Constants.CUSTOM_RIFF_DECKS===r||r.startsWith("custom-sy-")||(r===Constants.CUSTOM_REMINDER_WECHAT?a=`<label class="b3-label b3-label--noborder">
    ${window.siyuan.languages.wechatReminder}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" type="datetime-local" max="9999-12-31 23:59" readonly data-name="${r}" value="${dayjs(e[r]).format("YYYY-MM-DD HH:mm")}">
</label>`:r.indexOf("custom-av")>-1?i=!0:r.indexOf("custom")>-1&&(s+=`<label class="b3-label b3-label--noborder">
     <div class="fn__flex">
        <span class="fn__flex-1">${r.replace("custom-","")}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" rows="1" data-name="${r}">${e[r]}</textarea>
</label>`))});const o=new Dialog({width:isMobile()?"92vw":"50vw",height:"80vh",content:`<div class="fn__flex-column">
    <div class="layout-tab-bar fn__flex" style="flex-shrink:0;border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
        <div class="item item--full item--focus" data-type="attr">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.builtIn}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full${i?"":" fn__none"}" data-type="NodeAttributeView">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.database}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full" data-type="custom">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.custom}</span>
            <span class="fn__flex-1"></span>
        </div>
    </div>
    <div class="fn__flex-1">
        <div class="custom-attr" data-type="attr">
            <label class="b3-label b3-label--noborder">
                <div class="fn__flex">
                    <span class="fn__flex-1">${window.siyuan.languages.bookmark}</span>
                    <span data-action="bookmark" class="block__icon block__icon--show"><svg><use xlink:href="#iconDown"></use></svg></span>
                </div>
                <div class="fn__hr"></div>
                <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrBookmarkTip}" data-name="bookmark">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.name}
                <div class="fn__hr"></div>
                <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrNameTip}" data-name="name">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.alias}
                <div class="fn__hr"></div>
                <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrAliasTip}" data-name="alias">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.memo}
                <div class="fn__hr"></div>
                <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrMemoTip}" rows="2" data-name="memo">${e.memo||""}</textarea>
            </label>
            ${a}
        </div>
        <div data-type="NodeAttributeView" class="fn__none custom-attr"></div>
        <div data-type="custom" class="fn__none custom-attr">
           ${s}
           <div class="b3-label">
               <button data-action="addCustom" class="b3-button b3-button--outline">
                   <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}
               </button>
           </div>
        </div>
    </div>
</div>`,destroyCallback(){focusByRange(l)}});o.element.setAttribute("data-key",Constants.DIALOG_ATTR),o.element.querySelector('.b3-text-field[data-name="bookmark"]').value=e.bookmark||"",o.element.querySelector('.b3-text-field[data-name="name"]').value=e.name||"",o.element.querySelector('.b3-text-field[data-name="alias"]').value=e.alias||"",o.element.addEventListener("click",r=>{let c=r.target;for(typeof r.detail=="string"&&(c=o.element.querySelector('.item--full[data-type="NodeAttributeView"]'));!c.isSameNode(o.element);){const f=c.dataset.action;if(c.classList.contains("item--full"))c.parentElement.querySelector(".item--focus").classList.remove("item--focus"),c.classList.add("item--focus"),o.element.querySelectorAll(".custom-attr").forEach(u=>{u.dataset.type===c.dataset.type?(u.dataset.type==="NodeAttributeView"&&u.innerHTML===""&&renderAVAttribute(u,e.id,n),u.classList.remove("fn__none")):u.classList.add("fn__none")});else if(f==="remove"){fetchPost("/api/attr/setBlockAttrs",{id:e.id,attrs:{["custom-"+c.previousElementSibling.textContent]:""}}),c.parentElement.parentElement.remove(),r.stopPropagation(),r.preventDefault();break}else if(f==="bookmark"){fetchPost("/api/attr/getBookmarkLabels",{},u=>{window.siyuan.menus.menu.remove(),u.data.length===0?window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,label:window.siyuan.languages.emptyContent,type:"readonly"}).element):u.data.forEach(d=>{window.siyuan.menus.menu.append(new MenuItem({label:d,click(){const g=c.parentElement.parentElement.querySelector("input");g.value=d,g.dispatchEvent(new CustomEvent("change"))}}).element)}),window.siyuan.menus.menu.element.classList.add("b3-menu--list"),window.siyuan.menus.menu.popup({x:r.clientX,y:r.clientY+16,w:16})}),r.stopPropagation(),r.preventDefault();break}else if(f==="addCustom"){const u=new Dialog({title:window.siyuan.languages.attrName,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});u.element.setAttribute("data-key",Constants.DIALOG_SETCUSTOMATTR);const d=u.element.querySelector("input"),g=u.element.querySelectorAll(".b3-button");u.bindInput(d,()=>{g[1].click()}),d.focus(),d.select(),g[0].addEventListener("click",()=>{u.destroy()}),g[1].addEventListener("click",()=>{if(!isValidAttrName(d.value))return showMessage(window.siyuan.languages.attrName+" <b>"+d.value+"</b> "+window.siyuan.languages.invalid),!1;c.parentElement.insertAdjacentHTML("beforebegin",`<div class="b3-label b3-label--noborder">
    <div class="fn__flex">
        <span class="fn__flex-1">${d.value}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea data-name="custom-${d.value}" class="b3-text-field fn__block" rows="1" placeholder="${window.siyuan.languages.attrValue1}"></textarea>
</div>`);const p=c.parentElement.previousElementSibling.querySelector(".b3-text-field");p.focus(),En(p,e.id),u.destroy()}),r.stopPropagation(),r.preventDefault();break}c=c.parentElement}}),o.element.querySelectorAll(".b3-text-field").forEach(r=>{t!=="av"&&t===r.getAttribute("data-name")&&r.focus(),En(r,e.id)}),t==="av"&&o.element.dispatchEvent(new CustomEvent("click",{detail:"av"}))},Fo=(e,t="bookmark",n)=>{if(e.getAttribute("data-type")==="NodeThematicBreak")return;const s=e.getAttribute("data-node-id");fetchPost("/api/attr/getBlockAttrs",{id:s},a=>{Xa(a.data,t,n)})},Yo=(e,t=!0,n)=>[{icon:"iconRef",accelerator:t?window.siyuan.config.keymap.editor.general.copyBlockRef.custom:void 0,label:window.siyuan.languages.copyBlockRef,click:()=>{fetchPost("/api/block/getRefText",{id:e},s=>{writeText(`((${e} '${s.data}'))`)}),n&&focusBlock(n)}},{icon:"iconSQL",label:window.siyuan.languages.copyBlockEmbed,accelerator:t?window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom:void 0,click:()=>{writeText(`{{select * from blocks where id='${e}'}}`),n&&focusBlock(n)}},{icon:"iconSiYuan",label:window.siyuan.languages.copyProtocol,accelerator:t?window.siyuan.config.keymap.editor.general.copyProtocol.custom:void 0,click:()=>{writeText(`siyuan://blocks/${e}`),n&&focusBlock(n)}},{label:window.siyuan.languages.copyProtocolInMd,accelerator:t?window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom:void 0,click:()=>{fetchPost("/api/block/getRefText",{id:e},s=>{writeText(`[${s.data}](siyuan://blocks/${e})`)}),n&&focusBlock(n)}},{label:window.siyuan.languages.copyHPath,accelerator:t?window.siyuan.config.keymap.editor.general.copyHPath.custom:void 0,click:()=>{fetchPost("/api/filetree/getHPathByID",{id:e},s=>{writeText(s.data)})}},{label:window.siyuan.languages.copyID,accelerator:t?window.siyuan.config.keymap.editor.general.copyID.custom:void 0,click:()=>{writeText(e),n&&focusBlock(n)}}],Wo=e=>new MenuItem({label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{label:window.siyuan.languages.template,iconClass:"ft__error",icon:"iconMarkdown",click:()=>Za(void 0,null,function*(){const t=yield fetchSyncPost("/api/block/getRefText",{id:e}),n=new Dialog({title:window.siyuan.languages.fileName,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});n.element.setAttribute("data-key",Constants.DIALOG_EXPORTTEMPLATE);const s=n.element.querySelector("input"),a=n.element.querySelectorAll(".b3-button");n.bindInput(s,()=>{a[1].click()});let i=replaceFileName(t.data);const l=32;i.length>l&&(i=i.substring(0,l)),s.value=i,s.focus(),s.select(),a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{s.value.trim()===""?s.value="Untitled":s.value=replaceFileName(s.value),i.length>l&&(i=i.substring(0,l)),fetchPost("/api/template/docSaveAsTemplate",{id:e,name:s.value,overwrite:!1},o=>{if(o.code===1){confirmDialog(window.siyuan.languages.export,window.siyuan.languages.exportTplTip,()=>{fetchPost("/api/template/docSaveAsTemplate",{id:e,name:s.value,overwrite:!0},r=>{r.code===0&&showMessage(window.siyuan.languages.exportTplSucc)})});return}showMessage(window.siyuan.languages.exportTplSucc)}),n.destroy()})})},{label:"Markdown",icon:"iconMarkdown",click:()=>{const t=showMessage(window.siyuan.languages.exporting,-1);fetchPost("/api/export/exportMd",{id:e},n=>{hideMessage(t),openByMobile(n.data.zip)})}},{label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const t=showMessage(window.siyuan.languages.exporting,-1);fetchPost("/api/export/exportSY",{id:e},n=>{hideMessage(t),openByMobile(n.data.zip)})}},{label:window.siyuan.languages.image,icon:"iconImage",click:()=>{exportImage(e)}}]}).element,jo=(e,t,n,s)=>{const a=[];if(isLocalPath(t)&&Constants.SIYUAN_ASSETS_EXTS.includes(pathPosix().extname(t))&&(!t.endsWith(".pdf")||t.endsWith(".pdf")&&t.startsWith("file://")),a.push({label:window.siyuan.languages.useBrowserView,accelerator:s?"Click":"",click:()=>{openByMobile(t)}}),n)return a;window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:a}).element)},Uo=e=>new MenuItem({accelerator:window.siyuan.config.keymap.editor.general.rename.custom,icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{rename(e)}}).element,Vo=e=>new MenuItem({label:window.siyuan.languages.move,icon:"iconMove",accelerator:window.siyuan.config.keymap.general.move.custom,click(){movePathTo((t,n)=>{moveToPath(e,n[0],t[0])},e)}}).element;class Go{constructor(t=""){this.eventTarget=document.appendChild(document.createComment(t))}on(t,n){t==="loaded-protyle"&&console.warn("0.8.8 \u5C06\u79FB\u9664 loaded-protyle, \u8BF7\u4F7F\u7528 loaded-protyle-static \u8FDB\u884C\u66FF\u4EE3"),this.eventTarget.addEventListener(t,n)}once(t,n){this.eventTarget.addEventListener(t,n,{once:!0})}off(t,n){this.eventTarget.removeEventListener(t,n)}emit(t,n){return this.eventTarget.dispatchEvent(new CustomEvent(t,{detail:n,cancelable:!0}))}}const zo=e=>{const t=new subMenu;e.detail.menu=t,e.plugins.forEach(n=>{n.eventBus.emit(e.type,e.detail)}),t.menus.length>0&&(e.separatorPosition==="top"&&window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.plugin,icon:"iconPlugin",type:"submenu",submenu:t.menus}).element),e.separatorPosition==="bottom"&&window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element))},Ko=e=>{addScript(`${Constants.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.10.4`,"protyleViewerScript").then(()=>{const t=document.createElement("ul");t.innerHTML=`<li><img src="${e}"></li>`,window.siyuan.viewer=new Viewer(t,{title:[1,(n,s)=>{let a=n.alt;return a||(a=n.src.substring(n.src.lastIndexOf("/")+1)),a=a.substring(0,a.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${a} [${s.naturalWidth} \xD7 ${s.naturalHeight}]`}],button:!1,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})},Zo=(e,t)=>{addScript(`${Constants.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.10.4`,"protyleViewerScript").then(()=>{fetchPost("/api/asset/getDocImageAssets",{id:t},n=>{const s=document.createElement("ul");let a="",i=-1;n.data.forEach((l,o)=>{l&&(a+=`<li><img src="${l}"></li>`,i===-1&&(e.endsWith(encodeURI(l))||e.endsWith(l))&&(i=o))}),s.innerHTML=a,window.siyuan.viewer=new Viewer(s,{title:[1,(l,o)=>{let r=l.alt;return r||(r=l.src.substring(l.src.lastIndexOf("/")+1)),r=r.substring(0,r.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${r} [${o.naturalWidth} \xD7 ${o.naturalHeight}]`}],button:!1,initialViewIndex:i,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})})},ge=e=>{e.menu.addItem({iconHTML:"",label:kn(e.operator,!!e.data),click(){if(!e.data)transaction(e.protyle,[{action:"setAttrViewColCalc",avID:e.avId,id:e.colId,data:{operator:e.operator}}],[{action:"setAttrViewColCalc",avID:e.avId,id:e.colId,data:{operator:e.oldOperator}}]);else{e.target.querySelector(".b3-menu__accelerator").textContent=kn(e.operator,!0);const t=e.data.view.columns.find(n=>{if(n.id===e.colId)return n.rollup||(n.rollup={}),!0});t.rollup.calc={operator:e.operator},transaction(e.protyle,[{action:"updateAttrViewColRollup",id:e.colId,avID:e.avId,parentID:t.rollup.relationKeyID,keyID:t.rollup.keyID,data:{calc:t.rollup.calc}}],[{action:"updateAttrViewColRollup",id:e.colId,avID:e.avId,parentID:t.rollup.relationKeyID,keyID:t.rollup.keyID,data:{calc:{operator:e.oldOperator}}}])}}})},Xo=(e,t,n,s)=>{let a,i,l,o,r;if(n)o=n.id,i=t.dataset.colType,r=t.dataset.calc,l=s;else{const u=hasClosestBlock(t);if(!u||(a=hasClosestByClassName(t,"av__row--footer"),!a))return;a.classList.add("av__row--show"),i=t.dataset.dtype,l=t.dataset.colId,o=u.dataset.avId,r=t.dataset.operator}const c=new Menu("av-calc",()=>{a&&a.classList.remove("av__row--show")});if(c.isOpen)return;ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"",data:n,target:t}),ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Count all",data:n,target:t}),i!=="checkbox"?(ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Count values",data:n,target:t}),ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Count unique values",data:n,target:t}),ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Count empty",data:n,target:t}),ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Count not empty",data:n,target:t}),ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Percent empty",data:n,target:t}),ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Percent not empty",data:n,target:t})):(ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Checked",data:n,target:t}),ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Unchecked",data:n,target:t}),ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Percent checked",data:n,target:t}),ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Percent unchecked",data:n,target:t})),["number","template"].includes(i)?(ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Sum",data:n,target:t}),ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Average",data:n,target:t}),ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Median",data:n,target:t}),ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Min",data:n,target:t}),ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Max",data:n,target:t}),ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Range",data:n,target:t})):["date","created","updated"].includes(i)&&(ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Earliest",data:n,target:t}),ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Latest",data:n,target:t}),ge({menu:c,protyle:e,colId:l,avId:o,oldOperator:r,operator:"Range",data:n,target:t}));const f=t.getBoundingClientRect();c.open({x:f.left,y:f.bottom,h:f.height})},Qa=e=>{if(!e.calc||!e.calc.result)return"";let t=e.calc.result.number;(e.calc.operator==="Earliest"||e.calc.operator==="Latest"||e.calc.operator==="Range"&&["date","created","updated"].includes(e.type))&&(t=e.calc.result[e.type]);let n="";switch(e.calc.operator){case"Count all":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultCountAll}`;break;case"Count values":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultCountValues}`;break;case"Count unique values":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultCountUniqueValues}`;break;case"Count empty":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultCountEmpty}`;break;case"Count not empty":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultCountNotEmpty}`;break;case"Percent empty":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultPercentEmpty}`;break;case"Percent not empty":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultPercentNotEmpty}`;break;case"Sum":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultSum}`;break;case"Average":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultAverage}`;break;case"Median":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultMedian}`;break;case"Min":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultMin}`;break;case"Max":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultMax}`;break;case"Range":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultRange}`;break;case"Earliest":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcOperatorEarliest}`;break;case"Latest":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcOperatorLatest}`;break;case"Checked":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.checked}`;break;case"Unchecked":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.unchecked}`;break;case"Percent checked":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.percentChecked}`;break;case"Percent unchecked":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.percentUnchecked}`;break}return n},kn=(e,t)=>{switch(e){case"":return t?window.siyuan.languages.original:window.siyuan.languages.calcOperatorNone;case"Count all":return window.siyuan.languages.calcOperatorCountAll;case"Count values":return window.siyuan.languages.calcOperatorCountValues;case"Count unique values":return window.siyuan.languages.calcOperatorCountUniqueValues;case"Count empty":return window.siyuan.languages.calcOperatorCountEmpty;case"Count not empty":return window.siyuan.languages.calcOperatorCountNotEmpty;case"Percent empty":return window.siyuan.languages.calcOperatorPercentEmpty;case"Percent not empty":return window.siyuan.languages.calcOperatorPercentNotEmpty;case"Checked":return window.siyuan.languages.checked;case"Unchecked":return window.siyuan.languages.unchecked;case"Percent checked":return window.siyuan.languages.percentChecked;case"Percent unchecked":return window.siyuan.languages.percentUnchecked;case"Sum":return window.siyuan.languages.calcOperatorSum;case"Average":return window.siyuan.languages.calcOperatorAverage;case"Median":return window.siyuan.languages.calcOperatorMedian;case"Min":return window.siyuan.languages.calcOperatorMin;case"Max":return window.siyuan.languages.calcOperatorMax;case"Range":return window.siyuan.languages.calcOperatorRange;case"Earliest":return window.siyuan.languages.calcOperatorEarliest;case"Latest":return window.siyuan.languages.calcOperatorLatest;default:return""}},Ne=(e,t)=>{if(e.getAttribute("data-subtype")!=="o")return;let n;Array.from(e.children).forEach((s,a)=>{a===0?t?(n=t,s.setAttribute("data-marker",n+"."),s.querySelector(".protyle-action--order").textContent=n+"."):n=parseInt(s.getAttribute("data-marker")):s.classList.contains("li")&&(n++,s.setAttribute("data-marker",n+"."),s.querySelector(".protyle-action--order").textContent=n+".")})},Qo=(e,t=0,n=!1)=>{const s=document.createElement("template"),a=e.getAttribute("data-subtype");if(a==="o"){const i=parseInt(e.getAttribute("data-marker"))+t;s.innerHTML=`<div data-marker="${i+1}." data-subtype="${a}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div contenteditable="false" class="protyle-action protyle-action--order" draggable="true">${i+1}.</div>${genEmptyBlock(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`}else a==="t"?s.innerHTML=`<div data-marker="*" data-subtype="${a}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>${genEmptyBlock(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`:s.innerHTML=`<div data-marker="*" data-subtype="${a}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${genEmptyBlock(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`;return s.content.firstElementChild},Jo=(e,t,n)=>{const s=t[0].previousElementSibling;if(!s)return;n.collapse(!1),n.insertNode(document.createElement("wbr")),t.forEach(i=>{i.classList.remove("protyle-wysiwyg--select"),i.removeAttribute("select-start"),i.removeAttribute("select-end")});const a=s.parentElement.outerHTML;if(s.lastElementChild.previousElementSibling.getAttribute("data-type")==="NodeList"){const i=s.lastElementChild.previousElementSibling.outerHTML,l=[],o=[],r=s.lastElementChild.previousElementSibling.getAttribute("data-subtype");let c=s.lastElementChild.previousElementSibling.lastElementChild.previousElementSibling.getAttribute("data-node-id");t.forEach((f,u)=>{l.push({action:"move",id:f.getAttribute("data-node-id"),previousID:c}),o.push({action:"move",id:f.getAttribute("data-node-id"),previousID:u===0?s.getAttribute("data-node-id"):c}),c=f.getAttribute("data-node-id"),f.setAttribute("data-subtype",r);const d=f.querySelector(".protyle-action");r==="o"?(d.classList.add("protyle-action--order"),d.classList.remove("protyle-action--task"),s.lastElementChild.previousElementSibling.lastElementChild.before(f)):r==="t"?(f.setAttribute("data-marker","*"),d.innerHTML='<svg><use xlink:href="#iconUncheck"></use></svg>',d.classList.remove("protyle-action--order"),d.classList.add("protyle-action--task"),s.lastElementChild.previousElementSibling.lastElementChild.before(f)):(f.setAttribute("data-marker","*"),d.innerHTML='<svg><use xlink:href="#iconDot"></use></svg>',d.classList.remove("protyle-action--order","protyle-action--task"),s.lastElementChild.previousElementSibling.lastElementChild.before(f))}),r==="o"?(Ne(s.lastElementChild.previousElementSibling),Ne(s.parentElement)):s.getAttribute("data-subtype")==="o"&&Ne(s.parentElement),s.parentElement.classList.contains("protyle-wysiwyg")&&(l.push({action:"update",data:s.lastElementChild.previousElementSibling.outerHTML,id:s.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),o.push({action:"update",data:i,id:s.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),transaction(e,l,o))}else{const i=s.outerHTML,l=t[0].getAttribute("data-subtype"),o=document.createElement("div"),r=Lute.NewNodeID();o.setAttribute("data-node-id",r),o.setAttribute("data-type","NodeList"),o.setAttribute("class","list"),o.setAttribute("data-subtype",l),o.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';const c=[{action:"insert",data:o.outerHTML,id:r,previousID:s.lastElementChild.previousElementSibling.getAttribute("data-node-id")}];s.lastElementChild.before(o);const f=[];let u;t.forEach((d,g)=>{c.push({action:"move",id:d.getAttribute("data-node-id"),parentID:r,previousID:u}),f.push({action:"move",id:d.getAttribute("data-node-id"),previousID:g===0?s.getAttribute("data-node-id"):u}),u=d.getAttribute("data-node-id"),o.lastElementChild.before(d)}),f.push({action:"delete",id:r}),l==="o"&&(Ne(o,1),Ne(s.parentElement)),s.parentElement.classList.contains("protyle-wysiwyg")&&(c.push({action:"update",data:s.outerHTML,id:s.getAttribute("data-node-id")}),f.push({action:"update",data:i,id:s.getAttribute("data-node-id")}),transaction(e,c,f))}s.parentElement.classList.contains("protyle-wysiwyg")||updateTransaction(e,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,a),focusByWbr(s,n)},el=(e,t,n)=>{var s,a;const i=t.parentElement,l=i.getAttribute("data-node-id"),o=[],r=[];n.insertNode(document.createElement("wbr"));const c=Lute.NewNodeID();let f="",u=0;Array.from(i.parentElement.children).forEach(g=>{!u&&g.isSameNode(i)?u=1:u&&!g.classList.contains("protyle-attr")&&(r.push({id:g.getAttribute("data-node-id"),action:"move",previousID:l}),o.push({id:g.getAttribute("data-node-id"),action:"delete"}),g.getAttribute("data-subtype")==="o"&&(r.push({id:g.getAttribute("data-node-id"),action:"update",data:g.outerHTML}),g.setAttribute("data-marker",u+"."),g.firstElementChild.innerHTML=u+"."),f+=g.outerHTML,g.remove(),u++)}),r.reverse(),f=`<div data-subtype="${i.getAttribute("data-subtype")}" data-node-id="${c}" data-type="NodeList" class="list" updated="${dayjs().format("YYYYMMDDHHmmss")}">${f}<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`,i.parentElement.insertAdjacentHTML("afterend",f),o.push({id:c,action:"insert",previousID:i.parentElement.getAttribute("data-node-id"),data:f}),r.push({id:c,action:"delete"}),Array.from(i.children).reverse().forEach(g=>{!g.classList.contains("protyle-action")&&!g.classList.contains("protyle-attr")&&(o.push({id:g.getAttribute("data-node-id"),action:"move",previousID:i.parentElement.getAttribute("data-node-id")}),r.push({id:g.getAttribute("data-node-id"),action:"move",parentID:l}),i.parentElement.after(g))});const d=i.parentElement.getAttribute("data-node-id");i.parentElement.childElementCount===2?(r.splice(0,0,{id:d,action:"insert",data:i.parentElement.outerHTML,previousID:(s=i.parentElement.previousElementSibling)==null?void 0:s.getAttribute("data-node-id"),parentID:i.parentElement.parentElement.getAttribute("data-node-id")||e.block.rootID}),i.parentElement.remove(),o.push({id:d,action:"delete"})):(r.splice(0,0,{id:l,action:"insert",data:i.outerHTML,previousID:(a=i.previousElementSibling)==null?void 0:a.getAttribute("data-node-id"),parentID:d}),i.remove(),o.push({id:l,action:"delete"})),transaction(e,o,r),focusByWbr(e.wysiwyg.element,n)},tl=(e,t,n,s=!1,a)=>{var i,l,o,r,c,f,u,d;const g=t[0].parentElement,p=g.getAttribute("data-node-id");if(!p)return;const b=g.parentElement,m=b.parentElement;if((i=g.previousElementSibling)!=null&&i.classList.contains("protyle-action")&&!m.getAttribute("data-node-id"))return;if(b.classList.contains("protyle-wysiwyg")||b.classList.contains("sb")||b.classList.contains("bq")){const w=[],_=[];n.collapse(!1),moveToPrevious(a,n,s),n.insertNode(document.createElement("wbr"));let C;!t[0].previousElementSibling&&g.getAttribute("data-subtype")==="o"&&(C=parseInt(t[0].getAttribute("data-marker")));let x=p,T=g,B=t[t.length-1].nextElementSibling,D=t[t.length-1].lastElementChild.previousElementSibling;if(t.forEach(O=>{O.classList.remove("protyle-wysiwyg--select"),O.removeAttribute("select-start"),O.removeAttribute("select-end"),Array.from(O.children).forEach(($,U)=>{const ee=$.getAttribute("data-node-id");ee&&(w.push({action:"move",id:ee,previousID:x,parentID:b.getAttribute("data-node-id")||e.block.parentID}),_.push({action:"move",id:ee,previousID:U===1?void 0:x,parentID:O.getAttribute("data-node-id"),data:$.contains(n.startContainer)?"focus":""}),x=ee,T.after($),T=$)})}),!window.siyuan.config.editor.listLogicalOutdent&&!B.classList.contains("protyle-attr")){let O;D.getAttribute("data-subtype")!==B.getAttribute("data-subtype")&&(O=Lute.NewNodeID(),D=document.createElement("div"),D.classList.add("list"),D.setAttribute("data-subtype",B.getAttribute("data-subtype")),D.setAttribute("data-node-id",O),D.setAttribute("data-type","NodeList"),D.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),D.innerHTML=`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,T.after(D),w.push({action:"insert",id:O,data:D.outerHTML,previousID:T.getAttribute("data-node-id")}));let $;for(;B&&!B.classList.contains("protyle-attr");){w.push({action:"move",id:B.getAttribute("data-node-id"),previousID:$||((l=D.lastElementChild.previousElementSibling)==null?void 0:l.getAttribute("data-node-id")),parentID:D.getAttribute("data-node-id")}),_.push({action:"move",id:B.getAttribute("data-node-id"),parentID:D.getAttribute("data-node-id"),previousID:$||((o=B.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"))}),$=B.getAttribute("data-node-id");const U=B;B=B.nextElementSibling,D.lastElementChild.before(U)}D.getAttribute("data-subtype")==="o"&&(Array.from(D.children).forEach(U=>{const ee=U.getAttribute("data-node-id");ee&&_.push({action:"update",id:ee,data:U.outerHTML})}),Ne(D,1),Array.from(D.children).forEach(U=>{const ee=U.getAttribute("data-node-id");ee&&w.push({action:"update",id:ee,data:U.outerHTML})})),O&&_.push({action:"delete",id:O})}const H=g.outerHTML;t.forEach(O=>{O.remove()}),g.childElementCount===1?(w.push({action:"delete",id:p}),p===e.block.id&&(e.block.id=e.block.parentID),_.splice(0,0,{action:"insert",data:H,id:p,previousID:(r=g.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:b.getAttribute("data-node-id")||e.block.parentID}),g.remove()):(g.getAttribute("data-subtype")==="o"&&Ne(g,C),w.push({action:"update",id:p,data:g.outerHTML}),_.splice(0,0,{action:"update",id:p,data:H})),transaction(e,w,_),focusByWbr(b,n);return}if(g.childElementCount===2&&b.childElementCount===3){n.collapse(!1),moveToPrevious(a,n,s),n.insertNode(document.createElement("wbr"));const w=b.outerHTML;t[0].firstElementChild.remove(),t[0].lastElementChild.remove(),g.outerHTML=t[0].innerHTML,updateTransaction(e,b.getAttribute("data-node-id"),b.outerHTML,w),focusByWbr(b,n);return}n.collapse(!1),moveToPrevious(a,n,s),n.insertNode(document.createElement("wbr"));const h=[],y=[],k=(c=t[0].previousElementSibling)==null?void 0:c.getAttribute("data-node-id");t.forEach(w=>{w.classList.remove("protyle-wysiwyg--select"),w.removeAttribute("select-start"),w.removeAttribute("select-end")});let E;!t[0].previousElementSibling&&g.getAttribute("data-subtype")==="o"&&(E=parseInt(t[0].getAttribute("data-marker")));const A=b.parentElement.outerHTML;let v=t[t.length-1].nextElementSibling,S=t[t.length-1].lastElementChild.previousElementSibling;if(t.reverse().forEach(w=>{const _=w.getAttribute("data-node-id");h.push({action:"move",id:_,previousID:b.getAttribute("data-node-id")}),y.push({action:"move",id:_,previousID:k,parentID:g.getAttribute("data-node-id")}),b.after(w),(w.getAttribute("data-subtype")==="o"||w.getAttribute("data-subtype")==="t")&&b.getAttribute("data-subtype")==="u"?(y.push({action:"update",id:_,data:w.outerHTML}),w.querySelector(".protyle-action").outerHTML='<div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>',w.setAttribute("data-subtype","u"),w.setAttribute("data-marker","*"),h.push({action:"update",id:_,data:w.outerHTML})):(w.getAttribute("data-subtype")==="u"||w.getAttribute("data-subtype")==="t")&&b.getAttribute("data-subtype")==="o"?(y.push({action:"update",id:_,data:w.outerHTML}),w.querySelector(".protyle-action").outerHTML='<div contenteditable="false" draggable="true" class="protyle-action protyle-action--order">1.</div>',w.setAttribute("data-subtype","o"),w.setAttribute("data-marker","1."),h.push({action:"update",id:_,data:w.outerHTML})):(w.getAttribute("data-subtype")==="u"||w.getAttribute("data-subtype")==="0")&&b.getAttribute("data-subtype")==="t"&&(y.push({action:"update",id:_,data:w.outerHTML}),w.querySelector(".protyle-action").outerHTML='<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>',w.setAttribute("data-subtype","t"),w.setAttribute("data-marker","*"),h.push({action:"update",id:_,data:w.outerHTML}))}),!window.siyuan.config.editor.listLogicalOutdent&&!v.classList.contains("protyle-attr")){let w;S.classList.contains("list")||(w=Lute.NewNodeID(),S=document.createElement("div"),S.classList.add("list"),S.setAttribute("data-subtype",v.getAttribute("data-subtype")),S.setAttribute("data-node-id",w),S.setAttribute("data-type","NodeList"),S.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),S.innerHTML=`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,h.push({action:"insert",id:w,data:S.outerHTML,previousID:t[0].lastElementChild.previousElementSibling.getAttribute("data-node-id")}),t[0].lastElementChild.before(S));let _;for(;v&&!v.classList.contains("protyle-attr");){const C=v.getAttribute("data-node-id");v.getAttribute("data-subtype")!==S.getAttribute("data-subtype")&&(y.push({action:"update",id:C,data:v.outerHTML}),v.querySelector(".protyle-action").outerHTML=S.querySelector(".protyle-action").outerHTML,v.setAttribute("data-subtype",S.getAttribute("data-subtype")),v.setAttribute("data-marker",S.getAttribute("data-marker")),h.push({action:"update",id:C,data:v.outerHTML})),h.push({action:"move",id:C,previousID:_||((f=S.lastElementChild.previousElementSibling)==null?void 0:f.getAttribute("data-node-id")),parentID:S.getAttribute("data-node-id")}),y.push({action:"move",id:C,previousID:_||((u=S.parentElement)==null?void 0:u.getAttribute("data-node-id"))}),_=C;const x=v;v=v.nextElementSibling,S.lastElementChild.before(x)}S.getAttribute("data-subtype")==="o"&&(Array.from(S.children).forEach(C=>{const x=C.getAttribute("data-node-id");x&&y.push({action:"update",id:x,data:C.outerHTML})}),Ne(S,1),Array.from(S.children).forEach(C=>{const x=C.getAttribute("data-node-id");x&&h.push({action:"update",id:x,data:C.outerHTML})})),w&&y.push({action:"delete",id:w})}if(!window.siyuan.config.editor.listLogicalOutdent&&g.nextElementSibling){v=g.nextElementSibling;let w;for(;v&&!v.classList.contains("protyle-attr");){const _=v.getAttribute("data-node-id");h.push({action:"move",id:_,previousID:w||S.getAttribute("data-node-id")}),y.push({action:"move",id:_,previousID:w||g.getAttribute("data-node-id")}),w=_;const C=v;v=v.nextElementSibling,S.after(C),S=C}}g.childElementCount===1&&b.childElementCount===3?(h.push({action:"delete",id:b.getAttribute("data-node-id")}),y.splice(0,0,{action:"insert",id:b.getAttribute("data-node-id"),data:b.outerHTML,previousID:(d=b.previousElementSibling)==null?void 0:d.getAttribute("data-node-id"),parentID:b.parentElement.getAttribute("data-node-id")}),b.remove()):g.childElementCount===1?(h.push({action:"delete",id:g.getAttribute("data-node-id")}),y.splice(0,0,{action:"insert",id:g.getAttribute("data-node-id"),data:g.outerHTML,previousID:g.previousElementSibling.getAttribute("data-node-id")}),g.remove()):g.getAttribute("data-subtype")==="o"&&(y.splice(0,0,{action:"update",data:g.outerHTML,id:g.getAttribute("data-node-id")}),Ne(g,E),h.push({action:"update",data:g.outerHTML,id:g.getAttribute("data-node-id")})),m.classList.contains("protyle-wysiwyg")?transaction(e,h,y):(b&&b.getAttribute("data-subtype")==="o"&&Ne(m),updateTransaction(e,m.getAttribute("data-node-id"),m.outerHTML,A)),focusByWbr(m,n)},nl=(e,t)=>{if(e.includes("\u2303")){if(!t.ctrlKey)return!1}else if(isMac()?t.ctrlKey:e.includes("\u2318")?!t.ctrlKey:t.ctrlKey)return!1;if(e.includes("\u2325")){if(!t.altKey)return!1}else if(t.altKey)return!1;if(e.includes("\u21E7")){if(!t.shiftKey)return!1}else if(t.shiftKey)return!1;if(e.includes("\u2318")){if(isMac()?!t.metaKey:!t.ctrlKey)return!1}else if(isMac()?t.metaKey:e.includes("\u2303")?!t.ctrlKey:t.ctrlKey)return!1;return!0},al=(e,t)=>{if(!e)return!1;if(e.startsWith("\u2303")&&!isMac()){if(e==="\u2303D")return!1;e=e.replace("\u2318","").replace("\u2303","\u2318").replace("\u2318\u21E7","\u21E7\u2318").replace("\u2318\u2325\u21E7","\u2325\u21E7\u2318").replace("\u2318\u2325","\u2325\u2318")}if(e.indexOf("\u21E7")===-1&&e.indexOf("\u2318")===-1&&e.indexOf("\u2325")===-1&&e.indexOf("\u2303")===-1)return!!(isNotCtrl(t)&&!t.altKey&&!t.shiftKey&&e===Constants.KEYCODELIST[t.keyCode]);const n=e.split("");if(e.indexOf("F")>-1&&n.forEach((a,i)=>{a==="F"&&(n[i]="F"+n.splice(i+1,1),n[i+1]&&(n[i+1]+=n.splice(i+1,1)))}),e.startsWith("\u21E7")&&n.length===2)return!!(isNotCtrl(t)&&!t.altKey&&t.shiftKey&&n[1]===Constants.KEYCODELIST[t.keyCode]);if(e.startsWith("\u2325")){let a=n.length===3?n[2]:n[1];n.length===4&&(a=n[3]);const i=a===Constants.KEYCODELIST[t.keyCode];return!!(i&&t.altKey&&!t.shiftKey&&(n.length===3?isOnlyMeta(t)&&e.startsWith("\u2325\u2318"):isNotCtrl(t))||i&&e.startsWith("\u2325\u21E7\u2318")&&n.length===4&&t.altKey&&t.shiftKey&&isOnlyMeta(t)||i&&e.startsWith("\u2325\u21E7")&&n.length===3&&t.altKey&&t.shiftKey&&isNotCtrl(t))}if(e.startsWith("\u2303")){if(!isMac())return!1;let a=n.length===3?n[2]:n[1];n.length===4?a=n[3]:n.length===5&&(a=n[4]);const i=a===Constants.KEYCODELIST[t.keyCode];return!!(i&&t.ctrlKey&&!t.altKey&&!t.shiftKey&&n.length<4&&(n.length===3?t.metaKey&&e.startsWith("\u2303\u2318"):!t.metaKey)||i&&e.startsWith("\u2303\u21E7")&&n.length===3&&t.ctrlKey&&!t.altKey&&t.shiftKey&&!t.metaKey||i&&e.startsWith("\u2303\u2325")&&n.length===3&&t.ctrlKey&&t.altKey&&!t.shiftKey&&!t.metaKey||i&&n.length===4&&t.ctrlKey&&(e.startsWith("\u2303\u2325\u21E7")&&t.shiftKey&&!t.metaKey&&t.altKey||e.startsWith("\u2303\u2325\u2318")&&!t.shiftKey&&t.metaKey&&t.altKey||e.startsWith("\u2303\u21E7\u2318")&&t.shiftKey&&t.metaKey&&!t.altKey)||i&&n.length===5&&t.ctrlKey&&t.shiftKey&&t.metaKey&&t.altKey)}const s=n.length>2&&n[0]==="\u21E7";return isOnlyMeta(t)&&!t.altKey&&(!s&&!t.shiftKey||s&&t.shiftKey)?(s?n[2]:n[1])===Constants.KEYCODELIST[t.keyCode]:!1},zt=(e,t,n)=>{if(e.getAttribute("custom-pinthead")==="true"){const s=e.querySelector("table");s.clientHeight+s.scrollTop<t.offsetTop+t.clientHeight?s.scrollTop=t.offsetTop-s.clientHeight+t.clientHeight+1:s.scrollTop>t.offsetTop-t.clientHeight&&(s.scrollTop=t.offsetTop-t.clientHeight+1)}else scrollCenter(n,t)},Re=e=>{let t=e.previousElementSibling,n=0;for(;t;)n++,t=t.previousElementSibling;return n},Cn=(e,t,n=!0)=>{let s=e.previousElementSibling;return s||(e.parentElement.previousElementSibling?s=e.parentElement.previousElementSibling.lastElementChild:e.parentElement.parentElement.tagName==="TBODY"&&e.parentElement.parentElement.previousElementSibling?s=e.parentElement.parentElement.previousElementSibling.lastElementChild.lastElementChild:s=null),s&&(t.selectNodeContents(s),n||t.collapse(!1),focusByRange(t)),s},Kt=(e,t,n,s,a)=>{a.insertNode(document.createElement("wbr"));const i=n.outerHTML,l=n.querySelector("table"),o=l.rows[0].cells.length,r=l.rows.length,c=[];for(let f=0;f<r;f++){for(let u=0;u<o;u++)l.rows[f].cells[u].isSameNode(t[c.length])&&c.push(u);if(c.length>0)break}for(let f=0;f<r;f++)c.forEach(u=>{l.rows[f].cells[u].setAttribute("align",s)});updateTransaction(e,n.getAttribute("data-node-id"),n.outerHTML,i),focusByWbr(l,a)},An=(e,t,n,s)=>{const a=document.createElement("wbr");t.insertNode(a);const i=s.outerHTML;a.remove();let l="";for(let r=0;r<n.parentElement.childElementCount;r++)l+=`<td align="${n.parentElement.children[r].getAttribute("align")||""}"></td>`;let o;if(n.tagName==="TH"){const r=s.querySelector("tbody");r?(r.insertAdjacentHTML("afterbegin",`<tr>${l}</tr>`),o=r.firstElementChild):(n.parentElement.parentElement.insertAdjacentHTML("afterend",`<tbody><tr>${l}</tr></tbody>`),o=n.parentElement.parentElement.nextElementSibling.firstElementChild)}else n.parentElement.insertAdjacentHTML("afterend",`<tr>${l}</tr>`),o=n.parentElement.nextElementSibling;t.selectNodeContents(o.cells[Re(n)]),t.collapse(!0),focusByRange(t),updateTransaction(e,s.getAttribute("data-node-id"),s.outerHTML,i),zt(s,o,e)},Ja=(e,t,n,s)=>{const a=document.createElement("wbr");t.insertNode(a);const i=s.outerHTML;a.remove();let l="",o=!1;for(let c=0;c<n.parentElement.childElementCount;c++){const f=n.parentElement.children[c];f.className==="fn__none"&&(o=!0),n.tagName==="TH"?l+=`<th class="${f.className}" colspan="${f.colSpan}" align="${f.getAttribute("align")}"></th>`:l+=`<td class="${f.className}" colspan="${f.colSpan}" align="${f.getAttribute("align")}"></td>`}if(o){let c=n.parentElement.previousElementSibling,f=1;for(;c;)f++,Array.from(c.children).forEach(u=>{u.rowSpan>=f&&u.rowSpan>1&&(u.rowSpan=u.rowSpan+1)}),c=c.previousElementSibling}let r;n.parentElement.parentElement.tagName==="THEAD"&&!n.parentElement.previousElementSibling?(n.parentElement.parentElement.insertAdjacentHTML("beforebegin",`<thead><tr>${l}</tr></thead>`),r=s.querySelector("thead tr"),n.parentElement.parentElement.nextElementSibling.insertAdjacentHTML("afterbegin",n.parentElement.parentElement.innerHTML),n.parentElement.parentElement.remove()):(n.parentElement.insertAdjacentHTML("beforebegin",`<tr>${l}</tr>`),r=n.parentElement.previousElementSibling),t.selectNodeContents(r.cells[Re(n)]),t.collapse(!0),focusByRange(t),updateTransaction(e,s.getAttribute("data-node-id"),s.outerHTML,i),zt(s,r,e)},Ln=(e,t,n,s,a)=>{const i=document.createElement("wbr");a.insertNode(i);const l=t.outerHTML;i.remove();const o=Re(n),r=t.querySelector("table");for(let c=0;c<r.rows.length;c++){const f=r.rows[c].cells[o],u=document.createElement(f.tagName);f.insertAdjacentElement(s,u),f.isSameNode(n)?(u.innerHTML="<wbr> ",u.offsetLeft+u.clientWidth>t.firstElementChild.scrollLeft+t.firstElementChild.clientWidth&&(t.firstElementChild.scrollLeft=u.offsetLeft+u.clientWidth-t.firstElementChild.clientWidth)):u.textContent=" "}r.querySelectorAll("col")[o].insertAdjacentHTML(s,"<col>"),focusByWbr(t,a),updateTransaction(e,t.getAttribute("data-node-id"),t.outerHTML,l)},es=(e,t,n,s)=>{if(n.parentElement.parentElement.tagName!=="THEAD"){const a=document.createElement("wbr");t.insertNode(a);const i=s.outerHTML;a.remove();const l=Re(n),o=n.parentElement.parentElement;let r=o.previousElementSibling.lastElementChild;n.parentElement.previousElementSibling&&(r=n.parentElement.previousElementSibling),o.childElementCount===1?o.remove():n.parentElement.remove(),t.selectNodeContents(r.cells[l]),t.collapse(!0),focusByRange(t),zt(s,r,e),updateTransaction(e,s.getAttribute("data-node-id"),s.outerHTML,i)}},ts=(e,t,n,s)=>{var a;const i=document.createElement("wbr");t.insertNode(i);const l=n.outerHTML;i.remove();const o=Re(s),r=s.previousElementSibling||s.nextElementSibling;r&&(t.selectNodeContents(r),t.collapse(!0),r.offsetLeft+r.clientWidth>n.firstElementChild.scrollLeft+n.firstElementChild.clientWidth&&(n.firstElementChild.scrollLeft=r.offsetLeft+r.clientWidth-n.firstElementChild.clientWidth));const c=n.querySelector("table");for(let f=0;f<c.rows.length;f++){const u=c.rows[f].cells;if(u.length===1){c.remove();break}u[o].remove()}(a=n.querySelectorAll("col")[o])==null||a.remove(),updateTransaction(e,n.getAttribute("data-node-id"),n.outerHTML,l),focusByRange(t)},ns=(e,t,n,s)=>{const a=n.parentElement;if(a.parentElement.tagName==="THEAD")return;t.insertNode(document.createElement("wbr"));const i=s.outerHTML;if(a.previousElementSibling)a.after(a.previousElementSibling);else{const l=a.parentElement.previousElementSibling.firstElementChild;l.querySelectorAll("th").forEach(o=>{const r=document.createElement("td");r.innerHTML=o.innerHTML,o.parentNode.replaceChild(r,o)}),a.querySelectorAll("td").forEach(o=>{const r=document.createElement("th");r.innerHTML=o.innerHTML,o.parentNode.replaceChild(r,o)}),a.after(l),a.parentElement.previousElementSibling.append(a)}updateTransaction(e,s.getAttribute("data-node-id"),s.outerHTML,i),focusByWbr(s,t),scrollCenter(e,a)},as=(e,t,n,s)=>{const a=n.parentElement;if(a.parentElement.tagName==="TBODY"&&!a.nextElementSibling||a.parentElement.tagName==="THEAD"&&!a.parentElement.nextElementSibling)return;t.insertNode(document.createElement("wbr"));const i=s.outerHTML;if(a.nextElementSibling)a.before(a.nextElementSibling);else{const l=a.parentElement.nextElementSibling.firstElementChild;l.querySelectorAll("td").forEach(o=>{const r=document.createElement("th");r.innerHTML=o.innerHTML,o.parentNode.replaceChild(r,o)}),a.querySelectorAll("th").forEach(o=>{const r=document.createElement("td");r.innerHTML=o.innerHTML,o.parentNode.replaceChild(r,o)}),a.after(l),a.parentElement.nextElementSibling.insertAdjacentElement("afterbegin",a)}updateTransaction(e,s.getAttribute("data-node-id"),s.outerHTML,i),focusByWbr(s,t),scrollCenter(e,a)},ss=(e,t,n,s)=>{if(!n.previousElementSibling)return;t.insertNode(document.createElement("wbr"));const a=s.outerHTML;let i=0;Array.from(n.parentElement.children).find((o,r)=>{if(n.isSameNode(o))return i=r,!0}),s.querySelectorAll("tr").forEach(o=>{o.cells[i].after(o.cells[i-1])}),n.offsetLeft<s.firstElementChild.scrollLeft&&(s.firstElementChild.scrollLeft=n.offsetLeft);const l=s.querySelectorAll("col");l[i].after(l[i-1]),updateTransaction(e,s.getAttribute("data-node-id"),s.outerHTML,a),focusByWbr(s,t)},is=(e,t,n,s)=>{if(!n.nextElementSibling)return;t.insertNode(document.createElement("wbr"));const a=s.outerHTML;let i=0;Array.from(n.parentElement.children).find((o,r)=>{if(n.isSameNode(o))return i=r,!0}),s.querySelectorAll("tr").forEach(o=>{o.cells[i].before(o.cells[i+1])}),n.offsetLeft+n.clientWidth>s.firstElementChild.scrollLeft+s.firstElementChild.clientWidth&&(s.firstElementChild.scrollLeft=n.offsetLeft+n.clientWidth-s.firstElementChild.clientWidth);const l=s.querySelectorAll("col");l[i].before(l[i+1]),updateTransaction(e,s.getAttribute("data-node-id"),s.outerHTML,a),focusByWbr(s,t)},sl=(e,t,n)=>{var s,a,i;const l=hasClosestByMatchTag(n.startContainer,"TD")||hasClosestByMatchTag(n.startContainer,"TH"),o=hasClosestBlock(n.startContainer);if(!l||!o||o.classList.contains("protyle-wysiwyg--select"))return!1;if(t.key==="Enter"&&t.shiftKey&&isNotCtrl(t)&&!t.altKey){const w=document.createElement("wbr");n.insertNode(w);const _=o.outerHTML;if(w.remove(),l&&!l.innerHTML.endsWith("<br>")&&l.insertAdjacentHTML("beforeend","<br>"),n.extractContents(),e.toolbar.getCurrentType(n).includes("code")&&n.startContainer.nodeType!==3){const x=document.createElement("br");n.startContainer.after(x),n.setStartAfter(x)}else n.insertNode(document.createElement("br"));return n.collapse(!1),scrollCenter(e),updateTransaction(e,o.getAttribute("data-node-id"),o.outerHTML,_),t.preventDefault(),!0}if(isNotCtrl(t)&&!t.shiftKey&&!t.altKey&&t.key==="Enter"){t.preventDefault();const w=l.parentElement;if(!w.nextElementSibling&&w.parentElement.tagName==="TBODY"||w.parentElement.tagName==="THEAD"&&!w.parentElement.nextElementSibling)return!0;let _=w.nextElementSibling;return _||(_=w.parentElement.nextElementSibling.firstChild),_&&(n.selectNodeContents(_.cells[Re(l)]),n.collapse(!0),scrollCenter(e)),!0}if(t.key==="ArrowRight"&&n.toString()===""&&!o.nextElementSibling&&l.isSameNode(o.querySelector("table").lastElementChild.lastElementChild.lastElementChild)&&getSelectionOffset(l,e.wysiwyg.element,n).start===l.textContent.length)return t.preventDefault(),insertEmptyBlock(e,"afterend",o.getAttribute("data-node-id")),!0;if(t.key==="Tab"&&isNotCtrl(t)){if(t.shiftKey)return Cn(l,n),t.preventDefault(),!0;let w=l.nextElementSibling;return w||(l.parentElement.nextElementSibling?w=l.parentElement.nextElementSibling.firstElementChild:l.parentElement.parentElement.tagName==="THEAD"&&l.parentElement.parentElement.nextElementSibling?w=l.parentElement.parentElement.nextElementSibling.firstElementChild.firstElementChild:w=null),w?n.selectNodeContents(w):(An(e,n,l,o),n.selectNodeContents(o.querySelector("tbody").lastElementChild.firstElementChild)),t.preventDefault(),!0}if(t.key==="ArrowUp"&&isNotCtrl(t)&&!t.shiftKey&&!t.altKey){const w=n.startContainer;let _;for(w.nodeType!==3&&(w.tagName==="TH"||w.tagName==="TD")?_=(s=w.childNodes[Math.max(0,n.startOffset-1)])==null?void 0:s.previousElementSibling:w.parentElement.tagName==="SPAN"?_=w.parentElement.previousElementSibling:_=w.previousElementSibling;_;){if(_.tagName==="BR")return!1;_=_.previousElementSibling}const C=l.parentElement;let x=C.previousElementSibling;return x||(x=C.parentElement.previousElementSibling.lastElementChild),!x||(x==null?void 0:x.tagName)==="COL"?!1:(n.selectNodeContents(x.cells[Re(l)]),n.collapse(!1),scrollCenter(e),t.preventDefault(),!0)}if(t.key==="ArrowDown"&&isNotCtrl(t)&&!t.shiftKey&&!t.altKey){const w=n.endContainer;let _;for(w.nodeType!==3&&(w.tagName==="TH"||w.tagName==="TD")?_=(a=w.childNodes[Math.max(0,n.endOffset-1)])==null?void 0:a.nextElementSibling:w.parentElement.tagName==="SPAN"?_=w.parentElement.nextElementSibling:_=w.nextElementSibling;_;){if(_.tagName==="BR"&&_.nextSibling)return!1;_=_.nextElementSibling}const C=l.parentElement;if(!C.nextElementSibling&&C.parentElement.tagName==="TBODY"||C.parentElement.tagName==="THEAD"&&!C.parentElement.nextElementSibling)return!1;let x=C.nextElementSibling;return x||(x=C.parentElement.nextElementSibling.firstChild),x?(n.selectNodeContents(x.cells[Re(l)]),n.collapse(!0),scrollCenter(e),t.preventDefault(),!0):!1}if(isNotCtrl(t)&&!t.shiftKey&&!t.altKey&&t.key==="Backspace"&&getSelectionOffset(l,e.wysiwyg.element,n).start===0&&n.toString()===""&&(n.startOffset===0||n.startOffset===1&&l.querySelectorAll("br").length===1))return!Cn(l,n,!1)&&o.previousElementSibling&&focusBlock(o.previousElementSibling,void 0,!1),scrollCenter(e),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.alignLeft.custom,t))return Kt(e,[l],o,"left",n),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.alignCenter.custom,t))return Kt(e,[l],o,"center",n),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.alignRight.custom,t))return Kt(e,[l],o,"right",n),t.preventDefault(),!0;const r=o.querySelector("table"),c=l.parentElement.querySelector(".fn__none");let f=!1,u=!1;Array.from(l.parentElement.children).forEach(w=>{w.colSpan>1&&(f=!0),w.rowSpan>1&&(u=!0)});let d=!1,g=!1,p=!1,b=l.parentElement.previousElementSibling;!b&&l.parentElement.parentElement.tagName==="TBODY"&&(b=r.querySelector("thead").lastElementChild),b&&(d=b.querySelector(".fn__none"),Array.from(b.children).forEach(w=>{w.colSpan>1&&(g=!0),w.rowSpan>1&&(p=!0)}));let m=!1,h=!1,y=!1,k=l.parentElement.nextElementSibling;!k&&l.parentElement.parentElement.tagName==="THEAD"&&(k=(i=r.querySelector("tbody"))==null?void 0:i.firstElementChild),k&&(m=k.querySelector(".fn__none"),Array.from(k.children).forEach(w=>{w.colSpan>1&&(h=!0),w.rowSpan>1&&(y=!0)}));const E=Re(l);let A=!0;Array.from(r.rows).find(w=>{const _=w.cells[E];if(_.classList.contains("fn__none")||_.colSpan>1||_.rowSpan>1)return A=!1,!0});let v=!0;Array.from(r.rows).find(w=>{const _=w.cells[E+1];if(_&&(_.classList.contains("fn__none")||_.colSpan>1||_.rowSpan>1))return v=!1,!0});let S=!0;if(Array.from(r.rows).find(w=>{const _=w.cells[E-1];if(_&&(_.classList.contains("fn__none")||_.colSpan>1||_.rowSpan>1))return S=!1,!0}),matchHotKey(window.siyuan.config.keymap.editor.table.moveToUp.custom,t))return(!c||c&&!u&&f)&&(!d||d&&!p&&g)&&ns(e,n,l,o),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.moveToDown.custom,t))return(!c||c&&!u&&f)&&(!m||m&&!y&&h)&&as(e,n,l,o),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.moveToLeft.custom,t))return A&&S&&ss(e,n,l,o),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.moveToRight.custom,t))return A&&v&&is(e,n,l,o),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertRowAbove.custom,t))return Ja(e,n,l,o),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertRowBelow.custom,t))return(!m||m&&!y&&h)&&An(e,n,l,o),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,t))return(A||S)&&Ln(e,o,l,"beforebegin",n),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertColumnRight.custom,t))return(A||v)&&Ln(e,o,l,"afterend",n),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table["delete-row"].custom,t))return(!c&&!u||c&&!u&&f)&&es(e,n,l,o),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table["delete-column"].custom,t))return A&&ts(e,n,o,l),t.preventDefault(),!0};class il{constructor(){this.hasUndo=!1,this.redoStack=[],this.undoStack=[]}undo(t){if(t.disabled||this.undoStack.length===0)return;const n=this.undoStack.pop();this.render(t,n,!1),this.hasUndo=!0,this.redoStack.push(n)}redo(t){if(t.disabled||this.redoStack.length===0)return;const n=this.redoStack.pop();this.render(t,n,!0),this.undoStack.push(n)}render(t,n,s){hideElements(["hint","gutter"],t),t.wysiwyg.lastHTMLs={},s?(n.doOperations.forEach(a=>{onTransaction(t,a,!0)}),transaction(t,n.doOperations)):(n.undoOperations.forEach(a=>{onTransaction(t,a,!0)}),transaction(t,n.undoOperations)),preventScroll(t),scrollCenter(t)}replace(t){this.hasUndo&&this.redoStack.length>0&&(this.undoStack.push(this.redoStack.pop()),this.redoStack=[],this.hasUndo=!1),this.undoStack.length>0&&(this.undoStack[this.undoStack.length-1].doOperations=t)}add(t,n){this.undoStack.push({undoOperations:n,doOperations:t}),this.undoStack.length>Constants.SIZE_UNDO&&this.undoStack.shift(),this.hasUndo&&(this.redoStack=[],this.hasUndo=!1)}clear(){this.undoStack=[],this.redoStack=[]}}const ol=e=>!1,ll=(e,t,n)=>{var s,a,i,l,o,r,c,f,u;let d,g="",p=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(p.length===0){let m=getTopAloneElement(t);const h=hasClosestByAttribute(m,"fold","1");h&&(m=h),(s=m.previousElementSibling)!=null&&s.classList.contains("protyle-action")&&(m=getTopAloneElement(m.parentElement)),p=[m]}const b=p[0].getAttribute("data-type");if(b==="NodeListItem"&&!p[0].previousElementSibling&&((i=(a=p[0].parentElement.previousElementSibling)==null?void 0:a.previousElementSibling)!=null&&i.classList.contains("protyle-action")))if((l=p[0].parentElement.parentElement.previousElementSibling)!=null&&l.classList.contains("li")){if(d=p[0].parentElement.parentElement.previousElementSibling.querySelector(".list"),n.insertNode(document.createElement("wbr")),g=p[0].parentElement.parentElement.parentElement.outerHTML,!d){const m=Lute.NewNodeID();p[0].parentElement.parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${p[0].getAttribute("data-subtype")}" data-node-id="${m}" data-type="NodeList" class="list" updated="${m.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),d=p[0].parentElement.parentElement.previousElementSibling.querySelector(".list")}}else return;if(b==="NodeList"&&((r=(o=p[0].previousElementSibling)==null?void 0:o.previousElementSibling)!=null&&r.classList.contains("protyle-action")))if((c=p[0].parentElement.previousElementSibling)!=null&&c.classList.contains("li")){if(d=p[0].parentElement.previousElementSibling.querySelector(".list"),n.insertNode(document.createElement("wbr")),g=p[0].parentElement.parentElement.outerHTML,!d){const m=Lute.NewNodeID();p[0].parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${p[0].getAttribute("data-subtype")}" data-node-id="${m}" data-type="NodeList" class="list" updated="${m.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),d=p[0].parentElement.previousElementSibling.querySelector(".list")}}else return;if(d){d=d.lastElementChild.previousElementSibling;const m=p[0].classList.contains("list")?p[0]:p[0].parentElement;p.reverse().forEach(h=>{h.classList.contains("list")?d.after(h.firstElementChild):d.after(h)}),d.id==="moveTempLi"&&(d=d.nextElementSibling,d.previousElementSibling.remove()),m.childElementCount===1?m.remove():m.getAttribute("data-subtype")==="o"&&m.classList.contains("list")&&updateListOrder(m,1),d.getAttribute("data-subtype")==="o"&&updateListOrder(d.parentElement),updateTransaction(e,d.parentElement.parentElement.parentElement.getAttribute("data-node-id"),d.parentElement.parentElement.parentElement.outerHTML,g),preventScroll(e),scrollCenter(e),focusByWbr(d.parentElement,n);return}if(!(!p[0].previousElementSibling||(f=p[0].previousElementSibling)!=null&&f.classList.contains("protyle-action"))){if(d=p[0].previousElementSibling,p[0].getAttribute("data-subtype")==="o"&&b==="NodeListItem"){const m=p[0].parentElement.outerHTML;p[p.length-1].after(d),updateListOrder(p[0].parentElement,1),updateTransaction(e,p[0].parentElement.getAttribute("data-node-id"),p[0].parentElement.outerHTML,m)}else{const m=d.getAttribute("data-node-id");transaction(e,[{action:"move",id:m,previousID:p[p.length-1].getAttribute("data-node-id")}],[{action:"move",id:m,previousID:(u=d.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"),parentID:d.parentElement.getAttribute("data-node-id")||e.block.parentID}]),p[p.length-1].after(d)}preventScroll(e),scrollCenter(e)}},rl=(e,t,n)=>{var s,a,i,l,o,r,c;let f,u="",d=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(d.length===0){let p=getTopAloneElement(t);const b=hasClosestByAttribute(p,"fold","1");b&&(p=b),(s=p.previousElementSibling)!=null&&s.classList.contains("protyle-action")&&(p=getTopAloneElement(p.parentElement)),d=[p]}const g=d[0].getAttribute("data-type");if(g==="NodeListItem"&&d[d.length-1].nextElementSibling.classList.contains("protyle-attr")&&((a=d[0].parentElement.parentElement)!=null&&a.classList.contains("li")))if((i=d[0].parentElement.parentElement.nextElementSibling)!=null&&i.classList.contains("li")){if(f=d[0].parentElement.parentElement.nextElementSibling.querySelector(".list > .li"),n.insertNode(document.createElement("wbr")),u=d[0].parentElement.parentElement.parentElement.outerHTML,!f){const p=Lute.NewNodeID();d[0].parentElement.parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${d[0].getAttribute("data-subtype")}" data-node-id="${p}" data-type="NodeList" class="list" updated="${p.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),f=d[0].parentElement.parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(g==="NodeList"&&d[d.length-1].nextElementSibling.classList.contains("protyle-attr")&&((l=d[0].parentElement)!=null&&l.classList.contains("li")))if((o=d[0].parentElement.nextElementSibling)!=null&&o.classList.contains("li")){if(f=d[0].parentElement.nextElementSibling.querySelector(".list > .li"),n.insertNode(document.createElement("wbr")),u=d[0].parentElement.parentElement.outerHTML,!f){const p=Lute.NewNodeID();d[0].parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${d[0].getAttribute("data-subtype")}" data-node-id="${p}" data-type="NodeList" class="list" updated="${p.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),f=d[0].parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(f){const p=d[0].classList.contains("list")?d[0]:d[0].parentElement;d.forEach(b=>{b.classList.contains("list")?f.before(b.firstElementChild):f.before(b)}),p.childElementCount===1?p.remove():p.getAttribute("data-subtype")==="o"&&p.classList.contains("list")&&updateListOrder(p,1),f.getAttribute("data-subtype")==="o"&&updateListOrder(f.parentElement,1),updateTransaction(e,f.parentElement.parentElement.parentElement.getAttribute("data-node-id"),f.parentElement.parentElement.parentElement.outerHTML,u),preventScroll(e),scrollCenter(e),focusByWbr(f.parentElement,n);return}if(!(!d[d.length-1].nextElementSibling||(r=d[d.length-1].nextElementSibling)!=null&&r.classList.contains("protyle-attr"))){if(f=d[d.length-1].nextElementSibling,f.getAttribute("data-subtype")==="o"&&f.getAttribute("data-type")==="NodeListItem"){const p=f.parentElement.outerHTML;d[0].before(f),updateListOrder(f.parentElement,1),updateTransaction(e,f.parentElement.getAttribute("data-node-id"),f.parentElement.outerHTML,p)}else{const p=f.getAttribute("data-node-id");transaction(e,[{action:"move",id:p,previousID:(c=d[0].previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:f.parentElement.getAttribute("data-node-id")||e.block.parentID}],[{action:"move",id:p,previousID:d[d.length-1].getAttribute("data-node-id")}]),d[0].before(f)}preventScroll(e),scrollCenter(e)}};class cl{constructor(t,n){this.element=document.createElement("button");const s=n.hotkey?` ${updateHotkeyTip(n.hotkey)}`:"",a=n.tip||window.siyuan.languages[n.lang];this.element.classList.add("protyle-toolbar__item","b3-tooltips",`b3-tooltips__${n.tipPosition}`),this.element.setAttribute("data-type",n.name),this.element.setAttribute("aria-label",a+s),this.element.innerHTML=`<svg><use xlink:href="#${n.icon}"></use></svg>`,!["text","a","block-ref","inline-math","inline-memo"].includes(n.name)&&this.element.addEventListener(getEventName(),i=>{i.preventDefault(),Constants.INLINE_TYPE.includes(n.name)?t.toolbar.setInlineMark(t,n.name,"toolbar"):n.click&&n.click(t.getInstance())})}}class dl extends null{constructor(t,n){super(t,n),this.element.addEventListener("click",()=>{t.toolbar.element.classList.add("fn__none"),t.toolbar.subElement.innerHTML="",t.toolbar.subElement.style.width="",t.toolbar.subElement.style.padding="",t.toolbar.subElement.append(os(t,ls(t))),t.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),t.toolbar.subElement.classList.remove("fn__none"),t.toolbar.subElementCloseCB=void 0,focusByRange(t.toolbar.range)})}}const os=(e,t)=>{let n="";["var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach(f=>{n+=`<button class="color__square" data-type="color" style="color:${f}">A</button>`});let s="";["var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach(f=>{s+=`<button class="color__square" data-type="backgroundColor" style="background-color:${f}"></button>`});const a=document.createElement("div");a.classList.add("protyle-font");let i=!1;t==null||t.find(f=>{if(f.classList.contains("list")||f.classList.contains("li"))return i=!0,!0});let l="";const o=window.siyuan.storage[Constants.LOCAL_FONTSTYLES];o.length>0&&(l=`<div class="fn__flex">
    ${window.siyuan.languages.lastUsed}
    <span class="fn__space"></span>
    <kbd class="ft__on-surface fn__flex-center">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.lastUsed.custom)}</kbd>
</div>
<div class="fn__hr--small"></div>
<div class="fn__flex" style="align-items: center">`,o.forEach(f=>{const u=f.split(Constants.ZWSP);switch(u[0]){case"color":l+=`<button class="color__square" data-type="${u[0]}" style="color:${u[1]}">A</button>`;break;case"backgroundColor":l+=`<button class="color__square" data-type="${u[0]}" style="background-color:${u[1]}"></button>`;break;case"style2":l+=`<button data-type="${u[0]}" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>`;break;case"style4":l+=`<button data-type="${u[0]}" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>`;break;case"fontSize":i||(l+=`<button data-type="${u[0]}" class="protyle-font__style">${u[1]}</button>`);break;case"style1":l+=`<button data-type="${u[0]}" style="background-color:${u[1]};color:${u[2]}" class="color__square">A</button>`;break;case"clear":l+=`<button data-type="${u[0]}" class="protyle-font__style">${window.siyuan.languages.clearFontStyle}</button>`;break}}),l+="</div>");let r,c="16px";return t&&t.length>0?r=t[0]:(r=e.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=hasClosestByAttribute(e.toolbar.range.startContainer,"data-type","text"))),r&&(c=r.style.fontSize||"16px"),a.innerHTML=`${l}
<div class="fn__hr"></div>
<div>${window.siyuan.languages.color}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    <button class="color__square" data-type="style1" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</button>
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.colorFont}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    ${n}
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.colorPrimary}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    ${s}
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.fontStyle}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    <button data-type="style2" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>
    <button data-type="style4" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>
</div>
<div class="fn__hr${i?" fn__none":""}"></div>
<div class="${i?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div class="fn__hr--small${i?" fn__none":""}"></div>
<div class="fn__flex${i?" fn__none":""}">
    <select class="b3-select fn__block">
        <option ${c==="12px"?"selected":""} value="12px">12px</option>
        <option ${c==="13px"?"selected":""} value="13px">13px</option>
        <option ${c==="14px"?"selected":""} value="14px">14px</option>
        <option ${c==="15px"?"selected":""} value="15px">15px</option>
        <option ${c==="16px"?"selected":""} value="16px">16px</option>
        <option ${c==="19px"?"selected":""} value="19px">19px</option>
        <option ${c==="22px"?"selected":""} value="22px">22px</option>
        <option ${c==="24px"?"selected":""} value="24px">24px</option>
        <option ${c==="29px"?"selected":""} value="29px">29px</option>
        <option ${c==="32px"?"selected":""} value="32px">32px</option>
        <option ${c==="40px"?"selected":""} value="40px">40px</option>
        <option ${c==="48px"?"selected":""} value="48px">48px</option>
    </select>
</div>
<div class="fn__hr"></div>
<button class="b3-button b3-button--cancel" data-type="clear">
    <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.clearFontStyle}
</button>`,a.addEventListener("click",function(f){let u=f.target;for(;u&&!u.isEqualNode(a);){const d=u.getAttribute("data-type");if(u.tagName==="BUTTON"){d==="style1"?nt(e,t,d,u.style.backgroundColor+Constants.ZWSP+u.style.color):d==="fontSize"?nt(e,t,d,u.textContent.trim()):d==="backgroundColor"?nt(e,t,d,u.style.backgroundColor):d==="color"?nt(e,t,d,u.style.color):nt(e,t,d);break}u=u.parentElement}}),a.querySelector("select").addEventListener("change",function(f){nt(e,t,"fontSize",f.target.value)}),a},nt=(e,t,n,s)=>{let a=window.siyuan.storage[Constants.LOCAL_FONTSTYLES];if(n)a.splice(0,0,`${n}${Constants.ZWSP}${s}`),a=[...new Set(a)],a.length>8&&a.splice(8,1),window.siyuan.storage[Constants.LOCAL_FONTSTYLES]=a,setStorageVal(Constants.LOCAL_FONTSTYLES,window.siyuan.storage[Constants.LOCAL_FONTSTYLES]);else if(a.length===0)n="style1",s="var(--b3-card-error-color)"+Constants.ZWSP+"var(--b3-card-error-background)";else{const i=a[0].split(Constants.ZWSP);n=i.splice(0,1)[0],s=i.join(Constants.ZWSP)}t&&t.length>0?(updateBatchTransaction(t,e,i=>{if(n==="clear")i.style.color="",i.style.webkitTextFillColor="",i.style.webkitTextStroke="",i.style.textShadow="",i.style.backgroundColor="",i.style.fontSize="",i.classList.contains("av")&&i.querySelector(".av__container").setAttribute("style","--av-background:var(--b3-theme-background)");else if(n==="style1"){const l=s.split(Constants.ZWSP);i.style.backgroundColor=l[0],i.style.color=l[1],i.classList.contains("av")&&i.querySelector(".av__container").setAttribute("style",`--av-background:${l[0]}`)}else n==="style2"?(i.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",i.style.webkitTextFillColor="transparent"):n==="style4"?i.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)":n==="color"?i.style.color=s:n==="backgroundColor"?(i.style.backgroundColor=s,i.classList.contains("av")&&i.querySelector(".av__container").setAttribute("style",`--av-background:${s}`)):n==="fontSize"&&(i.style.fontSize=s);(n==="fontSize"||n==="clear")&&i.getAttribute("data-type")==="NodeCodeBlock"&&lineNumberRender(i.querySelector(".hljs"))}),focusByRange(e.toolbar.range)):n==="clear"?e.toolbar.setInlineMark(e,"clear","range",{type:"text"}):e.toolbar.setInlineMark(e,"text","range",{type:n,color:s})},ul=(e,t)=>{const n=i=>{const l=i.split(Constants.ZWSP);e.setAttribute("data-id",l.splice(0,1)[0]),e.setAttribute("data-subtype",l.splice(0,1)[0]),e.removeAttribute("data-href"),e.innerText=l.join("")},s=i=>{const l=i.split(Constants.ZWSP);e.setAttribute("data-href",l[0]),e.removeAttribute("data-subtype"),e.removeAttribute("data-id"),l[1]&&(e.textContent=l[1])},a=i=>{const l=i.split(Constants.ZWSP);e.setAttribute("data-id",l[0]),e.removeAttribute("data-href"),e.removeAttribute("data-subtype"),l[1]&&(e.textContent=l[1])};if(t)switch(t.type){case"color":e.style.color=t.color;break;case"fontSize":e.style.fontSize=t.color;break;case"backgroundColor":e.style.backgroundColor=t.color;break;case"style1":e.style.backgroundColor=t.color.split(Constants.ZWSP)[0],e.style.color=t.color.split(Constants.ZWSP)[1];break;case"style2":e.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",e.style.webkitTextFillColor="transparent";break;case"style4":e.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)";break;case"id":n(t.color);break;case"inline-math":e.className="render-node",e.setAttribute("contenteditable","false"),e.setAttribute("data-subtype","math"),e.setAttribute("data-content",e.textContent.replace(Constants.ZWSP,"")),e.removeAttribute("data-render"),e.textContent="";break;case"a":s(t.color);break;case"file-annotation-ref":a(t.color);break;case"inline-memo":e.removeAttribute("contenteditable"),e.removeAttribute("data-subtype"),e.removeAttribute("data-content");break}},fl=(e,t,n)=>{if(!n)return!0;if(n.type==="inline-math"||n.type==="inline-memo"||n.type==="a")return!1;if(n.type==="id"){if(e.nodeType!==3)return e.getAttribute("data-id")===t.getAttribute("data-id")&&e.getAttribute("data-subtype")===t.getAttribute("data-subtype")&&e.textContent===t.textContent;const c=n.color.split(Constants.ZWSP);return c[0]===t.getAttribute("data-id")&&c[1]===t.getAttribute("data-subtype")&&c[2]===t.textContent}if(n.type==="file-annotation-ref")return e.nodeType!==3?e.getAttribute("data-id")===t.getAttribute("data-id")&&e.textContent===t.textContent:n.color===t.getAttribute("data-id");let s="",a="",i="",l="",o="",r="";return e.nodeType!==3&&(s=e.style.color,a=e.style.webkitTextFillColor,i=e.style.webkitTextStroke,l=e.style.textShadow,o=e.style.backgroundColor,r=e.style.fontSize),n.type==="text"?s===t.style.color&&a===t.style.webkitTextFillColor&&i===t.style.webkitTextStroke&&l===t.style.textShadow&&r===t.style.fontSize&&o===t.style.backgroundColor:n.type==="color"?n.color===t.style.color&&a===t.style.webkitTextFillColor&&i===t.style.webkitTextStroke&&l===t.style.textShadow&&r===t.style.fontSize&&o===t.style.backgroundColor:n.type==="backgroundColor"?s===t.style.color&&a===t.style.webkitTextFillColor&&i===t.style.webkitTextStroke&&l===t.style.textShadow&&r===t.style.fontSize&&n.color===t.style.backgroundColor:n.type==="style1"?n.color.split(Constants.ZWSP)[0]===t.style.color&&a===t.style.webkitTextFillColor&&i===t.style.webkitTextStroke&&l===t.style.textShadow&&r===t.style.fontSize&&n.color.split(Constants.ZWSP)[1]===t.style.backgroundColor:n.type==="style2"?s===t.style.color&&t.style.webkitTextFillColor==="transparent"&&t.style.webkitTextStroke==="0.2px var(--b3-theme-on-background)"&&l===t.style.textShadow&&r===t.style.fontSize&&o===t.style.backgroundColor:n.type==="style4"?s===t.style.color&&a===t.style.webkitTextFillColor&&i===t.style.webkitTextStroke&&r===t.style.fontSize&&t.style.textShadow==="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)"&&o===t.style.backgroundColor:n.type==="fontSize"?s===t.style.color&&a===t.style.webkitTextFillColor&&i===t.style.webkitTextStroke&&l===t.style.textShadow&&n.color===t.style.fontSize&&o===t.style.backgroundColor:!0},ls=e=>{let t;if(e.toolbar.range.toString()===""&&(t=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),t.length===0)){const n=hasClosestBlock(e.toolbar.range.startContainer);n&&(t=[n])}return t},rs=(e,t,n)=>{var s,a;const i=t.parentElement,l=getContenteditableElement(t);if(["",`
`].includes(l.textContent)&&t.previousElementSibling.classList.contains("protyle-action")&&!t.querySelector("img")){if((s=i.nextElementSibling)!=null&&s.classList.contains("protyle-attr"))return listOutdent(e,[t.parentElement],n),!0;if(!i.parentElement.classList.contains("protyle-wysiwyg"))return breakList(e,t,n),!0}const o=getSelectionOffset(l,e.wysiwyg.element,n);if(n.toString()===""&&o.start===0&&!hasPreviousSibling(n.startContainer)){if(i.parentElement.classList.contains("protyle-wysiwyg"))return!0;const g=document.createElement("wbr");n.insertNode(g);const p=i.parentElement.outerHTML;g.remove();let b=genListItemElement(i,-1,!0);if(t.previousElementSibling.classList.contains("protyle-action"))getContenteditableElement(t).textContent===""?i.insertAdjacentElement("afterend",b):i.insertAdjacentElement("beforebegin",b);else{if(getContenteditableElement(t).textContent!=="")return!1;t.remove(),b=genListItemElement(i,-1,!0),i.insertAdjacentElement("afterend",b)}return i.getAttribute("data-subtype")==="o"&&updateListOrder(i.parentElement),updateTransaction(e,i.parentElement.getAttribute("data-node-id"),i.parentElement.outerHTML,p),focusByWbr(b,n),scrollCenter(e),dt(b),!0}const r=i.querySelector(".list");let c;if(r&&i.getAttribute("fold")!=="1"&&t.nextElementSibling.isSameNode(r)){if(o.end>=l.textContent.length-(l.textContent.endsWith(Constants.ZWSP)?1:0)){n.insertNode(document.createElement("wbr"));const g=r.outerHTML;t.querySelector("wbr").remove(),c=genListItemElement(r.firstElementChild,-1,!0),r.firstElementChild.before(c),r.getAttribute("data-subtype")==="o"&&updateListOrder(r),updateTransaction(e,r.getAttribute("data-node-id"),r.outerHTML,g),focusByWbr(i,n),scrollCenter(e)}else{n.insertNode(document.createElement("wbr"));const g=i.outerHTML,p=i.parentElement.outerHTML;n.toString()!==""&&(n.extractContents(),n.insertNode(document.createElement("wbr"))),n.setEndAfter(l.lastChild),c=genListItemElement(i,0,!1);const b=getContenteditableElement(c);b.appendChild(n.extractContents()),b.parentElement.after(r),i.insertAdjacentElement("afterend",c),i.getAttribute("data-subtype")==="o"&&updateListOrder(i.parentElement),i.parentElement.classList.contains("protyle-wysiwyg")?transaction(e,[{action:"update",data:i.outerHTML,id:i.getAttribute("data-node-id")},{action:"insert",id:c.getAttribute("data-node-id"),data:c.outerHTML,previousID:i.getAttribute("data-node-id")}],[{action:"delete",id:c.getAttribute("data-node-id")},{action:"update",data:g,id:i.getAttribute("data-node-id")}]):updateTransaction(e,i.parentElement.getAttribute("data-node-id"),i.parentElement.outerHTML,p),focusByWbr(c,n),scrollCenter(e)}return dt(c),!0}(n.toString()===""||n.toString()===Constants.ZWSP)&&n.startContainer.nodeType===3&&n.startContainer.textContent===Constants.ZWSP&&n.startOffset===0&&(n.setStart(n.startContainer,1),n.collapse(!1)),n.insertNode(document.createElement("wbr"));const f=i.outerHTML,u=i.parentElement.outerHTML;n.toString()!==""&&(n.extractContents(),n.insertNode(document.createElement("wbr"))),n.setEndAfter(l.lastChild),c=genListItemElement(i,0,!1);const d=n.extractContents();return d.firstChild.nodeType!==3&&d.firstChild.textContent===""&&(d.firstChild.after(document.createElement("wbr")),d.firstChild.remove()),(((a=l==null?void 0:l.lastElementChild)==null?void 0:a.getAttribute("data-type"))||"").indexOf("inline-math")>-1&&!hasNextSibling(l==null?void 0:l.lastElementChild)&&l.insertAdjacentText("beforeend",`
`),getContenteditableElement(c).appendChild(d),i.insertAdjacentElement("afterend",c),i.getAttribute("data-subtype")==="o"&&updateListOrder(i.parentElement),i.parentElement.classList.contains("protyle-wysiwyg")?transaction(e,[{action:"update",id:i.getAttribute("data-node-id"),data:i.outerHTML},{action:"insert",id:c.getAttribute("data-node-id"),data:c.outerHTML,previousID:i.getAttribute("data-node-id")}],[{action:"delete",id:c.getAttribute("data-node-id")},{action:"update",id:i.getAttribute("data-node-id"),data:f}]):updateTransaction(e,i.parentElement.getAttribute("data-node-id"),i.parentElement.outerHTML,u),focusByWbr(c,n),scrollCenter(e),dt(c),!0},gl=(e,t,n)=>{var s;const a=isNotEditBlock(e);if(!a&&e.classList.contains("protyle-wysiwyg--select")){setLastNodeRange(getContenteditableElement(e),t,!1),t.collapse(!1),hideElements(["select"],n);return}if(a){if(e.parentElement.classList.contains("li")){const m=e.parentElement.parentElement.outerHTML,h=genListItemElement(e.parentElement,0,!0);e.parentElement.insertAdjacentElement("afterend",h),updateTransaction(n,e.parentElement.parentElement.getAttribute("data-node-id"),e.parentElement.parentElement.outerHTML,m),focusByWbr(h,t),dt(h),scrollCenter(n);return}if(e.classList.contains("hr")){insertEmptyBlock(n,"afterend");return}e.classList.contains("protyle-wysiwyg--select")&&e.classList.contains("render-node")?n.toolbar.showRender(n,e):insertEmptyBlock(n,"afterend");return}const i=getContenteditableElement(e);if(i.querySelectorAll(".img--select").forEach(m=>{m.classList.remove("img--select")}),e.getAttribute("data-type")==="NodeAttributeView")return!0;const l=i.innerHTML.trimStart();if((l.startsWith("```")||l.startsWith("\xB7\xB7\xB7")||l.startsWith("~~~")||l.indexOf("\n```")>-1||l.indexOf(`
~~~`)>-1||l.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(l.indexOf(`
`)===-1&&l.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){if(e.classList.contains("p")){const m=e.outerHTML;let h=i.innerHTML.replace(/\n(~|·|`){3,}/g,"\n```").trim().replace(/^(~|·|`){3,}/g,"```");h.endsWith("\n```")||(h+="<wbr>\n```"),i.innerHTML=h,e.outerHTML=n.lute.SpinBlockDOM(e.outerHTML),e=n.wysiwyg.element.querySelector(`[data-node-id="${e.getAttribute("data-node-id")}"]`);const y=e.querySelector(".protyle-action__language");return y?(window.siyuan.storage[Constants.LOCAL_CODELANG]&&y.textContent===""?y.textContent=window.siyuan.storage[Constants.LOCAL_CODELANG]:(window.siyuan.storage[Constants.LOCAL_CODELANG]=y.textContent,setStorageVal(Constants.LOCAL_CODELANG,window.siyuan.storage[Constants.LOCAL_CODELANG])),highlightRender(e)):n.toolbar.showRender(n,e),updateTransaction(n,e.getAttribute("data-node-id"),e.outerHTML,m),!0}}if(e.getAttribute("data-type")==="NodeCodeBlock"){const m=document.createElement("wbr");t.insertNode(m);const h=e.outerHTML;return m.remove(),t.extractContents(),i.textContent.endsWith(`
`)||i.insertAdjacentText("beforeend",`
`),t.insertNode(document.createTextNode(`
`)),t.collapse(!1),t.insertNode(m),i.removeAttribute("data-render"),highlightRender(e),updateTransaction(n,e.getAttribute("data-node-id"),e.outerHTML,h),!0}if(i.textContent.replace(Constants.ZWSP,"").replace(`
`,"")===""&&e.nextElementSibling&&e.nextElementSibling.classList.contains("protyle-attr")&&e.parentElement.getAttribute("data-type")==="NodeBlockquote"){t.insertNode(document.createElement("wbr"));const m=getTopEmptyElement(e),h=e.getAttribute("data-node-id"),y=m.getAttribute("data-node-id"),k={action:"insert",id:h,data:e.outerHTML},E={action:"insert",id:y,data:m.outerHTML};return y===h?(k.previousID=e.parentElement.getAttribute("data-node-id"),E.previousID=e.previousElementSibling.getAttribute("data-node-id"),e.parentElement.after(e)):(k.previousID=m.previousElementSibling?m.previousElementSibling.getAttribute("data-node-id"):void 0,k.parentID=m.parentElement.getAttribute("data-node-id")||n.block.parentID,E.previousID=k.previousID,E.parentID=k.parentID,m.after(e),m.remove()),transaction(n,[{action:"delete",id:y},k],[{action:"delete",id:h},E]),focusByWbr(e,t),!0}const o=getSelectionOffset(i,n.wysiwyg.element,t);if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&(e.nextElementSibling.classList.contains("protyle-attr")||e.nextElementSibling.classList.contains("list")&&((s=e.previousElementSibling)!=null&&s.classList.contains("protyle-action"))||o.start===0&&e.previousElementSibling.classList.contains("protyle-action")||e.parentElement.getAttribute("fold")==="1")&&rs(n,e,t))return!0;if(i.textContent!==""&&t.toString()===""&&o.start===0){const m=genEmptyElement(!1,!0),h=m.getAttribute("data-node-id");return transaction(n,[{action:"insert",data:m.outerHTML,id:h,previousID:e.previousElementSibling?e.previousElementSibling.getAttribute("data-node-id"):"",parentID:e.parentElement.getAttribute("data-node-id")||n.block.parentID}],[{action:"delete",id:h}]),m.querySelector("wbr").remove(),e.insertAdjacentElement("beforebegin",m),dt(m),!0}const r=document.createElement("wbr");t.insertNode(r);const c=e.outerHTML;r.remove(),t.toString()!==""&&t.extractContents(),i.lastChild&&t.setEndAfter(i.lastChild);const f=e.getAttribute("data-node-id"),u=document.createElement("div");u.appendChild(genEmptyElement(!1,!1)),u.querySelector('[contenteditable="true"]').appendChild(t.extractContents()),u.innerHTML=n.lute.SpinBlockDOM(u.innerHTML);const d=document.createElement("div");d.innerHTML=n.lute.SpinBlockDOM(i.parentElement.outerHTML);const g=[],p=[];Array.from(d.children).forEach(m=>{m.dataset.nodeId===f?(i.innerHTML=m.querySelector('[contenteditable="true"]').innerHTML,g.push({action:"update",data:e.outerHTML,id:f}),p.push({action:"update",data:c,id:f}),mathRender(i)):(g.push({action:"insert",data:m.outerHTML,id:m.dataset.nodeId,nextID:f}),e.insertAdjacentElement("beforebegin",m),p.push({action:"delete",id:m.dataset.nodeId}),mathRender(m))});let b=e;return Array.from(u.children).forEach(m=>{const h=m.getAttribute("data-node-id");g.push({action:"insert",data:m.outerHTML,id:h,previousID:b.getAttribute("data-node-id")}),p.push({action:"delete",id:h}),b.insertAdjacentElement("afterend",m),mathRender(b.nextElementSibling),b=m}),transaction(n,g,p),focusBlock(e.nextElementSibling),scrollCenter(n),!0},dt=e=>{const t=getContenteditableElement(e).childNodes;for(let n=0;n<t.length;n++)t[n].nodeType===3&&t[n].textContent.length===0&&(t[n].remove(),n--)},pl=(e,t,n)=>{let s=e.startContainer;const a=hasNextSibling(s);if(a&&a.nodeType!==3&&a.classList.contains("img")){a.insertAdjacentHTML("beforebegin","<wbr>");const i=t.outerHTML;a.previousElementSibling.remove();const l=document.createTextNode(`
`);return s.after(document.createTextNode(Constants.ZWSP)),s.after(l),e.selectNode(l),e.collapse(!1),updateTransaction(n,t.getAttribute("data-node-id"),t.outerHTML,i),!0}if(s.nodeType===3&&(s=s.parentElement),s&&n.toolbar.getCurrentType(e).length>0&&getSelectionOffset(s,s,e).end===s.textContent.length)return Sn(e,t,n,s),!0;if(isIPad()||isMobile()){s=e.startContainer;const i=hasNextSibling(s);return i&&i.textContent.trim()!==""?(document.execCommand("insertHTML",!1,`
`),!0):(Sn(e,t,n,s),!0)}return!1},Sn=(e,t,n,s)=>{const a=document.createElement("wbr");s.nodeType===3?e.insertNode(a):s.insertAdjacentElement("afterend",a);const i=t.outerHTML;a.remove();let l;hasNextSibling(s)||(l=document.createTextNode(`
`),s.after(l));const o=document.createTextNode(`
`);s.after(o),l?e.setStart(l,0):e.setStart(o,1),e.collapse(!0),focusByRange(e),updateTransaction(n,t.getAttribute("data-node-id"),t.outerHTML,i)};let xn,ut=!1;const W=(e,t,n,s="false")=>{let a;return t&&t.startsWith("icon")?a=`<svg class="keyboard__slash-icon"><use xlink:href="#${t}"></use></svg>`:a=t,`<button class="keyboard__slash-item" data-focus="${s}" data-value="${encodeURIComponent(e)}">
    ${a}
    <span class="keyboard__slash-text">${n}</span>
</button>`},cs=(e,t)=>{let n="";["var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach((u,d)=>{n+=`<button class="keyboard__slash-item" data-type="color">
    <span class="keyboard__slash-icon" style="color:${u}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${d+1}</span>
</button>`});let s="";["var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach((u,d)=>{s+=`<button class="keyboard__slash-item" data-type="backgroundColor">
    <span class="keyboard__slash-icon" style="background-color:${u}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${d+1}</span>
</button>`});const a=getFontNodeElements(e);let i=!1;a==null||a.find(u=>{if(u.classList.contains("list")||u.classList.contains("li"))return i=!0,!0});let l="";const o=window.siyuan.storage[Constants.LOCAL_FONTSTYLES];o.length>0&&(l=`<div class="keyboard__slash-title">
    ${window.siyuan.languages.lastUsed}
</div>
<div class="keyboard__slash-block">`,o.forEach(u=>{const d=u.split(Constants.ZWSP);switch(d[0]){case"color":l+=`<button class="keyboard__slash-item" data-type="${d[0]}">
    <span class="keyboard__slash-icon" style="color:${d[1]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${parseInt(d[1].replace("var(--b3-font-color",""))+1}</span>
</button>`;break;case"backgroundColor":l+=`<button class="keyboard__slash-item" data-type="${d[0]}">
    <span class="keyboard__slash-icon" style="background-color:${d[1]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${parseInt(d[1].replace("var(--b3-font-background",""))+1}</span>
</button>`;break;case"style2":l+=`<button class="keyboard__slash-item" data-type="${d[0]}">
    <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
</button>`;break;case"style4":l+=`<button class="keyboard__slash-item" data-type="${d[0]}">
    <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
</button>`;break;case"fontSize":i||(l+=`<button class="keyboard__slash-item" data-type="${d[0]}">
    <span class="keyboard__slash-text">${d[1]}</span>
</button>`);break;case"style1":l+=`<button class="keyboard__slash-item" data-type="${d[0]}">
    <span class="keyboard__slash-icon" style="background-color:${d[1]};color:${d[2]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages[d[2].replace("var(--b3-card-","").replace("-color)","")+"Style"]}</span>
</button>`;break;case"clear":l+=`<button class="keyboard__slash-item" data-type="${d[0]}">
    <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
</button>`;break}}),l+="</div>");let r,c="16px";a&&a.length>0?r=a[0]:(r=e.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=hasClosestByAttribute(e.toolbar.range.startContainer,"data-type","text"))),r&&(c=r.style.fontSize||"16px");const f=t.querySelector(".keyboard__util");f.innerHTML=`${l}
<div class="keyboard__slash-title">${window.siyuan.languages.color}</div>
<div class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.errorStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.warningStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.infoStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.successStyle}</span>
    </button>
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.colorFont}</div>
<div class="keyboard__slash-block">
    ${n}
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.colorPrimary}</div>
<div class="keyboard__slash-block">
    ${s}
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.fontStyle}</div>
<div class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style2">
        <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style4">
        <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="clear">
        <svg class="keyboard__slash-icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
    </button>
</div>
<div class="keyboard__slash-title${i?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div class="keyboard__slash-block${i?" fn__none":""}">
    <select class="b3-select fn__block" style="width: calc(50% - 8px);margin: 4px 0 8px 0;">
        <option ${c==="12px"?"selected":""} value="12px">12px</option>
        <option ${c==="13px"?"selected":""} value="13px">13px</option>
        <option ${c==="14px"?"selected":""} value="14px">14px</option>
        <option ${c==="15px"?"selected":""} value="15px">15px</option>
        <option ${c==="16px"?"selected":""} value="16px">16px</option>
        <option ${c==="19px"?"selected":""} value="19px">19px</option>
        <option ${c==="22px"?"selected":""} value="22px">22px</option>
        <option ${c==="24px"?"selected":""} value="24px">24px</option>
        <option ${c==="29px"?"selected":""} value="29px">29px</option>
        <option ${c==="32px"?"selected":""} value="32px">32px</option>
        <option ${c==="40px"?"selected":""} value="40px">40px</option>
        <option ${c==="48px"?"selected":""} value="48px">48px</option>
    </select>
</div>`,f.querySelector("select").addEventListener("change",function(u){fontEvent(e,a,"fontSize",u.target.value)})},ds=(e,t)=>{e.hint.splitChar="/",e.hint.lastIndex=-1;const n=t.querySelector(".keyboard__util");n.innerHTML=`<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${W(Constants.ZWSP,"iconMarkdown",window.siyuan.languages.template)}
    ${W(Constants.ZWSP+1,"iconBoth",window.siyuan.languages.widget)}
    ${W(Constants.ZWSP+2,"iconImage",window.siyuan.languages.assets)}
    ${W("((","iconRef",window.siyuan.languages.ref,"true")}
    ${W("{{","iconSQL",window.siyuan.languages.blockEmbed,"true")}
    ${W(Constants.ZWSP+5,"iconSparkles","AI Chat")}
    ${isPaidUser()?W('<div data-type="NodeAttributeView" data-av-type="table"></div>',"iconDatabase",window.siyuan.languages.database,"true"):""}
    ${W(Constants.ZWSP+4,"iconFile",window.siyuan.languages.newSubDoc)}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${W("# "+Lute.Caret,"iconH1",window.siyuan.languages.heading1,"true")}
    ${W("## "+Lute.Caret,"iconH2",window.siyuan.languages.heading2,"true")}
    ${W("### "+Lute.Caret,"iconH3",window.siyuan.languages.heading3,"true")}
    ${W("#### "+Lute.Caret,"iconH4",window.siyuan.languages.heading4,"true")}
    ${W("##### "+Lute.Caret,"iconH5",window.siyuan.languages.heading5,"true")}
    ${W("###### "+Lute.Caret,"iconH6",window.siyuan.languages.heading6,"true")}
    ${W("* "+Lute.Caret,"iconList",window.siyuan.languages.list,"true")}
    ${W("1. "+Lute.Caret,"iconOrderedList",window.siyuan.languages["ordered-list"],"true")}
    ${W("* [ ] "+Lute.Caret,"iconCheck",window.siyuan.languages.check,"true")}
    ${W("> "+Lute.Caret,"iconQuote",window.siyuan.languages.quote,"true")}
    ${W("```","iconCode",window.siyuan.languages.code,"true")}
    ${W(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,"iconTable",window.siyuan.languages.table,"true")}
    ${W("---","iconLine",window.siyuan.languages.line,"true")}
    ${W("$$","iconMath",window.siyuan.languages.math)}
    ${W("<div>","iconHTML5","HTML")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${W("emoji","iconEmoji",window.siyuan.languages.emoji,"true")}
    ${W("a","iconLink",window.siyuan.languages.link)}
    ${W("strong","iconBold",window.siyuan.languages.bold,"true")}
    ${W("em","iconItalic",window.siyuan.languages.italic,"true")}
    ${W("u","iconUnderline",window.siyuan.languages.underline,"true")}
    ${W("s","iconStrike",window.siyuan.languages.strike,"true")}
    ${W("mark","iconMark",window.siyuan.languages.mark,"true")}
    ${W("sup","iconSup",window.siyuan.languages.sup,"true")}
    ${W("sub","iconSub",window.siyuan.languages.sub,"true")}
    ${W("tag","iconTags",window.siyuan.languages.tag,"true")}
    ${W("code","iconInlineCode",window.siyuan.languages["inline-code"],"true")}
    ${W("inline-math","iconMath",window.siyuan.languages["inline-math"])}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${W(Constants.ZWSP+3,"iconDownload",window.siyuan.languages.insertAsset+'<input class="b3-form__upload" type="file"'+(e.options.upload.accept?' multiple="'+e.options.upload.accept+'"':"")+"/>","true")}
    ${W('<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',"iconLanguage",window.siyuan.languages.insertIframeURL,"true")}
    ${W("![]()","iconImage",window.siyuan.languages.insertImgURL,"true")}
    ${W('<video controls="controls" src=""></video>',"iconVideo",window.siyuan.languages.insertVideoURL,"true")}
    ${W('<audio controls="controls" src=""></audio>',"iconRecord",window.siyuan.languages.insertAudioURL,"true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${W("```abc\n```","",window.siyuan.languages.staff,"true")}
    ${W("```echarts\n```","",window.siyuan.languages.chart,"true")}
    ${W("```flowchart\n```","","Flow Chart","true")}
    ${W("```graphviz\n```","","Graph","true")}
    ${W("```mermaid\n```","","Mermaid","true")}
    ${W("```mindmap\n```","",window.siyuan.languages.mindmap,"true")}
    ${W("```plantuml\n```","","UML","true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${W(`style${Constants.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,'<div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.infoStyle,"true")}
    ${W(`style${Constants.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,'<div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.successStyle,"true")}
    ${W(`style${Constants.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,'<div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.warningStyle,"true")}
    ${W(`style${Constants.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,'<div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.errorStyle,"true")}
    ${W(`style${Constants.ZWSP}`,'<div class="keyboard__slash-icon">A</div>',window.siyuan.languages.clearFontStyle,"true")}
</div>`,e.hint.bindUploadEvent(e,n)},Tn=e=>{window.siyuan.menus.menu.remove(),ut=!0;const t=document.getElementById("keyboardToolbar");let n=t.getAttribute("data-keyboardheight");n=(n?parseInt(n)+42:window.outerHeight/2)+"px";const s=getCurrentEditor();s&&(s.protyle.element.parentElement.style.paddingBottom=n,s.protyle.contentElement.scrollTop=e),setTimeout(()=>{t.style.height=n},Constants.TIMEOUT_TRANSITION),setTimeout(()=>{ut=!1},1e3)},ft=()=>{const e=document.getElementById("keyboardToolbar");e.style.height="";const t=getCurrentEditor();t&&(t.protyle.element.parentElement.style.paddingBottom="42px"),e.querySelector('.keyboard__action[data-type="add"]').classList.remove("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="text"]').classList.remove("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconKeyboardHide")},us=()=>{clearTimeout(xn),xn=window.setTimeout(()=>{if(getSelection().rangeCount===0||window.siyuan.config.readonly||document.getElementById("toolbarName").getAttribute("readonly")==="readonly"||window.screen.height-window.innerHeight<160||!document.activeElement||document.activeElement&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&!document.activeElement.classList.contains("protyle-wysiwyg")&&document.activeElement.getAttribute("contenteditable")!=="true"){Lt();return}if(document.activeElement&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("model").style.transform==="translateY(0px)")){Lt();return}ut||ft(),fs();const e=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic"),t=getSelection().getRangeAt(0);if(!hasClosestByClassName(t.startContainer,"protyle-wysiwyg",!0)){e[0].classList.add("fn__none"),e[1].classList.add("fn__none");return}t.toString()||e[0].querySelector('[data-type="goinline"]').classList.contains("protyle-toolbar__item--current")?(e[0].classList.add("fn__none"),e[1].classList.remove("fn__none")):(e[0].classList.remove("fn__none"),e[1].classList.add("fn__none"));const a=getCurrentEditor().protyle;if(!e[0].classList.contains("fn__none")){a.undo.undoStack.length===0?e[0].querySelector('[data-type="undo"]').setAttribute("disabled","disabled"):e[0].querySelector('[data-type="undo"]').removeAttribute("disabled"),a.undo.redoStack.length===0?e[0].querySelector('[data-type="redo"]').setAttribute("disabled","disabled"):e[0].querySelector('[data-type="redo"]').removeAttribute("disabled");const i=hasClosestBlock(t.startContainer);if(i){const l=e[0].querySelector('[data-type="outdent"]');i.parentElement.classList.contains("li")?(l.classList.remove("fn__none"),l.nextElementSibling.classList.remove("fn__none")):(l.classList.add("fn__none"),l.nextElementSibling.classList.add("fn__none"))}}e[1].classList.contains("fn__none")||(e[1].querySelectorAll(".protyle-toolbar__item--current").forEach(l=>{l.classList.remove("protyle-toolbar__item--current")}),a.toolbar.getCurrentType(t).forEach(l=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(l))return;const o=e[1].querySelector(`[data-type="${l}"]`);o&&o.classList.add("protyle-toolbar__item--current")}))},620)},fs=()=>{ut||ft();const e=document.getElementById("keyboardToolbar");if(!e.classList.contains("fn__none"))return;e.classList.remove("fn__none"),e.style.zIndex=(++window.siyuan.zIndex).toString();const t=document.getElementById("model");t.style.transform==="translateY(0px)"&&(t.style.paddingBottom="42px");const n=getSelection().getRangeAt(0),s=getCurrentEditor();s&&s.protyle.wysiwyg.element.contains(n.startContainer)&&(s.protyle.element.parentElement.style.paddingBottom="42px"),getCurrentEditor().protyle.app.plugins.forEach(a=>{a.eventBus.emit("mobile-keyboard-show")}),setTimeout(()=>{const a=hasClosestByClassName(n.startContainer,"protyle-content",!0);if(a){const i=a.getBoundingClientRect().top,l=getSelectionPosition(a).top;if(l<window.innerHeight-42&&l>i)return;a.scroll({top:a.scrollTop+l-window.innerHeight+42+26,left:a.scrollLeft,behavior:"smooth"})}},Constants.TIMEOUT_TRANSITION)},Lt=()=>{if(ut)return;const e=document.getElementById("keyboardToolbar");if(e.classList.contains("fn__none"))return;e.classList.add("fn__none"),e.style.height="";const t=getCurrentEditor();t&&(t.protyle.element.parentElement.style.paddingBottom="");const n=document.getElementById("model");n.style.transform==="translateY(0px)"&&(n.style.paddingBottom=""),getCurrentEditor().protyle.app.plugins.forEach(s=>{s.eventBus.emit("mobile-keyboard-hide")})},In=()=>{document.activeElement.blur()},ml=()=>{let e=!1;document.addEventListener("selectionchange",()=>{e||us()},!1);const t=document.getElementById("keyboardToolbar");t.innerHTML=`<div class="fn__flex keyboard__bar">
    <div class="fn__flex-1">
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="outdent"><svg><use xlink:href="#iconOutdent"></use></svg></button>
            <button class="keyboard__action" data-type="indent"><svg><use xlink:href="#iconIndent"></use></svg></button>
            <button class="keyboard__action" data-type="add"><svg><use xlink:href="#iconAdd"></use></svg></button>
            <button class="keyboard__action" data-type="block"><svg><use xlink:href="#iconParagraph"></use></svg></button>
            <button class="keyboard__action" data-type="goinline"><svg class="keyboard__svg--big"><use xlink:href="#iconBIU"></use></svg></button>
            <button class="keyboard__action" data-type="softLine"><svg><use xlink:href="#iconSoftWrap"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="undo"><svg><use xlink:href="#iconUndo"></use></svg></button>
            <button class="keyboard__action" data-type="redo"><svg><use xlink:href="#iconRedo"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="moveup"><svg><use xlink:href="#iconUp"></use></svg></button>
            <button class="keyboard__action" data-type="movedown"><svg><use xlink:href="#iconDown"></use></svg></button>
        </div>
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconBack"></use></svg></button>
            <button class="keyboard__action" data-type="block-ref"><svg><use xlink:href="#iconRef"></use></svg></button>
            <button class="keyboard__action" data-type="a"><svg><use xlink:href="#iconLink"></use></svg></button>
            <button class="keyboard__action" data-type="text"><svg><use xlink:href="#iconFont"></use></svg></button>
            <button class="keyboard__action" data-type="strong"><svg><use xlink:href="#iconBold"></use></svg></button>
            <button class="keyboard__action" data-type="em"><svg><use xlink:href="#iconItalic"></use></svg></button>
            <button class="keyboard__action" data-type="u"><svg><use xlink:href="#iconUnderline"></use></svg></button>
            <button class="keyboard__action" data-type="s"><svg><use xlink:href="#iconStrike"></use></svg></button>
            <button class="keyboard__action" data-type="mark"><svg><use xlink:href="#iconMark"></use></svg></button>
            <button class="keyboard__action" data-type="sup"><svg><use xlink:href="#iconSup"></use></svg></button>
            <button class="keyboard__action" data-type="sub"><svg><use xlink:href="#iconSub"></use></svg></button>
            <button class="keyboard__action" data-type="clear"><svg><use xlink:href="#iconClear"></use></svg></button>
            <button class="keyboard__action" data-type="code"><svg><use xlink:href="#iconInlineCode"></use></svg></button>
            <button class="keyboard__action" data-type="kbd"<use xlink:href="#iconKeymap"></use></svg></button>
            <button class="keyboard__action" data-type="tag"><svg><use xlink:href="#iconTags"></use></svg></button>
            <button class="keyboard__action" data-type="inline-math"><svg><use xlink:href="#iconMath"></use></svg></button>
            <button class="keyboard__action" data-type="inline-memo"><svg><use xlink:href="#iconM"></use></svg></button>
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconCloseRound"></use></svg></button>
        </div>
    </div>
    <span class="keyboard__split"></span>
    <button class="keyboard__action" data-type="done"><svg style="width: 36px"><use xlink:href="#iconKeyboardHide"></use></svg></button>
</div>
<div class="keyboard__util"></div>`,t.addEventListener("click",n=>{var s;const a=(s=getCurrentEditor())==null?void 0:s.protyle,i=n.target,l=hasClosestByClassName(n.target,"keyboard__slash-item");if(l&&!l.getAttribute("data-type")){const u=decodeURIComponent(l.getAttribute("data-value"));a.hint.fill(u,a,!1),u!==Constants.ZWSP+3&&(n.preventDefault(),n.stopPropagation()),l.getAttribute("data-focus")==="true"&&focusByRange(a.toolbar.range);return}const o=hasClosestByMatchTag(i,"BUTTON");if(!o||o.getAttribute("disabled"))return;const r=o.getAttribute("data-type");if(["clear","style2","style4","color","backgroundColor","fontSize","style1"].includes(r)){const u=getFontNodeElements(a),d=o.firstElementChild;r==="style1"?fontEvent(a,u,r,d.style.backgroundColor+Constants.ZWSP+d.style.color):r==="fontSize"?fontEvent(a,u,r,d.textContent.trim()):r==="backgroundColor"?fontEvent(a,u,r,d.style.backgroundColor):r==="color"?fontEvent(a,u,r,d.style.color):fontEvent(a,u,r)}if(n.preventDefault(),n.stopPropagation(),getSelection().rangeCount===0)return;const c=getSelection().getRangeAt(0);if(r==="done"){t.clientHeight>100?(ft(),focusByRange(c)):(In(),Lt());return}if(window.siyuan.config.readonly||!a||a.disabled)return;if(r==="undo"){a.undo.undo(a);return}else if(r==="redo"){a.undo.redo(a);return}if(getSelection().rangeCount===0)return;const f=hasClosestBlock(c.startContainer);if(f){if(r==="goback"){t.querySelector('.keyboard__action[data-type="goinline"]').classList.remove("protyle-toolbar__item--current");const u=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");u[0].classList.remove("fn__none"),u[1].classList.add("fn__none"),focusByRange(c),e=!0,setTimeout(()=>{e=!1},1e3);return}else if(r==="goinline"){o.classList.add("protyle-toolbar__item--current");const u=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");u[1].classList.remove("fn__none"),u[0].classList.add("fn__none"),focusByRange(c);return}else if(["a","block-ref","inline-math","inline-memo"].includes(r)){hasClosestByAttribute(c.startContainer,"data-type","NodeCodeBlock")||(hideElements(["util"],a),a.toolbar.element.querySelector(`[data-type="${r}"]`).dispatchEvent(new CustomEvent("click")));return}else if(o.classList.contains("keyboard__action")&&["strong","em","s","code","mark","tag","u","sup","clear","sub","kbd"].includes(r)){hasClosestByAttribute(c.startContainer,"data-type","NodeCodeBlock")||a.toolbar.setInlineMark(a,r,"toolbar");return}else if(r==="text"){if(o.classList.contains("protyle-toolbar__item--current"))ft(),focusByRange(c);else{o.classList.add("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const u=a.contentElement.scrollTop;cs(a,t),Tn(u)}return}else if(r==="moveup"){moveToUp(a,f,c),focusByRange(c);return}else if(r==="movedown"){moveToDown(a,f,c),focusByRange(c);return}else if(r==="softLine"){c.extractContents(),softEnter(c,f,a),focusByRange(c);return}else if(r==="add"){if(o.classList.contains("protyle-toolbar__item--current"))ft(),focusByRange(c);else{o.classList.add("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const u=a.contentElement.scrollTop;ds(a,t),Tn(u)}return}else if(r==="block"){a.gutter.renderMenu(a,f),window.siyuan.menus.menu.fullscreen(),In(),Lt();return}else if(r==="outdent"){listOutdent(a,[f.parentElement],c),focusByRange(c);return}else if(r==="indent"){listIndent(a,[f.parentElement],c),focusByRange(c);return}}})},bl=()=>{document.getElementById("menu").style.transform="",document.getElementById("sidebar").style.transform="",document.getElementById("model").style.transform="";const e=document.querySelector(".side-mask");e.classList.add("fn__none"),e.style.opacity="",window.siyuan.menus.menu.remove()},hl=()=>{document.getElementById("model").style.transform="",activeBlur(),hideKeyboardToolbar()},Zt=null,gs=e=>{const t=getCurrentEditor().protyle;if(window.siyuan.storage[Constants.LOCAL_DOCINFO]={id:e.id},setStorageVal(Constants.LOCAL_DOCINFO,window.siyuan.storage[Constants.LOCAL_DOCINFO]),hideElements(["toolbar","hint","util"],t),t.contentElement.classList.contains("fn__none")&&setEditMode(t,"wysiwyg"),t.notebookId=e.data.notebookId,t.path=e.data.path,e.data.startId===t.wysiwyg.element.firstElementChild.getAttribute("data-node-id")&&e.data.endId===t.wysiwyg.element.lastElementChild.getAttribute("data-node-id")){t.contentElement.scrollTo({top:e.scrollTop,behavior:"smooth"});return}if(e.id!==t.block.rootID&&fetchPost("/api/block/getDocInfo",{id:e.id},n=>{setTitle(n.data.name),document.getElementById("toolbarName").value=n.data.name==="Untitled"?"":n.data.name,t.background.render(n.data.ial,t.block.rootID),t.wysiwyg.renderCustom(n.data.ial)}),e.zoomId){e.zoomId!==t.block.id?fetchPost("/api/block/checkBlockExist",{id:e.id},n=>{n.data&&zoomOut({protyle:t,id:e.id,isPushBack:!1,callback:()=>{t.contentElement.scrollTop=e.scrollTop}})}):t.contentElement.scrollTop=e.scrollTop;return}fetchPost("/api/filetree/getDoc",{id:e.id,startID:e.data.startId,endID:e.data.endId},n=>{t.block.parentID=n.data.parentID,t.block.parent2ID=n.data.parent2ID,t.block.rootID=n.data.rootID,t.block.showAll=!1,t.block.mode=n.data.mode,t.block.blockCount=n.data.blockCount,t.block.id=n.data.id,t.block.action=e.callback,t.wysiwyg.element.setAttribute("data-doc-type",n.data.type),t.wysiwyg.element.innerHTML=n.data.content,processRender(t.wysiwyg.element),highlightRender(t.wysiwyg.element),avRender(t.wysiwyg.element,t),blockRender(t,t.wysiwyg.element,e.scrollTop),n.data.isSyncing?disabledForeverProtyle(t):setReadonlyByConfig(t,!0),t.contentElement.scrollTop=e.scrollTop})},yl=()=>{const e=getCurrentEditor().protyle;e.wysiwyg.element.firstElementChild&&window.siyuan.backStack.push({id:e.block.showAll?e.block.id:e.block.rootID,data:{startId:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:e.notebookId,path:e.path},scrollTop:e.contentElement.scrollTop,callback:e.block.action,zoomId:e.block.showAll?e.block.id:void 0})},wl=()=>{const e=getCurrentEditor();if(window.siyuan.menus.menu.element.classList.contains("b3-menu--fullscreen")&&!window.siyuan.menus.menu.element.classList.contains("fn__none")){window.siyuan.menus.menu.element.dispatchEvent(new CustomEvent("click",{detail:"back"}));return}else if(document.getElementById("model").style.transform==="translateY(0px)"){const n=document.getElementById("searchAssetsPanel");!n||n.classList.contains("fn__none")?document.getElementById("model").style.transform="":n.classList.add("fn__none");return}else if(window.siyuan.viewer&&!window.siyuan.viewer.destroyed){window.siyuan.viewer.destroy();return}else if(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("sidebar").style.transform==="translateX(0px)"){closePanel();return}else if(e&&!e.protyle.toolbar.subElement.classList.contains("fn__none")){hideElements(["util"],e.protyle),closePanel();return}else if(window.siyuan.dialogs.length!==0){hideElements(["dialog"]),closePanel();return}if(window.JSAndroid&&window.siyuan.backStack.length<1){document.querySelector('#message [data-id="exitTip"]')?window.JSAndroid.returnDesktop():showMessage(window.siyuan.languages.returnDesktop,3e3,"info","exitTip");return}if(window.siyuan.backStack.length<1)return;if(Zt.length===0&&e){const n=e.protyle;Zt.push({id:n.block.showAll?n.block.id:n.block.rootID,data:{startId:n.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:n.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:n.notebookId,path:n.path},scrollTop:n.contentElement.scrollTop,callback:n.block.action,zoomId:n.block.showAll?n.block.id:void 0})}const t=window.siyuan.backStack.pop();Zt.push(t),gs(t)},_l=(e,t,n)=>{if(!e){t.innerHTML="";return}fetchPost("/api/template/render",{id:n,path:e,preview:!0},s=>{t.innerHTML=`<div class="protyle-wysiwyg" style="padding: 8px">${s.data.content.replace(/contenteditable="true"/g,"")}</div>`})},Mn=(e,t,n=!0)=>{if(!e.getAttribute("data-type")||!t.getAttribute("data-type"))return!1;e.setAttribute("data-type",e.getAttribute("data-type").replace("search-mark","").trim()),t.setAttribute("data-type",t.getAttribute("data-type").replace("search-mark","").trim());const s=e.attributes;let a=!0;for(let i=0;i<s.length;i++)t.getAttribute(s[i].name)!==s[i].value&&(a=!1);return a&&(n?e.innerHTML=e.innerHTML+t.innerHTML:e.innerHTML=t.innerHTML+e.innerHTML,t.remove()),a},vl=e=>{let t=e.previousSibling;for(;t&&t.nodeType!==3&&Mn(e,t,!1);)t=e.previousSibling;let n=e.nextSibling;for(;n&&n.nodeType!==3&&Mn(e,n);)n=e.nextSibling;(e.getAttribute("data-type")||"").includes("search-mark")&&e.setAttribute("data-type",e.getAttribute("data-type").replace("search-mark","").trim())},El=(e,t,n)=>{const s=e.getAttribute("data-type").split(" ");if(s.length===1){const a=e.parentElement;e.outerHTML=e.innerHTML.replace(Constants.ZWSP,"")+"<wbr>",n&&focusByWbr(a,n)}else s.find((a,i)=>{if(t===a)return s.splice(i,1),!0}),e.setAttribute("data-type",s.join(" ")),t==="a"?e.removeAttribute("data-href"):t==="file-annotation-ref"?e.removeAttribute("data-id"):t==="block-ref"&&(e.removeAttribute("data-id"),e.removeAttribute("data-subtype")),n&&(n.selectNodeContents(e),n.collapse(!1),focusByRange(n))},kl=(e,t)=>{e.element.querySelector(".wysiwygLoading")||(addLoading(e),hideElements(["toolbar"],e),fetchPost(`/api/format/net${t}2LocalAssets`,{id:e.block.rootID},()=>{reloadProtyle(e,!1)}))},Cl=(e,t)=>{var n,s;setTimeout(()=>{hideAllElements(["gutter"])},Constants.TIMEOUT_TRANSITION);const a=e.className.includes("fullscreen");if(a?(e.classList.remove("fullscreen"),(n=document.getElementById("drag"))==null||n.classList.remove("fn__hidden")):(e.classList.add("fullscreen"),(s=document.getElementById("drag"))==null||s.classList.add("fn__hidden")),t){a?t.querySelector("use").setAttribute("xlink:href","#iconFullscreen"):t.querySelector("use").setAttribute("xlink:href","#iconFullscreenExit");const i=hasClosestByClassName(e,"layout--float");i&&(a?(i.setAttribute("data-temp",i.style.transform),i.style.transform="none"):(i.style.transform=i.getAttribute("data-temp"),i.removeAttribute("data-temp")));return}},Al=(e,t)=>{if(!window.siyuan.config.readonly){const n=e.querySelector("use").getAttribute("xlink:href")!=="#iconUnlock";window.siyuan.config.editor.readOnly?n?enableProtyle(t):disabledProtyle(t):fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{[Constants.CUSTOM_SY_READONLY]:n?"false":"true"}})}},Ll=(e,t,n)=>{if(matchHotKey(window.siyuan.config.keymap.editor.general.copyHPath.custom,t))return fetchPost("/api/filetree/getHPathByID",{id:e.block.rootID},s=>{writeText(s.data)}),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,t))return net2LocalAssets(e,"Img"),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.netAssets2LocalAssets.custom,t))return net2LocalAssets(e,"Assets"),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.optimizeTypography.custom,t))return fetchPost("/api/format/autoSpace",{id:e.block.rootID}),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom,t)){const s=n?n.getAttribute("data-node-id"):e.block.rootID;return fetchPost("/api/block/getRefText",{id:s},a=>{writeText(`[${a.data}](siyuan://blocks/${s})`)}),t.preventDefault(),t.stopPropagation(),!0}},Sl=e=>{const t=e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.length>0)e.event.stopPropagation(),e.event.preventDefault();else if(getSelectionOffset(e.nodeElement,e.editorElement,e.range).start!==0){const s=getContenteditableElement(e.nodeElement);if(s.tagName==="TABLE"){const a=hasClosestByMatchTag(e.range.startContainer,"TH")||hasClosestByMatchTag(e.range.startContainer,"TD")||s.querySelector("th, td");if(getSelectionOffset(a,a,e.range).start!==0){setFirstNodeRange(a,e.range),e.event.stopPropagation(),e.event.preventDefault();return}}else return}e.range.collapse(!0),hideElements(["toolbar"],e.protyle),t.length===0?e.nodeElement.classList.add("protyle-wysiwyg--select"):e.cb(t);const n=[];e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(s=>{n.push(s.getAttribute("data-node-id"))}),countBlockWord(n,e.protyle.block.rootID),e.event.stopPropagation(),e.event.preventDefault()},xl=e=>{const t=e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.length>0)e.event.stopPropagation(),e.event.preventDefault();else if(getSelectionOffset(e.nodeElement,e.editorElement,e.range).end<getContenteditableElement(e.nodeElement).textContent.length)return;e.range.collapse(!1),hideElements(["toolbar"],e.protyle),t.length===0?e.nodeElement.classList.add("protyle-wysiwyg--select"):e.cb(t);const n=[];e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(s=>{n.push(s.getAttribute("data-node-id"))}),countBlockWord(n,e.protyle.block.rootID),e.event.stopPropagation(),e.event.preventDefault()},Tl=e=>{let t,n;return e.forEach(s=>{s.getAttribute("select-start")&&(t=s),s.getAttribute("select-end")&&(n=s)}),t||(t=e[0],t.setAttribute("select-start","true")),n||(n=e[e.length-1],n.setAttribute("select-end","true")),{startElement:t,endElement:n}},Il=(e,t)=>{let n;const s=[],a=[];e.reverse().forEach((i,l)=>{const o=i.cloneNode(!0);l===0&&(n=o);const r=Lute.NewNodeID();o.setAttribute("data-node-id",r),o.querySelectorAll("[data-node-id]").forEach(c=>{c.setAttribute("data-node-id",Lute.NewNodeID())}),i.classList.remove("protyle-wysiwyg--select"),e[0].after(o),s.push({action:"insert",data:o.outerHTML,id:r,previousID:e[0].getAttribute("data-node-id")}),a.push({action:"delete",id:r})}),transaction(t,s,a),focusBlock(n),scrollCenter(t)},Ml=e=>{e.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0"||e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.options.backlinkData?(focusBlock(e.wysiwyg.element.firstElementChild),e.contentElement.scrollTop=0,e.scroll.lastScrollTop=1):fetchPost("/api/filetree/getDoc",{id:e.block.rootID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},t=>{onGet({data:t,protyle:e,action:[Constants.CB_GET_FOCUS]})})},Dl=e=>{!e.scroll.element.classList.contains("fn__none")&&e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"?fetchPost("/api/filetree/getDoc",{id:e.block.rootID,mode:4,size:window.siyuan.config.editor.dynamicLoadBlocks},t=>{onGet({data:t,protyle:e,action:[Constants.CB_GET_FOCUS],afterCB(){focusBlock(e.wysiwyg.element.lastElementChild,void 0,!1)}})}):(e.contentElement.scrollTop=e.contentElement.scrollHeight,e.scroll.lastScrollTop=e.contentElement.scrollTop,focusBlock(e.wysiwyg.element.lastElementChild,void 0,!1))},$l=(e,t,n,s,a)=>{t.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),n.forEach(i=>{i.style.display="block";let l=i.nextSibling;for(;l;)if(l.textContent==="")l=l.nextSibling;else if(l.textContent===Constants.ZWSP){l.textContent="";break}else break;let o=i.previousSibling;for(;o;)if(o.textContent==="")o=o.previousSibling;else if(o.textContent===Constants.ZWSP){o.textContent="";break}else break}),updateTransaction(e,s,t.outerHTML,a)},Hl=(e,t,n,s,a)=>{t.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),n.forEach(i=>{i.style.display="",hasNextSibling(i)||i.insertAdjacentText("afterend",Constants.ZWSP),hasPreviousSibling(i)||i.insertAdjacentText("beforebegin",Constants.ZWSP)}),updateTransaction(e,s,t.outerHTML,a)},Nl=e=>{if(!e)return"";const t=pathPosix().extname(e).toLowerCase();return Constants.SIYUAN_ASSETS_IMAGE.includes(t)?`<img style="max-height: 100%" src="${e}">`:Constants.SIYUAN_ASSETS_AUDIO.includes(t)?`<audio style="max-width: 100%" controls="controls" src="${e}"></audio>`:Constants.SIYUAN_ASSETS_VIDEO.includes(t)?`<video style="max-width: 100%" controls="controls" src="${e}"></video>`:e},Bl=()=>{},Pl=(e,t,n,s)=>{let a="";if(Constants.SIYUAN_ASSETS_AUDIO.includes(e))a=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeAudio" class="iframe" updated="${dayjs().format("YYYYMMDDHHmmss")}"><div class="iframe-content"><audio controls="controls" src="${t}" data-src="${t}"></audio>${Constants.ZWSP}</div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`;else if(Constants.SIYUAN_ASSETS_IMAGE.includes(e)){let i="";t.startsWith("assets/")||(i='<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>'),a=`<span contenteditable="false" data-type="img" class="img"><span> </span><span><span class="protyle-action protyle-icons"><span class="protyle-icon protyle-icon--only"><svg><use xlink:href="#iconMore"></use></svg></span></span><img src="${t}" data-src="${t}" alt="${n}" /><span class="protyle-action__drag"></span>${i}<span class="protyle-action__title"></span></span><span> </span></span>`}else Constants.SIYUAN_ASSETS_VIDEO.includes(e)?a=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeVideo" class="iframe" updated="${dayjs().format("YYYYMMDDHHmmss")}"><div class="iframe-content">${Constants.ZWSP}<video controls="controls" src="${t}" data-src="${t}"></video><span class="protyle-action__drag" contenteditable="false"></span></div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`:a=`<span data-type="a" data-href="${t}">${s}</span>`;return a},Xt=(e,t,n,s=[])=>{fetchPost("/api/search/searchAsset",{k:t,exts:s},a=>{let i="";a.data.forEach((c,f)=>{i+=`<div data-value="${c.path}" class="b3-list-item${f===0?" b3-list-item--focus":""}"><div class="b3-list-item__text">${c.hName}</div></div>`});const l=e.querySelector(".b3-list"),o=e.querySelector("#preview"),r=e.querySelector("input");l.innerHTML=i||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,a.data.length>0?o.innerHTML=renderAssetsPreview(a.data[0].path):o.innerHTML=window.siyuan.languages.emptyContent,window.siyuan.menus.menu.fullscreen(),t||r.select()})},Rl=(e,t,n,s)=>{const a=new Menu("background-asset");a.isOpen||a.addItem({iconHTML:"",type:"readonly",label:`<div class="fn__flex" style="max-height: 50vh">
<div class="fn__flex-column" style="${isMobile()?"width:100%":"min-width: 260px;max-width:420px"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div id="preview" style="width: 360px;display: ${isMobile()||window.outerWidth<window.outerWidth/2+260?"none":"flex"};padding: 8px;overflow: auto;justify-content: center;align-items: center;word-break: break-all;"></div>
</div>`,bind(i){i.style.maxWidth="none";const l=i.querySelector(".b3-list"),o=i.querySelector("#preview");l.addEventListener("mouseover",c=>{const f=c.target,u=hasClosestByClassName(f,"b3-list-item");u&&(o.innerHTML=renderAssetsPreview(u.getAttribute("data-value")))});const r=i.querySelector("input");r.addEventListener("keydown",c=>{if(c.isComposing)return;const f=i.querySelector(".b3-list--empty");if(!f){const u=upDownHint(l,c);u&&(o.innerHTML=renderAssetsPreview(u.getAttribute("data-value")),c.stopPropagation())}if(c.key==="Enter"){if(f)n||(window.siyuan.menus.menu.remove(),focusByRange(e.toolbar.range));else{const u=i.querySelector(".b3-list-item--focus");n?n(u.getAttribute("data-value"),u.textContent):(hintRenderAssets(u.getAttribute("data-value"),e),window.siyuan.menus.menu.remove())}c.preventDefault(),c.stopPropagation()}else c.key==="Escape"&&(n||focusByRange(e.toolbar.range))}),r.addEventListener("input",c=>{c.isComposing||(c.stopPropagation(),Xt(i,r.value,t,s))}),r.addEventListener("compositionend",c=>{c.stopPropagation(),Xt(i,r.value,t,s)}),i.lastElementChild.addEventListener("click",c=>{const f=c.target;if(hasClosestByAttribute(f,"data-type","previous")){r.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),c.stopPropagation();return}if(hasClosestByAttribute(f,"data-type","next")){r.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),c.stopPropagation();return}const g=hasClosestByClassName(f,"b3-list-item");if(g){c.stopPropagation();const p=g.getAttribute("data-value");n?n(p,g.textContent):(hintRenderAssets(p,e),window.siyuan.menus.menu.remove())}}),Xt(i,"",t,s)}})},Ol=(e,t)=>{var n;const s=hasClosestBlock(t);if(!s)return;hideElements(["util","toolbar","hint"],e);const a=s.getAttribute("data-node-id");let i=s.outerHTML;window.siyuan.menus.menu.remove();let l;window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",type:"readonly",label:`<div>ID</div>
<textarea rows="1" style="margin:4px 0;width: ${isMobile()?"200":"360"}px" class="b3-text-field" readonly>${t.getAttribute("data-id")||""}</textarea>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.anchor}</div>
<textarea rows="1" style="margin:4px 0;width: ${isMobile()?"200":"360"}px" class="b3-text-field"></textarea>`,bind(r){r.style.maxWidth="none",l=r.querySelectorAll(".b3-text-field")[1],l.value=t.textContent;const c=()=>{l.value?t.innerHTML=Lute.EscapeHTMLStr(l.value):t.innerHTML="*"};l.addEventListener("input",f=>{f.isComposing||(c(),f.stopPropagation())}),l.addEventListener("compositionend",f=>{f.isComposing||(c(),f.stopPropagation())}),l.addEventListener("keydown",f=>{if(!f.isComposing){if(f.key==="Enter"&&!f.isComposing)window.siyuan.menus.menu.remove();else if(electronUndo(f))return}})}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),removeInlineType(t,"file-annotation-ref",e.toolbar.range),updateTransaction(e,a,s.outerHTML,i),i=s.outerHTML}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,a,s.outerHTML,i),focusByWbr(s,e.toolbar.range),i=s.outerHTML}}).element),(n=e==null?void 0:e.app)!=null&&n.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-fileannotationref",detail:{protyle:e,element:t},separatorPosition:"top"});const o=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.left,y:o.top+26,h:26}),window.siyuan.menus.menu.element.setAttribute("data-from",hasClosestByClassName(e.element,"block__edit")?"popover":"app"),l.select(),window.siyuan.menus.menu.removeCB=()=>{s.outerHTML!==i&&(s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,a,s.outerHTML,i));const r=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);r&&!e.element.contains(r.startContainer)&&(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),focusByRange(e.toolbar.range))}},ql=(e,t)=>{var n;const s=hasClosestBlock(t);if(!s)return;hideElements(["util","toolbar","hint"],e);const a=t.getAttribute("data-id"),i=s.getAttribute("data-node-id");let l=s.outerHTML;if(window.siyuan.menus.menu.remove(),e.disabled||(window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.anchor}">`,bind(r){const c=r.querySelector("input");c.value=t.getAttribute("data-subtype")==="d"?"":t.textContent,c.addEventListener("input",()=>{c.value?t.innerHTML=Lute.EscapeHTMLStr(c.value):fetchPost("/api/block/getRefText",{id:a},f=>{t.innerHTML=f.data}),t.setAttribute("data-subtype",c.value?"s":"d")}),c.addEventListener("keydown",f=>{if(!f.isComposing){if(f.key==="Enter"&&!f.isComposing)window.siyuan.menus.menu.remove();else if(electronUndo(f))return}})}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element)),!e.disabled){let r=[];t.getAttribute("data-subtype")==="s"?r.push({label:window.siyuan.languages.turnToDynamic,click(){t.setAttribute("data-subtype","d"),fetchPost("/api/block/getRefText",{id:a},c=>{t.innerHTML=c.data,s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,s.outerHTML,l),l=s.outerHTML}),focusByRange(e.toolbar.range)}}):r.push({label:window.siyuan.languages.turnToStatic,click(){t.setAttribute("data-subtype","s"),s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,s.outerHTML,l),focusByRange(e.toolbar.range),l=s.outerHTML}}),r=r.concat([{label:window.siyuan.languages.text,click(){s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),removeInlineType(t,"block-ref",e.toolbar.range),updateTransaction(e,i,s.outerHTML,l),l=s.outerHTML}},{label:"*",click(){t.setAttribute("data-subtype","s"),t.textContent="*",s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,s.outerHTML,l),focusByRange(e.toolbar.range),l=s.outerHTML}},{label:window.siyuan.languages.text+" *",click(){t.insertAdjacentHTML("beforebegin",t.innerHTML+" "),t.setAttribute("data-subtype","s"),t.textContent="*",s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,s.outerHTML,l),focusByRange(e.toolbar.range),l=s.outerHTML}},{label:window.siyuan.languages.link,icon:"iconLink",click(){t.outerHTML=`<span data-type="a" data-href="siyuan://blocks/${t.getAttribute("data-id")}">${t.innerHTML}</span><wbr>`,s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,s.outerHTML,l),focusByWbr(s,e.toolbar.range),l=s.outerHTML}}]),t.parentElement.textContent.trim()===t.textContent.trim()&&t.parentElement.tagName==="DIV"&&r.push({label:window.siyuan.languages.blockEmbed,icon:"iconSQL",click(){const c=`<div data-content="select * from blocks where id='${a}'" data-node-id="${i}" data-type="NodeBlockQueryEmbed" class="render-node" updated="${dayjs().format("YYYYMMDDHHmmss")}">${s.querySelector(".protyle-attr").outerHTML}</div>`;s.outerHTML=c,updateTransaction(e,i,c,l),blockRender(e,e.wysiwyg.element),l=s.outerHTML}}),r.push({label:window.siyuan.languages.defBlock,click(){fetchPost("/api/block/swapBlockRef",{refID:i,defID:a,includeChildren:!1})}}),r.push({label:window.siyuan.languages.defBlockChildren,click(){fetchPost("/api/block/swapBlockRef",{refID:i,defID:a,includeChildren:!0})}}),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:r}).element)}window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copy,icon:"iconCopy",click(){const r=t.getAttribute("data-subtype")==="s"?'"':"'";writeText(`((${a} ${r}${t.textContent}${r}))`)}}).element),e.disabled||window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.remove,icon:"iconTrashcan",click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,s.outerHTML,l),focusByWbr(s,e.toolbar.range),l=s.outerHTML}}).element),(n=e==null?void 0:e.app)!=null&&n.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-blockref",detail:{protyle:e,element:t},separatorPosition:"top"});const o=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.left,y:o.top+26,h:26}),window.siyuan.menus.menu.element.setAttribute("data-from",hasClosestByClassName(e.element,"block__edit")?"popover":"app"),e.disabled||(window.siyuan.menus.menu.element.querySelector("input").select(),window.siyuan.menus.menu.removeCB=()=>{s.outerHTML!==l&&(s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,s.outerHTML,l));const r=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);r&&!e.element.contains(r.startContainer)&&(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),focusByRange(e.toolbar.range))})},Fl=(e,t)=>{var n;const s=getEditorRange(t);window.siyuan.menus.menu.remove(),e.toolbar.showContent(e,s,t),(n=e==null?void 0:e.app)!=null&&n.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-content",detail:{protyle:e,range:s,element:t},separatorPosition:"top"})},Yl=(e,t)=>{if(e.block.showAll)ps({protyle:e,id:e.block.parent2ID,focusId:t});else{const n=e.path.split("/");n.length>2&&openMobileFileById(e.app,n[n.length-2],[Constants.CB_GET_FOCUS,Constants.CB_GET_SCROLL])}},ps=e=>{var t,n;if(e.protyle.options.backlinkData)return;typeof e.isPushBack=="undefined"&&(e.isPushBack=!0),typeof e.reload=="undefined"&&(e.reload=!1);const s=(t=e.protyle.breadcrumb)==null?void 0:t.element.querySelector(".protyle-breadcrumb__item--active");if(!e.reload&&s&&s.getAttribute("data-node-id")===e.id){if(e.id===e.protyle.block.rootID)return;const a=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.focusId||e.id}"]`);if(a){focusBlock(a),a.scrollIntoView();return}}(n=window.siyuan.mobile)!=null&&n.editor&&(window.siyuan.storage[Constants.LOCAL_DOCINFO]={id:e.id},setStorageVal(Constants.LOCAL_DOCINFO,window.siyuan.storage[Constants.LOCAL_DOCINFO]),e.isPushBack&&pushBack()),fetchPost("/api/filetree/getDoc",{id:e.id,size:e.id===e.protyle.block.rootID?window.siyuan.config.editor.dynamicLoadBlocks:Constants.SIZE_GET_MAX},a=>{if(e.isPushBack?onGet({data:a,protyle:e.protyle,action:e.id===e.protyle.block.rootID?[Constants.CB_GET_FOCUS,Constants.CB_GET_HTML]:[Constants.CB_GET_ALL,Constants.CB_GET_FOCUS,Constants.CB_GET_HTML],afterCB:e.callback}):onGet({data:a,protyle:e.protyle,action:e.id===e.protyle.block.rootID?[Constants.CB_GET_FOCUS,Constants.CB_GET_HTML,Constants.CB_GET_UNUNDO]:[Constants.CB_GET_ALL,Constants.CB_GET_FOCUS,Constants.CB_GET_UNUNDO,Constants.CB_GET_HTML],afterCB:e.callback}),e.focusId){const i=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.focusId}"]`);if(i)focusBlock(i),i.scrollIntoView();else if(e.id===e.protyle.block.rootID){fetchPost("/api/filetree/getDoc",{id:e.focusId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{onGet({data:l,protyle:e.protyle,action:e.isPushBack?[Constants.CB_GET_FOCUS]:[Constants.CB_GET_FOCUS,Constants.CB_GET_UNUNDO]})});return}}else e.id!==e.protyle.block.rootID&&(e.protyle.wysiwyg.element.classList.add("protyle-wysiwyg--animate"),setTimeout(()=>{e.protyle.wysiwyg.element.classList.remove("protyle-wysiwyg--animate")},365))})},Wl=(e,t,n,s)=>{var a;window.siyuan.menus.menu.remove();const i=hasClosestBlock(n);if(!i)return;hideElements(["util","toolbar","hint"],e);const l=i.getAttribute("data-node-id"),o=n.querySelector("img"),r=n.querySelector(".protyle-action__title"),c=i.outerHTML;if(e.disabled||(window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",type:"readonly",label:`<div>${window.siyuan.languages.imageURL}</div>
<textarea style="margin:4px 0;width: ${isMobile()?"200":"360"}px" rows="1" class="b3-text-field">${o.getAttribute("src")}</textarea>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.title}</div>
<textarea style="margin:4px 0;width: ${isMobile()?"200":"360"}px" rows="1" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.tooltipText}</div>
<textarea style="margin:4px 0;width: ${isMobile()?"200":"360"}px" rows="1" class="b3-text-field"></textarea>`,bind(u){u.style.maxWidth="none";const d=u.querySelectorAll("textarea");d[0].addEventListener("input",g=>{if(g.isComposing)return;const p=g.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"");if(o.setAttribute("src",p),o.setAttribute("data-src",p),p.startsWith("assets/")){const b=n.querySelector(".img__net");b&&b.remove()}else window.siyuan.config.editor.displayNetImgMark&&n.querySelector(".protyle-action__drag").insertAdjacentHTML("afterend",'<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>')}),d[1].value=r.textContent,d[1].addEventListener("input",g=>{const p=g.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"");o.setAttribute("title",p),r.textContent=p,mathRender(r)}),d[2].value=o.getAttribute("alt")||""}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element)),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copy,accelerator:"\u2318C",icon:"iconCopy",click(){writeText(e.lute.BlockDOM2StdMd(n.outerHTML))}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copy+" PNG",accelerator:window.siyuan.config.keymap.editor.general.copyBlockRef.custom,icon:"iconImage",click(){copyPNG(o)}}).element),!e.disabled){window.siyuan.menus.menu.append(new MenuItem({icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){writeText(e.lute.BlockDOM2StdMd(n.outerHTML)),n.outerHTML="<wbr>",i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,l,i.outerHTML,c),focusByWbr(e.wysiwyg.element,t)}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click:function(){n.outerHTML="<wbr>",i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,l,i.outerHTML,c),focusByWbr(e.wysiwyg.element,t)}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element);const u=o.getAttribute("data-src");u.startsWith("assets/")&&window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.rename,icon:"iconEdit",click(){renameAsset(u)}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click(){alignImgCenter(e,i,[n],l,c)}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click(){alignImgLeft(e,i,[n],l,c)}}).element);const d=n.style.width.endsWith("%")?parseInt(n.style.width):0;window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.width,submenu:[Ue("25%",n,o,e,l,i,c),Ue("33%",n,o,e,l,i,c),Ue("50%",n,o,e,l,i,c),Ue("67%",n,o,e,l,i,c),Ue("75%",n,o,e,l,i,c),Ue("100%",n,o,e,l,i,c),{type:"separator"},{iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${d===0?window.siyuan.languages.default:d+"%"}" class="b3-tooltips b3-tooltips__n${isMobile()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${d}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind(g){const p=g.querySelector("input");p.addEventListener("input",()=>{n.style.width=p.value+"%",o.style.width="10000px",p.parentElement.setAttribute("aria-label",`${p.value}%`)}),p.addEventListener("change",()=>{i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,l,i.outerHTML,c),window.siyuan.menus.menu.remove(),focusBlock(i)})}},{type:"separator"},Ue(window.siyuan.languages.default,n,o,e,l,i,c)]}).element)}const f=o.getAttribute("src");if(f&&(window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),openMenu(e.app,f,!1,!1)),(a=e==null?void 0:e.app)!=null&&a.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-image",detail:{protyle:e,element:n},separatorPosition:"top"}),window.siyuan.menus.menu.popup({x:s.clientX,y:s.clientY}),window.siyuan.menus.menu.element.setAttribute("data-from",hasClosestByClassName(e.element,"block__edit")?"popover":"app"),!e.disabled){const u=window.siyuan.menus.menu.element.querySelectorAll("textarea");u[0].focus(),window.siyuan.menus.menu.removeCB=()=>{const d=window.siyuan.menus.menu.element.querySelector('[data-type="ocr"]');d&&fetchPost("/api/asset/setImageOCRText",{path:o.getAttribute("src"),text:d.value}),o.setAttribute("alt",u[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")),i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,l,i.outerHTML,c)}}},jl=(e,t,n=!1)=>{var s;window.siyuan.menus.menu.remove();const a=hasClosestBlock(t);if(!a)return;hideElements(["util","toolbar","hint"],e);const i=a.getAttribute("data-node-id");let l=a.outerHTML;const o=t.getAttribute("data-href");let r;window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",type:"readonly",label:`<div>${window.siyuan.languages.link}</div>
<textarea rows="1" style="margin:4px 0;width: ${isMobile()?"200":"360"}px" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.anchor}</div>
<textarea style="width: ${isMobile()?"200":"360"}px;margin: 4px 0;" rows="1" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.title}</div>
<textarea style="width: ${isMobile()?"200":"360"}px;margin: 4px 0;" rows="1" class="b3-text-field"></textarea>`,bind(f){f.style.maxWidth="none",r=f.querySelectorAll("textarea"),r[0].value=Lute.UnEscapeHTMLStr(o)||"",r[0].addEventListener("keydown",d=>{if((d.key==="Enter"||d.key==="Escape")&&!d.isComposing)d.preventDefault(),d.stopPropagation(),window.siyuan.menus.menu.remove();else if(d.key==="Tab"&&!d.isComposing)d.preventDefault(),d.stopPropagation(),r[1].focus();else if(electronUndo(d))return});let u=t.textContent.replace(Constants.ZWSP,"");!u&&o&&(u=o.replace("https://","").replace("http://",""),u.length>24&&(u=u.substring(0,Constants.SIZE_LINK_TEXT_MAX)+"..."),t.innerHTML=Lute.EscapeHTMLStr(u)),r[1].value=u,r[1].addEventListener("compositionend",()=>{t.innerHTML=Lute.EscapeHTMLStr(r[1].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")||"*")}),r[1].addEventListener("input",d=>{d.isComposing||(t.innerHTML=Lute.EscapeHTMLStr(r[1].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))||"*")}),r[1].addEventListener("keydown",d=>{if((d.key==="Enter"||d.key==="Escape")&&!d.isComposing)d.preventDefault(),d.stopPropagation(),window.siyuan.menus.menu.remove();else if(d.key==="Tab"&&!d.isComposing)d.preventDefault(),d.stopPropagation(),d.shiftKey?r[0].focus():r[2].focus();else if(electronUndo(d))return}),r[2].value=Lute.UnEscapeHTMLStr(t.getAttribute("data-title")||""),r[2].addEventListener("keydown",d=>{if((d.key==="Enter"||d.key==="Escape")&&!d.isComposing)d.preventDefault(),d.stopPropagation(),window.siyuan.menus.menu.remove();else if(d.key==="Tab"&&d.shiftKey&&!d.isComposing)d.preventDefault(),d.stopPropagation(),r[1].focus();else if(electronUndo(d))return})}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),o&&openMenu(e.app,o,!1,!0),o!=null&&o.startsWith("assets/")&&window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.rename,icon:"iconEdit",click(){renameAsset(o)}}).element),o!=null&&o.startsWith("siyuan://blocks/")&&window.siyuan.menus.menu.append(new MenuItem({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.ref}</b>`,icon:"iconRef",click(){t.setAttribute("data-subtype","s");const f=t.getAttribute("data-type").split(" ");f.push("block-ref"),f.splice(f.indexOf("a"),1),t.setAttribute("data-type",f.join(" ")),t.setAttribute("data-id",r[0].value.replace("siyuan://blocks/","")),r[0].value="",r[2].value="",t.removeAttribute("data-href"),t.removeAttribute("data-title"),a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,a.outerHTML,l),e.toolbar.range.selectNode(t),e.toolbar.range.collapse(!1),focusByRange(e.toolbar.range),l=a.outerHTML}}).element),window.siyuan.menus.menu.append(new MenuItem({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){r[0].value="",r[2].value="",a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),removeInlineType(t,"a",e.toolbar.range),updateTransaction(e,i,a.outerHTML,l),l=a.outerHTML}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,a.outerHTML,l),focusByWbr(a,e.toolbar.range),l=a.outerHTML}}).element),(s=e==null?void 0:e.app)!=null&&s.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-link",detail:{protyle:e,element:t},separatorPosition:"top"});const c=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:c.left,y:c.top+26,h:26}),window.siyuan.menus.menu.element.setAttribute("data-from",hasClosestByClassName(e.element,"block__edit")?"popover":"app"),n||e.lute.IsValidLinkDest(o)?r[1].select():r[0].select(),window.siyuan.menus.menu.removeCB=()=>{r[2].value?t.setAttribute("data-title",Lute.EscapeHTMLStr(r[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):t.removeAttribute("data-title"),t.getAttribute("data-type").indexOf("a")>-1?t.setAttribute("data-href",Lute.EscapeHTMLStr(r[0].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):t.removeAttribute("data-href");const f=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);f&&!e.element.contains(f.startContainer)&&(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),focusByRange(e.toolbar.range)),l!==a.outerHTML&&(a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,a.outerHTML,l))}},Ul=(e,t)=>{var n;window.siyuan.menus.menu.remove();const s=hasClosestBlock(t);if(!s)return;hideElements(["util","toolbar","hint"],e);const a=s.getAttribute("data-node-id");let i=s.outerHTML;window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",type:"readonly",label:`<input class="b3-text-field fn__size200" style="margin: 4px 0" placeholder="${window.siyuan.languages.tag}">`,bind(o){const r=o.querySelector("input");r.value=t.textContent.replace(Constants.ZWSP,""),r.addEventListener("change",()=>{updateTransaction(e,a,s.outerHTML,i),i=s.outerHTML}),r.addEventListener("compositionend",()=>{t.innerHTML=Constants.ZWSP+Lute.EscapeHTMLStr(r.value||"")}),r.addEventListener("input",c=>{c.isComposing||(t.innerHTML=Constants.ZWSP+Lute.EscapeHTMLStr(r.value||""))}),r.addEventListener("keydown",c=>{if((c.key==="Enter"||c.key==="Escape")&&!c.isComposing){if(c.preventDefault(),c.stopPropagation(),r.value)e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),focusByRange(e.toolbar.range);else{const f=s.outerHTML;t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,a,s.outerHTML,f),focusByWbr(s,e.toolbar.range)}window.siyuan.menus.menu.remove()}else if(electronUndo(c))return})}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){e.toolbar.range.setStart(t.firstChild,0),e.toolbar.range.setEnd(t.lastChild,t.lastChild.textContent.length),e.toolbar.setInlineMark(e,"tag","range")}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.rename,icon:"iconEdit",click(){renameTag(t.textContent.replace(Constants.ZWSP,""))}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){const o=s.outerHTML;t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,a,s.outerHTML,o),focusByWbr(s,e.toolbar.range)}}).element),(n=e==null?void 0:e.app)!=null&&n.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-tag",detail:{protyle:e,element:t},separatorPosition:"top"});const l=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:l.left,y:l.top+26,h:26}),window.siyuan.menus.menu.element.setAttribute("data-from",hasClosestByClassName(e.element,"block__edit")?"popover":"app"),window.siyuan.menus.menu.element.querySelector("input").select()},Ue=(e,t,n,s,a,i,l)=>({iconHTML:"",label:e,click(){if(i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),e===window.siyuan.languages.default){const o=t.style.display==="block";t.removeAttribute("style"),n.removeAttribute("style"),o&&(t.style.display="block")}else t.style.width=e,n.style.width="10000px";updateTransaction(s,a,i.outerHTML,l),focusBlock(i)}}),Vl=(e,t)=>{const n=t.getAttribute("data-node-id"),s=t.querySelector("iframe");let a=t.outerHTML;const i=[{iconHTML:"",type:"readonly",label:`<textarea rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.link}" style="margin: 4px 0">${s.getAttribute("src")||""}</textarea>`,bind(o){o.style.maxWidth="none",o.querySelector("textarea").addEventListener("change",r=>{const c=r.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""),f=c.match(/(?:www\.|\/\/)bilibili\.com\/video\/(\w+)/);if(c.indexOf("bilibili.com")>-1&&(c.indexOf("bvid=")>-1||f&&f[1])){const u={bvid:getSearch("bvid",c)||f&&f[1],page:"1",high_quality:"1",as_wide:"1",allowfullscreen:"true"};new URL(c.startsWith("http")?c:"https:"+c).search.split("&").forEach((p,b)=>{b===0&&(p=p.substr(1));const m=p.split("=");u[m[0]]=m[1]});let d="https://player.bilibili.com/player.html?";const g=Object.keys(u);g.forEach((p,b)=>{d+=`${p}=${u[p]}`,b<g.length-1&&(d+="&")}),s.setAttribute("src",d),s.setAttribute("sandbox","allow-top-navigation-by-user-activation allow-same-origin allow-forms allow-scripts allow-popups"),s.style.height||(s.style.height="360px"),s.style.width||(s.style.width="640px")}else s.setAttribute("src",c);updateTransaction(e,n,t.outerHTML,a),a=t.outerHTML,r.stopPropagation()})}}],l=s.getAttribute("src");return l?(i.push({type:"separator"}),i.concat(openMenu(e.app,l,!0,!1))):i},Gl=(e,t,n)=>{const s=t.getAttribute("data-node-id"),a=t.querySelector(n==="NodeVideo"?"video":"audio");let i=t.outerHTML;const l=[{iconHTML:"",type:"readonly",label:`<textarea rows="1" style="margin: 4px 0" class="b3-text-field" placeholder="${window.siyuan.languages.link}">${a.getAttribute("src")}</textarea>`,bind(c){c.style.maxWidth="none",c.querySelector("textarea").addEventListener("change",f=>{a.setAttribute("src",f.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")),updateTransaction(e,s,t.outerHTML,i),i=t.outerHTML,f.stopPropagation()})}}],o=a.getAttribute("src");o.startsWith("assets/")&&(l.push({type:"separator"}),l.push({label:window.siyuan.languages.rename,icon:"iconEdit",click(){renameAsset(o)}}));const r=a.getAttribute("src");return r&&l.push({label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:openMenu(e.app,r,!0,!1)}),l},zl=(e,t,n,s)=>{var a;const i=[],l=getColIndex(n);(n.rowSpan>1||n.colSpan>1)&&i.push({label:window.siyuan.languages.cancelMerged,click:()=>{const w=t.outerHTML;let _=n.rowSpan,C=n.parentElement;const x=n.colSpan;for(;_>0&&C;){let T=C.children[l],B=x;for(;B>0&&T;)T.classList.remove("fn__none"),T.colSpan=1,T.rowSpan=1,T=T.nextElementSibling,B--;C=C.nextElementSibling,_--}if(n.rowSpan=1,n.colSpan=1,n.tagName==="TH"){let T;if(Array.from(t.querySelectorAll("thead tr")).find(B=>{if(T=B,Array.from(B.children).forEach(D=>{(D.rowSpan!==1||D.classList.contains("fn__none"))&&(T=void 0)}),T)return!0}),T){const B=t.querySelector("tbody"),D=t.querySelector("thead");for(;!T.isSameNode(D.lastElementChild);)B.insertAdjacentElement("afterbegin",D.lastElementChild)}}focusByRange(s),updateTransaction(e,t.getAttribute("data-node-id"),t.outerHTML,w)}});const o=t.querySelectorAll("col")[l];(o.style.width||o.style.minWidth)&&i.push({label:window.siyuan.languages.useDefaultWidth,click:()=>{const w=t.outerHTML;o.style.width="",o.style.minWidth="",updateTransaction(e,t.getAttribute("data-node-id"),t.outerHTML,w)}});const r=t.getAttribute("custom-pinthead");i.push({icon:r?"iconUnpin":"iconPin",label:r?window.siyuan.languages.unpinTableHead:window.siyuan.languages.pinTableHead,click:()=>{const w=t.outerHTML;r?t.removeAttribute("custom-pinthead"):t.setAttribute("custom-pinthead","true"),updateTransaction(e,t.getAttribute("data-node-id"),t.outerHTML,w)}}),i.push({type:"separator"}),i.push({icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{setTableAlign(e,[n],t,"left",s)}}),i.push({icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{setTableAlign(e,[n],t,"center",s)}}),i.push({icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{setTableAlign(e,[n],t,"right",s)}}),i.push({type:"separator"});const c=t.querySelector("table"),f=n.parentElement.querySelector(".fn__none");let u=!1,d=!1;Array.from(n.parentElement.children).forEach(w=>{w.colSpan>1&&(u=!0),w.rowSpan>1&&(d=!0)});let g=!1,p=!1,b=!1,m=n.parentElement.previousElementSibling;!m&&n.parentElement.parentElement.tagName==="TBODY"&&(m=c.querySelector("thead").lastElementChild),m&&(g=m.querySelector(".fn__none"),Array.from(m.children).forEach(w=>{w.colSpan>1&&(p=!0),w.rowSpan>1&&(b=!0)}));let h=!1,y=!1,k=!1,E=n.parentElement.nextElementSibling;!E&&n.parentElement.parentElement.tagName==="THEAD"&&(E=(a=c.querySelector("tbody"))==null?void 0:a.firstElementChild),E&&(h=E.querySelector(".fn__none"),Array.from(E.children).forEach(w=>{w.colSpan>1&&(y=!0),w.rowSpan>1&&(k=!0)}));let A=!0;Array.from(c.rows).find(w=>{const _=w.cells[l];if(_.classList.contains("fn__none")||_.colSpan>1||_.rowSpan>1)return A=!1,!0});let v=!0;Array.from(c.rows).find(w=>{const _=w.cells[l+1];if(_&&(_.classList.contains("fn__none")||_.colSpan>1||_.rowSpan>1))return v=!1,!0});let S=!0;return Array.from(c.rows).find(w=>{const _=w.cells[l-1];if(_&&(_.classList.contains("fn__none")||_.colSpan>1||_.rowSpan>1))return S=!1,!0}),i.push({icon:"iconBefore",label:window.siyuan.languages.insertRowAbove,accelerator:window.siyuan.config.keymap.editor.table.insertRowAbove.custom,click:()=>{insertRowAbove(e,s,n,t)}}),(!h||h&&!k&&y)&&i.push({icon:"iconAfter",label:window.siyuan.languages.insertRowBelow,accelerator:window.siyuan.config.keymap.editor.table.insertRowBelow.custom,click:()=>{insertRow(e,s,n,t)}}),(A||S)&&i.push({icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,accelerator:window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,click:()=>{insertColumn(e,t,n,"beforebegin",s)}}),(A||v)&&i.push({icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,accelerator:window.siyuan.config.keymap.editor.table.insertColumnRight.custom,click:()=>{insertColumn(e,t,n,"afterend",s)}}),((!f||f&&!d&&u)&&(!g||g&&!b&&p)||(!f||f&&!d&&u)&&(!h||h&&!k&&y)||A&&S||A&&v)&&i.push({type:"separator"}),(!f||f&&!d&&u)&&(!g||g&&!b&&p)&&i.push({icon:"iconUp",label:window.siyuan.languages.moveToUp,accelerator:window.siyuan.config.keymap.editor.table.moveToUp.custom,click:()=>{moveRowToUp(e,s,n,t)}}),(!f||f&&!d&&u)&&(!h||h&&!k&&y)&&i.push({icon:"iconDown",label:window.siyuan.languages.moveToDown,accelerator:window.siyuan.config.keymap.editor.table.moveToDown.custom,click:()=>{moveRowToDown(e,s,n,t)}}),A&&S&&i.push({icon:"iconLeft",label:window.siyuan.languages.moveToLeft,accelerator:window.siyuan.config.keymap.editor.table.moveToLeft.custom,click:()=>{moveColumnToLeft(e,s,n,t)}}),A&&v&&i.push({icon:"iconRight",label:window.siyuan.languages.moveToRight,accelerator:window.siyuan.config.keymap.editor.table.moveToRight.custom,click:()=>{moveColumnToRight(e,s,n,t)}}),(n.parentElement.parentElement.tagName!=="THEAD"&&(!f&&!d||f&&!d&&u)||A)&&i.push({type:"separator"}),n.parentElement.parentElement.tagName!=="THEAD"&&(!f&&!d||f&&!d&&u)&&i.push({icon:"iconDeleteRow",label:window.siyuan.languages["delete-row"],accelerator:window.siyuan.config.keymap.editor.table["delete-row"].custom,click:()=>{deleteRow(e,s,n,t)}}),A&&i.push({icon:"iconDeleteColumn",label:window.siyuan.languages["delete-column"],accelerator:window.siyuan.config.keymap.editor.table["delete-column"].custom,click:()=>{deleteColumn(e,s,t,n)}}),i},Kl=(e,t,n,s)=>{if(t.getAttribute("data-type")==="NodeListItem"&&t.childElementCount<4||t.getAttribute("data-type")==="NodeThematicBreak")return-1;let a="0";if(t.getAttribute("fold")==="1"){if(typeof n=="boolean"&&!n)return-1;t.removeAttribute("fold"),t.querySelectorAll(".protyle-linenumber").forEach(l=>{lineNumberRender(l)})}else{if(typeof n=="boolean"&&n)return-1;if(a="1",t.setAttribute("fold","1"),getSelection().rangeCount>0){const l=getSelection().getRangeAt(0),o=hasClosestBlock(l.startContainer);o&&o.getBoundingClientRect().width===0&&focusBlock(t,void 0,!1)}t.querySelectorAll(".img--select, .av__cell--select, .av__cell--active, .av__row--select").forEach(l=>{var o;l.classList.contains("av__row--select")?(l.classList.remove("av__row--select"),l.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),updateHeader(l)):((o=l.querySelector(".av__drag-fill"))==null||o.remove(),l.classList.remove("img--select","av__cell--select","av__cell--active"))})}const i=t.getAttribute("data-node-id");return t.getAttribute("data-type")==="NodeHeading"?a==="0"?(t.insertAdjacentHTML("beforeend",'<div spin="1" style="text-align: center"><img width="24px" src="/stage/loading-pure.svg"></div>'),transaction(e,[{action:"unfoldHeading",id:i,data:s?"remove":void 0}],[{action:"foldHeading",id:i}])):(transaction(e,[{action:"foldHeading",id:i}],[{action:"unfoldHeading",id:i}]),removeFoldHeading(t)):transaction(e,[{action:"setAttrs",id:i,data:JSON.stringify({fold:a})}],[{action:"setAttrs",id:i,data:JSON.stringify({fold:a==="0"?"1":"0"})}]),preventScroll(e),a},Zl=(e,t)=>{const n=[],s=[];let a=t.previousElementSibling?t.previousElementSibling.getAttribute("data-node-id"):void 0;t.classList.remove("protyle-wysiwyg--select"),t.removeAttribute("select-start"),t.removeAttribute("select-end");const i=t.getAttribute("data-node-id"),l=t.cloneNode();return l.innerHTML=t.lastElementChild.outerHTML,s.push({action:"insert",id:i,data:l.outerHTML,previousID:t.previousElementSibling?t.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:t.parentElement.getAttribute("data-node-id")||e.block.parentID}),Array.from(t.children).forEach((o,r)=>{if(r===t.childElementCount-1){n.push({action:"delete",id:i}),t.lastElementChild.remove(),t.outerHTML=t.innerHTML;return}n.push({action:"move",id:o.getAttribute("data-node-id"),previousID:a,parentID:t.parentElement.getAttribute("data-node-id")||e.block.parentID}),s.push({action:"move",id:o.getAttribute("data-node-id"),previousID:o.previousElementSibling?o.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:i}),a=o.getAttribute("data-node-id")}),n.forEach(o=>{const r=e.wysiwyg.element.querySelector(`[data-node-id="${o.id}"]`);r&&r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),blockRender(e,r))}),{doOperations:n,undoOperations:s,previousId:a}},Xl=(e,t,n)=>{const s=document.createElement("div");return s.setAttribute("data-node-id",t||Lute.NewNodeID()),s.setAttribute("data-type","NodeSuperBlock"),s.setAttribute("class","sb"),s.setAttribute("data-sb-layout",e),s.innerHTML=n||`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,s},Ql=(e,t)=>{const n=getTopAloneElement(t);if(n){const s=hasClosestByClassName(n,"list")||hasClosestByClassName(n,"bq")||hasClosestByClassName(n,"sb")||n,a=getNextBlock(s);a?(focusBlock(a),scrollCenter(e,a)):fetchPost("/api/block/getParentNextChildID",{id:t.getAttribute("data-node-id")},i=>{i.data.id&&zoomOut({protyle:e,id:i.data.id})})}},Jl=(e,t,n)=>{const s=getEditorRange(e.wysiwyg.element);let a;if(n)a=e.wysiwyg.element.querySelector(`[data-node-id="${n}"]`);else{const c=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");c.length>0?(t==="beforebegin"?a=c[0]:a=c[c.length-1],hideElements(["select"],e)):(a=hasClosestBlock(s.startContainer),a=getTopAloneElement(a))}if(!a)return;let i=ms(!1,!0),l=1;a.getAttribute("data-type")==="NodeListItem"&&(i=genListItemElement(a,0,!0),l=parseInt(a.parentElement.firstElementChild.getAttribute("data-marker")));const o=a.parentElement.outerHTML,r=i.getAttribute("data-node-id");if(a.insertAdjacentElement(t,i),a.getAttribute("data-type")==="NodeListItem"&&a.getAttribute("data-subtype")==="o"&&!i.parentElement.classList.contains("protyle-wysiwyg"))updateListOrder(i.parentElement,l),updateTransaction(e,i.parentElement.getAttribute("data-node-id"),i.parentElement.outerHTML,o);else{let c;t==="beforebegin"?c=[{action:"insert",data:i.outerHTML,id:r,nextID:a.getAttribute("data-node-id")}]:c=[{action:"insert",data:i.outerHTML,id:r,previousID:a.getAttribute("data-node-id")}],transaction(e,c,[{action:"delete",id:r}])}focusByWbr(e.wysiwyg.element,s),scrollCenter(e)},er=(e=!0,t=!0,n)=>{let s="";return e&&(s=Constants.ZWSP),t&&(s+="<wbr>"),n&&(s+=n),`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${s}</div><div contenteditable="false" class="protyle-attr">${Constants.ZWSP}</div></div>`},ms=(e=!0,t=!0,n)=>{const s=document.createElement("div");return s.setAttribute("data-node-id",n||Lute.NewNodeID()),s.setAttribute("data-type","NodeParagraph"),s.classList.add("p"),s.innerHTML=`<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${e?Constants.ZWSP:""}${t?"<wbr>":""}</div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,s},bs=(e,t,n,s=!1)=>{var a;if(!t.parentElement.previousElementSibling&&t.parentElement.nextElementSibling&&t.parentElement.nextElementSibling.classList.contains("protyle-attr")){listOutdent(e,[t.parentElement],n,s,t);return}if(!t.parentElement.previousElementSibling&&t.parentElement.parentElement.parentElement.classList.contains("list")){n.insertNode(document.createElement("wbr"));const d=t.parentElement.parentElement,g=d.outerHTML,p=t.parentElement.parentElement.previousElementSibling.lastElementChild,b=p.parentElement.outerHTML;t.parentElement.firstElementChild.remove(),t.parentElement.lastElementChild.remove(),p.insertAdjacentHTML("beforebegin",t.parentElement.innerHTML),t.parentElement.remove(),d.getAttribute("data-subtype")==="o"&&updateListOrder(d),transaction(e,[{action:"update",id:d.getAttribute("data-node-id"),data:d.outerHTML},{action:"update",data:p.parentElement.outerHTML,id:p.parentElement.getAttribute("data-node-id")}],[{action:"update",data:b,id:p.parentElement.getAttribute("data-node-id")},{action:"update",data:g,id:d.getAttribute("data-node-id")}]),focusByWbr(p.parentElement,n);return}if(!t.parentElement.previousElementSibling){if(t.parentElement.parentElement.classList.contains("protyle-wysiwyg"))return;Dn(t,n,s),n.insertNode(document.createElement("wbr"));const d=t.parentElement.parentElement,g=d.outerHTML;t.parentElement.firstElementChild.remove(),t.parentElement.lastElementChild.remove();const p=document.createElement("div");p.innerHTML=t.parentElement.innerHTML;const b=[],m=[];Array.from(p.children).forEach((h,y)=>{var k;b.push({action:"insert",id:h.getAttribute("data-node-id"),data:h.outerHTML,previousID:y===0?(k=d.previousElementSibling)==null?void 0:k.getAttribute("data-node-id"):b[y-1].id,parentID:d.parentElement.getAttribute("data-node-id")||e.block.parentID}),m.push({action:"delete",id:h.getAttribute("data-node-id")})}),d.insertAdjacentHTML("beforebegin",t.parentElement.innerHTML),t.parentElement.remove(),d.getAttribute("data-subtype")==="o"&&updateListOrder(d,parseInt(d.firstElementChild.getAttribute("data-marker"))-1),b.splice(0,0,{action:"update",id:d.getAttribute("data-node-id"),data:d.outerHTML}),m.push({action:"update",data:g,id:d.getAttribute("data-node-id")}),transaction(e,b,m),focusByWbr(e.wysiwyg.element,n);return}const i=t.parentElement;if(i.previousElementSibling&&i.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;const l=i.getAttribute("data-node-id"),o=i.parentElement;Dn(t,n,s),n.insertNode(document.createElement("wbr"));const r=o.outerHTML,c=[],f=[{action:"insert",id:l,data:"",previousID:i.previousElementSibling.getAttribute("data-node-id")}],u=i.previousElementSibling.lastElementChild;if(i.previousElementSibling.getAttribute("fold")==="1")if(getContenteditableElement(t).textContent.trim()===""&&t.nextElementSibling.classList.contains("protyle-attr"))c.push({action:"delete",id:l}),f[0].data=i.outerHTML,setLastNodeRange(getContenteditableElement(i.previousElementSibling),n),n.collapse(!0),i.remove();else{setLastNodeRange(getContenteditableElement(i.previousElementSibling),n),n.collapse(!0),focusByRange(n),(a=t.querySelector("wbr"))==null||a.remove();return}else{let d=u.previousElementSibling.getAttribute("data-node-id");Array.from(t.parentElement.children).forEach((g,p)=>{if(g.classList.contains("protyle-action")||g.classList.contains("protyle-attr"))return;const b=g.getAttribute("data-node-id");c.push({action:"move",id:b,previousID:d}),f.push({action:"move",id:b,previousID:p===1?void 0:d,parentID:l}),d=b,u.before(g)}),c.push({action:"delete",id:l}),f[0].data=i.outerHTML,i.remove()}o.classList.contains("protyle-wysiwyg")?transaction(e,c,f):(o.getAttribute("data-subtype")==="o"&&updateListOrder(o),updateTransaction(e,o.getAttribute("data-node-id"),o.outerHTML,r)),focusByWbr(u.parentElement,n)},hs=(e,t,n,s=!1)=>{var a,i,l,o,r,c,f;preventScroll(e);const u=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if((u==null?void 0:u.length)>0){const v=[],S=[];let w=u[0].previousElementSibling||u[u.length-1].nextElementSibling,_,C;if(hideElements(["select"],e),u.find(x=>{const T=getTopAloneElement(x);C=T.parentElement;const B=T.getAttribute("data-node-id");if(v.push({action:"delete",id:B}),w=getNextBlock(T)||getPreviousBlock(T)||T.parentElement||e.wysiwyg.element.firstElementChild,T.getAttribute("data-type")==="NodeHeading"&&T.getAttribute("fold")==="1"){setFold(e,T,void 0,!0),S.push({action:"insert",data:T.outerHTML,id:B,previousID:u[0].previousElementSibling?u[0].previousElementSibling.getAttribute("data-node-id"):"",parentID:T.parentElement.getAttribute("data-node-id")||e.block.parentID}),T.firstElementChild.removeAttribute("contenteditable");const D=T.nextElementSibling;if(D){const H=D.getAttribute("data-type");if(H!=="NodeHeading"||H==="NodeHeading"&&D.getAttribute("data-subtype")>T.getAttribute("data-subtype"))return!0}}else{let D=T.outerHTML;(T.classList.contains("render-node")||T.querySelector("div.render-node"))&&(D=e.lute.SpinBlockDOM(T.outerHTML)),S.push({action:"insert",data:D,id:B,previousID:T.previousElementSibling?T.previousElementSibling.getAttribute("data-node-id"):"",parentID:T.parentElement.getAttribute("data-node-id")||e.block.parentID}),T.getAttribute("data-subtype")==="o"&&T.classList.contains("li")?_=T.parentElement:_=void 0,T.remove()}}),w)if(e.block.showAll&&w.classList.contains("protyle-wysiwyg")&&e.wysiwyg.element.childElementCount===0)setTimeout(()=>{zoomOut({protyle:e,id:e.block.parent2ID,focusId:e.block.parent2ID})},Constants.TIMEOUT_INPUT*2+100);else{if(w.classList.contains("protyle-wysiwyg")&&e.wysiwyg.element.childElementCount===0){const x=Lute.NewNodeID(),T=genEmptyElement(!1,!0,x);w.insertAdjacentElement("afterbegin",T),v.push({action:"insert",data:T.outerHTML,id:x,parentID:w.getAttribute("data-node-id")||e.block.parentID}),S.push({action:"delete",id:x}),w=void 0,focusByWbr(T,n)}focusBlock(w),scrollCenter(e,w),_&&(S.push({action:"update",id:_.getAttribute("data-node-id"),data:_.outerHTML}),updateListOrder(_,1),v.push({action:"update",id:_.getAttribute("data-node-id"),data:_.outerHTML}))}if(v.length>0)if(C&&C.getAttribute("data-type")==="NodeSuperBlock"&&C.childElementCount===2){const x=cancelSB(e,C);transaction(e,v.concat(x.doOperations),x.undoOperations.concat(S.reverse()))}else transaction(e,v,S.reverse());hideElements(["util"],e);return}if(t.getAttribute("data-type")==="NodeCodeBlock"&&getContenteditableElement(t).textContent.trim()===""){t.classList.add("protyle-wysiwyg--select"),hs(e,t,n);return}if(t.getAttribute("data-type")==="NodeCodeBlock"||t.getAttribute("data-type")==="NodeTable"){t.previousElementSibling&&focusBlock(t.previousElementSibling,void 0,!1);return}if(t.getAttribute("data-type")==="NodeHeading"){turnsIntoTransaction({protyle:e,selectsElement:[t],type:"Blocks2Ps"});return}if(!t.previousElementSibling&&t.parentElement.getAttribute("data-type")==="NodeBlockquote"){n.insertNode(document.createElement("wbr"));const v=t.parentElement;v.insertAdjacentElement("beforebegin",t),v.childElementCount===1?(transaction(e,[{action:"move",id:t.getAttribute("data-node-id"),previousID:(a=t.previousElementSibling)==null?void 0:a.getAttribute("data-node-id"),parentID:v.parentElement.getAttribute("data-node-id")||e.block.parentID},{action:"delete",id:v.getAttribute("data-node-id")}],[{action:"insert",id:v.getAttribute("data-node-id"),data:v.outerHTML,previousID:(i=t.previousElementSibling)==null?void 0:i.getAttribute("data-node-id"),parentID:v.parentElement.getAttribute("data-node-id")||e.block.parentID},{action:"move",id:t.getAttribute("data-node-id"),parentID:v.getAttribute("data-node-id")}]),v.remove()):transaction(e,[{action:"move",id:t.getAttribute("data-node-id"),previousID:(l=t.previousElementSibling)==null?void 0:l.getAttribute("data-node-id"),parentID:v.parentElement.getAttribute("data-node-id")||e.block.parentID}],[{action:"move",id:t.getAttribute("data-node-id"),parentID:v.getAttribute("data-node-id")}]),focusByWbr(t,n);return}if(t.parentElement.classList.contains("li")&&t.previousElementSibling.classList.contains("protyle-action")){bs(e,t,n,s);return}if(t.previousElementSibling&&t.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;const d=getPreviousBlock(t);if(!d){if(e.wysiwyg.element.childElementCount>1&&getContenteditableElement(t).textContent===""){focusBlock(e.wysiwyg.element.firstElementChild.nextElementSibling);const v=getTopAloneElement(t);transaction(e,[{action:"delete",id:v.getAttribute("data-node-id")}],[{action:"insert",data:v.outerHTML,id:v.getAttribute("data-node-id"),parentID:e.block.parentID}]),v.remove()}return}const g=t.parentElement,p=getContenteditableElement(t),b=getLastBlock(d);if(n.toString()===""&&isMobile()&&b&&b.classList.contains("hr")&&getSelectionOffset(p).start===0){transaction(e,[{action:"delete",id:b.getAttribute("data-node-id")}],[{action:"insert",data:b.outerHTML,id:b.getAttribute("data-node-id"),previousID:(o=b.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"),parentID:b.parentElement.getAttribute("data-node-id")}]),b.remove();return}const m=b&&(b.classList.contains("table")||b.classList.contains("render-node")||b.classList.contains("iframe")||b.classList.contains("hr")||b.classList.contains("av")||b.classList.contains("code-block")),h=b.getAttribute("data-node-id");if(m){if(b.classList.contains("code-block")){if(p.textContent.trim()===""){const v=t.getAttribute("data-node-id"),S=[{action:"delete",id:v}],w=[{action:"insert",data:t.outerHTML,id:v,previousID:(r=t.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:t.parentElement.getAttribute("data-node-id")}];if(t.remove(),g.getAttribute("data-type")==="NodeSuperBlock"&&g.childElementCount===2){const _=cancelSB(e,g);transaction(e,S.concat(_.doOperations),_.undoOperations.concat(w))}else transaction(e,S,w);focusBlock(e.wysiwyg.element.querySelector(`[data-node-id="${h}"]`),void 0,!1)}else focusBlock(b,void 0,!1);return}if(p.textContent!==""||t.classList.contains("av")){focusBlock(b,void 0,!1);return}}const y=getTopEmptyElement(t),k=y.getAttribute("data-node-id");n.insertNode(document.createElement("wbr"));const E=[{action:"update",data:b.outerHTML,id:h},{action:"insert",data:y.outerHTML,id:k,previousID:(c=t.previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:g.getAttribute("data-node-id")}],A=[{action:"delete",id:k}];if(m)y.remove(),focusBlock(b,void 0,!1);else{const v=getContenteditableElement(b);if(p&&p.textContent!==""&&(n.setEndAfter(p.lastChild),(((f=v==null?void 0:v.lastElementChild)==null?void 0:f.getAttribute("data-type"))||"").indexOf("inline-math")>-1)){const _=hasNextSibling(v==null?void 0:v.lastElementChild);_&&_.textContent===`
`&&_.remove()}const S=e.contentElement.scrollTop,w=n.extractContents();n.selectNodeContents(v),n.collapse(!1),n.insertNode(w),y.remove(),e.contentElement.scrollTop=S,e.scroll.lastScrollTop=S-1,A.push({action:"update",data:b.outerHTML,id:h})}if(g.getAttribute("data-type")==="NodeSuperBlock"&&g.childElementCount===2){const v=cancelSB(e,g);transaction(e,A.concat(v.doOperations),v.undoOperations.concat(E))}else transaction(e,A,E);focusByWbr(e.wysiwyg.element,n)},Dn=(e,t,n)=>{if(n){const s=getPreviousBlock(e);if(s){const a=getContenteditableElement(getLastBlock(s));a&&setLastNodeRange(a,t,!1)}}},tr=e=>{const t=new Menu("av-view");if(t.isOpen)return;t.addItem({icon:"iconEdit",label:window.siyuan.languages.rename,click(){var s;(s=document.querySelector(".av__panel"))==null||s.remove(),openMenuPanel({protyle:e.protyle,blockElement:e.blockElement,type:"config",cb:a=>{a.querySelector('.b3-text-field[data-type="name"]').focus()}})}}),t.addItem({icon:"iconSettings",label:window.siyuan.languages.config,click(){var s;(s=document.querySelector(".av__panel"))==null||s.remove(),openMenuPanel({protyle:e.protyle,blockElement:e.blockElement,type:"config"})}}),t.addSeparator(),t.addItem({icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){var s;(s=document.querySelector(".av__panel"))==null||s.remove();const a=Lute.NewNodeID();transaction(e.protyle,[{action:"duplicateAttrViewView",avID:e.blockElement.dataset.avId,previousID:e.element.dataset.id,id:a}],[{action:"removeAttrViewView",avID:e.blockElement.dataset.avId,id:a}])}}),t.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){var s;(s=document.querySelector(".av__panel"))==null||s.remove(),e.blockElement.querySelectorAll(".layout-tab-bar .item").length===1?removeBlock(e.protyle,e.blockElement,getEditorRange(e.blockElement)):transaction(e.protyle,[{action:"removeAttrViewView",avID:e.blockElement.dataset.avId,id:e.element.dataset.id}])}});const n=e.element.getBoundingClientRect();t.open({x:n.left,y:n.bottom})},nr=e=>{const t=e.menuElement.querySelector('.b3-text-field[data-type="name"]');t.addEventListener("blur",()=>{t.value!==t.dataset.value&&(transaction(e.protyle,[{action:"setAttrViewViewName",avID:e.data.id,id:e.data.viewID,data:t.value}],[{action:"setAttrViewViewName",avID:e.data.id,id:e.data.viewID,data:t.dataset.value}]),t.dataset.value=t.value)}),t.select()},ar=e=>`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label ft__center">${window.siyuan.languages.config}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span style="padding: 5px;margin-right: 8px;width: 14px;font-size: 14px;" class="block__icon block__icon--show" data-icon="${e.icon}" data-type="update-view-icon">${e.icon?unicode2Emoji(e.icon):'<svg><use xlink:href="#iconTable"></use></svg>'}</span>
    <span class="b3-menu__label" style="padding: 4px;display: flex;"><input data-type="name" class="b3-text-field fn__block" type="text" value="${e.name}" data-value="${e.name}"></span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="go-properties">
    <svg class="b3-menu__icon"></svg>
    <span class="b3-menu__label">${window.siyuan.languages.attr}</span>
    <span class="b3-menu__accelerator">${e.columns.filter(t=>!t.hidden).length}/${e.columns.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconFilter"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.filter}</span>
    <span class="b3-menu__accelerator">${e.filters.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconSort"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.sort}</span>
    <span class="b3-menu__accelerator">${e.sorts.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="set-page-size" data-size="${e.pageSize}">
    <svg class="b3-menu__icon"></svg>
    <span class="b3-menu__label">${window.siyuan.languages.pageCount}</span>
    <span class="b3-menu__accelerator">${e.pageSize}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="duplicate-view">
    <svg class="b3-menu__icon">
        <use xlink:href="#iconCopy"></use>
    </svg>
    <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
</button>
<button class="b3-menu__item" data-type="delete-view">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`,sr=(e,t)=>{let n="";return e.forEach(s=>{n+=`<button draggable="true" class="b3-menu__item" data-id="${s.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip${s.id===t?" b3-chip--primary":""}">
            ${s.icon?unicode2Emoji(s.icon,"icon",!0):'<svg class="icon"><use xlink:href="#iconTable"></use></svg>'}
            <span class="fn__ellipsis">${s.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="av-view-edit"><use xlink:href="#iconEdit"></use></svg>
</button>`}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="av-add">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
<button class="b3-menu__separator"></button>
${n}
</div>`},ir=(e,t)=>{const n=Lute.NewNodeID(),s=t.getAttribute("data-av-id");transaction(e,[{action:"addAttrViewView",avID:s,id:n}],[{action:"removeAttrViewView",avID:s,id:n}])},or=(e,t)=>{const n=hasClosestBlock(t.target);if(!n)return!1;if(t.shiftKey){const i=hasClosestByClassName(t.target,"av__row");if(i&&!i.classList.contains("av__row--header"))return selectRow(i.querySelector(".av__firstcol"),"toggle"),!0}const s=hasClosestByAttribute(t.target,"data-type","copy");if(s)return writeText(getCellText(hasClosestByClassName(s,"av__cell"))),showMessage(window.siyuan.languages.copied),t.preventDefault(),t.stopPropagation(),!0;if(e.disabled)return!1;let a=t.target;for(;a&&!a.isEqualNode(n);){const i=a.getAttribute("data-type");if(i==="av-header-add"){const l=addCol(e,n),o=a.getBoundingClientRect();return l.open({x:o.left,y:o.bottom,h:o.height}),t.preventDefault(),t.stopPropagation(),!0}else{if(i==="av-header-more")return openMenuPanel({protyle:e,blockElement:n,type:"properties"}),t.preventDefault(),t.stopPropagation(),!0;if(i==="av-add-more"){const l=n.getAttribute("data-av-id"),o=[Lute.NewNodeID()];return transaction(e,[{action:"insertAttrViewBlock",avID:l,srcIDs:o,isDetached:!0}],[{action:"removeAttrViewBlock",srcIDs:o,avID:l}]),insertAttrViewBlockAnimation(e,n,o,void 0,l),t.preventDefault(),t.stopPropagation(),!0}else{if(i==="av-more")return openMenuPanel({protyle:e,blockElement:n,type:"config"}),t.preventDefault(),t.stopPropagation(),!0;if(i==="av-switcher")return openMenuPanel({protyle:e,blockElement:n,type:"switcher"}),t.preventDefault(),t.stopPropagation(),!0;if(i==="av-sort")return openMenuPanel({protyle:e,blockElement:n,type:"sorts"}),t.preventDefault(),t.stopPropagation(),!0;if(i==="av-filter")return openMenuPanel({protyle:e,blockElement:n,type:"filters"}),t.preventDefault(),t.stopPropagation(),!0;if(i==="av-add")return addView(e,n),t.preventDefault(),t.stopPropagation(),!0;if(i==="block-more")return e.toolbar.range=document.createRange(),e.toolbar.range.selectNodeContents(a),focusByRange(e.toolbar.range),hintRef(a.previousElementSibling.textContent.trim(),e,"av"),t.preventDefault(),t.stopPropagation(),!0;if(i==="av-load-more")return n.querySelector(".av__row--footer").style.transform="",n.removeAttribute("data-render"),n.dataset.pageSize=(parseInt(n.dataset.pageSize)+parseInt(n.querySelector('[data-type="set-page-size"]').getAttribute("data-size"))).toString(),avRender(n,e),t.preventDefault(),t.stopPropagation(),!0;if(i==="set-page-size")return setPageSize({target:a,protyle:e,avID:n.getAttribute("data-av-id"),nodeElement:n}),t.preventDefault(),t.stopPropagation(),!0;if(i==="av-add-bottom"){const l=n.getAttribute("data-av-id"),o=[Lute.NewNodeID()],r=n.querySelector(".av__row--util").previousElementSibling.getAttribute("data-id")||"";return transaction(e,[{action:"insertAttrViewBlock",avID:l,previousID:r,srcIDs:o,isDetached:!0}],[{action:"removeAttrViewBlock",srcIDs:o,avID:l}]),insertAttrViewBlockAnimation(e,n,o,r,l),t.preventDefault(),t.stopPropagation(),!0}else{if(a.classList.contains("av__firstcol"))return window.siyuan.menus.menu.remove(),selectRow(a,"toggle"),t.preventDefault(),t.stopPropagation(),!0;if(a.classList.contains("av__celltext--url")){let l=a.textContent.trim();return a.dataset.type==="phone"?l="tel:"+l:a.dataset.type==="email"?l="mailto:"+l:a.classList.contains("b3-chip")&&(l=a.dataset.url),window.open(l),t.preventDefault(),t.stopPropagation(),!0}else{if(a.classList.contains("av__cellassetimg"))return previewImage(a.src),t.preventDefault(),t.stopPropagation(),!0;if(a.classList.contains("av__cell--header"))return showColMenu(e,n,a),t.preventDefault(),t.stopPropagation(),!0;if(a.classList.contains("av__cell")){if(!hasClosestByClassName(a,"av__row--header")){const l=hasClosestByClassName(a,"av__scroll");if(!l||a.querySelector(".av__pulse"))return;const o=hasClosestByClassName(a,"av__row");if(!o)return;const r=getTypeByCellElement(a);r==="updated"||r==="created"||r==="block"&&!a.getAttribute("data-detached")?selectRow(o.querySelector(".av__firstcol"),"toggle"):(l.querySelectorAll(".av__row--select").forEach(c=>{c.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),c.classList.remove("av__row--select")}),updateHeader(o),popTextCell(e,[a]))}return t.preventDefault(),t.stopPropagation(),!0}else{if(a.classList.contains("av__calc"))return openCalcMenu(e,a),t.preventDefault(),t.stopPropagation(),!0;if(a.classList.contains("item")&&a.parentElement.classList.contains("layout-tab-bar"))return a.classList.contains("item--focus")?openViewMenu({protyle:e,blockElement:n,element:a}):(n.removeAttribute("data-render"),avRender(n,e,void 0,a.dataset.id)),t.preventDefault(),t.stopPropagation(),!0}}}}}a=a.parentElement}return!1},lr=(e,t,n)=>{var s;if(t.classList.contains("av__row--header"))return!1;const a=hasClosestBlock(t);if(!a)return!1;a.querySelectorAll(".av__cell--select, .av__cell--active").forEach(o=>{var r;o.classList.remove("av__cell--select","av__cell--active"),(r=o.querySelector(".av__drag-fill"))==null||r.remove()}),t.classList.contains("av__row--select")||(a.querySelectorAll(".av__row--select").forEach(o=>{o.classList.remove("av__row--select")}),a.querySelectorAll(".av__firstcol use").forEach(o=>{o.setAttribute("xlink:href","#iconUncheck")}));const i=new Menu("av-row-menu");if(i.isOpen)return!0;t.classList.add("av__row--select"),t.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck");const l=a.querySelectorAll(".av__row--select:not(.av__row--header)");if(updateHeader(t),e.disabled||i.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){deleteRow(a,e)}}),l.length===1&&!l[0].querySelector('[data-detached="true"]')&&(e.disabled||i.addSeparator(),openEditorTab(e.app,l[0].getAttribute("data-id")),i.addItem({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:copySubMenu(l[0].getAttribute("data-id"))})),!e.disabled){i.addSeparator();const o=[];t.parentElement.querySelectorAll(".av__row--header .av__cell").forEach(r=>{let c=!1;const f=Array.from(a.querySelectorAll(`.av__row--select:not(.av__row--header) .av__cell[data-col-id="${r.dataset.colId}"]`));r.dataset.dtype==="block"&&f.find(d=>{if(!d.dataset.detached)return c=!0,!0});const u=r.getAttribute("data-dtype");if(!c&&!["updated","created"].includes(u)){const d=r.dataset.icon;o.push({iconHTML:d?unicode2Emoji(d,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(u)}"></use></svg>`,label:r.querySelector(".av__celltext").textContent.trim(),click(){popTextCell(e,f)}})}}),i.addItem({icon:"iconAttr",label:window.siyuan.languages.attr,type:"submenu",submenu:o})}return(s=e==null?void 0:e.app)!=null&&s.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-av",detail:{protyle:e,element:a,selectRowElements:l},separatorPosition:"top"}),i.open(n),!0},rr=(e,t)=>{const n=t.getAttribute("data-av-id"),s=t.getAttribute("data-node-id"),a=t.querySelector(".av__title"),i=a.textContent.trim();if(i===a.dataset.title.trim())return;const l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"setAttrViewName",id:n,data:i},{action:"doUpdateUpdated",id:s,data:l}],[{action:"setAttrViewName",id:n,data:a.dataset.title},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),t.setAttribute("updated",l),a.dataset.title=i,Array.from(e.wysiwyg.element.querySelectorAll(`[data-av-id="${n}"]`)).forEach(o=>{if(t.isSameNode(o))return;const r=o.querySelector(".av__title");r&&(r.textContent=i,r.dataset.title=i)})},cr=(e,t,n)=>{n?updateHeaderCell(e,n):e.innerHTML=renderCell(t)},dr=(e,t)=>{e.querySelectorAll(`.av__cell[data-col-id="${t}"]`).forEach(n=>{n.remove()})},Qt=(e,t)=>{let n="",s=!1;if(t&&t.forEach(a=>{(!e||e.toLowerCase().indexOf(a.name.toLowerCase())>-1||a.name.toLowerCase().indexOf(e.toLowerCase())>-1)&&(n+=`<button data-type="addColOptionOrCell" class="b3-menu__item${n?"":" b3-menu__item--current"}" draggable="true" data-name="${a.name}" data-color="${a.color}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip" style="background-color:var(--b3-font-background${a.color});color:var(--b3-font-color${a.color})">
            <span class="fn__ellipsis">${a.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
</button>`),e===a.name&&(s=!0)}),!s&&e){const a=((t==null?void 0:t.length)||0)%13+1;n=`<button data-type="addColOptionOrCell" class="b3-menu__item${n?"":" b3-menu__item--current"}" data-name="${e}" data-color="${a}">
<svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
<div class="fn__flex-1">
    <span class="b3-chip" style="background-color:var(--b3-font-background${a});color:var(--b3-font-color${a})">
        <span class="fn__ellipsis">${e}</span>
    </span>
</div>
<span class="b3-menu__accelerator">Enter</span>
</button>${n}`}return n},ys=(e,t,n,s,a)=>{if(!s)return;const i=n[0].dataset.colId,l=[],o=[];let r;n.forEach((c,f)=>{var u;a.contains(c)||(c=n[f]=a.querySelector(`.av__cell[data-id="${c.dataset.id}"]`));const d=hasClosestByClassName(c,"av__row").dataset.id,g=genCellValueByElement(getTypeByCellElement(c)||c.dataset.type,c),p=JSON.parse(JSON.stringify(g));f===0?((u=g.mSelect)==null||u.find((b,m)=>{if(b.content===s.dataset.content)return g.mSelect.splice(m,1),!0}),r=g.mSelect):g.mSelect=r,l.push({action:"updateAttrViewCell",id:g.id,keyID:i,rowID:d,avID:t.id,data:g}),o.push({action:"updateAttrViewCell",id:g.id,keyID:i,rowID:d,avID:t.id,data:p}),t.view.rows.find(b=>{if(b.id===d)return b.cells.find(m=>{if(m.id===g.id)return m.value=g,!0}),!0}),c.classList.contains("custom-attr__avvalue")?c.innerHTML=genAVValueHTML(g):updateAttrViewCellAnimation(c,g)}),transaction(e,l,o),s.remove()},ur=(e,t,n,s,a,i)=>{const l=hasClosestByClassName(n,"b3-menu");if(!l)return;const o=i?i[0].dataset.colId:l.querySelector(".b3-menu__item").getAttribute("data-col-id");let r=n.parentElement.dataset.name,c=n.parentElement.dataset.color;const f=new Menu("av-col-option",()=>{if(r===d.value||!d.value)return;let g=!1;t.view.columns.find(p=>{if(p.id===o)return p.options.find(b=>{if(b.name===d.value)return g=!0,!0}),!0}),!g&&(transaction(e,[{action:"updateAttrViewColOption",id:o,avID:t.id,data:{newColor:c,oldName:r,newName:d.value}}],[{action:"updateAttrViewColOption",id:o,avID:t.id,data:{newColor:c,oldName:d.value,newName:r}}]),t.view.columns.find(p=>{if(p.id===o)return p.options.find(b=>{if(b.name===r)return b.name=d.value,!0}),!0}),i?(i.forEach(p=>{t.view.rows.find(b=>{if(b.id===hasClosestByClassName(p,"av__row").dataset.id)return b.cells.find(m=>{if(m.id===p.dataset.id)return m.value.mSelect.find(h=>{if(h.content===r)return h.content=d.value,!0}),p.classList.contains("custom-attr__avvalue")?p.innerHTML=genAVValueHTML(m.value):updateAttrViewCellAnimation(p,m.value),!0}),!0})}),l.innerHTML=xt(t.view,i),St(e,t,l,i,s)):(l.innerHTML=getEditHTML({protyle:e,data:t,colId:o,isCustomAttr:a}),bindEditEvent({protyle:e,data:t,menuElement:l,isCustomAttr:a})))});if(f.isOpen)return;f.addItem({iconHTML:"",label:`<input class="b3-text-field" style="margin: 4px 0" value="${r}">`,bind(g){g.querySelector("input").addEventListener("keydown",p=>{p.isComposing||p.key==="Enter"&&f.close()})}}),f.addItem({label:window.siyuan.languages.delete,icon:"iconTrashcan",click(){confirmDialog(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.confirmDelete,()=>{let g=[];t.view.columns.find(b=>{if(b.id===o)return g=b.options,!0});const p=n.parentElement.dataset.name;transaction(e,[{action:"removeAttrViewColOption",id:o,avID:t.id,data:p}],[{action:"updateAttrViewColOptions",id:o,avID:t.id,data:g}]),g.find((b,m)=>{if(b.name===p)return g.splice(m,1),!0}),i?(i.forEach(b=>{t.view.rows.find(m=>{if(m.id===hasClosestByClassName(b,"av__row").dataset.id)return m.cells.find(h=>{if(h.id===b.dataset.id)return h.value.mSelect.find((y,k)=>{if(y.content===p)return h.value.mSelect.splice(k,1),!0}),b.classList.contains("custom-attr__avvalue")?b.innerHTML=genAVValueHTML(h.value):updateAttrViewCellAnimation(b,h.value),!0}),!0})}),l.innerHTML=xt(t.view,i),St(e,t,l,i,s)):(l.innerHTML=getEditHTML({protyle:e,data:t,colId:o,isCustomAttr:a}),bindEditEvent({protyle:e,data:t,menuElement:l,isCustomAttr:a}))})}}),f.addSeparator(),Array.from(Array(13).keys()).forEach(g=>{f.addItem({accelerator:parseInt(c)===g+1?'<svg class="svg" style="height: 30px; float: left;"><use xlink:href="#iconSelect"></use></svg>':void 0,iconHTML:"",label:`<span class="color__square"  style="padding: 5px;margin: 2px;color: var(--b3-font-color${g+1});background-color: var(--b3-font-background${g+1});">A</span>`,click(p){var b;if(!p.lastElementChild.classList.contains("b3-menu__accelerator"))return(b=p.parentElement.querySelector(".b3-menu__accelerator"))==null||b.remove(),p.insertAdjacentHTML("beforeend",'<span class="b3-menu__accelerator"><svg class="svg" style="height: 30px; float: left;"><use xlink:href="#iconSelect"></use></svg></span>'),transaction(e,[{action:"updateAttrViewColOption",id:o,avID:t.id,data:{oldName:r,newName:d.value,oldColor:c,newColor:(g+1).toString()}}],[{action:"updateAttrViewColOption",id:o,avID:t.id,data:{oldName:d.value,newName:r,oldColor:(g+1).toString(),newColor:c}}]),t.view.columns.find(m=>{if(m.id===o)return m.options.find(h=>{if(h.name===r)return h.name=d.value,h.color=(g+1).toString(),!0}),!0}),i?(i.forEach(m=>{t.view.rows.find(h=>{if(h.id===hasClosestByClassName(m,"av__row").dataset.id)return h.cells.find(y=>{if(y.id===m.dataset.id)return y.value.mSelect.find(k=>{if(k.content===r)return k.content=d.value,k.color=(g+1).toString(),!0}),m.classList.contains("custom-attr__avvalue")?m.innerHTML=genAVValueHTML(y.value):updateAttrViewCellAnimation(m,y.value),!0}),!0})}),l.innerHTML=xt(t.view,i),St(e,t,l,i,s)):(l.innerHTML=getEditHTML({protyle:e,data:t,colId:o,isCustomAttr:a}),bindEditEvent({protyle:e,data:t,menuElement:l,isCustomAttr:a})),r=d.value,c=(g+1).toString(),!0}})});const u=n.getBoundingClientRect();f.open({x:u.right,y:u.bottom,w:u.width,h:u.height});const d=window.siyuan.menus.menu.element.querySelector("input");d.select()},St=(e,t,n,s,a)=>{const i=n.querySelector("input"),l=s[0].dataset.colId;let o;t.view.columns.find(c=>{if(c.id===l){o=c;return}}),o.options||(o.options=[]);const r=n.lastElementChild.lastElementChild;i.addEventListener("input",c=>{c.isComposing||(r.innerHTML=Qt(i.value,o.options))}),i.addEventListener("compositionend",c=>{c.isComposing||(r.innerHTML=Qt(i.value,o.options))}),i.addEventListener("keydown",c=>{if(c.isComposing)return;let f=upDownHint(r,c,"b3-menu__item--current");c.key==="Enter"?(f||(f=n.querySelector(".b3-menu__item--current")),ws(e,t,s,f,n,a)):c.key==="Backspace"&&i.value===""&&ys(e,t,s,i.previousElementSibling,a)})},ws=(e,t,n,s,a,i)=>{let l=!1;if(Array.from(a.querySelectorAll(".b3-chips .b3-chip")).find(g=>{if(g.dataset.content===s.dataset.name)return l=!0,!0}),l){a.querySelector("input").focus();return}hasClosestBlock(n[0])||n.forEach((g,p)=>{const b=hasClosestByClassName(g,"av__row");b&&(n[p]=i.querySelector(`.av__row[data-id="${b.dataset.id}"] .av__cell[data-col-id="${g.dataset.colId}"]`))});const r=n[0].dataset.colId;let c;t.view.columns.find(g=>{if(g.id===r){c=g,c.options||(c.options=[]);return}});const f=[],u=[];let d;n.forEach((g,p)=>{const b=hasClosestByClassName(g,"av__row");if(!b)return;const m=genCellValueByElement(c.type,g),h=JSON.parse(JSON.stringify(m));if(p===0){if(c.type==="mSelect"){let k=!1;m.mSelect.find(E=>{if(E.content===s.dataset.name)return k=!0,!0}),k||m.mSelect.push({color:s.dataset.color,content:s.dataset.name})}else m.mSelect=[{color:s.dataset.color,content:s.dataset.name}];d=m.mSelect}else m.mSelect=d;const y=b.dataset.id;f.push({action:"updateAttrViewCell",id:m.id,keyID:r,rowID:y,avID:t.id,data:m}),u.push({action:"updateAttrViewCell",id:m.id,keyID:r,rowID:y,avID:t.id,data:h}),t.view.rows.find(k=>{if(k.id===y)return k.cells.find(E=>{if(E.id===m.id)return E.value=m,!0}),!0}),g.classList.contains("custom-attr__avvalue")?g.innerHTML=genAVValueHTML(m):updateAttrViewCellAnimation(g,m)}),s.querySelector(".b3-menu__accelerator")?(c.options.push({color:s.dataset.color,name:s.dataset.name}),f.splice(0,0,{action:"updateAttrViewColOptions",id:r,avID:t.id,data:c.options}),transaction(e,f,[{action:"removeAttrViewColOption",id:r,avID:t.id,data:s.dataset.name}])):transaction(e,f,u),c.type==="select"?a.parentElement.remove():(a.innerHTML=xt(t.view,n),St(e,t,a,n,i),a.querySelector("input").focus())},xt=(e,t)=>{var n;const s=t[0].dataset.colId,a=e.columns.find(l=>{if(l.id===s)return l});let i="";return(n=genCellValueByElement(a.type,t[0]).mSelect)==null||n.forEach(l=>{i+=`<div class="b3-chip b3-chip--middle" data-content="${escapeAttr(l.content)}" style="background-color:var(--b3-font-background${l.color});color:var(--b3-font-color${l.color})">${l.content}<svg class="b3-chip__close" data-type="removeCellOption"><use xlink:href="#iconCloseRound"></use></svg></div>`}),`<div class="b3-menu__items">
<div class="b3-chips">
    ${i}
    <input>
</div>
<div>${Qt("",a.options)}</div>
</div>`},fr=e=>{const t=new Menu("av-add-sort");e.data.view.columns.forEach(n=>{let s=!1;e.data.view.sorts.find(a=>{if(a.column===n.id)return s=!0,!0}),s||t.addItem({label:n.name,iconHTML:n.icon?unicode2Emoji(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(n.type)}"></use></svg>`,click:()=>{const a=Object.assign([],e.data.view.sorts);e.data.view.sorts.push({column:n.id,order:"ASC"}),transaction(e.protyle,[{action:"setAttrViewSorts",avID:e.data.id,data:e.data.view.sorts}],[{action:"setAttrViewSorts",avID:e.data.id,data:a}]),e.menuElement.innerHTML=vs(e.data.view.columns,e.data.view.sorts),_s(e.protyle,e.menuElement,e.data),setPosition(e.menuElement,e.tabRect.right-e.menuElement.clientWidth,e.tabRect.bottom,e.tabRect.height)}})}),t.open({x:e.rect.left,y:e.rect.bottom,h:e.rect.height})},_s=(e,t,n)=>{t.querySelectorAll("select").forEach(s=>{s.addEventListener("change",()=>{const a=s.parentElement.getAttribute("data-id"),i=JSON.parse(JSON.stringify(n.view.sorts));s.previousElementSibling.classList.contains("b3-menu__icon")?n.view.sorts.find(l=>{if(l.column===a)return l.column=s.value,s.parentElement.setAttribute("data-id",s.value),!0}):n.view.sorts.find(l=>l.column===a).order=s.value,transaction(e,[{action:"setAttrViewSorts",avID:n.id,data:n.view.sorts}],[{action:"setAttrViewSorts",avID:n.id,data:i}])})})},vs=(e,t)=>{let n="";const s=a=>{let i="";return e.forEach(l=>{i+=`<option value="${l.id}" ${l.id===a?"selected":""}>${l.icon&&unicode2Emoji(l.icon)}${l.name}</option>`}),i};return t.forEach(a=>{n+=`<button draggable="true" class="b3-menu__item" data-id="${a.column}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <select class="b3-select" style="margin: 4px 0">
        ${s(a.column)}
    </select>
    <span class="fn__space"></span>
    <select class="b3-select" style="margin: 4px 0">
        <option value="ASC" ${a.order==="ASC"?"selected":""}>${window.siyuan.languages.asc}</option>
        <option value="DESC" ${a.order==="DESC"?"selected":""}>${window.siyuan.languages.desc}</option>
    </select>
    <svg class="b3-menu__action" data-type="removeSort"><use xlink:href="#iconTrashcan"></use></svg>
</button>`}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.sort}</span>
</button>
<button class="b3-menu__separator"></button>
${n}
<button class="b3-menu__item${t.length===e.length?" fn__none":""}" data-type="addSort">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
<button class="b3-menu__item${n?"":" fn__none"}" data-type="removeSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},gr=(e,t)=>{var n,s,a,i,l,o;let r=!0,c;t.forEach(g=>{e.rows.find(p=>{if(hasClosestByClassName(g,"av__row").dataset.id===p.id)return p.cells.find(b=>{if(b.id===g.dataset.id)return(!b.value||!b.value.date||!b.value.date.hasEndDate)&&(r=!1),c=b,!0}),!0})}),c||(r=!1);const f=!c||((s=(n=c==null?void 0:c.value)==null?void 0:n.date)==null?void 0:s.isNotTime);let u="";(i=(a=c==null?void 0:c.value)==null?void 0:a.date)!=null&&i.isNotEmpty&&(u=dayjs(c.value.date.content).format(f?"YYYY-MM-DD":"YYYY-MM-DD HH:mm"));let d="";return(o=(l=c==null?void 0:c.value)==null?void 0:l.date)!=null&&o.isNotEmpty2&&(d=dayjs(c.value.date.content2).format(f?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),`<div class="b3-menu__items">
<div>
    <input type="${f?"date":"datetime-local"}" max="${f?"9999-12-31":"9999-12-31 23:59"}" value="${u}" data-value="${u?dayjs(c.value.date.content).format("YYYY-MM-DD HH:mm"):""}" class="b3-text-field fn__size200" style="margin-top: 4px;"><br>
    <input type="${f?"date":"datetime-local"}" max="${f?"9999-12-31":"9999-12-31 23:59"}" value="${d}" data-value="${d?dayjs(c.value.date.content2).format("YYYY-MM-DD HH:mm"):""}" style="margin-top: 8px;margin-bottom: 4px" class="b3-text-field fn__size200${r?"":" fn__none"}">
    <button class="b3-menu__separator"></button>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.endDate}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch b3-switch--menu"${r?" checked":""}>
    </label>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.includeTime}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch b3-switch--menu"${f?"":" checked"}>
    </label>
    <button class="b3-menu__separator"></button>
    <button class="b3-menu__item" data-type="clearDate">
        <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.clear}</span>
    </button>
</div>
</div>`},pr=e=>{const t=e.menuElement.querySelectorAll("input");t[0].addEventListener("change",()=>{t[0].dataset.value=t[0].value.length>10?t[0].value:t[0].value+" 00:00",updateCellsValue(e.protyle,e.blockElement,{content:new Date(t[0].dataset.value).getTime(),isNotEmpty:t[0].value!=="",content2:new Date(t[1].dataset.value).getTime(),isNotEmpty2:t[1].value!=="",hasEndDate:t[2].checked,isNotTime:!t[3].checked},e.cellElements)}),t[1].addEventListener("change",()=>{t[1].dataset.value=t[1].value.length>10?t[1].value:t[1].value+" 00:00",updateCellsValue(e.protyle,e.blockElement,{content:new Date(t[0].dataset.value).getTime(),isNotEmpty:t[0].value!=="",content2:new Date(t[1].dataset.value).getTime(),isNotEmpty2:t[1].value!=="",hasEndDate:t[2].checked,isNotTime:!t[3].checked},e.cellElements)}),t[2].addEventListener("change",()=>{t[2].checked?t[1].classList.remove("fn__none"):t[1].classList.add("fn__none"),updateCellsValue(e.protyle,e.blockElement,{content:new Date(t[0].dataset.value).getTime(),isNotEmpty:t[0].value!=="",content2:new Date(t[1].dataset.value).getTime(),isNotEmpty2:t[1].value!=="",hasEndDate:t[2].checked,isNotTime:!t[3].checked},e.cellElements)}),t[3].addEventListener("change",()=>{t[3].checked?(t[0].setAttribute("type","datetime-local"),t[1].setAttribute("type","datetime-local"),t[0].setAttribute("max","9999-12-31 23:59"),t[1].setAttribute("max","9999-12-31 23:59"),t[0].value=t[0].dataset.value,t[1].value=t[1].dataset.value):(t[0].setAttribute("type","date"),t[1].setAttribute("type","date"),t[0].setAttribute("max","9999-12-31"),t[1].setAttribute("max","9999-12-31"),t[0].value=t[0].dataset.value.substring(0,10),t[1].value=t[1].dataset.value.substring(0,10)),updateCellsValue(e.protyle,e.blockElement,{content:new Date(t[0].dataset.value).getTime(),isNotEmpty:t[0].value!=="",content2:new Date(t[1].dataset.value).getTime(),isNotEmpty2:t[1].value!=="",hasEndDate:t[2].checked,isNotTime:!t[3].checked},e.cellElements)})},Le=e=>{e.menu.addItem({iconHTML:"",label:Es(e.format),click(){transaction(e.protyle,[{action:"updateAttrViewColNumberFormat",id:e.colId,avID:e.avID,format:e.format,type:"number"}],[{action:"updateAttrViewColNumberFormat",id:e.colId,avID:e.avID,format:e.oldFormat,type:"number"}]),e.avPanelElement.remove()}})},mr=e=>{const t=new Menu("av-col-format-number");Le({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Le({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"commas",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Le({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"percent",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Le({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"usDollar",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Le({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"yuan",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Le({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"euro",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Le({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"pound",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Le({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"yen",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Le({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"ruble",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Le({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"rupee",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Le({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"won",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Le({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"canadianDollar",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Le({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"franc",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement});const n=e.element.getBoundingClientRect();t.open({x:n.left,y:n.bottom,h:n.height,w:n.width,isLeft:!0})},Es=e=>{switch(e){case"":return window.siyuan.languages.numberFormatNone;case"commas":return window.siyuan.languages.numberFormatCommas;case"percent":return window.siyuan.languages.numberFormatPercent;case"usDollar":return window.siyuan.languages.numberFormatUSDollar;case"yuan":return window.siyuan.languages.numberFormatYuan;case"euro":return window.siyuan.languages.numberFormatEuro;case"pound":return window.siyuan.languages.numberFormatPound;case"yen":return window.siyuan.languages.numberFormatYen;case"ruble":return window.siyuan.languages.numberFormatRuble;case"rupee":return window.siyuan.languages.numberFormatRupee;case"won":return window.siyuan.languages.numberFormatWon;case"canadianDollar":return window.siyuan.languages.numberFormatCanadianDollar;case"franc":return window.siyuan.languages.numberFormatFranc}},br=(e,t,n,s,a)=>{if(t!=="NodeCodeBlock"&&n.parentElement.getAttribute("data-subtype")!=="t"&&(["[ ]","[x]","[X]","\u3010 \u3011","\u3010x\u3011","\u3010X\u3011"].includes(s.innerHTML.substring(0,3))||["[]","\u3010\u3011"].includes(s.innerHTML.substring(0,2)))){const i=s.innerHTML.indexOf("]")+1||s.innerHTML.indexOf("\u3011")+1,l=s.innerHTML.substring(1,2).toLowerCase()==="x";if(n.parentElement.classList.contains("li")&&n.parentElement.childElementCount===3){if(!n.parentElement.parentElement.classList.contains("protyle-wysiwyg")&&n.parentElement.parentElement.childElementCount===2){const o=n.parentElement.parentElement,r=o.outerHTML;return o.setAttribute("data-subtype","t"),o.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),n.parentElement.setAttribute("data-subtype","t"),l&&n.parentElement.classList.add("protyle-task--done"),n.previousElementSibling.outerHTML=`<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${l?"C":"Unc"}heck"></use></svg></div>`,s.innerHTML=s.innerHTML.substring(i),updateTransaction(e,o.getAttribute("data-node-id"),o.outerHTML,r),focusByWbr(e.wysiwyg.element,a),!0}return!1}else{const o=n.getAttribute("data-node-id"),r=Lute.NewNodeID(),c=Lute.NewNodeID(),f=Lute.NewNodeID(),u=n.outerHTML;return s.innerHTML=s.innerHTML.substring(i),transaction(e,[{action:"update",id:o,data:n.outerHTML},{action:"insert",id:r,data:`<div data-subtype="t" data-node-id="${r}" updated="${r.split("-")[0]}" data-type="NodeList" class="list"><div data-marker="*" data-subtype="t" data-node-id="${f}" data-type="NodeListItem" class="li${l?" protyle-task--done":""}" updated="${f.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${l?"C":"Unc"}heck"></use></svg></div><div data-node-id="${c}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:o},{action:"move",id:o,previousID:c},{action:"delete",id:c}],[{action:"update",id:o,data:u},{action:"move",id:o,previousID:r},{action:"delete",id:r}]),n.outerHTML=`<div data-subtype="t" data-node-id="${r}" data-type="NodeList" class="list" updated="${r.split("-")[0]}"><div data-marker="*" data-subtype="t" data-node-id="${f}" data-type="NodeListItem" class="li${l?" protyle-task--done":""}" updated="${f.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${l?"C":"Unc"}heck"></use></svg></div>${n.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,focusByWbr(e.wysiwyg.element,a),!0}}return!1},hr=(e,t,n,s,a)=>{if(t==="NodeHeading"&&["* ","- "].includes(s.innerHTML.substring(0,2))&&n.parentElement.getAttribute("data-type")!=="NodeListItem"){const i=n.getAttribute("data-node-id"),l=Lute.NewNodeID(),o=Lute.NewNodeID(),r=Lute.NewNodeID(),c=n.outerHTML,f=s.innerHTML.substring(0,1);return s.innerHTML=s.innerHTML.substring(2),transaction(e,[{action:"update",id:i,data:n.outerHTML},{action:"insert",id:l,data:`<div data-subtype="u" data-node-id="${l}" data-type="NodeList" class="list" updated="${l.split("-")[0]}"><div data-marker="${f}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div data-node-id="${o}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:i},{action:"move",id:i,previousID:o},{action:"delete",id:o}],[{action:"update",id:i,data:c},{action:"move",id:i,previousID:l},{action:"delete",id:l}]),n.outerHTML=`<div data-subtype="u" data-node-id="${l}" data-type="NodeList" class="list" updated="${l.split("-")[0]}"><div data-marker="${f}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${n.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,focusByWbr(e.wysiwyg.element,a),!0}return!1};var ks=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const yr=(e,t,n,s=!0)=>ks(void 0,null,function*(){var a,i,l,o;if(!t.parentElement)return;if(t.classList.contains("av")){updateAVName(e,t);return}const r=getContenteditableElement(t),c=t.getAttribute("data-type");if(!r){c==="NodeThematicBreak"?t.innerHTML="<div><wbr></div>":c==="NodeBlockQueryEmbed"?t.lastElementChild.previousElementSibling.innerHTML="<wbr>"+Constants.ZWSP:c==="NodeMathBlock"||c==="NodeHTMLBlock"?t.lastElementChild.previousElementSibling.lastElementChild.innerHTML="<wbr>"+Constants.ZWSP:c==="NodeIFrame"||c==="NodeWidget"?t.innerHTML="<wbr>"+t.firstElementChild.outerHTML+t.lastElementChild.outerHTML:c==="NodeVideo"?t.firstElementChild.innerHTML="<wbr>"+Constants.ZWSP+t.firstElementChild.firstElementChild.outerHTML+t.firstElementChild.lastElementChild.outerHTML:c==="NodeAudio"?t.firstElementChild.innerHTML=t.firstElementChild.firstElementChild.outerHTML+"<wbr>"+Constants.ZWSP:c==="NodeCodeBlock"&&(n.startContainer.textContent=Constants.ZWSP),focusByWbr(t,n);return}t.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss"));const f=document.createElement("wbr");n.insertNode(f);const u=t.getAttribute("data-node-id");if(c!=="NodeCodeBlock"&&(r.innerHTML.endsWith(`
<wbr>`)||r.innerHTML.endsWith(`
<wbr>
`))){updateTransaction(e,u,t.outerHTML,e.wysiwyg.lastHTMLs[u]||t.outerHTML.replace(`
<wbr>`,"<wbr>")),f.remove();return}if(turnIntoTaskList(e,c,t,r,n)||headingTurnIntoList(e,c,t,r,n))return;const d=t.querySelector("br");d&&d.parentElement.tagName!=="TD"&&d.parentElement.tagName!=="TH"&&(d.parentElement.textContent.trim()===""||((i=(a=d.previousSibling)==null?void 0:a.previousSibling)==null?void 0:i.textContent)===`
`)&&d.remove(),(r.innerHTML==="\u300B<wbr>"||r.innerHTML.indexOf(`
\u300B<wbr>`)>-1)&&(r.innerHTML=r.innerHTML.replace("\u300B<wbr>","><wbr>"));const g=r.innerHTML.trimStart();if(!((g.startsWith("````")||g.startsWith("\xB7\xB7\xB7\xB7")||g.startsWith("~~~~"))&&g.indexOf(`
`)===-1)){if((g.startsWith("```")||g.startsWith("\xB7\xB7\xB7")||g.startsWith("~~~"))&&g.indexOf(`
`)===-1&&g.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")===-1){updateTransaction(e,u,t.outerHTML,e.wysiwyg.lastHTMLs[u]),f.remove();return}}(g==="\xA5\xA5<wbr>"||g==="\uFFE5\uFFE5<wbr>")&&(r.innerHTML="$$<wbr>");const p=hasClosestByAttribute(n.startContainer,"data-type","block-ref");p&&p.getAttribute("data-subtype")==="d"&&(yield fetchSyncPost("/api/block/getRefText",{id:p.getAttribute("data-id")})).data!==p.innerHTML.replace("<wbr>","")&&p.setAttribute("data-subtype","s");let b=t.outerHTML,m=!1;if(r.textContent==="---"&&c!=="NodeCodeBlock"){b=`<div data-node-id="${u}" data-type="NodeThematicBreak" class="hr"><div></div></div>`;const y=getNextBlock(r);y?isNotEditBlock(y)?m=!0:focusBlock(y):b+=genEmptyBlock(!1,!0)}else{if(c!=="NodeCodeBlock"&&(g.startsWith("```")||g.startsWith("~~~")||g.startsWith("\xB7\xB7\xB7")||g.indexOf("\n```")>-1||g.indexOf(`
~~~`)>-1||g.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(g.indexOf(`
`)===-1&&g.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let y=r.innerHTML.replace(/^(~|·|`){3,}/g,"```").replace(/\n(~|·|`){3,}/g,"\n```").trim();y.endsWith("\n```")||(y=y.replace("<wbr>","")+"<wbr>\n```"),r.innerHTML=y,b=t.outerHTML}b=e.lute.SpinBlockDOM(b)}hideElements(["util"],e,!0);const h=document.createElement("template");if(h.innerHTML=b,s&&(((l=getContenteditableElement(h.content.firstElementChild))==null?void 0:l.innerHTML)!==getContenteditableElement(t).innerHTML||h.content.childElementCount===1&&((o=getContenteditableElement(h.content.firstElementChild))==null?void 0:o.innerHTML)==="<wbr>")&&!(h.content.childElementCount===1&&h.content.firstElementChild.classList.contains("code-block")&&c==="NodeCodeBlock")){log("SpinBlockDOM",t.outerHTML,"argument",e.options.debugger),log("SpinBlockDOM",b,"result",e.options.debugger);let y;t.classList.contains("table")&&(y=getContenteditableElement(t).scrollLeft),/<span data-type="backslash">.<\/span><wbr>/.test(b)?t.outerHTML=b:t.outerHTML=b.replace("</span><wbr>","</span>"+Constants.ZWSP+"<wbr>"),e.wysiwyg.element.querySelectorAll(`[data-node-id="${u}"]`).forEach(k=>{(k.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(k,"data-type","NodeBlockQueryEmbed"))&&(t=k)}),b.split('<span data-type="inline-math" data-subtype="math"').length>1&&Array.from(t.querySelectorAll('[data-type="inline-math"]')).find(k=>{if(k.dataset.content.indexOf("<wbr>")>-1)return k.setAttribute("data-content",k.dataset.content.replace("<wbr>","")),e.toolbar.showRender(e,k),!0}),Array.from(h.content.children).forEach((k,E)=>{const A=k.getAttribute("data-node-id");let v;A===u?v=t:v=e.wysiwyg.element.querySelector(`[data-node-id="${A}"]`);const S=v.getAttribute("data-type");if(S==="NodeCodeBlock"){const w=v.querySelector(".protyle-action__language");w?(window.siyuan.storage[Constants.LOCAL_CODELANG]&&w.textContent===""&&(w.textContent=window.siyuan.storage[Constants.LOCAL_CODELANG]),highlightRender(v)):h.content.childElementCount===1&&e.toolbar.showRender(e,v)}else["NodeMathBlock","NodeHTMLBlock"].includes(S)?(S==="NodeMathBlock"&&mathRender(v),e.toolbar.showRender(e,v)):S==="NodeBlockQueryEmbed"?(blockRender(e,v),e.toolbar.showRender(e,v),hideElements(["hint"],e)):S==="NodeThematicBreak"&&m?focusBlock(t):(v.querySelectorAll('[data-type="block-ref"][data-subtype="d"]').forEach(w=>{w.textContent===""&&fetchPost("/api/block/getRefText",{id:w.getAttribute("data-id")},_=>{w.innerHTML=_.data})}),mathRender(v),E===h.content.childElementCount-1&&(focusByWbr(e.wysiwyg.element,n),e.hint.render(e),y>0&&(getContenteditableElement(v).scrollLeft=y)))})}else t.getAttribute("data-type")==="NodeCodeBlock"?(r.removeAttribute("data-render"),highlightRender(t)):(focusByWbr(e.wysiwyg.element,n),e.hint.render(e));hideElements(["gutter"],e),Cs(b,e,u)}),Cs=(e,t,n)=>{const s=document.createElement("template");s.innerHTML=e;const a=[],i=[];Array.from(s.content.children).forEach((l,o)=>{var r;l.getAttribute("spellcheck")==="false"&&l.getAttribute("contenteditable")==="false"&&l.setAttribute("contenteditable","true");const c=l.getAttribute("data-node-id");if(c===n)a.push({id:n,data:l.outerHTML,action:"update"}),i.push({id:n,data:t.wysiwyg.lastHTMLs[n],action:"update"});else{let f;o===0&&(f=t.wysiwyg.element.querySelector(`[data-node-id="${c}"]`)),a.push({action:"insert",data:l.outerHTML,id:c,previousID:o===0?(r=f==null?void 0:f.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"):l.previousElementSibling.getAttribute("data-node-id"),parentID:(f==null?void 0:f.parentElement.getAttribute("data-node-id"))||t.block.parentID}),i.push({id:c,action:"delete"})}}),transaction(t,a,i)},As=(e,t,n,s)=>{const a=n.lute.BlockDOM2EscapeMarkerContent(t),i=Array.from(s.querySelectorAll(".av__cell--select"));s.querySelector(".av__row--select")?updateCellsValue(n,s,a):i.length>0?updateCellsValue(n,s,a,i):(e.insertNode(document.createTextNode(a)),e.collapse(!1),updateAVName(n,s))},wr=(e,t,n=!1,s=!1)=>{var a,i,l;if(e==="")return;const o=s?t.toolbar.range:getEditorRange(t.wysiwyg.element);fixTableRange(o);let r;hasClosestByAttribute(o.startContainer,"data-type","NodeTable")&&!n&&(hasClosestByMatchTag(o.startContainer,"TABLE")?r=t.lute.BlockDOM2InlineBlockDOM(e):n=!0);let c=hasClosestBlock(o.startContainer);if(c||(t.toolbar.range?c=hasClosestBlock(t.toolbar.range.startContainer):c=t.wysiwyg.element.firstElementChild),!c)return;if(c.classList.contains("av")){o.deleteContents(),As(o,e,t,c);return}let f=c.getAttribute("data-node-id");o.insertNode(document.createElement("wbr"));let u=c.outerHTML;const d=c.getAttribute("data-type")==="NodeCodeBlock";if(!n&&(d||t.toolbar.getCurrentType(o).includes("code"))){o.deleteContents(),o.insertNode(document.createTextNode(e.replace(/\r\n|\r|\u2028|\u2029/g,`
`))),o.collapse(!1),o.insertNode(document.createElement("wbr")),d?(getContenteditableElement(c).removeAttribute("data-render"),highlightRender(c)):focusByWbr(c,o),c.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,f,c.outerHTML,u),setTimeout(()=>{scrollCenter(t,c,!1,"smooth")},Constants.TIMEOUT_LOAD);return}const g=[],p=[];if(o.toString()!==""){const E=hasClosestByAttribute(o.commonAncestorContainer,"data-type","inline-math");E?E.remove():(o.startContainer.nodeType===3&&((a=o.startContainer.parentElement.getAttribute("data-type"))==null?void 0:a.indexOf("block-ref"))>-1&&o.startContainer.parentElement.remove(),o.deleteContents()),o.insertNode(document.createElement("wbr")),g.push({action:"update",id:f,data:u}),p.push({action:"update",id:f,data:c.outerHTML})}const b=document.createElement("template");b.innerHTML=r||t.lute.SpinBlockDOM(e)||e;const m=getContenteditableElement(c);if(!n&&(b.content.firstChild.nodeType===3||b.content.firstChild.nodeType!==3&&(b.content.firstElementChild.classList.contains("p")&&b.content.childElementCount===1||b.content.firstElementChild.tagName!=="DIV"))){b.content.firstChild.nodeType!==3&&b.content.firstElementChild.classList.contains("p")&&(b.innerHTML=b.content.firstElementChild.firstElementChild.innerHTML.trim());const E=o.startContainer.nodeType===3?o.startContainer.parentElement:o.startContainer;if(E.tagName==="SPAN"&&E.isSameNode(o.endContainer.nodeType===3?o.endContainer.parentElement:o.endContainer)&&b.content.querySelector("span, img")){const A=document.createElement("span"),v=E.attributes;for(let S=0;S<v.length;S++)A.setAttribute(v[S].name,v[S].value);o.setEnd(E.lastChild,E.lastChild.textContent.length),A.append(o.extractContents()),E.after(A),o.setStartBefore(A),o.collapse(!0)}o.insertNode(b.content.cloneNode(!0)),o.collapse(!1),(i=c.querySelector("wbr"))==null||i.remove(),input(t,c,o);return}const h=hasClosestByClassName(c,"li");if(((l=b.content.children[0])==null?void 0:l.getAttribute("data-type"))==="NodeListItem")if(h)c=h,f=c.getAttribute("data-node-id"),u=c.outerHTML;else{const A=b.content.children[0].getAttribute("data-subtype");b.innerHTML=`<div${A==="o"?' data-marker="1."':""} data-subtype="${A}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${e}<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`}let y;Array.from(b.content.children).reverse().forEach(E=>{let A=E.getAttribute("data-node-id");if(A===f)p.push({action:"update",data:E.outerHTML,id:A}),g.push({action:"update",id:A,data:u});else{if(E.classList.contains("li")&&!c.parentElement.classList.contains("list")){A=Lute.NewNodeID();const v=document.createElement("div");v.setAttribute("data-subtype",E.getAttribute("data-subtype")),v.setAttribute("data-node-id",A),v.setAttribute("data-type","NodeList"),v.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),v.classList.add("list"),v.append(E),E=v}p.push({action:"insert",data:E.outerHTML,id:A,previousID:f}),g.push({action:"delete",id:A})}c.after(E),y||(y=E)}),m&&m.textContent===""&&c.classList.contains("p")&&(p.find((E,A)=>{if(E.id===f)return p.splice(A,1),!0}),p.push({action:"delete",id:f}),g.find((E,A)=>{if(E.id===f&&E.action==="update")return g.splice(A,1),!0}),g.push({action:"insert",data:u,id:f,previousID:c.previousElementSibling?c.previousElementSibling.getAttribute("data-node-id"):"",parentID:c.parentElement.getAttribute("data-node-id")||t.block.parentID}),c.remove()),y&&focusBlock(y,void 0,!1);const k=t.wysiwyg.element.querySelector("wbr");k&&k.remove(),transaction(t,p,g)},_r=e=>{var t,n;if(e){hideElements(["util"],e),(t=e.observer)==null||t.disconnect(),(n=e.observerLoad)==null||n.disconnect(),e.element.classList.remove("protyle"),e.element.removeAttribute("style"),e.wysiwyg&&(e.wysiwyg.lastHTMLs={}),e.undo&&e.undo.clear();try{e.ws.send("closews",{})}catch(s){setTimeout(()=>{e.ws.send("closews",{})},10240)}e.app.plugins.forEach(s=>{s.eventBus.emit("destroy-protyle",{protyle:e})})}};class vr{constructor(){this.isUploading=!1,this.element=document.createElement("div"),this.element.className="protyle-upload"}}const Ls=(e,t)=>{const n=[];let s="",a="";for(let l=t.length,o=0;o<l;o++){const r=t[o];let c=!0;r.name||(s+=`<li>${window.siyuan.languages.nameEmpty}</li>`,c=!1),r.size>e.options.upload.max&&(s+=`<li>${r.name} ${window.siyuan.languages.over} ${e.options.upload.max/1024/1024}M</li>`,c=!1);const f=r.name.lastIndexOf("."),u=f===-1?"":r.name.substr(f),d=f===-1?r.name:e.options.upload.filename(r.name.substr(0,f))+u;e.options.upload.accept&&(e.options.upload.accept.split(",").some(p=>{const b=p.trim();if(b.indexOf(".")===0){if(u.toLowerCase()===b.toLowerCase())return!0}else if(r.type.split("/")[0]===b.split("/")[0])return!0;return!1})||(s+=`<li>${r.name} ${window.siyuan.languages.fileTypeError}</li>`,c=!1)),c&&(n.push(r),a+=`<li>${d} ${window.siyuan.languages.uploading}</li>`)}let i;return(s!==""||a!=="")&&(i=showMessage(`<ul>${s}${a}</ul>`,-1)),{files:n,msgId:i}},$n=(e,t)=>{var n,s;const a=JSON.parse(e);let i="";a.code===1&&(i=`${a.msg}`),a.data.errFiles&&a.data.errFiles.length>0&&(i=`<ul><li>${i}</li>`,a.data.errFiles.forEach(d=>{const g=d.lastIndexOf("."),p=g===-1?d:t.options.upload.filename(d.substr(0,g))+d.substr(g);i+=`<li>${p} ${window.siyuan.languages.uploadError}</li>`}),i+="</ul>"),i&&showMessage(i);let l=!0;const o=getEditorRange(t.wysiwyg.element);o.toString()===""&&o.startContainer.nodeType===3&&t.toolbar.getCurrentType(o).length>0&&(o.setEndAfter(o.startContainer.parentElement),o.collapse(!1));const r=hasClosestBlock(o.startContainer);if(r)if(r.classList.contains("table"))l=!1;else{const d=getContenteditableElement(r);d&&d.textContent!==""&&r.classList.contains("p")&&(l=!1)}let c="";const f=Object.keys(a.data.succMap),u=[];if(f.forEach((d,g)=>{const p=a.data.succMap[d],b=pathPosix().extname(d).toLowerCase(),m=t.options.upload.filename(d),h=m.substring(0,m.length-b.length);u.push({type:Constants.SIYUAN_ASSETS_IMAGE.includes(b)?"image":"file",content:p,name:h}),c+=genAssetHTML(b,p,h,m),!Constants.SIYUAN_ASSETS_AUDIO.includes(b)&&!Constants.SIYUAN_ASSETS_VIDEO.includes(b)&&f.length-1!==g&&(r&&r.classList.contains("table")?c+="<br>":l?c+=`

`:c+=`
`)}),r&&r.classList.contains("av")){updateCellsValue(t,r,u),(n=document.querySelector(".av__panel"))==null||n.remove();return}if(document.querySelector(".av__panel")){const d=hasClosestBlock(t.wysiwyg.element.querySelector(".av__cell--select"));if(d){updateCellsValue(t,d,u),(s=document.querySelector(".av__panel"))==null||s.remove();return}}insertHTML(c,t,l)},Ss=(e,t,n)=>{const s=showMessage(window.siyuan.languages.uploading,0);fetchPost("/api/asset/insertLocalAssets",{assetPaths:e,isUpload:n,id:t.block.rootID},a=>{hideMessage(s),$n(JSON.stringify(a),t)})},Er=(e,t,n,s)=>{if(!e){const f=new FormData;for(let d=0,g=t.length;d<g;d++)f.append("file[]",t[d]);const u=new XMLHttpRequest;u.open("POST",Constants.UPLOAD_ADDRESS),u.onreadystatechange=()=>{u.readyState===XMLHttpRequest.DONE&&(u.status===200?s(u.responseText):u.status===0?showMessage(window.siyuan.languages.fileTypeError):showMessage(u.responseText),n&&(n.value=""))},u.send(f);return}let a=[];for(let f=0;f<t.length;f++){let u=t[f];u instanceof DataTransferItem&&(u=u.getAsFile()),u.size===0&&u.type===""&&u.name.indexOf(".")===-1?Ss([u.path],e,!1):a.push(u)}if(e.options.upload.handler){const f=e.options.upload.handler(a);if(typeof f=="string"){showMessage(f);return}return}if(!e.options.upload.url||!e.upload){n&&(n.value=""),showMessage("please config: options.upload.url");return}if(e.options.upload.file&&(a=e.options.upload.file(a)),e.options.upload.validate){const f=e.options.upload.validate(a);if(typeof f=="string"){showMessage(f);return}}const i=e.wysiwyg.element,l=Ls(e,a);if(l.files.length===0){n&&(n.value="");return}const o=new FormData,r=e.options.upload.extraData;for(const f of Object.keys(r))o.append(f,r[f]);for(let f=0,u=l.files.length;f<u;f++)o.append(e.options.upload.fieldName,l.files[f]);o.append("id",e.block.rootID);const c=new XMLHttpRequest;c.open("POST",e.options.upload.url),e.options.upload.token&&c.setRequestHeader("X-Upload-Token",e.options.upload.token),e.options.upload.withCredentials&&(c.withCredentials=!0),e.upload.isUploading=!0,c.onreadystatechange=()=>{if(c.readyState===XMLHttpRequest.DONE){if(e.upload.isUploading=!1,!document.body.contains(e.element)){destroy(e);return}if(c.status===200)if(hideMessage(l.msgId),e.options.upload.success)e.options.upload.success(i,c.responseText);else if(s)s(c.responseText);else{let f=c.responseText;e.options.upload.format&&(f=e.options.upload.format(t,c.responseText)),$n(f,e)}else c.status===0?showMessage(window.siyuan.languages.fileTypeError):e.options.upload.error?e.options.upload.error(c.responseText):showMessage(c.responseText);n&&(n.value=""),e.upload.element.style.display="none"}},c.upload.onprogress=f=>{if(!f.lengthComputable)return;const u=f.loaded/f.total*100;e.upload.element.style.display="block";const d=e.upload.element;d.style.width=u+"%"},c.send(o)},xs=e=>{e.menuElement.querySelector("input").addEventListener("change",t=>{t.target.files.length!==0&&uploadFiles(e.protyle,t.target.files,t.target,n=>{const s=JSON.parse(n),a=[];Object.keys(s.data.succMap).forEach(i=>{a.push({name:i,content:s.data.succMap[i],type:Constants.SIYUAN_ASSETS_IMAGE.includes(pathPosix().extname(s.data.succMap[i]).toLowerCase())?"image":"file"})}),gt({protyle:e.protyle,data:e.data,cellElements:e.cellElements,type:"addUpdate",addUpdateValue:a,blockElement:e.blockElement})})})},Ts=e=>{let t="";return genCellValueByElement("mAsset",e[0]).mAsset.forEach(n=>{if(!n.content)return;let s;n.type==="image"?s=`<span data-type="openAssetItem" class="fn__flex-1">
    <img style="max-height: 180px;max-width: 360px;border-radius: var(--b3-border-radius);margin: 4px 0;" src="${n.content}"/>
</span>`:s=`<span data-type="openAssetItem" class="fn__ellipsis b3-menu__label" style="max-width: 360px">${n.name}</span>`,t+=`<button class="b3-menu__item" draggable="true" data-name="${n.name}" data-type="${n.type}" data-content="${n.content}">
<svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
${s}
<svg class="b3-menu__action" data-type="editAssetItem"><use xlink:href="#iconEdit"></use></svg>
</button>`}),`<div class="b3-menu__items">
    ${t}
    <button data-type="addAssetExist" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconImage"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.assets}</span>
    </button>
    <button class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconDownload"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.insertAsset}</span> 
        <input multiple class="b3-form__upload" type="file">
    </button>
    <button data-type="addAssetLink" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconLink"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.link}</span>
    </button>
</div>`},gt=e=>{const t=e.cellElements[0].dataset.colId,n=[],s=[];let a;e.cellElements.forEach((l,o)=>{if(!e.blockElement.contains(l)){const u=hasClosestByClassName(l,"av__row");u&&(l=e.cellElements[o]=e.blockElement.querySelector(`.av__row[data-id="${u.dataset.id}"] .av__cell[data-col-id="${l.dataset.colId}"]`))}const r=genCellValueByElement(getTypeByCellElement(l)||l.dataset.type,l),c=hasClosestByClassName(l,"av__row").dataset.id,f=JSON.parse(JSON.stringify(r));o===0?(e.type==="remove"?r.mAsset.find((u,d)=>{if(u.content===e.removeContent)return r.mAsset.splice(d,1),!0}):e.type==="addUpdate"?e.addUpdateValue.forEach(u=>{if(!u.content)return;r.mAsset.find(g=>{if(g.content===u.content)return g.name=u.name,g.type=u.type,!0})||(u.type==="file"&&!u.name&&(u.name=u.content),r.mAsset.push(u))}):r.mAsset=e.replaceValue,a=r.mAsset):r.mAsset=a,n.push({action:"updateAttrViewCell",id:r.id,keyID:t,rowID:c,avID:e.data.id,data:r}),s.push({action:"updateAttrViewCell",id:r.id,keyID:t,rowID:c,avID:e.data.id,data:f}),e.data.view.rows.find(u=>{if(u.id===c)return u.cells.find(d=>{if(d.id===r.id)return d.value=r,!0}),!0}),l.classList.contains("custom-attr__avvalue")?l.innerHTML=genAVValueHTML(r):updateAttrViewCellAnimation(l,r)}),transaction(e.protyle,n,s);const i=document.querySelector(".av__panel > .b3-menu");if(i){i.innerHTML=Ts(e.cellElements),xs({protyle:e.protyle,data:e.data,menuElement:i,cellElements:e.cellElements,blockElement:e.blockElement});const l=(e.cellElements[0].classList.contains("custom-attr__avvalue")?e.cellElements[0]:e.protyle.wysiwyg.element.querySelector(`.av__cell[data-id="${e.cellElements[0].dataset.id}"]`)).getBoundingClientRect();setTimeout(()=>{setPosition(i,l.left,l.bottom,l.height)},Constants.TIMEOUT_LOAD)}},kr=(e,t,n,s,a)=>{const i=s.dataset.content,l=s.dataset.type,o=new Menu("av-asset-edit",()=>{!r||!r.value||r.value===s.dataset.name||gt({protyle:e,data:t,cellElements:n,type:"addUpdate",blockElement:a,addUpdateValue:[{content:i,name:r.value,type:l}]})});if(o.isOpen)return;l==="file"?o.addItem({iconHTML:"",type:"readonly",label:`${window.siyuan.languages.title}<textarea rows="1" style="margin:4px 0;width: ${isMobile()?"200":"360"}px" class="b3-text-field"></textarea>`}):o.addItem({icon:"iconPreview",label:window.siyuan.languages.cardPreview,click(){previewImage(i)}}),o.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){gt({protyle:e,data:t,cellElements:n,blockElement:a,type:"remove",removeContent:i})}}),openMenu(e?e.app:window.siyuan.ws.app,i,!1,!0);const r=o.element.querySelector("textarea");r&&(r.value=s.dataset.name);const c=s.getBoundingClientRect();o.open({x:c.right,y:c.top,w:c.width,h:c.height})},Cr=(e,t,n,s,a)=>{const i=new Menu("av-asset-link",()=>{const o=i.element.querySelectorAll("textarea");o[0].value&&gt({protyle:e,data:t,cellElements:n,blockElement:a,type:"addUpdate",addUpdateValue:[{type:"file",name:o[1].value,content:o[0].value}]})});if(i.isOpen)return;i.addItem({iconHTML:"",type:"readonly",label:`${window.siyuan.languages.link}
<textarea rows="1" style="margin:4px 0;width: ${isMobile()?"200":"360"}px" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
${window.siyuan.languages.title}
<textarea style="width: ${isMobile()?"200":"360"}px;margin: 4px 0;" rows="1" class="b3-text-field"></textarea>`});const l=s.getBoundingClientRect();i.open({x:l.right,y:l.bottom,w:s.parentElement.clientWidth+8,h:l.height})},Ar=(e,t,n,s)=>{const a=showMessage(window.siyuan.languages.uploading,0);fetchPost("/api/asset/insertLocalAssets",{assetPaths:e,isUpload:!0,id:t.block.rootID},i=>{const l=hasClosestBlock(n);if(l){hideMessage(a);const o=[];Object.keys(i.data.succMap).forEach(r=>{const c=pathPosix().extname(r).toLowerCase(),f=r.substring(0,r.length-c.length);Constants.SIYUAN_ASSETS_IMAGE.includes(c)?o.push({type:"image",name:f,content:i.data.succMap[r]}):o.push({type:"file",name:f,content:i.data.succMap[r]})}),fetchPost("/api/av/renderAttributeView",{id:s,pageSize:parseInt(l.getAttribute("data-page-size"))||void 0},r=>{gt({protyle:t,blockElement:l,data:r.data,cellElements:[n],type:"addUpdate",addUpdateValue:o})})}})},Hn=(e,t,n,s)=>{fetchPost("/api/av/searchAttributeView",{keyword:t},a=>{let i="";a.data.results.forEach((l,o)=>{i+=`<div class="b3-list-item b3-list-item--narrow${o===0?" b3-list-item--focus":""}" data-av-id="${l.avID}" data-block-id="${l.blockID}">
    <div class="b3-list-item--two fn__flex-1">
        <div class="b3-list-item__first">
            <span class="b3-list-item__text">${escapeHtml(l.avName||window.siyuan.languages.title)}</span>
        </div>
        <div class="b3-list-item__meta b3-list-item__showall">${escapeHtml(l.hPath)}</div>
    </div>
    <svg aria-label="${window.siyuan.languages.thisDatabase}" style="margin: 0 0 0 4px" class="b3-list-item__hinticon ariaLabel${l.avID===n?"":" fn__none"}"><use xlink:href="#iconInfo"></use></svg>
</div>`}),e.innerHTML=i,s&&s()})},Nn=(e,t,n)=>{t.dataset.avId=n.dataset.avId,t.dataset.blockId=n.dataset.blockId,t.querySelector(".b3-menu__accelerator").textContent=n.querySelector(".b3-list-item__hinticon").classList.contains("fn__none")?n.querySelector(".b3-list-item__text").textContent:window.siyuan.languages.thisDatabase;const s=hasClosestByClassName(t,"b3-menu__items");s&&Is(s,e,!0)},Lr=(e,t)=>{window.siyuan.menus.menu.remove();const n=new Menu;n.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column" style = "min-width: 260px;max-width:420px;max-height: 50vh">
    <input class="b3-text-field fn__flex-shrink"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind(s){const a=s.querySelector(".b3-list"),i=s.querySelector("input");i.addEventListener("keydown",l=>{if(l.isComposing)return;upDownHint(a,l)&&l.stopPropagation(),l.key==="Enter"&&(l.preventDefault(),l.stopPropagation(),Nn(e,t,a.querySelector(".b3-list-item--focus")),window.siyuan.menus.menu.remove())}),i.addEventListener("input",l=>{l.stopPropagation(),Hn(a,i.value,e)}),s.lastElementChild.addEventListener("click",l=>{const o=hasClosestByClassName(l.target,"b3-list-item");o&&(l.stopPropagation(),Nn(e,t,o),window.siyuan.menus.menu.remove())}),Hn(a,"",e,()=>{const l=t.getBoundingClientRect();n.open({x:l.left,y:l.bottom,h:l.height}),s.querySelector("input").focus()})}}),n.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial")},Sr=e=>{const t=e.avElement.querySelector('input[data-type="colName"]'),s=e.avElement.querySelector('.b3-menu__item[data-type="goSearchAV"]').getAttribute("data-av-id"),a=e.avElement.querySelector(".b3-menu__item").getAttribute("data-col-id");let i;e.colsData.find(o=>{if(o.id===a)return o.relation||(o.relation={}),i=o,!0});const l=e.avElement.querySelector('[data-type="name"]').value;transaction(e.protyle,[{action:"updateAttrViewColRelation",avID:e.avID,keyID:a,id:s||i.relation.avID,backRelationKeyID:i.relation.avID===s?i.relation.backKeyID:Lute.NewNodeID(),isTwoWay:e.avElement.querySelector(".b3-switch").checked,name:t.value,format:l}],[{action:"updateAttrViewColRelation",avID:e.avID,keyID:a,id:i.relation.avID,backRelationKeyID:i.relation.backKeyID,isTwoWay:i.relation.isTwoWay,name:t.dataset.oldValue,format:i.name}]),e.avElement.remove(),updateAttrViewCellAnimation(e.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${a}"]`),void 0,{name:l}),focusBlock(e.blockElement)},Is=(e,t,n=!1)=>{const s=e.querySelector('.b3-menu__item[data-type="goSearchAV"]'),a=s.nextElementSibling,i=a.querySelector(".b3-switch"),l=a.nextElementSibling,o=l.nextElementSibling,r=JSON.parse(s.dataset.oldValue);if(r.avID){const c=l.querySelector("input");n&&(s.dataset.avId!==r.avID?(c.value="",i.checked=!1):(c.value=c.dataset.oldValue,i.checked=r.isTwoWay)),s.dataset.avId===t&&r.avID===t&&r.isTwoWay?(a.classList.add("fn__none"),l.classList.add("fn__none")):(a.classList.remove("fn__none"),i.checked?l.classList.remove("fn__none"):l.classList.add("fn__none")),s.dataset.avId&&r.avID!==s.dataset.avId||r.isTwoWay!==i.checked||c.dataset.oldValue!==c.value?o.classList.remove("fn__none"):o.classList.add("fn__none")}else s.dataset.avId&&(a.classList.remove("fn__none"),i.checked?l.classList.remove("fn__none"):l.classList.add("fn__none"),o.classList.remove("fn__none"))},Fe=(e,t,n,s)=>{if(e==="selected")return`<button data-id="${t}" data-type="setRelationCell" class="b3-menu__item" draggable="true">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <span class="b3-menu__label${n?"":" popover__block"}" ${n?"":'style="color:var(--b3-protyle-inline-blockref-color)"'} data-id="${t}">${s}</span>
    <svg class="b3-menu__action"><use xlink:href="#iconMin"></use></svg>
</button>`;if(e==="empty")return`<button class="b3-menu__item">
    <span class="b3-menu__label">${window.siyuan.languages.emptyContent}</span>
</button>`;if(e=="unselect")return`<button data-id="${t}" class="b3-menu__item" data-type="setRelationCell">
    <span class="b3-menu__label${n?"":" popover__block"}" ${n?"":'style="color:var(--b3-protyle-inline-blockref-color)"'} data-id="${t}">${s}</span>
    <svg class="b3-menu__action"><use xlink:href="#iconAdd"></use></svg>
</button>`},Bn=(e,t)=>{Array.from(e.children).forEach(n=>{n.dataset.id&&(n.textContent.includes(t)?n.classList.remove("fn__none"):n.classList.add("fn__none"))})},xr=e=>{const t=e.menuElement.firstElementChild.getAttribute("data-cell-ids").split(",");fetchPost("/api/av/renderAttributeView",{id:e.menuElement.firstElementChild.getAttribute("data-av-id")},n=>{const s=n.data;let a=0;s.view.columns.find((f,u)=>{if(f.type==="block")return a=u,!0});let i="",l="";t.forEach(f=>{f&&s.view.rows.find(u=>{if(u.id===f)return l+=Fe("selected",u.id,u.cells[a].value.isDetached,u.cells[a].value.block.content||"Untitled"),!0})}),s.view.rows.forEach(f=>{t.includes(f.id)||(i+=Fe("unselect",f.id,f.cells[a].value.isDetached,f.cells[a].value.block.content||"Untitled"))}),e.menuElement.innerHTML=`<div class="fn__flex-column">
<div class="b3-menu__item fn__flex-column" data-type="nobg">
    <div class="b3-menu__label">${s.name}</div>
    <input class="b3-text-field fn__flex-shrink"/>
</div>
<div class="fn__hr"></div>
<div class="b3-menu__items">
    ${l||Fe("empty")}
    <button class="b3-menu__separator"></button>
    ${i||Fe("empty")}
</div>`;const o=e.cellElements[e.cellElements.length-1].getBoundingClientRect();setPosition(e.menuElement,o.left,o.bottom,o.height),e.menuElement.querySelector(".b3-menu__items .b3-menu__item").classList.add("b3-menu__item--current");const r=e.menuElement.querySelector("input");r.focus();const c=e.menuElement.querySelector(".b3-menu__items");r.addEventListener("keydown",f=>{if(f.stopPropagation(),f.isComposing)return;upDownHint(c,f,"b3-menu__item--current");const u=e.menuElement.querySelector(".b3-menu__item--current");f.key==="Enter"&&u&&u.getAttribute("data-type")==="setRelationCell"?(Ms(e.protyle,e.blockElement,u,e.cellElements),f.preventDefault(),f.stopPropagation()):f.key==="Escape"&&(e.menuElement.parentElement.remove(),f.preventDefault(),f.stopPropagation())}),r.addEventListener("input",f=>{f.isComposing||(Bn(c,r.value),f.stopPropagation())}),r.addEventListener("compositionend",f=>{f.stopPropagation(),Bn(c,r.value)})})},Tr=(e,t)=>{let n;if(e.view.columns.find(s=>{if(s.id===t[0].dataset.colId)return n=s.relation,!0}),n&&n.avID){let s="";return t[0].querySelectorAll("span").forEach(a=>{s+=`${a.getAttribute("data-id")},`}),`<div data-av-id="${n.avID}" data-cell-ids="${s}" class="fn__flex-column">
<div class="b3-menu__item fn__flex-column" data-type="nobg">
    <div class="b3-menu__label">&nbsp;</div>
    <input class="b3-text-field fn__flex-shrink"/>
</div>
<div class="fn__hr"></div>
<div class="b3-menu__items">
    <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
</div>`}else return""},Ms=(e,t,n,s)=>{const a=hasClosestByClassName(n,"b3-menu__items");if(!a)return;const i={blockIDs:[],contents:[]};if(Array.from(a.children).forEach(l=>{const o=l.getAttribute("data-id");l.getAttribute("draggable")&&o&&(i.blockIDs.push(o),i.contents.push(l.textContent.trim()))}),n.classList.contains("b3-menu__item")){const l=n.getAttribute("data-id"),o=a.querySelector(".b3-menu__separator");if(n.getAttribute("draggable")){o.nextElementSibling.getAttribute("data-id")||o.nextElementSibling.remove();const r=i.blockIDs.indexOf(l);i.blockIDs.splice(r,1),i.contents.splice(r,1),o.after(n),n.outerHTML=Fe("unselect",l,!n.querySelector(".popover__block"),n.querySelector(".b3-menu__label").textContent),o.previousElementSibling||o.insertAdjacentHTML("beforebegin",Fe("empty"))}else o.previousElementSibling.getAttribute("data-id")||o.previousElementSibling.remove(),i.blockIDs.push(l),i.contents.push(n.textContent.trim()),o.before(n),n.outerHTML=Fe("selected",l,!n.querySelector(".popover__block"),n.querySelector(".b3-menu__label").textContent),o.nextElementSibling||o.insertAdjacentHTML("afterend",Fe("empty"));a.firstElementChild.classList.add("b3-menu__item--current")}updateCellsValue(e,t,i,s)},Pn=(e,t)=>{if(t.classList.contains("b3-list--empty"))return;e.target.querySelector(".b3-menu__accelerator").textContent=t.querySelector(".b3-list-item__text").textContent;const n=e.data.view.columns.find(a=>{if(a.id===e.colId)return a.rollup||(a.rollup={}),!0}),s=Object.assign({},n.rollup);e.isRelation?(n.rollup.relationKeyID=t.dataset.colId,e.target.nextElementSibling.setAttribute("data-av-id",t.dataset.targetAvId)):(n.rollup.keyID=t.dataset.colId,e.target.nextElementSibling.setAttribute("data-col-type",t.dataset.colType)),transaction(e.protyle,[{action:"updateAttrViewColRollup",id:e.colId,avID:e.data.id,parentID:n.rollup.relationKeyID,keyID:n.rollup.keyID,data:{calc:n.rollup.calc}}],[{action:"updateAttrViewColRollup",id:e.colId,avID:e.data.id,parentID:s.relationKeyID,keyID:s.keyID,data:{calc:s.calc}}])},Rn=(e,t,n,s,a)=>{if(!s&&!n){showMessage(window.siyuan.languages.selectRelation);return}fetchPost(s?"/api/av/searchAttributeViewRelationKey":"/api/av/searchAttributeViewNonRelationKey",{avID:n,keyword:t},i=>{let l="";i.data.keys.forEach((o,r)=>{l+=`<div class="b3-list-item b3-list-item--narrow${r===0?" b3-list-item--focus":""}" data-col-id="${o.id}" ${s?`data-target-av-id="${o.relation.avID}"`:`data-col-type="${o.type}"`}>
        ${o.icon?unicode2Emoji(o.icon,"b3-list-item__graphic",!0):`<svg class="b3-list-item__graphic"><use xlink:href="#${getColIconByType(o.type)}"></use></svg>`}
        ${genIconHTML()}
        <span class="b3-list-item__text">${escapeHtml(o.name||window.siyuan.languages.title)}</span>
</div>`}),e.innerHTML=l||`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`,a&&a()})},Ir=e=>{window.siyuan.menus.menu.remove();const t=new Menu;t.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column" style = "min-width: 260px;max-width:420px;max-height: 50vh">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages[e.isRelation?"searchRelation":"searchRollupProperty"]}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind(n){const s=n.querySelector(".b3-list"),a=n.querySelector("input");a.addEventListener("keydown",i=>{if(i.isComposing)return;upDownHint(s,i)&&i.stopPropagation(),i.key==="Enter"&&(i.preventDefault(),i.stopPropagation(),Pn(e,s.querySelector(".b3-list-item--focus")),window.siyuan.menus.menu.remove())}),a.addEventListener("input",i=>{i.stopPropagation(),Rn(s,a.value,e.isRelation?e.data.id:e.target.dataset.avId,e.isRelation)}),n.lastElementChild.addEventListener("click",i=>{const l=hasClosestByClassName(i.target,"b3-list-item");l&&(i.stopPropagation(),Pn(e,l),window.siyuan.menus.menu.remove())}),Rn(s,"",e.isRelation?e.data.id:e.target.dataset.avId,e.isRelation,()=>{const i=e.target.getBoundingClientRect();t.open({x:i.left,y:i.bottom,h:i.height}),n.querySelector("input").focus()})}}),t.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial")},Mr=e=>{var t,n;let s;return e.colData?s=e.colData:e.data.view.columns.find(a=>{if(a.id===e.cellElements[0].dataset.colId)return s=a,!0}),`<button class="b3-menu__item" data-type="goSearchRollupCol" data-old-value='${JSON.stringify(s.rollup||{})}'>
    <span class="b3-menu__label">${window.siyuan.languages.relation}</span>
    <span class="b3-menu__accelerator"></span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSearchRollupTarget">
    <span class="b3-menu__label">${window.siyuan.languages.rollupProperty}</span>
    <span class="b3-menu__accelerator"></span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSearchRollupCalc">
    <span class="b3-menu__label">${window.siyuan.languages.rollupCalc}</span>
    <span class="b3-menu__accelerator">${getNameByOperator((n=(t=s.rollup)==null?void 0:t.calc)==null?void 0:n.operator,!0)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`},Dr=e=>{const t=e.menuElement.querySelector('[data-type="goSearchRollupCol"]');if(t){const n=JSON.parse(t.dataset.oldValue),s=e.menuElement.querySelector('[data-type="goSearchRollupTarget"]');let a="";n.relationKeyID&&e.data.view.columns.find(i=>{if(i.id===n.relationKeyID)return t.querySelector(".b3-menu__accelerator").textContent=i.name,a=i.relation.avID,s.dataset.avId=a,!0}),n.keyID&&a&&fetchPost("/api/av/getAttributeView",{id:a},i=>{i.data.av.keyValues.find(l=>{if(l.key.id===n.keyID){s.querySelector(".b3-menu__accelerator").textContent=l.key.name;const o=e.menuElement.querySelector('[data-type="goSearchRollupCalc"]');return o.dataset.colType=l.key.type,o.dataset.calc=n.calc.operator,!0}})})}},Ds=e=>{let t=document.querySelector(".av__panel");if(t){t.remove();return}window.siyuan.menus.menu.remove();const n=e.blockElement.getAttribute("data-av-id");fetchPost("/api/av/renderAttributeView",{id:n,pageSize:parseInt(e.blockElement.getAttribute("data-page-size"))||void 0},s=>{var a;const i=!e.blockElement.classList.contains("av"),l=s.data;let o;if(e.type==="config")o=getViewHTML(l.view);else if(e.type==="properties")o=Ve(l.view);else if(e.type==="sorts")o=getSortsHTML(l.view.columns,l.view.sorts);else if(e.type==="switcher")o=getSwitcherHTML(l.views,l.viewID);else if(e.type==="filters")o=getFiltersHTML(l.view);else if(e.type==="select")o=getSelectHTML(l.view,e.cellElements);else if(e.type==="asset")o=getAssetHTML(e.cellElements);else if(e.type==="edit")o=getEditHTML({protyle:e.protyle,data:l,colId:e.colId,isCustomAttr:i});else if(e.type==="date")o=getDateHTML(l.view,e.cellElements);else if(e.type==="rollup")o=`<div class="b3-menu__items">${getRollupHTML({data:l,cellElements:e.cellElements})}</div>`;else if(e.type==="relation"&&(o=getRelationHTML(l,e.cellElements),!o)){Ds({protyle:e.protyle,blockElement:e.blockElement,type:"edit",colId:e.cellElements[0].dataset.colId});return}document.body.insertAdjacentHTML("beforeend",`<div class="av__panel" style="z-index: ${++window.siyuan.zIndex}">
    <div class="b3-dialog__scrim" data-type="close"></div>
    <div class="b3-menu">${o}</div>
</div>`),t=document.querySelector(".av__panel");const r=t.lastElementChild,c=(a=e.blockElement.querySelector(`.av__views, .av__row[data-col-id="${e.colId}"] > .block__logo`))==null?void 0:a.getBoundingClientRect();if(["select","date","asset","relation","rollup"].includes(e.type)){const u=e.cellElements[e.cellElements.length-1].getBoundingClientRect();if(e.type==="select"?bindSelectEvent(e.protyle,l,r,e.cellElements,e.blockElement):e.type==="date"?bindDateEvent({protyle:e.protyle,data:l,menuElement:r,cellElements:e.cellElements,blockElement:e.blockElement}):e.type==="asset"?(bindAssetEvent({protyle:e.protyle,data:l,menuElement:r,cellElements:e.cellElements,blockElement:e.blockElement}),setTimeout(()=>{setPosition(r,u.left,u.bottom,u.height)},Constants.TIMEOUT_LOAD)):e.type==="relation"?bindRelationEvent({menuElement:r,cellElements:e.cellElements,protyle:e.protyle,blockElement:e.blockElement}):e.type==="rollup"&&bindRollupEvent({protyle:e.protyle,data:l,menuElement:r}),["select","date","relation","rollup"].includes(e.type)){const d=r.querySelector("input");d&&(d.select(),d.focus()),setPosition(r,u.left,u.bottom,u.height)}}else setPosition(r,c.right-r.clientWidth,c.bottom,c.height),e.type==="sorts"?bindSortsEvent(e.protyle,r,l):e.type==="edit"?bindEditEvent({protyle:e.protyle,data:l,menuElement:r,isCustomAttr:i}):e.type==="config"&&bindViewEvent({protyle:e.protyle,data:l,menuElement:r});e.cb&&e.cb(t),t.addEventListener("dragstart",u=>{window.siyuan.dragElement=u.target,window.siyuan.dragElement.style.opacity=".1"}),t.addEventListener("drop",u=>{var d,g,p,b;window.siyuan.dragElement.style.opacity="";const m=window.siyuan.dragElement;if(window.siyuan.dragElement=void 0,e.protyle&&e.protyle.disabled){u.preventDefault(),u.stopPropagation();return}if(!e.protyle&&window.siyuan.config.readonly){u.preventDefault(),u.stopPropagation();return}const h=t.querySelector(".dragover__bottom, .dragover__top");if(!h)return;const y=h.classList.contains("dragover__top"),k=m.dataset.id,E=h.dataset.id;if(h.querySelector('[data-type="removeSort"]')){const v=l.view.sorts,S=Object.assign([],v);let w;v.find((_,C)=>{if(_.column===k)return w=v.splice(C,1)[0],!0}),v.find((_,C)=>{if(_.column===E)return y?v.splice(C,0,w):v.splice(C+1,0,w),!0}),transaction(e.protyle,[{action:"setAttrViewSorts",avID:n,data:v}],[{action:"setAttrViewSorts",avID:n,data:S}]),r.innerHTML=getSortsHTML(l.view.columns,l.view.sorts),bindSortsEvent(e.protyle,r,l);return}if(h.querySelector('[data-type="removeFilter"]')){const v=l.view.filters,S=Object.assign([],v);let w;v.find((_,C)=>{if(_.column===k)return w=v.splice(C,1)[0],!0}),v.find((_,C)=>{if(_.column===E)return y?v.splice(C,0,w):v.splice(C+1,0,w),!0}),transaction(e.protyle,[{action:"setAttrViewFilters",avID:n,data:v}],[{action:"setAttrViewFilters",avID:n,data:S}]),r.innerHTML=getFiltersHTML(l.view);return}if(h.querySelector('[data-type="av-view-edit"]')){transaction(e.protyle,[{action:"sortAttrViewView",avID:n,id:k,previousID:y?(d=h.previousElementSibling)==null?void 0:d.getAttribute("data-id"):h.getAttribute("data-id")}],[{action:"sortAttrViewView",avID:n,id:k,previousID:(g=m.previousElementSibling)==null?void 0:g.getAttribute("data-id")}]),y?(h.before(m),h.classList.remove("dragover__top")):(h.after(m),h.classList.remove("dragover__bottom"));return}if(h.querySelector('[data-type="editAssetItem"]')){y?h.before(m):h.after(m);const v=[];Array.from(h.parentElement.children).forEach(S=>{S.dataset.content&&v.push({content:S.dataset.content,name:S.dataset.name,type:S.dataset.type})}),updateAssetCell({protyle:e.protyle,data:l,cellElements:e.cellElements,type:"replace",replaceValue:v,blockElement:e.blockElement});return}if(h.querySelector('[data-type="setColOption"]')){const v=e.cellElements?e.cellElements[0].dataset.colId:r.querySelector(".b3-menu__item").getAttribute("data-col-id"),S=l.view.columns.find(C=>C.id===v).options,w=Object.assign([],S);let _;S.find((C,x)=>{if(C.name===m.dataset.name)return _=S.splice(x,1)[0],!0}),S.find((C,x)=>{if(C.name===h.dataset.name)return y?S.splice(x,0,_):S.splice(x+1,0,_),!0}),transaction(e.protyle,[{action:"updateAttrViewColOptions",id:v,avID:l.id,data:S}],[{action:"updateAttrViewColOptions",id:v,avID:l.id,data:w}]),e.cellElements?(r.innerHTML=getSelectHTML(l.view,e.cellElements),bindSelectEvent(e.protyle,l,r,e.cellElements,e.blockElement)):(r.innerHTML=getEditHTML({protyle:e.protyle,data:l,colId:v,isCustomAttr:i}),bindEditEvent({protyle:e.protyle,data:l,menuElement:r,isCustomAttr:i}));return}if(h.getAttribute("data-type")==="setRelationCell"){y?h.before(m):h.after(m),h.classList.remove("dragover__bottom","dragover__top"),setRelationCell(e.protyle,e.blockElement,m.parentElement,e.cellElements);return}transaction(e.protyle,[{action:"sortAttrViewCol",avID:n,previousID:(h.classList.contains("dragover__top")?(p=h.previousElementSibling)==null?void 0:p.getAttribute("data-id"):h.getAttribute("data-id"))||"",id:k}],[{action:"sortAttrViewCol",avID:n,previousID:((b=m.previousElementSibling)==null?void 0:b.getAttribute("data-id"))||"",id:k}]);let A;l.view.columns.find((v,S)=>{if(v.id===k)return A=l.view.columns.splice(S,1)[0],!0}),l.view.columns.find((v,S)=>{if(v.id===E)return y?l.view.columns.splice(S,0,A):l.view.columns.splice(S+1,0,A),!0}),r.innerHTML=Ve(l.view)});let f;t.addEventListener("dragover",u=>{const d=u.target;let g=hasClosestByAttribute(d,"draggable","true");if(g||(g=hasClosestByAttribute(document.elementFromPoint(u.clientX,u.clientY-1),"draggable","true")),!(!g||g.isSameNode(window.siyuan.dragElement))){if(u.preventDefault(),f&&g.isSameNode(f)){const p=g.getBoundingClientRect();g.classList.remove("dragover__bottom","dragover__top"),u.clientY>p.top+p.height/2?g.classList.add("dragover__bottom"):g.classList.add("dragover__top");return}f=g}}),t.addEventListener("dragleave",()=>{t.querySelectorAll(".dragover__bottom, .dragover__top").forEach(u=>{u.classList.remove("dragover__bottom","dragover__top")})}),t.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),t.addEventListener("click",u=>{let d=u.target;for(;d&&!d.isSameNode(t);){const g=d.dataset.type;if(g==="close"){e.protyle.toolbar.subElement.classList.contains("fn__none")?window.siyuan.menus.menu.element.classList.contains("fn__none")?(t.remove(),focusBlock(e.blockElement)):window.siyuan.menus.menu.remove():hideElements(["util"],e.protyle),window.siyuan.menus.menu.remove(),u.preventDefault(),u.stopPropagation();break}else if(g==="go-config"){r.innerHTML=getViewHTML(l.view),setPosition(r,c.right-r.clientWidth,c.bottom,c.height),bindViewEvent({protyle:e.protyle,data:l,menuElement:r}),u.preventDefault(),u.stopPropagation();break}else if(g==="go-properties"){r.innerHTML=Ve(l.view),setPosition(r,c.right-r.clientWidth,c.bottom,c.height),u.preventDefault(),u.stopPropagation();break}else if(g==="goSorts"){r.innerHTML=getSortsHTML(l.view.columns,l.view.sorts),bindSortsEvent(e.protyle,r,l),setPosition(r,c.right-r.clientWidth,c.bottom,c.height),u.preventDefault(),u.stopPropagation();break}else if(g==="removeSorts"){transaction(e.protyle,[{action:"setAttrViewSorts",avID:n,data:[]}],[{action:"setAttrViewSorts",avID:n,data:l.view.sorts}]),l.view.sorts=[],r.innerHTML=getSortsHTML(l.view.columns,l.view.sorts),bindSortsEvent(e.protyle,r,l),setPosition(r,c.right-r.clientWidth,c.bottom,c.height),u.preventDefault(),u.stopPropagation();break}else if(g==="addSort"){addSort({data:l,rect:d.getBoundingClientRect(),menuElement:r,tabRect:c,avId:n,protyle:e.protyle}),u.preventDefault(),u.stopPropagation();break}else if(g==="removeSort"){const p=Object.assign([],l.view.sorts);l.view.sorts.find((b,m)=>{if(b.column===d.parentElement.dataset.id)return l.view.sorts.splice(m,1),!0}),transaction(e.protyle,[{action:"setAttrViewSorts",avID:n,data:l.view.sorts}],[{action:"setAttrViewSorts",avID:n,data:p}]),r.innerHTML=getSortsHTML(l.view.columns,l.view.sorts),bindSortsEvent(e.protyle,r,l),setPosition(r,c.right-r.clientWidth,c.bottom,c.height),u.preventDefault(),u.stopPropagation();break}else if(g==="goFilters"){r.innerHTML=getFiltersHTML(l.view),setPosition(r,c.right-r.clientWidth,c.bottom,c.height),u.preventDefault(),u.stopPropagation();break}else if(g==="removeFilters"){transaction(e.protyle,[{action:"setAttrViewFilters",avID:n,data:[]}],[{action:"setAttrViewFilters",avID:n,data:l.view.filters}]),l.view.filters=[],r.innerHTML=getFiltersHTML(l.view),setPosition(r,c.right-r.clientWidth,c.bottom,c.height),u.preventDefault(),u.stopPropagation();break}else if(g==="addFilter"){addFilter({data:l,rect:d.getBoundingClientRect(),menuElement:r,tabRect:c,avId:n,protyle:e.protyle,blockElement:e.blockElement}),u.preventDefault(),u.stopPropagation();break}else if(g==="removeFilter"){window.siyuan.menus.menu.remove();const p=Object.assign([],l.view.filters);l.view.filters.find((b,m)=>{if(b.column===d.parentElement.dataset.id)return l.view.filters.splice(m,1),!0}),transaction(e.protyle,[{action:"setAttrViewFilters",avID:n,data:l.view.filters}],[{action:"setAttrViewFilters",avID:n,data:p}]),r.innerHTML=getFiltersHTML(l.view),setPosition(r,c.right-r.clientWidth,c.bottom,c.height),u.preventDefault(),u.stopPropagation();break}else if(g==="setFilter"){l.view.filters.find(p=>{if(p.column===d.parentElement.parentElement.dataset.id)return setFilter({filter:p,protyle:e.protyle,data:l,target:d,blockElement:e.blockElement}),!0}),u.preventDefault(),u.stopPropagation();break}else if(g==="numberFormat"){formatNumber({avPanelElement:t,element:d,protyle:e.protyle,oldFormat:d.dataset.format,colId:r.querySelector(".b3-menu__item").getAttribute("data-col-id"),avID:n}),u.preventDefault(),u.stopPropagation();break}else if(g==="newCol"){t.remove(),addCol(e.protyle,e.blockElement).open({x:c.right,y:c.bottom,h:c.height,isLeft:!0}),u.preventDefault(),u.stopPropagation();break}else if(g==="update-view-icon"){const p=d.getBoundingClientRect();openEmojiPanel("","av",{x:p.left,y:p.bottom,h:p.height,w:p.width},b=>{transaction(e.protyle,[{action:"setAttrViewViewIcon",avID:n,id:l.viewID,data:b}],[{action:"setAttrViewViewIcon",id:l.viewID,avID:n,data:d.dataset.icon}]),d.innerHTML=b?unicode2Emoji(b):'<svg><use xlink:href="#iconTable"></use></svg>',d.dataset.icon=b}),u.preventDefault(),u.stopPropagation();break}else if(g==="set-page-size"){setPageSize({target:d,protyle:e.protyle,avID:n,nodeElement:e.blockElement}),u.preventDefault(),u.stopPropagation();break}else if(g==="duplicate-view"){const p=Lute.NewNodeID();transaction(e.protyle,[{action:"duplicateAttrViewView",avID:n,previousID:l.viewID,id:p}],[{action:"removeAttrViewView",avID:n,id:p}]),t.remove(),u.preventDefault(),u.stopPropagation();break}else if(g==="delete-view"){l.views.length===1?removeBlock(e.protyle,e.blockElement,getEditorRange(e.blockElement)):transaction(e.protyle,[{action:"removeAttrViewView",avID:n,id:l.viewID}]),t.remove(),u.preventDefault(),u.stopPropagation();break}else if(g==="update-icon"){const p=d.getBoundingClientRect();openEmojiPanel("","av",{x:p.left,y:p.bottom,h:p.height,w:p.width},b=>{const m=r.querySelector(".b3-menu__item").getAttribute("data-col-id");if(transaction(e.protyle,[{action:"setAttrViewColIcon",id:m,avID:n,data:b}],[{action:"setAttrViewColIcon",id:m,avID:n,data:d.dataset.icon}]),d.innerHTML=b?unicode2Emoji(b):`<svg><use xlink:href="#${getColIconByType(d.dataset.colType)}"></use></svg>`,i){const h=e.blockElement.querySelector(`.av__row[data-col-id="${m}"] .block__logoicon`);h.outerHTML=b?unicode2Emoji(b,"block__logoicon",!0):`<svg class="block__logoicon"><use xlink:href="#${getColIconByType(h.nextElementSibling.getAttribute("data-type"))}"></use></svg>`}else updateAttrViewCellAnimation(e.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${m}"]`),void 0,{icon:b});d.dataset.icon=b}),u.preventDefault(),u.stopPropagation();break}else if(g==="showAllCol"){const p=[],b=[];l.view.columns.forEach(m=>{m.hidden&&(p.push({action:"setAttrViewColHidden",id:m.id,avID:n,data:!1}),b.push({action:"setAttrViewColHidden",id:m.id,avID:n,data:!0}),m.hidden=!1)}),p.length>0&&(transaction(e.protyle,p,b),r.innerHTML=Ve(l.view),setPosition(r,c.right-r.clientWidth,c.bottom,c.height)),u.preventDefault(),u.stopPropagation();break}else if(g==="hideAllCol"){const p=[],b=[];l.view.columns.forEach(m=>{!m.hidden&&m.type!=="block"&&(p.push({action:"setAttrViewColHidden",id:m.id,avID:n,data:!0}),b.push({action:"setAttrViewColHidden",id:m.id,avID:n,data:!1}),m.hidden=!0)}),p.length>0&&(transaction(e.protyle,p,b),r.innerHTML=Ve(l.view),setPosition(r,c.right-r.clientWidth,c.bottom,c.height)),u.preventDefault(),u.stopPropagation();break}else if(g==="editCol"){r.innerHTML=getEditHTML({protyle:e.protyle,data:l,colId:d.parentElement.dataset.id,isCustomAttr:i}),bindEditEvent({protyle:e.protyle,data:l,menuElement:r,isCustomAttr:i}),setPosition(r,c.right-r.clientWidth,c.bottom,c.height),u.preventDefault(),u.stopPropagation();break}else if(g==="updateColType"){if(d.dataset.newType!==d.dataset.oldType){const p=d.dataset.name;transaction(e.protyle,[{action:"updateAttrViewCol",id:e.colId,avID:n,name:p,type:d.dataset.newType}],[{action:"updateAttrViewCol",id:e.colId,avID:n,name:p,type:d.dataset.oldType}])}t.remove(),u.preventDefault(),u.stopPropagation();break}else if(g==="goUpdateColType"){const p=hasClosestByClassName(d,"b3-menu");p&&(p.firstElementChild.classList.add("fn__none"),p.lastElementChild.classList.remove("fn__none")),setPosition(r,c.right-r.clientWidth,c.bottom,c.height),u.preventDefault(),u.stopPropagation();break}else if(g==="goSearchAV"){openSearchAV(n,d),u.preventDefault(),u.stopPropagation();break}else if(g==="goSearchRollupCol"){goSearchRollupCol({target:d,data:l,isRelation:!0,protyle:e.protyle,colId:e.colId||r.querySelector(".b3-menu__item").getAttribute("data-col-id")}),u.preventDefault(),u.stopPropagation();break}else if(g==="goSearchRollupTarget"){goSearchRollupCol({target:d,data:l,isRelation:!1,protyle:e.protyle,colId:e.colId||r.querySelector(".b3-menu__item").getAttribute("data-col-id")}),u.preventDefault(),u.stopPropagation();break}else if(g==="goSearchRollupCalc"){openCalcMenu(e.protyle,d,l,e.colId),u.preventDefault(),u.stopPropagation();break}else if(g==="updateRelation"){updateRelation({protyle:e.protyle,avElement:t,avID:n,colsData:l.view.columns,blockElement:e.blockElement}),u.preventDefault(),u.stopPropagation();break}else if(g==="goEditCol"){const p=hasClosestByClassName(d,"b3-menu");p&&(p.firstElementChild.classList.remove("fn__none"),p.lastElementChild.classList.add("fn__none")),setPosition(r,c.right-r.clientWidth,c.bottom,c.height),u.preventDefault(),u.stopPropagation();break}else if(g==="hideCol"){const p=r.querySelector('[data-type="go-properties"]'),b=p?r.querySelector(".b3-menu__item").getAttribute("data-col-id"):d.parentElement.getAttribute("data-id");transaction(e.protyle,[{action:"setAttrViewColHidden",id:b,avID:n,data:!0}],[{action:"setAttrViewColHidden",id:b,avID:n,data:!1}]),l.view.columns.find(m=>m.id===b).hidden=!0,p?(r.innerHTML=getEditHTML({protyle:e.protyle,data:l,colId:b,isCustomAttr:i}),bindEditEvent({protyle:e.protyle,data:l,menuElement:r,isCustomAttr:i})):r.innerHTML=Ve(l.view),setPosition(r,c.right-r.clientWidth,c.bottom,c.height),u.preventDefault(),u.stopPropagation();break}else if(g==="showCol"){const p=r.querySelector('[data-type="go-properties"]'),b=p?r.querySelector(".b3-menu__item").getAttribute("data-col-id"):d.parentElement.getAttribute("data-id");transaction(e.protyle,[{action:"setAttrViewColHidden",id:b,avID:n,data:!1}],[{action:"setAttrViewColHidden",id:b,avID:n,data:!0}]),l.view.columns.find(m=>m.id===b).hidden=!1,p?(r.innerHTML=getEditHTML({protyle:e.protyle,data:l,colId:b,isCustomAttr:i}),bindEditEvent({protyle:e.protyle,data:l,menuElement:r,isCustomAttr:i})):r.innerHTML=Ve(l.view),setPosition(r,c.right-r.clientWidth,c.bottom,c.height),u.preventDefault(),u.stopPropagation();break}else if(g==="duplicateCol"){const p=r.querySelector(".b3-menu__item").getAttribute("data-col-id"),b=l.view.columns.find(m=>m.id===p);duplicateCol({protyle:e.protyle,type:b.type,avID:n,colId:p,icon:b.icon,newValue:b.name}),t.remove(),u.preventDefault(),u.stopPropagation();break}else if(g==="removeCol"){const p=r.querySelector(".b3-menu__item").getAttribute("data-col-id");let b;const m=l.view.columns.find((h,y)=>{var k;if(h.id===p)return b=(k=l.view.columns[y-1])==null?void 0:k.id,!0});transaction(e.protyle,[{action:"removeAttrViewCol",id:p,avID:n}],[{action:"addAttrViewCol",name:m.name,avID:n,type:m.type,id:p,previousID:b}]),removeAttrViewColAnimation(e.blockElement,p),t.remove(),u.preventDefault(),u.stopPropagation();break}else if(g==="setColOption"){setColOption(e.protyle,l,d,e.blockElement,i,e.cellElements),u.preventDefault(),u.stopPropagation();break}else if(g==="setRelationCell"){setRelationCell(e.protyle,e.blockElement,d,e.cellElements),u.preventDefault(),u.stopPropagation();break}else if(g==="addColOptionOrCell"){addColOptionOrCell(e.protyle,l,e.cellElements,d,r,e.blockElement),window.siyuan.menus.menu.remove(),u.preventDefault(),u.stopPropagation();break}else if(g==="removeCellOption"){removeCellOption(e.protyle,l,e.cellElements,d.parentElement,e.blockElement),u.preventDefault(),u.stopPropagation();break}else if(g==="addAssetLink"){addAssetLink(e.protyle,l,e.cellElements,d,e.blockElement),u.preventDefault(),u.stopPropagation();break}else if(g==="addAssetExist"){const p=d.getBoundingClientRect();assetMenu(e.protyle,{x:p.right,y:p.bottom,w:d.parentElement.clientWidth+8,h:p.height},(b,m)=>{let h;Constants.SIYUAN_ASSETS_IMAGE.includes(pathPosix().extname(b).toLowerCase())?h={type:"image",content:b,name:""}:h={type:"file",content:b,name:m},updateAssetCell({protyle:e.protyle,data:l,cellElements:e.cellElements,type:"addUpdate",addUpdateValue:[h],blockElement:e.blockElement}),window.siyuan.menus.menu.remove()}),u.preventDefault(),u.stopPropagation();break}else if(g==="openAssetItem"){const p=d.parentElement.dataset.content,b=pathPosix().extname(p);Constants.SIYUAN_ASSETS_IMAGE.includes(b)?previewImage(p):window.open(p),u.preventDefault(),u.stopPropagation();break}else if(g==="editAssetItem"){editAssetItem(e.protyle,l,e.cellElements,d.parentElement,e.blockElement),u.preventDefault(),u.stopPropagation();break}else if(g==="clearDate"){updateCellsValue(e.protyle,e.blockElement,{isNotEmpty2:!1,isNotEmpty:!1,content:null,content2:null,hasEndDate:!1,isNotTime:!0},e.cellElements),t.remove(),u.preventDefault(),u.stopPropagation();break}else if(g==="av-add"){window.siyuan.menus.menu.remove(),addView(e.protyle,e.blockElement),t.remove(),u.preventDefault(),u.stopPropagation();break}else if(g==="av-view-edit"){d.parentElement.querySelector(".b3-chip--primary")?openViewMenu({protyle:e.protyle,blockElement:e.blockElement,element:d.parentElement}):(e.blockElement.removeAttribute("data-render"),avRender(e.blockElement,e.protyle,()=>{openViewMenu({protyle:e.protyle,blockElement:e.blockElement,element:d.parentElement}),t.querySelector(".b3-chip--primary").classList.remove("b3-chip--primary"),d.parentElement.querySelector(".b3-chip").classList.add("b3-chip--primary")},d.parentElement.dataset.id)),u.preventDefault(),u.stopPropagation();break}d=d.parentElement}})})},Ve=e=>{let t="",n="";return e.columns.forEach(s=>{s.hidden?n+=`<button class="b3-menu__item" draggable="true" data-id="${s.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip">
            ${s.icon?unicode2Emoji(s.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${getColIconByType(s.type)}"></use></svg>`}
            <span class="fn__ellipsis">${s.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="showCol"><use xlink:href="#iconEyeoff"></use></svg>
    <svg class="b3-menu__action" data-type="editCol"><use xlink:href="#iconEdit"></use></svg>
</button>`:t+=`<button class="b3-menu__item" draggable="true" data-id="${s.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip">
            ${s.icon?unicode2Emoji(s.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${getColIconByType(s.type)}"></use></svg>`}
            <span class="fn__ellipsis">${s.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action${s.type==="block"?" fn__none":""}" data-type="hideCol"><use xlink:href="#iconEye"></use></svg>
    <svg class="b3-menu__action${s.type==="block"?" fn__none":""}" data-type="editCol"><use xlink:href="#iconEdit"></use></svg>
</button>`}),n&&(n=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.hideCol} 
    </span>
    <span class="block__icon" data-type="showAllCol">
        ${window.siyuan.languages.showAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEye"></use></svg>
    </span>
</button>
${n}`),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.attr}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.showCol} 
    </span>
    <span class="block__icon" data-type="hideAllCol">
        ${window.siyuan.languages.hideAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEyeoff"></use></svg>
    </span>
</button>
${t}
${n}
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="newCol">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
</div>`},$s=e=>{if(!e)return"";let t="";const n=e.querySelectorAll(".b3-chip, .av__celltext--ref, .av__celltext");return n.length>0?(n.forEach(s=>{s.querySelector(".av__cellicon")?t+=`${s.firstChild.textContent} \u2192 ${s.lastChild.textContent}, `:s.getAttribute("data-type")!=="block-more"&&(t+=s.textContent+", ")}),t=t.substring(0,t.length-2)):t=e.textContent,t},On=(e,t)=>{const n={type:e,id:t.dataset.id};if(e==="number"){const s=t.querySelector(".av__celltext").getAttribute("data-content");n.number={content:parseFloat(s)||0,isNotEmpty:!!s}}else if(["text","block","url","phone","email","template"].includes(e)){const s=t.querySelector(".av__celltext");n[e]={content:s.textContent},e==="block"&&s.dataset.id&&(n.block.id=s.dataset.id)}else if(e==="mSelect"||e==="select"){const s=[];t.querySelectorAll(".b3-chip").forEach(a=>{s.push({content:a.textContent.trim(),color:a.style.color.replace("var(--b3-font-color","").replace(")","")})}),n.mSelect=s}else if(["date","created","updated"].includes(e))n[e]=JSON.parse(t.querySelector(".av__celltext").getAttribute("data-value"));else if(e==="checkbox")n.checkbox={checked:t.querySelector("use").getAttribute("xlink:href")==="#iconCheck"};else if(e==="relation")n.relation={blockIDs:Array.from(t.querySelectorAll("span")).map(s=>s.getAttribute("data-id")),contents:Array.from(t.querySelectorAll("span")).map(s=>s.textContent)};else if(e==="mAsset"){const s=[];Array.from(t.children).forEach(a=>{const i=a.classList.contains("av__cellassetimg");s.push({type:i?"image":"file",content:i?a.getAttribute("src"):a.getAttribute("data-url"),name:i?"":a.textContent})}),n.mAsset=s}return e==="block"&&(n.isDetached=t.dataset.detached==="true"),n},Hs=(e,t)=>{let n={type:e,[e==="select"?"mSelect":e]:t};return typeof t=="string"&&t&&e!=="mAsset"?e==="number"?n={type:e,number:{content:parseFloat(t)||0,isNotEmpty:!0}}:["text","block","url","phone","email","template"].includes(e)?n={type:e,[e]:{content:t}}:e==="mSelect"||e==="select"?n={type:e,mSelect:[{content:t,color:"1"}]}:e==="checkbox"&&(n={type:e,checkbox:{checked:!0}}):(typeof t=="undefined"||!t)&&(e==="number"?n={type:e,number:{content:null,isNotEmpty:!1}}:["text","block","url","phone","email","template"].includes(e)?n={type:e,[e]:{content:""}}:e==="mSelect"||e==="select"||e==="mAsset"?n={type:e,[e==="select"?"mSelect":e]:[]}:["date","created","updated"].includes(e)?n={type:e,[e]:{content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,hasEndDate:!1,isNotTime:!0}}:e==="checkbox"?n={type:e,checkbox:{checked:!1}}:e==="relation"&&(n={type:e,relation:{blockIDs:[],contents:[]}})),e==="block"&&(n.isDetached=!0),n},$r=(e,t,n=!0)=>{const s=t.getBoundingClientRect();if(!n){const i=e.querySelector(".av__scroll");if(i){const l=i.getBoundingClientRect();if(l.right<s.right)i.scrollLeft=i.scrollLeft+s.right-l.right;else{const o=hasClosestByClassName(t,"av__row");if(o){const r=o.querySelector(".av__colsticky");if(r){const c=r.getBoundingClientRect().right;c>s.left&&(i.scrollLeft=i.scrollLeft+s.left-c)}else l.left>s.left&&(i.scrollLeft=i.scrollLeft+s.left-l.left)}}}}if(!e.querySelector(".av__header"))return;const a=e.querySelector(".av__row--header").getBoundingClientRect();if(a.bottom>s.top){const i=hasClosestByClassName(e,"protyle-content",!0);i&&(i.scrollTop=i.scrollTop+s.top-a.bottom)}else{const i=e.querySelector(".av__row--footer");if(i.querySelector(".av__calc--ashow")){const l=i.getBoundingClientRect();if(l.top<s.bottom){const o=hasClosestByClassName(e,"protyle-content",!0);o&&(o.scrollTop=o.scrollTop+s.bottom-l.top)}}else{const l=hasClosestByClassName(e,"protyle-content",!0);if(l){const o=l.getBoundingClientRect().bottom;s.bottom>o&&(l.scrollTop=l.scrollTop+(s.bottom-o))}}}},Jt=e=>{const t=hasClosestByClassName(e,"av__scroll");if(t)return t.querySelector(".av__row--header").querySelector(`[data-col-id="${e.getAttribute("data-col-id")}"]`).getAttribute("data-dtype")},Hr=(e,t,n)=>{if(t.length===0||t.length===1&&!t[0]||(n||(n=Jt(t[0])),n==="updated"||n==="created"||document.querySelector(".av__mask"))||n==="block"&&(t.length>1||!t[0].getAttribute("data-detached")))return;const s=hasClosestBlock(t[0]);if(!s)return;let a=t[0].getBoundingClientRect();const i=hasClosestByClassName(s,"protyle-content",!0);i&&(i.scrollTop=i.scrollTop+a.top-110),a=t[0].getBoundingClientRect();let l="";const o=`style="padding-top: 6.5px;position:absolute;left: ${a.left}px;top: ${a.top}px;width:${Math.max(a.width,25)}px;height: ${a.height}px"`;if(["text","url","email","phone","block","template"].includes(n))l=`<textarea ${o} class="b3-text-field">${t[0].firstElementChild.textContent}</textarea>`;else if(n==="number")l=`<input type="number" value="${t[0].firstElementChild.getAttribute("data-content")}" ${o} class="b3-text-field">`;else{["select","mSelect"].includes(n)?openMenuPanel({protyle:e,blockElement:s,type:"select",cellElements:t}):n==="mAsset"?(openMenuPanel({protyle:e,blockElement:s,type:"asset",cellElements:t}),focusBlock(s)):n==="date"?openMenuPanel({protyle:e,blockElement:s,type:"date",cellElements:t}):n==="checkbox"?en(e,n,s,t):n==="relation"?openMenuPanel({protyle:e,blockElement:s,type:"relation",cellElements:t}):n==="rollup"&&openMenuPanel({protyle:e,blockElement:s,type:"rollup",cellElements:t,colId:t[0].dataset.colId}),hasClosestByClassName(t[0],"custom-attr")||t[0].classList.add("av__cell--select");return}window.siyuan.menus.menu.remove(),document.body.insertAdjacentHTML("beforeend",`<div class="av__mask" style="z-index: ${++window.siyuan.zIndex}">
    ${l}
</div>`);const r=document.querySelector(".av__mask"),c=r.querySelector(".b3-text-field");c&&(c.select(),c.focus(),n==="template"&&fetchPost("/api/av/renderAttributeView",{id:s.dataset.avId},f=>{f.data.view.columns.find(u=>{if(u.id===t[0].dataset.colId)return c.value=u.template,c.dataset.template=u.template,!0})}),n==="block"&&c.addEventListener("input",f=>{if(Constants.BLOCK_HINT_KEYS.includes(c.value.substring(0,2))){if(e.toolbar.range=document.createRange(),!s.contains(t[0])){const u=hasClosestByClassName(t[0],"av__row");t[0]&&(t[0]=s.querySelector(`.av__row[data-id="${u.dataset.id}"] .av__cell[data-col-id="${t[0].dataset.colId}"]`))}e.toolbar.range.selectNodeContents(t[0].lastChild),focusByRange(e.toolbar.range),t[0].classList.add("av__cell--select"),hintRef(c.value.substring(2),e,"av"),r==null||r.remove(),f.preventDefault(),f.stopPropagation()}}),c.addEventListener("keydown",f=>{f.isComposing||(f.key==="Escape"||f.key==="Tab"||f.key==="Enter"&&!f.shiftKey&&isNotCtrl(f))&&(en(e,n,s,t),f.key==="Tab"&&e.wysiwyg.element.dispatchEvent(new KeyboardEvent("keydown",{shiftKey:f.shiftKey,ctrlKey:f.ctrlKey,altKey:f.altKey,metaKey:f.metaKey,key:"Tab",keyCode:9})),f.preventDefault(),f.stopPropagation())})),r.addEventListener("click",f=>{f.target.classList.contains("av__mask")&&(en(e,n,s,t),r==null||r.remove())})},en=(e,t,n,s)=>{const a=hasClosestByClassName(s[0],"av__row");if(!a||s.length===1&&s[0].dataset.detached==="true"&&!a.dataset.id)return;const i=document.querySelector(".av__mask"),l=n.getAttribute("data-av-id");if(t==="template"){const o=s[0].getAttribute("data-col-id"),r=i.querySelector(".b3-text-field");r.value!==r.dataset.template&&transaction(e,[{action:"updateAttrViewColTemplate",id:o,avID:l,data:r.value,type:"template"}],[{action:"updateAttrViewColTemplate",id:o,avID:l,data:r.dataset.template,type:"template"}])}else Ns(e,n,t==="checkbox"?{checked:s[0].querySelector("use").getAttribute("xlink:href")==="#iconUncheck"}:i.querySelector(".b3-text-field").value,s);hasClosestByClassName(s[0],"custom-attr")||s[0].classList.add("av__cell--select"),document.querySelector(".b3-dialog")||focusBlock(n),document.querySelectorAll(".av__mask").forEach(o=>{o.remove()})},Ns=(e,t,n,s)=>{const a=[],i=[],l=t.dataset.avId,o=t.dataset.nodeId;let r="",c;return(s==null?void 0:s.length)>0?c=s:(c=Array.from(t.querySelectorAll(".av__cell--select")),c.length===0&&t.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(f=>{f.querySelectorAll(".av__cell").forEach(u=>{c.push(u)})})),c.forEach((f,u)=>{const d=hasClosestByClassName(f,"av__row");if(!d)return;t.contains(f)||(f=c[u]=t.querySelector(`.av__row[data-id="${d.dataset.id}"] .av__cell[data-col-id="${f.dataset.colId}"]`));const g=Jt(f)||f.dataset.type;if(["created","updated","template","rollup"].includes(g))return;const p=d.getAttribute("data-id"),b=f.getAttribute("data-id"),m=f.getAttribute("data-col-id");r+=$s(f);const h=On(g,f);if(g==="mAsset"){if(Array.isArray(n))n=h.mAsset.concat(n);else if(typeof n!="undefined")return}else g==="mSelect"&&typeof n=="string"&&(n=h.mSelect.concat({content:n,color:(h.mSelect.length+1).toString()}));const y=Hs(g,n);y.id=b,!(y.type==="date"&&typeof y.date=="string"||y.type==="relation"&&typeof y.relation=="string")&&(objEquals(y,h)||(a.push({action:"updateAttrViewCell",id:b,avID:l,keyID:m,rowID:p,data:y}),i.push({action:"updateAttrViewCell",id:b,avID:l,keyID:m,rowID:p,data:h}),hasClosestByClassName(c[0],"custom-attr")?f.innerHTML=genAVValueHTML(y):updateAttrViewCellAnimation(f,y)))}),a.length>0&&(a.push({action:"doUpdateUpdated",id:o,data:dayjs().format("YYYYMMDDHHmmss")}),i.push({action:"doUpdateUpdated",id:o,data:t.getAttribute("updated")}),transaction(e,a,i)),r},tn=e=>{var t,n,s,a,i,l,o;let r="";if(["text","template"].includes(e.type))r=`<span class="av__celltext">${e&&e[e.type].content||""}</span>`;else if(["url","email","phone"].includes(e.type)){const c=e?e[e.type].content:"";let f="";e.type==="url"&&(f=` data-href="${c}"`),r=`<span class="av__celltext av__celltext--url" data-type="${e.type}"${f}>${c}</span>`}else if(e.type==="block")e!=null&&e.isDetached?r=`<span class="av__celltext">${e.block.content||""}</span>
<span class="b3-chip b3-chip--info b3-chip--small" data-type="block-more">${window.siyuan.languages.more}</span>`:r=`<span data-type="block-ref" data-id="${e.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${e.block.content||"Untitled"}</span>
<span class="b3-chip b3-chip--info b3-chip--small popover__block" data-id="${e.block.id}" data-type="block-more">${window.siyuan.languages.update}</span>`;else if(e.type==="number")r=`<span class="av__celltext" data-content="${e!=null&&e.number.isNotEmpty?e==null?void 0:e.number.content:""}">${(e==null?void 0:e.number.formattedContent)||(e==null?void 0:e.number.content)||""}</span>`;else if(e.type==="mSelect"||e.type==="select")(t=e==null?void 0:e.mSelect)==null||t.forEach(c=>{r+=`<span class="b3-chip" style="background-color:var(--b3-font-background${c.color});color:var(--b3-font-color${c.color})">${c.content}</span>`});else if(e.type==="date"){const c=e?e.date:null;r=`<span class="av__celltext" data-value='${JSON.stringify(c)}'>`,c&&c.isNotEmpty&&(r+=ct(c.content).format(c.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),c&&c.hasEndDate&&c.isNotEmpty&&c.isNotEmpty2&&(r+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${ct(c.content2).format(c.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),r+="</span>"}else if(["created","updated"].includes(e.type)){const c=e?e[e.type]:null;r=`<span class="av__celltext" data-value='${JSON.stringify(c)}'>`,c&&c.isNotEmpty&&(r+=ct(c.content).format("YYYY-MM-DD HH:mm")),r+="</span>"}else e.type==="mAsset"?(n=e==null?void 0:e.mAsset)==null||n.forEach(c=>{c.type==="image"?r+=`<img class="av__cellassetimg" src="${c.content}">`:r+=`<span class="b3-chip av__celltext--url" data-url="${c.content}">${c.name}</span>`}):e.type==="checkbox"?r+=`<svg class="av__checkbox"><use xlink:href="#icon${(s=e==null?void 0:e.checkbox)!=null&&s.checked?"Check":"Uncheck"}"></use></svg>`:e.type==="rollup"?((i=(a=e==null?void 0:e.rollup)==null?void 0:a.contents)==null||i.forEach(c=>{const f=["select","mSelect","mAsset","checkbox","relation"].includes(c.type)?tn(c):Bs(c);f&&(r+=f+", ")}),r&&r.endsWith(", ")&&(r=r.substring(0,r.length-2))):e.type==="relation"&&((o=(l=e==null?void 0:e.relation)==null?void 0:l.contents)==null||o.forEach((c,f)=>{var u;r+=`<span class="av__celltext--ref" style="margin-right: 8px" data-id="${(u=e==null?void 0:e.relation)==null?void 0:u.blockIDs[f]}">${c||"Untitled"}</span>`}));return["text","template","url","email","phone","number","date","created","updated"].includes(e.type)&&e&&e[e.type].content&&(r+=`<span ${e.type!=="number"?"":'style="right:auto;left:5px"'} data-type="copy" class="block__icon"><svg><use xlink:href="#iconCopy"></use></svg></span>`),r},Bs=e=>{var t,n,s;let a="";if(["text"].includes(e.type))a=e&&e[e.type].content||"";else if(["url","email","phone"].includes(e.type)){const i=e?e[e.type].content:"";if(i){let l="";e.type==="url"&&(l=` data-href="${i}"`),a=`<span class="av__celltext av__celltext--url" data-type="${e.type}"${l}>${i}</span>`}}else if(e.type==="block")e!=null&&e.isDetached?a=`<span class="av__celltext">${((t=e.block)==null?void 0:t.content)||""}</span>`:a=`<span data-type="block-ref" data-id="${(n=e.block)==null?void 0:n.id}" data-subtype="s" class="av__celltext av__celltext--ref">${((s=e.block)==null?void 0:s.content)||"Untitled"}</span>`;else if(e.type==="number")a=(e==null?void 0:e.number.formattedContent)||(e==null?void 0:e.number.content.toString())||"";else if(e.type==="date"){const i=e?e.date:null;i&&i.isNotEmpty&&(a+=ct(i.content).format(i.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),i&&i.hasEndDate&&i.isNotEmpty&&i.isNotEmpty2&&(a+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${ct(i.content2).format(i.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),a&&(a=`<span class="av__celltext">${a}</span>`)}return a},Nr=(e,t)=>{var n;if(typeof t.icon!="undefined"&&(e.dataset.icon=t.icon,e.querySelector(".av__cellheadericon").outerHTML=t.icon?unicode2Emoji(t.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${getColIconByType(e.dataset.dtype)}"></use></svg>`),typeof t.name!="undefined"&&(e.querySelector(".av__celltext").textContent=t.name),typeof t.pin!="undefined"){const s=e.querySelector(".av__celltext");t.pin?e.querySelector(".av__cellheadericon--pin")||s.insertAdjacentHTML("afterend",'<svg class="av__cellheadericon av__cellheadericon--pin"><use xlink:href="#iconPin"></use></svg>'):(n=e.querySelector(".av__cellheadericon--pin"))==null||n.remove()}},Br=e=>{let t=hasClosestByClassName(e,"av__row");if(!t)return;let n=-1;for(;t;)t=t.previousElementSibling,n++;let s=-2;for(;e;)e=e.previousElementSibling,e&&e.classList.contains("av__colsticky")&&(e=e.lastElementChild),s++;return{rowIndex:n,celIndex:s}},Pr=(e,t,n,s)=>{var a;(a=t.querySelector(".av__drag-fill"))==null||a.remove();const i={};t.querySelectorAll(".av__cell--active").forEach(f=>{if(s.includes(f.dataset.id))return;const u=hasClosestByClassName(f,"av__row");if(!u)return;i[u.dataset.id]||(i[u.dataset.id]=[]);const d=On(Jt(f),f);d.colId=f.dataset.colId,d.element=f,i[u.dataset.id].push(d)});const l=[],o=[],r=t.dataset.avId,c=Object.keys(n);Object.keys(i).forEach((f,u)=>{i[f].forEach((d,g)=>{if(["rollup","template","created","updated"].includes(d.type))return;const p=n[c[u%c.length]][g];p.id=d.id;const b=d.colId;p.type==="block"&&(p.isDetached=!0,delete p.block.id),l.push({action:"updateAttrViewCell",id:d.id,avID:r,keyID:b,rowID:f,data:p}),d.element.innerHTML=tn(p),delete d.colId,delete d.element,o.push({action:"updateAttrViewCell",id:d.id,avID:r,keyID:b,rowID:f,data:d})})}),focusBlock(t),l.length>0&&transaction(e,l,o)};var Ps=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const nn=e=>{if(["select","number","date","created","updated"].includes(e))return"=";if(["checkbox"].includes(e))return"Is false";if(["rollup","relation","rollup","text","mSelect","url","block","email","phone","template"].includes(e))return"Contains"},qn=(e,t,n)=>{const s=hasClosestByClassName(e,"b3-menu");s&&s.querySelectorAll("input, .b3-chip").forEach((a,i)=>{const l=hasClosestByClassName(a,"b3-menu__item");l&&(["date","updated","created"].includes(n)?t==="Is between"?l.classList.remove("fn__none"):t==="Is empty"||t==="Is not empty"?l.classList.add("fn__none"):i===0?l.classList.remove("fn__none"):l.classList.add("fn__none"):t!=="Is empty"&&t!=="Is not empty"?l.classList.remove("fn__none"):l.classList.add("fn__none"))})},Rs=e=>Ps(void 0,null,function*(){var t,n;let s=e.target.getBoundingClientRect();s.height===0&&(s=e.protyle.wysiwyg.element.querySelector(`[data-col-id="${e.target.dataset.colId}"]`).getBoundingClientRect());const a=new Menu("set-filter-"+e.filter.column,()=>{const f=JSON.parse(JSON.stringify(e.data.view.filters)),u=window.siyuan.menus.menu.element.querySelector(".b3-select"),d=u.value;if(!u||!d)return;let g=!1,p;if(c.length>0)["date","updated","created"].includes(o)?p=genCellValue(o,{isNotEmpty2:c[1].value!=="",isNotEmpty:c[0].value!=="",content:c[0].value?new Date(c[0].value+" 00:00").getTime():null,content2:c[1].value?new Date(c[1].value+" 00:00").getTime():null,hasEndDate:d==="Is between",isNotTime:!0}):p=genCellValue(o,c[0].value);else if(o==="select"||o==="mSelect"){const y=[];window.siyuan.menus.menu.element.querySelectorAll("svg").forEach(k=>{if(k.firstElementChild.getAttribute("xlink:href")==="#iconCheck"){const E=k.nextElementSibling.firstElementChild;y.push({color:E.dataset.color,content:E.dataset.name})}}),p=genCellValue(o,y)}else o==="checkbox"?p=genCellValue(o,{checked:d==="Is true"}):p=genCellValue(o,void 0);const b={column:e.filter.column,value:p,operator:d};let m=!1;if(e.data.view.filters.find((y,k)=>{if(y.column===e.filter.column)return y.type&&y.type==="checkbox"?(g=!0,delete y.type,e.data.view.filters[k]=b,!0):(delete y.type,objEquals(y,b)?(m=!0,!0):(e.data.view.filters[k]=b,g=!0,!0))}),m||!g)return;transaction(e.protyle,[{action:"setAttrViewFilters",avID:e.data.id,data:e.data.view.filters}],[{action:"setAttrViewFilters",avID:e.data.id,data:f}]);const h=hasClosestByClassName(e.target,"b3-menu");h&&(h.innerHTML=an(e.data.view))});if(a.isOpen)return;let i="",l;e.data.view.columns.find(f=>{if(f.id===e.filter.column)return l=f,!0});let o=l.type;if(o==="rollup"){if(!l.rollup||!l.rollup.relationKeyID||!l.rollup.keyID){showMessage(window.siyuan.languages.plsChoose),openMenuPanel({protyle:e.protyle,blockElement:e.blockElement,type:"edit",colId:l.id});return}let f="";e.data.view.columns.find(d=>{if(d.id===l.rollup.relationKeyID)return f=d.relation.avID,!0}),(yield fetchSyncPost("/api/av/getAttributeView",{id:f})).data.av.keyValues.find(d=>{if(d.key.id===l.rollup.keyID)return o=d.key.type,!0}),e.data.view.filters.find(d=>{if(d.column===l.id&&d.type)return d.operator=nn(o),d.value=genCellValue(o,""),delete d.type,!0})}switch(o){case"checkbox":i=`<option ${e.filter.operator==="Is true"&&!e.filter.type?"selected":""} value="Is true">${window.siyuan.languages.checked}</option>
<option ${e.filter.operator==="Is false"&&!e.filter.type?"selected":""} value="Is false">${window.siyuan.languages.unchecked}</option>`,e.filter.type&&(i=`<option selected></option>${i}`);break;case"block":case"text":case"url":case"phone":case"email":i=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${e.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${e.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${e.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${e.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"template":i=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${e.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${e.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${e.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${e.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>
<option ${e.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${e.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${e.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${e.filter.operator==="<="?"selected":""} value="<=">&le;</option>`;break;case"date":case"created":case"updated":i=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator===">"?"selected":""} value=">">${window.siyuan.languages.filterOperatorIsAfter}</option>
<option ${e.filter.operator==="<"?"selected":""} value="<">${window.siyuan.languages.filterOperatorIsBefore}</option>
<option ${e.filter.operator===">="?"selected":""} value=">=">${window.siyuan.languages.filterOperatorIsOnOrAfter}</option>
<option ${e.filter.operator==="<="?"selected":""} value="<=">${window.siyuan.languages.filterOperatorIsOnOrBefore}</option>
<option ${e.filter.operator==="Is between"?"selected":""} value="Is between">${window.siyuan.languages.filterOperatorIsBetween}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"number":i=`<option ${e.filter.operator==="="?"selected":""} value="=">=</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">!=</option>
<option ${e.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${e.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${e.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${e.filter.operator==="<="?"selected":""} value="<=">&le;</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"mSelect":case"relation":i=`<option ${e.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${e.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"select":i=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break}if(a.addItem({iconHTML:"",type:"readonly",label:`<select style="margin: 4px 0" class="b3-select fn__size200">${i}</select>`}),o==="select"||o==="mSelect")(t=l.options)==null||t.forEach(f=>{var u,d;let g="iconUncheck";(d=(u=e.filter.value)==null?void 0:u.mSelect)==null||d.find(p=>{p.content===f.name&&(g="iconCheck")}),a.addItem({icon:g,label:`<span class="b3-chip b3-chip--middle" data-name="${f.name}" data-color="${f.color}" style="margin:3px 0;background-color:var(--b3-font-background${f.color});color:var(--b3-font-color${f.color})">
    <span class="fn__ellipsis">${f.name}</span>
</span>`,bind(p){p.addEventListener("click",()=>{const b=p.querySelector("use");b.getAttribute("xlink:href")==="#iconUncheck"?b.setAttribute("xlink:href","#iconCheck"):b.setAttribute("xlink:href","#iconUncheck")})}})});else if(["text","url","block","email","phone","template","relation"].includes(o)){let f="";e.filter.value&&(o==="relation"?f=e.filter.value.relation.contents[0]||"":f=e.filter.value[o].content||""),a.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${f}" class="b3-text-field fn__size200">`})}else if(o==="number")a.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${(n=e.filter.value)!=null&&n.number.isNotEmpty?e.filter.value.number.content:""}" class="b3-text-field fn__size200">`});else if(["date","updated","created"].includes(o)){const f=e.filter.value?e.filter.value[o]:null;a.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${f.isNotEmpty||o!=="date"?dayjs(f.content).format("YYYY-MM-DD"):""}" type="date" max="9999-12-31" class="b3-text-field fn__size200">`}),a.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${f.isNotEmpty2?dayjs(f.content2).format("YYYY-MM-DD"):""}" type="date" max="9999-12-31" class="b3-text-field fn__size200">`})}a.addItem({icon:"iconTrashcan",label:window.siyuan.languages.removeFilters,click(){const f=Object.assign([],e.data.view.filters);e.data.view.filters.find((d,g)=>{if(d.column===e.filter.column)return e.data.view.filters.splice(g,1),!0}),transaction(e.protyle,[{action:"setAttrViewFilters",avID:e.data.id,data:e.data.view.filters}],[{action:"setAttrViewFilters",avID:e.data.id,data:f}]);const u=hasClosestByClassName(e.target,"b3-menu");u&&(u.innerHTML=an(e.data.view))}});const r=window.siyuan.menus.menu.element.querySelector(".b3-select");r.addEventListener("change",()=>{qn(r,r.value,o)});const c=window.siyuan.menus.menu.element.querySelectorAll(".b3-text-field");c.forEach(f=>{f.addEventListener("keydown",u=>{if(u.isComposing){u.preventDefault();return}u.key==="Enter"&&(a.close(),u.preventDefault())})}),qn(r,r.value,o),a.open({x:s.left,y:s.bottom}),c.length>0&&c[0].select()}),Rr=e=>{const t=new Menu("av-add-filter");e.data.view.columns.forEach(n=>{let s=!1;e.data.view.filters.find(a=>{if(a.column===n.id)return s=!0,!0}),!s&&n.type!=="mAsset"&&t.addItem({label:n.name,iconHTML:n.icon?unicode2Emoji(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(n.type)}"></use></svg>`,click:()=>{const a=genCellValue(n.type,"");e.data.view.filters.push({column:n.id,operator:nn(n.type),value:a,type:n.type}),e.menuElement.innerHTML=an(e.data.view),setPosition(e.menuElement,e.tabRect.right-e.menuElement.clientWidth,e.tabRect.bottom,e.tabRect.height);const i=e.menuElement.querySelector(`[data-id="${n.id}"] .b3-chip`);Rs({filter:{operator:nn(n.type),column:n.id,value:a},protyle:e.protyle,data:e.data,target:i,blockElement:e.blockElement})}})}),t.open({x:e.rect.left,y:e.rect.bottom,h:e.rect.height})},an=e=>{let t="";const n=s=>{let a="";return e.columns.find(i=>{var l,o,r,c,f,u,d,g,p,b,m,h,y,k,E,A,v,S,w,_,C,x,T,B,D,H,O,$,U,ee,ie,Y;if(i.id===s.column){let ne="";if(s.operator==="Is empty")ne=": "+window.siyuan.languages.filterOperatorIsEmpty;else if(s.operator==="Is not empty")ne=": "+window.siyuan.languages.filterOperatorIsNotEmpty;else if(s.operator==="Is false")ne=": "+window.siyuan.languages.unchecked;else if(s.operator==="Is true")ne=": "+window.siyuan.languages.checked;else if((o=(l=s.value)==null?void 0:l.date)!=null&&o.content)(c=(r=s.value)==null?void 0:r.date)!=null&&c.content2&&s.operator==="Is between"?ne=` ${window.siyuan.languages.filterOperatorIsBetween} ${dayjs(s.value.date.content).format("YYYY-MM-DD")} ${dayjs(s.value.date.content2).format("YYYY-MM-DD")}`:s.operator==="="?ne=`: ${dayjs(s.value.date.content).format("YYYY-MM-DD")}`:[">","<"].includes(s.operator)?ne=` ${s.operator} ${dayjs(s.value.date.content).format("YYYY-MM-DD")}`:s.operator===">="?ne=` \u2265 ${dayjs(s.value.date.content).format("YYYY-MM-DD")}`:s.operator==="<="&&(ne=` \u2264 ${dayjs(s.value.date.content).format("YYYY-MM-DD")}`);else if(((u=(f=s.value)==null?void 0:f.mSelect)==null?void 0:u.length)>0){let V="";s.value.mSelect.forEach((Ie,He)=>{V+=Ie.content,He!==s.value.mSelect.length-1&&(V+=", ")}),s.operator==="Contains"?ne=`: ${V}`:s.operator==="Does not contains"&&(ne=` ${window.siyuan.languages.filterOperatorDoesNotContain} ${V}`)}else if((g=(d=s.value)==null?void 0:d.number)!=null&&g.content)["=","!=",">","<"].includes(s.operator)?ne=` ${s.operator} ${s.value.number.content}`:s.operator===">="?ne=` \u2265 ${s.value.number.content}`:s.operator==="<="&&(ne=` \u2264 ${s.value.number.content}`);else if((b=(p=s.value)==null?void 0:p.text)!=null&&b.content||(h=(m=s.value)==null?void 0:m.block)!=null&&h.content||(k=(y=s.value)==null?void 0:y.url)!=null&&k.content||(A=(E=s.value)==null?void 0:E.phone)!=null&&A.content||(S=(v=s.value)==null?void 0:v.email)!=null&&S.content||((_=(w=s.value)==null?void 0:w.relation)==null?void 0:_.contents.length)>0){const V=((x=(C=s.value)==null?void 0:C.text)==null?void 0:x.content)||((B=(T=s.value)==null?void 0:T.block)==null?void 0:B.content)||((H=(D=s.value)==null?void 0:D.url)==null?void 0:H.content)||(($=(O=s.value)==null?void 0:O.phone)==null?void 0:$.content)||((ee=(U=s.value)==null?void 0:U.email)==null?void 0:ee.content)||((Y=(ie=s.value)==null?void 0:ie.relation)==null?void 0:Y.contents[0]);["=","Contains"].includes(s.operator)?ne=`: ${V}`:s.operator==="Does not contains"?ne=` ${window.siyuan.languages.filterOperatorDoesNotContain} ${V}`:s.operator==="!="?ne=` ${window.siyuan.languages.filterOperatorIsNot} ${V}`:s.operator==="Starts with"?ne=` ${window.siyuan.languages.filterOperatorStartsWith} ${V}`:s.operator==="Ends with"&&(ne=` ${window.siyuan.languages.filterOperatorEndsWith} ${V}`)}return a+=`<span data-type="setFilter" class="b3-chip${ne?" b3-chip--primary":""}">
    ${i.icon?unicode2Emoji(i.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${getColIconByType(i.type)}"></use></svg>`}
    <span class="fn__ellipsis">${i.name}${ne}</span>
</span>`,!0}}),a};return e.filters.forEach(s=>{t+=`<button class="b3-menu__item" draggable="true" data-id="${s.column}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">${n(s)}</div>
    <svg class="b3-menu__action" data-type="removeFilter"><use xlink:href="#iconTrashcan"></use></svg>
</button>`}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.filter}</span>
</button>
<button class="b3-menu__separator"></button>
${t}
<button class="b3-menu__item${e.filters.length===e.columns.length?" fn__none":""}" data-type="addFilter">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.addFilter}</span>
</button>
<button class="b3-menu__item${t?"":" fn__none"}" data-type="removeFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.removeFilters}</span>
</button>
</div>`},Os=e=>{const t=Lute.NewNodeID(),n=e.newValue.match(/^(.*) \((\d+)\)$/);n?e.newValue=`${n[1]} (${parseInt(n[2])+1})`:e.newValue=`${e.newValue} (1)`,["select","mSelect","rollup"].includes(e.type)?fetchPost("/api/av/renderAttributeView",{id:e.avID},s=>{const a=s.data;let i;a.view.columns.find(l=>{if(l.id===e.colId)return i=l.options,!0}),transaction(e.protyle,[{action:"addAttrViewCol",name:e.newValue,avID:e.avID,type:e.type,data:e.icon,previousID:e.colId,id:t},{action:"updateAttrViewColOptions",id:t,avID:e.avID,data:i}],[{action:"removeAttrViewCol",id:t,avID:e.avID}])}):transaction(e.protyle,[{action:"addAttrViewCol",name:e.newValue,avID:e.avID,type:e.type,data:e.icon,id:t,previousID:e.colId}],[{action:"removeAttrViewCol",id:t,avID:e.avID}]),we({blockElement:e.protyle.wysiwyg.element.querySelector(`[data-av-id="${e.avID}"]`),protyle:e.protyle,type:e.type,name:e.newValue,icon:e.icon,previousID:e.colId,id:t})},qs=e=>{var t,n,s;let a;e.data.view.columns.find(l=>{if(l.id===e.colId)return a=l,!0});let i=`<button class="b3-menu__item" data-type="nobg" data-col-id="${e.colId}">
    <span class="block__icon${e.isCustomAttr?" fn__none":""}" style="padding: 8px;margin-left: -4px;" data-type="go-properties">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span style="padding: 5px;margin-right: 8px;width: 14px;font-size: 14px;" class="block__icon block__icon--show" data-col-type="${a.type}" data-icon="${a.icon}" data-type="update-icon">${a.icon?unicode2Emoji(a.icon):`<svg><use xlink:href="#${Ge(a.type)}"></use></svg>`}</span>
    <span class="b3-menu__label" style="padding: 4px;display: flex;"><input data-type="name" class="b3-text-field fn__block" type="text" value="${a.name}"></span>
</button>
<button class="b3-menu__item" data-type="goUpdateColType">
    <span class="b3-menu__label">${window.siyuan.languages.type}</span>
    <span class="fn__space"></span>
    <svg class="b3-menu__icon"><use xlink:href="#${Ge(a.type)}"></use></svg>
    <span class="b3-menu__accelerator" style="margin-left: 0">${Fn(a.type)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`;if(a.options&&a.options.length>0)i+=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label" style="padding: 4px;display: flex"><input data-type="addOption" class="b3-text-field fn__block fn__size200" type="text" placeholder="Enter ${window.siyuan.languages.addAttr}"></span>
</button>`,a.options.forEach(l=>{i+=`<button class="b3-menu__item${i?"":" b3-menu__item--current"}" draggable="true" data-name="${l.name}" data-color="${l.color}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip" style="background-color:var(--b3-font-background${l.color});color:var(--b3-font-color${l.color})">
            <span class="fn__ellipsis">${l.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
</button>`});else if(a.type==="number")i+=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="numberFormat" data-format="${a.numberFormat}">
    <svg class="b3-menu__icon"><use xlink:href="#iconFormat"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.format}</span>
    <span class="b3-menu__accelerator">${getLabelByNumberFormat(a.numberFormat)}</span>
</button>`;else if(a.type==="template")i+=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item">
    <textarea rows="${a.template.split(`
`).length}" placeholder="${window.siyuan.languages.template}" data-type="updateTemplate" style="margin: 4px 0" rows="1" class="fn__block b3-text-field">${a.template}</textarea>
</button>`;else if(a.type==="relation"){const l=((t=a.relation)==null?void 0:t.avID)===e.data.id;i+=`<button class="b3-menu__item" data-type="goSearchAV" data-av-id="${((n=a.relation)==null?void 0:n.avID)||""}" data-old-value='${JSON.stringify(a.relation||{})}'>
    <span class="b3-menu__label">${window.siyuan.languages.relatedTo}</span>
    <span class="b3-menu__accelerator">${l?window.siyuan.languages.thisDatabase:""}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item fn__none">
    <span class="fn__flex-center">${window.siyuan.languages.backRelation}</span>
    <svg class="b3-menu__icon b3-menu__icon--small fn__none"><use xlink:href="#iconHelp"></use></svg>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="backRelation" type="checkbox" class="b3-switch b3-switch--menu" ${(s=a.relation)!=null&&s.isTwoWay?"checked":""}>
</label>
<div class="b3-menu__item fn__flex-column fn__none" data-type="nobg">
    <input data-old-value="" data-type="colName" style="margin: 8px 0 4px" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.title}">
</div>
<div class="b3-menu__item fn__flex-column fn__none" data-type="nobg">
    <button style="margin: 4px 0 8px;" class="b3-button fn__block" data-type="updateRelation">${window.siyuan.languages.confirm}</button>
</div>`}else a.type==="rollup"&&(i+=getRollupHTML({colData:a}));return`<div class="b3-menu__items">
    ${i}
    <button class="b3-menu__separator"></button>
    <button class="b3-menu__item${e.isCustomAttr?" fn__none":""}" data-type="${a.hidden?"showCol":"hideCol"}">
        <svg class="b3-menu__icon" style=""><use xlink:href="#icon${a.hidden?"Eye":"Eyeoff"}"></use></svg>
        <span class="b3-menu__label">${a.hidden?window.siyuan.languages.showCol:window.siyuan.languages.hideCol}</span>
    </button>
    <button class="b3-menu__item${a.type==="relation"?" fn__none":""}" data-type="duplicateCol">
        <svg class="b3-menu__icon" style=""><use xlink:href="#iconCopy"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
    </button>
    <button class="b3-menu__item" data-type="removeCol">
        <svg class="b3-menu__icon" style=""><use xlink:href="#iconTrashcan"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
    </button>
</div>
<div class="b3-menu__items fn__none">
    <button class="b3-menu__item" data-type="nobg" data-col-id="${a.id}">
        <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goEditCol">
            <svg><use xlink:href="#iconLeft"></use></svg>
        </span>
        <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
    </button>
    <button class="b3-menu__separator"></button>
    ${_e("text",a.type,a.name)}
    ${_e("number",a.type,a.name)}
    ${_e("select",a.type,a.name)}
    ${_e("mSelect",a.type,a.name)}
    ${_e("date",a.type,a.name)}
    ${_e("mAsset",a.type,a.name)}
    ${_e("checkbox",a.type,a.name)}
    ${_e("url",a.type,a.name)}
    ${_e("email",a.type,a.name)}
    ${_e("phone",a.type,a.name)}
    ${_e("template",a.type,a.name)}
    ${_e("relation",a.type,a.name)}
    ${_e("rollup",a.type,a.name)}
    ${_e("created",a.type,a.name)}
    ${_e("updated",a.type,a.name)}
</div>`},Fs=e=>{const t=e.data.id,n=e.menuElement.querySelector(".b3-menu__item").getAttribute("data-col-id"),s=e.data.view.columns.find(r=>r.id===n),a=e.menuElement.querySelector('[data-type="name"]');a.addEventListener("blur",()=>{const r=a.value;r!==s.name&&(transaction(e.protyle,[{action:"updateAttrViewCol",id:n,avID:t,name:r,type:s.type}],[{action:"updateAttrViewCol",id:n,avID:t,name:s.name,type:s.type}]),s.name=r,updateAttrViewCellAnimation(e.protyle.wysiwyg.element.querySelector(`.av__row--header .av__cell[data-col-id="${n}"]`),void 0,{name:r}))}),a.addEventListener("keydown",r=>{r.isComposing||(r.key==="Escape"?e.menuElement.parentElement.remove():r.key==="Enter"&&(a.dispatchEvent(new CustomEvent("blur")),e.menuElement.parentElement.remove()))}),a.select();const i=e.menuElement.querySelector('[data-type="updateTemplate"]');i&&(i.addEventListener("blur",()=>{const r=i.value;r!==s.template&&(transaction(e.protyle,[{action:"updateAttrViewColTemplate",id:n,avID:t,data:r,type:s.type}],[{action:"updateAttrViewColTemplate",id:n,avID:t,data:s.template,type:s.type}]),s.template=r)}),i.addEventListener("keydown",r=>{r.isComposing||(r.key==="Escape"?e.menuElement.parentElement.remove():r.key==="Enter"&&!r.shiftKey&&(i.dispatchEvent(new CustomEvent("blur")),e.menuElement.parentElement.remove()))}));const l=e.menuElement.querySelector('[data-type="addOption"]');l&&l.addEventListener("keydown",r=>{if(!r.isComposing&&(r.key==="Escape"&&e.menuElement.parentElement.remove(),r.key==="Enter")){let c=!1;if(s.options.find(f=>{if(l.value===f.name)return c=!0,!0}),c||!l.value)return;s.options.push({color:(s.options.length+1).toString(),name:l.value}),transaction(e.protyle,[{action:"updateAttrViewColOptions",id:n,avID:t,data:s.options}],[{action:"removeAttrViewColOption",id:n,avID:t,data:l.value}]),e.menuElement.innerHTML=qs({protyle:e.protyle,colId:n,data:e.data,isCustomAttr:e.isCustomAttr}),Fs({protyle:e.protyle,menuElement:e.menuElement,data:e.data,isCustomAttr:e.isCustomAttr}),e.menuElement.querySelector('[data-type="addOption"]').focus()}});const o=e.menuElement.querySelector('[data-type="backRelation"]');if(o){o.addEventListener("change",()=>{toggleUpdateRelationBtn(e.menuElement,t)});const r=e.menuElement.querySelector('[data-type="goSearchAV"]'),c=JSON.parse(r.getAttribute("data-old-value")),f=e.menuElement.querySelector('[data-type="colName"]');f.addEventListener("input",()=>{toggleUpdateRelationBtn(e.menuElement,t)}),c.avID?fetchPost("/api/av/getAttributeView",{id:c.avID},u=>{r.querySelector(".b3-menu__accelerator").textContent=c.avID===t?window.siyuan.languages.thisDatabase:u.data.av.name||window.siyuan.languages.title,u.data.av.keyValues.find(d=>{if(d.key.id===c.backKeyID)return f.setAttribute("data-old-value",d.key.name||window.siyuan.languages.title),f.value=d.key.name||window.siyuan.languages.title,!0}),toggleUpdateRelationBtn(e.menuElement,t)}):toggleUpdateRelationBtn(e.menuElement,t)}bindRollupEvent(e)},Fn=e=>{switch(e){case"text":case"number":case"select":case"date":case"phone":case"email":case"template":return window.siyuan.languages[e];case"mSelect":return window.siyuan.languages.multiSelect;case"relation":return window.siyuan.languages.relation;case"rollup":return window.siyuan.languages.rollup;case"updated":return window.siyuan.languages.updatedTime;case"created":return window.siyuan.languages.createdTime;case"url":return window.siyuan.languages.link;case"mAsset":return window.siyuan.languages.assets;case"checkbox":return window.siyuan.languages.checkbox}},Ge=e=>{switch(e){case"text":return"iconAlignLeft";case"block":return"iconKey";case"number":return"iconNumber";case"select":return"iconListItem";case"mSelect":return"iconList";case"relation":return"iconOpen";case"rollup":return"iconSearch";case"date":return"iconCalendar";case"updated":case"created":return"iconClock";case"url":return"iconLink";case"mAsset":return"iconImage";case"email":return"iconEmail";case"phone":return"iconPhone";case"template":return"iconMath";case"checkbox":return"iconCheck"}},we=e=>{!e.blockElement||!e.blockElement.classList.contains("av")||(e.blockElement.querySelectorAll(".av__row").forEach((t,n)=>{let s;e.previousID?s=t.querySelector(`[data-col-id="${e.previousID}"]`):s=t.lastElementChild.previousElementSibling;let a="";n===0?a=`<div class="av__cell av__cell--header" draggable="true" data-icon="${e.icon||""}" data-col-id="${e.id}" data-dtype="${e.type}" data-wrap="false" style="width: 200px;">
    ${e.icon?unicode2Emoji(e.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${Ge(e.type)}"></use></svg>`}
    <span class="av__celltext fn__flex-1">${e.name}</span>
    <div class="av__widthdrag av__pulse"></div>
</div>`:a='<div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>',s.insertAdjacentHTML("afterend",a)}),window.siyuan.menus.menu.remove())},Or=(e,t,n)=>{const s=n.getAttribute("data-dtype"),a=n.getAttribute("data-col-id"),i=t.getAttribute("data-av-id"),l=n.querySelector(".av__celltext").textContent.trim(),o=new Menu("av-header-cell",()=>{const u=o.element.querySelector(".b3-text-field").value;u!==l&&(transaction(e,[{action:"updateAttrViewCol",id:a,avID:i,name:u,type:s}],[{action:"updateAttrViewCol",id:a,avID:i,name:l,type:s}]),updateAttrViewCellAnimation(t.querySelector(`.av__row--header .av__cell[data-col-id="${a}"]`),void 0,{name:u}),focusBlock(t))});o.addItem({iconHTML:`<span style="align-self: center;margin-right: 8px;width: 14px;" class="block__icon block__icon--show">${n.dataset.icon?unicode2Emoji(n.dataset.icon):`<svg><use xlink:href="#${Ge(s)}"></use></svg>`}</span>`,type:"readonly",label:`<input style="margin: 4px 0" class="b3-text-field fn__block fn__size200" type="text" value="${l}">`,bind(u){const d=u.querySelector(".block__icon");d.setAttribute("data-icon",n.dataset.icon),d.addEventListener("click",g=>{const p=d.getBoundingClientRect();openEmojiPanel("","av",{x:p.left,y:p.bottom,h:p.height,w:p.width},b=>{transaction(e,[{action:"setAttrViewColIcon",id:a,avID:i,data:b}],[{action:"setAttrViewColIcon",id:a,avID:i,data:n.dataset.icon}]),d.setAttribute("data-icon",b),d.innerHTML=b?unicode2Emoji(b):`<svg><use xlink:href="#${Ge(s)}"></use></svg>`,updateAttrViewCellAnimation(t.querySelector(`.av__row--header .av__cell[data-col-id="${a}"]`),void 0,{icon:b})}),g.preventDefault(),g.stopPropagation()}),u.querySelector("input").addEventListener("keydown",g=>{g.isComposing||g.key==="Enter"&&(o.close(),g.preventDefault())})}}),s!=="block"&&o.addItem({icon:"iconEdit",label:window.siyuan.languages.edit,click(){const u=o.element.querySelector(".b3-text-field").value;openMenuPanel({protyle:e,blockElement:t,type:"edit",colId:a,cb(d){const g=d.querySelector('.b3-text-field[data-type="name"]');g.value=u,g.select()}})}}),o.addSeparator(),o.addItem({icon:"iconUp",label:window.siyuan.languages.asc,click(){fetchPost("/api/av/renderAttributeView",{id:i},u=>{transaction(e,[{action:"setAttrViewSorts",avID:u.data.id,data:[{column:a,order:"ASC"}]}],[{action:"setAttrViewSorts",avID:u.data.id,data:u.data.view.sorts}])})}}),o.addItem({icon:"iconDown",label:window.siyuan.languages.desc,click(){fetchPost("/api/av/renderAttributeView",{id:i},u=>{transaction(e,[{action:"setAttrViewSorts",avID:u.data.id,data:[{column:a,order:"DESC"}]}],[{action:"setAttrViewSorts",avID:u.data.id,data:u.data.view.sorts}])})}}),s!=="mAsset"&&o.addItem({icon:"iconFilter",label:window.siyuan.languages.filter,click(){fetchPost("/api/av/renderAttributeView",{id:i},u=>{const d=u.data;let g;d.view.filters.find(p=>{if(p.column===a)return g=p,!0}),g||(g={column:a,operator:getDefaultOperatorByType(s),value:genCellValue(s,""),type:s},d.view.filters.push(g)),setFilter({filter:g,protyle:e,data:d,blockElement:t,target:t.querySelector(`.av__row--header .av__cell[data-col-id="${a}"]`)})})}}),o.addSeparator(),o.addItem({icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,click(){var u;const d=Yn(e,t,((u=n.previousElementSibling)==null?void 0:u.getAttribute("data-col-id"))||""),g=n.getBoundingClientRect();d.open({x:g.left,y:g.bottom,h:g.height})}}),o.addItem({icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,click(){const u=Yn(e,t,n.getAttribute("data-col-id")||""),d=n.getBoundingClientRect();u.open({x:d.left,y:d.bottom,h:d.height})}}),s!=="block"&&o.addItem({icon:"iconEyeoff",label:window.siyuan.languages.hide,click(){transaction(e,[{action:"setAttrViewColHidden",id:a,avID:i,data:!0}],[{action:"setAttrViewColHidden",id:a,avID:i,data:!1}])}});const r=n.dataset.pin==="true";o.addItem({icon:r?"iconUnpin":"iconPin",label:r?window.siyuan.languages.unfreezeCol:window.siyuan.languages.freezeCol,click(){transaction(e,[{action:"setAttrViewColPin",id:a,avID:i,data:!r}],[{action:"setAttrViewColPin",id:a,avID:i,data:r}]),updateAttrViewCellAnimation(t.querySelector(`.av__row--header .av__cell[data-col-id="${a}"]`),void 0,{pin:!r})}}),s!=="block"&&(s!=="relation"&&o.addItem({icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){Os({protyle:e,type:s,avID:i,colId:a,icon:o.element.querySelector(".block__icon").getAttribute("data-icon"),newValue:window.siyuan.menus.menu.element.querySelector(".b3-text-field").value})}}),o.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){var u;transaction(e,[{action:"removeAttrViewCol",id:a,avID:i}],[{action:"addAttrViewCol",name:l,avID:i,type:s,id:a,previousID:((u=n.previousElementSibling)==null?void 0:u.getAttribute("data-col-id"))||""}]),removeAttrViewColAnimation(t,a)}}),o.addSeparator()),o.addItem({label:`<label class="fn__flex" style="margin: 4px 0;padding-right: 6px"><span>${window.siyuan.languages.wrap}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${n.dataset.wrap==="true"?" checked":""}></label>`,bind(u){const d=u.querySelector("input");d.addEventListener("change",()=>{transaction(e,[{action:"setAttrViewColWrap",id:a,avID:i,data:d.checked}],[{action:"setAttrViewColWrap",id:a,avID:i,data:!d.checked}])})}});const c=n.getBoundingClientRect();o.open({x:c.left,y:c.bottom,h:c.height});const f=window.siyuan.menus.menu.element.querySelector(".b3-text-field");f&&(f.select(),f.focus())},_e=(e,t,n)=>`<button class="b3-menu__item" data-type="updateColType"  data-name="${n}" data-old-type="${t}" data-new-type="${e}">
    <svg class="b3-menu__icon"><use xlink:href="#${Ge(e)}"></use></svg>
    <span class="b3-menu__label">${Fn(e)}</span>
    ${e===t?'<span class="b3-menu__accelerator"><svg class="svg" style="height: 30px; float: left;"><use xlink:href="#iconSelect"></use></svg></span>':""}
</button>`,Yn=(e,t,n)=>{const s=new Menu("av-header-add"),a=t.getAttribute("data-av-id");return typeof n=="undefined"&&(n=Array.from(t.querySelectorAll(".av__row--header .av__cell")).pop().getAttribute("data-col-id")),s.addItem({icon:"iconAlignLeft",label:window.siyuan.languages.text,click(){const i=Lute.NewNodeID();transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.text,avID:a,type:"text",id:i,previousID:n}],[{action:"removeAttrViewCol",id:i,avID:a}]),we({blockElement:t,protyle:e,type:"text",name:window.siyuan.languages.text,id:i,previousID:n})}}),s.addItem({icon:"iconNumber",label:window.siyuan.languages.number,click(){const i=Lute.NewNodeID();transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.number,avID:a,type:"number",id:i,previousID:n}],[{action:"removeAttrViewCol",id:i,avID:a}]),we({blockElement:t,protyle:e,type:"number",name:window.siyuan.languages.number,id:i,previousID:n})}}),s.addItem({icon:"iconListItem",label:window.siyuan.languages.select,click(){const i=Lute.NewNodeID();transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.select,avID:a,type:"select",id:i,previousID:n}],[{action:"removeAttrViewCol",id:i,avID:a}]),we({blockElement:t,protyle:e,type:"select",name:window.siyuan.languages.select,id:i,previousID:n})}}),s.addItem({icon:"iconList",label:window.siyuan.languages.multiSelect,click(){const i=Lute.NewNodeID();transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.multiSelect,avID:a,type:"mSelect",id:i,previousID:n}],[{action:"removeAttrViewCol",id:i,avID:a}]),we({blockElement:t,protyle:e,type:"mSelect",name:window.siyuan.languages.multiSelect,id:i,previousID:n})}}),s.addItem({icon:"iconCalendar",label:window.siyuan.languages.date,click(){const i=Lute.NewNodeID();transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.date,avID:a,type:"date",id:i,previousID:n}],[{action:"removeAttrViewCol",id:i,avID:a}]),we({blockElement:t,protyle:e,type:"date",name:window.siyuan.languages.date,id:i,previousID:n})}}),s.addItem({icon:"iconImage",label:window.siyuan.languages.assets,click(){const i=Lute.NewNodeID();transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.assets,avID:a,type:"mAsset",id:i,previousID:n}],[{action:"removeAttrViewCol",id:i,avID:a}]),we({blockElement:t,protyle:e,type:"mAsset",name:window.siyuan.languages.assets,id:i,previousID:n})}}),s.addItem({icon:"iconCheck",label:window.siyuan.languages.checkbox,click(){const i=Lute.NewNodeID();transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.checkbox,avID:a,type:"checkbox",id:i,previousID:n}],[{action:"removeAttrViewCol",id:i,avID:a}]),we({blockElement:t,protyle:e,type:"checkbox",name:window.siyuan.languages.checkbox,id:i,previousID:n})}}),s.addItem({icon:"iconLink",label:window.siyuan.languages.link,click(){const i=Lute.NewNodeID();transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.link,avID:a,type:"url",id:i,previousID:n}],[{action:"removeAttrViewCol",id:i,avID:a}]),we({blockElement:t,protyle:e,type:"url",name:window.siyuan.languages.link,id:i,previousID:n})}}),s.addItem({icon:"iconEmail",label:window.siyuan.languages.email,click(){const i=Lute.NewNodeID();transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.email,avID:a,type:"email",id:i,previousID:n}],[{action:"removeAttrViewCol",id:i,avID:a}]),we({blockElement:t,protyle:e,type:"email",name:window.siyuan.languages.email,id:i,previousID:n})}}),s.addItem({icon:"iconPhone",label:window.siyuan.languages.phone,click(){const i=Lute.NewNodeID();transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.phone,avID:a,type:"phone",id:i,previousID:n}],[{action:"removeAttrViewCol",id:i,avID:a}]),we({blockElement:t,protyle:e,type:"phone",name:window.siyuan.languages.phone,id:i,previousID:n})}}),s.addItem({icon:"iconMath",label:window.siyuan.languages.template,click(){const i=Lute.NewNodeID();transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.template,avID:a,type:"template",id:i,previousID:n}],[{action:"removeAttrViewCol",id:i,avID:a}]),we({blockElement:t,protyle:e,type:"template",name:window.siyuan.languages.template,id:i,previousID:n})}}),s.addItem({icon:"iconOpen",label:window.siyuan.languages.relation,click(){const i=Lute.NewNodeID();transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.relation,avID:a,type:"relation",id:i,previousID:n}],[{action:"removeAttrViewCol",id:i,avID:a}]),we({blockElement:t,protyle:e,type:"relation",name:window.siyuan.languages.relation,id:i,previousID:n})}}),s.addItem({icon:"iconSearch",label:window.siyuan.languages.rollup,click(){const i=Lute.NewNodeID();transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.rollup,avID:a,type:"rollup",id:i,previousID:n}],[{action:"removeAttrViewCol",id:i,avID:a}]),we({blockElement:t,protyle:e,type:"rollup",name:window.siyuan.languages.rollup,id:i,previousID:n})}}),s.addItem({icon:"iconClock",label:window.siyuan.languages.createdTime,click(){const i=Lute.NewNodeID();transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.createdTime,avID:a,type:"created",id:i,previousID:n}],[{action:"removeAttrViewCol",id:i,avID:a}]),we({blockElement:t,protyle:e,type:"created",name:window.siyuan.languages.createdTime,id:i,previousID:n})}}),s.addItem({icon:"iconClock",label:window.siyuan.languages.updatedTime,click(){const i=Lute.NewNodeID();transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.updatedTime,avID:a,type:"updated",id:i,previousID:n}],[{action:"removeAttrViewCol",id:i,avID:a}]),we({blockElement:t,protyle:e,type:"updated",name:window.siyuan.languages.updatedTime,id:i,previousID:n})}}),s},Wn=(e,t,n,s)=>{let a=[];e.getAttribute("data-type")==="NodeAttributeView"?a=[e]:a=Array.from(e.querySelectorAll('[data-type="NodeAttributeView"]')),a.length!==0&&a.length>0&&a.forEach(i=>{var l,o,r,c,f,u;if(i.getAttribute("data-render")==="true")return;if(i.firstElementChild.innerHTML===""){i.style.alignSelf="";let E="";[1,2,3].forEach(()=>{E+=`<div class="av__row">
    <div style="width: 24px;flex-shrink: 0"></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
</div>`}),i.firstElementChild.innerHTML=E}const d=((l=i.querySelector(".av__scroll"))==null?void 0:l.scrollLeft)||0,g=(o=i.querySelector(".av__row--header"))==null?void 0:o.style.transform,p=(r=i.querySelector(".av__row--footer"))==null?void 0:r.style.transform;let b="";const m=i.querySelector(".av__cell--select");m&&(b=N(m,"av__row").dataset.id+L.ZWSP+m.getAttribute("data-col-id"));const h=(c=t.options.history)==null?void 0:c.created,y=(f=t.options.history)==null?void 0:f.snapshot;let k="";typeof s=="string"?k=s:typeof s=="undefined"&&(k=(u=i.querySelector(".av__header .item--focus"))==null?void 0:u.getAttribute("data-id")),pa(h?"/api/av/renderHistoryAttributeView":y?"/api/av/renderSnapshotAttributeView":"/api/av/renderAttributeView",{id:i.getAttribute("data-av-id"),created:h,snapshot:y,pageSize:parseInt(i.dataset.pageSize)||void 0,viewID:k},E=>{var A;const v=E.data.view;i.dataset.pageSize||(i.dataset.pageSize=v.pageSize.toString());let S='<div class="av__row av__row--header"><div class="av__firstcol av__colsticky"><svg><use xlink:href="#iconUncheck"></use></svg></div>',w="",_=-1,C=-1,x=0;const T=i.clientWidth;v.columns.forEach((H,O)=>{H.hidden||(H.pin&&(_=O),x<T-200&&(x+=parseInt(H.width)||200,C=O))}),_=Math.min(_,C),_>-1&&(S='<div class="av__row av__row--header"><div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>',w='<div class="av__colsticky">'),v.columns.forEach((H,O)=>{var $;H.hidden||(S+=`<div class="av__cell av__cell--header" data-col-id="${H.id}"  draggable="true" 
data-icon="${H.icon}" data-dtype="${H.type}" data-wrap="${H.wrap}" data-pin="${H.pin}" 
style="width: ${H.width||"200px"};">
    ${H.icon?fe(H.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${Ge(H.type)}"></use></svg>`}
    <span class="av__celltext fn__flex-1">${H.name}</span>
    ${H.pin?'<svg class="av__cellheadericon av__cellheadericon--pin"><use xlink:href="#iconPin"></use></svg>':""}
    <div class="av__widthdrag"></div>
</div>`,_===O&&(S+="</div>"),w+=`<div class="av__calc${H.calc&&H.calc.operator!==""?" av__calc--ashow":""}" data-col-id="${H.id}" data-dtype="${H.type}" data-operator="${(($=H.calc)==null?void 0:$.operator)||""}"  
style="width: ${O===0?parseInt(H.width||"200")+24+"px":H.width||"200px"}">${Qa(H)||'<svg><use xlink:href="#iconDown"></use></svg>'+window.siyuan.languages.calc}</div>`,_===O&&(w+="</div>"))}),S+=`<div class="block__icons" style="min-height: auto">
    <div class="block__icon block__icon--show" data-type="av-header-add"><svg><use xlink:href="#iconAdd"></use></svg></div>
    <div class="fn__space"></div>
    <div class="block__icon block__icon--show"  data-type="av-header-more"><svg><use xlink:href="#iconMore"></use></svg></div>
</div>
</div>`,v.rows.forEach(H=>{S+=`<div class="av__row" data-id="${H.id}">`,_>-1?S+='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>':S+='<div class="av__firstcol av__colsticky"><svg><use xlink:href="#iconUncheck"></use></svg></div>',H.cells.forEach((O,$)=>{var U;v.columns[$].hidden||(S+=`<div class="av__cell" data-id="${O.id}" data-col-id="${v.columns[$].id}"
${O.valueType==="block"?'data-block-id="'+(O.value.block.id||"")+'"':""} data-wrap="${v.columns[$].wrap}" 
${(U=O.value)!=null&&U.isDetached?' data-detached="true"':""} 
style="width: ${v.columns[$].width||"200px"};
${O.valueType==="number"?"text-align: right;":""}
${O.bgColor?`background-color:${O.bgColor};`:""}
${O.color?`color:${O.color};`:""}">${tn(O.value)}</div>`,_===$&&(S+="</div>"))}),S+="<div></div></div>"});let B="";E.data.views.forEach(H=>{B+=`<div data-id="${H.id}" class="item${H.id===E.data.viewID?" item--focus":""}">
    ${H.icon?fe(H.icon,"item__graphic",!0):'<svg class="item__graphic"><use xlink:href="#iconTable"></use></svg>'}
    <span class="item__text">${H.name}</span>
</div>`}),i.firstElementChild.outerHTML=`<div class="av__container" style="--av-background:${i.style.backgroundColor||"var(--b3-theme-background)"}">
    <div class="av__header">
        <div class="fn__flex av__views">
            <div class="layout-tab-bar fn__flex">
                ${B}
            </div>
            <div class="fn__space"></div>
            <span data-type="av-add" class="block__icon">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__flex-1"></div>
            <div class="fn__space"></div>
            <span data-type="av-switcher" class="block__icon${E.data.views.length>0?"":" fn__none"}">
                <svg><use xlink:href="#iconDown"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-filter" class="block__icon${v.filters.length>0?" block__icon--active":""}">
                <svg><use xlink:href="#iconFilter"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-sort" class="block__icon${v.sorts.length>0?" block__icon--active":""}">
                <svg><use xlink:href="#iconSort"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-more" class="block__icon">
                <svg><use xlink:href="#iconMore"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-add-more" class="block__icon">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            ${E.data.isMirror?` <span class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.mirrorTip}">
    <svg><use xlink:href="#iconSplitLR"></use></svg></span><div class="fn__space"></div>`:""}
        </div>
        <div contenteditable="${t.disabled?"false":"true"}" spellcheck="${window.siyuan.config.editor.spellcheck.toString()}" class="av__title" data-title="${E.data.name||""}" data-tip="${window.siyuan.languages.title}">${E.data.name||""}</div>
        <div class="av__counter fn__none"></div>
    </div>
    <div class="av__scroll">
        <div class="av__body">
            ${S}
            <div class="av__row--util">
                <div class="av__colsticky">
                    <button class="b3-button" data-type="av-add-bottom">
                        <svg><use xlink:href="#iconAdd"></use></svg>
                        ${window.siyuan.languages.addAttr}
                    </button>
                    <span class="fn__space"></span>
                    <button class="b3-button${v.rowCount>v.rows.length?"":" fn__none"}">
                        <svg data-type="av-load-more"><use xlink:href="#iconArrowDown"></use></svg>
                        <span data-type="av-load-more">
                            ${window.siyuan.languages.loadMore}
                        </span>
                        <svg data-type="set-page-size" data-size="${v.pageSize}"><use xlink:href="#iconMore"></use></svg>
                    </button>
                </div>
            </div>
            <div class="av__row--footer">${w}</div>
        </div>
    </div>
</div>`,i.setAttribute("data-render","true"),i.style.margin="",d&&(i.querySelector(".av__scroll").scrollLeft=d);const D=t.contentElement.getBoundingClientRect();if(g?i.querySelector(".av__row--header").style.transform=g:on(i,D,"top"),p?i.querySelector(".av__row--footer").style.transform=p:on(i,D,"bottom"),b){const H=i.querySelector(`.av__row[data-id="${b.split(L.ZWSP)[0]}"] .av__cell[data-col-id="${b.split(L.ZWSP)[1]}"]`);H&&H.classList.add("av__cell--select");const O=document.querySelector(".av__mask");O?(A=O.querySelector("textarea, input"))==null||A.focus():document.querySelector(".av__panel")||Pt(i)}if(getSelection().rangeCount>0){const H=getSelection().getRangeAt(0);if(!N(H.startContainer,"av__title")){const O=K(H.startContainer);O&&i.isSameNode(O)&&Pt(i)}}i.querySelector(".layout-tab-bar").scrollLeft=i.querySelector(".layout-tab-bar .item--focus").offsetLeft,n&&n()})})},jn={},qr=(e,t)=>{t.action==="setAttrViewName"&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-av-id="${t.id}"]`)).forEach(n=>{const s=n.querySelector(".av__title");s&&(s.textContent=t.data,s.dataset.title=t.data)}),clearTimeout(jn[e.id]),jn[e.id]=window.setTimeout(()=>{t.action==="setAttrViewColWidth"?Array.from(e.wysiwyg.element.querySelectorAll(`[data-av-id="${t.avID}"]`)).forEach(n=>{const s=n.querySelector(`.av__cell[data-col-id="${t.id}"]`);!s||s.style.width===t.data||n.querySelectorAll(".av__row").forEach(a=>{a.querySelector(`[data-col-id="${t.id}"]`).style.width=t.data})}):Array.from(e.wysiwyg.element.querySelectorAll(`[data-av-id="${t.avID}"]`)).forEach(n=>{n.removeAttribute("data-render");const s=n.querySelector(".av__pulse");Wn(n,e,()=>{t.action==="addAttrViewCol"&&s&&openMenuPanel({protyle:e,blockElement:n,type:"edit",colId:t.id});const a=document.querySelector(`.b3-dialog--open[data-key="${Constants.DIALOG_ATTR}"] div[data-av-id="${t.avID}"]`);a&&renderAVAttribute(a.parentElement,a.dataset.nodeId,e,i=>{t.action==="addAttrViewCol"&&openMenuPanel({protyle:e,blockElement:i.querySelector(`div[data-av-id="${t.avID}"]`),type:"edit",colId:t.id})})},["addAttrViewView","duplicateAttrViewView"].includes(t.action)?t.id:t.action==="removeAttrViewView"?null:void 0)})},["insertAttrViewBlock","addAttrViewCol"].includes(t.action)?2:100)},Ys=e=>{if(e.action||(e.action=[]),e.protyle.wysiwyg.element.removeAttribute("data-top"),e.data.code===1){e.protyle.model?e.protyle.model.parent.parent.removeTab(e.protyle.model.parent.id,!1):e.protyle.element.innerHTML=`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`;return}if(e.data.code!==3&&(e.protyle.notebookId=e.data.data.box,e.protyle.path=e.data.data.path,!(e.data.data.eof&&!e.scrollAttr&&(e.action.includes(Constants.CB_GET_BEFORE)?e.protyle.wysiwyg.element.firstElementChild.setAttribute("data-eof","1"):e.protyle.wysiwyg.element.lastElementChild.setAttribute("data-eof","2"),e.data.data.mode!==4)))){if(hideElements(["gutter"],e.protyle),e.protyle.block.parentID=e.data.data.parentID,e.protyle.block.parent2ID=e.data.data.parent2ID,e.protyle.block.rootID=e.data.data.rootID,e.protyle.block.showAll=!1,e.protyle.block.mode=e.data.data.mode,e.protyle.block.blockCount=e.data.data.blockCount,e.protyle.block.scroll=e.data.data.scroll,e.protyle.block.action=e.action,e.action.includes(Constants.CB_GET_UNCHANGEID)||(e.protyle.block.id=e.data.data.id,e.protyle.scroll.lastScrollTop=0,e.protyle.contentElement.scrollTop=0,e.protyle.wysiwyg.element.setAttribute("data-doc-type",e.data.data.type)),e.action.includes(Constants.CB_GET_APPEND)||e.action.includes(Constants.CB_GET_BEFORE)||e.action.includes(Constants.CB_GET_HTML)){Un({content:e.data.data.content,expand:e.data.data.isBacklinkExpand,action:e.action,scrollAttr:e.scrollAttr,updateReadonly:e.updateReadonly,isSyncing:e.data.data.isSyncing,afterCB:e.afterCB},e.protyle),removeLoading(e.protyle);return}fetchPost("/api/block/getDocInfo",{id:e.protyle.block.rootID},t=>{e.protyle.options.render.title?e.protyle.title.render(e.protyle,t):(e.protyle.options.render.background&&e.protyle.background.render(t.data.ial,e.protyle.block.rootID),e.protyle.wysiwyg.renderCustom(t.data.ial)),Un({content:e.data.data.content,expand:e.data.data.isBacklinkExpand,action:e.action,scrollAttr:e.scrollAttr,updateReadonly:e.updateReadonly,isSyncing:e.data.data.isSyncing,afterCB:e.afterCB},e.protyle),removeLoading(e.protyle)})}},Un=(e,t)=>{if(t.contentElement.classList.contains("fn__none")&&t.wysiwyg.element.innerHTML!=="")return;t.block.showAll=e.action.includes(Constants.CB_GET_ALL);const n=t.contentElement.clientHeight*8,s=typeof e.updateReadonly=="undefined"?t.wysiwyg.element.innerHTML==="":e.updateReadonly;if(e.action.includes(Constants.CB_GET_APPEND)){if(!t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!t.scroll.keepLazyLoad&&t.contentElement.scrollHeight>n){let a=t.wysiwyg.element.firstElementChild;const i=[];for(;t.wysiwyg.element.childElementCount>2&&i&&!t.wysiwyg.element.lastElementChild.isSameNode(a)&&t.contentElement.scrollHeight-a.offsetTop>n;){i.push(a);a=a.nextElementSibling}const l=a.getBoundingClientRect().top;i.forEach(o=>{o.remove()}),t.contentElement.scrollTop=t.contentElement.scrollTop+(a.getBoundingClientRect().top-l),t.scroll.lastScrollTop=t.contentElement.scrollTop,hideElements(["toolbar"],t)}t.wysiwyg.element.insertAdjacentHTML("beforeend",e.content)}else if(e.action.includes(Constants.CB_GET_BEFORE)){const a=t.wysiwyg.element.firstElementChild,i=a.getBoundingClientRect().top;if(t.wysiwyg.element.insertAdjacentHTML("afterbegin",e.content),t.contentElement.scrollTop=t.contentElement.scrollTop+(a.getBoundingClientRect().top-i),t.scroll.lastScrollTop=t.contentElement.scrollTop,!t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!t.scroll.keepLazyLoad){const l=[];let o=t.wysiwyg.element.childElementCount,r=t.contentElement.scrollHeight,c=t.wysiwyg.element.lastElementChild;for(;o>2&&r>n&&c.getBoundingClientRect().top>window.innerHeight;)l.push(c),c=c.previousElementSibling,o--,r-=c.clientHeight+8;l.forEach(f=>{f.remove()}),hideElements(["toolbar"],t)}}else t.wysiwyg.element.innerHTML=e.content;if(e.action.includes(Constants.CB_GET_BACKLINK)&&foldPassiveType(e.expand,t.wysiwyg.element),processRender(t.wysiwyg.element),highlightRender(t.wysiwyg.element),avRender(t.wysiwyg.element,t),blockRender(t,t.wysiwyg.element),!e.action.includes(Constants.CB_GET_HISTORY)){if(t.options.render.scroll&&t.scroll.update(t),e.action.includes(Constants.CB_GET_FOCUSFIRST)){const a=t.wysiwyg.element.offsetTop-16;preventScroll(t,a,256),t.contentElement.scrollTop=a}if(e.isSyncing?Ws(t):(t.breadcrumb&&(t.breadcrumb.element.nextElementSibling.textContent=""),t.element.removeAttribute("disabled-forever"),Vs(t,s)),Us(t,e.action,e.scrollAttr),e.action.includes(Constants.CB_GET_SETID)&&(t.block.id=t.block.rootID,t.wysiwyg.element.setAttribute("data-doc-type","NodeDocument")),t.options.defId&&(t.wysiwyg.element.querySelectorAll(`[data-id="${t.options.defId}"]`).forEach(a=>{a.classList.add("def--mark")}),t.options.defId=void 0),e.action.includes(Constants.CB_GET_APPEND)||e.action.includes(Constants.CB_GET_BEFORE)){t.app.plugins.forEach(a=>{a.eventBus.emit("loaded-protyle-dynamic",{protyle:t,positon:e.action.includes(Constants.CB_GET_APPEND)?"afterend":"beforebegin"})});return}t.options.render.breadcrumb&&(t.breadcrumb.toggleExit(!e.action.includes(Constants.CB_GET_ALL)),t.breadcrumb.render(t)),e.afterCB&&e.afterCB(),e.scrollAttr&&!t.scroll.element.classList.contains("fn__none")&&!t.element.classList.contains("block__edit")&&t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&t.contentElement.scrollHeight>0&&!e.action.includes(Constants.CB_GET_FOCUSFIRST)&&t.contentElement.scrollHeight<=t.contentElement.clientHeight&&fetchPost("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{Ys({data:a,protyle:t,action:[Constants.CB_GET_APPEND,Constants.CB_GET_UNCHANGEID]})}),e.scrollAttr&&!t.scroll.element.classList.contains("fn__none")&&!t.element.classList.contains("fn__none")&&(t.scroll.updateIndex(t,e.scrollAttr.startId),t.contentElement.scrollHeight<=t.contentElement.clientHeight&&showMessage(window.siyuan.languages.scrollGetMore)),t.app.plugins.forEach(a=>{a.eventBus.emit("loaded-protyle",t),a.eventBus.emit("loaded-protyle-static",{protyle:t})})}},Ws=e=>{Vn(e),e.breadcrumb&&!isMobile()?e.breadcrumb.element.nextElementSibling.textContent=window.siyuan.languages._kernel[81]:showMessage(window.siyuan.languages._kernel[81]),e.element.setAttribute("disabled-forever","true")},Vn=e=>{if(window.siyuan.menus.menu.remove(),hideElements(["gutter","toolbar","select","hint","util"],e),e.disabled=!0,e.title){const t=e.title.element.querySelector(".protyle-title__input");t.setAttribute("contenteditable","false"),t.style.userSelect="text"}document.getElementById("toolbarName").setAttribute("readonly","readonly"),e.background&&(e.background.element.classList.remove("protyle-background--enable"),e.background.element.classList.remove("protyle-background--mobileshow")),e.wysiwyg.element.querySelectorAll(".protyle-icons--show").forEach(t=>{t.classList.remove("protyle-icons--show")}),e.wysiwyg.element.style.userSelect="text",e.wysiwyg.element.setAttribute("contenteditable","false"),e.wysiwyg.element.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(t=>{t.setAttribute("contenteditable","false")}),e.wysiwyg.element.querySelectorAll('.protyle-action[draggable="true"]').forEach(t=>{t.setAttribute("draggable","false")}),e.wysiwyg.element.querySelectorAll(".av").forEach(t=>{const n=t.querySelector(".av__row--header");n&&(n.style.transform="",t.querySelector(".av__row--footer").style.transform="")}),e.breadcrumb&&(e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"] use').setAttribute("xlink:href","#iconLock"),e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]').setAttribute("aria-label",window.siyuan.config.editor.readOnly?window.siyuan.languages.tempUnlock:window.siyuan.languages.unlockEdit)),hideTooltip()},js=e=>{if(e.element.getAttribute("disabled-forever")==="true")return;if(e.disabled=!1,isMobile()?document.getElementById("toolbarName").removeAttribute("readonly"):(e.wysiwyg.element.setAttribute("contenteditable","true"),e.wysiwyg.element.style.userSelect=""),e.title){const n=e.title.element.querySelector(".protyle-title__input");n.setAttribute("contenteditable","true"),n.style.userSelect=""}e.background&&e.background.element.classList.add("protyle-background--enable"),e.wysiwyg.element.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(n=>{hasClosestByClassName(n,"protyle-wysiwyg__embed")||n.setAttribute("contenteditable","true")}),e.wysiwyg.element.querySelectorAll('.protyle-action[draggable="false"]').forEach(n=>{n.setAttribute("draggable","true")});const t=e.contentElement.getBoundingClientRect();e.wysiwyg.element.querySelectorAll(".av").forEach(n=>{n.querySelector(".av__title")&&stickyRow(n,t,"all")}),e.breadcrumb&&(e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"] use').setAttribute("xlink:href","#iconUnlock"),e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]').setAttribute("aria-label",window.siyuan.config.editor.readOnly?window.siyuan.languages.cancelTempUnlock:window.siyuan.languages.lockEdit)),hideTooltip()},Us=(e,t,n)=>{var s;let a;if(n&&n.focusId?a=e.wysiwyg.element.querySelector(`[data-node-id="${n.focusId}"]`):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${e.block.id}"]`)).find(l=>{if(!hasClosestByAttribute(l,"data-type","block-render",!0))return a=l,!0}),e.block.mode===4?(preventScroll(e),a=e.wysiwyg.element.lastElementChild):(!a||t.includes(Constants.CB_GET_FOCUSFIRST))&&(a=e.wysiwyg.element.firstElementChild),t.includes(Constants.CB_GET_HL)&&(preventScroll(e),bgFade(a)),t.includes(Constants.CB_GET_FOCUS)||t.includes(Constants.CB_GET_FOCUSFIRST)){let l;n&&n.focusId?l=focusByOffset(a,n.focusStart,n.focusEnd):focusBlock(a)}const i=n&&typeof n.scrollTop=="number";if(i&&(e.contentElement.scrollTop=n.scrollTop),(s=e.observerLoad)==null||s.disconnect(),t.includes(Constants.CB_GET_FOCUS)||t.includes(Constants.CB_GET_SCROLL)||t.includes(Constants.CB_GET_HL)||t.includes(Constants.CB_GET_FOCUSFIRST)){const l=e.contentElement.getBoundingClientRect(),o=a.getBoundingClientRect();!i&&(l.top>o.top||l.bottom<o.bottom)&&scrollCenter(e,a,!0)}else return;e.observerLoad=new ResizeObserver(()=>{if(i&&(e.contentElement.scrollTop=n.scrollTop),t.includes(Constants.CB_GET_FOCUS)||t.includes(Constants.CB_GET_HL)||t.includes(Constants.CB_GET_FOCUSFIRST)){const l=e.contentElement.getBoundingClientRect(),o=a.getBoundingClientRect();!i&&(l.top>o.top||l.bottom<o.bottom)&&scrollCenter(e,a,!0)}}),e.observerLoad.observe(e.wysiwyg.element),e.observer.unobserve(e.wysiwyg.element),setTimeout(()=>{e.observerLoad.disconnect(),e.observer.observe(e.wysiwyg.element)},1e3*3),a.isSameNode(e.wysiwyg.element.firstElementChild)&&!i&&e.observerLoad.disconnect()},Vs=(e,t)=>{let n=window.siyuan.config.readonly?"true":"false";t?n==="false"&&(n=window.siyuan.config.editor.readOnly?"true":"false",n==="false"&&(n=e.wysiwyg.element.getAttribute(Constants.CUSTOM_SY_READONLY))):n=e.disabled?"true":"false",n==="true"?Vn(e):js(e)},Fr=(e,t)=>{e.block.showAll=!0;let n="";t.forEach(s=>{n+=zs(s.blockPaths)+Gn(s.dom,s.expand)}),e.wysiwyg.element.innerHTML=n,processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),blockRender(e,e.wysiwyg.element),removeLoading(e),(window.siyuan.config.readonly||window.siyuan.config.editor.readOnly)&&disabledProtyle(e)},Gs=(e,t)=>{t.firstElementChild.classList.contains("li")?e?t.querySelectorAll(".li .li").forEach(n=>{n.childElementCount>3&&n.setAttribute("fold","1")}):t.firstElementChild.setAttribute("fold","1"):t.firstElementChild.getAttribute("data-type")==="NodeHeading"&&Array.from(t.children).forEach((n,s)=>{(e&&s>2||!e&&s>1)&&((e&&s===3||!e&&s===2)&&n.insertAdjacentHTML("beforebegin",'<div style="max-width: 100%;justify-content: center;" contenteditable="false" class="protyle-breadcrumb__item"><svg><use xlink:href="#iconMore"></use></svg></div>'),n.classList.add("fn__none"))})},Gn=(e,t)=>{const n=document.createElement("template");return n.innerHTML=e,Gs(t,n.content),n.innerHTML},Yr=(e,t)=>{fetchPost("/api/filetree/getDoc",{id:t.getAttribute("data-id"),size:Constants.SIZE_GET_MAX},n=>{t.parentElement.querySelector(".protyle-breadcrumb__item--active").classList.remove("protyle-breadcrumb__item--active"),t.classList.add("protyle-breadcrumb__item--active");let s=t.parentElement.nextElementSibling;for(;s&&!s.classList.contains("protyle-breadcrumb__bar");){const a=s;s=s.nextElementSibling,a.remove()}t.parentElement.insertAdjacentHTML("afterend",Gn(n.data.content,!0)),processRender(t.parentElement.parentElement),avRender(t.parentElement.parentElement,e),blockRender(e,t.parentElement.parentElement),n.data.isSyncing?disabledForeverProtyle(e):window.siyuan.config.readonly||window.siyuan.config.editor.readOnly?disabledProtyle(e):t.parentElement.parentElement.classList.contains("protyle-wysiwyg__embed")&&t.parentElement.parentElement.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(a=>{a.setAttribute("contenteditable","false")})})},Wr=e=>{let t=e.nextElementSibling;for(;t&&!t.classList.contains("protyle-breadcrumb__bar");)t.classList.remove("fn__none"),t=t.nextElementSibling;e.remove()},zs=(e,t=!1)=>{let n="";return e.forEach((s,a)=>{a===0&&!t||(n+=`<span class="protyle-breadcrumb__item${a===e.length-1?" protyle-breadcrumb__item--active":""}" data-id="${s.id}">
    <svg class="popover__block" data-id="${s.id}"><use xlink:href="#${getIconByType(s.type,s.subType)}"></use></svg>
    <span class="protyle-breadcrumb__text" title="${s.name}">${s.name}</span>
</span>`,a!==e.length-1&&(n+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>'))}),`<div contenteditable="false" style="margin-bottom: 8px" class="protyle-breadcrumb__bar protyle-breadcrumb__bar--nowrap">${n}</div>`},Ks=(e,t,n)=>{let s=[];t.getAttribute("data-type")==="NodeBlockQueryEmbed"?s=[t]:s=Array.from(t.querySelectorAll('[data-type="NodeBlockQueryEmbed"]')),s.length!==0&&s.forEach(a=>{if(a.getAttribute("data-render")==="true")return;a.setAttribute("data-render","true"),a.style.height=a.clientHeight-8+"px",a.innerHTML=`<div class="protyle-icons${hasClosestByAttribute(a.parentElement,"data-type","NodeBlockQueryEmbed")?" fn__none":""}">
    <span aria-label="${window.siyuan.languages.refresh}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__reload protyle-icon--first"><svg class="fn__rotate"><use xlink:href="#iconRefresh"></use></svg></span>
    <span aria-label="${window.siyuan.languages.update} SQL" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>${a.lastElementChild.outerHTML}`;const i=Lute.UnEscapeHTMLStr(a.getAttribute("data-content"));let l=a.getAttribute("breadcrumb");if(l?l=l==="true":l=window.siyuan.config.editor.embedBlockBreadcrumb,hasTopClosestByClassName(a,"sb")&&(l=!1),i.startsWith("//!js"))try{const r=new Function("fetchSyncPost","item","protyle","top",i)(fetchSyncPost,a,e,n);if(r instanceof Promise)r.then(c=>{if(Array.isArray(c))fetchPost("/api/search/getEmbedBlock",{embedBlockID:a.getAttribute("data-node-id"),includeIDs:c,headingMode:a.getAttribute("custom-heading-mode")==="1"?1:0,breadcrumb:l},f=>{pt(f.data.blocks||[],e,a,n)});else return}).catch(()=>{pt([],e,a,n)});else if(Array.isArray(r))fetchPost("/api/search/getEmbedBlock",{embedBlockID:a.getAttribute("data-node-id"),includeIDs:r,headingMode:a.getAttribute("custom-heading-mode")==="1"?1:0,breadcrumb:l},c=>{pt(c.data.blocks||[],e,a,n)});else return}catch(r){pt([],e,a,n)}else fetchPost("/api/search/searchEmbedBlock",{embedBlockID:a.getAttribute("data-node-id"),stmt:i,headingMode:a.getAttribute("custom-heading-mode")==="1"?1:0,excludeIDs:[a.getAttribute("data-node-id"),e.block.rootID],breadcrumb:l},r=>{pt(r.data.blocks,e,a,n)})})},pt=(e,t,n,s)=>{const a=n.querySelector(".fn__rotate");a&&a.classList.remove("fn__rotate");let i="";e.forEach(r=>{let c="";r.blockPaths.length!==0&&(c=genBreadcrumb(r.blockPaths,!0)),i+=`<div class="protyle-wysiwyg__embed" data-id="${r.block.id}">${c}${r.block.content}</div>`}),e.length>0?n.lastElementChild.insertAdjacentHTML("beforebegin",i+`<div style="position: absolute;">${Constants.ZWSP}</div>`):n.lastElementChild.insertAdjacentHTML("beforebegin",`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>
<div style="position: absolute;">${Constants.ZWSP}</div>`),processRender(n),highlightRender(n),avRender(n,t),s&&(t.contentElement.scrollTop=s);let l=0,o=n;for(;l<4&&o;)o=hasClosestByAttribute(o.parentElement,"data-type","NodeBlockQueryEmbed"),l++;l<4&&n.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(r=>{Ks(t,r)}),n.style.height=""},zn=(e,t)=>{const n=getTopAloneElement(e),s=[];if(n.isSameNode(e)||(e.remove(),s.push({action:"delete",id:n.getAttribute("data-node-id")})),n.remove(),t.block.rootID===t.block.id&&t.wysiwyg.element.childElementCount===0){const a=Lute.NewNodeID(),i=genEmptyElement(!1,!1,a);s.push({action:"insert",data:i.outerHTML,id:a,parentID:t.block.parentID}),t.wysiwyg.element.innerHTML=i.outerHTML}s.length>0&&mt(t,s,[])},Kn=()=>{if(window.siyuan.transactions.length===0)return;const e=window.siyuan.transactions[0].protyle,t=window.siyuan.transactions[0].doOperations,n=window.siyuan.transactions[0].undoOperations;window.siyuan.transactions.splice(0,1),fetchPost("/api/transactions",{session:e.id,app:Constants.SIYUAN_APPID,transactions:[{doOperations:t,undoOperations:n}]},s=>{if(window.siyuan.transactions.length===0?countBlockWord([],e.block.rootID,!0):Kn(),(window.siyuan.config.sync.provider!==0&&isPaidUser()||window.siyuan.config.sync.provider===0&&!needSubscribe(""))&&window.siyuan.config.repo.key&&window.siyuan.config.sync.enabled&&document.getElementById("toolbarSync").classList.remove("fn__none"),s.data[0].doOperations[0].action==="setAttrs"){const i=e.gutter.element.querySelector('[data-type="fold"]');i&&i.removeAttribute("disabled"),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(l=>{l.querySelector(`[data-node-id="${s.data[0].doOperations[0].id}"]`)&&(l.removeAttribute("data-render"),blockRender(e,l))});return}let a;getSelection().rangeCount>0&&(a=getSelection().getRangeAt(0)),s.data[0].doOperations.forEach(i=>{if(i.action==="unfoldHeading"||i.action==="foldHeading"){const l=e.gutter.element.querySelector('[data-type="fold"]');if(l&&l.removeAttribute("disabled"),i.action==="unfoldHeading"){const o=e.contentElement.scrollTop;e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`).forEach(r=>{if(r.lastElementChild.classList.contains("protyle-attr")||r.lastElementChild.remove(),Qn(i.retData,e),r.insertAdjacentHTML("afterend",i.retData),i.data==="remove"){const c=getSelection();c.rangeCount>0&&r.contains(c.getRangeAt(0).startContainer)&&focusBlock(r.nextElementSibling,void 0,!0),r.remove()}}),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),blockRender(e,e.wysiwyg.element),e.contentElement.scrollTop=o,e.scroll.lastScrollTop=o;return}e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&!e.scroll.element.classList.contains("fn__none")&&e.contentElement.scrollHeight-e.contentElement.scrollTop<e.contentElement.clientHeight*2&&fetchPost("/api/filetree/getDoc",{id:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},o=>{onGet({data:o,protyle:e,action:[Constants.CB_GET_APPEND,Constants.CB_GET_UNCHANGEID]})});return}if(i.action==="update"){e.options.backlinkData&&(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`)).forEach(l=>{(l.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(l,"data-type","NodeBlockQueryEmbed"))&&(a&&(l.isSameNode(a.startContainer)||l.contains(a.startContainer))||(l.outerHTML=i.data.replace("<wbr>","")))}),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),blockRender(e,e.wysiwyg.element)),sn(e,i),at(e,i.id);return}if(i.action==="delete"||i.action==="append"){e.options.backlinkData&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`)).forEach(l=>{hasClosestByAttribute(l,"data-type","NodeBlockQueryEmbed")||l.remove()}),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(l=>{l.querySelector(`[data-node-id="${i.id}"]`)&&(l.removeAttribute("data-render"),blockRender(e,l))});return}if(i.action==="move"){if(e.options.backlinkData){const l=[];Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`)).forEach(r=>{if(r.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(r,"data-type","NodeBlockQueryEmbed")){l.push(r);return}});let o=!1;i.previousID&&l.length>0?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.previousID}"]`)).forEach(r=>{(r.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(r.parentElement,"data-type","NodeBlockQueryEmbed"))&&(r.after(l[0].cloneNode(!0)),o=!0)}):l.length>0&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.parentID}"]`)).forEach(r=>{var c;(r.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(r.parentElement,"data-type","NodeBlockQueryEmbed"))&&((c=r.firstElementChild)!=null&&c.classList.contains("protyle-action")?r.firstElementChild.after(l[0].cloneNode(!0)):r.prepend(l[0].cloneNode(!0)),o=!0)}),l.forEach(r=>{o?r.remove():!o&&r.parentElement&&zn(r,e)})}e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(l=>{l.querySelector(`[data-node-id="${i.id}"]`)&&(l.removeAttribute("data-render"),blockRender(e,l))});return}if(i.action==="insert"){if(e.options.backlinkData){const l=[];i.previousID?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.previousID}"]`)).forEach(o=>{var r;((r=o.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"))!==i.id&&!hasClosestByAttribute(o,"data-node-id",i.id)&&(o.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(o.parentElement,"data-type","NodeBlockQueryEmbed"))&&(o.insertAdjacentHTML("afterend",i.data),l.push(o.nextElementSibling))}):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.parentID}"]`)).forEach(o=>{(o.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(o.parentElement,"data-type","NodeBlockQueryEmbed"))&&(o.firstElementChild&&o.firstElementChild.classList.contains("protyle-action")&&o.firstElementChild.nextElementSibling.getAttribute("data-node-id")!==i.id?(o.firstElementChild.insertAdjacentHTML("afterend",i.data),l.push(o.firstElementChild.nextElementSibling)):o.firstElementChild&&o.firstElementChild.getAttribute("data-node-id")!==i.id&&(o.insertAdjacentHTML("afterbegin",i.data),l.push(o.firstElementChild)))}),e.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(o=>{o.lastElementChild.getAttribute("spin")==="1"&&o.lastElementChild.remove()}),l.forEach(o=>{processRender(o),highlightRender(o),avRender(o,e),blockRender(e,o);const r=o.querySelector("wbr");r&&r.remove()})}at(e,i.id)}})})},sn=(e,t)=>{let n=!1;e.wysiwyg.element.querySelectorAll(`[data-type="NodeBlockQueryEmbed"] [data-node-id="${t.id}"]`).forEach(s=>{const a=document.createElement("div");a.innerHTML=t.data,a.querySelectorAll('[contenteditable="true"]').forEach(l=>{l.setAttribute("contenteditable","false")});const i=a.querySelector("wbr");i&&i.remove(),s.outerHTML=a.innerHTML,n=!0}),n&&(processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e))},Zn=(e,t,n,s)=>{s&&focusSideBlock(e[0]),e.forEach(a=>{a.remove()}),n.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(a=>{a.querySelector(`[data-node-id="${t}"]`)&&(a.removeAttribute("data-render"),blockRender(n,a))})},Xn=(e,t,n,s)=>{e.forEach(i=>{i.getAttribute("data-subtype")==="echarts"?i.outerHTML=t.lute.SpinBlockDOM(n.data):i.outerHTML=n.data}),Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${n.id}"]`)).find(i=>{if(i.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(i,"data-type","NodeBlockQueryEmbed"))return e[0]=i,!0});const a=e[0].querySelector("wbr");if(s){const i=getEditorRange(e[0]);a?focusByWbr(e[0],i):focusBlock(e[0])}else a&&a.remove();processRender(e.length===1?e[0]:t.wysiwyg.element),highlightRender(e.length===1?e[0]:t.wysiwyg.element),avRender(e.length===1?e[0]:t.wysiwyg.element,t),blockRender(t,e.length===1?e[0]:t.wysiwyg.element),sn(t,n),at(t,n.id)},jr=(e,t,n)=>{const s=[];if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).forEach(a=>{hasClosestByAttribute(a.parentElement,"data-type","NodeBlockQueryEmbed")||s.push(a)}),t.action==="setAttrs"){e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(a=>{JSON.parse(t.data).fold==="1"?a.setAttribute("fold","1"):a.removeAttribute("fold")});return}if(t.action==="unfoldHeading"){const a=e.contentElement.scrollTop;e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(i=>{t.retData&&(Qn(t.retData,e),i.insertAdjacentHTML("afterend",t.retData)),i.removeAttribute("fold"),t.data==="remove"&&i.remove()}),t.retData&&(processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),blockRender(e,e.wysiwyg.element),e.contentElement.scrollTop=a,e.scroll.lastScrollTop=a);return}if(t.action==="foldHeading"){e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(a=>{a.setAttribute("fold","1"),t.retData||removeFoldHeading(a)}),t.retData&&t.retData.forEach(a=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${a}"]`).forEach(i=>{i.remove()})});return}if(t.action==="delete"){s.length>0?Zn(s,t.id,e,n):n&&zoomOut({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:t.id,callback(){Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).forEach(a=>{hasClosestByAttribute(a.parentElement,"data-type","NodeBlockQueryEmbed")||s.push(a)}),Zn(s,t.id,e,n)}});return}if(t.action==="update"){s.length>0?Xn(s,e,t,n):n?zoomOut({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:t.id,callback(){Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).forEach(a=>{hasClosestByAttribute(a.parentElement,"data-type","NodeBlockQueryEmbed")||s.push(a)}),Xn(s,e,t,n)}}):(sn(e,t),at(e,t.id));return}if(t.action==="updateAttrs"){const a=t.data,i={};let l="",o="",r="",c="",f="";Object.keys(a.new).forEach(d=>{i[d]=a.new[d];const g=Lute.EscapeHTMLStr(a.new[d]);d==="bookmark"?l=`<div class="protyle-attr--bookmark">${g}</div>`:d==="name"?o=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${g}</div>`:d==="alias"?r=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${g}</div>`:d==="memo"?c=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${g}"><svg><use xlink:href="#iconM"></use></svg></div>`:d==="custom-avs"&&(f='<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg></div>')});let u=l+o+r+c+f;if(e.block.rootID===t.id){if(e.title){const d=e.title.element.querySelector(".protyle-attr--refcount");d&&(u+=d.outerHTML),a.new[Constants.CUSTOM_RIFF_DECKS]&&a.new[Constants.CUSTOM_RIFF_DECKS]!==a.old[Constants.CUSTOM_RIFF_DECKS]?(e.title.element.style.animation="addCard 450ms linear",e.title.element.setAttribute(Constants.CUSTOM_RIFF_DECKS,a.new[Constants.CUSTOM_RIFF_DECKS]),setTimeout(()=>{e.title.element.style.animation=""},450)):a.new[Constants.CUSTOM_RIFF_DECKS]||e.title.element.removeAttribute(Constants.CUSTOM_RIFF_DECKS),e.title.element.querySelector(".protyle-attr").innerHTML=u}if(e.wysiwyg.renderCustom(i),a.new[Constants.CUSTOM_SY_FULLWIDTH]!==a.old[Constants.CUSTOM_SY_FULLWIDTH]&&resize(e),a.new[Constants.CUSTOM_SY_READONLY]!==a.old[Constants.CUSTOM_SY_READONLY]){let d=a.new[Constants.CUSTOM_SY_READONLY];d||(d=window.siyuan.config.editor.readOnly?"true":"false"),d==="true"?disabledProtyle(e):enableProtyle(e)}a.new.icon!==a.old.icon&&window.siyuan.mobile.editor.protyle.background.ial.icon!==a.new.icon&&(window.siyuan.mobile.editor.protyle.background.ial.icon=a.new.icon,window.siyuan.mobile.editor.protyle.background.render(window.siyuan.mobile.editor.protyle.background.ial,window.siyuan.mobile.editor.protyle.block.rootID));return}e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(d=>{if(d.getAttribute("data-type")==="NodeThematicBreak")return;Object.keys(a.old).forEach(p=>{d.removeAttribute(p)}),a.new.style&&a.new[Constants.CUSTOM_RIFF_DECKS]&&a.new[Constants.CUSTOM_RIFF_DECKS]!==a.old[Constants.CUSTOM_RIFF_DECKS]&&(a.new.style+=";animation:addCard 450ms linear"),Object.keys(a.new).forEach(p=>{d.setAttribute(p,a.new[p]),p===Constants.CUSTOM_RIFF_DECKS&&a.new[Constants.CUSTOM_RIFF_DECKS]!==a.old[Constants.CUSTOM_RIFF_DECKS]&&(d.style.animation="addCard 450ms linear",setTimeout(()=>{d.style.animation=""},450))});const g=d.lastElementChild.querySelector(".protyle-attr--refcount");g&&(u+=g.outerHTML),d.lastElementChild.innerHTML=u+Constants.ZWSP});return}if(t.action==="move"){let a;n&&getSelection().rangeCount>0&&(a=getSelection().getRangeAt(0),a.insertNode(document.createElement("wbr")));let i=!1;t.previousID&&s.length>0?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.previousID}"]`)).forEach(l=>{hasClosestByAttribute(l.parentElement,"data-type","NodeBlockQueryEmbed")||(l.after(s[0].cloneNode(!0)),i=!0)}):s.length>0&&(!e.options.backlinkData&&t.parentID===e.block.parentID?(e.wysiwyg.element.prepend(s[0].cloneNode(!0)),i=!0):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.parentID}"]`)).forEach(l=>{var o;hasClosestByAttribute(l.parentElement,"data-type","NodeBlockQueryEmbed")||((o=l.firstElementChild)!=null&&o.classList.contains("protyle-action")?l.firstElementChild.after(s[0].cloneNode(!0)):l.prepend(s[0].cloneNode(!0)),i=!0)})),s.forEach(l=>{i?l.remove():!i&&l.parentElement&&zn(l,e)}),n&&a&&(t.data==="focus"?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).find(l=>{if(!hasClosestByAttribute(l.parentElement,"data-type","NodeBlockQueryEmbed"))return focusBlock(l),!0}):focusByWbr(e.wysiwyg.element,a)),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(l=>{l.querySelector(`[data-node-id="${t.id}"],[data-node-id="${t.parentID}"],[data-node-id="${t.previousID}"]`)&&(l.removeAttribute("data-render"),blockRender(e,l))});return}if(t.action==="insert"){const a=[];if(t.previousID?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.previousID}"]`)).forEach(i=>{const l=hasClosestByAttribute(i.parentElement,"data-type","NodeBlockQueryEmbed");l?(l.removeAttribute("data-render"),blockRender(e,l)):(i.insertAdjacentHTML("afterend",t.data),a.push(i.nextElementSibling))}):!e.options.backlinkData&&t.parentID===e.block.parentID?(e.wysiwyg.element.insertAdjacentHTML("afterbegin",t.data),a.push(e.wysiwyg.element.firstElementChild)):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.parentID}"]`)).forEach(i=>{var l;hasClosestByAttribute(i.parentElement,"data-type","NodeBlockQueryEmbed")||((l=i.firstElementChild)!=null&&l.classList.contains("protyle-action")?(i.firstElementChild.insertAdjacentHTML("afterend",t.data),a.push(i.firstElementChild.nextElementSibling)):(i.insertAdjacentHTML("afterbegin",t.data),a.push(i.firstElementChild)))}),e.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(i=>{i.lastElementChild.getAttribute("spin")==="1"&&i.lastElementChild.remove()}),a.length===0)return;a.forEach(i=>{processRender(i),highlightRender(i),avRender(i,e),blockRender(e,i);const l=i.querySelector("wbr");if(n){const o=getEditorRange(i);l?focusByWbr(i,o):focusBlock(i)}else l&&l.remove()}),at(e,t.id)}else t.action==="append"?reloadProtyle(e,!1):["addAttrViewCol","insertAttrViewBlock","updateAttrViewCol","updateAttrViewColOptions","updateAttrViewColOption","updateAttrViewCell","sortAttrViewRow","sortAttrViewCol","setAttrViewColHidden","setAttrViewColWrap","setAttrViewColWidth","removeAttrViewColOption","setAttrViewName","setAttrViewFilters","setAttrViewSorts","setAttrViewColCalc","removeAttrViewCol","updateAttrViewColNumberFormat","removeAttrViewBlock","replaceAttrViewBlock","updateAttrViewColTemplate","setAttrViewColPin","addAttrViewView","setAttrViewColIcon","removeAttrViewView","setAttrViewViewName","setAttrViewViewIcon","duplicateAttrViewView","sortAttrViewView","updateAttrViewColRelation","setAttrViewPageSize","updateAttrViewColRollup"].includes(t.action)?refreshAV(e,t):t.action==="doUpdateUpdated"&&s.forEach(a=>{a.setAttribute("updated",t.data)})},Ur=e=>{let t;const n=Lute.NewNodeID();if(e.type==="BlocksMergeSuperBlock")t=genSBElement(e.level,n);else if(e.type==="Blocks2Blockquote")t=document.createElement("div"),t.classList.add("bq"),t.setAttribute("data-node-id",n),t.setAttribute("data-type","NodeBlockquote"),t.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';else if(e.type.endsWith("Ls")){t=document.createElement("div"),t.classList.add("list"),t.setAttribute("data-node-id",n),t.setAttribute("data-type","NodeList"),e.type==="Blocks2ULs"?t.setAttribute("data-subtype","u"):e.type==="Blocks2OLs"?t.setAttribute("data-subtype","o"):t.setAttribute("data-subtype","t");let r="";e.selectsElement.forEach((c,f)=>{e.type==="Blocks2ULs"?r+=`<div data-marker="*" data-subtype="u" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`:e.type==="Blocks2OLs"?r+=`<div data-marker="${f+1}." data-subtype="o" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--order" contenteditable="false" draggable="true">${f+1}.</div><div class="protyle-attr" contenteditable="false"></div></div>`:r+=`<div data-marker="*" data-subtype="t" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`}),t.innerHTML=r+'<div class="protyle-attr" contenteditable="false"></div>'}const s=e.selectsElement[0].getAttribute("data-node-id"),a=e.selectsElement[0].parentElement.getAttribute("data-node-id")||e.protyle.block.parentID,i=[{action:"insert",id:n,data:t.outerHTML,nextID:s,parentID:a}],l=[];e.selectsElement[0].previousElementSibling?e.selectsElement[0].before(t):e.selectsElement[0].parentElement.prepend(t);let o;e.selectsElement.forEach((r,c)=>{r.classList.remove("protyle-wysiwyg--select"),r.removeAttribute("select-start"),r.removeAttribute("select-end");const f=r.getAttribute("data-node-id");l.push({action:"move",id:f,previousID:o||n,parentID:a}),e.type.endsWith("Ls")?(i.push({action:"move",id:f,parentID:t.children[c].getAttribute("data-node-id")}),t.children[c].firstElementChild.after(r)):(i.push({action:"move",id:f,previousID:o,parentID:n}),t.lastElementChild.before(r)),o=r.getAttribute("data-node-id"),c===e.selectsElement.length-1&&l.push({action:"delete",id:n}),r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),blockRender(e.protyle,r))}),mt(e.protyle,i,l),focusBlock(e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.selectsElement[0].getAttribute("data-node-id")}"]`)),hideElements(["gutter"],e.protyle)},Qn=(e,t)=>{const n=document.createElement("template");n.innerHTML=e,Array.from(n.content.children).forEach(s=>{var a;(a=t.wysiwyg.element.querySelector(`:scope > [data-node-id="${s.getAttribute("data-node-id")}"]`))==null||a.remove()})},Vr=e=>{let t=e.selectsElement,n;if(e.nodeElement){n=getSelection().getRangeAt(0),n.insertNode(document.createElement("wbr")),t=Array.from(e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),t.length===0&&(t=[e.nodeElement]);let o=!1,r=!1,c=!1;if(t.find((f,u)=>{if(f.classList.contains("li"))return c=!0,!0;if((f.classList.contains("bq")||f.classList.contains("sb")||f.classList.contains("p"))&&(r=!0),f.nextElementSibling&&t[u+1]&&f.nextElementSibling.isSameNode(t[u+1]))o=!0;else if(u!==t.length-1)return o=!1,!0}),c||r&&e.type==="Blocks2Ps")return;t.length===1&&e.type==="Blocks2Hs"&&t[0].getAttribute("data-type")==="NodeHeading"&&e.level===parseInt(t[0].getAttribute("data-subtype").substr(1))&&(e.type="Blocks2Ps"),e.isContinue=o}let s="";const a=[],i=[],l=document.createElement("div");t.forEach((o,r)=>{var c,f,u;(e.type==="Blocks2Ps"||e.type==="Blocks2Hs")&&o.getAttribute("data-type")==="NodeHeading"&&o.getAttribute("fold")==="1"&&setFold(e.protyle,o),o.classList.remove("protyle-wysiwyg--select"),o.removeAttribute("select-start"),o.removeAttribute("select-end"),s+=o.outerHTML;const d=o.getAttribute("data-node-id");i.push({action:"update",id:d,data:o.outerHTML,parentID:((c=o.parentElement)==null?void 0:c.getAttribute("data-node-id"))||e.protyle.block.parentID||e.protyle.block.rootID,previousID:((f=i[i.length-1])==null?void 0:f.id)||((u=o.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"))}),e.isContinue?r===t.length-1?(l.innerHTML=e.protyle.lute[e.type](s,e.level),o.outerHTML=l.innerHTML):o.remove():o.outerHTML=e.protyle.lute[e.type](o.outerHTML,e.level)}),i.forEach(o=>{const r=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${o.id}"]`);r?a.push({action:"update",id:o.id,data:r.outerHTML}):(o.action="insert",a.push({action:"delete",id:o.id}))}),Array.from(l.children).forEach(o=>{var r,c;const f=o.getAttribute("data-node-id");let u=!1;i.find(d=>{if(f===d.id)return u=!0,!0}),u||(a.push({action:"insert",id:f,previousID:((r=o.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"))||i[0].previousID,data:o.outerHTML,parentID:((c=o.parentElement)==null?void 0:c.getAttribute("data-node-id"))||e.protyle.block.parentID||e.protyle.block.rootID}),i.splice(0,0,{action:"delete",id:f}))}),mt(e.protyle,a,i),processRender(e.protyle.wysiwyg.element),highlightRender(e.protyle.wysiwyg.element),avRender(e.protyle.wysiwyg.element,e.protyle),blockRender(e.protyle,e.protyle.wysiwyg.element),n?focusByWbr(e.protyle.wysiwyg.element,n):focusBlock(e.protyle.wysiwyg.element.querySelector(`[data-node-id="${t[0].getAttribute("data-node-id")}"]`)),hideElements(["gutter"],e.protyle)},at=(e,t,n=0)=>{n>6||e.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${t}"]`).forEach(s=>{s.getAttribute("data-subtype")==="d"&&fetchPost("/api/block/getRefText",{id:t},a=>{s.innerHTML=a.data;const i=hasClosestBlock(s);i&&at(e,i.getAttribute("data-node-id"),n+1)})})};let Jn;const mt=(e,t,n)=>{if(!e){fetchPost("/api/transactions",{session:Constants.SIYUAN_APPID,app:Constants.SIYUAN_APPID,transactions:[{doOperations:t}]});return}const s=window.siyuan.transactions[window.siyuan.transactions.length-1];let a=!1;const i=new Date().getTime();s&&s.doOperations.length===1&&s.doOperations[0].action==="update"&&t.length===1&&t[0].action==="update"&&s.doOperations[0].id===t[0].id&&e.transactionTime-i<Constants.TIMEOUT_INPUT&&(a=!0),e.wysiwyg.lastHTMLs={},n&&(window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.model&&e.model.headElement.classList.remove("item--unupdate"),e.updated=!0,a?e.undo.replace(t):e.undo.add(t,n)),a?(window.siyuan.transactions[window.siyuan.transactions.length-1].protyle=e,window.siyuan.transactions[window.siyuan.transactions.length-1].doOperations=t):window.siyuan.transactions.push({protyle:e,doOperations:t,undoOperations:n}),e.transactionTime=i,window.clearTimeout(Jn),Jn=window.setTimeout(()=>{Kn()},Constants.TIMEOUT_INPUT*2)},Gr=(e,t,n,s)=>{n!==s&&mt(e,[{id:t,data:n,action:"update"}],[{id:t,data:s,action:"update"}])},zr=(e,t,n)=>{const s=[],a=[];e.forEach(i=>{const l=i.getAttribute("data-node-id");i.classList.remove("protyle-wysiwyg--select"),i.removeAttribute("select-start"),i.removeAttribute("select-end"),a.push({action:"update",id:l,data:i.outerHTML}),n(i),s.push({action:"update",id:l,data:i.outerHTML})}),mt(t,s,a)},Kr=(e,t)=>{const n=hasClosestByClassName(e,"av__row");if(!n)return;const s=e.querySelector("use");n.classList.contains("av__row--header")||t==="unselectAll"?s.getAttribute("xlink:href")==="#iconCheck"||t==="unselectAll"?n.parentElement.querySelectorAll(".av__firstcol").forEach(a=>{a.querySelector("use").setAttribute("xlink:href","#iconUncheck");const i=hasClosestByClassName(a,"av__row");i&&i.classList.remove("av__row--select")}):n.parentElement.querySelectorAll(".av__firstcol").forEach(a=>{a.querySelector("use").setAttribute("xlink:href","#iconCheck");const i=hasClosestByClassName(a,"av__row");i&&i.classList.add("av__row--select")}):t==="select"||s.getAttribute("xlink:href")==="#iconUncheck"&&t==="toggle"?(n.classList.add("av__row--select"),s.setAttribute("xlink:href","#iconCheck")):(t==="unselect"||s.getAttribute("xlink:href")==="#iconCheck"&&t==="toggle")&&(n.classList.remove("av__row--select"),s.setAttribute("xlink:href","#iconUncheck")),focusBlock(hasClosestBlock(n)),ea(n)},ea=e=>{const t=hasClosestBlock(e);if(!t)return;const n=e.parentElement.querySelectorAll(".av__row--select:not(.av__row--header)").length,s=e.parentElement.childElementCount-3-n,a=e.parentElement.firstElementChild,i=a.querySelector("use"),l=t.querySelector(".av__counter"),o=t.querySelector(".av__header");if(s===0&&e.parentElement.childElementCount-3!==0)a.classList.add("av__row--select"),i.setAttribute("xlink:href","#iconCheck");else if(s===e.parentElement.childElementCount-3){a.classList.remove("av__row--select"),i.setAttribute("xlink:href","#iconUncheck"),l.classList.add("fn__none"),o.style.position="";return}else s>0&&(a.classList.add("av__row--select"),i.setAttribute("xlink:href","#iconIndeterminateCheck"));l.classList.remove("fn__none"),l.innerHTML=`${n} ${window.siyuan.languages.selected}`,o.style.position="sticky"},Zr=(e,t,n,s,a)=>{const i=t.querySelector(`.av__row[data-id="${s}"]`)||t.querySelector(".av__row--header");let l='<div class="av__firstcol av__colsticky"><svg><use xlink:href="#iconUncheck"></use></svg></div>';const o=i.querySelectorAll(".av__colsticky .av__cell").length-1;o>-1&&(l='<div class="av__colsticky"><div class="av__firstcol av__colsticky"><svg><use xlink:href="#iconUncheck"></use></svg></div>'),i.querySelectorAll(".av__cell").forEach((f,u)=>{l+=`<div class="av__cell" data-col-id="${f.dataset.colId}" 
style="width: ${f.style.width};text-align: ${f.style.textAlign}" 
${f.getAttribute("data-block-id")||f.dataset.dtype==="block"?' data-detached="true"':""}><span class="${a?"av__celltext":"av__pulse"}"></span></div>`,o===u&&(l+="</div>")});let r="";if(n.forEach(f=>{r+=`<div class="av__row" data-id="${f}" data-avid="${a}" data-previous-id="${s}">
    ${l}
</div>`}),i.insertAdjacentHTML("afterend",r),a){const f=i.nextElementSibling,u=i.classList.contains("av__row--header")?f.nextElementSibling:i;u.classList.contains("av__row")?fetchPost("/api/av/getAttributeViewFilterSort",{id:a},d=>{d.data.filters.forEach(g=>{const p=u.querySelector(`.av__cell[data-col-id="${g.column}"]`);f.querySelector(`.av__cell[data-col-id="${g.column}"]`).innerHTML=renderCell(genCellValueByElement(getTypeByCellElement(p),p))}),d.data.sorts.forEach(g=>{const p=u.querySelector(`.av__cell[data-col-id="${g.column}"]`);f.querySelector(`.av__cell[data-col-id="${g.column}"]`).innerHTML=renderCell(genCellValueByElement(getTypeByCellElement(p),p))}),popTextCell(e,[f.querySelector('.av__cell[data-detached="true"]')],"block")}):popTextCell(e,[f.querySelector('.av__cell[data-detached="true"]')],"block")}const c=parseInt(t.getAttribute("data-page-size"));if(c){const f=t.querySelectorAll(".av__row:not(.av__row--header)").length;c<f&&t.setAttribute("data-page-size",f.toString())}},on=(e,t,n)=>{if(e.querySelector(".av__title").getAttribute("contenteditable")==="false")return;const s=e.querySelector(".av__scroll").getBoundingClientRect(),a=e.querySelector(".av__row--header");if(a&&(n==="top"||n==="all")){const l=Math.floor(t.top-s.top);l>0&&l<s.height?a.style.transform=`translateY(${l}px)`:a.style.transform=""}const i=e.querySelector(".av__row--footer");if(i&&(n==="bottom"||n==="all"))if(i.querySelector(".av__calc--ashow")){const l=Math.ceil(t.bottom-i.parentElement.getBoundingClientRect().bottom);l<0&&-l<s.height?i.style.transform=`translateY(${l}px)`:i.style.transform=""}else i.style.transform=""},Tt=e=>{var t;e.currentPageSize!==e.newPageSize&&(e.nodeElement.setAttribute("data-page-size",e.newPageSize),transaction(e.protyle,[{action:"setAttrViewPageSize",avID:e.avID,data:parseInt(e.newPageSize)}],[{action:"setAttrViewPageSize",data:parseInt(e.currentPageSize),avID:e.avID}]),(t=document.querySelector(".av__panel"))==null||t.remove())},Xr=e=>{const t=new Menu("av-page-size");if(t.isOpen)return;const n=e.target.dataset.size;t.addItem({iconHTML:"",label:"10",accelerator:n==="10"?'<svg class="svg" style="height: 30px; float: left;"><use xlink:href="#iconSelect"></use></svg>':void 0,click(){Tt({currentPageSize:n,newPageSize:"10",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",accelerator:n==="25"?'<svg class="svg" style="height: 30px; float: left;"><use xlink:href="#iconSelect"></use></svg>':void 0,label:"25",click(){Tt({currentPageSize:n,newPageSize:"25",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",accelerator:n==="50"?'<svg class="svg" style="height: 30px; float: left;"><use xlink:href="#iconSelect"></use></svg>':void 0,label:"50",click(){Tt({currentPageSize:n,newPageSize:"50",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",accelerator:n==="100"?'<svg class="svg" style="height: 30px; float: left;"><use xlink:href="#iconSelect"></use></svg>':void 0,label:"100",click(){Tt({currentPageSize:n,newPageSize:"100",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}});const s=e.target.getBoundingClientRect();t.open({x:s.left,y:s.bottom})},Qr=(e,t)=>{const n=e.getAttribute("data-av-id"),s=[],a=e.querySelectorAll(".av__row--select:not(.av__row--header)"),i=[];a.forEach(l=>{i.push(l.querySelector(".av__cell[data-block-id]").getAttribute("data-block-id"))}),a.forEach(l=>{var o;s.push({action:"insertAttrViewBlock",avID:n,previousID:((o=l.previousElementSibling)==null?void 0:o.getAttribute("data-id"))||"",srcIDs:[l.getAttribute("data-id")],isDetached:!!l.querySelector('.av__cell[data-detached="true"]')})}),transaction(t,[{action:"removeAttrViewBlock",srcIDs:i,avID:n}],s),a.forEach(l=>{l.remove()}),on(e,t.contentElement.getBoundingClientRect(),"all"),ea(e.querySelector(".av__row"))},Jr=e=>{hideElements(["gutter"],e);const t=setPadding(e),n=4;setTimeout(()=>{if(!e.disabled){const s=e.contentElement.getBoundingClientRect();e.wysiwyg.element.querySelectorAll(".av").forEach(a=>{a.querySelector(".av__title")&&stickyRow(a,s,"all")})}if((t.width>n||isNaN(t.width))&&(typeof window.echarts!="undefined"&&e.wysiwyg.element.querySelectorAll('[data-subtype="echarts"], [data-subtype="mindmap"]').forEach(s=>{const a=window.echarts.getInstanceById(s.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));a&&a.resize()}),window.siyuan.config.editor.codeSyntaxHighlightLineNum&&e.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber").forEach(s=>{lineNumberRender(s)}),!e.disabled&&e.toolbar.range)){let s=e.toolbar.range.getBoundingClientRect();if(s.height===0){const i=hasClosestBlock(e.toolbar.range.startContainer);i&&(s=i.getBoundingClientRect())}if(s.height===0)return;const a=e.element.getBoundingClientRect();(a.top+30>s.top||a.bottom<s.bottom)&&e.toolbar.range.startContainer.parentElement.scrollIntoView(a.top>s.top)}},Constants.TIMEOUT_TRANSITION)},ec=(e,t)=>{var n,s,a,i;if(t==="preview"){if(!e.preview.element.classList.contains("fn__none"))return;e.preview.element.classList.remove("fn__none"),e.contentElement.classList.add("fn__none"),(n=e.scroll)==null||n.element.classList.add("fn__none"),e.options.render.breadcrumb&&((s=e.breadcrumb)==null||s.element.classList.add("fn__none"),e.breadcrumb.toggleExit(!0)),e.preview.render(e)}else if(t==="wysiwyg"){if(!e.contentElement.classList.contains("fn__none"))return;e.preview.element.classList.add("fn__none"),e.contentElement.classList.remove("fn__none"),e.options.render.scroll&&((a=e.scroll)==null||a.element.classList.remove("fn__none")),e.options.render.breadcrumb&&((i=e.breadcrumb)==null||i.element.classList.remove("fn__none"),e.breadcrumb.toggleExit(!e.block.showAll)),resize(e)}hideElements(["gutter","toolbar","select","hint","util"],e)};let ta;const tc=(e,t)=>{t.addEventListener("scroll",()=>{const n=t.getBoundingClientRect();if(!e.toolbar.element.classList.contains("fn__none")){const s=e.toolbar.element.getAttribute("data-inity").split(Constants.ZWSP),a=parseInt(s[0])+(parseInt(s[1])-t.scrollTop);a<n.top-e.toolbar.toolbarHeight||a>n.bottom-e.toolbar.toolbarHeight?e.toolbar.element.style.display="none":(e.toolbar.element.style.top=a+"px",e.toolbar.element.style.display="")}e.wysiwyg.element.querySelectorAll(".av").forEach(s=>{s.dataset.render==="true"&&stickyRow(s,n,"all")}),!e.element.classList.contains("block__edit")&&!isMobile()&&e.contentElement.setAttribute("data-scrolltop",t.scrollTop.toString()),window.siyuan.dragElement||hideElements(["gutter"],e),e.scroll&&!e.scroll.element.classList.contains("fn__none")&&(clearTimeout(ta),ta=window.setTimeout(()=>{let s=document.elementFromPoint(n.left+n.width/2,n.top+10);s.classList.contains("protyle-wysiwyg")&&(s=document.elementFromPoint(n.left+n.width/2,n.top+20));const a=hasClosestBlock(s);if(!a){if((e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0")&&(hasClosestByClassName(s,"protyle-background")||hasClosestByClassName(s,"protyle-title"))){const i=e.scroll.element.querySelector(".b3-slider");i.value="1",e.scroll.element.setAttribute("aria-label",`Blocks 1/${e.block.blockCount}`)}return}e.scroll.updateIndex(e,a.getAttribute("data-node-id"))},Constants.TIMEOUT_LOAD)),!(e.wysiwyg.element.getAttribute("data-top")||e.block.showAll||e.scroll&&e.scroll.element.classList.contains("fn__none")||!e.scroll||e.scroll.lastScrollTop===t.scrollTop||e.scroll.lastScrollTop===-1)&&(e.scroll.lastScrollTop-t.scrollTop>0?t.scrollTop<t.clientHeight&&e.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(e.contentElement.style.width=e.contentElement.clientWidth+"px",e.contentElement.style.overflow="hidden",e.wysiwyg.element.setAttribute("data-top",t.scrollTop.toString()),fetchPost("/api/filetree/getDoc",{id:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},s=>{e.contentElement.style.overflow="",e.contentElement.style.width="",onGet({data:s,protyle:e,action:[Constants.CB_GET_BEFORE,Constants.CB_GET_UNCHANGEID]})})):t.scrollTop>t.scrollHeight-t.clientHeight*1.8&&e.wysiwyg.element.lastElementChild&&e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&(e.wysiwyg.element.setAttribute("data-top",t.scrollTop.toString()),fetchPost("/api/filetree/getDoc",{id:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},s=>{onGet({data:s,protyle:e,action:[Constants.CB_GET_APPEND,Constants.CB_GET_UNCHANGEID]})})),e.scroll.lastScrollTop=Math.max(t.scrollTop,0))},{capture:!1,passive:!0,once:!1})},na=(e,t)=>{addScript(e,"iconDefaultScript").then(()=>{if(!["ant","material"].includes(t.icon)){const n=document.getElementById("iconScript");n&&n.remove(),addScript(`/appearance/icons/${t.icon}/icon.js?v=${t.iconVer}`,"iconScript")}})},Zs=e=>{const t=document.getElementsByTagName("html")[0];t.setAttribute("lang",window.siyuan.config.appearance.lang),t.setAttribute("data-theme-mode",Xs()),t.setAttribute("data-light-theme",window.siyuan.config.appearance.themeLight),t.setAttribute("data-dark-theme",window.siyuan.config.appearance.themeDark);const n=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===1&&n==="light"||window.siyuan.config.appearance.mode===0&&n==="dark")&&(fetchPost("/api/system/setAppearanceMode",{mode:n==="light"?0:1}),window.siyuan.config.appearance.mode=n==="light"?0:1);const s=document.getElementById("themeDefaultStyle");let a=`/appearance/themes/${e.mode===1?"midnight":"daylight"}/theme.css?v=${Constants.SIYUAN_VERSION}`;(e.mode===1&&e.themeDark!=="midnight"||e.mode===0&&e.themeLight!=="daylight")&&(a=`/appearance/themes/${e.mode===1?"midnight":"daylight"}/theme.css?v=${Constants.SIYUAN_VERSION}`),s?s.getAttribute("href").startsWith(a)||(s.remove(),addStyle(a,"themeDefaultStyle")):addStyle(a,"themeDefaultStyle");const i=document.getElementById("themeStyle");if(e.mode===1&&e.themeDark!=="midnight"||e.mode===0&&e.themeLight!=="daylight"){const f=`/appearance/themes/${e.mode===1?e.themeDark:e.themeLight}/theme.css?v=${e.themeVer}`;i?i.getAttribute("href").startsWith(f)||(i.remove(),addStyle(f,"themeStyle")):addStyle(f,"themeStyle")}else i&&i.remove();aa();const l=document.getElementById("themeScript"),o=`/appearance/themes/${e.mode===1?e.themeDark:e.themeLight}/theme.js?v=${e.themeVer}`;l?l.getAttribute("src").startsWith(o)||(l.remove(),addScript(o,"themeScript")):addScript(o,"themeScript");const r=document.getElementById("iconDefaultScript"),c=`/appearance/icons/${["ant","material"].includes(e.icon)?e.icon:"material"}/icon.js?v=${Constants.SIYUAN_VERSION}`;if(r){r.remove();let f=document.body.firstElementChild;for(;f.tagName==="svg";){const u=f;f=f.nextElementSibling,u.getAttribute("data-name")||u.remove()}na(c,e)}else na(c,e)},nc=()=>{const e=document.getElementById("loading");e&&setTimeout(()=>{e.remove()},160),sa(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",t=>{const n=t.matches?"dark":"light";sa(n),window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===0&&n==="light"||window.siyuan.config.appearance.mode===1&&n==="dark"||fetchPost("/api/system/setAppearanceMode",{mode:n==="light"?0:1},s=>{if(window.siyuan.config.appearance.themeJS){window.location.reload();return}window.siyuan.config.appearance=s.data.appearance,Zs(s.data.appearance)}))})},ac=()=>{if(!window.siyuan.config.system.disableGoogleAnalytics){addScript("https://www.googletagmanager.com/gtag/js?id=G-L7WEXVQCR9","gaScript"),window.dataLayer=window.dataLayer||[];const e=function(...n){window.dataLayer.push(arguments)};e("js",new Date),e("config","G-L7WEXVQCR9",{send_page_view:!1});const t={version:Constants.SIYUAN_VERSION,container:window.siyuan.config.system.container,os:window.siyuan.config.system.os,osPlatform:window.siyuan.config.system.osPlatform,isLoggedIn:!1,subscriptionStatus:-1,subscriptionPlan:-1,subscriptionType:-1,oneTimePayStatus:-1,syncEnabled:!1,syncProvider:-1,cTreeCount:window.siyuan.config.stat.cTreeCount,cBlockCount:window.siyuan.config.stat.cBlockCount,cDataSize:window.siyuan.config.stat.cDataSize,cAssetsSize:window.siyuan.config.stat.cAssetsSize};window.siyuan.user&&(t.isLoggedIn=!0,t.subscriptionStatus=window.siyuan.user.userSiYuanSubscriptionStatus,t.subscriptionPlan=window.siyuan.user.userSiYuanSubscriptionPlan,t.subscriptionType=window.siyuan.user.userSiYuanSubscriptionType,t.oneTimePayStatus=window.siyuan.user.userSiYuanOneTimePayStatus),window.siyuan.config.sync&&(t.syncEnabled=window.siyuan.config.sync.enabled,t.syncProvider=window.siyuan.config.sync.provider),e("event",Constants.ANALYTICS_EVT_ON_GET_CONFIG,t)}},sc=(e=!0)=>{const t=Math.floor(window.siyuan.config.editor.fontSize*1.625);let n=`.b3-typography, .protyle-wysiwyg, .protyle-title {font-size:${window.siyuan.config.editor.fontSize}px !important}
.b3-typography code:not(.hljs), .protyle-wysiwyg span[data-type~=code] { font-variant-ligatures: ${window.siyuan.config.editor.codeLigatures?"normal":"none"} }
.li > .protyle-action {height:${t+8}px;line-height: ${t+8}px}
.protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h1, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h2, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h3, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h4, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h5, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h6 {line-height:${t+8}px;}
.protyle-wysiwyg [data-node-id].li > .protyle-action:after {height: ${window.siyuan.config.editor.fontSize}px;width: ${window.siyuan.config.editor.fontSize}px;margin:-${window.siyuan.config.editor.fontSize/2}px 0 0 -${window.siyuan.config.editor.fontSize/2}px}
.protyle-wysiwyg [data-node-id].li > .protyle-action svg {height: ${Math.max(14,window.siyuan.config.editor.fontSize-8)}px}
.protyle-wysiwyg [data-node-id].li:before {height: calc(100% - ${t+8}px);top:${t+8}px}
.protyle-wysiwyg [data-node-id] [spellcheck] {min-height:${t}px;}
.protyle-wysiwyg [data-node-id] {${window.siyuan.config.editor.rtl?" direction: rtl;":""}${window.siyuan.config.editor.justify?" text-align: justify;":""}}
.protyle-wysiwyg .li {min-height:${t+8}px}
.protyle-gutters button svg {height:${t}px}
.protyle-wysiwyg img.emoji, .b3-typography img.emoji {width:${t-8}px}
.protyle-wysiwyg .h1 img.emoji, .b3-typography h1 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.75*1.25)}px}
.protyle-wysiwyg .h2 img.emoji, .b3-typography h2 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.55*1.25)}px}
.protyle-wysiwyg .h3 img.emoji, .b3-typography h3 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.38*1.25)}px}
.protyle-wysiwyg .h4 img.emoji, .b3-typography h4 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.25*1.25)}px}
.protyle-wysiwyg .h5 img.emoji, .b3-typography h5 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.13*1.25)}px}
.protyle-wysiwyg .h6 img.emoji, .b3-typography h6 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.25)}px}`;if(window.siyuan.config.editor.fontFamily&&(n+=`
.b3-typography:not(.b3-typography--default), .protyle-wysiwyg, .protyle-title {font-family: "${window.siyuan.config.editor.fontFamily}", var(--b3-font-family-protyle)}`),"ontouchend"in document&&(n+=`
.b3-menu .b3-menu__action {opacity: 0.68;}`),e){const s=document.getElementById("siyuanStyle");s?s.innerHTML=n:document.querySelector("#pluginsStyle").insertAdjacentHTML("beforebegin",`<style id="siyuanStyle">${n}</style>`)}return n},aa=(e=L.PROTYLE_CDN)=>{const t=document.getElementById("protyleHljsStyle");let n;window.siyuan.config.appearance.mode===0?(n=window.siyuan.config.appearance.codeBlockThemeLight,L.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE.includes(n)||(n="default")):(n=window.siyuan.config.appearance.codeBlockThemeDark,L.SIYUAN_CONFIG_APPEARANCE_DARK_CODE.includes(n)||(n="github-dark"));const s=`${e}/js/highlight.js/styles/${n}.min.css?v=11.5.0`;t?t.href.includes(s)||(t.remove(),Ut(s,"protyleHljsStyle")):Ut(s,"protyleHljsStyle")},ic=e=>{},sa=e=>{(isInIOS()||isInAndroid())&&setTimeout(()=>{const t=getComputedStyle(document.body).getPropertyValue("--b3-theme-background").trim();let n=window.siyuan.config.appearance.mode;window.siyuan.config.appearance.modeOS&&(e==="dark"?n=1:n=0),isInIOS()?window.webkit.messageHandlers.changeStatusBar.postMessage((t||(n===0?"#fff":"#1e1e1e"))+" "+n):isInAndroid()&&window.JSAndroid.changeStatusBarColor(t,n)},500)},Xs=()=>{const e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";return window.siyuan.config.appearance.modeOS?e:window.siyuan.config.appearance.mode===0?"light":"dark"},oc=e=>{e.contentElement=document.createElement("div"),e.contentElement.className="protyle-content",e.options.render.background&&e.contentElement.appendChild(e.background.element),e.options.render.title&&e.contentElement.appendChild(e.title.element),e.contentElement.appendChild(e.wysiwyg.element),e.options.action.includes(Constants.CB_GET_HISTORY)||scrollEvent(e,e.contentElement),e.element.append(e.contentElement),e.element.appendChild(e.preview.element),e.upload&&e.element.appendChild(e.upload.element),e.options.render.scroll&&e.element.appendChild(e.scroll.element.parentElement),e.gutter&&e.element.appendChild(e.gutter.element),e.element.appendChild(e.hint.element),e.selectElement=document.createElement("div"),e.selectElement.className="protyle-select fn__none",e.element.appendChild(e.selectElement),e.element.appendChild(e.toolbar.element),e.element.appendChild(e.toolbar.subElement),Qs(e),setEditMode(e,e.options.mode),document.execCommand("DefaultParagraphSeparator",!1,"p");let t;const n=isMac();e.contentElement.addEventListener("mousewheel",s=>{if(!(!window.siyuan.config.editor.fontSizeScrollZoom||n&&!s.metaKey||!n&&!s.ctrlKey||s.deltaX!==0)){if(s.preventDefault(),s.stopPropagation(),s.deltaY<0)if(window.siyuan.config.editor.fontSize<72)window.siyuan.config.editor.fontSize++;else return;else if(s.deltaY>0)if(window.siyuan.config.editor.fontSize>9)window.siyuan.config.editor.fontSize--;else return;setInlineStyle(),clearTimeout(t),t=window.setTimeout(()=>{fetchPost("/api/setting/setEditor",window.siyuan.config.editor),window.siyuan.config.editor.codeSyntaxHighlightLineNum&&e.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber").forEach(a=>{lineNumberRender(a)})},Constants.TIMEOUT_LOAD)}},{passive:!1})},Qs=(e,t)=>{e.element.removeAttribute("data-loading"),setTimeout(()=>{e.element.getAttribute("data-loading")!=="finished"&&e.element.insertAdjacentHTML("beforeend",`<div style="background-color: var(--b3-theme-background);flex-direction: column;" class="fn__loading wysiwygLoading">
    <img width="48px" src="/stage/loading-pure.svg">
    <div style="color: var(--b3-theme-on-surface);margin-top: 8px;">${t||""}</div>
</div>`)},Constants.TIMEOUT_LOAD)},lc=e=>{e.element.setAttribute("data-loading","finished"),e.element.querySelectorAll(".wysiwygLoading").forEach(t=>{t.remove()})},rc=e=>{if(e.options.action.includes(Constants.CB_GET_HISTORY))return{width:0,padding:0};const t=parseInt(e.wysiwyg.element.style.paddingLeft);let n=16,s=24;if(!isMobile()){let o=e.wysiwyg.element.getAttribute(Constants.CUSTOM_SY_FULLWIDTH);o||(o=window.siyuan.config.editor.fullWidth?"true":"false");let r=(e.element.clientWidth-Constants.SIZE_EDITOR_WIDTH)/2;o==="false"&&r>96?(r>Constants.SIZE_EDITOR_WIDTH&&(r=e.element.clientWidth*.382/1.382),r=Math.ceil(r),n=r,s=r):e.element.clientWidth>Constants.SIZE_EDITOR_WIDTH&&(n=96,s=96)}let a="16px";if(e.options.typewriterMode&&(isMobile()?a=window.innerHeight/5+"px":a=e.element.clientHeight/2+"px"),e.options.backlinkData?e.wysiwyg.element.style.padding=`4px ${n}px 4px ${s}px`:e.wysiwyg.element.style.padding=`16px ${n}px ${a} ${s}px`,e.options.render.background&&(e.background.element.lastElementChild.setAttribute("style",`left:${n}px`),e.background.element.querySelector(".protyle-background__img .protyle-icons").setAttribute("style",`right:${n}px`)),e.options.render.title&&(e.title.element.style.margin=`16px ${n}px 0 ${s}px`),window.siyuan.config.editor.displayBookmarkIcon){const o=document.getElementById("editorAttr");o&&(o.innerHTML=`.protyle-wysiwyg--attr .b3-tooltips:after { max-width: ${e.wysiwyg.element.clientWidth-n-s}px; }`)}const i=e.wysiwyg.element.getAttribute("data-realwidth"),l=e.wysiwyg.element.clientWidth-parseInt(e.wysiwyg.element.style.paddingLeft)-parseInt(e.wysiwyg.element.style.paddingRight);return e.wysiwyg.element.setAttribute("data-realwidth",l.toString()),{width:Math.abs(parseInt(i)-l),padding:Math.abs(t-parseInt(e.wysiwyg.element.style.paddingLeft))}},cc=(e,t=!1)=>{if(!e.wysiwyg.element.firstElementChild||window.siyuan.config.readonly)return;const n={rootId:e.block.rootID,startId:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),scrollTop:e.contentElement.scrollTop||parseInt(e.contentElement.getAttribute("data-scrolltop"))||0};let s;if(getSelection().rangeCount>0&&(s=getSelection().getRangeAt(0)),(!s||!e.wysiwyg.element.contains(s.startContainer))&&(s=e.toolbar.range),s&&e.wysiwyg.element.contains(s.startContainer)){const a=hasClosestBlock(s.startContainer);if(a){const i=getSelectionOffset(a,void 0,s);n.focusId=a.getAttribute("data-node-id"),n.focusStart=i.start,n.focusEnd=i.end}}if(e.block.showAll&&(n.zoomInId=e.block.id),t)return n;window.siyuan.storage[Constants.LOCAL_FILEPOSITION][e.block.rootID]=n,setStorageVal(Constants.LOCAL_FILEPOSITION,window.siyuan.storage[Constants.LOCAL_FILEPOSITION])},dc=e=>{var t,n;let s=[];if(e.mergedOptions?s=e.mergedOptions.action:e.focus?s=[Constants.CB_GET_UNUNDO,Constants.CB_GET_FOCUS]:s=[Constants.CB_GET_UNUNDO],e.scrollAttr.zoomInId){fetchPost("/api/filetree/getDoc",{id:e.scrollAttr.zoomInId,size:Constants.SIZE_GET_MAX},a=>{var i,l;a.code===1?fetchPost("/api/filetree/getDoc",{id:e.scrollAttr.rootId||((i=e.mergedOptions)==null?void 0:i.blockId)||((l=e.protyle.block)==null?void 0:l.rootID)||e.scrollAttr.startId},o=>{onGet({data:o,protyle:e.protyle,action:s,scrollAttr:e.scrollAttr,afterCB:e.cb})}):(s.push(Constants.CB_GET_ALL),onGet({data:a,protyle:e.protyle,action:s,scrollAttr:e.scrollAttr,afterCB:e.cb}))});return}fetchPost("/api/filetree/getDoc",{id:e.scrollAttr.rootId||((t=e.mergedOptions)==null?void 0:t.blockId)||((n=e.protyle.block)==null?void 0:n.rootID)||e.scrollAttr.startId,startID:e.scrollAttr.startId,endID:e.scrollAttr.endId},a=>{onGet({data:a,protyle:e.protyle,action:s,scrollAttr:e.scrollAttr,afterCB:e.cb})})},uc=(e,t)=>{if(!e.preview.element.classList.contains("fn__none")){e.preview.render(e);return}if(window.siyuan.config.editor.displayBookmarkIcon?e.wysiwyg.element.classList.add("protyle-wysiwyg--attr"):e.wysiwyg.element.classList.remove("protyle-wysiwyg--attr"),e.title&&(e.title.element.setAttribute("spellcheck",window.siyuan.config.editor.spellcheck.toString()),window.siyuan.config.editor.displayBookmarkIcon?e.title.element.classList.add("protyle-wysiwyg--attr"):e.title.element.classList.remove("protyle-wysiwyg--attr")),e.lute.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),e.lute.SetSpellcheck(window.siyuan.config.editor.spellcheck),addLoading(e),e.options.backlinkData){const n=e.element.getAttribute("data-ismention")==="true",s=hasClosestByClassName(e.element,"sy__backlink");if(s){const a=s.querySelectorAll(".b3-form__icon-input");fetchPost(n?"/api/ref/getBackmentionDoc":"/api/ref/getBacklinkDoc",{defID:e.element.getAttribute("data-defid"),refTreeID:e.block.rootID,keyword:n?a[1].value:a[0].value},i=>{e.options.backlinkData=n?i.data.backmentions:i.data.backlinks,renderBacklink(e,e.options.backlinkData)})}}else preventScroll(e),getDocByScroll({protyle:e,focus:t,scrollAttr:saveScroll(e,!0)})},ln=(e,t)=>{fetchPost("/api/filetree/createDailyNote",{notebook:t,app:Constants.SIYUAN_APPID},n=>{openMobileFileById(e,n.data.id)})},fc=e=>{if(window.siyuan.dialogs.find(i=>{if(i.element.getAttribute("data-key")===Constants.DIALOG_DIALYNOTE)return i.destroy(),!0}))return;const n=getOpenNotebookCount();if(n===0){showMessage(window.siyuan.languages.newFileTip);return}if(n===1){let i="";window.siyuan.notebooks.find(l=>{l.closed||(i=l.id)}),ln(e,i);return}const s=window.siyuan.storage[Constants.LOCAL_DAILYNOTEID],a=window.siyuan.notebooks.find(i=>{if(i.id===s&&!i.closed)return!0});if(s&&a&&!isMobile())ln(e,s);else{let i="";window.siyuan.notebooks.forEach(c=>{c.closed||(i+=`<option value="${c.id}">${c.name}</option>`)});const l=new Dialog({positionId:Constants.DIALOG_DIALYNOTE,title:window.siyuan.languages.plsChoose,content:`<div class="b3-dialog__content">
    <select class="b3-select fn__block">${i}</select>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});l.element.setAttribute("data-key",Constants.DIALOG_DIALYNOTE);const o=l.element.querySelectorAll(".b3-button"),r=l.element.querySelector(".b3-select");r.value=s,o[0].addEventListener("click",()=>{l.destroy()}),o[1].addEventListener("click",()=>{const c=r.value;window.siyuan.storage[Constants.LOCAL_DAILYNOTEID]=c,setStorageVal(Constants.LOCAL_DAILYNOTEID,window.siyuan.storage[Constants.LOCAL_DAILYNOTEID]),ln(e,c),l.destroy()})}},gc=()=>{const e=Constants.HELP_PATH[window.siyuan.config.appearance.lang];fetchPost("/api/notebook/removeNotebook",{notebook:e,callback:Constants.CB_MOUNT_REMOVE},()=>{fetchPost("/api/notebook/openNotebook",{notebook:e})})},pc=()=>{const e=new Dialog({title:window.siyuan.languages.newNotebook,content:`<div class="b3-dialog__content">
    <input placeholder="${window.siyuan.languages.notebookName}" class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});e.element.setAttribute("data-key",Constants.DIALOG_CREATENOTEBOOK);const t=e.element.querySelectorAll(".b3-button");e.bindInput(e.element.querySelector("input"),()=>{t[1].dispatchEvent(new CustomEvent("click"))}),t[0].addEventListener("click",()=>{e.destroy()}),t[1].addEventListener("click",()=>{const n=e.element.querySelector("input").value;if(!validateName(n))return!1;fetchPost("/api/notebook/createNotebook",{name:n}),e.destroy()})},Js=e=>{let t="",n="";return window.siyuan.mobile.editor&&document.getElementById("empty").classList.contains("fn__none")&&(t=window.siyuan.mobile.editor.protyle.notebookId,e?n=window.siyuan.mobile.editor.protyle.path:n=pathPosix().dirname(window.siyuan.mobile.editor.protyle.path)),t||window.siyuan.notebooks.find(s=>{if(!s.closed)return t=s.id,n="/",!0}),{notebookId:t,currentPath:n}},ei=e=>{if(getOpenNotebookCount()===0){showMessage(window.siyuan.languages.newFileTip);return}if(!e.notebookId){const t=Js(e.useSavePath);e.notebookId=t.notebookId,e.currentPath=t.currentPath}fetchPost("/api/filetree/getDocCreateSavePath",{notebook:e.notebookId},t=>{if(t.data.path.indexOf("/")>-1&&e.useSavePath||e.name)t.data.path.startsWith("/")||e.currentPath==="/"?fetchPost("/api/filetree/createDocWithMd",{notebook:e.notebookId,path:pathPosix().join(t.data.path,e.name||(t.data.path.endsWith("/")?"Untitled":"")),markdown:""},n=>{openMobileFileById(e.app,n.data,[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT])}):fetchPost("/api/filetree/getHPathByPath",{notebook:e.notebookId,path:e.currentPath.endsWith(".sy")?e.currentPath:e.currentPath+".sy"},n=>{fetchPost("/api/filetree/createDocWithMd",{notebook:e.notebookId,path:pathPosix().join(n.data,t.data.path,e.name||(t.data.path.endsWith("/")?"Untitled":"")),parentID:getDisplayName(e.currentPath,!0,!0),markdown:""},s=>{openMobileFileById(e.app,s.data,[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT])})});else{const n=pathPosix().basename(t.data.path||"Untitled");if(!validateName(n))return;const s=Lute.NewNodeID(),a=pathPosix().join(getDisplayName(e.currentPath,!1,!0),s+".sy");e.paths&&(e.paths[e.paths.indexOf(void 0)]=a),fetchPost("/api/filetree/createDoc",{notebook:e.notebookId,path:a,title:n,md:"",sorts:e.paths},()=>{openMobileFileById(e.app,s,[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT])})}})},mc=(e,t,n)=>{fetchPost("/api/filetree/getRefCreateSavePath",{notebook:t},s=>{s.data.path?s.data.path.startsWith("/")?n(getDisplayName(s.data.path,!1,!0)):fetchPost("/api/filetree/getHPathByPath",{notebook:t,path:e},a=>{n(getDisplayName(pathPosix().join(a.data,s.data.path),!1,!0))}):fetchPost("/api/filetree/getHPathByPath",{notebook:t,path:e},a=>{n(getDisplayName(a.data,!1,!0))})})},bc=(e,t)=>{hideElements(["dialog"]),ei({app:e,useSavePath:!0,name:replaceFileName(t.trim())||"Untitled"})},hc=(e,t,n,s)=>{const a=replaceFileName(t.trim()?t.trim():e.lute.BlockDOM2Content(n.outerHTML).replace(/\n/g,""))||"Untitled",i=pathPosix().join(s,a);fetchPost("/api/filetree/getIDsByHPath",{path:i,notebook:e.notebookId},l=>{const o=escapeHtml(a.substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen));l.data&&l.data.length>0?insertHTML(`<span data-type="block-ref" data-id="${l.data[0]}" data-subtype="d">${o}</span>`,e,!1,!0):fetchPost("/api/filetree/createDocWithMd",{notebook:e.notebookId,path:i,parentID:e.block.rootID,markdown:""},r=>{insertHTML(`<span data-type="block-ref" data-id="${r.data}" data-subtype="d">${o}</span>`,e,!1,!0)}),hideElements(["toolbar"],e)})};var ti=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const ni=(e,t)=>{const n=new Dialog({title:window.siyuan.languages.searchType,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconMath"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.math}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="mathBlock" type="checkbox"${e.types.mathBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconTable"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.table}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="table" type="checkbox"${e.types.table?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconQuote"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.quote}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="blockquote" type="checkbox"${e.types.blockquote?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSuper"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.superBlock}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="superBlock" type="checkbox"${e.types.superBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconParagraph"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.paragraph}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="paragraph" type="checkbox"${e.types.paragraph?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconFile"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.doc}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="document" type="checkbox"${e.types.document?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHeadings"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.headings}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="heading" type="checkbox"${e.types.heading?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconList"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.list1}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="list" type="checkbox"${e.types.list?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconListItem"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.listItem}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="listItem" type="checkbox"${e.types.listItem?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconCode"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.code}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="codeBlock" type="checkbox"${e.types.codeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHTML5"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            HTML
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="htmlBlock" type="checkbox"${e.types.htmlBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSQL"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.embedBlock}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="embedBlock" type="checkbox"${e.types.embedBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconDatabase"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.database}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="databaseBlock" type="checkbox"${e.types.databaseBlock?" checked":""}>
    </label>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px",height:"70vh"});n.element.setAttribute("data-key",Constants.DIALOG_SEARCHTYPE);const s=n.element.querySelectorAll(".b3-button");s[0].addEventListener("click",()=>{n.destroy()}),s[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(a=>{e.types[a.getAttribute("data-type")]=a.checked}),t(),n.destroy()})},ai=e=>{let t="";Object.keys(Constants.SIYUAN_DEFAULT_REPLACETYPES).forEach(a=>{t+=`<label class="fn__flex b3-label">
    <span class="fn__space"></span>
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.replaceTypes[a]}
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" data-type="${a}" type="checkbox"${e.replaceTypes[a]?" checked":""}>
</label>`});const n=new Dialog({title:window.siyuan.languages.replaceType,content:`<div class="b3-dialog__content">${t}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px",height:"70vh"});n.element.setAttribute("data-key",Constants.DIALOG_REPLACETYPE);const s=n.element.querySelectorAll(".b3-button");s[0].addEventListener("click",()=>{n.destroy()}),s[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(a=>{e.replaceTypes[a.getAttribute("data-type")]=a.checked}),n.destroy()})},yc=(e,t)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchMethod"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchMethod"),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.keyword,current:e.method===0,click(){e.method=0,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.querySyntax,current:e.method===1,click(){e.method=1,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:"SQL",current:e.method===2,click(){e.method=2,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.regex,current:e.method===3,click(){e.method=3,t()}}).element)},It=(e,t,n,s,a)=>{e.removed=!1;const i=e;i.name=s,t.push(Object.assign({},i)),window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},e),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]),fetchPost("/api/storage/setCriterion",{criterion:i},()=>{var l;a.destroy();const o=n.querySelector("#criteria").firstElementChild;o.classList.remove("fn__none"),(l=o.querySelector(".b3-chip--current"))==null||l.classList.remove("b3-chip--current"),o.insertAdjacentHTML("beforeend",`<div data-type="set-criteria" class="b3-chip b3-chip--current b3-chip--middle b3-chip--pointer b3-chip--${["secondary","primary","info","success","warning","error",""][o.childElementCount%7]}">${i.name}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`)})},si=(e,t,n)=>{const s=new Dialog({title:window.siyuan.languages.saveCriterion,content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});s.element.setAttribute("data-key",Constants.DIALOG_SAVECRITERION);const a=s.element.querySelectorAll(".b3-button");s.bindInput(s.element.querySelector("input"),()=>{a[1].dispatchEvent(new CustomEvent("click"))}),a[0].addEventListener("click",()=>{s.destroy()}),a[1].addEventListener("click",()=>{const i=s.element.querySelector("input").value.trim();if(!i){showMessage(window.siyuan.languages._kernel[142]);return}isMobile()?(e.k=document.querySelector("#toolbarSearch").value,e.r=n.querySelector("#toolbarReplace").value):(e.k=n.querySelector("#searchInput").value,e.r=n.querySelector("#replaceInput").value);const l=n.querySelector("#criteria").firstElementChild;let o="",r="";if(t.forEach(c=>{c.name===i&&(o=c.name),ia(c,e)&&(r=c.name)}),o&&!r)confirmDialog(window.siyuan.languages.confirm,window.siyuan.languages.searchOverwrite,()=>{Array.from(l.children).forEach(c=>{c.textContent===i&&c.remove()}),t.find((c,f)=>{if(c.name===i)return t.splice(f,1),!0}),It(e,t,n,i,s)});else if(o&&r)if(o===r)s.destroy();else{const c=o===i?r:o;confirmDialog(window.siyuan.languages.confirm,window.siyuan.languages.searchRemoveName.replace("${x}",c).replace("${y}",i),()=>{Array.from(l.children).forEach(f=>{(f.textContent===r||f.textContent===o)&&f.remove()}),t.find((f,u)=>{if(f.name===c||f.name===o)return fetchPost("/api/storage/removeCriterion",{name:c}),t.splice(u,1),!0}),It(e,t,n,i,s)})}else!o&&r?confirmDialog(window.siyuan.languages.confirm,window.siyuan.languages.searchUpdateName.replace("${x}",r).replace("${y}",i),()=>{Array.from(l.children).forEach(c=>{c.textContent===r&&c.remove()}),t.find((c,f)=>{if(c.name===r)return fetchPost("/api/storage/removeCriterion",{name:r}),t.splice(f,1),!0}),It(e,t,n,i,s)}):It(e,t,n,i,s)})},wc=(e,t,n,s,a,i)=>ti(void 0,null,function*(){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchMore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchMore"),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.searchType,click(){ni(e,()=>{updateSearchResult(e,n,!0)})}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.replaceType,click(){ai(e)}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.searchMethod,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.keyword,current:e.method===0,click(){e.method=0,e.page=1,updateSearchResult(e,n,!0)}},{iconHTML:"",label:window.siyuan.languages.querySyntax,current:e.method===1,click(){e.method=1,e.page=1,updateSearchResult(e,n,!0)}},{iconHTML:"",label:"SQL",current:e.method===2,click(){e.method=2,e.page=1,updateSearchResult(e,n,!0)}},{iconHTML:"",label:window.siyuan.languages.regex,current:e.method===3,click(){e.method=3,e.page=1,updateSearchResult(e,n,!0)}}]}).element);const l=[{iconHTML:"",label:window.siyuan.languages.type,current:e.sort===0,click(){e.sort=0,s()}},{iconHTML:"",label:window.siyuan.languages.createdASC,current:e.sort===1,click(){e.sort=1,s()}},{iconHTML:"",label:window.siyuan.languages.createdDESC,current:e.sort===2,click(){e.sort=2,s()}},{iconHTML:"",label:window.siyuan.languages.modifiedASC,current:e.sort===3,click(){e.sort=3,s()}},{iconHTML:"",label:window.siyuan.languages.modifiedDESC,current:e.sort===4,click(){e.sort=4,s()}},{iconHTML:"",label:window.siyuan.languages.sortByRankAsc,current:e.sort===6,click(){e.sort=6,s()}},{iconHTML:"",label:window.siyuan.languages.sortByRankDesc,current:e.sort===7,click(){e.sort=7,s()}}];e.group===1&&l.push({iconHTML:"",label:window.siyuan.languages.sortByContent,current:e.sort===5,click(){e.sort=5,s()}}),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.sort,type:"submenu",submenu:l}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.group,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.noGroupBy,current:e.group===0,click(){isMobile()?(n.querySelector('[data-type="expand"]').classList.add("fn__none"),n.querySelector('[data-type="contract"]').classList.add("fn__none")):n.querySelector("#searchCollapse").parentElement.classList.add("fn__none"),e.group=0,e.sort===5&&(e.sort=0),s()}},{iconHTML:"",label:window.siyuan.languages.groupByDoc,current:e.group===1,click(){isMobile()?(n.querySelector('[data-type="expand"]').classList.remove("fn__none"),n.querySelector('[data-type="contract"]').classList.remove("fn__none")):n.querySelector("#searchCollapse").parentElement.classList.remove("fn__none"),e.group=1,s()}}]}).element),i&&i(),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.saveCriterion,iconHTML:"",click(){si(e,t,n)}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.removeCriterion,click(){a()}}).element)}),ia=(e,t)=>!!(t.group===e.group&&t.hPath===e.hPath&&t.hasReplace===e.hasReplace&&t.k===e.k&&t.method===e.method&&t.r===e.r&&t.sort===e.sort&&objEquals(t.types,e.types)&&objEquals(t.replaceTypes,e.replaceTypes)&&objEquals(t.idPath,e.idPath)),_c=(e,t,n)=>{fetchPost("/api/storage/getCriteria",{},s=>{let a="";s.data.forEach((i,l)=>{t.push(i);let o=!1;ia(i,n)&&(o=!0),a+=`<div data-type="set-criteria" class="${o?"b3-chip--current ":""}b3-chip b3-chip--middle b3-chip--pointer b3-chip--${["secondary","primary","info","success","warning","error",""][l%7]}">${escapeHtml(i.name)}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`}),e.innerHTML=`<div class="b3-chips">
    ${a}
</div>`,a===""?e.classList.add("fn__none"):e.classList.remove("fn__none")})},vc=e=>{const t=[];return e.querySelectorAll("mark").forEach(n=>{t.push(n.textContent)}),[...new Set(t)].join(" ")},Ec=(e,t)=>{};let oa;const rn=(e,t,n=1)=>{var s;if(!isPaidUser()){e.nextElementSibling.classList.add("fn__none"),(s=e.querySelector(".search__drag"))==null||s.classList.add("fn__none"),e.querySelector("#searchAssetPreview").classList.add("fn__none"),e.querySelector("#searchAssetList").innerHTML=`<div class="search__empty">
    ${window.siyuan.languages._kernel[214]}
</div>`;return}e.nextElementSibling.classList.remove("fn__none"),clearTimeout(oa),oa=window.setTimeout(()=>{t||(t=window.siyuan.storage[Constants.LOCAL_SEARCHASSET]);const a=e.querySelector('[data-type="assetPrevious"]');n>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled");const i=e.querySelector("#searchAssetInput");fetchPost("/api/search/fullTextSearchAssetContent",{page:n,query:i.value,types:t.types,method:t.method,orderBy:t.sort},l=>{var o,r;e.nextElementSibling.classList.add("fn__none");const c=e.querySelector('[data-type="assetNext"]');n<l.data.pageCount?c.removeAttribute("disabled"):c.setAttribute("disabled","disabled");let f="";l.data.assetContents.forEach((d,g)=>{f+=`<div data-type="search-item" class="b3-list-item${g===0?" b3-list-item--focus":""}" data-id="${d.id}">
<span class="ft__on-surface">${d.ext}</span>
<span class="fn__space"></span>
<span class="b3-list-item__text">${d.content}</span>
<span class="b3-list-item__meta">${d.hSize}</span>
<span class="b3-list-item__meta b3-list-item__meta--ellipsis ariaLabel" aria-label="${escapeAriaLabel(d.path)}">${d.name}</span>
</div>`});const u=e.querySelector("#searchAssetPreview");l.data.assetContents.length>0?(u.classList.remove("fn__none"),(o=e.querySelector(".search__drag"))==null||o.classList.remove("fn__none"),ii(u,l.data.assetContents[0].id,i.value,t.method)):(u.classList.add("fn__none"),(r=e.querySelector(".search__drag"))==null||r.classList.add("fn__none")),e.querySelector("#searchAssetResult").innerHTML=`<span class="fn__flex-center">${n}/${l.data.pageCount||1}</span><span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.total} ${l.data.matchedAssetCount}</span>`,e.querySelector("#searchAssetList").innerHTML=f||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},Constants.TIMEOUT_INPUT)},kc=e=>{const t=window.siyuan.storage[Constants.LOCAL_SEARCHASSET].keys;if(!t||t.length===0)return;const n=new Menu("search-asset-history");if(n.isOpen)return;n.element.classList.add("b3-menu--list"),n.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[Constants.LOCAL_SEARCHASSET].keys=[],setStorageVal(Constants.LOCAL_SEARCHASSET,window.siyuan.storage[Constants.LOCAL_SEARCHASSET])}});const s=n.addSeparator(1);let a=!0;const i=e.querySelector("#searchAssetInput");t.forEach(o=>{if(o!==i.value&&o){const r=n.addItem({iconHTML:"",label:escapeHtml(o),action:"iconCloseRound",bind(c){c.addEventListener("click",f=>{var u;hasClosestByClassName(f.target,"b3-menu__action")?(t.find((d,g)=>{if(d===o)return t.splice(g,1),!0}),window.siyuan.storage[Constants.LOCAL_SEARCHASSET].keys=t,setStorageVal(Constants.LOCAL_SEARCHASSET,window.siyuan.storage[Constants.LOCAL_SEARCHASSET]),(u=c.previousElementSibling)!=null&&u.classList.contains("b3-menu__separator")&&!c.nextElementSibling?window.siyuan.menus.menu.remove():c.remove()):(i.value=c.textContent,rn(e),window.siyuan.menus.menu.remove()),f.preventDefault(),f.stopPropagation()})}});a&&r.classList.add("b3-menu__item--current"),a=!1}}),a&&s.remove();const l=i.getBoundingClientRect();n.open({x:l.left,y:l.bottom})},ii=(e,t,n,s)=>{fetchPost("/api/search/getAssetContent",{id:t,query:n,queryMethod:s},a=>{e.innerHTML=`<p style="white-space: pre-wrap;">${a.data.assetContent.content}</p>`;const i=e.querySelector("mark");if(i){i.classList.add("mark--hl");const l=e.getBoundingClientRect();e.scrollTop=e.scrollTop+i.getBoundingClientRect().top-l.top-l.height/2}})},Cc=e=>{let t;const n=Array.from(e.querySelectorAll("mark"));if(n.find((s,a)=>{if(s.classList.contains("mark--hl")){s.classList.remove("mark--hl"),t=n[a+1];return}}),t||(t=n[0]),t){t.classList.add("mark--hl");const s=e.getBoundingClientRect();e.scrollTop=e.scrollTop+t.getBoundingClientRect().top-s.top-s.height/2}},Ac=(e,t)=>{const n=window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method;if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchAssetMethod"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchAssetMethod"),window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,label:window.siyuan.languages.keyword,current:n===0,click(){window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method=0,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,label:window.siyuan.languages.querySyntax,current:n===1,click(){window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method=1,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,label:window.siyuan.languages.regex,current:n===3,click(){window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method=3,t()}}).element),window.siyuan.menus.menu.fullscreen()},oi=e=>{let t="";return Constants.SIYUAN_ASSETS_SEARCH.sort((n,s)=>n.localeCompare(s)).forEach(n=>{t+=`<label class="fn__flex b3-label">
        <div class="fn__flex-1 fn__flex-center">
            ${n}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="${n}" type="checkbox" ${e[n]?" checked":""}>
    </label>`}),t},Lc=e=>{const t=window.siyuan.storage[Constants.LOCAL_SEARCHASSET].types,n=new Dialog({title:window.siyuan.languages.type,content:`<div class="b3-dialog__content">${oi(t)}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px",height:"70vh"});n.element.setAttribute("data-key",Constants.DIALOG_SEARCHASSETSTYPE);const s=n.element.querySelectorAll(".b3-button");s[0].addEventListener("click",()=>{n.destroy()}),s[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(a=>{t[a.getAttribute("data-type")]=a.checked}),rn(e),setStorageVal(Constants.LOCAL_SEARCHASSET,window.siyuan.storage[Constants.LOCAL_SEARCHASSET]),n.destroy()})},Sc=(e,t,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchAssetMore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchAssetMore");const s=window.siyuan.storage[Constants.LOCAL_SEARCHASSET],a=[{iconHTML:Constants.ZWSP,label:window.siyuan.languages.sortByRankAsc,current:s.sort===1,click(){s.sort=1,n()}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.sortByRankDesc,current:s.sort===0,click(){s.sort=0,n()}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.modifiedASC,current:s.sort===3,click(){s.sort=3,n()}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.modifiedDESC,current:s.sort===2,click(){s.sort=2,n()}}];window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,label:window.siyuan.languages.sort,type:"submenu",submenu:a}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,label:window.siyuan.languages.rebuildIndex,click(){if(!isPaidUser()){showMessage(window.siyuan.languages._kernel[214]);return}t.nextElementSibling.classList.remove("fn__none"),fetchPost("/api/asset/fullReindexAssetContent",{},()=>{rn(t,s)})}}).element),window.siyuan.menus.menu.fullscreen()},la=(e,t,n)=>{if(t.method===1||t.method===2){showMessage(window.siyuan.languages._kernel[132]);return}const s=e.querySelector("#searchList"),a=e.querySelector("#toolbarReplace"),i=a.parentElement.querySelector(".fn__rotate");if(!i.classList.contains("fn__none"))return;let l=s.querySelector(".b3-list-item--focus");if(!l)return;i.classList.remove("fn__none"),i.nextElementSibling.classList.add("fn__none");let o=[];n?s.querySelectorAll('.b3-list-item[data-type="search-item"]').forEach(r=>{o.push(r.getAttribute("data-node-id"))}):o=[l.getAttribute("data-node-id")],fetchPost("/api/search/findReplace",{k:t.method===0?getKeyByLiElement(l):document.querySelector("#toolbarSearch").value,r:a.value,ids:o,types:t.types,method:t.method,replaceTypes:t.replaceTypes},r=>{var c;if(i.classList.add("fn__none"),i.nextElementSibling.classList.remove("fn__none"),r.code===1){showMessage(r.msg);return}if(!(o.length>1)){if(reloadProtyle(window.siyuan.mobile.editor.protyle,!1),l.nextElementSibling?l.nextElementSibling.classList.add("b3-list-item--focus"):l.previousElementSibling&&l.previousElementSibling.classList.add("b3-list-item--focus"),t.group===1)if(l.nextElementSibling||l.previousElementSibling)l.remove();else{const f=l.parentElement.nextElementSibling||((c=l.parentElement.previousElementSibling.previousElementSibling)==null?void 0:c.previousElementSibling);f&&(f.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"),f.nextElementSibling.classList.remove("fn__none"),f.firstElementChild.firstElementChild.classList.add("b3-list-item__arrow--open")),l.parentElement.previousElementSibling.remove(),l.parentElement.remove()}else l.remove();if(l=s.querySelector(".b3-list-item--focus"),!l){s.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`;return}(s.scrollTop<l.offsetTop-s.clientHeight+30||s.scrollTop>l.offsetTop)&&(s.scrollTop=l.offsetTop-s.clientHeight+30)}})},ra=(e,t,n)=>{n.hasReplace!==t.hasReplace&&(t.hasReplace?(e.querySelector('[data-type="toggle-replace"]').classList.add("toolbar__icon--active"),e.querySelector(".toolbar").classList.remove("fn__none")):(e.querySelector('[data-type="toggle-replace"]').classList.remove("toolbar__icon--active"),e.querySelector(".toolbar").classList.add("fn__none")));const s=e.querySelector("#searchPath");t.hPath?(s.classList.remove("fn__none"),s.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(t.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`):s.classList.add("fn__none"),n.group!==t.group&&(t.group===0?(e.querySelector('[data-type="expand"]').classList.add("fn__none"),e.querySelector('[data-type="contract"]').classList.add("fn__none")):(e.querySelector('[data-type="expand"]').classList.remove("fn__none"),e.querySelector('[data-type="contract"]').classList.remove("fn__none")));let a=!0,i=!1;t.idPath.forEach(o=>{o.endsWith(".sy")&&(a=!1),o.split("/").length>1&&(i=!0)});const l=e.querySelector('[data-type="include"]');a?l.classList.add("toolbar__icon--active"):l.classList.remove("toolbar__icon--active"),i?l.removeAttribute("disabled"):l.setAttribute("disabled","disabled"),document.querySelector("#toolbarSearch").value=t.k,e.querySelector("#toolbarReplace").value=t.r,Object.assign(n,t),window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},n),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]),Te(n,e),window.siyuan.menus.menu.remove()},ca=(e,t,n)=>{const s=document.querySelector("#searchList");let a="";e.forEach((l,o)=>{const r=getNotebookName(l.box)+getDisplayName(l.hPath,!1);l.children?(a+=`<div class="b3-list-item">
<span class="b3-list-item__toggle b3-list-item__toggle--hl">
    <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
</span>
${unicode2Emoji(getNotebookIcon(l.box)||Constants.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text" style="color: var(--b3-theme-on-surface)">${escapeGreat(r)}</span>
</div><div>`,l.children.forEach((c,f)=>{a+=`<div style="padding-left: 36px" data-type="search-item" class="b3-list-item${f===0&&o===0?" b3-list-item--focus":""}" data-node-id="${c.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(c.type)}"></use></svg>
${unicode2Emoji(c.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${c.content}</span>
</div>`}),a+="</div>"):a+=`<div class="b3-list-item b3-list-item--two${o===0?" b3-list-item--focus":""}" data-type="search-item" data-node-id="${l.id}">
<div class="b3-list-item__first">
    <svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(l.type)}"></use></svg>
    ${unicode2Emoji(l.ial.icon,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${l.content}</span>
</div>
<span class="b3-list-item__text b3-list-item__meta">${escapeGreat(r)}</span>
</div>`}),s.innerHTML=a||`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
    <span class="b3-list-item__text">
        ${window.siyuan.languages.newFile} <mark>${document.querySelector("#toolbarSearch").value}</mark>
    </span>
</div>`,s.scrollTop=0;let i="";n&&(i=`<span class="fn__flex-center">${window.siyuan.languages.findInDoc.replace("${x}",n.data.matchedRootCount).replace("${y}",n.data.matchedBlockCount)}</span>
<span class="fn__flex-1"></span>
<span class="fn__flex-center">${t.page}/${n.data.pageCount||1}</span>`),s.previousElementSibling.querySelector('[data-type="result"]').innerHTML=i};let da=0;const Te=(e,t,n=!1)=>{clearTimeout(da),da=window.setTimeout(()=>{var s;n&&((s=t.querySelector("#criteria .b3-chip--current"))==null||s.classList.remove("b3-chip--current"));const a=t.querySelector(".fn__loading--top");a.classList.remove("fn__none");const i=t.querySelector('[data-type="previous"]'),l=t.querySelector('[data-type="next"]'),o=document.getElementById("toolbarSearch");o.value===""&&(!e.idPath||e.idPath.length===0)?fetchPost("/api/block/getRecentUpdatedBlocks",{},r=>{ca(r.data,e),a.classList.add("fn__none"),i.setAttribute("disabled","true"),l.setAttribute("disabled","true")}):(e.page||(e.page=1),e.page>1?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),fetchPost("/api/search/fullTextSearchBlock",{query:o.value,method:e.method,types:e.types,paths:e.idPath||[],groupBy:e.group,orderBy:e.sort,page:e.page},r=>{ca(r.data.blocks,e,r),a.classList.add("fn__none"),e.page<r.data.pageCount?l.removeAttribute("disabled"):l.setAttribute("disabled","disabled")}))},Constants.TIMEOUT_INPUT)},li=(e,t,n)=>{const s=document.getElementById("toolbarSearch");s.value=n.k||"",s.addEventListener("compositionend",c=>{c&&c.isComposing||(n.page=1,Te(n,t,!0))}),s.addEventListener("input",c=>{c&&c.isComposing||(n.page=1,Te(n,t,!0))}),s.addEventListener("blur",()=>{n.removed&&(n.k=s.value,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},n),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]))}),addClearButton({inputElement:s,className:"toolbar__icon",clearCB(){n.page=1,Te(n,t)}});const a=t.querySelector(".toolbar .toolbar__title");a.value=n.r||"",addClearButton({inputElement:a,className:"toolbar__icon"});const i=[];initCriteriaMenu(t.querySelector("#criteria"),i,n);const l=document.querySelector("#searchAssetsPanel"),o=t.querySelector("#searchList"),r=window.siyuan.storage[Constants.LOCAL_SEARCHASSET];t.addEventListener("click",c=>{var f,u;let d=c.target;for(;d&&!d.isSameNode(t);){const g=d.getAttribute("data-type");if(g==="previous"){d.getAttribute("disabled")||(n.page--,Te(n,t)),c.stopPropagation(),c.preventDefault();break}else if(g==="next"){d.getAttribute("disabled")||(n.page++,Te(n,t)),c.stopPropagation(),c.preventDefault();break}else if(g==="set-criteria"){n.removed=!1,(f=d.parentElement.querySelector(".b3-chip--current"))==null||f.classList.remove("b3-chip--current"),d.classList.add("b3-chip--current"),i.find(p=>{if(p.name===d.innerText.trim())return ra(t,p,n),!0}),c.stopPropagation(),c.preventDefault();break}else if(g==="remove-criteria"){const p=d.parentElement.innerText.trim();fetchPost("/api/storage/removeCriterion",{name:p}),i.find((b,m)=>{if(b.name===p)return i.splice(m,1),!0}),d.parentElement.parentElement.childElementCount===1&&d.parentElement.parentElement.classList.add("fn__none"),d.parentElement.remove(),c.stopPropagation(),c.preventDefault();break}else if(g==="remove-path"){n.idPath=[],n.hPath="",t.querySelector("#searchPath").classList.add("fn__none"),n.page=1,Te(n,t,!0);const p=t.querySelector('[data-type="include"]');p.classList.remove("toolbar__icon--active"),p.setAttribute("disabled","disabled"),c.stopPropagation(),c.preventDefault();break}else if(g==="expand"){Array.from(o.children).forEach(p=>{p.classList.contains("b3-list-item")&&(p.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),p.nextElementSibling.classList.remove("fn__none"))}),c.stopPropagation(),c.preventDefault();break}else if(g==="contract"){Array.from(o.children).forEach(p=>{p.classList.contains("b3-list-item")&&(p.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),p.nextElementSibling.classList.add("fn__none"))}),c.stopPropagation(),c.preventDefault();break}else if(g==="currentPath"&&!d.hasAttribute("disabled")){const p=getCurrentEditor().protyle;fetchPost("/api/filetree/getHPathsByPaths",{paths:[p.path]},b=>{n.idPath=[pathPosix().join(p.notebookId,p.path)],n.hPath=b.data[0];const m=t.querySelector("#searchPath");m.classList.remove("fn__none"),m.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(n.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const h=t.querySelector('[data-type="include"]');h.classList.remove("toolbar__icon--active"),h.removeAttribute("disabled"),n.page=1,Te(n,t,!0)}),c.stopPropagation(),c.preventDefault();break}else if(g==="path"){movePathTo((p,b)=>{fetchPost("/api/filetree/getHPathsByPaths",{paths:p},m=>{n.idPath=[];const h=[];let y=!1;p.forEach((A,v)=>{A==="/"?(n.idPath.push(b[v]),h.push(getNotebookName(b[v]))):(y=!0,n.idPath.push(pathPosix().join(b[v],A.replace(".sy",""))))}),m.data&&h.push(...m.data),n.hPath=h.join(" ");const k=t.querySelector("#searchPath");k.classList.remove("fn__none"),k.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(n.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const E=t.querySelector('[data-type="include"]');E.classList.add("toolbar__icon--active"),y?E.removeAttribute("disabled"):E.setAttribute("disabled","disabled"),n.page=1,Te(n,t,!0)})},[],void 0,window.siyuan.languages.specifyPath),c.stopPropagation(),c.preventDefault();break}else if(g==="include"&&!d.hasAttribute("disabled")){d.classList.toggle("toolbar__icon--active"),d.classList.contains("toolbar__icon--active")?n.idPath.forEach((p,b)=>{p.endsWith(".sy")&&(n.idPath[b]=p.replace(".sy",""))}):n.idPath.forEach((p,b)=>{!p.endsWith(".sy")&&p.split("/").length>1&&(n.idPath[b]=p+".sy")}),n.page=1,Te(n,t,!0),c.stopPropagation(),c.preventDefault();break}else if(g==="toggle-replace"){n.hasReplace=!n.hasReplace,a.parentElement.classList.toggle("fn__none"),d.classList.toggle("toolbar__icon--active"),c.stopPropagation(),c.preventDefault();break}else if(g==="more"){moreMenu(n,i,t,()=>{n.page=1,Te(n,t,!0)},()=>{ra(t,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock},replaceTypes:Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)},n)}),window.siyuan.menus.menu.fullscreen(),c.stopPropagation(),c.preventDefault();break}else if(g==="replace-all"){la(t,n,!0),c.stopPropagation(),c.preventDefault();break}else if(g==="queryAsset"){assetMethodMenu(d,()=>{assetInputEvent(l,r),setStorageVal(Constants.LOCAL_SEARCHASSET,r)}),c.stopPropagation(),c.preventDefault();break}else if(g==="filterAsset"){assetFilterMenu(l),c.stopPropagation(),c.preventDefault();break}else if(g==="moreAsset"){assetMoreMenu(d,l,()=>{assetInputEvent(l),setStorageVal(Constants.LOCAL_SEARCHASSET,r)}),c.stopPropagation(),c.preventDefault();break}else if(g==="goAsset"){ri(),c.stopPropagation(),c.preventDefault();break}else if(g==="goSearch"){l.classList.add("fn__none"),c.stopPropagation(),c.preventDefault();break}else if(g==="assetPrevious"){d.getAttribute("disabled")||assetInputEvent(l,r,parseInt(l.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])-1),c.stopPropagation(),c.preventDefault();break}else if(g==="assetNext"){d.getAttribute("disabled")||assetInputEvent(l,r,parseInt(l.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])+1),c.stopPropagation(),c.preventDefault();break}else if(g==="replace"){la(t,n,!1),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item__toggle")){d.parentElement.nextElementSibling.classList.toggle("fn__none"),d.firstElementChild.classList.toggle("b3-list-item__arrow--open"),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item")){if(d.getAttribute("data-type")==="search-new")newFileByName(e,s.value);else if(d.getAttribute("data-type")==="search-item"){const p=d.getAttribute("data-node-id");p?((u=window.siyuan.mobile.editor)!=null&&u.protyle&&preventScroll(window.siyuan.mobile.editor.protyle),checkFold(p,b=>{openMobileFileById(e,p,b?[Constants.CB_GET_ALL,Constants.CB_GET_HL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL])}),closePanel()):d.classList.contains("b3-list-item--focus")?d.classList.contains("b3-list-item--focus")&&renderNextAssetMark(t.querySelector("#searchAssetPreview")):(t.querySelector("#searchAssetList .b3-list-item--focus").classList.remove("b3-list-item--focus"),d.classList.add("b3-list-item--focus"),renderPreview(t.querySelector("#searchAssetPreview"),d.dataset.id,t.querySelector("#searchAssetInput").value,window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method))}else d.querySelector(".b3-list-item__toggle")&&(d.nextElementSibling.classList.toggle("fn__none"),d.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"));c.stopPropagation(),c.preventDefault();break}d=d.parentElement}},!1)},xc=(e,t=window.siyuan.storage[Constants.LOCAL_SEARCHDATA])=>{activeBlur(),hideKeyboardToolbar();let n=!0,s=!1;t.idPath.forEach(a=>{a.endsWith(".sy")&&(n=!1),a.split("/").length>1&&(s=!0)}),openModel({title:`<div class="fn__flex">
    <input id="toolbarSearch" placeholder="${window.siyuan.languages.showRecentUpdatedBlocks}" class="toolbar__title fn__block">
    <svg id="toolbarSearchNew" class="toolbar__icon"><use xlink:href="#iconFile"></use></svg>
</div>`,icon:"iconSearch",html:`<div class="fn__flex-column" style="height: 100%">
    <div class="toolbar toolbar--border${t.hasReplace?"":" fn__none"}">
        <svg class="toolbar__icon"><use xlink:href="#iconReplace"></use></svg>
        <input id="toolbarReplace" class="toolbar__title">
        <svg class="fn__rotate fn__none toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
        <div class="fn__space"></div>
        <button data-type="replace-all" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replaceAll}</button>
        <div class="fn__space"></div>
        <button data-type="replace" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replace}</button>
        <div class="fn__space"></div>
    </div>
    <div id="criteria" style="background-color: var(--b3-theme-background);"></div>
    <div class="toolbar">
        <span class="fn__space"></span>
        <span data-type="result" class="fn__flex-1 fn__flex"></span>
        <span class="fn__space"></span>
        <svg data-type="previous" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
        <svg data-type="next" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
    </div>
    <div id="searchList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
    <div id="searchPath" class="b3-chips${t.hPath?"":" fn__none"}" style="background-color: var(--b3-theme-background);">
        <div class="b3-chip b3-chip--middle">
            ${escapeHtml(t.hPath)}
            <svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg>
        </div>
    </div>
    <div class="toolbar">
        <span class="fn__flex-1"></span>
        <svg data-type="toggle-replace" class="toolbar__icon${t.hasReplace?" toolbar__icon--active":""}"><use xlink:href="#iconReplace"></use></svg>
        <svg ${s?"":"disabled"} data-type="include" class="toolbar__icon${n?" toolbar__icon--active":""}"><use xlink:href="#iconCopy"></use></svg>
        <svg data-type="path" class="toolbar__icon"><use xlink:href="#iconFolder"></use></svg>
        <svg ${document.querySelector("#empty").classList.contains("fn__none")?"":"disabled"} data-type="currentPath" class="toolbar__icon"><use xlink:href="#iconFocus"></use></svg>
        <svg data-type="expand" class="toolbar__icon${t.group===0?" fn__none":""}"><use xlink:href="#iconExpand"></use></svg>
        <svg data-type="contract" class="toolbar__icon${t.group===0?" fn__none":""}"><use xlink:href="#iconContract"></use></svg>
        <svg data-type="more" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
        <svg data-type="goAsset" class="toolbar__icon"><use xlink:href="#iconExact"></use></svg>
        <span class="fn__flex-1"></span>
     </div>
     <div class="fn__none fn__flex-column" style="position: fixed;top: 0;width: 100%;background: var(--b3-theme-surface);height: 100%;" id="searchAssetsPanel">
        <div class="toolbar toolbar--border">
            <svg class="toolbar__icon"><use xlink:href="#iconSearch"></use></svg>
            <input id="searchAssetInput" placeholder="${window.siyuan.languages.keyword}" class="toolbar__title fn__block">
        </div>
        <div class="toolbar">
            <span class="fn__space"></span>
            <span id="searchAssetResult" class="fn__flex-1 fn__flex"><span class="fn__flex-1"></span></span>
            <span class="fn__space"></span>
            <svg data-type="assetPrevious" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
            <svg data-type="assetNext" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
        </div>
        <div id="searchAssetList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
        <div id="searchAssetPreview" class="fn__flex-1 search__preview b3-typography" style="padding: 8px;border-bottom: 1px solid var(--b3-border-color);"></div>
        <div class="toolbar">
            <span class="fn__flex-1"></span>
            <svg data-type="queryAsset" class="toolbar__icon"><use xlink:href="#iconRegex"></use></svg>
            <svg data-type="filterAsset" class="toolbar__icon"><use xlink:href="#iconFilter"></use></svg>
            <svg data-type="moreAsset" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
            <svg data-type="goSearch" class="toolbar__icon"><use xlink:href="#iconBack"></use></svg>
            <span class="fn__flex-1"></span>
         </div>
    </div>
     <div class="fn__loading fn__loading--top"><img width="120px" src="/stage/loading-pure.svg"></div>
</div>`,bindEvent(a){document.querySelector("#toolbarSearchNew").addEventListener("click",()=>{newFileByName(e,document.querySelector("#toolbarSearch").value)}),li(e,a.firstElementChild,t),Te(t,a)}})},ri=()=>{const e=document.querySelector("#searchAssetsPanel");if(e.classList.remove("fn__none"),e.querySelector("#searchAssetList").innerHTML)return;const n=window.siyuan.storage[Constants.LOCAL_SEARCHASSET],s=e.querySelector("input");s.value=n.k,s.addEventListener("compositionend",a=>{a.isComposing||assetInputEvent(e,n)}),s.addEventListener("input",a=>{a.isComposing||assetInputEvent(e,n)}),assetInputEvent(e,n),addClearButton({inputElement:s,className:"toolbar__icon",clearCB(){assetInputEvent(e,n)}})},Tc=e=>{fetchPost("/api/storage/getRecentDocs",{},t=>{let n="";t.data.forEach((s,a)=>{n+=`<li data-index="${a}" data-node-id="${s.rootID}" class="b3-list-item${a===0?" b3-list-item--focus":""}">
${unicode2Emoji(s.icon||Constants.SIYUAN_IMAGE_FILE,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${escapeHtml(s.title)}</span>
</li>`}),openModel({title:window.siyuan.languages.recentDocs,icon:"iconList",html:`<ul class="b3-list b3-list--mobile">${n}</ul>`,bindEvent(s){s.firstElementChild.addEventListener("click",a=>{const i=hasClosestByClassName(a.target,"b3-list-item");i&&openMobileFileById(e,i.dataset.nodeId,[Constants.CB_GET_SCROLL,Constants.CB_GET_HL])})}})})},cn=(e,t)=>{if(!e||e.length===0)return`<li style="padding-left: 40px;" class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;let n="";return e.forEach((s,a)=>{let i="";t&&(i=`data-id2="${t[a].fileID}"`),n+=`<li style="padding-left: 40px;" class="b3-list-item" ${i} data-id="${s.fileID}">
    <span class="b3-list-item__text" title="${escapeAttr(s.path)} ${s.hSize}">${escapeHtml(s.title)}</span>
</li>`}),n};let ze,st;const ua=(e,t)=>{const n=hasClosestByClassName(t,"history__diff");if(!n)return;const s=hasClosestByClassName(t,"b3-dialog__container");if(!s)return;const a=n.nextElementSibling.firstElementChild,i=n.nextElementSibling.lastElementChild;ze||(ze=new Protyle(e,a.lastElementChild,{blockId:"",history:{snapshot:""},action:[Constants.CB_GET_HISTORY],render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(ze.protyle),st=new Protyle(e,i.lastElementChild,{blockId:"",action:[Constants.CB_GET_HISTORY],history:{snapshot:""},render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(st.protyle)),fetchPost("/api/repo/openRepoSnapshotDoc",{id:t.getAttribute("data-id")},o=>{a.classList.remove("fn__none");const r=a.querySelector("textarea"),c=pathPosix().extname(o.data.content).toLowerCase();Constants.SIYUAN_ASSETS_IMAGE.concat(Constants.SIYUAN_ASSETS_AUDIO).concat(Constants.SIYUAN_ASSETS_VIDEO).includes(c)?(r.previousElementSibling.innerHTML=renderAssetsPreview(o.data.content),r.previousElementSibling.classList.remove("fn__none"),r.classList.add("fn__none"),a.lastElementChild.classList.add("fn__none")):o.data.isProtyleDoc?(r.value=o.data.content,r.classList.remove("fn__none"),a.lastElementChild.classList.add("fn__none"),r.previousElementSibling.classList.add("fn__none")):(r.classList.add("fn__none"),a.lastElementChild.classList.remove("fn__none"),r.previousElementSibling.classList.add("fn__none"),ze.protyle.options.history.snapshot=s.querySelector(".b3-dialog__header code").getAttribute("data-snapshot"),onGet({data:o,protyle:ze.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]})),a.querySelector(".history__date").textContent=dayjs(o.data.updated).format("YYYY-MM-DD HH:mm")});const l=t.getAttribute("data-id2");l?(i.classList.remove("fn__none"),fetchPost("/api/repo/openRepoSnapshotDoc",{id:l},o=>{const r=i.querySelector("textarea"),c=pathPosix().extname(o.data.content).toLowerCase();Constants.SIYUAN_ASSETS_IMAGE.concat(Constants.SIYUAN_ASSETS_AUDIO).concat(Constants.SIYUAN_ASSETS_VIDEO).includes(c)?(r.previousElementSibling.innerHTML=renderAssetsPreview(o.data.content),r.previousElementSibling.classList.remove("fn__none"),r.classList.add("fn__none"),i.lastElementChild.classList.add("fn__none")):o.data.isProtyleDoc?(r.value=o.data.content,r.classList.remove("fn__none"),i.lastElementChild.classList.add("fn__none"),r.previousElementSibling.classList.add("fn__none")):(r.classList.add("fn__none"),i.lastElementChild.classList.remove("fn__none"),r.previousElementSibling.classList.add("fn__none"),st.protyle.options.history.snapshot=s.querySelectorAll(".b3-dialog__header code")[1].getAttribute("data-snapshot"),onGet({data:o,protyle:st.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]})),i.querySelector(".history__date").textContent=dayjs(o.data.updated).format("YYYY-MM-DD HH:mm")})):i.classList.add("fn__none")},Ic=(e,t)=>{if(t.length!==2)return;let n,s;t[0].time>t[1].time?(n=t[1].id,s=t[0].id):(n=t[0].id,s=t[1].id);const a=new Dialog({title:window.siyuan.languages.compare,content:"",width:isMobile()?"92vw":"90vw",height:"80vh",destroyCallback(){ze=void 0,st=void 0}});a.element.setAttribute("data-key",Constants.DIALOG_HISTORYCOMPARE),a.element.addEventListener("click",i=>{var l;if(typeof i.detail=="string"){ua(e,a.element.querySelector(".history__diff .b3-list-item--focus")),i.stopPropagation(),i.preventDefault();return}let o=i.target;for(;o&&o!==a.element;){if(o.classList.contains("b3-list-item")&&!o.dataset.id){o.nextElementSibling.classList.toggle("fn__none"),o.querySelector("svg").classList.toggle("b3-list-item__arrow--open"),i.preventDefault(),i.stopPropagation();break}else if(o.classList.contains("b3-list-item")&&o.dataset.id){if(o.classList.contains("b3-list-item--focus"))return;(l=a.element.querySelector(".history__diff .b3-list-item--focus"))==null||l.classList.remove("b3-list-item--focus"),o.classList.add("b3-list-item--focus"),ua(e,o),i.preventDefault(),i.stopPropagation();break}else if(o.classList.contains("block__icon")){o.getAttribute("data-direct")==="left"?(o.setAttribute("data-direct","right"),dn(s,n,a,"right")):(o.setAttribute("data-direct","left"),dn(n,s,a,"left")),i.preventDefault(),i.stopPropagation();break}o=o.parentElement}}),dn(n,s,a,"left")},dn=(e,t,n,s)=>{ze=void 0,st=void 0;const a=isMobile();fetchPost("/api/repo/diffRepoSnapshots",{left:e,right:t},i=>{const l=n.element.querySelector(".b3-dialog__header");l.innerHTML=`<div style="padding: 0;min-height: auto;" class="block__icons">
    <span class="fn__flex-1"></span>
    <code class="fn__code${a?" fn__none":""}" data-snapshot="${e}">${e.substring(0,7)}</code>
    ${a?"":'<span class="fn__space"></span>'}
    ${dayjs(i.data.left.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show b3-tooltips b3-tooltips__s" aria-label="${window.siyuan.languages.switchDirect}" data-direct="${s}"><svg><use xlink:href="#iconScrollHoriz"></use></svg></span>
    <span class="fn__space"></span>
    <code class="fn__code${a?" fn__none":""}" data-snapshot="${t}">${t.substring(0,7)}</code>
    ${a?"":'<span class="fn__space"></span>'}
    ${dayjs(i.data.right.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__flex-1"></span>
</div>`,l.nextElementSibling.innerHTML=`<div class="fn__flex history__panel" style="height: 100%">
    <div class="history__diff">
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.update}</span>
                <span class="counter${i.data.updatesLeft.length===0?" fn__none":""}">${i.data.updatesLeft.length}</span>
            </li>
            <ul class="fn__none">${cn(i.data.updatesLeft,i.data.updatesRight)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.addAttr}</span>
                <span class="counter${i.data.addsLeft.length===0?" fn__none":""}">${i.data.addsLeft.length}</span>
            </li>
            <ul class="fn__none">${cn(i.data.addsLeft)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.remove}</span>
                <span class="counter${i.data.removesRight.length===0?" fn__none":""}">${i.data.removesRight.length}</span>
            </li>
            <ul class="fn__none">${cn(i.data.removesRight)}</ul>
        </ul>
    </div>
    <div class="fn__flex-1 fn__flex">
        <div class="fn__none fn__flex-1 fn__flex-column">
            <div class="history__date">${dayjs(i.data.left.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
        <div class="fn__none fn__flex-1 fn__flex-column" style="border-left: 1px solid var(--b3-border-color);">
            <div class="history__date">${dayjs(i.data.right.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
    </div>
</div>`})};let it;const bt=(e,t)=>{const n=e.querySelector('[data-type="docprevious"]'),s=e.querySelector('[data-type="docnext"]');e.setAttribute("data-page",t.toString()),t>1?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled");const a=e.querySelector(".b3-text-field"),i=e.querySelector('.b3-select[data-type="opselect"]'),l=e.querySelector('.b3-select[data-type="typeselect"]'),o=e.querySelector('.b3-select[data-type="notebookselect"]');window.siyuan.storage[Constants.LOCAL_HISTORYNOTEID]=o.value,setStorageVal(Constants.LOCAL_HISTORYNOTEID,window.siyuan.storage[Constants.LOCAL_HISTORYNOTEID]);const r=e.querySelector('.history__text[data-type="docPanel"]'),c=e.querySelector('.history__text[data-type="assetPanel"]'),f=e.querySelector('.history__text[data-type="mdPanel"]');r.classList.add("fn__none"),f.classList.add("fn__none"),l.value==="0"||l.value==="1"?(i.removeAttribute("disabled"),o.removeAttribute("disabled"),c.classList.add("fn__none")):(i.setAttribute("disabled","disabled"),o.setAttribute("disabled","disabled"),c.classList.remove("fn__none")),fetchPost("/api/history/searchHistory",{notebook:o.value,query:a.value,page:t,op:i.value,type:parseInt(l.value)},u=>{if(t<u.data.pageCount?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"),s.nextElementSibling.nextElementSibling.textContent=`${t}/${u.data.pageCount||1}`,u.data.histories.length===0){e.lastElementChild.lastElementChild.previousElementSibling.classList.add("fn__none"),e.lastElementChild.lastElementChild.classList.add("fn__none"),e.lastElementChild.firstElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let d="";u.data.histories.forEach(g=>{d+=`<li class="b3-list-item" data-type="toggle" data-created="${g}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl"><svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg></span>
    <span style="padding-left: 4px" class="b3-list-item__text">${dayjs(parseInt(g)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
</li>`}),e.lastElementChild.firstElementChild.innerHTML=d})},fa=(e,t,n)=>{if(e.data.snapshots.length===0){t.lastElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let s="";n==="getCloudRepoTagSnapshots"?s=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="downloadSnapshot">
    <svg><use xlink:href="#iconDownload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.download}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="removeCloudRepoTagSnapshot">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.remove}
</span>
<span class="fn__flex-1"></span>`:n==="getCloudRepoSnapshots"?s=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="downloadSnapshot">
    <svg><use xlink:href="#iconDownload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.download}
</span>
<span class="fn__flex-1"></span>`:n==="getRepoTagSnapshots"?s=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="uploadSnapshot">
    <svg><use xlink:href="#iconUpload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.upload}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="rollback">
    <svg><use xlink:href="#iconUndo"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.rollback}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="removeRepoTagSnapshot">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.remove}
</span>
<span class="fn__flex-1"></span>`:n==="getRepoSnapshots"&&(s=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="genTag">
    <svg><use xlink:href="#iconTags"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.tagSnapshot}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="rollback">
    <svg><use xlink:href="#iconUndo"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.rollback}
</span>
<span class="fn__flex-1"></span>`);let a="";const i=isMobile();e.data.snapshots.forEach(l=>{let o="";l.typesCount&&(o=`<div class="b3-list-item__meta${i?" fn__none":""}">
${window.siyuan.languages.fileCount} ${l.count}<span class="fn__space"></span>`,l.typesCount.forEach(c=>{o+=`${c.type} ${c.count}<span class="fn__space"></span>`}),o+="</div>");const r=`<div${i?' style="padding-top:8px"':""}>
    <span data-type="hCreated">${l.hCreated}</span>
    <span class="fn__space"></span>
    ${l.hSize}
    <span class="fn__space"></span>
    ${l.systemOS}${l.systemName&&l.systemOS?"/":""}${l.systemName}
    <span class="fn__space"></span>
    <span class="b3-chip b3-chip--secondary b3-chip--small${l.tag?"":" fn__none"}">${l.tag}</span>
</div>
<div class="b3-list-item__meta${i?" fn__none":""}">
    ${escapeHtml(l.memo)}
    <span class="fn__space"></span>
    <code class="fn__code">${l.id.substring(0,7)}</code>
</div>
${o}`;a+=`<li class="b3-list-item" data-type="repoitem" data-id="${l.id}" data-tag="${l.tag}">
<div class="fn__flex-1">
    ${r}
    <div class="fn__flex" style="height: 26px" data-id="${l.id}" data-tag="${l.tag}">
        ${s}
        <span class="b3-list-item__action" data-type="more">
            <svg><use xlink:href="#iconMore"></use></svg>
            <span class="fn__space"></span>
            ${window.siyuan.languages.more}
        </span>
        <span class="fn__flex-1"></span>
    </div>
</div>
</li>`}),t.lastElementChild.innerHTML=`${a}`},Ke=(e,t)=>{const n=e.querySelector(".b3-select").value;e.lastElementChild.innerHTML='<li style="position: relative;height: 100%;"><div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div></li>';const s=e.querySelector('[data-type="previous"]'),a=e.querySelector('[data-type="next"]'),i=a.nextElementSibling.nextElementSibling;e.setAttribute("data-init","true"),n==="getRepoTagSnapshots"||n==="getCloudRepoTagSnapshots"?(fetchPost(`/api/repo/${n}`,{},l=>{fa(l,e,n)}),s.classList.add("fn__none"),a.classList.add("fn__none"),i.classList.add("fn__none")):(s.classList.remove("fn__none"),a.classList.remove("fn__none"),i.classList.remove("fn__none"),e.setAttribute("data-page",t.toString()),t>1?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"),a.setAttribute("disabled","disabled"),fetchPost(`/api/repo/${n}`,{page:t},l=>{t<l.data.pageCount?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),i.textContent=`${t}/${l.data.pageCount||1}`,fa(l,e,n)}))},ci=e=>{e.setAttribute("data-init","true"),fetchPost("/api/history/getNotebookHistory",{},t=>{if(t.data.histories.length===0){e.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let n="";t.data.histories.forEach((s,a)=>{n+=`<li class="b3-list-item" style="padding-left: 0" data-type="rmtoggle">
    <span style="padding-left: 8px" class="b3-list-item__toggle"><svg class="b3-list-item__arrow${a===0?" b3-list-item__arrow--open":""}${s.items.length>0?"":" fn__hidden"}"><use xlink:href="#iconRight"></use></svg></span>
    <span class="b3-list-item__text">${s.hCreated}</span>
</li>`,s.items.length>0&&(n+=`<ul class="${a===0?"":"fn__none"}">`,s.items.forEach(i=>{n+=`<li data-type="notebook" data-path="${i.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 32px">
    <span class="b3-list-item__text">${escapeHtml(i.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),n+="</ul>")}),e.innerHTML=n})},Mc=e=>{if(window.siyuan.config.readonly||window.siyuan.dialogs.find(a=>{if(a.element.querySelector("#historyContainer"))return a.destroy(),!0}))return;let n="";window.siyuan.notebooks.forEach(a=>{a.closed||(n+=` <option value="${a.id}"${a.id===window.siyuan.storage[Constants.LOCAL_HISTORYNOTEID]?" selected":""}>${escapeHtml(a.name)}</option>`)});const s=`<div class="fn__flex-column" style="height: 100%;">
    <div class="layout-tab-bar fn__flex" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
        <div data-type="doc" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.fileHistory}</span><span class="fn__flex-1"></span></div>
        <div data-type="notebook" style="min-width: 160px" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.removedNotebook}</span><span class="fn__flex-1"></span></div>
        <div data-type="repo" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.dataSnapshot}</span><span class="fn__flex-1"></span></div>
    </div>
    <div class="fn__flex-1 fn__flex" id="historyContainer">
        <div data-type="doc" class="history__repo fn__block" data-init="true">
            <div style="overflow:auto;">
                <div class="block__icons">
                    <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <span class="fn__space"></span>
                    <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span>1/1</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <div style="position: relative">
                        <svg class="b3-form__icon-icon ft__on-surface"><use xlink:href="#iconSearch"></use></svg>
                        <input class="b3-text-field b3-form__icon-input ${isMobile()?"fn__size96":"fn__size200"}">
                    </div>
                    <span class="fn__space"></span>
                    <select data-type="typeselect" class="b3-select ${isMobile()?"fn__size96":"fn__size200"}">
                        <option value="0" selected>${window.siyuan.languages.docName}</option>
                        <option value="1">${window.siyuan.languages.docNameAndContent}</option>
                        <option value="2">${window.siyuan.languages.assets}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="opselect" class="b3-select${isMobile()?" fn__size96":""}">
                        <option value="all" selected>${window.siyuan.languages.allOp}</option>
                        <option value="clean">clean</option>
                        <option value="update">update</option>
                        <option value="delete">delete</option>
                        <option value="format">format</option>
                        <option value="sync">sync</option>
                        <option value="replace">replace</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="notebookselect" class="b3-select ${isMobile()?"fn__size96":"fn__size200"}">
                        ${n}
                    </select>
                    <span class="fn__space"></span>
                    <button data-type="rebuildIndex" class="b3-button b3-button--outline">${window.siyuan.languages.rebuildIndex}</button>
                </div>
            </div>
            <div class="fn__flex fn__flex-1 history__panel">
                <ul class="b3-list b3-list--background" style="overflow:auto;">
                    <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
                </ul>
                <div class="fn__flex-1 history__text fn__none" data-type="assetPanel"></div>
                <textarea class="fn__flex-1 history__text fn__none" data-type="mdPanel"></textarea>
                <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
            </div>
        </div>
        <ul data-type="notebook" style="padding: 8px 0;" class="fn__none b3-list b3-list--background">
            <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
        </ul>
        <div data-type="repo" class="fn__none history__repo">
            <div style="overflow: auto"">
                <div class="block__icons">
                    <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <span class="fn__space"></span>
                    <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span>1/1</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <select class="b3-select ${isMobile()?"fn__size96":"fn__size200"}">
                        <option value="getRepoSnapshots">${window.siyuan.languages.localSnapshot}</option>
                        <option value="getRepoTagSnapshots">${window.siyuan.languages.localTagSnapshot}</option>
                        <option value="getCloudRepoSnapshots">${window.siyuan.languages.cloudSnapshot}</option>
                        <option value="getCloudRepoTagSnapshots">${window.siyuan.languages.cloudTagSnapshot}</option>
                    </select>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" disabled data-type="compare">${window.siyuan.languages.compare}</button>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" data-type="genRepo">
                        <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.createSnapshot}
                    </button>
                </div>    
            </div>
            <ul class="b3-list b3-list--background fn__flex-1" style="padding-bottom: 8px">
                <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
            </ul>
        </div>
    </div>
</div>`;if(isMobile())openModel({html:s,icon:"iconHistory",title:window.siyuan.languages.dataHistory,bindEvent(a){ga(e,a.firstElementChild)}});else{const a=new Dialog({content:s,width:"90vw",height:"80vh",destroyCallback(){it=void 0}});a.element.setAttribute("data-key",Constants.DIALOG_HISTORY),ga(e,a.element,a)}},ga=(e,t,n)=>{const s=t.querySelector("#historyContainer [data-type=doc]");s.querySelectorAll(".b3-select").forEach(c=>{c.addEventListener("change",()=>{bt(s,1)})}),s.querySelector(".b3-text-field").addEventListener("input",c=>{c.isComposing||bt(s,1)}),s.querySelector(".b3-text-field").addEventListener("compositionend",()=>{bt(s,1)});const a=s.querySelector('.history__text[data-type="docPanel"]'),i=s.querySelector('.history__text[data-type="assetPanel"]'),l=s.querySelector('.history__text[data-type="mdPanel"]');bt(s,1),it=new Protyle(e,a,{blockId:"",history:{created:""},action:[Constants.CB_GET_HISTORY],render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(it.protyle);const o=t.querySelector('#historyContainer [data-type="repo"]'),r=o.querySelector(".b3-select");r.addEventListener("change",()=>{Ke(o,1);const c=t.querySelector(".b3-button[data-type='compare']");c.setAttribute("disabled","disabled"),c.removeAttribute("data-ids")}),t.addEventListener("click",c=>{var f;let u=c.target;for(;u&&!u.isEqualNode(t);){const d=u.getAttribute("data-type");if(u.classList.contains("item")){u.parentElement.querySelector(".item--focus").classList.remove("item--focus"),Array.from(t.querySelector("#historyContainer").children).forEach(g=>{g.getAttribute("data-type")===d?(g.classList.remove("fn__none"),g.classList.add("fn__block"),u.classList.add("item--focus"),g.getAttribute("data-init")!=="true"&&(d==="notebook"?ci(g):d==="repo"&&Ke(g,1))):(g.classList.add("fn__none"),g.classList.remove("fn__block"))}),c.stopPropagation(),c.preventDefault();break}else if(u.classList.contains("b3-list-item__action")&&d==="rollback"&&!window.siyuan.config.readonly){confirmDialog("\u26A0\uFE0F "+window.siyuan.languages.rollback,`${window.siyuan.languages.rollbackConfirm.replace("${date}",u.parentElement.textContent.trim())}`,()=>{const g=u.parentElement.getAttribute("data-type");g==="assets"?fetchPost("/api/history/rollbackAssetsHistory",{historyPath:u.parentElement.getAttribute("data-path")}):g==="doc"?fetchPost("/api/history/rollbackDocHistory",{notebook:s.querySelector('.b3-select[data-type="notebookselect"]').value,historyPath:u.parentElement.getAttribute("data-path")}):g==="notebook"?fetchPost("/api/history/rollbackNotebookHistory",{historyPath:u.parentElement.getAttribute("data-path")}):fetchPost("/api/repo/checkoutRepo",{id:u.parentElement.getAttribute("data-id")})}),c.stopPropagation(),c.preventDefault();break}else if(d==="more"){u.parentElement.parentElement.querySelectorAll(".b3-list-item__meta").forEach(g=>{g.classList.toggle("fn__none")}),c.stopPropagation(),c.preventDefault();break}else if(d==="toggle"){const g=u.firstElementChild.firstElementChild;if(g.classList.contains("b3-list-item__arrow--open"))u.nextElementSibling.classList.add("fn__none"),g.classList.remove("b3-list-item__arrow--open");else if(u.nextElementSibling&&u.nextElementSibling.tagName==="UL")u.nextElementSibling.classList.remove("fn__none"),g.classList.add("b3-list-item__arrow--open");else{const p=s.querySelector(".b3-text-field"),b=s.querySelector('.b3-select[data-type="opselect"]'),m=s.querySelector('.b3-select[data-type="typeselect"]'),h=s.querySelector('.b3-select[data-type="notebookselect"]'),y=u.getAttribute("data-created");fetchPost("/api/history/getHistoryItems",{notebook:h.value,query:p.value,op:b.value,type:parseInt(m.value),created:y},k=>{g.classList.add("b3-list-item__arrow--open");let E="";k.data.items.forEach(A=>{E+=`<li title="${escapeAttr(A.title)}" data-created="${y}" data-type="${m.value==="2"?"assets":"doc"}" data-path="${A.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 40px">
    <span class="b3-list-item__text">${escapeHtml(A.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),u.insertAdjacentHTML("afterend",`<ul>${E}</ul>`)})}c.stopPropagation(),c.preventDefault();break}else if(d==="rmtoggle"){u.nextElementSibling.classList.toggle("fn__none"),u.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"),c.stopPropagation(),c.preventDefault();break}else if(u.classList.contains("b3-list-item")&&d==="repoitem"&&["getRepoSnapshots","getRepoTagSnapshots"].includes(r.value)){const g=t.querySelector(".b3-button[data-type='compare']"),p=JSON.parse(g.getAttribute("data-ids")||"[]"),b=u.getAttribute("data-id");if(u.classList.contains("b3-list-item--focus"))u.classList.remove("b3-list-item--focus"),p.forEach((m,h)=>{b===m.id&&p.splice(h,1)});else{for(u.classList.add("b3-list-item--focus");p.length>1;)p[0].id!==b&&((f=u.parentElement.querySelector(`.b3-list-item[data-id="${p.splice(0,1)[0].id}"]`))==null||f.classList.remove("b3-list-item--focus"));p.push({id:b,time:u.querySelector('[data-type="hCreated"]').textContent})}p.length===2?g.removeAttribute("disabled"):g.setAttribute("disabled","disabled"),g.setAttribute("data-ids",JSON.stringify(p)),c.stopPropagation(),c.preventDefault();break}else if(u.classList.contains("b3-list-item")&&(d==="assets"||d==="doc")){const g=u.getAttribute("data-path");d==="assets"?i.innerHTML=renderAssetsPreview(g):d==="doc"&&fetchPost("/api/history/getDocHistoryContent",{historyPath:g,k:s.querySelector(".b3-text-field").value},b=>{b.data.isLargeDoc?(l.value=b.data.content,l.classList.remove("fn__none"),a.classList.add("fn__none")):(l.classList.add("fn__none"),a.classList.remove("fn__none"),it.protyle.options.history.created=u.dataset.created,onGet({data:b,protyle:it.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]}))});let p=hasClosestByClassName(u,"b3-list");p&&(p=p.querySelector(".b3-list-item--focus"),p&&p.classList.remove("b3-list-item--focus")),u.classList.add("b3-list-item--focus"),c.stopPropagation(),c.preventDefault();break}else if(d==="genRepo"){const g=new Dialog({title:window.siyuan.languages.snapshotMemo,content:`<div class="b3-dialog__content">
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.snapshotMemoTip}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});g.element.setAttribute("data-key",Constants.DIALOG_SNAPSHOTMEMO);const p=g.element.querySelector("textarea");p.focus();const b=g.element.querySelectorAll(".b3-button");g.bindInput(p,()=>{b[1].click()}),b[0].addEventListener("click",()=>{g.destroy()}),b[1].addEventListener("click",()=>{fetchPost("/api/repo/createSnapshot",{memo:p.value},()=>{Ke(o,1)}),g.destroy()}),c.stopPropagation(),c.preventDefault();break}else if(d==="removeRepoTagSnapshot"||d==="removeCloudRepoTagSnapshot"){const g=u.parentElement.getAttribute("data-tag");confirmDialog(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <i>${g}</i>?`,()=>{fetchPost("/api/repo/"+d,{tag:g},()=>{Ke(o,1)})}),c.stopPropagation(),c.preventDefault();break}else if(d==="uploadSnapshot"){fetchPost("/api/repo/uploadCloudSnapshot",{tag:u.parentElement.getAttribute("data-tag"),id:u.parentElement.getAttribute("data-id")}),c.stopPropagation(),c.preventDefault();break}else if(d==="downloadSnapshot"){fetchPost("/api/repo/downloadCloudSnapshot",{tag:u.parentElement.getAttribute("data-tag"),id:u.parentElement.getAttribute("data-id")}),c.stopPropagation(),c.preventDefault();break}else if(d==="genTag"){const g=new Dialog({title:window.siyuan.languages.tagSnapshot,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="${dayjs().format("YYYYMMDDHHmmss")}" placeholder="${window.siyuan.languages.tagSnapshotTip}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshot}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshotUpload}</button>
</div>`,width:isMobile()?"92vw":"520px"});g.element.setAttribute("data-key",Constants.DIALOG_SNAPSHOTTAG);const p=g.element.querySelector(".b3-text-field");p.select();const b=g.element.querySelectorAll(".b3-button");b[0].addEventListener("click",()=>{g.destroy()}),b[2].addEventListener("click",()=>{fetchPost("/api/repo/tagSnapshot",{id:u.parentElement.getAttribute("data-id"),name:p.value},()=>{fetchPost("/api/repo/uploadCloudSnapshot",{tag:p.value,id:u.parentElement.getAttribute("data-id")},()=>{Ke(o,1)})}),g.destroy()}),b[1].addEventListener("click",()=>{fetchPost("/api/repo/tagSnapshot",{id:u.parentElement.getAttribute("data-id"),name:p.value},()=>{Ke(o,1)}),g.destroy()}),c.stopPropagation(),c.preventDefault();break}else if((d==="previous"||d==="next")&&u.getAttribute("disabled")!=="disabled"){const g=parseInt(o.getAttribute("data-page"));Ke(o,d==="previous"?g-1:g+1),c.stopPropagation(),c.preventDefault();break}else if((d==="docprevious"||d==="docnext")&&u.getAttribute("disabled")!=="disabled"){const g=parseInt(s.getAttribute("data-page"));bt(s,d==="docprevious"?g-1:g+1),c.stopPropagation(),c.preventDefault();break}else if(d==="rebuildIndex"){fetchPost("/api/history/reindexHistory"),n?n.destroy():(closeModel(),it=void 0),c.stopPropagation(),c.preventDefault();break}else if(d==="compare"&&!u.getAttribute("disabled")){showDiff(e,JSON.parse(u.getAttribute("data-ids")||"[]")),c.stopPropagation(),c.preventDefault();break}u=u.parentElement}})},Dc=e=>{setTitle(window.siyuan.languages.siyuanNote),document.getElementById("toolbarName").classList.add("fn__hidden"),document.getElementById("editor").classList.add("fn__none");const t=document.getElementById("empty");t.classList.remove("fn__none"),t.innerHTML===""&&(t.innerHTML=`<div id="emptySearch" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.search}</span>
</div>
<div id="emptyRecent" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.recentDocs}</span>
</div>
<div id="emptyHistory" class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHistory"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.dataHistory}</span>
</div>
<div id="emptyNewFile" class="b3-list-item${getOpenNotebookCount()>0||!window.siyuan.config.readonly?"":" fn__none"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span>
</div>
<div class="b3-list-item" id="emptyNewNotebook${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFilesRoot"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newNotebook}</span>
</div>
<div class="b3-list-item" id="emptyHelp">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHelp"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.help}</span>
</div>`,t.addEventListener("click",n=>{let s=n.target;for(;s&&!s.isEqualNode(t);){if(s.id==="emptySearch"){popSearch(e),n.stopPropagation(),n.preventDefault();break}else if(s.id==="emptyRecent"){getRecentDocs(e),n.stopPropagation(),n.preventDefault();break}else if(s.id==="emptyHistory"){openHistory(e),n.stopPropagation(),n.preventDefault();break}else if(s.id==="emptyNewFile"){newFile({app:e,useSavePath:!0}),n.stopPropagation(),n.preventDefault();break}else if(s.id==="emptyNewNotebook"){newNotebook(),n.stopPropagation(),n.preventDefault();break}else if(s.id==="emptyHelp"){mountHelp(),n.stopPropagation(),n.preventDefault();break}s=s.parentElement}}))},$c=()=>{const e=document.getElementById("toolbarName");setTitle(e.value),e.classList.remove("fn__hidden"),document.getElementById("editor").classList.remove("fn__none"),document.getElementById("empty").classList.add("fn__none")},Hc=(e,t,n)=>{fetchPost("/api/block/getDocInfo",{id:e},s=>{t.updateTitle(s.data.name),n&&n.title&&n.title.setTitle(s.data.name)})},Nc=(e,t)=>{hideMessage(),window.siyuan.mobile.popEditor&&(t.removeRootIDs.includes(window.siyuan.mobile.popEditor.protyle.block.rootID)?hideElements(["dialog"]):reloadProtyle(window.siyuan.mobile.popEditor.protyle,!1)),window.siyuan.mobile.editor&&(t.removeRootIDs.includes(window.siyuan.mobile.editor.protyle.block.rootID)?setEmpty(e):(reloadProtyle(window.siyuan.mobile.editor.protyle,!1),fetchPost("/api/block/getDocInfo",{id:window.siyuan.mobile.editor.protyle.block.rootID},n=>{fi(n.data.name),document.getElementById("toolbarName").value=n.data.name==="Untitled"?"":n.data.name}))),setNoteBook(()=>{window.siyuan.mobile.files.init(!1)})},Bc=e=>{window.siyuan.config.readonly||(e.plugins.forEach(t=>{t.eventBus.emit("lock-screen")}),fetchPost("/api/system/logoutAuth",{},()=>{redirectToCheckAuth()}))},di=()=>{if(document.querySelector("#errorLog"))return;let e="";Ot()&&(e=`<div class="fn__hr"></div><div class="fn__flex"><div class="fn__flex-1"></div><button class="b3-button">${window.siyuan.languages.retry}</button></div>`);const t=new Na({disableClose:!0,title:`\u{1F494} ${window.siyuan.languages.kernelFault0} <small>v${L.SIYUAN_VERSION}</small>`,width:ue()?"92vw":"520px",content:`<div class="b3-dialog__content">
<div class="ft__breakword">
    <div>${window.siyuan.languages.kernelFault1}</div>
    <div class="fn__hr"></div>
    <div>${window.siyuan.languages.kernelFault2}</div>
    ${e}
</div>
</div>`});t.element.id="errorLog",t.element.setAttribute("data-key",L.DIALOG_KERNELFAULT);const n=t.element.querySelector(".b3-button");n&&n.addEventListener("click",()=>{t.destroy(),window.webkit.messageHandlers.startKernelFast.postMessage("startKernelFast")})},ui=()=>{hideAllElements(["util"]),window.siyuan.mobile.editor&&saveScroll(window.siyuan.mobile.editor.protyle),fetchPost("/api/system/exit",{force:!1},e=>{if(e.code===1){const t=showMessage(e.msg,e.data.closeTimeout,"error"),n=document.querySelector(`#message [data-id="${t}"] button`);n&&n.addEventListener("click",()=>{fetchPost("/api/system/exit",{force:!0},()=>{(isInIOS()||isInAndroid())&&(window.location.href="siyuan://api/system/exit")})})}else e.code===2?(hideMessage(),confirmDialog(window.siyuan.languages.tip,e.msg,()=>{fetchPost("/api/system/exit",{force:!0,execInstallPkg:2},()=>{})},()=>{fetchPost("/api/system/exit",{force:!0,execInstallPkg:1},()=>{})})):(isInIOS()||isInAndroid())&&(window.location.href="siyuan://api/system/exit")})},Pc=()=>{if(document.getElementById("transactionError"))return;const e=new Dialog({disableClose:!0,title:`${window.siyuan.languages.stateExcepted} v${Constants.SIYUAN_VERSION}`,content:`<div class="b3-dialog__content" id="transactionError">${window.siyuan.languages.rebuildIndexTip}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--text">${window.siyuan.languages._kernel[97]}</button>
    <div class="fn__space"></div>
    <button class="b3-button">${window.siyuan.languages.rebuildIndex}</button>
</div>`,width:isMobile()?"92vw":"520px"});e.element.setAttribute("data-key",Constants.DIALOG_STATEEXCEPTED);const t=e.element.querySelectorAll(".b3-button");t[0].addEventListener("click",()=>{ui()}),t[1].addEventListener("click",()=>{fetchPost("/api/filetree/refreshFiletree",{}),e.destroy()})},Rc=e=>{const t=document.querySelector("#status");if(!t)return;if(isMobile()){if(!document.querySelector("#keyboardToolbar").classList.contains("fn__none"))return;t.innerHTML=e.msg,t.classList.remove("status--hide"),t.style.bottom="0";return}const n=t.querySelector(".status__msg");n&&(n.innerHTML=e.msg)},Oc=e=>{let t=document.getElementById("progress");if(t||(document.body.insertAdjacentHTML("beforeend",`<div id="progress" style="z-index: ${++window.siyuan.zIndex}"></div>`),t=document.getElementById("progress")),e.code===2){t.remove();return}e.code===0?t.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div class="b3-dialog__loading">
    <div style="text-align: right">${e.data.current}/${e.data.total}</div>
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="width: ${e.data.current/e.data.total*100}%;transition: var(--b3-transition);background-color: var(--b3-theme-primary);height: 8px;"></div></div>
    <div>${e.msg}</div>
</div>`:e.code===1&&(t.lastElementChild?t.lastElementChild.lastElementChild.innerHTML=e.msg:t.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div class="b3-dialog__loading">
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="background-color: var(--b3-theme-primary);height: 8px;background-image: linear-gradient(-45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent);animation: stripMove 450ms linear infinite;background-size: 50px 50px;"></div></div>
    <div>${e.msg}</div>
</div>`)},qc=e=>{const t=document.querySelector(".status__backgroundtask");t&&(e.length===0?(t.classList.add("fn__none"),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="statusBackgroundTask"&&window.siyuan.menus.menu.remove()):(t.classList.remove("fn__none"),t.setAttribute("data-tasks",JSON.stringify(e)),t.innerHTML=e[0].action+"<div><div></div></div>"))},Fc=()=>{fetchPost("/api/sync/getBootSync",{},e=>{if(e.code===1){const t=new Dialog({width:isMobile()?"92vw":"50vw",title:"\u{1F329}\uFE0F "+window.siyuan.languages.bootSyncFailed,content:`<div class="b3-dialog__content">${e.msg}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.syncNow}</button>
</div>`});t.element.setAttribute("data-key",Constants.DIALOG_BOOTSYNCFAILED);const n=t.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>{n[1].getAttribute("disabled")||(n[1].setAttribute("disabled","disabled"),fetchPost("/api/sync/performBootSync",{},s=>{s.code===0&&t.destroy(),n[1].removeAttribute("disabled")}))})}})},fi=e=>{const t=document.getElementById("drag"),n=getWorkspaceName();if(e===window.siyuan.languages.siyuanNote){const s=`${n} - ${window.siyuan.languages.siyuanNote} v${Constants.SIYUAN_VERSION}`;document.title=s,t&&(t.textContent=s,t.setAttribute("title",s))}else{if(e=e||"Untitled",document.title=`${e} - ${n} - ${window.siyuan.languages.siyuanNote} v${Constants.SIYUAN_VERSION}`,!t)return;t.setAttribute("title",e),t.innerHTML=escapeHtml(e)}},Yc=e=>{const t=document.querySelector("#configBazaarReadme .item__side");if(!t||e.id!==JSON.parse(t.getAttribute("data-obj")).repoURL)return;const n=t.querySelector('[data-type="install"]');n&&(e.percent>=1?(n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.add("fn__none")):(n.classList.add("b3-button--progress"),n.parentElement.nextElementSibling.firstElementChild.classList.add("b3-button--progress"),n.innerHTML=`<span style="width: ${e.percent*100}%"></span>`,n.parentElement.nextElementSibling.firstElementChild.innerHTML=`<span style="width: ${e.percent*100}%"></span>`))},Wc=(e,t)=>{const n=document.querySelector("#menuSyncNow use"),s=document.querySelector("#toolbarSync use");if(!e){!window.siyuan.config.sync.enabled||window.siyuan.config.sync.provider===0&&needSubscribe("")?(n==null||n.setAttribute("xlink:href","#iconCloudOff"),s.setAttribute("xlink:href","#iconCloudOff")):(n==null||n.setAttribute("xlink:href","#iconCloudSucc"),s.setAttribute("xlink:href","#iconCloudSucc"));return}n==null||n.parentElement.classList.remove("fn__rotate"),s.parentElement.classList.remove("fn__rotate"),e.code===0?(n==null||n.parentElement.classList.add("fn__rotate"),s.parentElement.classList.add("fn__rotate"),n==null||n.setAttribute("xlink:href","#iconRefresh"),s.setAttribute("xlink:href","#iconRefresh")):e.code===2?(n==null||n.setAttribute("xlink:href","#iconCloudError"),s.setAttribute("xlink:href","#iconCloudError")):e.code===1&&(n==null||n.setAttribute("xlink:href","#iconCloudSucc"),s.setAttribute("xlink:href","#iconCloudSucc")),t.forEach(a=>{e.code===0?a.eventBus.emit("sync-start",e):e.code===1?a.eventBus.emit("sync-end",e):e.code===2&&a.eventBus.emit("sync-fail",e)})};var gi=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const pa=(e,t,n,s)=>{const a={method:"POST"};t&&(["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph"].includes(e)&&(window.siyuan.reqIds[e]=new Date().getTime(),t.type==="local"&&e==="/api/graph/getLocalGraph"||(t.reqId=window.siyuan.reqIds[e])),e==="/api/transactions"&&(t.reqId=new Date().getTime()),t instanceof FormData?a.body=t:a.body=JSON.stringify(t)),s&&(a.headers=s),fetch(e,a).then(i=>{var l;return i.status===404?{data:null,msg:i.statusText,code:i.status}:((l=i.headers.get("content-type"))==null?void 0:l.indexOf("application/json"))>-1?i.json():i.text()}).then(i=>{if(typeof i=="string"){n&&n(i);return}["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph"].includes(e)&&i.data.reqId&&window.siyuan.reqIds[e]&&window.siyuan.reqIds[e]>i.data.reqId||(typeof i=="object"&&typeof i.msg=="string"&&typeof i.code=="number"?Ha(i)&&n&&n(i):n&&n(i))}).catch(i=>{if(console.warn("fetch post error",i),e==="/api/transactions"&&(i.message==="Failed to fetch"||i.message==="Unexpected end of JSON input")){di();return}})},jc=(e,t)=>gi(void 0,null,function*(){const n={method:"POST"};t&&(n.body=JSON.stringify(t));const a=yield(yield fetch(e,n)).json();return processMessage(a),a}),Uc=(e,t)=>{fetch(e).then(n=>{var s;return((s=n.headers.get("content-type"))==null?void 0:s.indexOf("application/json"))>-1?n.json():n.text()}).then(n=>{t(n)})},Vc=(e,t)=>{const n=[{filter:["\u6A21\u7248","moban","mb","template"],value:Constants.ZWSP,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMarkdown"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.template}</span></div>`},{filter:["\u6302\u4EF6","widget","gj","guajian"],value:Constants.ZWSP+1,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBoth"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.widget}</span></div>`},{filter:["\u8D44\u6E90","assets","zy","ziyuan"],value:Constants.ZWSP+2,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.assets}</span></div>`},{filter:["\u5F15\u7528\u5757","yinyong","yy","block reference"],value:"((",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRef"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.ref}</span><span class="b3-list-item__meta">((</span></div>`},{filter:["\u5D4C\u5165\u5757","qianrukuai","qrk","embed block"],value:"{{",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSQL"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.blockEmbed}</span><span class="b3-list-item__meta">{{</span></div>`},{filter:["ai chat"],value:Constants.ZWSP+5,html:'<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSparkles"></use></svg><span class="b3-list-item__text">AI Chat</span></div>'}];isPaidUser()&&n.push({filter:["\u6570\u636E\u5E93","\u5C5E\u6027\u89C6\u56FE","shujuku","shuxingshitu","sjk","sxst","database","attribute view"],value:'<div data-type="NodeAttributeView" data-av-type="table"></div>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDatabase"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.database}</span></div>`}),[{filter:["\u6587\u6863","\u5B50\u6587\u6863","wendang","wd","ziwendang","zwd","xjwd"],value:Constants.ZWSP+4,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.general.newFile.custom)}</span></div>`},{value:"",html:"separator"},{filter:["yijibiaoti","\u4E00\u7EA7\u6807\u9898","yjbt","h1","heading"],value:"# "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH1"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading1}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.heading.heading1.custom)}</span></div>`},{filter:["erjibiaoti","\u4E8C\u7EA7\u6807\u9898","ejbt","h2","heading"],value:"## "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH2"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading2}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.heading.heading2.custom)}</span></div>`},{filter:["sanjibiaoti","\u4E09\u7EA7\u6807\u9898","sjbt","h3","heading"],value:"### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH3"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading3}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.heading.heading3.custom)}</span></div>`},{filter:["sijibiaoti","\u56DB\u7EA7\u6807\u9898","sjbt","h4","heading"],value:"#### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH4"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading4}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.heading.heading4.custom)}</span></div>`},{filter:["wujibiaoti","\u4E94\u7EA7\u6807\u9898","wjbt","h5","heading"],value:"##### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH5"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading5}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.heading.heading5.custom)}</span></div>`},{filter:["liujibiaoti","\u516D\u7EA7\u6807\u9898","ljbt","h6","heading"],value:"###### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH6"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading6}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.heading.heading6.custom)}</span></div>`},{filter:["\u65E0\u5E8F\u5217\u8868","wuxuliebiao","wxlb","unordered list"],value:"* "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.list}</span><span class="b3-list-item__meta">*&nbsp;</span></div>`},{filter:["\u6709\u5E8F\u5217\u8868","youxuliebiao","yxlb","ordered list"],value:"1. "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconOrderedList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["ordered-list"]}</span><span class="b3-list-item__meta">1.&nbsp;</span></div>`},{filter:["\u4EFB\u52A1\u5217\u8868","renwuliebiao","rwlb","task list","todo list"],value:"* [ ] "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCheck"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.check}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.check.custom)}</span></div>`},{filter:["\u5F15\u8FF0","yinshu","ys","bq","blockquote"],value:"> "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconQuote"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.quote}</span><span class="b3-list-item__meta">&gt;</span></div>`},{filter:["\u4EE3\u7801\u5757","daimakuai","dmk","code block"],value:"```",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.code}</span><span class="b3-list-item__meta">\`\`\`Enter</span></div>`},{filter:["\u8868\u683C","biaoge","bg","table"],value:`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.table}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.table.custom)}</span></div>`},{filter:["\u5206\u5272\u7EBF","\u5206\u9694\u7EBF","fengexian","fgx","divider","thematic","break"],value:"---",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLine"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.line}</span><span class="b3-list-item__meta">---</span></div>`},{filter:["\u6570\u5B66\u516C\u5F0F\u5757","shuxuegongshikuai","sxgsk","math block"],value:"$$",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.math}</span><span class="b3-list-item__meta">$$</span></div>`},{filter:["html"],value:"<div>",html:'<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconHTML5"></use></svg><span class="b3-list-item__text">HTML</span></div>'},{value:"",html:"separator"},{filter:["\u8868\u60C5","biaoqing","bq","emoji"],value:"emoji",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconEmoji"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.emoji}</span><span class="b3-list-item__meta">:</span></div>`},{filter:["\u94FE\u63A5","lianjie","lj","link","a"],value:"a",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLink"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.link}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.link.custom)}</span></div>`},{filter:["\u7C97\u4F53","cuti","ct","bold","strong"],value:"strong",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBold"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.bold}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.bold.custom)}</span></div>`},{filter:["\u659C\u4F53","xieti","xt","italic","em"],value:"em",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconItalic"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.italic}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.italic.custom)}</span></div>`},{filter:["\u4E0B\u5212\u7EBF","xiahuaxian","xhx","underline"],value:"u",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconUnderline"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.underline}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.underline.custom)}</span></div>`},{filter:["\u5220\u9664\u7EBF","shanchuxian","scx","strike"],value:"s",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconStrike"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.strike}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.strike.custom)}</span></div>`},{filter:["\u6807\u8BB0","biaoji","bj","mark"],value:"mark",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMark"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.mark}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.mark.custom)}</span></div>`},{filter:["\u4E0A\u6807","shangbiao","sb","superscript"],value:"sup",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSup"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sup}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.sup.custom)}</span></div>`},{filter:["\u4E0B\u6807","xiaobiao","xb","subscript"],value:"sub",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSub"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sub}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.sub.custom)}</span></div>`},{filter:["\u6807\u7B7E","biaoqian","bq","tag"],value:"tag",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.tag}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.tag.custom)}</span></div>`},{filter:["\u884C\u5185\u4EE3\u7801","hangneidaima","hndm","inline code"],value:"code",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconInlineCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-code"]}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert["inline-code"].custom)}</span></div>`},{filter:["\u884C\u5185\u6570\u5B66\u516C\u5F0F","hangneishuxuegongshi","hnsxgs","inline math"],value:"inline-math",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-math"]}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert["inline-math"].custom)}</span></div>`},{value:"",html:"separator"},{filter:["\u63D2\u5165\u56FE\u7247\u6216\u6587\u4EF6","upload","\u4E0A\u4F20","crtphwj","sc"],value:Constants.ZWSP+3,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDownload"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAsset}</span>
<input class="b3-form__upload" type="file" ${t.options.upload.accept?'multiple="'+t.options.upload.accept+'"':""}></div>`},{filter:["iframe","\u5D4C\u5165\u7F51\u5740","qianruwangzhan","qrwz"],value:'<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLanguage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertIframeURL}</span></div>`},{filter:["\u63D2\u5165\u56FE\u7247\u94FE\u63A5","insert image link","charutupianlianjie","crtptp"],value:"![]()",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertImgURL}</span></div>`},{filter:["\u63D2\u5165\u89C6\u9891\u94FE\u63A5","charushipinlianjie","crsplj","insert video url"],value:'<video controls="controls" src=""></video>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconVideo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertVideoURL}</span></div>`},{filter:["\u63D2\u5165\u97F3\u9891\u94FE\u63A5","charuyinpinlianjie","cryplj","insert audio url"],value:'<audio controls="controls" src=""></audio>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRecord"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAudioURL}</span></div>`},{value:"",html:"separator"},{filter:["\u4E94\u7EBF\u8C31","wuxianpu","wxp","staff"],value:"```abc\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">ABC</span><span class="b3-list-item__meta">${window.siyuan.languages.staff}</span></div>`},{filter:["\u56FE\u8868","tubiao","tb","chart"],value:"```echarts\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Chart</span><span class="b3-list-item__meta">${window.siyuan.languages.chart}</span></div>`},{filter:["\u6D41\u7A0B\u56FE","liuchengtu","lct","flow chart"],value:"```flowchart\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">FlowChart</span><span class="b3-list-item__meta">Flow Chart</span></div>'},{filter:["\u72B6\u6001\u56FE","zhuangtaitu","ztt","graph viz"],value:"```graphviz\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Graphviz</span><span class="b3-list-item__meta">Graph</span></div>'},{filter:["\u6D41\u7A0B\u56FE","\u65F6\u5E8F\u56FE","\u7518\u7279\u56FE","liuchengtu","shixutu","gantetu","lct","sxt","gtt","mermaid"],value:"```mermaid\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Mermaid</span><span class="b3-list-item__meta">Mermaid</span></div>'},{filter:["\u8111\u56FE","naotu","nt","mind map"],value:"```mindmap\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Mind map</span><span class="b3-list-item__meta">${window.siyuan.languages.mindmap}</span></div>`},{filter:["\u7EDF\u4E00\u5EFA\u6A21\u8BED\u8A00","tongyijianmoyuyan","tyjmyy","plant uml"],value:"```plantuml\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">PlantUML</span><span class="b3-list-item__meta">UML</span></div>'},{value:"",html:"separator"},{filter:["\u4FE1\u606F\u6837\u5F0F","xinxiyangshi","xxys","info style"],value:`style${Constants.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.infoStyle}</span></div>`},{filter:["\u6210\u529F\u6837\u5F0F","chenggongyangshi","cgys","success style"],value:`style${Constants.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.successStyle}</span></div>`},{filter:["\u8B66\u544A\u6837\u5F0F","jinggaoyangshi","jgys","warning style"],value:`style${Constants.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.warningStyle}</span></div>`},{filter:["\u9519\u8BEF\u6837\u5F0F","cuowuyangshi","cwys","error style"],value:`style${Constants.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.errorStyle}</span></div>`},{filter:["\u79FB\u9664\u6837\u5F0F","yichuyangshi","ycys","remove style"],value:`style${Constants.ZWSP}`,html:`<div class="b3-list-item__first"><div class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.clearFontStyle}</span></div>`}].forEach(a=>{n.push(a)}),n.push({value:"",html:"separator"});let s=!1;return t.app.plugins.forEach(a=>{a.protyleSlash.forEach(i=>{n.push({filter:i.filter,value:`plugin${Constants.ZWSP}${a.name}${Constants.ZWSP}${i.id}`,html:i.html}),s=!0})}),s||n.pop(),e===""?n:n.filter(a=>a.filter?!!a.filter.find(l=>{if(l.indexOf(e.toLowerCase())>-1)return!0}):!1)},Gc=(e,t)=>(t.hint.genLoading(t),fetchPost("/api/search/searchTag",{k:e},n=>{const s=[];let a=!1;n.data.tags.forEach(i=>{const l=i.replace(/<mark>/g,"").replace(/<\/mark>/g,"");s.push({value:`#${l}#`,html:i}),l===n.data.k&&(a=!0)}),n.data.k&&!a&&(s.splice(0,0,{value:`#${n.data.k}#`,html:`${window.siyuan.languages.new} <mark>${escapeHtml(n.data.k)}</mark>`}),s.length>1&&(s[1].focus=!0)),t.hint.genHTML(s,t,!0,"hint")}),[]),ma=e=>{let t;e.type==="NodeDocument"&&e.ial.icon?(t=unicode2Emoji(e.ial.icon,"b3-list-item__graphic popover__block",!0),t=t.replace('popover__block"',`popover__block" data-id="${e.id}"`)):t=`<svg class="b3-list-item__graphic popover__block" data-id="${e.id}"><use xlink:href="#${getIconByType(e.type)}"></use></svg>`;let n="";return e.name&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg><span>${e.name}</span></span><span class="fn__space"></span>`),e.alias&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg><span>${e.alias}</span></span><span class="fn__space"></span>`),e.memo&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg><span>${e.memo}</span></span>`),n&&(n=`<div class="fn__flex b3-list-item__meta b3-list-item__showall">${n}</div>`),`${n}<div class="b3-list-item__first">
    ${t}
    <span class="b3-list-item__text">${e.content}</span>
</div>
<div class="b3-list-item__meta b3-list-item__showall">${e.hPath}</div>`},zc=(e,t,n)=>{const s=hasClosestBlock(getEditorRange(t.wysiwyg.element).startContainer);return t.hint.genLoading(t),fetchPost("/api/search/searchRefBlock",{k:e,id:s?s.getAttribute("data-node-id"):t.block.parentID,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),rootID:t.block.rootID,isSquareBrackets:["[[","\u3010\u3010"].includes(t.hint.splitChar)},a=>{const i=[];if(a.data.newDoc){const l=Lute.UnEscapeHTMLStr(replaceFileName(a.data.k));i.push({value:`((newFile "${l}"${Constants.ZWSP}'${l}${Lute.Caret}'))`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${a.data.k}</mark></span></div>`})}a.data.blocks.forEach(l=>{let o=`<span data-type="block-ref" data-id="${l.id}" data-subtype="d">${l.name||l.refText}</span>`;n==="search"&&(o=`<span data-type="block-ref" data-id="${l.id}" data-subtype="s">${e}${Constants.ZWSP}${l.name||l.refText}</span>`),i.push({value:o,html:ma(l)})}),n==="search"&&(t.hint.splitChar="((",t.hint.lastIndex=-1),i.length===0?i.push({value:"",html:window.siyuan.languages.emptyContent}):a.data.newDoc&&i.length>1&&(i[1].focus=!0),t.hint.genHTML(i,t,!0,n)}),[]},Kc=(e,t)=>{if(e.endsWith("}}")||e.endsWith("\u300D\u300D"))return[];t.hint.genLoading(t);const n=hasClosestBlock(getEditorRange(t.wysiwyg.element).startContainer);return fetchPost("/api/search/searchRefBlock",{k:e,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),id:n?n.getAttribute("data-node-id"):t.block.parentID,rootID:t.block.rootID},s=>{const a=[];s.data.blocks.forEach(i=>{a.push({value:`{{select * from blocks where id='${i.id}'}}`,html:ma(i)})}),a.length===0&&a.push({value:"",html:window.siyuan.languages.emptyContent}),t.hint.genHTML(a,t,!0,"hint")}),[]},Zc=(e,t,n)=>{fetchPost("/api/template/render",{id:t.block.parentID,path:e},s=>{focusByRange(t.toolbar.range);const a=getContenteditableElement(n);a&&a.textContent.trim()===""?insertHTML(s.data.content,t,!0):insertHTML(s.data.content,t),t.wysiwyg.element.querySelectorAll('[status="temp"]').forEach(i=>{i.remove()}),blockRender(t,t.wysiwyg.element),processRender(t.wysiwyg.element),highlightRender(t.wysiwyg.element),avRender(t.wysiwyg.element,t),hideElements(["util"],t)})},Xc=(e,t)=>{focusByRange(t.toolbar.range),insertHTML(t.lute.SpinBlockDOM(`<iframe src="/widgets/${e}" data-subtype="widget" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>`),t,!0),hideElements(["util"],t)},Qc=(e,t)=>{focusByRange(t.toolbar.range);const n=pathPosix().extname(e).toLowerCase(),s=e.startsWith("assets/")?getAssetName(e):e;insertHTML(genAssetHTML(n,e,s,e.startsWith("assets/")?s+n:e),t),hideElements(["util"],t)},Jc=(e,t,n)=>{if(e==="/")return;const s=getDisplayName(e,!0,!0);if(n.block.rootID===s)return;const a=[];let i;const l=t[0].parentElement;let o;if(t.forEach((r,c)=>{c===t.length-1&&r.parentElement&&(i=getTopAloneElement(r),o=i.nextElementSibling||i.previousElementSibling,i.isSameNode(r)&&(i=void 0)),a.push({action:"append",id:r.getAttribute("data-node-id"),parentID:s}),r.remove()}),i)a.push({action:"delete",id:i.getAttribute("data-node-id")}),i.remove();else if(l.classList.contains("list")&&l.getAttribute("data-subtype")==="o"&&l.childElementCount>1)updateListOrder(l,1),Array.from(l.children).forEach(r=>{r.classList.contains("protyle-attr")||a.push({action:"update",id:r.getAttribute("data-node-id"),data:r.outerHTML})});else if(n.block.showAll&&l.classList.contains("protyle-wysiwyg")&&l.childElementCount===0)setTimeout(()=>{zoomOut({protyle:n,id:n.block.parent2ID,focusId:n.block.parent2ID})},Constants.TIMEOUT_INPUT*2+100);else if(l.classList.contains("protyle-wysiwyg")&&l.innerHTML===""&&!hasClosestByClassName(l,"block__edit",!0)&&n.block.id===n.block.rootID){const r=Lute.NewNodeID(),c=genEmptyElement(!1,!1,r);a.splice(0,0,{action:"insert",id:r,data:c.outerHTML,parentID:n.block.parentID}),l.innerHTML=c.outerHTML,focusBlock(c)}else o&&focusBlock(o);transaction(n,a)},Ee=(e,t,n)=>{t&&(setLastNodeRange(getContenteditableElement(n[n.length-1]),e.toolbar.range),e.toolbar.range.collapse(!0),insertHTML(t,e,!0,!0),blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element))},ed=(e,t)=>{const n=[];e.forEach(a=>{n.push(a.getAttribute("data-node-id"))});const s=[{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiCustomAction,click(){const a=new Dialog({title:window.siyuan.languages.aiCustomAction,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.use}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.save}</button>
</div>`,width:isMobile()?"92vw":"520px"});a.element.setAttribute("data-key",Constants.DIALOG_AICUSTOMACTION);const i=a.element.querySelector("input"),l=a.element.querySelector("textarea"),o=a.element.querySelectorAll(".b3-button");a.bindInput(l,()=>{o[1].click()}),o[0].addEventListener("click",()=>{a.destroy()}),o[1].addEventListener("click",()=>{if(!l.value){showMessage(window.siyuan.languages._kernel[142]);return}fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:l.value},r=>{a.destroy(),Ee(t,r.data,e)})}),o[2].addEventListener("click",()=>{if(!i.value&&!l.value){showMessage(window.siyuan.languages._kernel[142]);return}window.siyuan.storage[Constants.LOCAL_AI].push({name:i.value,memo:l.value}),setStorageVal(Constants.LOCAL_AI,window.siyuan.storage[Constants.LOCAL_AI]),a.destroy()}),i.focus()}}];window.siyuan.storage[Constants.LOCAL_AI].length>0&&s.push({type:"separator"}),window.siyuan.storage[Constants.LOCAL_AI].forEach(a=>{s.push({iconHTML:Constants.ZWSP,action:"iconEdit",label:`<div aria-label="${escapeAriaLabel(a.memo)}" class="ariaLabel">${escapeHtml(a.name)}</div>`,bind:i=>{i.addEventListener("click",l=>{if(hasClosestByClassName(l.target,"b3-menu__action")){const o=new Dialog({title:window.siyuan.languages.update,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--error">${window.siyuan.languages.delete}</button>
</div>`,width:isMobile()?"92vw":"520px"});o.element.setAttribute("data-key",Constants.DIALOG_AIUPDATECUSTOMACTION);const r=o.element.querySelector("input");r.value=a.name;const c=o.element.querySelector("textarea"),f=o.element.querySelectorAll(".b3-button");o.bindInput(c,()=>{f[1].click()}),c.value=a.memo,f[0].addEventListener("click",()=>{o.destroy()}),f[1].addEventListener("click",()=>{window.siyuan.storage[Constants.LOCAL_AI].find(u=>{if(a.name===u.name&&a.memo===u.memo)return a.name=r.value,a.memo=c.value,setStorageVal(Constants.LOCAL_AI,window.siyuan.storage[Constants.LOCAL_AI]),!0}),o.destroy()}),f[2].addEventListener("click",()=>{window.siyuan.storage[Constants.LOCAL_AI].find((u,d)=>{if(a.name===u.name&&a.memo===u.memo)return window.siyuan.storage[Constants.LOCAL_AI].splice(d,1),setStorageVal(Constants.LOCAL_AI,window.siyuan.storage[Constants.LOCAL_AI]),!0}),o.destroy()}),r.focus()}else fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:a.memo},o=>{Ee(t,o.data,e)});window.siyuan.menus.menu.remove(),l.preventDefault(),l.stopPropagation()})}})}),window.siyuan.menus.menu.append(new MenuItem({icon:"iconSparkles",label:window.siyuan.languages.ai,type:"submenu",submenu:[{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiContinueWrite,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:"Continue writing"},a=>{Ee(t,a.data,e)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiTranslate,type:"submenu",submenu:[{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiTranslate_zh_Hans,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [zh-Hans]"},a=>{Ee(t,a.data,e)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiTranslate_zh_Hant,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [zh-Hant]"},a=>{Ee(t,a.data,e)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiTranslate_ja_JP,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [ja-JP]"},a=>{Ee(t,a.data,e)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiTranslate_ko_KR,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [ko-KR]"},a=>{Ee(t,a.data,e)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiTranslate_en_US,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [en-US]"},a=>{Ee(t,a.data,e)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiTranslate_es_ES,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [es-ES]"},a=>{Ee(t,a.data,e)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiTranslate_fr_FR,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [fr-FR]"},a=>{Ee(t,a.data,e)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiTranslate_de_DE,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [de-DE]"},a=>{Ee(t,a.data,e)})}}]},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiExtractSummary,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:window.siyuan.languages.aiExtractSummary},a=>{Ee(t,a.data,e)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiBrainStorm,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:window.siyuan.languages.aiBrainStorm},a=>{Ee(t,a.data,e)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiFixGrammarSpell,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:window.siyuan.languages.aiFixGrammarSpell},a=>{Ee(t,a.data,e)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.custom,type:"submenu",submenu:s}]}).element)},td=(e,t)=>{const n=new Dialog({title:"AI Chat",content:`<div class="b3-dialog__content"><textarea class="b3-text-field fn__block"></textarea></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),s=n.element.querySelector("textarea"),a=n.element.querySelectorAll(".b3-button");n.bindInput(s,()=>{a[1].click()}),s.focus(),a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{fetchPost("/api/ai/chatGPT",{msg:s.value},i=>{n.destroy();let l="";i.data&&i.data!==""&&(l=`

`+i.data),fillContent(e,`${s.value}${l}`,[t])})})};class nd{constructor(t){this.enableSlash=!0,this.enableEmoji=!0,this.enableExtend=!1,this.splitChar="",this.lastIndex=-1,this.element=document.createElement("div"),this.element.setAttribute("data-close","false"),this.element.setAttribute("style",`width:${Math.max(t.element.clientWidth/2,320)}px;`),this.element.className="protyle-hint b3-list b3-list--background fn__none",this.element.addEventListener("click",n=>{var s;const a=n.target;if(a.tagName==="INPUT"){n.stopPropagation();return}const i=hasClosestByMatchTag(a,"BUTTON");if(i&&!i.classList.contains("emojis__item")&&!i.classList.contains("emojis__type")){this.fill(decodeURIComponent(i.getAttribute("data-value")),t,!1,this.source==="search"?isNotCtrl(n):isOnlyMeta(n)),n.preventDefault(),n.stopPropagation();return}const l=this.element.querySelector(".emojis__panel"),o=hasClosestByClassName(a,"emojis__type");if(o){const c=l.querySelector(`[data-type="${o.getAttribute("data-type")}"]`);if(c){const f=c.nextElementSibling.getAttribute("data-index");if(f){let u="";window.siyuan.emojis[parseInt(f)].items.forEach(d=>{u+=`<button data-unicode="${d.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?d.description_zh_cn:d.description}">
${unicode2Emoji(d.unicode)}</button>`}),c.nextElementSibling.innerHTML=u,c.nextElementSibling.removeAttribute("data-index")}l.scrollTo({top:c.offsetTop})}return}const r=hasClosestByClassName(a,"emojis__item");if(r){const c=r.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const f=getSelection().getRangeAt(0);f.endContainer.nodeType!==3?(s=f.endContainer.childNodes[f.endOffset-1])==null||s.remove():f.endContainer.textContent===":"&&(f.endContainer.textContent=""),addEmoji(c);let u;c.indexOf(".")>-1?u=`:${c.split(".")[0]}: `:u=unicode2Emoji(c)+" ",insertHTML(t.lute.SpinBlockDOM(u),t,!1,!0),this.element.classList.add("fn__none")}else this.fill(c,t)}})}render(t){if(!window.getSelection().focusNode){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(!this.enableExtend){clearTimeout(this.timeId);return}if(t.toolbar.range=getSelection().getRangeAt(0),t.toolbar.range.startContainer.nodeType===3&&t.toolbar.range.startContainer.textContent===""){const i=hasPreviousSibling(t.toolbar.range.startContainer);if(i&&i.nodeType===3){if(i.wholeText!==i.textContent){let l=i.previousSibling;for(;l&&l.nodeType===3;)if(l.textContent==="")l=l.previousSibling,l.nextSibling.remove();else{i.textContent=l.textContent+i.textContent,l.remove();break}}t.toolbar.range.setStart(i,i.textContent.length),t.toolbar.range.collapse(!0)}}const n=getSelectionOffset(t.toolbar.range.startContainer,t.wysiwyg.element).start,s=t.toolbar.range.startContainer.textContent.substring(0,n)||"",a=this.getKey(s,t.options.hint.extend);if(typeof a=="undefined"||hasClosestByAttribute(t.toolbar.range.startContainer,"data-type","code")||hasClosestByAttribute(t.toolbar.range.startContainer,"data-type","NodeCodeBlock")){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(this.splitChar==="#"){const i=hasClosestBlock(t.toolbar.range.startContainer);if(i&&i.getAttribute("data-type")==="NodeHeading"){const l=getSelectionOffset(t.toolbar.range.startContainer,i).start;if(i.textContent.startsWith("#".repeat(l))){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}}}if(this.splitChar===":"){clearTimeout(this.timeId),a?this.genEmojiHTML(t,a):this.element.classList.add("fn__none");return}if(this.splitChar==="/"||this.splitChar==="\u3001"){clearTimeout(this.timeId),this.enableSlash&&!isMobile()&&this.genHTML(hintSlash(a,t),t,!1,"hint");return}t.options.hint.extend.forEach(i=>{i.key===this.splitChar&&(clearTimeout(this.timeId),this.timeId=window.setTimeout(()=>{this.genHTML(i.hint(a,t,"hint"),t,!1,"hint")},t.options.hint.delay))})}genLoading(t){if(this.element.classList.contains("fn__none")){this.element.innerHTML='<div class="fn__loading" style="height: 128px;position: initial"><img width="64px" src="/stage/loading-pure.svg"></div>',this.element.classList.remove("fn__none");const n=getSelectionPosition(t.wysiwyg.element);setPosition(this.element,n.left,n.top+26,30)}else this.element.insertAdjacentHTML("beforeend",'<div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div>')}bindUploadEvent(t,n){const s=n.querySelector('input[type="file"]');s&&s.addEventListener("change",a=>{if(a.target.files.length===0)return;const i=getEditorRange(t.wysiwyg.element);this.lastIndex>-1&&i.setStart(i.startContainer,this.lastIndex),i.deleteContents(),uploadFiles(t,a.target.files,a.target),hideElements(["hint","toolbar"],t)})}getHTMLByData(t){let n='<div style="flex: 1;overflow:auto;">';return this.source!=="hint"&&(n='<input style="margin:0 8px 4px 8px" class="b3-text-field"><div style="flex: 1;overflow:auto;">'),t.forEach((s,a)=>{let i="";(a===1&&t[a].focus||a===0&&(t.length===1||!t[1].focus))&&(i=" b3-list-item--focus"),s.html==="separator"?n+='<div class="b3-menu__separator"></div>':n+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${i}" data-value="${encodeURIComponent(s.value)}">${s.html}</button>`}),`${n}</div>`}genHTML(t,n,s=!1,a){var i;if(this.source=a,t.length===0){(!this.element.querySelector(".fn__loading")||s)&&this.element.classList.add("fn__none");return}if(this.element.innerHTML=this.getHTMLByData(t),this.element.classList.remove("fn__none"),t[0].filter?this.element.classList.add("hint--menu"):this.element.classList.remove("hint--menu"),this.element.style.width=Math.max(n.element.clientWidth/2,320)+"px",this.source==="av"){const l=hasClosestByClassName(n.toolbar.range.startContainer,"av__cell");if(l){const o=l.getBoundingClientRect();setPosition(this.element,o.left,o.bottom,o.height)}}else{const l=getSelectionPosition(n.wysiwyg.element);setPosition(this.element,l.left,l.top+26,30)}if(this.element.scrollTop=0,this.bindUploadEvent(n,this.element),this.source!=="hint"){const l=this.element.querySelector("input.b3-text-field"),o=((i=this.element.querySelector("mark"))==null?void 0:i.textContent)||"";l.value=o,l.select(),l.addEventListener("keydown",c=>{c.key!=="Meta"&&c.key!=="Control"&&c.stopPropagation(),!c.isComposing&&(upDownHint(this.element.lastElementChild,c),c.key==="Enter"?(this.fill(decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value")),n,!1,isNotCtrl(c)),c.preventDefault()):c.key==="Escape"&&(this.element.classList.add("fn__none"),focusByRange(n.toolbar.range)))});const r=n.toolbar.range?hasClosestBlock(n.toolbar.range.startContainer):!1;l.addEventListener("input",c=>{c.isComposing||(c.stopPropagation(),this.genSearchHTML(n,l,r,o))}),l.addEventListener("compositionend",c=>{c.stopPropagation(),this.genSearchHTML(n,l,r,o)})}}genSearchHTML(t,n,s,a){this.element.lastElementChild.innerHTML='<div class="ft__center"><img style="height:32px;width:32px;" src="/stage/loading-pure.svg"></div>',fetchPost("/api/search/searchRefBlock",{k:n.value,id:s?s.getAttribute("data-node-id"):t.block.parentID,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),rootID:t.block.rootID},i=>{let l="";if(i.data.newDoc){const o=`((newFile "${a}"${Constants.ZWSP}'${i.data.k}${Lute.Caret}'))`;l+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${i.data.blocks.length===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(o)}"><div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${i.data.k}</mark></span></div></button>`}i.data.blocks.forEach((o,r)=>{const c=`<span data-type="block-ref" data-id="${o.id}" data-subtype="s">${a}</span>`;l+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${r===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(c)}">
${genHintItemHTML(o)}
</button>`}),l===""&&(l=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two" data-value="">${window.siyuan.languages.emptyContent}</button>`),this.element.lastElementChild.innerHTML=l,setPosition(this.element,parseInt(this.element.style.left),parseInt(this.element.style.right))})}genEmojiHTML(t,n=""){if(n&&!this.enableEmoji)return;const s=this.element.querySelector(".emojis__panel");s?(s.innerHTML=filterEmoji(n,256),n?s.nextElementSibling.classList.add("fn__none"):s.nextElementSibling.classList.remove("fn__none"),lazyLoadEmojiImg(s)):(this.element.innerHTML=`<div style="padding: 0;${n?"":"height:402px"}" class="emojis">
<div class="emojis__panel">${filterEmoji(n,256)}</div>
<div class="fn__flex${n?" fn__none":""}">
    <button data-type="0" class="emojis__type ariaLabel" aria-label="${window.siyuan.languages.recentEmoji}">${unicode2Emoji("2b50")}</button>
    <button data-type="1" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[0][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${unicode2Emoji("1f527")}</button>
    <button data-type="2" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[1][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${unicode2Emoji("1f60d")}</button>
    <button data-type="3" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[2][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${unicode2Emoji("1f433")}</button>
    <button data-type="4" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[3][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${unicode2Emoji("1f96a")}</button>
    <button data-type="5" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[4][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${unicode2Emoji("1f3a8")}</button>
    <button data-type="6" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[5][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${unicode2Emoji("1f3dd-fe0f")}</button>
    <button data-type="7" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[6][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${unicode2Emoji("1f52e")}</button>
    <button data-type="8" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[7][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${unicode2Emoji("267e-fe0f")}</button>
    <button data-type="9" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[8][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${unicode2Emoji("1f6a9")}</button>
</div>
</div>`,lazyLoadEmoji(this.element),lazyLoadEmojiImg(this.element));const a=this.element.querySelector(".emojis__item");if(a){a.classList.add("emojis__item--current"),this.element.classList.remove("fn__none"),this.element.style.width=Math.max(t.element.clientWidth/2,320)+"px";const i=getSelectionPosition(t.wysiwyg.element);setPosition(this.element,i.left,i.top+26,30),this.element.querySelector(".emojis__panel").scrollTop=0}else this.element.classList.add("fn__none")}fill(t,n,s=!0,a=!1){var i;hideElements(["hint","toolbar"],n),s&&this.source!=="av"&&(n.toolbar.range=getEditorRange(n.wysiwyg.element));const l=n.toolbar.range;let o=hasClosestBlock(n.toolbar.range.startContainer);if(!o)return;if(this.source==="av"){let u=hasClosestByClassName(n.toolbar.range.startContainer,"av__cell");if(u||(u=o.querySelector(".av__cell--select")),!u)return;const d=hasClosestByClassName(u,"av__row");if(!d)return;const g=u.dataset.blockId,p=o.getAttribute("data-av-id");let b=document.createElement("div");if(b.innerHTML=t.replace(/<mark>/g,"").replace(/<\/mark>/g,""),b=b.firstElementChild,t.startsWith("((newFile ")&&t.endsWith(`${Lute.Caret}'))`)){const m=t.substring(11,t.length-4).split(`"${Constants.ZWSP}'`),h=m.length===1?m[0]:m[1],y=Lute.NewNodeID();d.dataset.id=y,getSavePath(n.path,n.notebookId,k=>{fetchPost("/api/filetree/createDocWithMd",{notebook:n.notebookId,path:pathPosix().join(k,h),parentID:n.block.rootID,markdown:"",id:y},()=>{transaction(n,[{action:"replaceAttrViewBlock",avID:p,previousID:g,nextID:y,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:p,previousID:y,nextID:g,isDetached:!0}])})})}else{const m=b.getAttribute("data-id");d.dataset.id=m,transaction(n,[{action:"replaceAttrViewBlock",avID:p,previousID:g,nextID:m,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:p,previousID:m,nextID:g,isDetached:!0}])}return}this.enableExtend=!1;let r="";o&&(r=o.getAttribute("data-node-id"));const c=o.outerHTML,f=Constants.BLOCK_HINT_CLOSE_KEYS[this.splitChar];if(Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&f&&l.startContainer.nodeType===3&&l.startContainer.wholeText.indexOf(f)>-1&&l.startContainer.wholeText.indexOf(this.splitChar)>-1){let u=0,d=l.startContainer;for(;d&&u<2;){const g=d.textContent.indexOf(f),p=d.textContent.indexOf(this.splitChar);if(g>-1&&(g<p||p<0)){u=2,l.setEnd(d,g+2);break}const b=d.textContent.indexOf(f.substr(1));if(b>-1&&(u+=1),u===2){l.setEnd(d,b+1);break}d=d.nextSibling}}if(this.lastIndex>-1&&(l.setStart(l.startContainer,this.lastIndex),isIPhone()&&focusByRange(l)),Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&t.startsWith("((newFile ")&&t.endsWith(`${Lute.Caret}'))`)){const u=t.substring(11,t.length-4).split(`"${Constants.ZWSP}'`),d=u.length===1?u[0]:u[1];getSavePath(n.path,n.notebookId,g=>{fetchPost("/api/filetree/createDocWithMd",{notebook:n.notebookId,path:pathPosix().join(g,d),parentID:n.block.rootID,markdown:""},p=>{n.toolbar.range=l,n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${p.data}${Constants.ZWSP}${a?"s":"d"}${Constants.ZWSP}${(a?u[0]:d).substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen)}`})})});return}if(Constants.BLOCK_HINT_KEYS.includes(this.splitChar)){if(t===""){const d=getContenteditableElement(o);d.textContent===""&&(d.innerHTML="<wbr>",focusByWbr(d,l));return}let u=document.createElement("div");if(u.innerHTML=t.replace(/<mark>/g,"").replace(/<\/mark>/g,""),u=u.firstElementChild,a){const d=l.toString().replace(this.splitChar,"");d&&(u.setAttribute("data-subtype","s"),u.innerText=d)}else{u.setAttribute("data-subtype","d");const d=u.innerText.split(Constants.ZWSP);d.length===2&&(u.innerText=d[1])}n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${u.getAttribute("data-id")}${Constants.ZWSP}${u.getAttribute("data-subtype")}${Constants.ZWSP}${u.textContent}`});return}else if(this.splitChar===":"){addEmoji(t);let u;t.indexOf(".")>-1?u=`:${t.split(".")[0]}: `:u=unicode2Emoji(t)+" ",insertHTML(n.lute.SpinBlockDOM(u),n)}else if(["\u300C\u300C","\u300C\u300E","\u300E\u300C","\u300E\u300E","{{"].includes(this.splitChar)||this.splitChar==="#"||this.splitChar===":"){if(t===""){const u=getContenteditableElement(o);u.textContent===""&&(u.innerHTML="<wbr>",focusByWbr(u,l));return}insertHTML(n.lute.SpinBlockDOM(t),n,!1,isMobile()),blockRender(n,n.wysiwyg.element);return}else if(this.splitChar==="/"||this.splitChar==="\u3001")if(this.enableExtend=!0,t==="(("||t==="{{"){t==="(("?hintRef("",n,"hint"):hintEmbed("",n),this.splitChar=t,this.lastIndex=0,l.deleteContents();const u=document.createTextNode(t);l.insertNode(u),l.setEnd(u,t.length),l.collapse(!1);return}else if(t===Constants.ZWSP){l.deleteContents(),this.fixImageCursor(l),n.toolbar.showTpl(n,o,l),updateTransaction(n,r,o.outerHTML,c);return}else if(t===Constants.ZWSP+1){l.deleteContents(),this.fixImageCursor(l),n.toolbar.showWidget(n,o,l),updateTransaction(n,r,o.outerHTML,c);return}else if(t===Constants.ZWSP+2){l.deleteContents(),this.fixImageCursor(l),n.toolbar.range=l;const u=getSelectionPosition(o,l);assetMenu(n,{x:u.left,y:u.top+26,w:0,h:26}),updateTransaction(n,r,o.outerHTML,c);return}else if(t===Constants.ZWSP+3){l.deleteContents();return}else if(t===Constants.ZWSP+4){const u=Lute.NewNodeID();fetchPost("/api/filetree/createDoc",{notebook:n.notebookId,path:pathPosix().join(getDisplayName(n.path,!1,!0),u+".sy"),title:"Untitled",md:""},()=>{insertHTML(`<span data-type="block-ref" data-id="${u}" data-subtype="d">Untitled</span>`,n),openMobileFileById(n.app,u,[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT])});return}else if(t===Constants.ZWSP+5){l.deleteContents(),AIChat(n,o);return}else if(Constants.INLINE_TYPE.includes(t)){if(l.deleteContents(),focusByRange(l),["a","block-ref","inline-math","inline-memo","text"].includes(t)){n.toolbar.element.querySelector(`[data-type="${t}"]`).dispatchEvent(new CustomEvent("click"));return}n.toolbar.setInlineMark(n,t,"range");return}else if(t==="emoji"){l.deleteContents(),l.insertNode(document.createTextNode(":")),l.collapse(!1),this.genEmojiHTML(n);return}else if(t.indexOf("style")>-1){l.deleteContents(),this.fixImageCursor(l),o.setAttribute("style",t.split(Constants.ZWSP)[1]||""),updateTransaction(n,r,o.outerHTML,c);return}else if(t.startsWith("plugin")){n.app.plugins.find(u=>{const d=t.split(Constants.ZWSP);if(d[1]===u.name)return u.protyleSlash.find(g=>{if(g.id===d[2])return g.callback(n.getInstance()),!0}),!0});return}else{l.deleteContents(),t!=="![]()"&&this.fixImageCursor(l);let u=t;t==="```"&&(u=t+window.siyuan.storage[Constants.LOCAL_CODELANG]+Lute.Caret+"\n```");const d=getContenteditableElement(o);if(t==="![]()"){let g="";l.insertNode(document.createElement("wbr")),l.insertNode(document.createTextNode(t)),g=n.lute.SpinBlockDOM(o.outerHTML),o.outerHTML=g,o=n.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),focusByWbr(o,l),updateTransaction(n,r,o.outerHTML,c);let p=l.startContainer.childNodes[l.startOffset-1]||l.startContainer;p&&p.nodeType!==3&&p.classList.contains("img")||(((i=p.previousSibling)==null?void 0:i.nodeType)!==3&&p.previousSibling.classList.contains("img")?p=p.previousSibling:Array.from(o.querySelectorAll(".img")).find(m=>{if(m.querySelector("img").getAttribute("data-src")==="")return p=m,!0}));const b=p.getBoundingClientRect();imgMenu(n,l,p,{clientX:b.left,clientY:b.top});return}else if(d.textContent===""&&o.getAttribute("data-type")==="NodeParagraph"){let g="";t==="<div>"?g=`<div data-node-id="${r}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${genIconHTML()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${Constants.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`:(d.textContent=u,g=n.lute.SpinBlockDOM(o.outerHTML)),o.outerHTML=g,o=n.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),o.getAttribute("data-type")==="NodeTable"&&(o.querySelectorAll("colgroup col").forEach(p=>{p.style.minWidth="60px"}),g=o.outerHTML),updateTransaction(n,r,g,c)}else{let g=n.lute.SpinBlockDOM(u);t==="<div>"&&(g=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${genIconHTML()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${Constants.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`),o.insertAdjacentHTML("afterend",g);const p=o.outerHTML,b=g.substr(g.indexOf('data-node-id="')+14,22);o=n.wysiwyg.element.querySelector(`[data-node-id="${b}"]`),o.getAttribute("data-type")==="NodeTable"&&o.querySelectorAll("colgroup col").forEach(m=>{m.style.minWidth="60px"}),transaction(n,[{data:p,id:r,action:"update"},{data:o.outerHTML,id:b,previousID:r,action:"insert"}],[{id:b,action:"delete"},{data:c,id:r,action:"update"}])}if(t==="<div>"||t==="$$"||t.indexOf("```")>-1&&t.length>3)n.toolbar.showRender(n,o),processRender(o);else if(t.startsWith("```"))highlightRender(o);else if(t.startsWith("<iframe")||t.startsWith("<video")||t.startsWith("<audio")){n.gutter.renderMenu(n,o);const g=o.getBoundingClientRect();window.siyuan.menus.menu.popup({x:g.left,y:g.top,isLeft:!0});const p=window.siyuan.menus.menu.element.querySelector('[data-id="assetSubMenu"]');p.classList.add("b3-menu__item--show"),window.siyuan.menus.menu.showSubMenu(p.querySelector(".b3-menu__submenu")),window.siyuan.menus.menu.element.querySelector("textarea").focus()}else t==="---"?focusBlock(o):o.classList.contains("av")?avRender(o,n):focusByWbr(o,l)}}select(t,n){var s,a,i;const l=this.element.firstElementChild.classList.contains("emojis");if(this.element.querySelectorAll("button").length===0&&!l)return!1;if(t.key==="Enter"){if(l){const o=this.element.querySelector(".emojis__item--current");if(!o)return!1;const r=o.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const c=getSelection().getRangeAt(0);c.endContainer.nodeType!==3&&((s=c.endContainer.childNodes[c.endOffset-1])==null||s.remove()),addEmoji(r);let f;r.indexOf(".")>-1?f=`:${r.split(".")[0]}: `:f=unicode2Emoji(r)+" ",insertHTML(n.lute.SpinBlockDOM(f),n),this.element.classList.add("fn__none")}else this.fill(r,n)}else{const o=decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value"));o===Constants.ZWSP+3?this.element.querySelector(".b3-list-item--focus input").click():this.fill(o,n,!0,isOnlyMeta(t))}return t.preventDefault(),t.stopPropagation(),!0}if(l){const o=this.element.querySelector(".emojis__item--current");if(!o)return!1;let r;if(t.key==="ArrowLeft"||t.key==="ArrowUp"?o.previousElementSibling?(o.classList.remove("emojis__item--current"),r=o.previousElementSibling):(a=o.parentElement.previousElementSibling)!=null&&a.previousElementSibling&&(o.classList.remove("emojis__item--current"),r=o.parentElement.previousElementSibling.previousElementSibling.lastElementChild):(t.key==="ArrowRight"||t.key==="ArrowDown")&&(o.nextElementSibling?(o.classList.remove("emojis__item--current"),r=o.nextElementSibling):(i=o.parentElement.nextElementSibling)!=null&&i.nextElementSibling&&(o.classList.remove("emojis__item--current"),r=o.parentElement.nextElementSibling.nextElementSibling.firstElementChild)),r){r.classList.add("emojis__item--current");const c=4,f=this.element.querySelector(".emojis__panel");r.offsetTop-c<f.scrollTop?f.scrollTop=r.offsetTop-c:r.offsetTop-c-f.clientHeight+r.clientHeight>f.scrollTop&&(f.scrollTop=r.offsetTop-c-f.clientHeight+r.clientHeight)}return t.preventDefault(),t.stopPropagation(),!0}else if(t.key==="ArrowDown"||t.key==="ArrowUp")return upDownHint(this.element.firstElementChild,t),t.preventDefault(),t.stopPropagation(),!0;return t.key==="ArrowLeft"||t.key==="ArrowRight"?(hideElements(["hint"],n),t.preventDefault(),t.stopPropagation(),!0):!1}fixImageCursor(t){const n=hasPreviousSibling(t.startContainer);n&&n.nodeType!==3&&n.classList.contains("img")&&(hasNextSibling(n)||(t.insertNode(document.createTextNode(Constants.ZWSP)),t.collapse(!1)))}getKey(t,n){if(this.lastIndex=-1,this.splitChar="",n.forEach(i=>{let l=t.lastIndexOf(i.key);Constants.BLOCK_HINT_KEYS.includes(i.key)&&l>-1&&t.lastIndexOf(i.key+i.key.substring(0,1))>-1&&(l=Math.min(l,t.lastIndexOf(i.key+i.key.substring(0,1)))),this.lastIndex<l&&(Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&(i.key===":"||i.key==="#"||i.key==="/"||i.key==="\u3001")||this.splitChar==="#"&&(i.key==="/"||i.key==="\u3001")||(this.splitChar=i.key,this.lastIndex=l))}),this.lastIndex===-1)return;this.splitChar===":"&&(this.enableEmoji=!(/\d/.test(t.substr(this.lastIndex-1,1))||t.substr(this.lastIndex-1,2)==="::"));const s=t.split(this.splitChar),a=s[s.length-1];if(s.length>1&&a.trim()===a&&a.length<Constants.SIZE_TITLE)return this.splitChar==="\u3010\u3010"&&t.endsWith("\u3010\u3010\u3011")?"":a}}const ad=(e,t)=>{if(typeof speechSynthesis=="undefined"||typeof SpeechSynthesisUtterance=="undefined")return;const n='<svg><use xlink:href="#iconPlay"></use></svg>',s='<svg><use xlink:href="#iconPause"></use></svg>';let a=document.querySelector(".protyle-speech");if(!a){a=document.createElement("div"),a.className="protyle-speech",document.body.insertAdjacentElement("beforeend",a);const i=()=>{const o=speechSynthesis.getVoices();let r,c;return o.forEach(f=>{f.lang===t.replace("_","-")&&(r=f),f.default&&(c=f)}),r||(r=c),r};speechSynthesis.onvoiceschanged!==void 0&&(speechSynthesis.onvoiceschanged=i);const l=i();a.onclick=()=>{if(a.className==="protyle-speech"){const o=new SpeechSynthesisUtterance(a.getAttribute("data-text"));o.voice=l,o.onend=()=>{a.className="protyle-speech",speechSynthesis.cancel(),a.innerHTML=n},speechSynthesis.speak(o),a.className="protyle-speech protyle-speech--current",a.innerHTML=s}else speechSynthesis.speaking&&(speechSynthesis.paused?(speechSynthesis.resume(),a.innerHTML=s):(speechSynthesis.pause(),a.innerHTML=n));focusByRange(window.protyleSpeechRange)},document.body.addEventListener("click",()=>{getSelection().toString().trim()===""&&a.style.display==="block"&&(a.className="protyle-speech",speechSynthesis.cancel(),a.style.display="none")})}e.addEventListener("mouseup",i=>{const l=getSelection().toString().trim();if(speechSynthesis.cancel(),getSelection().toString().trim()===""){a.style.display==="block"&&(a.className="protyle-speech",a.style.display="none");return}window.protyleSpeechRange=getSelection().getRangeAt(0).cloneRange();const o=getSelection().getRangeAt(0).getBoundingClientRect();a.innerHTML=n,a.style.display="block",a.style.top=o.top+o.height+document.querySelector("html").scrollTop-20+"px",a.style.left=i.screenX+2+"px",a.setAttribute("data-text",l)})};class sd{constructor(t){this.element=document.createElement("div"),this.element.className="protyle-preview fn__none";const n=document.createElement("div");n.className="b3-typography",t.options.classes.preview&&n.classList.add(t.options.classes.preview),t.wysiwyg.element.style.padding&&(n.style.padding=t.wysiwyg.element.style.padding);const s=t.options.preview.actions,a=document.createElement("div");a.className="protyle-preview__action";const i=[];for(let l=0;l<s.length;l++){const o=s[l];if(typeof o=="object"){i.push(`<button type="button" data-type="${o.key}" class="${o.className}">${o.text}</button>`);continue}switch(o){case"desktop":i.push(`<button type="button"${t.wysiwyg.element.style.padding?' class="protyle-preview__action--current"':""} data-type="desktop">Desktop</button>`);break;case"tablet":i.push('<button type="button" data-type="tablet">Tablet</button>');break;case"mobile":i.push('<button type="button" data-type="mobile">Mobile/Wechat</button>');break;case"mp-wechat":i.push('<button type="button" data-type="mp-wechat" class="b3-tooltips b3-tooltips__w" aria-label="\u590D\u5236\u5230\u516C\u4F17\u53F7"><svg><use xlink:href="#iconMp"></use></svg></button>');break;case"zhihu":i.push('<button type="button" data-type="zhihu" class="b3-tooltips b3-tooltips__w" aria-label="\u590D\u5236\u5230\u77E5\u4E4E"><svg><use xlink:href="#iconZhihu"></use></svg></button>');break;case"yuque":i.push('<button type="button" data-type="yuque" class="b3-tooltips b3-tooltips__w" aria-label="\u590D\u5236\u5230\u8BED\u96C0"><svg><use xlink:href="#iconYuque"></use></svg></button>');break}}a.innerHTML=i.join(""),this.element.appendChild(a),this.element.appendChild(n),this.element.addEventListener("click",l=>{t.model&&(setPanelFocus(t.model.element.parentElement.parentElement),updateOutline(getAllModels(),t.model.editor.protyle));let o=l.target;for(;o&&!o.isEqualNode(this.element);){if(o.tagName==="A"){const r=o.getAttribute("href");if(r.startsWith("#")){n.querySelector(r).scrollIntoView(),l.stopPropagation(),l.preventDefault();break}if(isMobile()){openByMobile(r),l.stopPropagation(),l.preventDefault();break}l.stopPropagation(),l.preventDefault(),isLocalPath(r)||window.open(r);break}else if(o.tagName==="IMG"){previewDocImage(l.target.src,t.block.rootID),l.stopPropagation(),l.preventDefault();break}else if(o.tagName==="BUTTON"){const r=o.getAttribute("data-type"),c=s.find(f=>(f==null?void 0:f.key)===r);c?c.click(r):r==="mp-wechat"||r==="zhihu"||r==="yuque"?this.copyToX(this.element.lastElementChild.cloneNode(!0),t,r):r==="desktop"?(n.style.width="",n.style.padding=t.wysiwyg.element.style.padding):r==="tablet"?(n.style.width="1024px",n.style.padding="8px 16px"):(n.style.width="360px",n.style.padding="8px"),r!=="mp-wechat"&&r!=="zhihu"&&r!=="yuque"&&(a.querySelectorAll("button").forEach(f=>{f.classList.remove("protyle-preview__action--current")}),o.classList.add("protyle-preview__action--current"))}o=o.parentElement}}),this.previewElement=n}render(t,n){if(this.element.style.display==="none")return;let s=this.element.querySelector(".fn__loading");s||(this.element.insertAdjacentHTML("beforeend",`<div style="flex-direction: column;" class="fn__loading">
    <img width="48px" src="/stage/loading-pure.svg">
</div>`),s=this.element.querySelector(".fn__loading")),this.mdTimeoutId=window.setTimeout(()=>{fetchPost("/api/export/preview",{id:t.block.parentID||t.options.blockId},a=>{const i=t.preview.previewElement.scrollTop;t.preview.previewElement.innerHTML=a.data.html,processRender(t.preview.previewElement),highlightRender(t.preview.previewElement),avRender(t.preview.previewElement,t),speechRender(t.preview.previewElement,t.options.lang),t.preview.previewElement.scrollTop=i,n&&n(a.data.outline),s.remove()})},t.options.preview.delay)}link2online(t){needSubscribe("")||t.querySelectorAll("[href],[src]").forEach(n=>{const s=n.getAttribute("href")||n.getAttribute("src");if(s&&s.startsWith("assets/")){const a=Constants.ASSETS_ADDRESS+window.siyuan.user.userId+"/"+s;n.getAttribute("href")?n.setAttribute("href",a):n.setAttribute("src",a)}})}copyToX(t,n,s){if(s==="mp-wechat")this.link2online(t),t.querySelectorAll(".katex-html .base").forEach(l=>{l.style.display="initial"}),t.querySelectorAll("mjx-container > svg").forEach(l=>{l.setAttribute("width",parseInt(l.getAttribute("width"))*8+"px")});else if(s==="zhihu")this.link2online(t),t.querySelectorAll('[data-subtype="math"]').forEach(l=>{l.outerHTML=`<img class="Formula-image" data-eeimg="true" src="//www.zhihu.com/equation?tex=" alt="${l.getAttribute("data-content")}" style="${l.tagName==="DIV"?"display: block; max-width: 100%;":""}margin: 0 auto;">`}),t.querySelectorAll("blockquote").forEach(l=>{const o=[];this.processZHBlockquote(l,o),o.reverse().forEach(r=>{l.insertAdjacentElement("afterend",r)}),l.remove()}),this.processZHTable(t);else if(s==="yuque"){fetchPost("/api/lute/copyStdMarkdown",{id:n.block.rootID},l=>{writeText(l.data),showMessage("\u5DF2\u590D\u5236\uFF0C\u53EF\u5230\u8BED\u96C0\u8FDB\u884C\u7C98\u8D34")});return}t.style.backgroundColor="#fff",t.querySelectorAll("code").forEach(l=>{l.style.backgroundImage="none"}),this.element.append(t);let a;getSelection().rangeCount>0&&(a=getSelection().getRangeAt(0).cloneRange());const i=t.ownerDocument.createRange();i.selectNodeContents(t),focusByRange(i),document.execCommand("copy"),this.element.lastElementChild.remove(),focusByRange(a),s&&showMessage(`\u5DF2\u590D\u5236\uFF0C\u53EF\u5230${s==="zhihu"?"\u77E5\u4E4E":"\u5FAE\u4FE1\u516C\u4F17\u53F7\u5E73\u53F0"}\u8FDB\u884C\u7C98\u8D34`)}processZHBlockquote(t,n){Array.from(t.children).forEach(s=>{if(s.tagName==="BLOCKQUOTE")this.processZHBlockquote(s,n);else if(s.tagName!=="P"||s.querySelector("img"))n.push(s);else{const a=n[n.length-1];(!a||a&&a.tagName!=="BLOCKQUOTE")&&n.push(document.createElement("blockquote")),n[n.length-1].append(s)}})}processZHTable(t){t.querySelectorAll("table").forEach(n=>{const s=n.querySelector("thead");if(!s)return;const a=n.querySelector("tbody");a?a.insertAdjacentElement("afterbegin",s.firstElementChild):n.innerHTML=`<tbody>${s.innerHTML}</tbody>`,s.remove()})}}class id{constructor(t){this.defaultOptions={mode:"wysiwyg",blockId:"",render:{background:!1,title:!1,gutter:!0,scroll:!1,breadcrumb:!0,breadcrumbDocName:!1},action:[],after:void 0,classes:{preview:""},debugger:Constants.NODE_ENV==="development",hint:{delay:200,emoji:{"+1":"\u{1F44D}","-1":"\u{1F44E}",confused:"\u{1F615}",eyes:"\u{1F440}\uFE0F",heart:"\u2764\uFE0F",rocket:"\u{1F680}\uFE0F",smile:"\u{1F604}",tada:"\u{1F389}\uFE0F"},emojiPath:"/emojis",extend:[{key:"((",hint:hintRef},{key:"\u3010\u3010",hint:hintRef},{key:"\uFF08\uFF08",hint:hintRef},{key:"[[",hint:hintRef},{key:"{{",hint:hintEmbed},{key:"\u300C\u300C",hint:hintEmbed},{key:"\u300C\u300E",hint:hintEmbed},{key:"\u300E\u300C",hint:hintEmbed},{key:"\u300E\u300E",hint:hintEmbed},{key:"#",hint:hintTag},{key:"/",hint:hintSlash},{key:"\u3001",hint:hintSlash},{key:":"}]},lang:window.siyuan.config.appearance.lang,preview:{actions:["desktop","tablet","mobile","mp-wechat","zhihu","yuque"],delay:0,markdown:{paragraphBeginningSpace:window.siyuan.config.export.paragraphBeginningSpace,listStyle:!1,sanitize:!0},mode:"both"},toolbar:isMobile()?["block-ref","a","|","text","strong","em","u","clear","|","code","tag","inline-math","inline-memo"]:["block-ref","a","|","text","strong","em","u","s","mark","sup","sub","clear","|","code","kbd","tag","inline-math","inline-memo"],typewriterMode:!1,upload:{max:1024*1024*1024*4,url:Constants.UPLOAD_ADDRESS,extraData:{},fieldName:"file[]",filename:n=>n.replace(/[\\/:*?"'<>|]/g,""),linkToImgUrl:"",withCredentials:!1}},this.options=t}merge(){var t;return this.options&&(this.options.toolbar?this.options.toolbar=this.mergeToolbar(this.options.toolbar):this.options.toolbar=this.mergeToolbar(this.defaultOptions.toolbar),(t=this.options.hint)!=null&&t.emoji&&(this.defaultOptions.hint.emoji=this.options.hint.emoji)),merge(this.defaultOptions,this.options)}mergeToolbar(t){const n=[{name:"block-ref",hotkey:window.siyuan.config.keymap.editor.insert.ref.custom,lang:"ref",icon:"iconRef",tipPosition:"ne"},{name:"a",hotkey:window.siyuan.config.keymap.editor.insert.link.custom,lang:"link",icon:"iconLink",tipPosition:"n"},{name:"strong",lang:"bold",hotkey:window.siyuan.config.keymap.editor.insert.bold.custom,icon:"iconBold",tipPosition:"n"},{name:"em",lang:"italic",hotkey:window.siyuan.config.keymap.editor.insert.italic.custom,icon:"iconItalic",tipPosition:"n"},{name:"u",lang:"underline",hotkey:window.siyuan.config.keymap.editor.insert.underline.custom,icon:"iconUnderline",tipPosition:"n"},{name:"s",lang:"strike",hotkey:window.siyuan.config.keymap.editor.insert.strike.custom,icon:"iconStrike",tipPosition:"n"},{name:"mark",lang:"mark",hotkey:window.siyuan.config.keymap.editor.insert.mark.custom,icon:"iconMark",tipPosition:"n"},{name:"sup",lang:"sup",hotkey:window.siyuan.config.keymap.editor.insert.sup.custom,icon:"iconSup",tipPosition:"n"},{name:"sub",lang:"sub",hotkey:window.siyuan.config.keymap.editor.insert.sub.custom,icon:"iconSub",tipPosition:"n"},{name:"kbd",lang:"kbd",hotkey:window.siyuan.config.keymap.editor.insert.kbd.custom,icon:"iconKeymap",tipPosition:"n"},{name:"tag",lang:"tag",hotkey:window.siyuan.config.keymap.editor.insert.tag.custom,icon:"iconTags",tipPosition:"n"},{name:"code",lang:"inline-code",hotkey:window.siyuan.config.keymap.editor.insert["inline-code"].custom,icon:"iconInlineCode",tipPosition:"n"},{name:"inline-math",lang:"inline-math",hotkey:window.siyuan.config.keymap.editor.insert["inline-math"].custom,icon:"iconMath",tipPosition:"n"},{name:"inline-memo",lang:"memo",hotkey:window.siyuan.config.keymap.editor.insert.memo.custom,icon:"iconM",tipPosition:"n"},{name:"text",lang:"appearance",hotkey:window.siyuan.config.keymap.editor.insert.appearance.custom,icon:"iconFont",tipPosition:"n"},{name:"clear",lang:"clearInline",hotkey:window.siyuan.config.keymap.editor.insert.clearInline.custom,icon:"iconClear",tipPosition:"n"},{name:"|"}],s=[];return t.forEach(a=>{let i=a;n.find(l=>{if(typeof a=="string"&&l.name===a)return i=l,!0;if(typeof a=="object"&&l.name===a.name)return i=Object.assign({},l,a),!0}),s.push(i)}),s}}class od{constructor(t){this.parentElement=document.createElement("div"),this.parentElement.classList.add("protyle-scroll"),isMobile()||(this.parentElement.style.right="10px"),this.parentElement.innerHTML=`<div class="b3-tooltips b3-tooltips__w protyle-scroll__up" aria-label="${updateHotkeyTip("\u2318Home")}">
    <svg><use xlink:href="#iconUp"></use></svg>
</div>
<div class="fn__none protyle-scroll__bar b3-tooltips b3-tooltips__s" aria-label="Blocks 1/1">
    <input class="b3-slider" type="range" max="1" min="1" step="1" value="1" />
</div>
<div class="b3-tooltips b3-tooltips__w protyle-scroll__down" aria-label="${updateHotkeyTip("\u2318End")}">
    <svg><use xlink:href="#iconDown"></use></svg>
</div>`,this.element=this.parentElement.querySelector(".protyle-scroll__bar"),this.keepLazyLoad=!1,t.options.render.scroll||this.parentElement.classList.add("fn__none"),this.lastScrollTop=0,this.inputElement=this.element.firstElementChild,this.inputElement.addEventListener("input",()=>{this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${t.block.blockCount}`)}),this.inputElement.addEventListener("change",()=>{this.setIndex(t)}),this.inputElement.addEventListener("touchend",()=>{this.setIndex(t)}),this.parentElement.addEventListener("click",n=>{const s=n.target;hasClosestByClassName(s,"protyle-scroll__up")?goHome(t):hasClosestByClassName(s,"protyle-scroll__down")?goEnd(t):s.classList.contains("b3-slider")&&this.setIndex(t)})}setIndex(t){t.wysiwyg.element.getAttribute("data-top")||(t.wysiwyg.element.setAttribute("data-top",t.wysiwyg.element.scrollTop.toString()),fetchPost("/api/filetree/getDoc",{index:parseInt(this.inputElement.value),id:t.block.parentID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},n=>{onGet({data:n,protyle:t,action:[Constants.CB_GET_FOCUSFIRST,Constants.CB_GET_UNCHANGEID]})}))}updateIndex(t,n){fetchPost("/api/block/getBlockIndex",{id:n},s=>{if(!s.data)return;const a=t.scroll.element.querySelector(".b3-slider");a.value=s.data,t.scroll.element.setAttribute("aria-label",`Blocks ${s.data}/${t.block.blockCount}`)})}update(t){typeof t.block.blockCount=="number"&&(this.inputElement.setAttribute("max",t.block.blockCount.toString()),this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${t.block.blockCount}`)),t.block.showAll?this.element.classList.add("fn__none"):t.block.scroll&&!t.contentElement.classList.contains("fn__none")?this.element.classList.remove("fn__none"):this.element.classList.add("fn__none")}}class ld{constructor(t){this.app=t.app,t.msgCallback&&this.connect(t)}connect(t){const n=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,s=new WebSocket(`${n}?app=${Constants.SIYUAN_APPID}&id=${t.id}${t.type?"&type="+t.type:""}`);s.onopen=()=>{t.callback&&t.callback.call(this),document.getElementById("errorLog")&&(reloadSync(this.app,{upsertRootIDs:[],removeRootIDs:[]}),window.siyuan.dialogs.find(i=>{if(i.element.id==="errorLog")return i.destroy(),!0}))},s.onmessage=a=>{if(t.msgCallback){const i=processMessage(JSON.parse(a.data));t.msgCallback.call(this,i)}},s.onclose=a=>{0<=a.reason.indexOf("unauthenticated")||0>a.reason.indexOf("close websocket")&&(console.warn("WebSocket is closed. Reconnect will be attempted in 3 second.",a),setTimeout(()=>{this.connect({id:t.id,type:t.type,msgCallback:t.msgCallback})},3e3))},s.onerror=a=>{a.target.url.endsWith("&type=main")&&a.target.readyState===3&&kernelError()},this.ws=s}send(t,n,s=!1){this.ws&&(this.reqId=s?0:new Date().getTime(),this.ws.send(JSON.stringify({cmd:t,reqId:this.reqId,param:n})))}}var un=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const rd=(e,t)=>un(void 0,null,function*(){try{let n=yield readText();n=n.replace(/\\/g,"\\\\").replace(/\*/g,"\\*").replace(/_/g,"\\_").replace(/\[/g,"\\[").replace(/]/g,"\\]").replace(/!/g,"\\!").replace(/`/g,"\\`").replace(/</g,"\\<").replace(/>/g,"\\>").replace(/&/g,"\\&").replace(/~/g,"\\~").replace(/\{/g,"\\{").replace(/}/g,"\\}").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/=/g,"\\=").replace(/#/g,"\\#").replace(/\$/g,"\\$").replace(/\^/g,"\\^").replace(/\|/g,"\\|"),pi(e,n,t)}catch(n){console.log(n)}}),ht=(e,t)=>{let n=!0;e.options.hint.extend.find(s=>{if(s.key===t)return n=!1,!0}),n&&e.hint.render(e)},cd=e=>un(void 0,null,function*(){[].length===0&&navigator.clipboard.readText().then(n=>{insertHTML(e.lute.BlockDOM2EscapeMarkerContent(e.lute.Md2BlockDOM(n)),e),ht(e,n)})}),pi=(e,t,n)=>{const s=getEditorRange(e.wysiwyg.element);if(n.getAttribute("data-type")==="NodeCodeBlock"){insertHTML(t,e);return}s.toString()!==""&&(isDynamicRef(t)?t=t.replace(/'.+'\)\)$/,` "${s.toString()}"))`):isFileAnnotation(t)?t=t.replace(/".+">>$/,`"${s.toString()}">>`):e.lute.IsValidLinkDest(t)&&(t=`[${s.toString()}](${t})`)),insertHTML(e.lute.Md2BlockDOM(t),e),blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),ht(e,t),scrollCenter(e,void 0,!1,"smooth")},dd=(e,t)=>un(void 0,null,function*(){var n;t.stopPropagation(),t.preventDefault();let s,a,i,l;if("clipboardData"in t?(s=t.clipboardData.getData("text/html"),a=t.clipboardData.getData("text/plain"),i=t.clipboardData.getData("text/siyuan"),l=t.clipboardData.files):(s=t.dataTransfer.getData("text/html"),a=t.dataTransfer.getData("text/plain"),i=t.dataTransfer.getData("text/siyuan"),t.dataTransfer.types[0]==="Files"&&(l=t.dataTransfer.items)),(s.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<a href="${a}">${a}</a>`||s.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<!--StartFragment--><a href="${a}">${a}</a><!--EndFragment-->`)&&(s=""),a.endsWith(Constants.ZWSP)&&!s&&!i&&(i=a.substr(0,a.length-1)),!i){const u=new DOMParser().parseFromString(s,"text/html");u.body&&u.body.innerHTML&&(s=u.body.innerHTML),s.startsWith(`
<!--StartFragment-->`)&&s.endsWith(`<!--EndFragment-->

`)&&(s=u.body.innerHTML.trim().replace("<!--StartFragment-->","").replace("<!--EndFragment-->","")),s=Lute.Sanitize(s)}if(e&&e.app&&e.app.plugins)for(let u=0;u<e.app.plugins.length;u++){const d=yield new Promise(g=>{e.app.plugins[u].eventBus.emit("paste",{protyle:e,resolve:g,textHTML:s,textPlain:a,siyuanHTML:i,files:l})&&g(void 0)});d!=null&&d.textHTML&&(s=d.textHTML),d!=null&&d.textPlain&&(a=d.textPlain),d!=null&&d.siyuanHTML&&(i=d.siyuanHTML),d!=null&&d.files&&(l=d.files)}const o=hasClosestBlock(t.target);if(!o){l&&l.length>0&&uploadFiles(e,l);return}hideElements(["select"],e),e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(u=>{u.classList.remove("protyle-wysiwyg--hl")});const r=processPasteCode(s,a),c=getEditorRange(e.wysiwyg.element);if(o.getAttribute("data-type")==="NodeCodeBlock"||e.toolbar.getCurrentType(c).includes("code")){(n=o.querySelector(".protyle-action"))!=null&&n.contains(c.startContainer)&&c.setStart(o.querySelector(".hljs").firstChild,0),insertHTML(a,e);return}else if(i){const u=document.createElement("div");u.innerHTML=i;let d=!1;u.querySelectorAll("[data-node-id]").forEach(p=>{const b=Lute.NewNodeID();p.setAttribute("data-node-id",b),p.removeAttribute(Constants.CUSTOM_RIFF_DECKS),p.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),p.setAttribute("updated",b.split("-")[0]),d=!0}),o.classList.contains("table")&&(d=!1),u.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(p=>{p.setAttribute("contenteditable","true")});const g=u.innerHTML;insertHTML(g,e,d),ht(e,e.lute.BlockDOM2StdMd(g)),blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e)}else if(r)r.startsWith('<div data-type="NodeCodeBlock" class="code-block" data-node-id="')?(insertHTML(r,e,!0),highlightRender(e.wysiwyg.element)):insertHTML(r,e),hideElements(["hint"],e);else{let u=!1;if(s.replace("<!--StartFragment--><!--EndFragment-->","").trim()!==""&&(s=s.replace("<!--StartFragment-->","").replace("<!--EndFragment-->","").trim(),l&&l.length===1&&(s.startsWith("<img")||s.startsWith("<table")&&s.indexOf("<img")>-1)?u=!1:u=!0),u){const d=document.createElement("div");d.innerHTML=s,d.querySelectorAll("[style]").forEach(g=>{g.removeAttribute("style")}),d.querySelectorAll("a").forEach(g=>{g.innerHTML.trim()===""&&g.remove()}),fetchPost("/api/lute/html2BlockDOM",{dom:d.innerHTML},g=>{insertHTML(g.data,e),e.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(p=>{p.textContent===""&&fetchPost("/api/block/getRefText",{id:p.getAttribute("data-id")},b=>{p.innerHTML=b.data})}),blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),ht(e,g.data),scrollCenter(e,void 0,!1,"smooth")});return}else if(l&&l.length>0)uploadFiles(e,l);else if(a.trim()!==""&&l&&l.length===0){if(c.toString()!==""){const g=a.split(`
`)[0];if(isDynamicRef(a)){e.toolbar.setInlineMark(e,"block-ref","range",{type:"id",color:`${a.substring(2,22+2)}${Constants.ZWSP}s${Constants.ZWSP}${c.toString()}`});return}else if(isFileAnnotation(g)){e.toolbar.setInlineMark(e,"file-annotation-ref","range",{type:"file-annotation-ref",color:g.substring(2).replace(/ ".+">>$/,"")});return}else if(e.lute.IsValidLinkDest(a)){e.toolbar.setInlineMark(e,"a","range",{type:"a",color:a});return}}const d=e.lute.Md2BlockDOM(a);insertHTML(d,e),ht(e,a)}blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e)}const f=o.querySelector(".av__cell--select");o.classList.contains("av")&&f?cellScrollIntoView(o,f):scrollCenter(e,void 0,!1,"smooth")});var Mt=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const ba=(e,t,n,s,a,i,l)=>{let o;const r=n.getAttribute("data-node-id"),c=s.getAttribute("data-node-id"),f=[],u=[];return n.insertAdjacentElement(i?"afterend":"beforebegin",s),i?f.push({action:"insert",data:s.outerHTML,id:c,previousID:r}):f.push({action:"insert",data:s.outerHTML,id:c,nextID:r}),t.reverse().forEach((d,g)=>{var p;const b=d.getAttribute("data-node-id");g===t.length-1&&(o=getTopAloneElement(d),o.isSameNode(d)&&(o=void 0));const m=Lute.NewNodeID();if(l?u.push({action:"delete",id:m}):u.push({action:"move",id:b,previousID:(p=d.previousElementSibling)==null?void 0:p.getAttribute("data-node-id"),parentID:d.parentElement.getAttribute("data-node-id")||e.block.rootID}),!a&&!l){const h=e.wysiwyg.element.querySelector(`[data-node-id="${b}"]`);h&&h.remove()}if(l){const h=d.cloneNode(!0);h.setAttribute("data-node-id",m),h.querySelectorAll("[data-node-id]").forEach(y=>{const k=Lute.NewNodeID();y.setAttribute("data-node-id",k),y.setAttribute("updated",k.split("-")[0])}),s.insertAdjacentElement("afterbegin",h),f.push({action:"insert",id:m,data:h.outerHTML,parentID:c})}else s.insertAdjacentElement("afterbegin",d),f.push({action:"move",id:b,parentID:c})}),u.reverse(),s.getAttribute("data-subtype")==="o"&&(u.splice(0,0,{action:"update",id:c,data:s.outerHTML}),updateListOrder(s,1),f.push({action:"update",id:c,data:s.outerHTML})),u.push({action:"delete",id:c}),{doOperations:f,undoOperations:u,topSourceElement:o}},ha=(e,t,n,s,a,i)=>Mt(void 0,null,function*(){let l;const o=[],r=[],c=[],f=n.getAttribute("data-node-id");let u=n;t.reverse().forEach((d,g)=>{var p,b,m,h,y;const k=d.getAttribute("data-node-id"),E=d.parentElement.getAttribute("data-node-id")||e.block.rootID;g===t.length-1&&(l=getTopAloneElement(d),l.isSameNode(d)?l=void 0:l.contains(d)&&l.contains(n)&&(l=n)),i&&d.getAttribute("data-type")==="NodeHeading"&&d.getAttribute("fold")==="1"&&(d.removeAttribute("fold"),c.push({id:k,parentID:E}));let A,v;if(i?(A=Lute.NewNodeID(),r.push({action:"delete",id:A})):r.push({action:"move",id:k,previousID:(p=d.previousElementSibling)==null?void 0:p.getAttribute("data-node-id"),parentID:E}),!s&&!i){const S=e.wysiwyg.element.querySelector(`[data-node-id="${k}"]`);S&&S.remove()}i?(v=d.cloneNode(!0),v.setAttribute("data-node-id",A),v.querySelectorAll("[data-node-id]").forEach(S=>{const w=Lute.NewNodeID();S.setAttribute("data-node-id",w),S.setAttribute("updated",w.split("-")[0])}),u.insertAdjacentElement(a,v),o.push({action:"insert",id:A,data:v.outerHTML,previousID:a==="afterend"?f:(b=v.previousElementSibling)==null?void 0:b.getAttribute("data-node-id"),parentID:((m=v.parentElement)==null?void 0:m.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID})):(u.insertAdjacentElement(a,d),o.push({action:"move",id:k,previousID:a==="afterend"?f:(h=d.previousElementSibling)==null?void 0:h.getAttribute("data-node-id"),parentID:((y=d.parentElement)==null?void 0:y.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID})),a!=="afterend"&&(u=i?v:d)}),r.reverse();for(let d=0;d<c.length;d++){const g=c[d];(yield fetchSyncPost("/api/block/getHeadingChildrenIDs",{id:g.id})).data.reverse().forEach(b=>{r.push({action:"move",id:b,previousID:g.id,parentID:g.parentID})}),r.push({action:"foldHeading",id:g.id,data:"remove"}),o.push({action:"unfoldHeading",id:g.id})}return{doOperations:o,undoOperations:r,topSourceElement:l}}),ya=(e,t,n,s,a,i)=>Mt(void 0,null,function*(){var l,o,r,c,f,u;const d=e.element.contains(t[0]);let g;t[0].getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-type")!=="NodeListItem"&&(g=document.createElement("div"),g.setAttribute("data-node-id",Lute.NewNodeID()),g.setAttribute("data-type","NodeList"),g.setAttribute("data-subtype",t[0].getAttribute("data-subtype")),g.className="list",g.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`));const p=[{action:"move",id:n.getAttribute("data-node-id"),previousID:(l=n.previousElementSibling)==null?void 0:l.getAttribute("data-node-id"),parentID:((o=n.parentElement)==null?void 0:o.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}];let b,m=t[0].parentElement;const h=genSBElement(a);n.parentElement.replaceChild(h,n);const y=[{action:"insert",data:h.outerHTML,id:h.getAttribute("data-node-id"),nextID:(r=h.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"),previousID:(c=h.previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:h.parentElement.getAttribute("data-node-id")||e.block.parentID||e.block.rootID}];if(g){const k=g.getAttribute("data-node-id");h.insertAdjacentElement("afterbegin",n),y.push({action:"move",id:n.getAttribute("data-node-id"),parentID:h.getAttribute("data-node-id")}),s?(n.insertAdjacentElement("afterend",g),y.push({action:"insert",data:g.outerHTML,id:k,previousID:n.getAttribute("data-node-id")})):(n.insertAdjacentElement("beforebegin",g),y.push({action:"insert",data:g.outerHTML,id:k,nextID:n.getAttribute("data-node-id")})),t.reverse().forEach((E,A)=>{var v;A===t.length-1&&(b=getTopAloneElement(E),b.isSameNode(E)&&(b=void 0));const S=Lute.NewNodeID();if(i?p.push({action:"delete",id:S}):p.push({action:"move",id:E.getAttribute("data-node-id"),previousID:(v=E.previousElementSibling)==null?void 0:v.getAttribute("data-node-id"),parentID:E.parentElement.getAttribute("data-node-id")||e.block.rootID}),!d&&!i){const w=e.wysiwyg.element.querySelector(`[data-node-id="${E.getAttribute("data-node-id")}"]`);w&&w.remove()}if(i){const w=E.cloneNode(!0);w.setAttribute("data-node-id",S),w.querySelectorAll("[data-node-id]").forEach(_=>{const C=Lute.NewNodeID();_.setAttribute("data-node-id",C),_.setAttribute("updated",C.split("-")[0])}),g.insertAdjacentElement("afterbegin",w),y.push({action:"insert",id:S,data:w.outerHTML,parentID:k})}else g.insertAdjacentElement("afterbegin",E),y.push({action:"move",id:E.getAttribute("data-node-id"),parentID:k})}),p.reverse(),p.push({action:"delete",id:k})}else{const k=[];let E;t.reverse().forEach((A,v)=>{var S;const w=A.getAttribute("data-node-id"),_=A.parentElement.getAttribute("data-node-id")||e.block.rootID;v===t.length-1&&(b=getTopAloneElement(A),b.isSameNode(A)&&(b=void 0));const C=Lute.NewNodeID();if(v===0&&(E=i?C:w),i&&A.getAttribute("data-type")==="NodeHeading"&&A.getAttribute("fold")==="1"&&(A.removeAttribute("fold"),k.push({id:w,parentID:_})),i?p.push({action:"delete",id:C}):p.push({action:"move",id:w,previousID:(S=A.previousElementSibling)==null?void 0:S.getAttribute("data-node-id"),parentID:_}),!d&&!i){const x=e.wysiwyg.element.querySelector(`[data-node-id="${w}"]`);x&&x.remove()}if(i){const x=A.cloneNode(!0);x.setAttribute("data-node-id",C),x.querySelectorAll("[data-node-id]").forEach(T=>{const B=Lute.NewNodeID();T.setAttribute("data-node-id",B),T.setAttribute("updated",B.split("-")[0])}),h.insertAdjacentElement("afterbegin",x),y.push({action:"insert",id:C,data:x.outerHTML,parentID:h.getAttribute("data-node-id")})}else h.insertAdjacentElement("afterbegin",A),y.push({action:"move",id:w,parentID:h.getAttribute("data-node-id")})}),p.reverse();for(let A=0;A<k.length;A++){const v=k[A],S=yield fetchSyncPost("/api/block/getHeadingChildrenIDs",{id:v.id});S.data.reverse().forEach(w=>{p.push({action:"move",id:w,previousID:v.id,parentID:v.parentID})}),A===0&&(E=S.data[0]),p.push({action:"foldHeading",id:v.id,data:"remove"}),y.push({action:"unfoldHeading",id:v.id})}s?(h.insertAdjacentElement("afterbegin",n),y.push({action:"move",id:n.getAttribute("data-node-id"),parentID:h.getAttribute("data-node-id")})):(h.lastElementChild.insertAdjacentElement("beforebegin",n),y.push({action:"move",id:n.getAttribute("data-node-id"),previousID:E}))}if(p.push({action:"delete",id:h.getAttribute("data-node-id")}),!i&&m&&m.classList.contains("list")&&m.getAttribute("data-subtype")==="o"&&!m.isSameNode(t[0].parentElement)&&m.childElementCount>1&&(Array.from(m.children).forEach(k=>{k.classList.contains("protyle-attr")||p.splice(0,0,{action:"update",id:k.getAttribute("data-node-id"),data:k.outerHTML})}),updateListOrder(m,1),Array.from(m.children).forEach(k=>{k.classList.contains("protyle-attr")||y.push({action:"update",id:k.getAttribute("data-node-id"),data:k.outerHTML})})),!i&&b){if(y.push({action:"delete",id:b.getAttribute("data-node-id")}),p.splice(0,0,{action:"insert",data:b.outerHTML,id:b.getAttribute("data-node-id"),previousID:(f=b.previousElementSibling)==null?void 0:f.getAttribute("data-node-id"),parentID:((u=b.parentElement)==null?void 0:u.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}),!d){const k=e.wysiwyg.element.querySelector(`[data-node-id="${b.getAttribute("data-node-id")}"]`);k&&k.remove()}m=b.parentElement,b.remove()}if(!i&&m&&m.classList.contains("sb")&&m.childElementCount===2){const k=cancelSB(e,m);y.push(k.doOperations[0],k.doOperations[1]),p.splice(0,0,k.undoOperations[0],k.undoOperations[1])}else!i&&m&&m.classList.contains("protyle-wysiwyg")&&m.innerHTML;d||i?transaction(e,y,p):transaction(e,y),focusBlock(t[0])}),wa=(e,t,n,s,a)=>Mt(void 0,null,function*(){var i,l;const o=e.element.contains(t[0]),r=[],c=[];let f;t[0].getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-type")!=="NodeListItem"&&(f=document.createElement("div"),f.setAttribute("data-node-id",Lute.NewNodeID()),f.setAttribute("data-type","NodeList"),f.setAttribute("data-subtype",t[0].getAttribute("data-subtype")),f.className="list",f.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`));let u,d=t[0].parentElement;if(s)if(f){const g=ba(e,t,n,f,o,s,a);r.push(...g.doOperations),c.push(...g.undoOperations),u=g.topSourceElement}else{const g=yield ha(e,t,n,o,"afterend",a);r.push(...g.doOperations),c.push(...g.undoOperations),u=g.topSourceElement}else if(f){const g=ba(e,t,n,f,o,s,a);r.push(...g.doOperations),c.push(...g.undoOperations),u=g.topSourceElement}else{const g=yield ha(e,t,n,o,"beforebegin",a);r.push(...g.doOperations),c.push(...g.undoOperations),u=g.topSourceElement}if(n.getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-subtype")==="o"&&(Array.from(n.parentElement.children).forEach(g=>{g.classList.contains("protyle-attr")||c.splice(0,0,{action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML})}),updateListOrder(n.parentElement,1),Array.from(n.parentElement.children).forEach(g=>{g.classList.contains("protyle-attr")||r.push({action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML})})),!a&&o&&d&&d.classList.contains("list")&&d.getAttribute("data-subtype")==="o"&&!d.isSameNode(t[0].parentElement)&&d.childElementCount>1&&(Array.from(d.children).forEach(g=>{g.classList.contains("protyle-attr")||(d.contains(n)?c.splice(0,0,{action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML}):c.splice(n.parentElement.childElementCount-1,0,{action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML}))}),updateListOrder(d,1),Array.from(d.children).forEach(g=>{g.classList.contains("protyle-attr")||r.push({action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML})})),!a&&u&&(r.push({action:"delete",id:u.getAttribute("data-node-id")}),c.splice(0,0,{action:"insert",data:u.outerHTML,id:u.getAttribute("data-node-id"),previousID:(i=u.previousElementSibling)==null?void 0:i.getAttribute("data-node-id"),parentID:((l=u.parentElement)==null?void 0:l.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}),d=u.parentElement,u.remove(),!o)){const g=e.wysiwyg.element.querySelector(`[data-node-id="${u.getAttribute("data-node-id")}"]`);g&&g.remove()}if(!a&&d&&d.classList.contains("sb")&&d.childElementCount===2){const g=cancelSB(e,d);r.push(g.doOperations[0],g.doOperations[1]),c.splice(0,0,g.undoOperations[0],g.undoOperations[1])}else!a&&d&&d.classList.contains("protyle-wysiwyg")&&d.childElementCount;o||a?transaction(e,r,c):transaction(e,r),focusBlock(t[0])}),ud=(e,t)=>{t.addEventListener("dragstart",a=>{const i=a.target;if(i.tagName==="IMG"){window.siyuan.dragElement=void 0,a.preventDefault();return}if(i.classList){if(hasClosestByClassName(i,"protyle-wysiwyg__embed"))window.siyuan.dragElement=void 0,a.preventDefault();else if(i.classList.contains("protyle-action")){window.siyuan.dragElement=e.wysiwyg.element,a.dataTransfer.setData(`${Constants.SIYUAN_DROP_GUTTER}NodeListItem${Constants.ZWSP}${i.parentElement.getAttribute("data-subtype")}${Constants.ZWSP}${[i.parentElement.getAttribute("data-node-id")]}`,e.wysiwyg.element.innerHTML);return}else if(i.classList.contains("av__cell--header")){window.siyuan.dragElement=i,a.dataTransfer.setData(`${Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${Constants.ZWSP}Col${Constants.ZWSP}${[i.getAttribute("data-col-id")]}`,i.outerHTML);return}}a.dataTransfer.setData(Constants.SIYUAN_DROP_EDITOR,Constants.SIYUAN_DROP_EDITOR),e.element.style.userSelect="auto",document.onmousemove=null,document.onmouseup=null}),t.addEventListener("drop",a=>Mt(void 0,null,function*(){var i,l,o,r,c;if(e.disabled||a.dataTransfer.getData(Constants.SIYUAN_DROP_EDITOR)){a.preventDefault(),a.stopPropagation();return}let f="";for(const d of a.dataTransfer.items)d.type.startsWith(Constants.SIYUAN_DROP_GUTTER)&&(f=d.type);const u=t.querySelector(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top");if(u&&(u.classList.remove("protyle-wysiwyg--select"),u.removeAttribute("select-start"),u.removeAttribute("select-end")),f){const d=[],g=f.replace(Constants.SIYUAN_DROP_GUTTER,"").split(Constants.ZWSP),p=g[2].split(",");if(a.altKey){focusByRange(getRangeByPoint(a.clientX,a.clientY));let b="";for(let m=0;m<p.length;m++){const h=yield fetchSyncPost("/api/block/getRefText",{id:p[m]});b+=`((${p[m]} '${h.data}')) `}insertHTML(b,e)}else if(a.shiftKey){focusByRange(getRangeByPoint(a.clientX,a.clientY));let b="";p.forEach(m=>{b+=`{{select * from blocks where id='${m}'}}
`}),insertHTML(e.lute.SpinBlockDOM(b),e,!0),blockRender(e,e.wysiwyg.element)}else if(u&&u.className.indexOf("dragover__")>-1){let b="";if(p.forEach(y=>{b+=`[data-node-id="${y}"],`}),window.siyuan.dragElement)window.siyuan.dragElement.querySelectorAll(b.substring(0,b.length-1)).forEach(y=>{(y.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(y,"data-type","NodeBlockQueryEmbed"))&&d.push(y)});else{const y=document.createElement("template");y.innerHTML=`<div>${a.dataTransfer.getData(f)}</div>`,y.content.querySelectorAll(b.substring(0,b.length-1)).forEach(k=>{(k.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(k,"data-type","NodeBlockQueryEmbed"))&&d.push(k)})}const m=[];d.forEach(y=>{y.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),y.removeAttribute("select-start"),y.removeAttribute("select-end"),y.querySelectorAll('[data-type="search-mark"]').forEach(k=>{k.outerHTML=k.innerHTML}),m.push(y.getAttribute("data-node-id"))}),hideElements(["gutter"],e);const h=u.className.split(" ");if(u.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right"),u.classList.contains("av__cell")){const y=hasClosestBlock(u);if(y){const k=y.getAttribute("data-av-id");let E="";h.includes("dragover__left")?u.previousElementSibling&&(u.previousElementSibling.classList.contains("av__colsticky")?E=u.previousElementSibling.lastElementChild.getAttribute("data-col-id"):E=u.previousElementSibling.getAttribute("data-col-id")):E=u.getAttribute("data-col-id");let A="";const v=hasClosestByClassName(u,"av__row");if(v){const S=(i=v.querySelector(`[data-col-id="${g[2]}"`))==null?void 0:i.previousElementSibling;S&&(S.classList.contains("av__colsticky")?A=S.lastElementChild.getAttribute("data-col-id"):A=S.getAttribute("data-col-id"))}transaction(e,[{action:"sortAttrViewCol",avID:k,previousID:E,id:g[2]}],[{action:"sortAttrViewCol",avID:k,previousID:A,id:g[2]}])}}else if(u.classList.contains("av__row")){const y=hasClosestBlock(u);if(y){let k="";h.includes("dragover__bottom")?k=u.getAttribute("data-id")||"":k=((l=u.previousElementSibling)==null?void 0:l.getAttribute("data-id"))||"";const E=y.getAttribute("data-av-id");if(g[0]==="nodeattributeviewrowmenu"){const A=[],v=[],S=y.querySelector(`[data-id="${p[0]}"]`).previousElementSibling.getAttribute("data-id")||"";p.reverse().forEach(w=>{A.push({action:"sortAttrViewRow",avID:E,previousID:k,id:w}),v.push({action:"sortAttrViewRow",avID:E,previousID:S,id:w})}),transaction(e,A,v)}else transaction(e,[{action:"insertAttrViewBlock",avID:E,previousID:k,srcIDs:m,isDetached:!1}],[{action:"removeAttrViewBlock",srcIDs:m,avID:E}]),insertAttrViewBlockAnimation(e,y,m,k)}}else d.length>0&&(u.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&u.parentElement.getAttribute("data-sb-layout")==="col"?h.includes("dragover__left")||h.includes("dragover__right")?wa(e,d,u,h.includes("dragover__right"),a.ctrlKey):ya(e,d,u,h.includes("dragover__bottom"),"row",a.ctrlKey):h.includes("dragover__left")||h.includes("dragover__right")?ya(e,d,u,h.includes("dragover__right"),"col",a.ctrlKey):wa(e,d,u,h.includes("dragover__bottom"),a.ctrlKey),d.forEach(y=>{y.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(y.removeAttribute("data-render"),blockRender(e,y))}),u.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(u.removeAttribute("data-render"),blockRender(e,u)));n=void 0}}else if(((o=a.dataTransfer.getData(Constants.SIYUAN_DROP_FILE))==null?void 0:o.split("-").length)>1&&u&&!e.options.backlinkData&&u.className.indexOf("dragover__")>-1){const d=e.contentElement.scrollTop,g=a.dataTransfer.getData(Constants.SIYUAN_DROP_FILE).split(",");if(u.classList.contains("av__row")){const p=hasClosestBlock(u);if(p){let b="";u.classList.contains("dragover__bottom")?b=u.getAttribute("data-id")||"":b=((r=u.previousElementSibling)==null?void 0:r.getAttribute("data-id"))||"";const m=p.getAttribute("data-av-id");transaction(e,[{action:"insertAttrViewBlock",avID:m,previousID:b,srcIDs:g,isDetached:!1}],[{action:"removeAttrViewBlock",srcIDs:g,avID:m}]),insertAttrViewBlockAnimation(e,p,g,b)}}else{for(let p=0;p<g.length;p++)g[p]&&(yield fetchSyncPost("/api/filetree/doc2Heading",{srcID:g[p],after:u.classList.contains("dragover__bottom"),targetID:u.getAttribute("data-node-id")}));fetchPost("/api/filetree/getDoc",{id:e.block.id,size:window.siyuan.config.editor.dynamicLoadBlocks},p=>{onGet({data:p,protyle:e}),setTimeout(()=>{e.contentElement.scrollTop=d,e.scroll.lastScrollTop=d-1},Constants.TIMEOUT_LOAD)})}u.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right")}else if(!window.siyuan.dragElement&&(a.dataTransfer.types[0]==="Files"||a.dataTransfer.types.includes("text/html"))){const d=hasClosestByClassName(a.target,"av");if(d){const g=hasClosestByClassName(a.target,"av__cell");if(g&&((c=d.querySelector(`.av__row--header [data-col-id="${g.dataset.colId}"]`))==null?void 0:c.getAttribute("data-dtype"))==="mAsset"&&a.dataTransfer.types[0]==="Files"&&!isBrowser()){const b=[];for(let m=0;m<a.dataTransfer.files.length;m++)b.push(a.dataTransfer.files[m].path);dragUpload(b,e,g,d.dataset.avId)}}else if(focusByRange(getRangeByPoint(a.clientX,a.clientY)),a.dataTransfer.types[0]==="Files"&&!isBrowser()){const g=[];for(let p=0;p<a.dataTransfer.files.length;p++)g.push(a.dataTransfer.files[p].path);uploadLocalFiles(g,e,!a.altKey)}else paste(e,a)}window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}));let n,s;t.addEventListener("dragover",a=>{var i,l;if(e.disabled){a.preventDefault(),a.stopPropagation();return}const o=e.contentElement.getBoundingClientRect();if((a.clientY<o.top+Constants.SIZE_SCROLL_TB||a.clientY>o.bottom-Constants.SIZE_SCROLL_TB)&&e.contentElement.scroll({top:e.contentElement.scrollTop+(a.clientY<o.top+Constants.SIZE_SCROLL_TB?-Constants.SIZE_SCROLL_STEP:Constants.SIZE_SCROLL_STEP),behavior:"smooth"}),a.dataTransfer.types.includes("Files")&&a.target.classList.contains("protyle-wysiwyg")){a.preventDefault();return}let r="";for(const d of a.dataTransfer.items)d.type.startsWith(Constants.SIYUAN_DROP_GUTTER)&&(r=d.type);if(!r&&!window.siyuan.dragElement){a.preventDefault();return}if(a.shiftKey||a.altKey){const d=hasClosestBlock(a.target);d&&(d.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),d.removeAttribute("select-start"),d.removeAttribute("select-end")),a.preventDefault();return}a.preventDefault();let c=hasClosestByClassName(a.target,"av__row")||hasClosestBlock(a.target);const f={x:a.clientX,y:a.clientY,className:""};if(c)c&&c.classList.contains("list")&&(r&&r.replace(Constants.SIYUAN_DROP_GUTTER,"").split(Constants.ZWSP)[0]!=="nodelistitem"?c=hasClosestBlock(document.elementFromPoint(a.clientX,a.clientY-6)):c=hasClosestByClassName(document.elementFromPoint(a.clientX,a.clientY-6),"li"));else if(a.clientY>t.lastElementChild.getBoundingClientRect().bottom)c=t.lastElementChild,f.className="dragover__bottom";else if(a.clientY<t.firstElementChild.getBoundingClientRect().top)c=t.firstElementChild,f.className="dragover__top";else if(o){const d={left:o.left+parseInt(t.style.paddingLeft),right:o.left+e.contentElement.clientWidth-parseInt(t.style.paddingRight)};a.clientX<d.left?(f.x=d.left,f.className="dragover__left"):a.clientX>=d.right&&(f.x=d.right-6,f.className="dragover__right"),c=document.elementFromPoint(f.x,f.y),c.classList.contains("protyle-wysiwyg")&&(c=document.elementFromPoint(f.x,f.y-6)),c=hasTopClosestByAttribute(c,"data-node-id",null)}if(r&&r.startsWith(`${Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${Constants.ZWSP}Col${Constants.ZWSP}`.toLowerCase())){if(c=hasClosestByClassName(a.target,"av__cell"),c){const d=hasClosestByClassName(c,"av__row--header"),g=hasClosestByClassName(window.siyuan.dragElement,"av__row--header");(!d||!g||d&&g&&!d.isSameNode(g))&&(c=!1)}}else c&&r&&r.startsWith(`${Constants.SIYUAN_DROP_GUTTER}NodeAttributeViewRowMenu${Constants.ZWSP}`.toLowerCase())&&(!c.classList.contains("av__row")||!window.siyuan.dragElement.contains(c))&&(c=!1);if(!c)return;const u=a.dataTransfer.types.includes(Constants.SIYUAN_DROP_FILE)&&window.siyuan.dragElement?window.siyuan.dragElement.innerText:"";if(c&&n&&c.isSameNode(n)){const d=c.getBoundingClientRect();if(t.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top").forEach(g=>{g.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","protyle-wysiwyg--select"),g.removeAttribute("select-start"),g.removeAttribute("select-end")}),c.getAttribute("data-type")==="NodeAttributeView"&&hasClosestByTag(a.target,"TD"))return;if(f.className){c.classList.add(f.className);return}if(c.getAttribute("data-type")==="NodeListItem"||u.indexOf("-")>-1){a.clientY>d.top+d.height/2?c.classList.add("dragover__bottom"):c.classList.contains("av__row--header")||c.classList.add("dragover__top");return}if(c.classList.contains("av__cell")){a.clientX<d.left+d.width/2&&a.clientX>d.left&&!c.classList.contains("av__row")?c.classList.add("dragover__left"):a.clientX>d.right-d.width/2&&a.clientX<=d.right+1&&!c.classList.contains("av__row")&&c.classList.add("dragover__right");return}a.clientX<d.left+32&&a.clientX>=d.left-1&&!c.classList.contains("av__row")?c.classList.add("dragover__left"):a.clientX>d.right-32&&a.clientX<d.right&&!c.classList.contains("av__row")?c.classList.add("dragover__right"):a.clientY>d.top+d.height/2&&s!=="bottom"?c.classList.add("dragover__bottom"):s!=="top"&&c.classList.add("dragover__top");return}if(u.indexOf("-")>-1){u.split(",").includes(e.block.rootID)&&!c.classList.contains("av__row")?n=void 0:n=c;return}if(r){s="";const d=r.replace(Constants.SIYUAN_DROP_GUTTER,"").split(Constants.ZWSP);if(d[0]==="nodeattributeview"&&d[1]==="col"&&c.getAttribute("data-id")===d[2]||d[2].split(",").find(p=>{if(p&&hasClosestByAttribute(c,"data-node-id",p))return!0})||hasClosestByAttribute(c.parentElement,"data-type","NodeBlockQueryEmbed")||d[0]==="nodelistitem"&&d[1]!==c.getAttribute("data-subtype")&&c.getAttribute("data-type")==="NodeListItem"||d[0]!=="nodelistitem"&&c.getAttribute("data-type")==="NodeListItem")return;d[0]==="nodelistitem"&&c.parentElement.classList.contains("li")&&((i=c.previousElementSibling)!=null&&i.classList.contains("protyle-action"))&&(s="top"),d[0]==="nodelistitem"&&((l=c.nextElementSibling)!=null&&l.classList.contains("list"))&&(s="bottom"),c&&c.classList.contains("av__row--header")&&(s="top"),n=c}}),t.addEventListener("dragleave",a=>{if(e.disabled){a.preventDefault(),a.stopPropagation();return}t.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top").forEach(i=>{i.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right")})})},fd=(e,t,n)=>{if(!t.classList.contains("av")||!window.siyuan.menus.menu.element.classList.contains("fn__none"))return!1;if(e.isComposing)return!0;if(matchHotKey("\u2318B",e)||matchHotKey("\u2318I",e)||matchHotKey("\u2318U",e))return e.preventDefault(),!0;const s=t.querySelector(".av__cell--select");if(s){const i=hasClosestByClassName(s,"av__row");if(!i)return!1;if(t.querySelectorAll(".av__cell--active").forEach(o=>{var r;o.classList.remove("av__cell--active"),(r=o.querySelector(".av__drag-fill"))==null||r.remove()}),e.key==="Escape")return s.classList.remove("av__cell--select"),selectRow(i.querySelector(".av__firstcol"),"select"),e.preventDefault(),!0;if(e.key==="Enter")return popTextCell(n,[s]),e.preventDefault(),!0;if(e.key==="Backspace"||e.key==="Delete")return updateCellsValue(n,t,void 0,[s]),e.preventDefault(),!0;let l;if(e.key==="ArrowLeft"||matchHotKey("\u21E7\u21E5",e)){const o=i.previousElementSibling;if(s.previousElementSibling&&!s.previousElementSibling.classList.contains("av__firstcol"))s.previousElementSibling.classList.contains("av__cell")?l=s.previousElementSibling:l=s.previousElementSibling.lastElementChild;else if(o&&!o.classList.contains("av__row--header")){const r=o.querySelectorAll(".av__cell");l=r[r.length-1]}return l&&(s.classList.remove("av__cell--select"),l.classList.add("av__cell--select"),cellScrollIntoView(t,l,!1)),e.preventDefault(),!0}if(e.key==="ArrowRight"||matchHotKey("\u21E5",e)){const o=i.nextElementSibling;return s.nextElementSibling&&s.nextElementSibling.classList.contains("av__cell")?l=s.nextElementSibling:!s.nextElementSibling&&s.parentElement.nextElementSibling?l=s.parentElement.nextElementSibling:o&&!o.classList.contains("av__row--footer")&&(l=o.querySelector(".av__cell")),l&&(s.classList.remove("av__cell--select"),l.classList.add("av__cell--select"),cellScrollIntoView(t,l,!1)),e.preventDefault(),!0}if(e.key==="ArrowUp"){const o=i.previousElementSibling;return o&&!o.classList.contains("av__row--header")&&(l=o.querySelector(`.av__cell[data-col-id="${s.dataset.colId}"]`)),l&&(s.classList.remove("av__cell--select"),l.classList.add("av__cell--select"),cellScrollIntoView(t,l)),e.preventDefault(),!0}if(e.key==="ArrowDown"){const o=i.nextElementSibling;return o&&!o.classList.contains("av__row--footer")&&(l=o.querySelector(`.av__cell[data-col-id="${s.dataset.colId}"]`)),l&&(s.classList.remove("av__cell--select"),l.classList.add("av__cell--select"),cellScrollIntoView(t,l)),e.preventDefault(),!0}if(!Constants.KEYCODELIST[e.keyCode]||Constants.KEYCODELIST[e.keyCode].length===1&&!e.metaKey&&!e.ctrlKey&&!["\u21E7","\u2303","\u2325","\u2318"].includes(Constants.KEYCODELIST[e.keyCode]))return s.style.backgroundColor?e.preventDefault():popTextCell(n,[s]),!0}const a=t.querySelectorAll(".av__row--select:not(.av__row--header)");if(a.length>0){if(matchHotKey("\u2318/",e))return e.stopPropagation(),e.preventDefault(),avContextmenu(n,a[0],{x:t.querySelector(".layout-tab-bar").getBoundingClientRect().left,y:a[0].getBoundingClientRect().bottom}),!0;if(e.key==="Escape")return e.preventDefault(),selectRow(a[0].querySelector(".av__firstcol"),"unselectAll"),!0;if(e.key==="Backspace")return e.preventDefault(),deleteRow(t,n),!0;if(e.key==="Enter")return selectRow(a[0].querySelector(".av__firstcol"),"unselectAll"),popTextCell(n,[a[0].querySelector(".av__cell")]),e.preventDefault(),!0;if(e.key==="ArrowUp"){const i=a[0].previousElementSibling;return selectRow(a[0].querySelector(".av__firstcol"),"unselectAll"),i&&!i.classList.contains("av__row--header")?(selectRow(i.querySelector(".av__firstcol"),"select"),cellScrollIntoView(t,i)):t.classList.add("protyle-wysiwyg--select"),e.preventDefault(),!0}if(e.key==="ArrowDown"){const i=a[a.length-1].nextElementSibling;return selectRow(a[0].querySelector(".av__firstcol"),"unselectAll"),i&&!i.classList.contains("av__row--util")?(selectRow(i.querySelector(".av__firstcol"),"select"),cellScrollIntoView(t,i)):t.classList.add("protyle-wysiwyg--select"),e.preventDefault(),!0}}return!1},_a=(e,t)=>{let n="";Array.from(e.cloneContents().childNodes).forEach(s=>{s.nodeType===3?n+=s.textContent:n+=s.outerHTML}),fetchPost("/api/block/getDOMText",{dom:n},s=>{t(s.data)})},gd=(e,t)=>{t.addEventListener("keydown",n=>{var s,a,i,l,o,r,c,f;if(n.target.localName==="protyle-html"){n.stopPropagation();return}if(e.disabled||!e.selectElement.classList.contains("fn__none")){n.stopPropagation(),n.preventDefault();return}e.wysiwyg.preventKeyup=!1,hideElements(["util"],e),n.shiftKey&&n.key.indexOf("Arrow")>-1||!n.repeat&&n.code!==""&&hideElements(["toolbar"],e);let u=getEditorRange(e.wysiwyg.element);const d=hasClosestBlock(u.startContainer);if(!d)return;const g=hasClosestBlock(u.endContainer);if(!matchHotKey("\u2318C",n)&&g&&!d.isSameNode(g)){n.stopPropagation(),n.preventDefault();return}if(avKeydown(n,d,e))return;if(d.classList.contains("protyle-wysiwyg--select")&&isNotCtrl(n)&&!n.shiftKey&&!n.altKey){if(n.key.toLowerCase()==="a")return n.stopPropagation(),n.preventDefault(),e.wysiwyg.element.blur(),setTimeout(()=>{insertEmptyBlock(e,"afterend")},100),!1;if(n.key.toLowerCase()==="b")return n.stopPropagation(),n.preventDefault(),e.wysiwyg.element.blur(),setTimeout(()=>{insertEmptyBlock(e,"beforebegin")},100),!1}if(n.isComposing){n.stopPropagation();return}if(["\u2318","\u21E7","\u2325","\u2303"].includes(Constants.KEYCODELIST[n.keyCode])||(Constants.KEYCODELIST[n.keyCode]==="/"||n.key==="/"||n.code==="Slash"&&n.key==="Process"&&n.keyCode===229?e.hint.enableSlash=!0:(Constants.KEYCODELIST[n.keyCode]==="\\"||n.key==="\\"||n.code==="Backslash"&&n.key==="Process"&&n.keyCode===229)&&(e.hint.enableSlash=!1,hideElements(["hint"],e))),n.key!=="PageUp"&&n.key!=="PageDown"&&n.key!=="Home"&&n.key!=="End"&&n.key.indexOf("Arrow")===-1&&n.key!=="Escape"&&n.key!=="Shift"&&n.key!=="Meta"&&n.key!=="Alt"&&n.key!=="Control"&&n.key!=="CapsLock"&&!isNotEditBlock(d)&&!/^F\d{1,2}$/.test(n.key)&&typeof e.wysiwyg.lastHTMLs[d.getAttribute("data-node-id")]=="undefined"){const m=u.cloneRange();u.insertNode(document.createElement("wbr")),e.wysiwyg.lastHTMLs[d.getAttribute("data-node-id")]=d.outerHTML,d.querySelector("wbr").remove(),u=m}if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&(["\u2190","\u2191","\u2192","\u2193"].includes(Constants.KEYCODELIST[n.keyCode])||Constants.KEYCODELIST[n.keyCode]==="\u21A9")&&!n.altKey&&!n.shiftKey&&isNotCtrl(n)){n.preventDefault();return}else n.key!=="Escape"&&window.siyuan.menus.menu.remove();if(!["Alt","Meta","Shift","Control","CapsLock","Escape"].includes(n.key)&&e.options.render.breadcrumb&&e.breadcrumb.hide(),!n.altKey&&!n.shiftKey&&isNotCtrl(n)&&(n.key==="ArrowDown"||n.key==="ArrowUp")){const m=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(m.length>0){if(n.preventDefault(),n.stopPropagation(),hideElements(["select"],e),n.key==="ArrowDown"){const h=m[m.length-1];let y=getNextBlock(h);if(y)if(y.getBoundingClientRect().width===0){const E=hasTopClosestByAttribute(y,"fold","1");E?(y=getNextBlock(E),y?y=getFirstBlock(y):y=h):y=h}else y.getAttribute("fold")==="1"&&(y.classList.contains("sb")||y.classList.contains("bq"))||(y=getFirstBlock(y));else y=h;y.classList.add("protyle-wysiwyg--select"),countBlockWord([y.getAttribute("data-node-id")]);const k=y.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;k>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+k,e.scroll.lastScrollTop=e.contentElement.scrollTop-1),focusBlock(y)}else if(n.key==="ArrowUp"){let h=getPreviousBlock(m[0]);if(h){if(h=getLastBlock(h),h.getBoundingClientRect().width===0){const y=hasTopClosestByAttribute(h,"fold","1");y?h=getFirstBlock(y):h=m[0]}else if(h){const y=hasTopClosestByAttribute(h,"fold","1");y&&(y.classList.contains("sb")||y.classList.contains("bq"))&&(h=y)}}else e.title&&(e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.contentElement.scrollTop===0)?e.title.editElement.focus():e.contentElement.scrollTop!==0?(e.contentElement.scrollTop=0,e.scroll.lastScrollTop=8):h=m[0];if(h){h.classList.add("protyle-wysiwyg--select"),countBlockWord([h.getAttribute("data-node-id")]);const y=h.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;y<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+y,e.scroll.lastScrollTop=e.contentElement.scrollTop+1),focusBlock(h)}}return}}if(n.key!=="PageUp"&&n.key!=="PageDown"&&n.key!=="Home"&&n.key!=="End"&&n.key.indexOf("Arrow")===-1&&isNotCtrl(n)&&n.key!=="Escape"&&!n.shiftKey&&!n.altKey&&!/^F\d{1,2}$/.test(n.key)&&n.key!=="Enter"&&n.key!=="Tab"&&n.key!=="Backspace"&&n.key!=="Delete"&&n.key!=="ContextMenu")return n.stopPropagation(),hideElements(["select"],e),!1;if(matchHotKey(window.siyuan.config.keymap.editor.general.collapse.custom,n)&&!n.repeat){const m=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");return m.length>0?setFold(e,m[0]):d.parentElement.getAttribute("data-type")==="NodeListItem"?d.parentElement.childElementCount>3?setFold(e,d.parentElement):setFold(e,d):d.getAttribute("data-type")==="NodeHeading"?setFold(e,d):setFold(e,getTopAloneElement(d)),n.stopPropagation(),n.preventDefault(),!1}if(matchHotKey(window.siyuan.config.keymap.editor.general.expand.custom,n)&&!n.repeat){const m=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");m.length>0?setFold(e,m[0],!0):d.parentElement.getAttribute("data-type")==="NodeListItem"?d.parentElement.childElementCount>3?setFold(e,d.parentElement,!0):setFold(e,d,!0):d.getAttribute("data-type")==="NodeHeading"?setFold(e,d,!0):setFold(e,getTopAloneElement(d),!0),n.stopPropagation(),n.preventDefault();return}if((matchHotKey("\u21E7\u2190",n)||matchHotKey("\u21E7\u2192",n))&&e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").length>0){n.stopPropagation(),n.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.expandUp.custom,n)){upSelect({protyle:e,event:n,nodeElement:d,editorElement:t,range:u,cb(m){const h=m[0].previousElementSibling;if(h&&h.getAttribute("data-node-id")){h.classList.add("protyle-wysiwyg--select"),m.forEach(k=>{k.removeAttribute("select-end")}),h.setAttribute("select-end","true");const y=h.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;y<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+y,e.scroll.lastScrollTop=e.contentElement.scrollTop+1)}else m[0].parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],e),m[0].parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(matchHotKey(window.siyuan.config.keymap.editor.general.expandDown.custom,n)){downSelect({protyle:e,event:n,nodeElement:d,editorElement:t,range:u,cb(m){const h=m[m.length-1],y=h.nextElementSibling;if(y&&y.getAttribute("data-node-id")){y.classList.add("protyle-wysiwyg--select"),m.forEach(E=>{E.removeAttribute("select-end")}),y.setAttribute("select-end","true");const k=y.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;k>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+k,e.scroll.lastScrollTop=e.contentElement.scrollTop-1)}else h.parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],e),h.parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(matchHotKey("\u21E7\u2191",n)){upSelect({protyle:e,event:n,nodeElement:d,editorElement:t,range:u,cb(m){const h=getStartEndElement(m);if(h.startElement.getBoundingClientRect().top>=h.endElement.getBoundingClientRect().top){const y=h.endElement.previousElementSibling;if(y&&y.getAttribute("data-node-id")){y.classList.add("protyle-wysiwyg--select"),y.setAttribute("select-end","true"),h.endElement.removeAttribute("select-end");const k=y.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;k<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+k,e.scroll.lastScrollTop=e.contentElement.scrollTop+1)}else h.endElement.parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],e),h.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{h.endElement.classList.remove("protyle-wysiwyg--select"),h.endElement.removeAttribute("select-end");const y=getPreviousBlock(h.endElement);y&&(y.setAttribute("select-end","true"),y.getBoundingClientRect().top<=e.contentElement.getBoundingClientRect().top&&(preventScroll(e),y.scrollIntoView(!0)))}}});return}if(matchHotKey("\u21E7\u2193",n)){downSelect({protyle:e,event:n,nodeElement:d,editorElement:t,range:u,cb(m){const h=getStartEndElement(m);if(h.startElement.getBoundingClientRect().top<=h.endElement.getBoundingClientRect().top){const y=h.endElement.nextElementSibling;if(y&&y.getAttribute("data-node-id")){y.classList.add("protyle-wysiwyg--select"),y.setAttribute("select-end","true"),h.endElement.removeAttribute("select-end");const k=y.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;k>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+k,e.scroll.lastScrollTop=e.contentElement.scrollTop-1)}else h.endElement.parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],e),h.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{h.endElement.classList.remove("protyle-wysiwyg--select"),h.endElement.removeAttribute("select-end");const y=getNextBlock(h.endElement);y&&(y.setAttribute("select-end","true"),y.getBoundingClientRect().bottom>=e.contentElement.getBoundingClientRect().bottom&&(preventScroll(e),y.scrollIntoView(!1)))}}});return}if(matchHotKey(window.siyuan.config.keymap.general.enter.custom,n)){let m=getTopAloneElement(d);m.parentElement.classList.contains("li")&&m.parentElement.parentElement.classList.contains("list")&&((s=m.nextElementSibling)!=null&&s.classList.contains("list"))&&m.previousElementSibling.classList.contains("protyle-action")&&(m=m.parentElement),zoomOut({protyle:e,id:m.getAttribute("data-node-id")}),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.general.enterBack.custom,n)){enterBack(e,d.getAttribute("data-node-id")),n.preventDefault(),n.stopPropagation();return}if(n.shiftKey&&!n.altKey&&isNotCtrl(n)&&(n.key==="Home"||n.key==="End")&&isMac()||n.shiftKey&&!n.altKey&&isOnlyMeta(n)&&(n.key==="Home"||n.key==="End")&&!isMac()){const m=hasTopClosestByAttribute(d,"data-node-id",null);if(m){m.querySelectorAll(".protyle-wysiwyg--select").forEach(y=>{y.classList.remove("protyle-wysiwyg--select")}),m.classList.add("protyle-wysiwyg--select");let h=n.key==="Home"?m.previousElementSibling:m.nextElementSibling;for(;h;)h.classList.add("protyle-wysiwyg--select"),h=n.key==="Home"?h.previousElementSibling:h.nextElementSibling;n.key==="Home"?e.wysiwyg.element.firstElementChild.scrollIntoView():e.wysiwyg.element.lastElementChild.scrollIntoView(!1)}n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&isOnlyMeta(n)&&n.key==="Home"){goHome(e),hideElements(["select"],e),n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&isOnlyMeta(n)&&n.key==="End"){goEnd(e),hideElements(["select"],e),n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&isNotCtrl(n)&&(n.key==="PageUp"||n.key==="PageDown")){n.key==="PageUp"?(e.contentElement.scrollTop=e.contentElement.scrollTop-e.contentElement.clientHeight,e.scroll.lastScrollTop=e.contentElement.scrollTop+1):(e.contentElement.scrollTop=e.contentElement.scrollTop+e.contentElement.clientHeight,e.scroll.lastScrollTop=e.contentElement.scrollTop-1);const m=e.contentElement.getBoundingClientRect();let h=document.elementFromPoint(m.x+m.width/2,m.y+m.height/2);h.classList.contains("protyle-wysiwyg")&&(h=document.elementFromPoint(m.x+m.width/2,m.y+m.height/2+Constants.SIZE_TOOLBAR_HEIGHT));const y=hasClosestBlock(h);y&&!y.isSameNode(d)&&focusBlock(y,void 0,!1),n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&(n.key.indexOf("Arrow")>-1&&isNotCtrl(n)||n.key==="Enter")&&!e.hint.element.classList.contains("fn__none")&&e.hint.select(n,e)){n.stopPropagation(),n.preventDefault();return}if(matchHotKey("\u2318/",n)){n.stopPropagation(),n.preventDefault();const m=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(m.length===0){const y=hasClosestByAttribute(u.startContainer,"data-type",null);if(y&&y.tagName==="SPAN"){const k=y.getAttribute("data-type").split(" ");if(k.length>0&&(e.toolbar.range=u,removeSearchMark(y)),k.includes("block-ref")){refMenu(e,y);return}else if(k.includes("inline-memo")){e.toolbar.showRender(e,y);return}else if(k.includes("file-annotation-ref")){fileAnnotationRefMenu(e,y);return}else if(k.includes("a")){linkMenu(e,y);return}else if(k.includes("tag")){tagMenu(e,y);return}}if(u.startOffset===0&&u.startContainer.nodeType===3){const k=hasPreviousSibling(u.startContainer);if(k&&k.nodeType!==3&&((a=k.getAttribute("data-type"))==null?void 0:a.indexOf("inline-math"))>-1){e.toolbar.showRender(e,k);return}else if(!k&&u.startContainer.parentElement.previousSibling&&u.startContainer.parentElement.previousSibling.isSameNode(u.startContainer.parentElement.previousElementSibling)&&((i=u.startContainer.parentElement.previousElementSibling.getAttribute("data-type"))==null?void 0:i.indexOf("inline-math"))>-1){e.toolbar.showRender(e,u.startContainer.parentElement.previousElementSibling);return}}m.push(d)}m.length===1?e.gutter.renderMenu(e,m[0]):e.gutter.renderMultipleMenu(e,m);const h=d.getBoundingClientRect();window.siyuan.menus.menu.popup({x:h.left,y:h.top,isLeft:!0});return}if(fixTable(e,n,u)){n.preventDefault();return}const p=u.toString();if(!n.altKey&&!n.shiftKey&&isNotCtrl(n)&&!n.isComposing&&n.key.indexOf("Arrow")>-1){const m=getContenteditableElement(d)||d,h=getSelectionOffset(m,e.wysiwyg.element,u),y=hasClosestByMatchTag(u.startContainer,"TD");if(n.key==="ArrowDown"&&(m==null?void 0:m.textContent.trimRight().substr(h.start).indexOf(`
`))===-1&&(y&&!y.parentElement.nextElementSibling&&d.getAttribute("data-type")==="NodeTable"&&!getNextBlock(d)||d.getAttribute("data-type")==="NodeCodeBlock"&&!getNextBlock(d)||d.parentElement.getAttribute("data-type")==="NodeBlockquote"&&d.nextElementSibling.classList.contains("protyle-attr")&&!getNextBlock(d.parentElement)))d.parentElement.getAttribute("data-type")==="NodeBlockquote"?insertEmptyBlock(e,"afterend",d.parentElement.getAttribute("data-node-id")):insertEmptyBlock(e,"afterend",d.getAttribute("data-node-id"));else if(n.key==="ArrowUp"){const k=getContenteditableElement(e.wysiwyg.element.firstElementChild);if(!getPreviousBlock(d)&&d.contains(k)||!k&&d.isSameNode(e.wysiwyg.element.firstElementChild))(getSelectionPosition(d,u).top-e.wysiwyg.element.getBoundingClientRect().top<40||d.classList.contains("av"))&&(e.title&&(e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.contentElement.scrollTop===0)?e.title.editElement.focus():(e.contentElement.scrollTop=0,e.scroll.lastScrollTop=8));else if((m==null?void 0:m.textContent.substr(0,h.end).indexOf(`
`))===-1){let E=getPreviousBlock(d);if(E&&(E=getLastBlock(E),E)){const A=hasClosestByAttribute(E,"fold","1");(l=getContenteditableElement(E))!=null&&l.textContent.endsWith(`
`)&&!A?(focusBlock(E,void 0,!1),scrollCenter(e,E),n.stopPropagation(),n.preventDefault()):A&&A.getAttribute("data-type")!=="NodeListItem"&&(A.scrollTop=0,focusBlock(A,void 0,!0),scrollCenter(e,A),n.stopPropagation(),n.preventDefault())}}}else if(p===""&&(n.key==="ArrowDown"||n.key==="ArrowRight")&&d.isSameNode(getLastBlock(e.wysiwyg.element.lastElementChild))&&!hasClosestByMatchTag(u.startContainer,"TD")&&!hasClosestByMatchTag(u.startContainer,"TH")){const k=getContenteditableElement(d);k&&k.textContent.replace(/\n$/,"").length<=getSelectionOffset(k,void 0,u).end&&(n.stopPropagation(),n.preventDefault(),focusByRange(u))}else if(p===""&&n.key==="ArrowLeft"&&d.isSameNode(getFirstBlock(e.wysiwyg.element.firstElementChild))){const k=getContenteditableElement(d);k&&getSelectionOffset(k,void 0,u).start===0&&(n.stopPropagation(),n.preventDefault(),focusByRange(u))}if(n.key==="ArrowDown"){const k=hasClosestByAttribute(u.startContainer,"fold","1");if(k){let E=getNextBlock(k);E&&(E.getAttribute("fold")==="1"&&(E.classList.contains("sb")||E.classList.contains("bq"))||(E=getFirstBlock(E)),focusBlock(E),scrollCenter(e,E)),n.stopPropagation(),n.preventDefault()}else if((m==null?void 0:m.textContent.substr(h.end+1).indexOf(`
`))===-1){const E=getNextBlock(d);E&&E.getAttribute("fold")==="1"&&(focusBlock(E),scrollCenter(e,E),n.stopPropagation(),n.preventDefault())}}return}if(!n.altKey&&(n.key==="Backspace"||n.key==="Delete")||matchHotKey("\u2303D",n)){if(e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")){removeBlock(e,d,u),n.stopPropagation(),n.preventDefault();return}if(p===""&&n.key==="Backspace"&&u.startOffset===u.startContainer.textContent.length&&u.startContainer.textContent.endsWith(`
`+Constants.ZWSP)){u.setStart(u.startContainer,u.startOffset-1),u.collapse(!0),n.stopPropagation(),n.preventDefault();return}const m=hasPreviousSibling(u.startContainer);if(u.startOffset===1&&u.startContainer.textContent===Constants.ZWSP&&m&&m.nodeType!==3&&n.key==="Backspace"){if(m.classList.contains("img"))m.classList.add("img--select");else if(((o=m.getAttribute("data-type"))==null?void 0:o.indexOf("inline-math"))>-1){m.after(document.createElement("wbr"));const y=d.outerHTML;u.startContainer.textContent="",m.remove(),updateTransaction(e,d.getAttribute("data-node-id"),d.outerHTML,y),focusByWbr(d,u),n.stopPropagation(),n.preventDefault();return}}const h=e.wysiwyg.element.querySelector(".img--select");if(h){if(h.classList.remove("img--select"),d.contains(h)){h.insertAdjacentHTML("afterend","<wbr>");const y=d.outerHTML;h.remove(),updateTransaction(e,d.getAttribute("data-node-id"),d.outerHTML,y),focusByWbr(d,u),n.stopPropagation(),n.preventDefault();return}}else if(p===""){const y=getContenteditableElement(d);if(!y){d.classList.add("protyle-wysiwyg--select"),removeBlock(e,d,u),n.stopPropagation(),n.preventDefault();return}const k=getSelectionOffset(y,e.wysiwyg.element,u);if(n.key==="Delete"||matchHotKey("\u2303D",n)){if(k.end===y.textContent.length){const E=getNextBlock(getTopAloneElement(d));if(E){const A=focusBlock(E);if(A){const v=hasClosestBlock(A.startContainer);v&&removeBlock(e,v,A,!0)}n.stopPropagation(),n.preventDefault();return}}else if(k.end===y.textContent.length-1&&d.getAttribute("data-type")==="NodeCodeBlock"){n.stopPropagation(),n.preventDefault();return}}else{const E=u.startContainer.childNodes[u.startOffset-1];if(k.start===0&&(u.startOffset===0||E&&E.nodeType===3&&!hasPreviousSibling(E)&&E.textContent==="")){removeBlock(e,d,u),n.stopPropagation(),n.preventDefault();return}if(u.startContainer.nodeType!==3&&d.getAttribute("data-type")==="NodeTable"&&((r=u.startContainer.children[u.startOffset-1])==null?void 0:r.tagName)==="TABLE"){d.classList.add("protyle-wysiwyg--select"),removeBlock(e,d,u),n.stopPropagation(),n.preventDefault();return}if(E&&E.nodeType!==3&&E.classList.contains("img")){u.insertNode(document.createElement("wbr"));const v=d.outerHTML;E.remove(),updateTransaction(e,d.getAttribute("data-node-id"),d.outerHTML,v),focusByWbr(d,u),n.stopPropagation(),n.preventDefault();return}if(d.classList.contains("code-block")&&isOnlyMeta(n)&&u.startContainer.nodeType===3&&u.startContainer.textContent.substring(u.startOffset-1,u.startOffset)===`
`){n.stopPropagation(),n.preventDefault();return}const A=hasClosestByMatchTag(u.startContainer,"SPAN");if(k.start===2&&A&&getSelectionOffset(A,e.wysiwyg.element,u).start===1&&A.textContent.startsWith(Constants.ZWSP)){focusBlock(d),n.stopPropagation(),n.preventDefault();return}if(k.start===1&&!A&&y.textContent.startsWith(Constants.ZWSP)){setFirstNodeRange(y,u),removeBlock(e,d,u),n.stopPropagation(),n.preventDefault();return}}}else if(d.classList.contains("code-block")&&getContenteditableElement(d).textContent===`
`){u.collapse(!0),n.stopPropagation(),n.preventDefault();return}}if(matchHotKey("\u21E7\u21A9",n)&&p===""&&softEnter(u,d,e)){n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&isNotCtrl(n)&&n.key==="Enter")if(n.shiftKey){if(d.getAttribute("data-type")==="NodeAttributeView"){n.stopPropagation(),n.preventDefault();return}}else{enter(d,u,e),n.stopPropagation(),n.preventDefault();return}if(matchHotKey("\u2318A",n))return n.preventDefault(),selectAll(e,d,u),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.undo.custom,n)){e.undo.undo(e),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.redo.custom,n)){e.undo.redo(e),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyProtocol.custom,n)){const m=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let h;return m.length===1?h=m[0]:h=d,writeText(`siyuan://blocks/${h.getAttribute("data-node-id")}`),n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyID.custom,n))return writeText(d.getAttribute("data-node-id")),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.copyText.custom,n))return p!==""?_a(u,m=>{writeText(`${m.trim()} ((${d.getAttribute("data-node-id")} "*"))`)}):(d.setAttribute("data-reftext","true"),focusByRange(getEditorRange(d)),document.execCommand("copy")),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,n)){const m=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let h;return m.length===1?h=m[0]:h=d,writeText(`{{select * from blocks where id='${h.getAttribute("data-node-id")}'}}`),n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.attr.custom,n)){const m=getTopAloneElement(d);if(p===""){const h=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let y;h.length===1?y=h[0]:y=m,openAttr(y,"bookmark",e)}else _a(u,h=>{const y=m.outerHTML,k=m.lastElementChild.querySelector(".protyle-attr--name");k?k.innerHTML=`<svg><use xlink:href="#iconN"></use></svg>${h.trim()}`:m.lastElementChild.insertAdjacentHTML("afterbegin",`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${h.trim()}</div>`),m.setAttribute("name",h.trim()),updateTransaction(e,m.getAttribute("data-node-id"),m.outerHTML,y)});return n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.rename.custom,n)&&!e.disabled){p===""?fetchPost("/api/block/getDocInfo",{id:e.block.rootID},m=>{rename({notebookId:e.notebookId,path:e.path,name:m.data.ial.title,range:u,type:"file"})}):fetchPost("/api/filetree/renameDoc",{notebook:e.notebookId,path:e.path,title:replaceFileName(p)}),n.preventDefault(),n.stopPropagation();return}const b=matchHotKey(window.siyuan.config.keymap.editor.general.newNameFile.custom,n);if(b||matchHotKey(window.siyuan.config.keymap.editor.general.newNameSettingFile.custom,n)){!p.trim()&&(d.querySelector("tr")||d.querySelector("span"))||(!p.trim()&&getContenteditableElement(d).textContent&&selectAll(e,d,u),b?fetchPost("/api/filetree/getHPathByPath",{notebook:e.notebookId,path:e.path},m=>{newFileBySelect(e,p,d,m.data)}):getSavePath(e.path,e.notebookId,m=>{newFileBySelect(e,p,d,m)})),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.newContentFile.custom,n)){newFileContentBySelect(e),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.alignLeft.custom,n)){const m=d.querySelectorAll(".img--select");if(m.length>0)alignImgLeft(e,d,Array.from(m),d.getAttribute("data-node-id"),d.outerHTML);else{let h=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));h.length===0&&(h=[d]),updateBatchTransaction(h,e,y=>{y.classList.contains("av")?y.style.justifyContent="":y.style.textAlign="left"})}n.stopPropagation(),n.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.alignCenter.custom,n)){const m=d.querySelectorAll(".img--select");if(m.length>0)alignImgCenter(e,d,Array.from(m),d.getAttribute("data-node-id"),d.outerHTML);else{let h=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));h.length===0&&(h=[d]),updateBatchTransaction(h,e,y=>{y.classList.contains("av")?y.style.justifyContent="center":y.style.textAlign="center"})}n.stopPropagation(),n.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.alignRight.custom,n)){let m=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));m.length===0&&(m=[d]),updateBatchTransaction(m,e,h=>{h.classList.contains("av")?h.style.justifyContent="flex-end":h.style.textAlign="right"}),n.stopPropagation(),n.preventDefault();return}if(n.key==="Escape"){!e.toolbar.element.classList.contains("fn__none")||!e.hint.element.classList.contains("fn__none")||!e.toolbar.subElement.classList.contains("fn__none")?(hideElements(["toolbar","hint","util"],e),e.hint.enableExtend=!1):d.classList.contains("protyle-wysiwyg--select")?(hideElements(["select"],e),countBlockWord([],e.block.rootID)):window.siyuan.menus.menu.element.classList.contains("fn__none")?(hideElements(["select"],e),u.collapse(!1),d.classList.add("protyle-wysiwyg--select"),countBlockWord([d.getAttribute("data-node-id")],e.block.rootID)):window.siyuan.menus.menu.remove(),n.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.heading.paragraph.custom,n))return turnsIntoTransaction({protyle:e,nodeElement:d,type:"Blocks2Ps"}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading1.custom,n))return turnsIntoTransaction({protyle:e,nodeElement:d,type:"Blocks2Hs",level:1}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading2.custom,n))return turnsIntoTransaction({protyle:e,nodeElement:d,type:"Blocks2Hs",level:2}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading3.custom,n))return turnsIntoTransaction({protyle:e,nodeElement:d,type:"Blocks2Hs",level:3}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading4.custom,n))return turnsIntoTransaction({protyle:e,nodeElement:d,type:"Blocks2Hs",level:4}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading5.custom,n))return turnsIntoTransaction({protyle:e,nodeElement:d,type:"Blocks2Hs",level:5}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading6.custom,n))return turnsIntoTransaction({protyle:e,nodeElement:d,type:"Blocks2Hs",level:6}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.insert.code.custom,n)&&!["NodeCodeBlock","NodeHeading"].includes(d.getAttribute("data-type"))){const m=d.getAttribute("data-node-id"),h=d.outerHTML,y=getContenteditableElement(d);y.innerHTML="```"+window.siyuan.storage[Constants.LOCAL_CODELANG]+`
`+y.textContent+"<wbr>\n```";const k=e.lute.SpinBlockDOM(d.outerHTML);d.outerHTML=k;const E=e.wysiwyg.element.querySelector(`[data-node-id="${m}"]`);return updateTransaction(e,m,k,h),highlightRender(E),n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.insert.lastUsed.custom,n)){e.toolbar.range=u;let m=[];p===""&&e.toolbar.getCurrentType(u).length===0&&(m=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),m.length===0&&(m=[d])),fontEvent(e,m),n.stopPropagation(),n.preventDefault();return}if(!d.classList.contains("code-block")&&!n.repeat&&!hasClosestByAttribute(d,"data-type","NodeBlockQueryEmbed")){let m=!1;if(e.options.toolbar.find(h=>{if(!h.hotkey)return!1;if(matchHotKey(h.hotkey,n))return e.toolbar.range=getEditorRange(e.wysiwyg.element),["block-ref"].includes(h.name)&&e.toolbar.range.toString()===""||(m=!0,["a","block-ref","inline-math","inline-memo","text"].includes(h.name)?e.toolbar.element.querySelector(`[data-type="${h.name}"]`).dispatchEvent(new CustomEvent("click")):Constants.INLINE_TYPE.includes(h.name)?e.toolbar.setInlineMark(e,h.name,"range"):h.click&&h.click(e.getInstance())),!0}),m)return n.preventDefault(),n.stopPropagation(),e.wysiwyg.preventKeyup=!0,!0}if(matchHotKey(window.siyuan.config.keymap.editor.list.outdent.custom,n)){const m=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(m.length>0&&m[0].getAttribute("data-type")==="NodeListItem")return listOutdent(e,Array.from(m),u),n.preventDefault(),n.stopPropagation(),!0;if(d.parentElement.classList.contains("li")&&d.getAttribute("data-type")!=="NodeCodeBlock")return listOutdent(e,[d.parentElement],u),n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.list.indent.custom,n)){const m=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(m.length>0&&m[0].getAttribute("data-type")==="NodeListItem")return listIndent(e,Array.from(m),u),n.preventDefault(),n.stopPropagation(),!0;if(d.parentElement.classList.contains("li")&&d.getAttribute("data-type")!=="NodeCodeBlock")return listIndent(e,[d.parentElement],u),n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.insert.check.custom,n)){e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill("* [ ] "+Lute.Caret,e),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.insert.table.custom,n)){e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,e),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.list.checkToggle.custom,n)){const m=hasClosestByAttribute(u.startContainer,"data-subtype","t");if(!m)return;const h=m.outerHTML;m.classList.contains("protyle-task--done")?(m.querySelector("use").setAttribute("xlink:href","#iconUncheck"),m.classList.remove("protyle-task--done")):(m.querySelector("use").setAttribute("xlink:href","#iconCheck"),m.classList.add("protyle-task--done")),m.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,m.getAttribute("data-node-id"),m.outerHTML,h),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.insertBefore.custom,n))return insertEmptyBlock(e,"beforebegin"),n.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.insertAfter.custom,n))return insertEmptyBlock(e,"afterend"),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,n))return jumpToParentNext(e,d),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.moveToUp.custom,n)){n.preventDefault(),n.stopPropagation(),moveToUp(e,d,u);return}if(matchHotKey(window.siyuan.config.keymap.editor.general.moveToDown.custom,n)){n.preventDefault(),n.stopPropagation(),moveToDown(e,d,u);return}if(matchHotKey(window.siyuan.config.keymap.editor.general.vLayout.custom,n)){n.preventDefault(),n.stopPropagation();const m=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(m.length<2||(c=m[0])!=null&&c.classList.contains("li"))return;turnsIntoOneTransaction({protyle:e,selectsElement:m,type:"BlocksMergeSuperBlock",level:"row"});return}if(matchHotKey(window.siyuan.config.keymap.editor.general.hLayout.custom,n)){n.preventDefault(),n.stopPropagation();const m=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(m.length<2||(f=m[0])!=null&&f.classList.contains("li"))return;turnsIntoOneTransaction({protyle:e,selectsElement:m,type:"BlocksMergeSuperBlock",level:"col"});return}if(!n.repeat&&matchHotKey(window.siyuan.config.keymap.editor.general.duplicate.custom,n)){n.preventDefault(),n.stopPropagation();let m=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));m.length===0&&(m=[d]),duplicateBlock(m,e);return}if(n.key==="Tab"&&isNotCtrl(n)&&!n.altKey){n.preventDefault();const m=window.siyuan.config.editor.codeTabSpaces===0?"	":"".padStart(window.siyuan.config.editor.codeTabSpaces," ");if(d.getAttribute("data-type")==="NodeCodeBlock"&&p!==""){const h=document.createElement("wbr");u.startContainer.nodeType!==3&&u.startContainer.classList.contains("protyle-action")&&u.setStart(d.querySelector(".hljs").firstChild,0),u.insertNode(h),u.setStartAfter(h);const y=d.outerHTML;let k="";n.shiftKey?u.extractContents().textContent.split(`
`).forEach(v=>{v.startsWith(m)?k+=v.replace(m,"")+`
`:k+=v+`
`}):u.extractContents().textContent.split(`
`).forEach(v=>{k+=m+v+`
`});const E=document.createElement("span");let A=d.querySelector(".protyle-action__language").textContent;window.hljs.getLanguage(A)||(A="plaintext"),E.innerHTML=window.hljs.highlight(k.substr(0,k.length-1),{language:A,ignoreIllegals:!0}).value,u.insertNode(E),updateTransaction(e,d.getAttribute("data-node-id"),d.outerHTML,y),h.remove();return}if(!n.shiftKey){const h=document.createElement("wbr");u.insertNode(h);const y=d.outerHTML;return u.extractContents(),u.insertNode(document.createTextNode(m)),u.collapse(!1),focusByRange(u),h.remove(),updateTransaction(e,d.getAttribute("data-node-id"),d.outerHTML,y),!0}}if(n.key==="ContextMenu"){const m=getSelectionPosition(d,u);e.wysiwyg.element.dispatchEvent(new CustomEvent("contextmenu",{detail:{target:d,y:m.top+8,x:m.left}})),n.preventDefault(),n.stopPropagation();return}if(matchHotKey("\u21E7\u2318V",n)){n.returnValue=!1,n.preventDefault(),n.stopPropagation(),pasteAsPlainText(e);return}isNotCtrl(n)&&n.key!=="Backspace"&&n.key!=="Escape"&&n.key!=="Delete"&&!n.shiftKey&&!n.altKey&&n.key!=="Enter"&&hideElements(["select"],e)})},pd=(e,t,n)=>{const s=isMobile(),a=hasClosestByClassName(e.target,"protyle-attr--bookmark");if(a)return!s&&isOnlyMeta(e)||(n?openFileAttr(n,"bookmark",t):openAttr(a.parentElement.parentElement,"bookmark",t)),e.stopPropagation(),!0;const i=hasClosestByClassName(e.target,"protyle-attr--name");if(i)return!s&&isOnlyMeta(e)||(n?openFileAttr(n,"name",t):openAttr(i.parentElement.parentElement,"name",t)),e.stopPropagation(),!0;const l=hasClosestByClassName(e.target,"protyle-attr--av");if(l)return n?openFileAttr(n,"av",t):openAttr(l.parentElement.parentElement,"av",t),e.stopPropagation(),!0;const o=hasClosestByClassName(e.target,"protyle-attr--alias");if(o)return!s&&isOnlyMeta(e)||(n?openFileAttr(n,"alias",t):openAttr(o.parentElement.parentElement,"alias",t)),e.stopPropagation(),!0;const r=hasClosestByClassName(e.target,"protyle-attr--memo");if(r)return!s&&isOnlyMeta(e)||(n?openFileAttr(n,"memo",t):openAttr(r.parentElement.parentElement,"memo",t)),e.stopPropagation(),!0};class md{constructor(t){this.lastHTMLs={},this.element=document.createElement("div"),this.element.className="protyle-wysiwyg",this.element.setAttribute("spellcheck","false"),isMobile()?this.element.setAttribute("contenteditable","false"):this.element.setAttribute("contenteditable","true"),window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.bindCommonEvent(t),!t.options.action.includes(Constants.CB_GET_HISTORY)&&(this.bindEvent(t),keydown(t,this.element),dropEvent(t,this.element))}renderCustom(t){let n=t[Constants.CUSTOM_SY_FULLWIDTH];n||(n=window.siyuan.config.editor.fullWidth?"true":"false"),n==="true"?this.element.parentElement.setAttribute("data-fullwidth","true"):this.element.parentElement.removeAttribute("data-fullwidth");const s=Object.keys(t);for(let a=0;a<this.element.attributes.length;a++){const i=this.element.attributes[a].nodeName;!["type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth"].includes(i)&&!s.includes(i)&&(this.element.removeAttribute(i),a--)}s.forEach(a=>{["title-img","title","updated","icon","id","type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth"].includes(a)||this.element.setAttribute(a,t[a])})}escapeInline(t,n,s){if(!s.data)return;const a=s.data;t.toolbar.range=n;const i=n.startContainer.parentElement,l=t.toolbar.getCurrentType();let o=a.length;if((a==="<"||a===">")&&(o=4),l.length>0&&n.toString()===""&&n.startOffset===a.length&&i.tagName==="SPAN"&&i.textContent.replace(Constants.ZWSP,"")!==a&&i.textContent.replace(Constants.ZWSP,"").length>=a.length&&!hasPreviousSibling(n.startContainer)&&!hasPreviousSibling(i)){const r=i.innerHTML.replace(Constants.ZWSP,"");i.innerHTML=r.substr(o);const c=document.createTextNode(a);i.before(c),n.selectNodeContents(c),n.collapse(!1);return}if(i.tagName==="SPAN"&&i.textContent!==a&&!l.includes("search-mark")&&n.toString()===""&&n.startContainer.nodeType===3&&(l.includes("inline-memo")||l.includes("text")||l.includes("block-ref")||l.includes("file-annotation-ref")||l.includes("a"))&&!hasNextSibling(n.startContainer)&&n.startContainer.textContent.length===n.startOffset&&i.textContent.length>a.length){const r=getSelectionOffset(i,t.wysiwyg.element,n),c=i.innerHTML;if(r.start===i.textContent.length){i.innerHTML=c.substr(0,c.length-o);const f=document.createTextNode(a);i.after(f),n.selectNodeContents(f),n.collapse(!1)}}}setEmptyOutline(t,n){t.wysiwyg.element.querySelectorAll(".img--select, .av__cell--select, .av__cell--active, .av__row--select").forEach(a=>{var i;a.classList.contains("av__row--select")&&!hasClosestByClassName(n,"av")?(a.classList.remove("av__row--select"),a.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),updateHeader(a)):(a.classList.remove("img--select","av__cell--select","av__cell--active"),(i=a.querySelector(".av__drag-fill"))==null||i.remove())});let s=n;if(!n.getAttribute("data-node-id")){const a=hasClosestBlock(n);if(!a)return;s=a}}emojiToMd(t){t.querySelectorAll(".emoji").forEach(n=>{n.outerHTML=`:${n.getAttribute("alt")}:`})}bindCommonEvent(t){this.element.addEventListener("copy",n=>{if(window.siyuan.ctrlIsPressed=!1,n.target.tagName==="PROTYLE-HTML"){n.stopPropagation();return}n.stopPropagation(),n.preventDefault();const s=getEditorRange(t.wysiwyg.element),a=hasClosestBlock(s.startContainer);if(!a)return;const i=a.querySelector(".img--select"),l=a.querySelector(".av__row--select, .av__cell--select");let o=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));o.length===0&&s.toString()===""&&!s.cloneContents().querySelector("img")&&!i&&!l&&(a.classList.add("protyle-wysiwyg--select"),countBlockWord([a.getAttribute("data-node-id")]),o=[a]);let r="",c="";if(o.length>0){const f=o[0].getAttribute("data-reftext")==="true";if(o[0].getAttribute("data-type")==="NodeListItem"&&o[0].parentElement.classList.contains("list")&&o[0].parentElement.childElementCount-1===o.length)if(f){const u=o[0].parentElement.cloneNode(!0),d=getContenteditableElement(u);d&&d.insertAdjacentHTML("beforeend",` <span data-type="block-ref" data-subtype="s" data-id="${u.getAttribute("data-node-id")}">*</span>`),r=u.outerHTML,o[0].removeAttribute("data-reftext")}else r=o[0].parentElement.outerHTML;else o.forEach((u,d)=>{if(f&&d===0){const g=u.cloneNode(!0),p=getContenteditableElement(g);p&&p.insertAdjacentHTML("beforeend",` <span data-type="block-ref" data-subtype="s" data-id="${u.getAttribute("data-node-id")}">*</span>`),r+=removeEmbed(g),o[0].removeAttribute("data-reftext")}else r+=removeEmbed(u)})}else if(l){const f=Array.from(a.querySelectorAll(".av__cell--select"))||[];f.length===0&&a.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(u=>{u.querySelectorAll(".av__cell").forEach(d=>{f.push(d)})}),f.forEach(u=>{const d=getCellText(u);r+=d,c+=d})}else{const f=document.createElement("div"),u=t.toolbar.getCurrentType(s);if((u.length>0||s.startContainer.parentElement.parentElement.getAttribute("data-type")==="NodeHeading")&&(s.startContainer.nodeType===3&&s.startContainer.parentElement.textContent===s.toString()||s.startContainer.nodeType!==3&&s.startContainer.textContent===s.toString()))s.startContainer.parentElement.parentElement.getAttribute("data-type")==="NodeHeading"?f.append(s.startContainer.parentElement.parentElement.cloneNode(!0)):["DIV","TD","TH","TR"].includes(s.startContainer.parentElement.tagName)?(f.append(s.cloneContents()),this.emojiToMd(f)):(f.append(s.startContainer.parentElement.cloneNode(!0)),this.emojiToMd(f)),r=f.innerHTML;else if(i)r=i.outerHTML;else if(u.length>0&&s.startContainer.nodeType===3&&s.startContainer.parentElement.tagName==="SPAN"&&s.startContainer.parentElement.isSameNode(s.endContainer.parentElement)){const d=s.startContainer.parentElement.attributes,g=document.createElement("span");for(let p=0;p<d.length;p++)g.setAttribute(d[p].name,d[p].value);g.getAttribute("data-type").indexOf("block-ref")>-1&&g.getAttribute("data-subtype")==="d"&&g.setAttribute("data-subtype","s"),g.textContent=s.toString(),r=g.outerHTML}else{f.append(s.cloneContents()),this.emojiToMd(f);const d=hasClosestByAttribute(s.commonAncestorContainer,"data-type","inline-math");d?r=d.outerHTML:r=f.innerHTML,(hasClosestByAttribute(s.startContainer,"data-type","NodeCodeBlock")||hasClosestByMatchTag(s.startContainer,"CODE"))&&(c=f.textContent.replace(Constants.ZWSP,""))}}t.disabled&&(r=getEnableHTML(r)),c=c||t.lute.BlockDOM2StdMd(r).trimEnd(),c=c.replace(/\u00A0/g," "),n.clipboardData.setData("text/plain",c),n.clipboardData.setData("text/html",t.lute.BlockDOM2HTML(r)),n.clipboardData.setData("text/siyuan",r)}),this.element.addEventListener("mousedown",n=>{var s;if(n.button===2||window.siyuan.ctrlIsPressed)return;window.siyuan.shiftIsPressed&&getSelection().rangeCount>0&&(this.shiftStartElement=hasClosestBlock(getSelection().getRangeAt(0).startContainer)),window.siyuan.shiftIsPressed||hideElements(["select"],t);const a=n.target;if(hasClosestByClassName(a,"protyle-action")||hasClosestByClassName(a,"av__cell--header")&&!hasClosestByClassName(a,"av__widthdrag"))return;const i=document,l=t.element.getBoundingClientRect(),o=l.left+(parseInt(t.wysiwyg.element.style.paddingLeft)||24)+1,r=o+(t.wysiwyg.element.clientWidth-(parseInt(t.wysiwyg.element.style.paddingLeft)||24)-(parseInt(t.wysiwyg.element.style.paddingRight)||16))-2,c=l.bottom,f=n.clientY;if(!t.disabled&&a.classList.contains("av__widthdrag")){const E=hasClosestBlock(a);if(!E)return;const A=E.getAttribute("data-av-id"),v=a.parentElement,S=v.clientWidth,w=v.getAttribute("data-col-id");let _;const C=E.querySelector(".av__scroll"),x=t.contentElement.getBoundingClientRect();i.onmousemove=T=>{_=Math.max(S+(T.clientX-n.clientX),25)+"px",C.querySelectorAll(".av__row, .av__row--footer").forEach(B=>{B.querySelector(`[data-col-id="${w}"]`).style.width=_}),stickyRow(E,x,"bottom")},i.onmouseup=()=>{i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,!(!_||_===S+"px")&&transaction(t,[{action:"setAttrViewColWidth",id:w,avID:A,data:_}],[{action:"setAttrViewColWidth",id:w,avID:A,data:S+"px"}])},this.preventClick=!0,n.preventDefault();return}const u=hasClosestByClassName(a,"av__drag-fill");if(!t.disabled&&u){const E=hasClosestBlock(u);if(!E)return;const A={};let v;const S=[];E.querySelectorAll(".av__cell--active").forEach(T=>{const B=hasClosestByClassName(T,"av__row");B&&(A[B.dataset.id]||(A[B.dataset.id]=[]),A[B.dataset.id].push(genCellValueByElement(getTypeByCellElement(T),T)),v=T,S.push(T.dataset.id))});const w=getPositionByCellElement(v),_=getPositionByCellElement(E.querySelector(".av__cell--active"));let C,x;return i.onmousemove=T=>{const B=hasClosestByClassName(T.target,"av__cell");if(!(C&&B&&B.isSameNode(C))&&(C=B,C&&C.dataset.id)){const D=getPositionByCellElement(C);if(E.querySelectorAll(".av__cell--active").forEach(H=>{S.includes(H.dataset.id)||H.classList.remove("av__cell--active")}),D.celIndex!==w.celIndex||w.rowIndex>=D.rowIndex){x=void 0;return}E.querySelectorAll(".av__row").forEach((H,O)=>{O>=w.rowIndex&&O<=D.rowIndex&&H.querySelectorAll(".av__cell").forEach(($,U)=>{U>=_.celIndex&&U<=D.celIndex&&($.classList.add("av__cell--active"),x=$)})})}},i.onmouseup=()=>(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,x&&(dragFillCellsValue(t,E,A,S),x.insertAdjacentHTML("beforeend",`<div aria-label="${window.siyuan.languages.dragFill}" class="av__drag-fill ariaLabel"></div>`)),!1),this.preventClick=!0,!1}const d=hasClosestByClassName(a,"av__cell");if(!t.disabled&&d&&d.dataset.id){const E=hasClosestBlock(d);if(!E)return;E.querySelectorAll(".av__cell--select").forEach(w=>{w.classList.remove("av__cell--select")}),E.querySelectorAll(".av__drag-fill").forEach(w=>{w.remove()}),d.classList.add("av__cell--select");const A=getPositionByCellElement(d);let v,S;return i.onmousemove=w=>{const _=hasClosestByClassName(w.target,"av__cell");if(!(v&&_&&_.isSameNode(v))&&_&&_.dataset.id&&(n.clientX!==w.clientX||n.clientY!==w.clientY)){const C=getPositionByCellElement(_);E.querySelectorAll(".av__cell--active").forEach(x=>{x.classList.remove("av__cell--active")}),E.querySelectorAll(".av__row").forEach((x,T)=>{T>=Math.min(A.rowIndex,C.rowIndex)&&T<=Math.max(A.rowIndex,C.rowIndex)&&x.querySelectorAll(".av__cell").forEach((B,D)=>{D>=Math.min(A.celIndex,C.celIndex)&&D<=Math.max(A.celIndex,C.celIndex)&&(B.classList.add("av__cell--active"),S=B)})}),v=_}},i.onmouseup=()=>(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,S&&(selectRow(E.querySelector(".av__firstcol"),"unselectAll"),focusBlock(E),S.insertAdjacentHTML("beforeend",`<div aria-label="${window.siyuan.languages.dragFill}" class="av__drag-fill ariaLabel"></div>`),this.preventClick=!0),!1),!1}if(!t.disabled&&a.classList.contains("protyle-action__drag")){const E=hasClosestBlock(a);if(!E)return;let A=!0;["NodeIFrame","NodeWidget","NodeVideo"].includes(E.getAttribute("data-type"))?(E.classList.add("iframe--drag"),(E.style.textAlign==="left"||E.style.textAlign==="right")&&(A=!1)):a.parentElement.parentElement.getAttribute("data-type")==="img"&&a.parentElement.parentElement.classList.add("img--drag");const v=E.getAttribute("data-node-id"),S=E.outerHTML,w=n.clientX,_=a.previousElementSibling,C=_.clientWidth,x=_.clientHeight;i.onmousemove=T=>{_.tagName==="IMG"&&(_.parentElement.parentElement.style.width=""),T.clientX>w-C+8&&T.clientX<r&&(_.tagName==="IMG"&&_.parentElement.parentElement.style.display!=="block"||!A?_.style.width=Math.max(17,C+(T.clientX-w))+"px":_.style.width=Math.max(17,C+(T.clientX-w)*2)+"px"),_.tagName!=="IMG"?T.clientY>f-x+8&&T.clientY<c&&(_.style.height=x+(T.clientY-f)+"px"):_.parentElement.parentElement.style.width=parseInt(_.style.width)+10+"px"},i.onmouseup=()=>{i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,a.classList.contains("protyle-action__drag")&&E&&updateTransaction(t,v,E.outerHTML,S),E.classList.remove("iframe--drag"),a.parentElement.parentElement.classList.remove("img--drag")};return}let g;if((a.tagName==="TH"||a.tagName==="TD"||((s=a.firstElementChild)==null?void 0:s.tagName)==="TABLE"||a.classList.contains("table__resize")||a.classList.contains("table__select"))&&(g=hasClosestBlock(a),g&&(g.querySelector(".table__select").removeAttribute("style"),window.siyuan.menus.menu.remove(),n.stopPropagation())),!t.disabled&&a.classList.contains("table__resize")){const E=hasClosestBlock(a);if(!E)return;const A=E.outerHTML;getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),E.firstElementChild.style.webkitUserModify="read-only",E.style.cursor="col-resize",a.removeAttribute("style");const v=E.getAttribute("data-node-id"),S=n.clientX,w=parseInt(a.getAttribute("data-col-index")),_=E.querySelectorAll("table col")[w];_.style.minWidth&&(_.style.width=E.querySelectorAll("table td, table th")[w].offsetWidth+"px",_.style.minWidth=""),E.querySelectorAll("tr").forEach(T=>{T.cells[w].style.width=""});const C=_.clientWidth,x=E.firstElementChild.clientWidth<E.firstElementChild.scrollWidth;i.onmousemove=T=>{E.style.textAlign==="center"&&!x?_.style.width=C+(T.clientX-S)*2+"px":_.style.width=C+(T.clientX-S)+"px"},i.onmouseup=()=>{E.firstElementChild.style.webkitUserModify="",E.style.cursor="",i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,E&&updateTransaction(t,v,E.outerHTML,A)};return}if(["IMG","VIDEO","AUDIO"].includes(a.tagName))return;let p=n.clientX;n.clientX>r?p=r:n.clientX<o&&(p=o);const b=l.top+(t.options.render.breadcrumb?t.breadcrumb.element.parentElement.clientHeight:0);let m,h,y,k;i.onmousemove=E=>{const A=E.target;if(!t.disabled&&g&&g.contains(A)&&!hasClosestByClassName(g,"protyle-wysiwyg__embed")){if((A.tagName==="TH"||A.tagName==="TD")&&!A.isSameNode(a)&&(!h||!h.isSameNode(A))){g.firstElementChild.style.webkitUserModify="read-only";let $=a.offsetLeft+a.clientWidth-A.offsetLeft,U=A.offsetLeft;a.offsetLeft===A.offsetLeft?$=Math.max(a.clientWidth,A.clientWidth):a.offsetLeft<A.offsetLeft&&($=A.offsetLeft+A.clientWidth-a.offsetLeft,U=a.offsetLeft);let ee=a.offsetTop+a.clientHeight-A.offsetTop,ie=A.offsetTop;a.offsetTop===A.offsetTop?ee=Math.max(a.clientHeight,A.clientHeight):a.offsetTop<A.offsetTop&&(ee=A.offsetTop+A.clientHeight-a.offsetTop,ie=a.offsetTop),Array.from(g.querySelectorAll("th, td")).find(Y=>{const ne=Y.offsetLeft<U+$&&Y.offsetLeft+Y.clientWidth>U+$,V=Y.offsetLeft<U&&Y.offsetLeft+Y.clientWidth>U;Y.offsetTop<ie&&Y.offsetTop+Y.clientHeight>ie?((Y.offsetLeft+6>U&&Y.offsetLeft+Y.clientWidth-6<U+$||ne||V)&&(ee=ie+ee-Y.offsetTop,ie=Y.offsetTop),ne&&($=Y.offsetLeft+Y.clientWidth-U),V&&($=U+$-Y.offsetLeft,U=Y.offsetLeft)):Y.offsetTop<ie+ee&&Y.offsetTop+Y.clientHeight>ie+ee?((Y.offsetLeft+6>U&&Y.offsetLeft+Y.clientWidth-6<U+$||ne||V)&&(ee=Y.clientHeight+Y.offsetTop-ie),ne&&($=Y.offsetLeft+Y.clientWidth-U),V&&($=U+$-Y.offsetLeft,U=Y.offsetLeft)):V&&Y.offsetTop+6>ie&&Y.offsetTop+Y.clientHeight-6<ie+ee?($=U+$-Y.offsetLeft,U=Y.offsetLeft):ne&&Y.offsetTop+6>ie&&Y.offsetTop+Y.clientHeight-6<ie+ee&&($=Y.offsetLeft+Y.clientWidth-U)}),g.querySelector(".table__select").setAttribute("style",`left:${U-g.firstElementChild.scrollLeft}px;top:${ie}px;height:${ee}px;width:${$+1}px;`),h=A}return}t.selectElement.classList.remove("fn__none"),hideElements(["gutter"],t);let v=0,S=0,w=0,_=0;if(E.clientX<p?(E.clientX<o?S=o:S=E.clientX,w=p-S):E.clientX>r?(S=p,w=r-S):(S=p,w=E.clientX-p),E.clientY>f?E.clientY>c?(v=f,_=c-f):(v=f,_=E.clientY-f):(E.clientY<b?v=b:v=E.clientY,_=f-v),_<4)return;t.selectElement.setAttribute("style",`background-color: ${t.selectElement.style.backgroundColor};top:${v}px;height:${_}px;left:${S+2}px;width:${w-2}px;`);const C=document.elementFromPoint(E.clientX,E.clientY);if(m&&m.isSameNode(C)&&!m.classList.contains("protyle-wysiwyg")&&!m.classList.contains("list")&&!m.classList.contains("bq")&&!m.classList.contains("sb"))return;m=C,hideElements(["select"],t);let x;if(E.clientY>f?(x=y||document.elementFromPoint(S,v),k=void 0):(x=document.elementFromPoint(S,v),y=void 0),!x||((x.classList.contains("protyle-wysiwyg")||x.classList.contains("list")||x.classList.contains("sb")||x.classList.contains("bq"))&&(x=document.elementFromPoint(S,v+16)),!x))return;let T=hasClosestBlock(x);E.clientY>f?y||(y=x):!T&&E.clientY<t.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom&&(T=t.wysiwyg.element.firstElementChild);let B=[],D=T,H=!1;const O=k?k.getBoundingClientRect().bottom:v+_;for(;D;)if(D&&!D.classList.contains("protyle-attr")){const $=D.getBoundingClientRect();if($.height>0&&$.top<O&&$.left<S+w)if(H)if(D.nextElementSibling&&!D.nextElementSibling.classList.contains("protyle-attr")){const U=D.nextElementSibling.getBoundingClientRect();if(U.top<O&&U.left<S+w)B=[D],D=D.nextElementSibling,H=!1;else if(D.parentElement.classList.contains("sb"))D=hasClosestBlock(D.parentElement),H=!0;else break}else D=hasClosestBlock(D.parentElement),H=!0;else B.push(D),D=D.nextElementSibling;else if(D.parentElement.classList.contains("sb"))D=hasClosestBlock(D.parentElement),H=!0;else if($.height===0&&$.width===0&&D.parentElement.getAttribute("fold")==="1")D=D.parentElement,B=[];else break}else D=hasClosestBlock(D.parentElement),H=!0;E.clientY<=f&&!k&&(k=B[B.length-1]),B.length===1&&!B[0].classList.contains("list")&&!B[0].classList.contains("bq")&&!B[0].classList.contains("sb")?t.selectElement.style.backgroundColor="transparent":(B.forEach($=>{hasClosestByClassName($,"protyle-wysiwyg__embed")||$.classList.add("protyle-wysiwyg--select")}),t.selectElement.style.backgroundColor="")},i.onmouseup=E=>{var A;if(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,y=void 0,k=void 0,t.selectElement.classList.add("fn__none"),t.selectElement.removeAttribute("style"),!t.disabled&&g){g.firstElementChild.style.webkitUserModify="";const w=g.querySelector(".table__select");w.getAttribute("style")&&(getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.mergeCell,click:()=>{if(g){const _=[],C=[],x=g.querySelectorAll("th").length;let T=0;const B=g.firstElementChild.scrollLeft;let D=!1,H=!1;g.querySelectorAll("th, td").forEach((V,Ie)=>{V.classList.contains("fn__none")?(V.previousElementSibling&&V.previousElementSibling.isSameNode(_[_.length-1])||Ie<T&&C.includes((Ie+1)%x))&&(_.push(V),!D&&V.parentElement.parentElement.tagName==="THEAD"?D=!0:!H&&V.parentElement.parentElement.tagName==="TBODY"&&(H=!0)):V.offsetLeft+6>w.offsetLeft+B&&V.offsetLeft+V.clientWidth-6<w.offsetLeft+B+w.clientWidth&&V.offsetTop+6>w.offsetTop&&V.offsetTop+V.clientHeight-6<w.offsetTop+w.clientHeight&&(_.push(V),!D&&V.parentElement.parentElement.tagName==="THEAD"?D=!0:!H&&V.parentElement.parentElement.tagName==="TBODY"&&(H=!0),C.push((Ie+1)%x),T=Math.max((V.rowSpan-1)*x+Ie+1,T))}),w.removeAttribute("style");const O=g.outerHTML;let $=_[0],U=$.colSpan,ee=1;for(;$.nextElementSibling&&$.nextElementSibling.isSameNode(_[ee]);)$=$.nextElementSibling,$.classList.contains("fn__none")||(U+=$.colSpan),ee++;let ie="",Y=_[0].parentElement,ne=_[0].rowSpan;if(_.forEach((V,Ie)=>{let He=V.innerHTML.trim();He.endsWith("<br>")&&(He=He.substr(0,He.length-4)),ie+=He+(!He||Ie===_.length-1?"":"<br>"),Ie!==0&&(Y.isSameNode(V.parentElement)||(V.classList.contains("fn__none")||(ne+=V.rowSpan),Y=V.parentElement,_[0].parentElement.parentElement.tagName==="THEAD"&&V.parentElement.parentElement.tagName!=="THEAD"&&_[0].parentElement.parentElement.insertAdjacentElement("beforeend",V.parentElement)),V.classList.add("fn__none"),V.innerHTML="")}),D&&H)for(Y=Y.parentElement.nextElementSibling.firstElementChild;Y&&Y.parentElement.tagName!=="THEAD";){let V=0,Ie=0;if(Array.from(Y.children).forEach(He=>{V+=He.colSpan-1,He.classList.contains("fn__none")&&Ie++}),V!==Ie)_[0].parentElement.parentElement.insertAdjacentElement("beforeend",Y),Y=Y.parentElement.nextElementSibling.firstElementChild;else break}setTimeout(()=>{g&&(_[0].innerHTML=ie+"<wbr>",_[0].colSpan=U,_[0].rowSpan=ne,focusByWbr(_[0],document.createRange()),updateTransaction(t,g.getAttribute("data-node-id"),g.outerHTML,O))})}}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{if(g){const _=[],C=g.firstElementChild.scrollLeft;g.querySelectorAll("th, td").forEach(x=>{!x.classList.contains("fn__none")&&x.offsetLeft+6>w.offsetLeft+C&&x.offsetLeft+x.clientWidth-6<w.offsetLeft+C+w.clientWidth&&x.offsetTop+6>w.offsetTop&&x.offsetTop+x.clientHeight-6<w.offsetTop+w.clientHeight&&(_.length===0||_.length>0&&x.offsetTop===_[0].offsetTop)&&_.push(x)}),w.removeAttribute("style"),setTableAlign(t,_,g,"left",getEditorRange(g))}}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,label:window.siyuan.languages.alignCenter,click:()=>{if(g){const _=[],C=g.firstElementChild.scrollLeft;g.querySelectorAll("th, td").forEach(x=>{!x.classList.contains("fn__none")&&x.offsetLeft+6>w.offsetLeft+C&&x.offsetLeft+x.clientWidth-6<w.offsetLeft+C+w.clientWidth&&x.offsetTop+6>w.offsetTop&&x.offsetTop+x.clientHeight-6<w.offsetTop+w.clientHeight&&(_.length===0||_.length>0&&x.offsetTop===_[0].offsetTop)&&_.push(x)}),w.removeAttribute("style"),setTableAlign(t,_,g,"center",getEditorRange(g))}}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,label:window.siyuan.languages.alignRight,click:()=>{if(g){const _=[],C=g.firstElementChild.scrollLeft;g.querySelectorAll("th, td").forEach(x=>{!x.classList.contains("fn__none")&&x.offsetLeft+6>w.offsetLeft+C&&x.offsetLeft+x.clientWidth-6<w.offsetLeft+C+w.clientWidth&&x.offsetTop+6>w.offsetTop&&x.offsetTop+x.clientHeight-6<w.offsetTop+w.clientHeight&&(_.length===0||_.length>0&&x.offsetTop===_[0].offsetTop)&&_.push(x)}),w.removeAttribute("style"),setTableAlign(t,_,g,"right",getEditorRange(g))}}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.clear,icon:"iconTrashcan",click(){if(g){const _=[],C=g.firstElementChild.scrollLeft;g.querySelectorAll("th, td").forEach(T=>{!T.classList.contains("fn__none")&&T.offsetLeft+6>w.offsetLeft+C&&T.offsetLeft+T.clientWidth-6<w.offsetLeft+C+w.clientWidth&&T.offsetTop+6>w.offsetTop&&T.offsetTop+T.clientHeight-6<w.offsetTop+w.clientHeight&&_.push(T)}),w.removeAttribute("style");const x=g.outerHTML;_.forEach(T=>{T.innerHTML=""}),updateTransaction(t,g.getAttribute("data-node-id"),g.outerHTML,x)}}}).element),window.siyuan.menus.menu.popup({x:E.clientX-8,y:E.clientY-16}))}const v=[],S=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(S.forEach(w=>{v.push(w.getAttribute("data-node-id"))}),countBlockWord(v),getSelection().rangeCount>0){const w=getSelection().getRangeAt(0);if((w.toString()===""||window.siyuan.shiftIsPressed)&&n.detail>2){let x=hasClosestBlock(w.startContainer);if(x){if((A=x.nextElementSibling)!=null&&A.classList.contains("table"))setLastNodeRange(getContenteditableElement(x),w,!1);else if(x.classList.contains("table")){const T=x.querySelectorAll("th, td");x=T[T.length-1],x.contains(w.startContainer)&&setLastNodeRange(x,w,!1)}}return}if(S.length>0){w.collapse(!0);return}const _=hasClosestBlock(w.startContainer);let C;E.detail>2&&w.endContainer.nodeType!==3&&w.endContainer.tagName==="DIV"&&w.endOffset===0?w.endContainer.classList.contains("protyle-attr")&&_&&setLastNodeRange(getContenteditableElement(_),w,!1):C=hasClosestBlock(w.endContainer),_&&C&&!C.isSameNode(_)&&w.collapse(!0)}}})}bindEvent(t){t.observer=new ResizeObserver(()=>{const o=t.contentElement.getBoundingClientRect();t.wysiwyg.element.querySelectorAll(".av").forEach(r=>{r.querySelector(".av__title")&&stickyRow(r,o,"all")})}),this.element.addEventListener("focusout",()=>{if(getSelection().rangeCount===0)return;const o=getSelection().getRangeAt(0);(this.element.isSameNode(o.startContainer)||this.element.contains(o.startContainer))&&(t.toolbar.range=o)}),this.element.addEventListener("cut",o=>{var r,c;if(window.siyuan.ctrlIsPressed=!1,t.disabled)return;if(o.target.tagName==="PROTYLE-HTML"){o.stopPropagation();return}t.options.render.breadcrumb&&t.breadcrumb.hide();const f=getEditorRange(t.wysiwyg.element);let u=hasClosestBlock(f.startContainer);if(!u){o.stopPropagation(),o.preventDefault();return}o.stopPropagation(),o.preventDefault();const d=u.querySelector(".img--select"),g=u.querySelector(".av__row--select, .av__cell--select");let p=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));p.length===0&&f.toString()===""&&!f.cloneContents().querySelector("img")&&!d&&!g&&(u.classList.add("protyle-wysiwyg--select"),p=[u]);let b="";if(p.length>0){p[0].getAttribute("data-type")==="NodeListItem"&&p[0].parentElement.classList.contains("list")&&p[0].parentElement.childElementCount-1===p.length?b=p[0].parentElement.outerHTML:(p.forEach(y=>{const k=getTopAloneElement(y);y.getAttribute("data-type")==="NodeHeading"&&y.getAttribute("fold")==="1"?b+=removeEmbed(k).replace('fold="1"',""):b+=removeEmbed(k)}),p[0].getAttribute("data-type")==="NodeListItem"&&(b=`<div data-subtype="${p[0].getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${b}<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`));const h=getNextBlock(p[p.length-1]);removeBlock(t,u,f),h&&focusBlock(h)}else if(g)b=updateCellsValue(t,u);else{const h=u.getAttribute("data-node-id"),y=u.outerHTML,k=document.createElement("div");let E=f.startContainer;if(E.nodeType===3&&E.textContent===""){const S=hasNextSibling(f.startContainer);S&&(E=S)}const A=hasClosestByAttribute(E,"data-type","NodeHeading");let v=!1;if(A&&f.toString()===A.firstElementChild.textContent){const S=[{action:"delete",id:A.getAttribute("data-node-id")}],w=[{action:"insert",id:A.getAttribute("data-node-id"),data:A.outerHTML,previousID:(r=A.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:((c=A.parentElement)==null?void 0:c.getAttribute("data-node-id"))||t.block.parentID}];if(A.getAttribute("fold")==="1"){v=!0;const _=A.cloneNode(!0);_.removeAttribute("fold"),k.append(_),w[0].data=_.outerHTML,setFold(t,A,void 0,!0)}else{if(A.parentElement.childElementCount===3&&A.parentElement.classList.contains("li")||A.parentElement.childElementCount===2&&(A.parentElement.classList.contains("bq")||A.parentElement.classList.contains("sb"))||A.parentElement.childElementCount===1&&A.parentElement.classList.contains("protyle-wysiwyg")){const _=Lute.NewNodeID(),C=genEmptyElement(!1,!1,_);S.push({id:_,data:C.outerHTML,action:"insert",parentID:A.parentElement.getAttribute("data-node-id")||t.block.parentID}),w.push({id:_,action:"delete"}),A.before(C)}focusSideBlock(A),k.append(A)}transaction(t,S,w)}else if(f.toString()!==""&&E.isSameNode(f.endContainer)&&f.startContainer.nodeType===3&&f.endOffset===f.endContainer.textContent.length&&f.startOffset===0&&!["DIV","TD","TH","TR"].includes(f.startContainer.parentElement.tagName))k.append(f.startContainer.parentElement);else if(d)k.append(d);else if(f.startContainer.nodeType===3&&f.startContainer.parentElement.tagName==="SPAN"&&f.startContainer.parentElement.getAttribute("data-type")&&f.startContainer.parentElement.isSameNode(f.endContainer.parentElement)){const S=f.startContainer.parentElement,w=S.attributes,_=document.createElement("span");for(let C=0;C<w.length;C++)_.setAttribute(w[C].name,w[C].value);S.getAttribute("data-type").indexOf("block-ref")>-1&&S.getAttribute("data-subtype")==="d"&&(_.setAttribute("data-subtype","s"),S.setAttribute("data-subtype","s")),_.textContent=f.toString(),f.deleteContents(),k.append(_)}else if(f.cloneContents().querySelectorAll("td, th").length>0){const S=document.createElement("wbr");f.insertNode(S),f.setStartAfter(S),k.append(f.extractContents()),u.outerHTML=t.lute.SpinBlockDOM(u.outerHTML),u=t.wysiwyg.element.querySelector(`[data-node-id="${h}"]`),focusByWbr(u,f)}else{const S=hasClosestByAttribute(f.commonAncestorContainer,"data-type","inline-math");if(S)k.append(S);else{k.append(f.extractContents());let w;u.classList.contains("av")?updateAVName(t,u):u.classList.contains("table")?w=hasClosestByMatchTag(f.startContainer,"TD")||hasClosestByMatchTag(f.startContainer,"TH"):w=getContenteditableElement(u),w&&Array.from(w.children).forEach(_=>{_.textContent===""&&_.nodeType===1&&!["BR","IMG"].includes(_.tagName)&&_.remove()})}}if(this.emojiToMd(k),b=k.innerHTML,!u.classList.contains("table")){const S=getContenteditableElement(u);S&&S.textContent===""&&(S.innerHTML="")}u.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),u.getAttribute("data-type")==="NodeCodeBlock"&&(f.insertNode(document.createElement("wbr")),getContenteditableElement(u).removeAttribute("data-render"),highlightRender(u)),u.parentElement.parentElement&&!v&&!u.classList.contains("av")&&updateTransaction(t,h,u.outerHTML,y)}t.hint.render(t);let m=t.lute.BlockDOM2StdMd(b).trimEnd();m=m.replace(/\u00A0/g," "),o.clipboardData.setData("text/plain",m),o.clipboardData.setData("text/html",t.lute.BlockDOM2HTML(b)),o.clipboardData.setData("text/siyuan",b)});let n;this.element.addEventListener("contextmenu",o=>{var r,c,f,u;if(o.shiftKey)return;o.stopPropagation(),o.preventDefault();const d=o.clientX||o.detail.x,g=o.clientY||o.detail.y,p=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(p.length>1){hideElements(["util"],t),t.gutter.renderMenu(t,p[0]),window.siyuan.menus.menu.popup({x:d,y:g});return}const b=o.detail.target||o.target,m=hasClosestByAttribute(b,"data-type","NodeBlockQueryEmbed");if(m)return getSelection().rangeCount===0&&focusSideBlock(m),t.gutter.renderMenu(t,m),window.siyuan.menus.menu.fullscreen(),!1;const h=hasClosestByClassName(b,"av__row");if(h&&avContextmenu(t,h,{x:o.clientX,y:h.getBoundingClientRect().bottom,h:h.clientHeight})){o.stopPropagation(),o.preventDefault();return}if(t.toolbar.range=getEditorRange(t.element),b.tagName==="SPAN"){let A=t.toolbar.getCurrentType(t.toolbar.range);if(A.length===0&&(A=(b.dataset.type||"").split(" ")),A.length>0&&removeSearchMark(b),A.includes("block-ref"))return refMenu(t,b),b.setAttribute("prevent-popover","true"),setTimeout(()=>{b.removeAttribute("prevent-popover")},620),!1;if(A.includes("file-annotation-ref")&&!t.disabled)return fileAnnotationRefMenu(t,b),!1;if(A.includes("tag")&&!t.disabled)return tagMenu(t,b),!1;if(A.includes("inline-memo"))return t.toolbar.showRender(t,b),!1;if(A.includes("a")&&!t.disabled)return linkMenu(t,b),window.siyuan.config.editor.floatWindowMode===0&&((r=b.getAttribute("data-href"))!=null&&r.startsWith("siyuan://blocks"))&&(b.setAttribute("prevent-popover","true"),setTimeout(()=>{b.removeAttribute("prevent-popover")},620)),!1}if(b.tagName==="IMG"&&hasClosestByClassName(b,"img"))return imgMenu(t,t.toolbar.range,b.parentElement.parentElement,{clientX:d+4,clientY:g}),!1;const y=hasClosestBlock(b);if(!y)return!1;const k=hasClosestByClassName(b,"av__cell--header");if(k){showColMenu(t,y,k),o.stopPropagation(),o.preventDefault();return}const E=hasClosestByClassName(b,"item");if(y.classList.contains("av")&&E){E.classList.contains("item--focus")?openViewMenu({protyle:t,blockElement:y,element:E}):(y.removeAttribute("data-render"),avRender(y,t,()=>{openViewMenu({protyle:t,blockElement:y,element:y.querySelector(".item.item--focus")})},E.dataset.id)),o.stopPropagation(),o.preventDefault();return}!isNotEditBlock(y)&&!y.classList.contains("protyle-wysiwyg--select")&&!hasClosestByClassName(b,"protyle-action")&&(isMobile()||o.detail.target||n&&y.contains(n.startContainer))?(!isMobile()||(c=t.toolbar)!=null&&c.element.classList.contains("fn__none"))&&!y.classList.contains("av")&&(contentMenu(t,y),window.siyuan.menus.menu.popup({x:d,y:g+13,h:26}),(f=t.toolbar)==null||f.element.classList.add("fn__none"),y.classList.contains("table")&&y.querySelector(".table__select").removeAttribute("style")):t.toolbar.range.toString()===""&&(hideElements(["util"],t),t.gutter&&t.gutter.renderMenu(t,y),window.siyuan.menus.menu.fullscreen(),(u=t.toolbar)==null||u.element.classList.add("fn__none"))}),this.element.addEventListener("pointerdown",()=>{getSelection().rangeCount>0?n=getSelection().getRangeAt(0):n=void 0});let s=!1;this.element.addEventListener("mousewheel",o=>{if(!s&&o.deltaY<0&&!t.scroll.element.classList.contains("fn__none")&&t.contentElement.clientHeight===t.contentElement.scrollHeight&&t.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(fetchPost("/api/filetree/getDoc",{id:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},c=>{s=!1,onGet({data:c,protyle:t,action:[Constants.CB_GET_BEFORE,Constants.CB_GET_UNCHANGEID]})}),s=!0),o.deltaX===0)return;const r=hasClosestByClassName(o.target,"table");if(r){const c=r.querySelector(".table__select");c!=null&&c.style.width&&(c.removeAttribute("style"),window.siyuan.menus.menu.remove())}},{passive:!0});let a=!1;this.element.addEventListener("mouseover",o=>{const r=hasClosestByClassName(o.target,"protyle-attr");if(r){a=!0,r.parentElement.classList.add("protyle-wysiwyg--hl");return}else if(a){const f=t.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");f&&f.classList.remove("protyle-wysiwyg--hl"),a=!1}if(hasClosestByClassName(o.target,"protyle-action")||!t.options.render.gutter)return;const c=hasClosestBlock(o.target);if(!(c&&(c.classList.contains("list")||c.classList.contains("li")))&&c){const f=hasClosestByAttribute(c,"data-type","NodeBlockQueryEmbed");f?t.gutter.render(t,f,this.element):t.gutter.render(t,c,this.element,o.target)}}),this.element.addEventListener("paste",o=>{if(t.disabled){o.stopPropagation(),o.preventDefault();return}if(window.siyuan.ctrlIsPressed=!1,o.target.tagName==="PROTYLE-HTML"){o.stopPropagation();return}if(!hasClosestByAttribute(o.target,"contenteditable","true")){o.stopPropagation(),o.preventDefault();return}const r=hasClosestBlock(o.target);if(r&&!getContenteditableElement(r)){o.stopPropagation(),o.preventDefault();return}paste(t,o)});let i=!1;this.element.addEventListener("compositionstart",o=>{const r=getEditorRange(t.wysiwyg.element),c=hasClosestBlock(r.startContainer);c&&typeof t.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=="undefined"&&(r.insertNode(document.createElement("wbr")),t.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=c.outerHTML,c.querySelector("wbr").remove()),i=!0,o.stopPropagation()}),this.element.addEventListener("compositionend",o=>{o.stopPropagation(),i=!1;const r=getEditorRange(this.element),c=hasClosestBlock(r.startContainer);if(!(c&&c.getAttribute("data-type")==="NodeHTMLBlock")&&c)if(o.data!=="")this.escapeInline(t,r,o),input(t,c,r,!0);else{const f=c.getAttribute("data-node-id");t.wysiwyg.lastHTMLs[f]&&updateTransaction(t,f,c.outerHTML,t.wysiwyg.lastHTMLs[f])}});let l;this.element.addEventListener("input",o=>{const r=o.target;if(r.tagName==="VIDEO"||r.tagName==="AUDIO"||o.inputType==="historyRedo")return;if(o.inputType==="historyUndo"){window.siyuan.menus.menu.remove();return}const c=getEditorRange(this.element),f=hasClosestBlock(c.startContainer);if(f){if(f&&f.getAttribute("data-type")==="NodeHTMLBlock"){o.stopPropagation();return}[":","(","\u3010","\uFF08","[","{","\u300C","\u300E","#","/","\u3001"].includes(o.data)&&(t.hint.enableExtend=!0),!(o.isComposing||i||o.inputType==="deleteByDrag"||o.inputType==="insertFromDrop")&&(this.escapeInline(t,c,o),/^\d{1}$/.test(o.data)||o.data==="\u2018"||o.data==="\u201C"||o.data==="\u201D"||o.data==="\u300C"?(clearTimeout(l),l=window.setTimeout(()=>{input(t,f,c,!0)})):input(t,f,c,!0),o.stopPropagation())}}),this.element.addEventListener("keyup",o=>{const r=getEditorRange(this.element).cloneRange(),c=hasClosestBlock(r.startContainer);if(o.key!=="PageUp"&&o.key!=="PageDown"&&o.key!=="Home"&&o.key!=="End"&&o.key.indexOf("Arrow")===-1&&o.key!=="Alt"&&o.key!=="Shift"&&o.key!=="CapsLock"&&o.key!=="Escape"&&o.key!=="Meta"&&!/^F\d{1,2}$/.test(o.key)&&(!o.isComposing||o.isComposing&&r.toString()!=="")){r.toString()===""&&c&&typeof t.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=="undefined"&&(r.insertNode(document.createElement("wbr")),t.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=c.outerHTML,c.querySelector("wbr").remove());return}if(!this.preventKeyup&&((o.shiftKey||isOnlyMeta(o))&&!o.isComposing&&r.toString()!==""&&(t.toolbar.render(t,r,o),countSelectWord(r)),o.eventPhase!==3&&!o.shiftKey&&(o.key.indexOf("Arrow")>-1||o.key==="Home"||o.key==="End"||o.key==="PageUp"||o.key==="PageDown")&&!o.isComposing&&(c&&(this.setEmptyOutline(t,c),r.toString()===""&&countSelectWord(r,t.block.rootID)),o.stopPropagation()),(o.key==="ArrowLeft"||o.key==="ArrowRight"||o.key==="Alt"||o.key==="Shift")&&c&&!c.classList.contains("protyle-wysiwyg--select"))){const f=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let u=!1;f.find(d=>{if(d.contains(r.startContainer))return u=!0,!0}),!u&&f.length>0&&(f.forEach(d=>{d.classList.remove("protyle-wysiwyg--select")}),c.classList.add("protyle-wysiwyg--select"))}}),this.element.addEventListener("dblclick",o=>{if(o.target.tagName==="IMG"&&!o.target.classList.contains("emoji")){previewDocImage(o.target.src,t.block.rootID);return}}),this.element.addEventListener("click",o=>{if(this.preventClick){this.preventClick=!1;return}t.app.plugins.forEach(_=>{_.eventBus.emit("click-editorcontent",{protyle:t,event:o})}),hideElements(["hint","util"],t);const r=isOnlyMeta(o);o.shiftKey||(this.shiftStartElement=void 0),this.setEmptyOutline(t,o.target);const c=hasClosestByClassName(o.target,"table");this.element.querySelectorAll(".table").forEach(_=>{(!c||!_.isSameNode(c))&&_.querySelector(".table__select").removeAttribute("style"),c&&c.isSameNode(_)&&_.querySelector(".table__select").getAttribute("style")&&o.stopPropagation()}),t.options.render.breadcrumb&&t.breadcrumb.render(t);const f=getEditorRange(this.element),u=hasClosestByAttribute(o.target,"data-type","block-ref"),d=hasClosestByAttribute(o.target,"data-type","a")||hasClosestByAttribute(o.target,"data-type","url");let g="";if(d&&(d.classList.contains("av__celltext")?g=d.textContent.trim():g=d.getAttribute("data-href")),u||g.startsWith("siyuan://blocks/")){if(o.stopPropagation(),o.preventDefault(),hideElements(["dialog","toolbar"],t),f.toString()!==""&&!o.shiftKey)return;let _;u?_=u.getAttribute("data-id"):d&&(_=g.substring(16,38)),checkFold(_,(C,x)=>{openMobileFileById(t.app,_,C?[Constants.CB_GET_ALL,Constants.CB_GET_HL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL]),activeBlur(),hideKeyboardToolbar()});return}const p=hasClosestByAttribute(o.target,"data-type","file-annotation-ref");if(p&&f.toString()===""){o.stopPropagation(),o.preventDefault();const C=`assets/${p.getAttribute("data-id").split("/")[1]}`;openByMobile(C);return}if(d&&!o.altKey){o.stopPropagation(),o.preventDefault();let _=Lute.UnEscapeHTMLStr(g);openByMobile(_);return}const b=hasClosestByAttribute(o.target,"data-type","tag");if(b&&!o.altKey){const _=window.siyuan.storage[Constants.LOCAL_SEARCHDATA];popSearch(t.app,{removed:_.removed,sort:_.sort,group:_.group,hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${b.textContent}#`,r:"",page:1,types:Object.assign({},_.types),replaceTypes:Object.assign({},_.replaceTypes)});return}const m=hasClosestByClassName(o.target,"protyle-wysiwyg__embed");if(m){const _=m.getAttribute("data-id");checkFold(_,(C,x)=>{openMobileFileById(t.app,_,C?[Constants.CB_GET_ALL,Constants.CB_GET_HL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL]),activeBlur(),hideKeyboardToolbar()}),o.stopPropagation();return}if(commonClick(o,t)||hasTopClosestByClassName(o.target,"protyle-action__copy"))return;const h=hasClosestByClassName(o.target,"protyle-action__edit");if(h&&!t.disabled){t.toolbar.showRender(t,h.parentElement.parentElement),o.stopPropagation(),o.preventDefault();return}const y=hasClosestByClassName(o.target,"protyle-action__menu");if(y){t.gutter.renderMenu(t,y.parentElement.parentElement),window.siyuan.menus.menu.fullscreen(),o.stopPropagation(),o.preventDefault();return}const k=hasClosestByClassName(o.target,"protyle-action__reload");if(k){const _=hasClosestByAttribute(k,"data-type","NodeBlockQueryEmbed");_&&(_.removeAttribute("data-render"),blockRender(t,_)),o.stopPropagation(),o.preventDefault();return}const E=hasClosestByClassName(o.target,"protyle-action__language");if(E&&!t.disabled){t.toolbar.showCodeLanguage(t,E),o.stopPropagation(),o.preventDefault();return}const A=hasClosestByAttribute(o.target,"data-subtype","math");if(!o.shiftKey&&!r&&A&&!t.disabled){t.toolbar.showRender(t,A),o.stopPropagation();return}const v=hasClosestByClassName(o.target,"protyle-action");if(v){if(v.parentElement.parentElement.getAttribute("data-type")==="img"&&!t.disabled)imgMenu(t,f,v.parentElement.parentElement,{clientX:o.clientX+4,clientY:o.clientY});else if(v.parentElement.classList.contains("li")){const C=v.parentElement.getAttribute("data-node-id");if(o.altKey&&!t.disabled){if(v.parentElement.parentElement.classList.contains("protyle-wysiwyg"))setFold(t,v.parentElement);else{let x=!0;const T=v.parentElement.parentElement.outerHTML;Array.from(v.parentElement.parentElement.children).find(B=>{if(B.classList.contains("li")&&B.getAttribute("fold")!=="1"&&B.childElementCount>3)return x=!1,!0}),Array.from(v.parentElement.parentElement.children).find(B=>{B.classList.contains("li")&&(x?B.removeAttribute("fold"):B.childElementCount>3&&B.setAttribute("fold","1"))}),updateTransaction(t,v.parentElement.parentElement.getAttribute("data-node-id"),v.parentElement.parentElement.outerHTML,T)}hideElements(["gutter"],t)}else if(o.shiftKey&&!t.disabled)openAttr(v.parentElement,"bookmark",t);else if(r)zoomOut({protyle:t,id:C});else if(v.classList.contains("protyle-action--task")){if(!t.disabled){const x=v.parentElement.outerHTML;v.parentElement.classList.contains("protyle-task--done")?(v.querySelector("use").setAttribute("xlink:href","#iconUncheck"),v.parentElement.classList.remove("protyle-task--done")):(v.querySelector("use").setAttribute("xlink:href","#iconCheck"),v.parentElement.classList.add("protyle-task--done")),v.parentElement.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,C,v.parentElement.outerHTML,x)}}else t.block.showAll&&t.block.id===C?enterBack(t,C):zoomOut({protyle:t,id:C})}o.stopPropagation();return}const S=hasClosestByClassName(o.target,"hr")||hasClosestByClassName(o.target,"iframe");if(!o.shiftKey&&!r&&S){S.classList.add("protyle-wysiwyg--select"),o.stopPropagation();return}const w=hasTopClosestByClassName(o.target,"img");if(!o.shiftKey&&!r&&w){w.classList.add("img--select"),f.setStartAfter(w),f.collapse(!0),focusByRange(f),t.options.render.breadcrumb&&t.breadcrumb.render(t);return}if(!avClick(t,o)){if(o.target.contains(this.element)&&this.element.lastElementChild&&!t.disabled){const _=this.element.lastElementChild.getBoundingClientRect();if(o.y>_.bottom){const C=getContenteditableElement(getLastBlock(this.element.lastElementChild));if(!C||this.element.lastElementChild.getAttribute("data-type")!=="NodeParagraph"&&t.wysiwyg.element.getAttribute("data-doc-type")!=="NodeListItem"||this.element.lastElementChild.getAttribute("data-type")==="NodeParagraph"&&getContenteditableElement(C).innerHTML!==""){const x=genEmptyElement(!1,!1);this.element.insertAdjacentElement("beforeend",x),transaction(t,[{action:"insert",data:x.outerHTML,id:x.getAttribute("data-node-id"),previousID:x.previousElementSibling.getAttribute("data-node-id"),parentID:t.block.parentID}],[{action:"delete",id:x.getAttribute("data-node-id")}]);const T=getContenteditableElement(x);f.selectNodeContents(T),f.collapse(!0),focusByRange(f),t.options.render.breadcrumb&&setTimeout(()=>{t.breadcrumb.render(t)},Constants.TIMEOUT_TRANSITION)}else C&&(f.selectNodeContents(C),f.collapse(!1),focusByRange(f))}}if(setTimeout(()=>{const _=getEditorRange(this.element);t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")||countSelectWord(_,t.block.rootID),getSelection().rangeCount===0&&focusByRange(_)},isMobile()||isInIOS()?520:0),t.hint.enableExtend=!1,o.shiftKey){o.preventDefault(),o.stopPropagation();let _=this.shiftStartElement,C=hasClosestBlock(o.target);if(this.shiftStartElement&&C&&!this.shiftStartElement.isSameNode(C)){let x=!0;f.collapse(!0);const T=_.getBoundingClientRect(),B=C.getBoundingClientRect();let D=T.top,H=B.top;if(D===H&&(D=T.left,H=B.left),D>H){const ee=C;C=_,_=ee;const ie=H;H=D,D=ie,x=!1}let O=[],$=_,U=!1;for(;$;)if($&&!$.classList.contains("protyle-attr")){const ee=$.getBoundingClientRect();if(T.top===B.top?ee.left<=H:ee.top<=H)if(U)if($.nextElementSibling&&!$.nextElementSibling.classList.contains("protyle-attr")){const ie=$.nextElementSibling.getBoundingClientRect();if(T.top===B.top?ie.left<=H&&ie.bottom<=B.bottom:ie.top<=H)O=[$],$=$.nextElementSibling,U=!1;else if($.parentElement.classList.contains("sb"))$=hasClosestBlock($.parentElement),U=!0;else break}else $=hasClosestBlock($.parentElement),U=!0;else O.push($),$=$.nextElementSibling;else if($.parentElement.classList.contains("sb"))$=hasClosestBlock($.parentElement),U=!0;else break}else $=hasClosestBlock($.parentElement),U=!0;if(O.length===1&&!O[0].classList.contains("list")&&!O[0].classList.contains("bq")&&!O[0].classList.contains("sb"))this.shiftStartElement=void 0;else{const ee=[];!t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&t.scroll&&!t.scroll.element.classList.contains("fn__none")&&!t.scroll.keepLazyLoad&&(_.getBoundingClientRect().top<-t.contentElement.clientHeight*2||C.getBoundingClientRect().bottom>t.contentElement.clientHeight*2)&&showMessage(window.siyuan.languages.crossKeepLazyLoad),O.forEach(ie=>{ie.classList.add("protyle-wysiwyg--select"),ee.push(ie.getAttribute("data-node-id")),ie.querySelectorAll(".protyle-wysiwyg--select").forEach(Y=>{Y.classList.remove("protyle-wysiwyg--select")})}),countBlockWord(ee),x?focusBlock(O[O.length-1],t.wysiwyg.element,!1):focusBlock(O[0],t.wysiwyg.element,!1)}}}if(this.element.querySelector(".protyle-wysiwyg--select")&&f.toString()!==""&&(f.collapse(!1),focusByRange(f)),r&&f.toString()===""){let _=hasClosestBlock(o.target);if(_){_=getTopAloneElement(_),_.classList.contains("protyle-wysiwyg--select")?(_.classList.remove("protyle-wysiwyg--select"),_.removeAttribute("select-start"),_.removeAttribute("select-end")):_.classList.add("protyle-wysiwyg--select"),_.querySelectorAll(".protyle-wysiwyg--select").forEach(T=>{T.classList.remove("protyle-wysiwyg--select"),T.removeAttribute("select-start"),T.removeAttribute("select-end")});const C=hasClosestByClassName(_.parentElement,"protyle-wysiwyg--select");C&&(C.classList.remove("protyle-wysiwyg--select"),C.removeAttribute("select-start"),C.removeAttribute("select-end"));const x=[];t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(T=>{x.push(T.getAttribute("data-node-id"))}),countBlockWord(x)}}}})}}var mi=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});class bd extends null{constructor(t,n){super(t,n),this.element.addEventListener("click",s=>mi(this,null,function*(){t.toolbar.element.classList.add("fn__none"),s.stopPropagation();const a=t.toolbar.range;if(!hasClosestBlock(a.startContainer))return;const l=hasClosestByAttribute(a.startContainer,"data-type","a");if(l){linkMenu(t,l);return}const o=a.toString().trim().replace(Constants.ZWSP,"");let r="",c="";try{const f=yield readText();if(t.lute.IsValidLinkDest(o))r=o;else if(t.lute.IsValidLinkDest(f))r=f;else{const u=f.lastIndexOf(" ");u>-1&&t.lute.IsValidLinkDest(f.substring(u))&&(r=f.substring(u),c=f.substring(0,u))}}catch(f){console.log(f)}t.toolbar.setInlineMark(t,"a","range",{type:"a",color:r+(c?Constants.ZWSP+c:"")})}))}}class hd extends null{constructor(t,n){super(t,n),this.element.addEventListener("click",s=>{t.toolbar.range.toString()!==""&&(fixTableRange(t.toolbar.range),hintRef(t.toolbar.range.toString(),t,"search"),t.toolbar.element.classList.add("fn__none"),s.stopPropagation())})}}var bi=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});class yd extends null{constructor(t,n){super(t,n),this.element.addEventListener("click",s=>bi(this,null,function*(){t.toolbar.element.classList.add("fn__none"),s.stopPropagation();const a=t.toolbar.range;if(!hasClosestBlock(a.startContainer))return;let l=hasClosestByAttribute(a.startContainer,"data-type","inline-math");if(!l&&a.startContainer.nodeType!==3&&a.startContainer.childNodes[a.startOffset]){const o=hasPreviousSibling(a.startContainer.childNodes[a.startOffset]);o&&o.getAttribute("data-type").indexOf("inline-math")>-1&&(l=o)}if(!l&&a.startOffset===a.startContainer.textContent.length&&a.startContainer.nodeType===3){let o=!0,r=!1;if(a.cloneContents().childNodes.forEach(c=>{c.nodeType!==3&&(c.getAttribute("data-type")||"").indexOf("inline-math")>-1||c.nodeType==3&&c.textContent===""?r=!0:o=!1}),o&&r){const c=hasNextSibling(a.startContainer);if(c&&c.nodeType!==3&&c.getAttribute("data-type").indexOf("inline-math")>-1)l=c;else{const f=hasPreviousSibling(a.startContainer);a.startOffset===0&&f&&f.nodeType!==3&&f.getAttribute("data-type").indexOf("inline-math")>-1&&(l=f)}}}if(l){t.toolbar.showRender(t,l);return}t.toolbar.setInlineMark(t,"inline-math","range",{type:"inline-math"})}))}}var hi=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});class wd extends null{constructor(t,n){super(t,n),this.element.addEventListener("click",s=>hi(this,null,function*(){t.toolbar.element.classList.add("fn__none"),s.stopPropagation();const a=t.toolbar.range;if(!hasClosestBlock(a.startContainer))return;const l=hasClosestByAttribute(a.startContainer,"data-type","inline-memo");if(l&&l.textContent===a.toString()){t.toolbar.showRender(t,l);return}a.toString()!==""&&t.toolbar.setInlineMark(t,"inline-memo","range",{type:"inline-memo"})}))}}var yi=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});class _d{constructor(t){const n=t.options,s=document.createElement("div");s.className="protyle-toolbar fn__none",this.element=s,this.subElement=document.createElement("div"),this.subElement.className="protyle-util fn__none protyle-util--mobile",this.toolbarHeight=29,n.toolbar.forEach(a=>{const i=this.genItem(t,a);this.element.appendChild(i)})}render(t,n,s){this.range=n;let a=hasClosestBlock(n.startContainer);if(isMobile()||!a||t.disabled||a.classList.contains("av")){this.element.classList.add("fn__none");return}let i=!0,l=!0;if(Array.from(n.cloneContents().childNodes).find(d=>{if(d.nodeType!==1){if(d.textContent.length>0)return l=!1,!0}else if(!d.classList.contains("img"))return i=!1,!0}),i&&l||n.commonAncestorContainer.nodeType!==3&&n.commonAncestorContainer.classList.contains("img")){this.element.classList.add("fn__none");return}const o=hasClosestBlock(n.startContainer),r=hasClosestBlock(n.endContainer);if(o&&r&&!o.isSameNode(r)){if(s)if(s.key==="ArrowLeft")this.range=setLastNodeRange(getContenteditableElement(o),n,!1);else if(s.key==="ArrowRight")this.range=setFirstNodeRange(getContenteditableElement(r),n),this.range.collapse(!1);else if(s.key==="ArrowUp"){if(this.range=setFirstNodeRange(getContenteditableElement(r),n),a=hasClosestBlock(r),!a)return}else s.key==="ArrowDown"&&(this.range=setLastNodeRange(getContenteditableElement(o),n,!1));else this.range=setLastNodeRange(getContenteditableElement(a),n,!1);if(focusByRange(this.range),this.range.toString()===""){this.element.classList.add("fn__none");return}}if(a.getAttribute("data-type")==="NodeCodeBlock"){this.element.classList.add("fn__none");return}const c=getSelectionPosition(a,n);this.element.classList.remove("fn__none"),this.toolbarHeight=this.element.clientHeight;const f=c.top-this.toolbarHeight-4;this.element.setAttribute("data-inity",f+Constants.ZWSP+t.contentElement.scrollTop.toString()),setPosition(this.element,c.left-52,f),this.element.querySelectorAll(".protyle-toolbar__item--current").forEach(d=>{d.classList.remove("protyle-toolbar__item--current")}),this.getCurrentType().forEach(d=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(d))return;const g=this.element.querySelector(`[data-type="${d}"]`);g&&g.classList.add("protyle-toolbar__item--current")})}getCurrentType(t=this.range){var n,s;let a=[],i=t.startContainer;if(i.nodeType===3?i=i.parentElement:i.childElementCount>0&&((n=i.childNodes[t.startOffset])==null?void 0:n.nodeType)!==3&&(i=i.childNodes[t.startOffset]),!i||i.nodeType===3)return[];["DIV","TD","TH","TR"].includes(i.tagName)||(a=(i.getAttribute("data-type")||"").split(" "));let l=t.endContainer;return l.nodeType===3?l=l.parentElement:l.childElementCount>0&&((s=l.childNodes[t.endOffset])==null?void 0:s.nodeType)!==3&&(l=l.childNodes[t.endOffset]),!l||l.nodeType===3?[]:(!["DIV","TD","TH","TR"].includes(l.tagName)&&!i.isSameNode(l)&&(a=a.concat((l.getAttribute("data-type")||"").split(" "))),t.cloneContents().childNodes.forEach(o=>{o.nodeType!==3&&(a=a.concat((o.getAttribute("data-type")||"").split(" ")))}),a=[...new Set(a)],a.find((o,r)=>{if(o==="")return a.splice(r,1),!0}),a)}genItem(t,n){let s;switch(n.name){case"strong":case"em":case"s":case"code":case"mark":case"tag":case"u":case"sup":case"clear":case"sub":case"kbd":s=new ToolbarItem(t,n);break;case"block-ref":s=new BlockRef(t,n);break;case"inline-math":s=new InlineMath(t,n);break;case"inline-memo":s=new InlineMemo(t,n);break;case"|":s=new Divider;break;case"text":s=new Font(t,n);break;case"a":s=new Link(t,n);break;default:s=new ToolbarItem(t,n);break}if(s)return s.element}mergeNode(t){for(let n=0;n<t.length;n++)t[n].nodeType!==3&&t[n].tagName==="WBR"&&(t[n].remove(),n--);for(let n=0;n<t.length;n++)t[n].nodeType===3&&(t[n].textContent===""?(t[n].remove(),n--):t[n+1]&&t[n+1].nodeType===3&&(t[n].textContent=t[n].textContent+t[n+1].textContent,t[n+1].remove(),n--))}setInlineMark(t,n,s,a){var i;const l=hasClosestBlock(this.range.startContainer);if(!l)return;const o=hasClosestBlock(this.range.endContainer);if(!o)return;l.isSameNode(o)||(this.range=setLastNodeRange(getContenteditableElement(l),this.range,!1));const r=this.getCurrentType(this.range),c=this.range.toString();fixTableRange(this.range);let f,u,d,g;const p=hasPreviousSibling(this.range.startContainer);["DIV","TD","TH","TR"].includes(this.range.startContainer.parentElement.tagName)?p&&p.nodeType!==3&&this.range.startOffset===0&&(f=p):this.range.startOffset===0&&!p?(f=this.range.startContainer.parentElement.previousSibling,this.range.setStartBefore(this.range.startContainer.parentElement)):f=this.range.startContainer.parentElement;let b=!1;const m=hasNextSibling(this.range.endContainer);["DIV","TD","TH","TR"].includes(this.range.endContainer.parentElement.tagName)?m&&m.nodeType!==3&&this.range.endOffset===this.range.endContainer.textContent.length&&(u=m):this.range.endOffset===this.range.endContainer.textContent.length&&!m?(u=this.range.endContainer.parentElement.nextSibling,this.range.setEndAfter(this.range.endContainer.parentElement),c===""&&(b=!0,this.range.collapse(!1))):u=this.range.endContainer.parentElement,this.range.insertNode(document.createElement("wbr"));const h=l.outerHTML,y=this.range.extractContents();if(this.mergeNode(y.childNodes),f&&u&&f.isSameNode(u)&&((i=y.firstChild)==null?void 0:i.nodeType)===3){const w=f.attributes;y.childNodes.forEach(_=>{const C=document.createElement("span");for(let x=0;x<w.length;x++)C.setAttribute(w[x].name,w[x].value);C.innerHTML=_.textContent,_.replaceWith(C)})}const k=isMobile()?document.querySelector("#keyboardToolbar .keyboard__dynamic").nextElementSibling:this.element,E=s==="toolbar"?k.querySelector(`[data-type="${n}"]`):void 0,A=[];if(n==="clear"||E!=null&&E.classList.contains("protyle-toolbar__item--current")||s==="range"&&r.length>0&&r.includes(n)&&!a){if(n==="clear"?k.querySelectorAll('[data-type="em"],[data-type="u"],[data-type="s"],[data-type="mark"],[data-type="sup"],[data-type="sub"],[data-type="strong"]').forEach(w=>{w.classList.remove("protyle-toolbar__item--current")}):E&&E.classList.remove("protyle-toolbar__item--current"),y.childNodes.length===0)if(r.find((w,_)=>{if(n===w)return r.splice(_,1),!0}),r.length===0||n==="clear")A.push(document.createTextNode(Constants.ZWSP));else{let w=0;for(;w<r.length;)["inline-memo","text","block-ref","file-annotation-ref","a"].includes(r[w])?r.splice(w,1):++w;const _=document.createElement("span");_.setAttribute("data-type",r.join(" ")),_.textContent=Constants.ZWSP,A.push(_)}y.childNodes.forEach((w,_)=>{if(w.nodeType!==3&&w.tagName!=="BR"&&w.tagName!=="IMG"){const C=(w.getAttribute("data-type")||"").split(" ");if(n==="clear")for(let x=0;x<C.length;x++)a&&a.type==="text"?C[x]==="text"&&(C.splice(x,1),x--):["kbd","text","strong","em","u","s","mark","sup","sub","code"].includes(C[x])&&(C.splice(x,1),x--);else C.find((x,T)=>{if(n===x)return C.splice(T,1),!0});if(C.length===0)w.textContent===""&&(w.textContent=Constants.ZWSP),A.push(document.createTextNode(w.textContent));else{if(c&&n==="clear"&&a&&a.type==="text"&&w.style.color===""&&w.style.webkitTextFillColor===""&&w.style.webkitTextStroke===""&&w.style.textShadow===""&&w.style.backgroundColor===""&&w.style.fontSize==="")return w.setAttribute("data-type",C.join(" ")),A.push(w),!0;n==="clear"&&(w.style.color="",w.style.webkitTextFillColor="",w.style.webkitTextStroke="",w.style.textShadow="",w.style.backgroundColor="",w.style.fontSize=""),_===0&&f&&f.nodeType!==3&&isArrayEqual(C,(f.getAttribute("data-type")||"").split(" "))&&hasSameTextStyle(w,f,a)?(d=f.textContent.length,f.innerHTML=f.innerHTML+w.innerHTML):_===y.childNodes.length-1&&u&&u.nodeType!==3&&isArrayEqual(C,(u.getAttribute("data-type")||"").split(" "))&&hasSameTextStyle(w,u,a)?(g=w.textContent.length,u.innerHTML=w.innerHTML+u.innerHTML):(w.setAttribute("data-type",C.join(" ")),A.push(w))}}else A.push(w)})}else if(!this.element.classList.contains("fn__none")&&n!=="text"&&E&&E.classList.add("protyle-toolbar__item--current"),c===""){const w=document.createElement("span");if(r.push(n),b){let _=0;for(;_<r.length;)["inline-memo","text","block-ref","file-annotation-ref","a"].includes(r[_])?r.splice(_,1):++_}w.setAttribute("data-type",[...new Set(r)].join(" ")),w.textContent=Constants.ZWSP,setFontStyle(w,a),A.push(w)}else{if(n==="block-ref")for(;y.childNodes.length>1;)y.childNodes[0].remove();y.childNodes.forEach((w,_)=>{if(w.nodeType===3)if(_===0&&f&&f.nodeType!==3&&n===f.getAttribute("data-type")&&hasSameTextStyle(w,f,a))d=f.textContent.length,f.innerHTML=f.innerHTML+w.textContent;else if(_===y.childNodes.length-1&&u&&u.nodeType!==3&&n===u.getAttribute("data-type")&&hasSameTextStyle(w,u,a))g=w.textContent.length,u.innerHTML=w.textContent+u.innerHTML;else{const C=document.createElement("span");C.setAttribute("data-type",n),C.textContent=w.textContent,setFontStyle(C,a),A.push(C)}else{let C=(w.getAttribute("data-type")||"").split(" ");for(let x=0;x<C.length;x++)["backslash","virtual-block-ref","search-mark"].includes(C[x])&&(C.splice(x,1),x--);C.push(n),n==="sub"&&C.includes("sup")?C.find((x,T)=>{if(x==="sup")return C.splice(T,1),k.querySelector('[data-type="sup"]').classList.remove("protyle-toolbar__item--current"),!0}):n==="sup"&&C.includes("sub")?C.find((x,T)=>{if(x==="sub")return C.splice(T,1),k.querySelector('[data-type="sub"]').classList.remove("protyle-toolbar__item--current"),!0}):n==="block-ref"&&(C.includes("a")||C.includes("file-annotation-ref"))?C.find((x,T)=>{if(x==="a"||x==="file-annotation-ref")return C.splice(T,1),!0}):n==="a"&&(C.includes("block-ref")||C.includes("file-annotation-ref"))?C.find((x,T)=>{if(x==="block-ref"||x==="file-annotation-ref")return C.splice(T,1),!0}):n==="file-annotation-ref"&&(C.includes("block-ref")||C.includes("a"))?C.find((x,T)=>{if(x==="block-ref"||x==="a")return C.splice(T,1),!0}):n==="inline-memo"&&C.includes("inline-math")?(C.find((x,T)=>{if(x==="inline-math")return C.splice(T,1),!0}),w.textContent=w.getAttribute("data-content")):n==="inline-math"&&C.includes("inline-memo")&&C.find((x,T)=>{if(x==="inline-memo")return C.splice(T,1),!0}),C=[...new Set(C)],_===0&&f&&f.nodeType!==3&&isArrayEqual(C,(f.getAttribute("data-type")||"").split(" "))&&hasSameTextStyle(w,f,a)?(d=f.textContent.length,f.innerHTML=f.innerHTML+w.innerHTML):_===y.childNodes.length-1&&u&&u.nodeType!==3&&isArrayEqual(C,(u.getAttribute("data-type")||"").split(" "))&&hasSameTextStyle(w,u,a)?(g=w.textContent.length,u.innerHTML=w.innerHTML+u.innerHTML):(w.tagName!=="BR"&&w.tagName!=="IMG"&&(w.setAttribute("data-type",C.join(" ")),setFontStyle(w,a)),A.push(w))}})}if(this.range.startContainer.nodeType!==3&&this.range.startContainer.tagName==="SPAN"&&this.range.startContainer.isSameNode(this.range.endContainer)&&!b){const w=this.range.startContainer,_=document.createElement("span"),C=w.attributes;for(let x=0;x<C.length;x++)_.setAttribute(C[x].name,C[x].value);this.range.setEnd(w.lastChild,w.lastChild.textContent.length),_.append(this.range.extractContents()),w.after(_),this.range.setStartBefore(_),this.range.collapse(!0)}for(let w=0;w<A.length;w++){const _=A[w],C=A[w+1];if(_.nodeType!==3&&C&&C.nodeType!==3&&C.tagName===_.tagName&&isArrayEqual((C.getAttribute("data-type")||"").split(" "),(_.getAttribute("data-type")||"").split(" "))&&_.getAttribute("data-id")===C.getAttribute("data-id")&&_.getAttribute("data-subtype")===C.getAttribute("data-subtype")&&_.style.color===C.style.color&&_.style.webkitTextFillColor===C.style.webkitTextFillColor&&_.style.webkitTextStroke===C.style.webkitTextStroke&&_.style.textShadow===C.style.textShadow&&_.style.fontSize===C.style.fontSize&&_.style.backgroundColor===C.style.backgroundColor){const x=_.getAttribute("data-type");x.indexOf("inline-math")>-1?C.setAttribute("data-content",_.getAttribute("data-content")+C.getAttribute("data-content")):(C.innerHTML=_.innerHTML+C.innerHTML,x.indexOf("inline-memo")>-1&&C.setAttribute("data-inline-memo-content",(_.getAttribute("data-inline-memo-content")||"")+(C.getAttribute("data-inline-memo-content")||""))),A.splice(w,1),w--}else{if(this.range.insertNode(_),_.nodeType!==3&&["code","tag","kbd"].includes(n)){const x=hasPreviousSibling(_);(!x||x.textContent.endsWith(`
`))&&_.before(document.createTextNode(Constants.ZWSP)),_.textContent.startsWith(Constants.ZWSP)||(_.textContent=Constants.ZWSP+_.textContent);const T=hasNextSibling(_);(!T||T&&(T.nodeType!==3||T.nodeType===3&&!T.textContent.startsWith(Constants.ZWSP)))&&_.after(document.createTextNode(Constants.ZWSP))}this.range.collapse(!1)}}if(f&&(f.nodeType!==3&&f.textContent===Constants.ZWSP?f.remove():this.mergeNode(f.childNodes)),u&&this.mergeNode(u.childNodes),d?this.range.setStart(f.firstChild,d):A.length>0?A[0].nodeType!==3&&A[0].getAttribute("data-type")==="inline-math"||(A[0].firstChild?A[0].firstChild.textContent===Constants.ZWSP?this.range.setStart(A[0].firstChild,1):this.range.setStart(A[0].firstChild,0):A[0].nodeType===3?this.range.setStart(A[0],0):this.range.setStartBefore(A[0])):u&&this.range.setStart(u.firstChild,0),g)this.range.setEnd(u.lastChild,g);else if(A.length>0){const w=A[A.length-1];if(w.nodeType!==3&&w.getAttribute("data-type").indexOf("inline-math")>-1){const _=hasPreviousSibling(w);_&&_.nodeType===3?this.range.setStart(_,_.textContent.length):this.range.setStartBefore(w);const C=hasNextSibling(w);C&&C.nodeType===3?this.range.setEnd(C,0):this.range.setEndAfter(w)}else w.lastChild?w.lastChild.textContent===Constants.ZWSP?this.range.collapse(!0):this.range.setEnd(w.lastChild,w.lastChild.textContent.length):w.nodeType===3?(this.range.setEnd(w,w.textContent.length),w.textContent===Constants.ZWSP&&this.range.collapse(!1)):this.range.setEndAfter(w)}else f&&this.range.setEnd(f.firstChild,f.firstChild.textContent.length);let v=!0;if(n==="inline-math"){if(mathRender(l),c===""){t.toolbar.showRender(t,A[0],void 0,h);return}}else if(n==="inline-memo"){t.toolbar.showRender(t,A[0],A,h);return}else if(n==="block-ref")this.range.collapse(!1);else if(n==="a"){const w=A[0];w.textContent.replace(Constants.ZWSP,"")===""||!w.getAttribute("data-href")?(v=!1,linkMenu(t,w,!!w.getAttribute("data-href"))):this.range.collapse(!1)}l.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,l.getAttribute("data-node-id"),l.outerHTML,h);const S=l.querySelector("wbr");S&&S.remove(),v&&focusByRange(this.range)}showRender(t,n,s,a){var i;const l=hasClosestBlock(n);if(!l)return;hideElements(["hint"],t),window.siyuan.menus.menu.remove();const o=l.getAttribute("data-node-id"),r=(n.getAttribute("data-type")||"").split(" "),c=a||l.outerHTML;let f="HTML",u="";const d=r.includes("inline-memo");switch(n.getAttribute("data-subtype")){case"abc":f=window.siyuan.languages.staff;break;case"echarts":f=window.siyuan.languages.chart;break;case"flowchart":f="Flow Chart";break;case"graphviz":f="Graphviz";break;case"mermaid":f="Mermaid";break;case"mindmap":u=`- foo
  - bar
- baz`,f=window.siyuan.languages.mindmap;break;case"plantuml":f="UML";break;case"math":r.includes("NodeMathBlock")?f=window.siyuan.languages.math:f=window.siyuan.languages["inline-math"];break}r.includes("NodeBlockQueryEmbed")?f=window.siyuan.languages.blockEmbed:d&&(f=window.siyuan.languages.memo);const g=((i=this.subElement.querySelector('[data-type="pin"]'))==null?void 0:i.getAttribute("aria-label"))===window.siyuan.languages.unpin,p={};if(g){const E=this.subElement.querySelector(".b3-text-field");p.styleH=E.style.height,p.styleW=E.style.width}else this.subElement.style.width="",this.subElement.style.padding="0";this.subElement.innerHTML=`<div ${g&&this.subElement.firstElementChild.getAttribute("data-drag")==="true"?'data-drag="true"':""}><div class="block__icons block__icons--menu fn__flex" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0;">
    <span class="fn__flex-1 resize__move">
        ${f}
    </span>
    <span class="fn__space"></span>
    <button data-type="refresh" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${g&&!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active")?"":" block__icon--active"}${r.includes("NodeBlockQueryEmbed")?" fn__none":""}" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href="#iconRefresh"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="before" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${t.disabled?" fn__none":""}" aria-label="${window.siyuan.languages["insert-before"]}"><svg><use xlink:href="#iconBefore"></use></svg></button>
    <span class="fn__space${t.disabled?" fn__none":""}"></span>
    <button data-type="after" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${t.disabled?" fn__none":""}" aria-label="${window.siyuan.languages["insert-after"]}"><svg><use xlink:href="#iconAfter"></use></svg></button>
    <span class="fn__space${t.disabled?" fn__none":""}"></span>
    <button data-type="export" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.export} ${window.siyuan.languages.image}"><svg><use xlink:href="#iconImage"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${g?window.siyuan.languages.unpin:window.siyuan.languages.pin}"><svg><use xlink:href="#icon${g?"Unpin":"Pin"}"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.close}"><svg style="width: 10px"><use xlink:href="#iconClose"></use></svg></button>
</div>
<textarea ${t.disabled?" readonly":""} spellcheck="false" class="b3-text-field b3-text-field--text fn__block" placeholder="${u}" style="${isMobile()?"":"width:"+Math.max(480,n.clientWidth*.7)+"px"};max-height:calc(80vh - 44px);min-height: 48px;min-width: 268px;border-radius: 0 0 var(--b3-border-radius-b) var(--b3-border-radius-b);font-family: var(--b3-font-family-code);"></textarea></div>`;const b=()=>{if(y.style.height=y.scrollHeight+"px",isMobile()){setPosition(this.subElement,0,0);return}if(this.subElement.firstElementChild.getAttribute("data-drag")==="true"){y.getBoundingClientRect().bottom>window.innerHeight&&(this.subElement.style.top=window.innerHeight-this.subElement.clientHeight+"px");return}const E=k.bottom===k.top?k.bottom+26:k.bottom;this.subElement.clientHeight<=window.innerHeight-E||this.subElement.clientHeight<=k.top?r.includes("inline-math")||d?setPosition(this.subElement,k.left,E,k.height||26):setPosition(this.subElement,k.left+(k.width-this.subElement.clientWidth)/2,E,k.height||26):setPosition(this.subElement,k.right,E)},m=this.subElement.querySelector(".block__icons");m.addEventListener("click",E=>{const A=E.target,v=hasClosestByClassName(A,"b3-tooltips");if(!v){if(E.detail===2){const S=m.querySelector('[data-type="pin"]');S.getAttribute("aria-label")===window.siyuan.languages.unpin?(S.querySelector("svg use").setAttribute("xlink:href","#iconPin"),S.setAttribute("aria-label",window.siyuan.languages.pin)):(S.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),S.setAttribute("aria-label",window.siyuan.languages.unpin)),E.preventDefault(),E.stopPropagation()}return}switch(E.stopPropagation(),v.getAttribute("data-type")){case"close":this.subElement.querySelector('[data-type="pin"]').setAttribute("aria-label",window.siyuan.languages.pin),hideElements(["util"],t);break;case"pin":v.getAttribute("aria-label")===window.siyuan.languages.unpin?(v.querySelector("svg use").setAttribute("xlink:href","#iconPin"),v.setAttribute("aria-label",window.siyuan.languages.pin)):(v.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),v.setAttribute("aria-label",window.siyuan.languages.unpin));break;case"refresh":v.classList.toggle("block__icon--active");break;case"before":insertEmptyBlock(t,"beforebegin",o),hideElements(["util"],t);break;case"after":insertEmptyBlock(t,"afterend",o),hideElements(["util"],t);break;case"export":h();break}});const h=()=>{const E=showMessage(window.siyuan.languages.exporting,0);if(n.getAttribute("data-subtype")==="plantuml"){fetch(n.querySelector("img").getAttribute("src")).then(function(A){return A.blob()}).then(function(A){const v=new FormData;v.append("file",A),v.append("type","image/png"),fetchPost("/api/export/exportAsFile",v,S=>{openByMobile(S.data.file),hideMessage(E)})});return}setTimeout(()=>{addScript("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{window.html2canvas(n,{useCORS:!0}).then(A=>{A.toBlob(v=>{const S=new FormData;S.append("file",v),S.append("type","image/png"),fetchPost("/api/export/exportAsFile",S,w=>{openByMobile(w.data.file),hideMessage(E)})})})})},Constants.TIMEOUT_LOAD)},y=this.subElement.querySelector(".b3-text-field");r.includes("NodeHTMLBlock")?y.value=Lute.UnEscapeHTMLStr(n.querySelector("protyle-html").getAttribute("data-content")||""):d?y.value=Lute.UnEscapeHTMLStr(n.getAttribute("data-inline-memo-content")||""):y.value=Lute.UnEscapeHTMLStr(n.getAttribute("data-content")||""),y.addEventListener("input",E=>{if(n.parentElement&&(y.clientHeight!==y.scrollHeight&&b(),!!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active"))){if(r.includes("NodeHTMLBlock"))n.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(y.value));else if(d){let A;s?A=s:A=[n],A.forEach(v=>{v.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(y.value))})}else n.setAttribute("data-content",Lute.EscapeHTMLStr(y.value)),n.removeAttribute("data-render");(!r.includes("NodeBlockQueryEmbed")||!r.includes("NodeHTMLBlock")||!d)&&processRender(n),E.stopPropagation()}}),y.addEventListener("keydown",E=>{if(E.stopPropagation(),matchHotKey(window.siyuan.config.keymap.editor.insert["inline-math"].custom,E)){E.preventDefault();return}if(!E.isComposing){if(E.key==="Escape"||matchHotKey("\u2318\u21A9",E))this.subElement.querySelector('[data-type="pin"]').setAttribute("aria-label",window.siyuan.languages.pin),hideElements(["util"],t);else if(E.key==="Tab")document.execCommand("insertText",!1,"	"),E.preventDefault();else if(electronUndo(E))return}}),this.subElementCloseCB=()=>{var E;if(!n.parentElement||t.disabled)return;let A;if(r.includes("NodeHTMLBlock")){let v=y.value;v&&(v=v.trim().replace(/\n+/g,`
`),v.startsWith("<div>")&&v.endsWith("</div>")||(v=`<div>
${v}
</div>`)),n.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(v))}else if(d){let v;s?v=s:v=[n],v.forEach((S,w)=>{if(y.value)S.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(y.value));else{const _=S.getAttribute("data-type").split(" ");_.length===1&&_[0]==="inline-memo"?S.outerHTML=S.innerHTML+(w===v.length-1?"<wbr>":""):(_.find((C,x)=>{if(C==="inline-memo")return _.splice(x,1),!0}),S.setAttribute("data-type",_.join(" ")),S.removeAttribute("data-inline-memo-content")),w===v.length-1&&(A=S)}})}else r.includes("inline-math")?y.value?(n.setAttribute("data-content",Lute.EscapeHTMLStr(y.value)),n.removeAttribute("data-render"),processRender(n)):(A=n,n.outerHTML="<wbr>"):(n.setAttribute("data-content",Lute.EscapeHTMLStr(y.value)),n.removeAttribute("data-render"),r.includes("NodeBlockQueryEmbed")?blockRender(t,n):processRender(n));if(getSelection().rangeCount===0||getSelection().rangeCount>0&&hasClosestByClassName(getSelection().getRangeAt(0).startContainer,"protyle-util")?n.tagName==="SPAN"?A?A.parentElement?(this.range.setStartAfter(A),this.range.collapse(!0),focusByRange(this.range)):focusByWbr(l,this.range):n.parentElement&&(this.range.setStartAfter(n),this.range.collapse(!0),focusByRange(this.range)):(focusBlock(n),n.classList.add("protyle-wysiwyg--select")):(E=l.querySelector("wbr"))==null||E.remove(),l.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),r.includes("NodeHTMLBlock")){const v=document.createElement("template");v.innerHTML=t.lute.SpinBlockDOM(l.outerHTML),v.content.childElementCount>1&&showMessage(window.siyuan.languages.htmlBlockTip)}updateTransaction(t,o,l.outerHTML,c)},this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none");const k=n.getBoundingClientRect();this.element.classList.add("fn__none"),g?(y.style.width=p.styleW,y.style.height=p.styleH):b(),t.disabled||y.select(),t.app.plugins.forEach(E=>{E.eventBus.emit("open-noneditableblock",{protyle:t,toolbar:this})})}showCodeLanguage(t,n){var s,a;const i=hasClosestBlock(n);if(!i)return;hideElements(["hint"],t),window.siyuan.menus.menu.remove(),this.range=getEditorRange(i);const l=i.getAttribute("data-node-id");let o=i.outerHTML,r=`<div class="b3-list-item">${window.siyuan.languages.clear}</div>`;const c=Constants.ALIAS_CODE_LANGUAGES.concat((a=(s=window.hljs)==null?void 0:s.listLanguages())!=null?a:[]).sort();c.forEach((d,g)=>{r+=`<div class="b3-list-item${g===0?" b3-list-item--focus":""}">${d}</div>`}),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input placeholder="${window.siyuan.languages.search}" style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${r}</div>
</div>`;const f=this.subElement.lastElementChild.lastElementChild,u=this.subElement.querySelector("input");u.addEventListener("keydown",d=>{if(d.stopPropagation(),!d.isComposing){if(upDownHint(f,d),d.key==="Enter"){const g=this.subElement.querySelector(".b3-list-item--focus").textContent;n.textContent=g===window.siyuan.languages.clear?"":g,window.siyuan.storage[Constants.LOCAL_CODELANG]=n.textContent,setStorageVal(Constants.LOCAL_CODELANG,window.siyuan.storage[Constants.LOCAL_CODELANG]);const p=getContenteditableElement(i),b=i.getAttribute("linenumber");b==="true"||b!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum?p.classList.add("protyle-linenumber"):p.classList.remove("protyle-linenumber"),p.textContent=p.textContent,p.removeAttribute("data-render"),highlightRender(i),i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,l,i.outerHTML,o),o=i.outerHTML,d.preventDefault(),d.stopPropagation()}(d.key==="Escape"||d.key==="Enter")&&(this.subElement.classList.add("fn__none"),focusByRange(this.range))}}),u.addEventListener("input",d=>{const g=u.value.toLowerCase(),p=c.filter(h=>h.includes(g));let b="",m=!1;p.sort((h,y)=>h.startsWith(g)&&y.startsWith(g)?h.length<y.length?-1:h.length===y.length?0:1:h.startsWith(g)?-1:y.startsWith(g)?1:0).forEach(h=>{u.value===h&&(m=!0),b+=`<div class="b3-list-item">${h.replace(g,"<b>"+g+"</b>")}</div>`}),u.value.trim()&&!m&&(b=`<div class="b3-list-item"><b>${u.value.replace(/`| /g,"_")}</b></div>${b}`),b=`<div class="b3-list-item">${window.siyuan.languages.clear}</div>`+b,f.innerHTML=b,f.firstElementChild.nextElementSibling?f.firstElementChild.nextElementSibling.classList.add("b3-list-item--focus"):f.firstElementChild.classList.add("b3-list-item--focus"),d.stopPropagation()}),f.addEventListener("click",d=>{const g=d.target,p=hasClosestByClassName(g,"b3-list-item");if(!p)return;n.textContent=p.textContent===window.siyuan.languages.clear?"":p.textContent,window.siyuan.storage[Constants.LOCAL_CODELANG]=n.textContent,setStorageVal(Constants.LOCAL_CODELANG,window.siyuan.storage[Constants.LOCAL_CODELANG]);const b=hasClosestBlock(n);if(b){const m=getContenteditableElement(b),h=b.getAttribute("linenumber");h==="true"||h!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum?m.classList.add("protyle-linenumber"):m.classList.remove("protyle-linenumber"),m.textContent=m.textContent,m.removeAttribute("data-render"),highlightRender(b),b.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,l,b.outerHTML,o),o=b.outerHTML,this.subElement.classList.add("fn__none"),focusByRange(this.range)}}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,setPosition(this.subElement,0,0),this.element.classList.add("fn__none"),u.select()}showTpl(t,n,s){this.range=s,hideElements(["hint"],t),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div style="max-height:50vh" class="fn__flex">
<div class="fn__flex-column" style="${isMobile()?"width: 100%":"min-width: 260px;max-width:50vw"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div style="width: 520px;${isMobile()||window.outerWidth<window.outerWidth/2+520?"display:none":""};overflow: auto;"></div>
</div>`;const a=this.subElement.querySelector(".b3-list"),i=this.subElement.firstElementChild.lastElementChild;let l;a.addEventListener("mouseover",r=>{const c=r.target,f=hasClosestByClassName(c,"b3-list-item");if(!f)return;const u=f.getAttribute("data-value");l!==u&&(l=u,previewTemplate(l,i,t.block.parentID))});const o=this.subElement.querySelector("input");o.addEventListener("keydown",r=>{if(r.stopPropagation(),r.isComposing)return;const c=!this.subElement.querySelector(".b3-list-item");if(!c){const f=upDownHint(a,r);if(f){const u=f.getAttribute("data-value");if(l===u)return;l=u,previewTemplate(l,i,t.block.parentID)}}r.key==="Enter"?(c?focusByRange(this.range):hintRenderTemplate(decodeURIComponent(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-value")),t,n),this.subElement.classList.add("fn__none"),r.preventDefault()):r.key==="Escape"&&(this.subElement.classList.add("fn__none"),focusByRange(this.range))}),o.addEventListener("input",r=>{r.stopPropagation(),fetchPost("/api/search/searchTemplate",{k:o.value},c=>{var f;let u="";c.data.blocks.forEach((g,p)=>{u+=`<div data-value="${g.path}" class="b3-list-item${p===0?" b3-list-item--focus":""}">${g.content}</div>`}),a.innerHTML=u||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;const d=(f=c.data.blocks[0])==null?void 0:f.path;l!==d&&(l=d,previewTemplate(l,i,t.block.parentID))})}),this.subElement.lastElementChild.addEventListener("click",r=>{const c=r.target;if(c.classList.contains("b3-list--empty")){this.subElement.classList.add("fn__none"),focusByRange(this.range),r.stopPropagation();return}const f=hasClosestByClassName(c,"b3-list-item__action");if(f&&f.getAttribute("data-type")==="remove"){confirmDialog(window.siyuan.languages.remove,window.siyuan.languages.confirmDelete+"?",()=>{fetchPost("/api/search/removeTemplate",{path:f.parentElement.getAttribute("data-value")},()=>{if(f.parentElement.parentElement.childElementCount===1)f.parentElement.parentElement.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,previewTemplate("",i,t.block.parentID);else{if(f.parentElement.classList.contains("b3-list-item--focus")){const p=f.parentElement.previousElementSibling||f.parentElement.nextElementSibling;p.classList.add("b3-list-item--focus");const b=p.getAttribute("data-value");if(l===b)return;l=b,previewTemplate(l,i,t.block.parentID)}f.parentElement.remove()}})}),r.stopPropagation();return}if(hasClosestByAttribute(c,"data-type","previous")){o.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),r.stopPropagation();return}if(hasClosestByAttribute(c,"data-type","next")){o.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),r.stopPropagation();return}const g=hasClosestByClassName(c,"b3-list-item");g&&(hintRenderTemplate(decodeURIComponent(g.getAttribute("data-value")),t,n),r.stopPropagation())}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),o.select(),fetchPost("/api/search/searchTemplate",{k:""},r=>{let c="";r.data.blocks.forEach((f,u)=>{c+=`<div data-value="${f.path}" class="b3-list-item--hide-action b3-list-item${u===0?" b3-list-item--focus":""}">
<span class="b3-list-item__text">${f.content}</span>`,c+=`<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=c||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,setPosition(this.subElement,0,0),l=a.firstElementChild.getAttribute("data-value"),previewTemplate(l,i,t.block.parentID)})}showWidget(t,n,s){this.range=s,hideElements(["hint"],t),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height:64px" src="/stage/loading-pure.svg"></div>
</div>`;const a=this.subElement.lastElementChild.lastElementChild,i=this.subElement.querySelector("input");i.addEventListener("keydown",l=>{l.stopPropagation(),!l.isComposing&&(upDownHint(a,l),l.key==="Enter"?(hintRenderWidget(this.subElement.querySelector(".b3-list-item--focus").textContent,t),this.subElement.classList.add("fn__none"),l.preventDefault()):l.key==="Escape"&&(this.subElement.classList.add("fn__none"),focusByRange(this.range)))}),i.addEventListener("input",l=>{l.stopPropagation(),fetchPost("/api/search/searchWidget",{k:i.value},o=>{let r="";o.data.blocks.forEach((c,f)=>{r+=`<div data-value="${c.path}" class="b3-list-item${f===0?" b3-list-item--focus":""}">${c.content}</div>`}),a.innerHTML=r})}),this.subElement.lastElementChild.addEventListener("click",l=>{const o=l.target,r=hasClosestByClassName(o,"b3-list-item");r&&hintRenderWidget(r.textContent,t)}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),i.select(),fetchPost("/api/search/searchWidget",{k:""},l=>{let o="";l.data.blocks.forEach((r,c)=>{o+=`<div class="b3-list-item${c===0?" b3-list-item--focus":""}">${r.content}</div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=o,setPosition(this.subElement,0,0)})}showContent(t,n,s){var a,i;this.range=n,hideElements(["hint"],t),this.subElement.style.width="auto",this.subElement.style.padding="0 8px";let l="";const o=n.toString()!==""||((i=(a=n.cloneContents().childNodes[0])==null?void 0:a.classList)==null?void 0:i.contains("emoji"));o&&(l+='<button class="keyboard__action" data-action="copy"><svg><use xlink:href="#iconCopy"></use></svg></button>',t.disabled||(l+=`<button class="keyboard__action" data-action="cut"><svg><use xlink:href="#iconCut"></use></svg></button>
<button class="keyboard__action" data-action="delete"><svg><use xlink:href="#iconTrashcan"></use></svg></button>`)),t.disabled||(l+=`<button class="keyboard__action" data-action="paste"><svg><use xlink:href="#iconPaste"></use></svg></button>
<button class="keyboard__action" data-action="select"><svg><use xlink:href="#iconSelect"></use></svg></button>`),(o||!t.disabled)&&(l+='<button class="keyboard__action" data-action="more"><svg><use xlink:href="#iconMore"></use></svg></button>'),this.subElement.innerHTML=`<div class="fn__flex">${l}</div>`,this.subElement.lastElementChild.addEventListener("click",c=>yi(this,null,function*(){const f=hasClosestByClassName(c.target,"keyboard__action");if(!f)return;const u=f.getAttribute("data-action");if(u==="copy")focusByRange(getEditorRange(s)),document.execCommand("copy"),this.subElement.classList.add("fn__none");else if(u==="cut")focusByRange(getEditorRange(s)),document.execCommand("cut"),this.subElement.classList.add("fn__none");else if(u==="delete"){const d=getEditorRange(s);d.insertNode(document.createElement("wbr"));const g=s.outerHTML;d.extractContents(),focusByWbr(s,d),focusByRange(d),updateTransaction(t,s.getAttribute("data-node-id"),s.outerHTML,g),this.subElement.classList.add("fn__none")}else if(u==="paste"){if(document.queryCommandSupported("paste"))document.execCommand("paste");else try{const d=yield readText();pasteText(t,d,s)}catch(d){console.log(d)}this.subElement.classList.add("fn__none")}else u==="select"?(selectAll(t,s,n),this.subElement.classList.add("fn__none")):u==="copyPlainText"?(focusByRange(getEditorRange(s)),copyPlainText(getSelection().getRangeAt(0).toString()),this.subElement.classList.add("fn__none")):u==="pasteAsPlainText"?(focusByRange(getEditorRange(s)),pasteAsPlainText(t),this.subElement.classList.add("fn__none")):u==="pasteEscaped"?(pasteEscaped(t,s),this.subElement.classList.add("fn__none")):u==="back"?this.subElement.lastElementChild.innerHTML=l:u==="more"&&(this.subElement.lastElementChild.innerHTML=`<button class="keyboard__action${o?"":" fn__none"}" data-action="copyPlainText"><span>${window.siyuan.languages.copyPlainText}</span></button>
<div class="keyboard__split${o?"":" fn__none"}"></div>
<button class="keyboard__action${t.disabled?" fn__none":""}" data-action="pasteAsPlainText"><span>${window.siyuan.languages.pasteAsPlainText}</span></button>
<div class="keyboard__split${t.disabled?" fn__none":""}"></div>
<button class="keyboard__action${t.disabled?" fn__none":""}" data-action="pasteEscaped"><span>${window.siyuan.languages.pasteEscaped}</span></button>
<div class="keyboard__split${t.disabled?" fn__none":""}"></div>
<button class="keyboard__action" data-action="back"><svg><use xlink:href="#iconBack"></use></svg></button>`,setPosition(this.subElement,r.left,r.top+28,Constants.SIZE_TOOLBAR_HEIGHT))})),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none");const r=getSelectionPosition(s,n);setPosition(this.subElement,r.left,r.top-48,Constants.SIZE_TOOLBAR_HEIGHT)}}const vd=(e,t,n,s,a)=>{let i=1,l;fetchPost(`/api/riff/get${s}RiffCards`,{id:t,page:i},o=>{var r;const c=new Dialog({positionId:Constants.DIALOG_VIEWCARDS,content:`<div class="fn__flex-column" style="height: 100%">
    <div class="block__icons">
        <span class="fn__flex-1 fn__flex-center resize__move">${escapeHtml(n)}</span>
        <span class="fn__space"></span>
        <span data-type="resetAll" class="block__icon block__icon--show b3-tooltips b3-tooltips__w${s===""&&t===""?" fn__none":""}" aria-label="${window.siyuan.languages.reset}"><svg><use xlink:href='#iconUndo'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
        <span class="fn__space"></span>
        <span class="fn__flex-center ft__on-surface">${i}/${o.data.pageCount||1}</span>
        <span class="fn__space"></span>
        <span class="counter">${o.data.total}</span>
        ${isMobile()?`<span class="fn__space"></span>
<div data-type="close" class="block__icon block__icon--show">
    <svg><use xlink:href="#iconCloseRound"></use></svg>
</div>`:""}
    </div>
    <div class="${isMobile()?"fn__flex-column":"fn__flex"} fn__flex-1" style="min-height: auto">
        <ul class="fn__flex-1 b3-list b3-list--background" style="user-select: none">
            ${fn(o.data.blocks,n,s)}
        </ul>
        <div id="cardPreview" style="border-bottom-right-radius:var(--b3-border-radius-b);" class="fn__flex-1 fn__none"></div>
        <div class="fn__flex-1 card__empty">${window.siyuan.languages.emptyContent}</div>
    </div>
</div>`,width:isMobile()?"100vw":"80vw",height:isMobile()?"100vh":"70vh",destroyCallback(){l&&(l.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null))}});o.data.blocks.length>0&&(l=new Protyle(e,c.element.querySelector("#cardPreview"),{blockId:"",render:{gutter:!0,breadcrumbDocName:!0}}),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=l),c.editor=l,Ze(l,(r=c.element.querySelector(".b3-list-item--focus"))==null?void 0:r.getAttribute("data-id")));const f=c.element.querySelector('[data-type="previous"]'),u=c.element.querySelector('[data-type="next"]'),d=c.element.querySelector(".b3-list--background");o.data.pageCount>1&&u.removeAttribute("disabled"),c.element.setAttribute("data-key",Constants.DIALOG_VIEWCARDS),c.element.addEventListener("click",g=>{var p;if(typeof g.detail=="string"){let m=d.querySelector(".b3-list-item--focus");if(m){m.classList.remove("b3-list-item--focus"),g.detail==="arrowup"?m=m.previousElementSibling||m.parentElement.lastElementChild:g.detail==="arrowdown"?m=m.nextElementSibling||m.parentElement.firstElementChild:g.detail==="home"?m=m.parentElement.firstElementChild:g.detail==="end"&&(m=m.parentElement.lastElementChild);const h=m.getBoundingClientRect(),y=m.parentElement.getBoundingClientRect();(h.top<y.top||h.bottom>y.bottom)&&m.scrollIntoView(h.top<y.top),Ze(l,m.getAttribute("data-id")),m.classList.add("b3-list-item--focus")}g.stopPropagation(),g.preventDefault();return}let b=g.target;for(;b&&!c.element.isSameNode(b);){const m=b.getAttribute("data-type");if(m==="close"){c.destroy(),g.stopPropagation(),g.preventDefault();break}else if(m==="previous"){if(i<=1)return;i--,i<=1&&f.setAttribute("disabled","disabled"),fetchPost(`/api/riff/get${s}RiffCards`,{id:t,page:i},h=>{var y;i===h.data.pageCount?u.setAttribute("disabled","disabled"):h.data.pageCount>1&&u.removeAttribute("disabled"),u.nextElementSibling.nextElementSibling.textContent=`${i}/${h.data.pageCount||1}`,d.innerHTML=fn(h.data.blocks,n,s),d.scrollTop=0,Ze(l,(y=c.element.querySelector(".b3-list-item--focus"))==null?void 0:y.getAttribute("data-id"))}),g.stopPropagation(),g.preventDefault();break}else if(m==="next"){if(i>=o.data.pageCount)return;i++,f.removeAttribute("disabled"),fetchPost(`/api/riff/get${s}RiffCards`,{id:t,page:i},h=>{var y;i===h.data.pageCount?u.setAttribute("disabled","disabled"):h.data.pageCount>1&&u.removeAttribute("disabled"),u.nextElementSibling.nextElementSibling.textContent=`${i}/${h.data.pageCount||1}`,d.innerHTML=fn(h.data.blocks,n,s),d.scrollTop=0,Ze(l,(y=c.element.querySelector(".b3-list-item--focus"))==null?void 0:y.getAttribute("data-id"))}),g.stopPropagation(),g.preventDefault();break}else if(m==="reset"){fetchPost("/api/riff/resetRiffCards",{type:s===""?"deck":s.toLowerCase(),deckID:s===""?t:Constants.QUICK_DECK_ID,id:t,blockIDs:[b.getAttribute("data-id")]},()=>{b.parentElement.querySelector(".ariaLabel.b3-list-item__meta").textContent=dayjs().format("YYYY-MM-DD")}),g.stopPropagation(),g.preventDefault();break}else if(m==="resetAll"){confirmDialog(window.siyuan.languages.reset,window.siyuan.languages.resetCardTip.replace("${x}",c.element.querySelector(".counter").textContent),()=>{fetchPost("/api/riff/resetRiffCards",{type:s===""?"deck":s.toLowerCase(),deckID:s===""?t:Constants.QUICK_DECK_ID,id:t},()=>{c.element.querySelectorAll(".ariaLabel.b3-list-item__meta").forEach(h=>{h.textContent=dayjs().format("YYYY-MM-DD")})})}),g.stopPropagation(),g.preventDefault();break}else if(m==="card-item"){Ze(l,b.getAttribute("data-id")),(p=d.querySelector(".b3-list-item--focus"))==null||p.classList.remove("b3-list-item--focus"),b.classList.add("b3-list-item--focus"),g.stopPropagation(),g.preventDefault();break}else if(m==="remove"){fetchPost("/api/riff/removeRiffCards",{deckID:s===""?t:Constants.QUICK_DECK_ID,blockIDs:[b.getAttribute("data-id")]},h=>{var y;let k=b.parentElement.nextElementSibling;k||(k=b.parentElement.previousElementSibling),!k&&b.parentElement.parentElement.childElementCount>1&&(k=b.parentElement.parentElement.firstElementChild),k?(Ze(l,k.getAttribute("data-id")),(y=d.querySelector(".b3-list-item--focus"))==null||y.classList.remove("b3-list-item--focus"),k.classList.add("b3-list-item--focus"),b.parentElement.remove()):(Ze(l,""),d.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),c.element.querySelector(".counter").textContent=(parseInt(c.element.querySelector(".counter").textContent)-1).toString(),a&&a(h)}),g.stopPropagation(),g.preventDefault();break}b=b.parentElement}})})},fn=(e,t,n)=>{let s="",a=!0;const i=t.split("/");return i.splice(0,1),e.forEach(l=>{var o,r,c,f;if(l.type){let u;n===""?u=getNotebookName(l.box)+getDisplayName(Lute.UnEscapeHTMLStr(l.hPath),!1):(u=getDisplayName(Lute.UnEscapeHTMLStr(l.hPath),!1).replace("/"+i.join("/"),""),u.startsWith("/")&&(u=u.substring(1))),s+=`<div data-type="card-item" class="b3-list-item${a?" b3-list-item--focus":""}${isMobile()?"":" b3-list-item--hide-action"}" data-id="${l.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(l.type)}"></use></svg>
${unicode2Emoji(l.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${l.content||Constants.ZWSP}</span>
<span class="${isMobile()||!u?"fn__none ":""}b3-list-item__meta b3-list-item__meta--ellipsis" title="${escapeAttr(u)}">${escapeHtml(u)}</span>
<span data-position="parentE" aria-label="${window.siyuan.languages.revisionCount}" class="ariaLabel counter${((o=l.riffCard)==null?void 0:o.reps)===0?" fn__none":""}">${(r=l.riffCard)==null?void 0:r.reps}</span>
<span data-position="parentE" aria-label="${window.siyuan.languages.nextDue}" class="ariaLabel b3-list-item__meta${(c=l.riffCard)!=null&&c.due?"":" fn__none"}">${dayjs((f=l.riffCard)==null?void 0:f.due).format("YYYY-MM-DD")}</span>
<span data-position="parentE" data-type="reset" data-id="${l.id}" class="b3-list-item__action ariaLabel" aria-label="${window.siyuan.languages.reset}">
    <svg><use xlink:href="#iconUndo"></use></svg>
</span>
<span data-position="parentE" data-type="remove" data-id="${l.id}" class="b3-list-item__action ariaLabel" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`,a=!1}else s+=`<div data-type="card-item" class="b3-list-item${isMobile()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">${l.content}</span>
<span data-position="parentE" data-type="remove" data-id="${l.id}" class="b3-list-item__action ariaLabel" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`}),e.length===0&&(s=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),s},Ze=(e,t)=>{if(!t){e.protyle.element.classList.add("fn__none"),e.protyle.element.nextElementSibling.classList.remove("fn__none");return}e.protyle.element.classList.remove("fn__none"),e.protyle.element.nextElementSibling.classList.add("fn__none"),e.protyle.scroll.lastScrollTop=0,addLoading(e.protyle),fetchPost("/api/block/getDocInfo",{id:t},n=>{e.protyle.wysiwyg.renderCustom(n.data.ial),fetchPost("/api/filetree/getDoc",{id:t,mode:0,size:Constants.SIZE_GET_MAX},s=>{onGet({updateReadonly:!0,data:s,protyle:e.protyle,action:s.data.rootID===s.data.id?[Constants.CB_GET_HTML]:[Constants.CB_GET_ALL,Constants.CB_GET_HTML]})})})},yt=e=>`<li data-id="${e.id}" data-name="${escapeAttr(e.name)}" class="b3-list-item b3-list-item--narrow${isMobile()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">
    <span>${escapeHtml(e.name)}</span>
    <span class="b3-list-item__meta">${e.size}</span>
</span>
<span data-type="rename" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.rename}">
    <svg><use xlink:href="#iconEdit"></use></svg>
</span>
<span data-type="delete" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
<span data-type="view" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
    <svg><use xlink:href="#iconEye"></use></svg>
</span>
<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconMin"></use></svg>
</span>
<span data-type="add" style="display: flex" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.addDeck}">
    <svg><use xlink:href="#iconAdd"></use></svg>
</span>
<span class="b3-list-item__meta${isMobile()?" fn__none":""}">${e.updated}</span>
</li>`,Ed=(e,t)=>{window.siyuan.dialogs.find(n=>{if(n.element.getAttribute("data-key")===Constants.DIALOG_MAKECARD)return hideElements(["dialog"]),!0}),fetchPost("/api/riff/getRiffDecks",{},n=>{let s="";n.data.forEach(i=>{s+=yt(i)});const a=new Dialog({positionId:Constants.DIALOG_MAKECARD,width:isMobile()?"92vw":"50vw",height:"70vh",title:window.siyuan.languages.riffCard,content:`<div class="b3-dialog__content fn__flex-column" style="box-sizing: border-box;height: 100%">
    <div class="fn__flex">
        <input class="b3-text-field fn__flex-1">
        <span class="fn__space"></span>
        <span data-type="create" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.createDeck}">
            <svg><use xlink:href="#iconAdd"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span data-type="viewall" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
            <svg><use xlink:href="#iconEye"></use></svg>
        </span>
    </div>
    <div class="fn__hr"></div>
    <ul class="b3-list b3-list--background fn__flex-1">${s}</ul>
</div>`});a.element.setAttribute("data-key",Constants.DIALOG_MAKECARD),a.element.addEventListener("click",i=>{let l=i.target;for(;l&&!l.isSameNode(a.element);){const o=l.getAttribute("data-type");if(o==="create"){let r="";const c=a.element.querySelector(".b3-text-field");c.value?(r&&hideMessage(r),fetchPost("/api/riff/createRiffDeck",{name:c.value},f=>{a.element.querySelector(".b3-list").insertAdjacentHTML("afterbegin",yt(f.data)),c.value=""})):(r=showMessage(window.siyuan.languages._kernel[142]),c.focus()),i.stopPropagation(),i.preventDefault();break}else if(o==="add"){fetchPost("/api/riff/addRiffCards",{deckID:l.parentElement.getAttribute("data-id"),blockIDs:t},r=>{l.parentElement.outerHTML=yt(r.data)}),i.stopPropagation(),i.preventDefault();break}else if(o==="remove"){fetchPost("/api/riff/removeRiffCards",{deckID:l.parentElement.getAttribute("data-id"),blockIDs:t},r=>{l.parentElement.outerHTML=yt(r.data)}),i.stopPropagation(),i.preventDefault();break}else if(o==="delete"){confirmDialog(window.siyuan.languages.confirm,`${window.siyuan.languages.confirmDelete} <b>${escapeHtml(l.parentElement.getAttribute("data-name"))}</b>?`,()=>{fetchPost("/api/riff/removeRiffDeck",{deckID:l.parentElement.getAttribute("data-id")},()=>{l.parentElement.remove()})}),i.stopPropagation(),i.preventDefault();break}else if(o==="view"){viewCards(e,l.parentElement.getAttribute("data-id"),l.parentElement.getAttribute("data-name"),"",r=>{l.parentElement.outerHTML=yt(r.data)}),i.stopPropagation(),i.preventDefault();break}else if(o==="viewall"){viewCards(e,"",window.siyuan.languages.all,""),i.stopPropagation(),i.preventDefault();break}else if(o==="rename"){const r=new Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),c=r.element.querySelector("input"),f=r.element.querySelectorAll(".b3-button");r.bindInput(c,()=>{f[1].click()}),c.value=l.parentElement.getAttribute("data-name"),c.focus(),c.select(),f[0].addEventListener("click",()=>{r.destroy()}),f[1].addEventListener("click",()=>{fetchPost("/api/riff/renameRiffDeck",{name:c.value,deckID:l.parentElement.getAttribute("data-id")},()=>{l.parentElement.querySelector(".b3-list-item__text span").textContent=c.value,l.parentElement.setAttribute("data-name",c.value)}),r.destroy()}),i.stopPropagation(),i.preventDefault();break}l=l.parentElement}})})},kd=(e,t)=>{let n=!0;const s=[];t.forEach(a=>{a.getAttribute("data-type")!=="NodeThematicBreak"&&(a.classList.remove("protyle-wysiwyg--select"),s.push(a.getAttribute("data-node-id")),(a.getAttribute(Constants.CUSTOM_RIFF_DECKS)||"").indexOf(Constants.QUICK_DECK_ID)===-1&&(n=!1))}),n?transaction(e,[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:s}],[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:s}]):transaction(e,[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:s}],[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:s}])},Cd=e=>{window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.transferBlockRef,icon:"iconScrollHoriz",click(){const t=new Dialog({title:window.siyuan.languages.transferBlockRef,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.targetBlockID}">
    <div class="b3-label__text">${window.siyuan.languages.transferBlockRefTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});t.element.setAttribute("data-key",Constants.DIALOG_TRANSFERBLOCKREF);const n=t.element.querySelector("input"),s=t.element.querySelectorAll(".b3-button");t.bindInput(n,()=>{s[1].click()}),n.focus(),s[0].addEventListener("click",()=>{t.destroy()}),s[1].addEventListener("click",()=>{fetchPost("/api/block/transferBlockRef",{fromID:e,toID:n.value}),t.destroy()})}}).element)};var wi=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())}),_i=(e,t,n)=>(t=e[Symbol.asyncIterator],n=(s,a)=>(a=e[s])&&(t[s]=i=>new Promise((l,o,r)=>(i=a.call(e,i),r=i.done,Promise.resolve(i.value).then(c=>l({value:c,done:r}),o)))),t?t.call(e):(e=e[Symbol.iterator](),t={},n("next"),n("return"),t));class Ad{constructor(t){isMac()?this.gutterTip=window.siyuan.languages.gutterTip:this.gutterTip=window.siyuan.languages.gutterTip.replace(/⌘/g,"Ctrl+").replace(/⌥/g,"Alt+").replace(/⇧/g,"Shift+").replace(/⌃/g,"Ctrl+"),this.element=document.createElement("div"),this.element.className="protyle-gutters",this.element.addEventListener("dragstart",n=>{hideTooltip();const s=n.target.parentElement;let a=[],i=[],l;s.dataset.rowId?(l=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-node-id="${s.dataset.nodeId}"]`)).find(r=>{if(!hasClosestByAttribute(r,"data-type","NodeBlockQueryEmbed"))return!0}),l.querySelector(`.av__row[data-id="${s.dataset.rowId}"]`).classList.add("av__row--select"),l.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(r=>{a.push(r.getAttribute("data-id")),i.push(r)})):(a=[s.getAttribute("data-node-id")],i=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),i.length>0?(a=[],i.forEach(r=>{a.push(r.getAttribute("data-node-id"))})):i=[t.wysiwyg.element.querySelector(`[data-node-id="${a[0]}"]`)]);const o=document.createElement("div");o.className=t.wysiwyg.element.className,i.forEach(r=>{if(r.getAttribute("data-type")==="NodeIFrame"){const c=genEmptyElement();c.classList.add("protyle-wysiwyg--select"),getContenteditableElement(c).innerHTML='<svg class="svg"><use xlink:href="#iconLanguage"></use></svg> IFrame',o.append(c)}else o.append(r.cloneNode(!0))}),o.setAttribute("style",`position:fixed;opacity:.1;width:${i[0].clientWidth}px;padding:0;`),document.body.append(o),n.dataTransfer.setDragImage(o,0,0),setTimeout(()=>{o.remove()}),s.style.opacity="0.1",window.siyuan.dragElement=l||t.wysiwyg.element,n.dataTransfer.setData(`${Constants.SIYUAN_DROP_GUTTER}${s.getAttribute("data-type")}${Constants.ZWSP}${s.getAttribute("data-subtype")}${Constants.ZWSP}${a}`,t.wysiwyg.element.innerHTML)}),this.element.addEventListener("dragend",()=>{this.element.querySelectorAll("button").forEach(n=>{n.style.opacity=""}),window.siyuan.dragElement=void 0}),this.element.addEventListener("click",n=>{const s=hasClosestByTag(n.target,"BUTTON");if(!s)return;n.preventDefault(),n.stopPropagation(),hideTooltip();const a=s.getAttribute("data-node-id");if(!a){if(s.getAttribute("disabled"))return;s.setAttribute("disabled","disabled");let l;if(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${(s.previousElementSibling||s.nextElementSibling).getAttribute("data-node-id")}"]`)).find(o=>{if(!hasClosestByAttribute(o.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(o))return l=o,!0}),!l)return;if(n.altKey){let o=!0;Array.from(l.children).find(f=>{if(f.classList.contains("list")&&Array.from(f.children).find(d=>{if(d.classList.contains("li")&&d.getAttribute("fold")!=="1"&&d.childElementCount>3)return o=!1,!0}))return!0});const r=[],c=[];Array.from(l.children).forEach(f=>{f.classList.contains("list")&&Array.from(f.children).forEach(u=>{if(u.classList.contains("li")){o?u.removeAttribute("fold"):u.childElementCount>3&&u.setAttribute("fold","1");const d=u.getAttribute("data-node-id");r.push({action:"setAttrs",id:d,data:JSON.stringify({fold:o?"0":"1"})}),c.push({action:"setAttrs",id:d,data:JSON.stringify({fold:o?"1":"0"})})}})}),transaction(t,r,c),s.removeAttribute("disabled")}else{const o=setFold(t,l);o==="1"?s.firstElementChild.style.transform="":o==="0"&&(s.firstElementChild.style.transform="rotate(90deg)")}hideElements(["select"],t),window.siyuan.menus.menu.remove();return}const i=s.getBoundingClientRect();if(s.dataset.type==="NodeAttributeViewRowMenu"||s.dataset.type==="NodeAttributeViewRow"){const l=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-node-id="${s.dataset.nodeId}"] .av__row[data-id="${s.dataset.rowId}"]`)).find(r=>{if(!hasClosestByAttribute(r,"data-type","NodeBlockQueryEmbed"))return!0});if(!l)return;const o=hasClosestBlock(l);if(!o)return;if(s.dataset.type==="NodeAttributeViewRow"){o.querySelectorAll(".av__cell--select, .av__cell--active").forEach(u=>{var d;u.classList.remove("av__cell--select","av__cell--active"),(d=u.querySelector(".av__drag-fill"))==null||d.remove()});const r=o.getAttribute("data-av-id"),c=[Lute.NewNodeID()],f=n.altKey?l.previousElementSibling.getAttribute("data-id")||"":s.dataset.rowId;transaction(t,[{action:"insertAttrViewBlock",avID:r,previousID:f,srcIDs:c,isDetached:!0}],[{action:"removeAttrViewBlock",srcIDs:c,avID:r}]),insertAttrViewBlockAnimation(t,o,c,f,r)}else avContextmenu(t,l,{x:i.left,y:i.bottom,w:i.width,h:i.height,isLeft:!0});return}if(isOnlyMeta(n))zoomOut({protyle:t,id:a});else if(n.altKey&&!t.disabled){let l;if(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${a}"]`)).find(o=>{if(!hasClosestByAttribute(o.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(o))return l=o,!0}),!l)return;if(s.getAttribute("data-type")==="NodeListItem"&&l.parentElement.getAttribute("data-node-id")){let o=!0;Array.from(l.parentElement.children).find(f=>{if(f.classList.contains("li")&&f.getAttribute("fold")!=="1"&&f.childElementCount>3)return o=!1,!0});const r=[],c=[];Array.from(l.parentElement.children).find(f=>{if(f.classList.contains("li")){o?f.removeAttribute("fold"):f.childElementCount>3&&f.setAttribute("fold","1");const u=f.getAttribute("data-node-id");r.push({action:"setAttrs",id:u,data:JSON.stringify({fold:o?"0":"1"})}),c.push({action:"setAttrs",id:u,data:JSON.stringify({fold:o?"1":"0"})})}}),transaction(t,r,c)}else setFold(t,l);l.classList.remove("protyle-wysiwyg--hl")}else window.siyuan.shiftIsPressed&&!t.disabled?openAttr(t.wysiwyg.element.querySelector(`[data-node-id="${a}"]`),"bookmark",t):!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed&&(this.renderMenu(t,s),t.toolbar.range||(t.toolbar.range=getEditorRange(t.wysiwyg.element.firstElementChild)),isMobile()?window.siyuan.menus.menu.fullscreen():(window.siyuan.menus.menu.popup({x:i.left,y:i.bottom,isLeft:!0}),window.siyuan.menus.menu.element.setAttribute("data-from",hasClosestByClassName(t.element,"block__edit")?"popover":"app"),focusByRange(t.toolbar.range)))}),this.element.addEventListener("contextmenu",n=>{const s=hasClosestByTag(n.target,"BUTTON");if(!(!s||s.getAttribute("data-type")==="fold")){if(!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed){hideTooltip();const a=s.getBoundingClientRect();if(s.dataset.type==="NodeAttributeViewRowMenu"){const i=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-node-id="${s.dataset.nodeId}"] .av__row[data-id="${s.dataset.rowId}"]`)).find(l=>{if(!hasClosestByAttribute(l,"data-type","NodeBlockQueryEmbed"))return!0});i&&avContextmenu(t,i,{x:a.left,y:a.bottom,w:a.width,h:a.height,isLeft:!0})}else s.dataset.type!=="NodeAttributeViewRow"&&(this.renderMenu(t,s),window.siyuan.menus.menu.popup({x:a.left,y:a.bottom,isLeft:!0}),window.siyuan.menus.menu.element.setAttribute("data-from",hasClosestByClassName(t.element,"block__edit")?"popover":"app"))}n.preventDefault(),n.stopPropagation()}}),this.element.addEventListener("mouseover",n=>{const s=hasClosestByTag(n.target,"BUTTON");if(!s)return;const a=s.getAttribute("data-type");if(a==="fold"||a==="NodeAttributeViewRow"){Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(i=>{i.classList.remove("protyle-wysiwyg--hl","av__row--hl")});return}Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.getAttribute("data-node-id")}"]`)).find(i=>{if(!hasClosestByAttribute(i.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(i)){const l=i.querySelector(`.av__row[data-id="${s.dataset.rowId}"]`);return Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, av__row--hl")).forEach(o=>{i.isSameNode(o)||o.classList.remove("protyle-wysiwyg--hl"),l&&!l.isSameNode(o)&&l.classList.remove("av__row--hl")}),a==="NodeAttributeViewRowMenu"?l.classList.add("av__row--hl"):i.classList.add("protyle-wysiwyg--hl"),!0}}),n.preventDefault()}),this.element.addEventListener("mouseleave",n=>{Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(s=>{s.classList.remove("protyle-wysiwyg--hl","av__row--hl")}),n.preventDefault(),n.stopPropagation()})}isMatchNode(t){const n=t.getBoundingClientRect();let s=this.element.getBoundingClientRect().top+4;return n.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&(s=s-(n.height-this.element.clientHeight)/2),n.top<=s&&n.bottom>=s}turnsOneInto(t){return{icon:t.icon,label:t.label,accelerator:t.accelerator,click(){return wi(this,null,function*(){var n,s;if(t.nodeElement.querySelector("wbr")||(n=getContenteditableElement(t.nodeElement))==null||n.insertAdjacentHTML("afterbegin","<wbr>"),t.type==="CancelList"||t.type==="CancelBlockquote")try{for(var a=_i(t.nodeElement.querySelectorAll('[data-type="NodeHeading"][fold="1"]')),i,l,o;i=!(l=yield a.next()).done;i=!1){const d=l.value,g=d.getAttribute("data-node-id");d.removeAttribute("fold");const p=yield fetchSyncPost("/api/transactions",{session:t.protyle.id,app:Constants.SIYUAN_APPID,transactions:[{doOperations:[{action:"unfoldHeading",id:g}],undoOperations:[{action:"foldHeading",id:g}]}]});t.protyle.undo.add([{action:"unfoldHeading",id:g}],[{action:"foldHeading",id:g}]),d.insertAdjacentHTML("afterend",p.data[0].doOperations[0].retData)}}catch(d){o=[d]}finally{try{i&&(l=a.return)&&(yield l.call(a))}finally{if(o)throw o[0]}}const r=t.nodeElement.outerHTML,c=(s=t.nodeElement.previousElementSibling)==null?void 0:s.getAttribute("data-node-id"),f=t.nodeElement.parentElement.getAttribute("data-node-id")||t.protyle.block.parentID,u=t.protyle.lute[t.type](t.nodeElement.outerHTML,t.level);if(t.nodeElement.outerHTML=u,t.type==="CancelList"||t.type==="CancelBlockquote"){const d=document.createElement("template");d.innerHTML=u;const g=[{action:"delete",id:t.id}],p=[];let b=c;Array.from(d.content.children).forEach(m=>{const h=m.getAttribute("data-node-id");g.push({action:"insert",data:m.outerHTML,id:h,previousID:b,parentID:f}),p.push({action:"delete",id:h}),b=h}),p.push({action:"insert",data:r,id:t.id,previousID:c,parentID:f}),transaction(t.protyle,g,p)}else updateTransaction(t.protyle,t.id,u,r);focusByWbr(t.protyle.wysiwyg.element,getEditorRange(t.protyle.wysiwyg.element)),t.protyle.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(d=>{d.textContent===""&&fetchPost("/api/block/getRefText",{id:d.getAttribute("data-id")},g=>{d.innerHTML=g.data})}),blockRender(t.protyle,t.protyle.wysiwyg.element),processRender(t.protyle.wysiwyg.element),highlightRender(t.protyle.wysiwyg.element),avRender(t.protyle.wysiwyg.element,t.protyle)})}}}turnsIntoOne(t){return{icon:t.icon,label:t.label,accelerator:t.accelerator,click(){turnsIntoOneTransaction(t)}}}turnsInto(t){return{icon:t.icon,label:t.label,accelerator:t.accelerator,click(){turnsIntoTransaction(t)}}}showMobileAppearance(t){const n=document.getElementById("keyboardToolbar"),s=n.querySelectorAll("#keyboardToolbar .keyboard__dynamic");s[0].classList.add("fn__none"),s[1].classList.remove("fn__none"),n.querySelector('.keyboard__action[data-type="text"]').classList.add("protyle-toolbar__item--current"),n.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound"),n.classList.remove("fn__none");const a=t.contentElement.scrollTop+333.5;renderTextMenu(t,n),showKeyboardToolbarUtil(a)}renderMultipleMenu(t,n){var s;let a=!1,i=!1,l=!1;if(n.find((f,u)=>{if(f.classList.contains("li"))return a=!0,!0;if((f.classList.contains("sb")||f.classList.contains("p"))&&(l=!0),f.nextElementSibling&&n[u+1]&&f.nextElementSibling.isSameNode(n[u+1]))i=!0;else if(u!==n.length-1)return i=!1,!0}),!a&&!t.disabled){const f=[];i&&(f.push(this.turnsIntoOne({icon:"iconList",label:window.siyuan.languages.list,protyle:t,selectsElement:n,type:"Blocks2ULs"})),f.push(this.turnsIntoOne({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:t,selectsElement:n,type:"Blocks2OLs"})),f.push(this.turnsIntoOne({icon:"iconCheck",label:window.siyuan.languages.check,protyle:t,selectsElement:n,type:"Blocks2TLs"})),f.push(this.turnsIntoOne({icon:"iconQuote",label:window.siyuan.languages.quote,protyle:t,selectsElement:n,type:"Blocks2Blockquote"}))),l||f.push(this.turnsInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,selectsElement:n,type:"Blocks2Ps",isContinue:i})),f.push(this.turnsInto({icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:t,selectsElement:n,level:1,type:"Blocks2Hs",isContinue:i})),f.push(this.turnsInto({icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:t,selectsElement:n,level:2,type:"Blocks2Hs",isContinue:i})),f.push(this.turnsInto({icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:t,selectsElement:n,level:3,type:"Blocks2Hs",isContinue:i})),f.push(this.turnsInto({icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:t,selectsElement:n,level:4,type:"Blocks2Hs",isContinue:i})),f.push(this.turnsInto({icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:t,selectsElement:n,level:5,type:"Blocks2Hs",isContinue:i})),f.push(this.turnsInto({icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:t,selectsElement:n,level:6,type:"Blocks2Hs",isContinue:i})),window.siyuan.menus.menu.append(new MenuItem({icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:f}).element),i&&window.siyuan.menus.menu.append(new MenuItem({icon:"iconSuper",label:window.siyuan.languages.merge+" "+window.siyuan.languages.superBlock,type:"submenu",submenu:[this.turnsIntoOne({label:window.siyuan.languages.hLayout,accelerator:window.siyuan.config.keymap.editor.general.hLayout.custom,icon:"iconSplitLR",protyle:t,selectsElement:n,type:"BlocksMergeSuperBlock",level:"col"}),this.turnsIntoOne({label:window.siyuan.languages.vLayout,accelerator:window.siyuan.config.keymap.editor.general.vLayout.custom,icon:"iconSplitTB",protyle:t,selectsElement:n,type:"BlocksMergeSuperBlock",level:"row"})]}).element)}t.disabled||AIActions(n,t);const o=[{label:window.siyuan.languages.copy,accelerator:"\u2318C",click(){isNotEditBlock(n[0])?focusBlock(n[0]):focusByRange(getEditorRange(n[0])),document.execCommand("copy")}},{label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let f="";n.forEach(u=>{u.querySelectorAll("[spellcheck]").forEach(d=>{f+=d.textContent+`
`})}),copyPlainText(f.trimEnd())}},{label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,disabled:t.disabled,click(){duplicateBlock(n,t)}}],r=this.genCopyTextRef(n);if(r&&o.splice(2,0,r),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:o}).element),t.disabled)return;window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.cut,accelerator:"\u2318X",icon:"iconCut",click:()=>{var f;if(isNotEditBlock(n[0])){let u="";n.forEach(d=>{u+=removeEmbed(d)}),writeText(t.lute.BlockDOM2StdMd(u).trimEnd()),(f=t.breadcrumb)==null||f.hide(),removeBlock(t,n[0],getEditorRange(n[0]))}else focusByRange(getEditorRange(n[0])),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{movePathTo(f=>{hintMoveBlock(f[0],n,t)})}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"\u232B",click:()=>{var f;(f=t.breadcrumb)==null||f.hide(),removeBlock(t,n[0],getEditorRange(n[0]))}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element);const c=new MenuItem({label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{this.showMobileAppearance(t)}}).element;return window.siyuan.menus.menu.append(c),isMobile()||c.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign(n,t),this.genWidths(n,t),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,iconHTML:'<svg class="b3-menu__icon" style="color:var(--b3-theme-primary)"><use xlink:href="#iconRiffCard"></use></svg>',icon:"iconRiffCard",click(){quickMakeCard(t,n)}}).element),window.siyuan.config.flashcard.deck&&window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.addToDeck,icon:"iconRiffCard",click(){const f=[];n.forEach(u=>{u.getAttribute("data-type")!=="NodeThematicBreak"&&f.push(u.getAttribute("data-node-id"))}),makeCard(t.app,f)}}).element),(s=t==null?void 0:t.app)!=null&&s.plugins&&emitOpenMenu({plugins:t.app.plugins,type:"click-blockicon",detail:{protyle:t,blockElements:n},separatorPosition:"top"}),window.siyuan.menus.menu}renderMenu(t,n){var s,a;if(!n)return;hideElements(["util","toolbar","hint"],t),window.siyuan.menus.menu.remove(),isMobile()&&activeBlur();const i=n.getAttribute("data-node-id"),l=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(l.length>1&&Array.from(l).find(b=>{if(i===b.getAttribute("data-node-id"))return!0}))return this.renderMultipleMenu(t,Array.from(l));let o;if(n.tagName==="BUTTON"?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${i}"]`)).find(p=>{if(!hasClosestByAttribute(p.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(p))return o=p,!0}):o=n,!o)return;const r=o.getAttribute("data-type"),c=o.getAttribute("data-subtype"),f=[];hideElements(["select"],t),o.classList.add("protyle-wysiwyg--select"),countBlockWord([i],t.block.rootID),r==="NodeParagraph"&&!t.disabled?(f.push(this.turnsIntoOne({icon:"iconList",label:window.siyuan.languages.list,protyle:t,selectsElement:[o],type:"Blocks2ULs"})),f.push(this.turnsIntoOne({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:t,selectsElement:[o],type:"Blocks2OLs"})),f.push(this.turnsIntoOne({icon:"iconCheck",label:window.siyuan.languages.check,protyle:t,selectsElement:[o],type:"Blocks2TLs"})),f.push(this.turnsIntoOne({icon:"iconQuote",label:window.siyuan.languages.quote,protyle:t,selectsElement:[o],type:"Blocks2Blockquote"})),f.push(this.turnsInto({icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:t,selectsElement:[o],level:1,type:"Blocks2Hs"})),f.push(this.turnsInto({icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:t,selectsElement:[o],level:2,type:"Blocks2Hs"})),f.push(this.turnsInto({icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:t,selectsElement:[o],level:3,type:"Blocks2Hs"})),f.push(this.turnsInto({icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:t,selectsElement:[o],level:4,type:"Blocks2Hs"})),f.push(this.turnsInto({icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:t,selectsElement:[o],level:5,type:"Blocks2Hs"})),f.push(this.turnsInto({icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:t,selectsElement:[o],level:6,type:"Blocks2Hs"}))):r==="NodeHeading"&&!t.disabled?(f.push(this.turnsInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,selectsElement:[o],type:"Blocks2Ps"})),c!=="h1"&&f.push(this.turnsInto({icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:t,selectsElement:[o],level:1,type:"Blocks2Hs"})),c!=="h2"&&f.push(this.turnsInto({icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:t,selectsElement:[o],level:2,type:"Blocks2Hs"})),c!=="h3"&&f.push(this.turnsInto({icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:t,selectsElement:[o],level:3,type:"Blocks2Hs"})),c!=="h4"&&f.push(this.turnsInto({icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:t,selectsElement:[o],level:4,type:"Blocks2Hs"})),c!=="h5"&&f.push(this.turnsInto({icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:t,selectsElement:[o],level:5,type:"Blocks2Hs"})),c!=="h6"&&f.push(this.turnsInto({icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:t,selectsElement:[o],level:6,type:"Blocks2Hs"}))):r==="NodeList"&&!t.disabled?(f.push(this.turnsOneInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,protyle:t,nodeElement:o,id:i,type:"CancelList"})),o.getAttribute("data-subtype")==="o"?(f.push(this.turnsOneInto({icon:"iconList",label:window.siyuan.languages.list,protyle:t,nodeElement:o,id:i,type:"OL2UL"})),f.push(this.turnsOneInto({icon:"iconCheck",label:window.siyuan.languages.check,protyle:t,nodeElement:o,id:i,type:"UL2TL"}))):o.getAttribute("data-subtype")==="t"?(f.push(this.turnsOneInto({icon:"iconList",label:window.siyuan.languages.list,protyle:t,nodeElement:o,id:i,type:"TL2UL"})),f.push(this.turnsOneInto({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:t,nodeElement:o,id:i,type:"TL2OL"}))):(f.push(this.turnsOneInto({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:t,nodeElement:o,id:i,type:"UL2OL"})),f.push(this.turnsOneInto({icon:"iconCheck",label:window.siyuan.languages.check,protyle:t,nodeElement:o,id:i,type:"OL2TL"})))):r==="NodeBlockquote"&&!t.disabled&&f.push(this.turnsOneInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,protyle:t,nodeElement:o,id:i,type:"CancelBlockquote"})),f.length>0&&!t.disabled&&window.siyuan.menus.menu.append(new MenuItem({icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:f}).element),!t.disabled&&!o.classList.contains("hr")&&AIActions([o],t);const u=copySubMenu(i,!0,o).concat([{label:window.siyuan.languages.copy,accelerator:"\u2318C",click(){isNotEditBlock(o)?focusBlock(o):focusByRange(getEditorRange(o)),document.execCommand("copy")}},{label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let p="";o.querySelectorAll("[spellcheck]").forEach(b=>{p+=b.textContent+`
`}),copyPlainText(p.trimEnd())}},{label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,disabled:t.disabled,click(){duplicateBlock([o],t)}}]),d=this.genCopyTextRef([o]);if(d&&u.splice(u.length-1,0,d),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:u}).element),t.disabled||(window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.cut,accelerator:"\u2318X",icon:"iconCut",click:()=>{var p;isNotEditBlock(o)?(writeText(t.lute.BlockDOM2StdMd(removeEmbed(o)).trimEnd()),removeBlock(t,o,getEditorRange(o)),(p=t.breadcrumb)==null||p.hide()):(focusByRange(getEditorRange(o)),document.execCommand("cut"))}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{movePathTo(p=>{hintMoveBlock(p[0],[o],t)})}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"\u232B",click:()=>{var p;(p=t.breadcrumb)==null||p.hide(),removeBlock(t,o,getEditorRange(o))}}).element)),r==="NodeSuperBlock"&&!t.disabled)window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.cancel+" "+window.siyuan.languages.superBlock,click(){const p=cancelSB(t,o);transaction(t,p.doOperations,p.undoOperations),focusBlock(t.wysiwyg.element.querySelector(`[data-node-id="${p.previousId}"]`)),hideElements(["gutter"],t)}}).element);else if(r==="NodeCodeBlock"&&!t.disabled&&!o.getAttribute("data-subtype")){window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element);const p=o.getAttribute("linewrap"),b=o.getAttribute("ligatures"),m=o.getAttribute("linenumber");window.siyuan.menus.menu.append(new MenuItem({type:"submenu",icon:"iconCode",label:window.siyuan.languages.code,submenu:[{iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md31}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${p==="true"||window.siyuan.config.editor.codeLineWrap&&p!=="false"?" checked":""}></div>`,bind(h){h.addEventListener("click",y=>{const k=h.querySelector("input");y.target.tagName!=="INPUT"&&(k.checked=!k.checked),o.setAttribute("linewrap",k.checked.toString()),o.querySelector(".hljs").removeAttribute("data-render"),highlightRender(o),fetchPost("/api/attr/setBlockAttrs",{id:i,attrs:{linewrap:k.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md2}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${b==="true"||window.siyuan.config.editor.codeLigatures&&b!=="false"?" checked":""}></div>`,bind(h){h.addEventListener("click",y=>{const k=h.querySelector("input");y.target.tagName!=="INPUT"&&(k.checked=!k.checked),o.setAttribute("ligatures",k.checked.toString()),o.querySelector(".hljs").removeAttribute("data-render"),highlightRender(o),fetchPost("/api/attr/setBlockAttrs",{id:i,attrs:{ligatures:k.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md27}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${m==="true"||window.siyuan.config.editor.codeSyntaxHighlightLineNum&&m!=="false"?" checked":""}></div>`,bind(h){h.addEventListener("click",y=>{const k=h.querySelector("input");y.target.tagName!=="INPUT"&&(k.checked=!k.checked),o.setAttribute("linenumber",k.checked.toString()),o.querySelector(".hljs").removeAttribute("data-render"),highlightRender(o),fetchPost("/api/attr/setBlockAttrs",{id:i,attrs:{linenumber:k.checked.toString()}}),window.siyuan.menus.menu.remove()})}}]}).element)}else if(r==="NodeCodeBlock"&&!t.disabled&&["echarts","mindmap"].includes(o.getAttribute("data-subtype"))){window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element);const p=o.style.height;let b=o.outerHTML;window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.chart,icon:"iconCode",submenu:[{label:`${window.siyuan.languages.height}<span class="fn__space"></span>
<input style="margin: 4px 0;width: 84px" type="number" step="1" min="148" class="b3-text-field" value="${p?parseInt(p):"420"}">`,bind:m=>{m.querySelector("input").addEventListener("change",h=>{const y=(h.target.value||"420")+"px";o.style.height=y,o.firstElementChild.nextElementSibling.style.height=y,updateTransaction(t,i,o.outerHTML,b),b=o.outerHTML,h.stopPropagation();const k=window.echarts.getInstanceById(o.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));k&&k.resize()})}},{label:window.siyuan.languages.update,icon:"iconEdit",click(){t.toolbar.showRender(t,o)}}]}).element)}else if(r==="NodeTable"&&!t.disabled){let p=getEditorRange(o);const b=o.querySelector("table");b.contains(p.startContainer)||(p=getEditorRange(b.querySelector("th")));const m=hasClosestByMatchTag(p.startContainer,"TD")||hasClosestByMatchTag(p.startContainer,"TH");m&&(window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({type:"submenu",icon:"iconTable",label:window.siyuan.languages.table,submenu:tableMenu(t,o,m,p)}).element))}else if(r==="NodeAttributeView"&&!t.disabled)window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconDatabase",label:window.siyuan.languages.export+" CSV",click(){fetchPost("/api/export/exportAttributeView",{id:o.getAttribute("data-av-id")},p=>{openByMobile(p.data.zip)})}}).element);else if((r==="NodeVideo"||r==="NodeAudio")&&!t.disabled)window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"assetSubMenu",type:"submenu",icon:r==="NodeVideo"?"iconVideo":"iconRecord",label:window.siyuan.languages.assets,submenu:videoMenu(t,o,r)}).element);else if(r==="NodeIFrame"&&!t.disabled)window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"assetSubMenu",type:"submenu",icon:"iconLanguage",label:window.siyuan.languages.assets,submenu:iframeMenu(t,o)}).element);else if(r==="NodeHTMLBlock"&&!t.disabled)window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconHTML5",label:"HTML",click(){t.toolbar.showRender(t,o)}}).element);else if(r==="NodeBlockQueryEmbed"&&!t.disabled){window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element);const p=o.getAttribute("breadcrumb");window.siyuan.menus.menu.append(new MenuItem({id:"assetSubMenu",type:"submenu",icon:"iconSQL",label:window.siyuan.languages.blockEmbed,submenu:[{icon:"iconRefresh",label:`${window.siyuan.languages.refresh} SQL`,click(){o.removeAttribute("data-render"),blockRender(t,o)}},{icon:"iconEdit",label:`${window.siyuan.languages.update} SQL`,click(){t.toolbar.showRender(t,o)}},{type:"separator"},{label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.embedBlockBreadcrumb}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${p==="true"||window.siyuan.config.editor.embedBlockBreadcrumb&&p!=="false"?" checked":""}></div>`,bind(b){b.addEventListener("click",m=>{const h=b.querySelector("input");m.target.tagName!=="INPUT"&&(h.checked=!h.checked),o.setAttribute("breadcrumb",h.checked.toString()),fetchPost("/api/attr/setBlockAttrs",{id:i,attrs:{breadcrumb:h.checked.toString()}}),o.removeAttribute("data-render"),blockRender(t,o),window.siyuan.menus.menu.remove()})}},{label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.hideHeadingBelowBlocks}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${o.getAttribute("custom-heading-mode")==="1"?" checked":""}></div>`,bind(b){b.addEventListener("click",m=>{const h=b.querySelector("input");m.target.tagName!=="INPUT"&&(h.checked=!h.checked),o.setAttribute("custom-heading-mode",h.checked?"1":"0"),fetchPost("/api/attr/setBlockAttrs",{id:i,attrs:{"custom-heading-mode":h.checked?"1":"0"}}),o.removeAttribute("data-render"),blockRender(t,o),window.siyuan.menus.menu.remove()})}}]}).element)}else if(r==="NodeHeading"&&!t.disabled){window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element);const p=[];c!=="h1"&&p.push(this.genHeadingTransform(t,i,1)),c!=="h2"&&p.push(this.genHeadingTransform(t,i,2)),c!=="h3"&&p.push(this.genHeadingTransform(t,i,3)),c!=="h4"&&p.push(this.genHeadingTransform(t,i,4)),c!=="h5"&&p.push(this.genHeadingTransform(t,i,5)),c!=="h6"&&p.push(this.genHeadingTransform(t,i,6)),window.siyuan.menus.menu.append(new MenuItem({type:"submenu",icon:"iconRefresh",label:window.siyuan.languages.tWithSubtitle,submenu:p}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconCopy",label:`${window.siyuan.languages.copy} ${window.siyuan.languages.headings1}`,click(){fetchPost("/api/block/getHeadingChildrenDOM",{id:i},b=>{writeText(b.data+Constants.ZWSP)})}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconCut",label:`${window.siyuan.languages.cut} ${window.siyuan.languages.headings1}`,click(){fetchPost("/api/block/getHeadingChildrenDOM",{id:i},b=>{writeText(b.data+Constants.ZWSP),fetchPost("/api/block/getHeadingDeleteTransaction",{id:i},m=>{m.data.doOperations.forEach(h=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${h.id}"]`).forEach(y=>{y.remove()})}),transaction(t,m.data.doOperations,m.data.undoOperations)})})}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",label:`${window.siyuan.languages.delete} ${window.siyuan.languages.headings1}`,click(){fetchPost("/api/block/getHeadingDeleteTransaction",{id:i},b=>{b.data.doOperations.forEach(m=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${m.id}"]`).forEach(h=>{h.remove()})}),transaction(t,b.data.doOperations,b.data.undoOperations)})}}).element)}if(window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),t.options.backlinkData||(window.siyuan.menus.menu.append(new MenuItem({accelerator:`${updateHotkeyTip(window.siyuan.config.keymap.general.enter.custom)}/${updateHotkeyTip("\u2318Click")}`,label:window.siyuan.languages.enter,click:()=>{zoomOut({protyle:t,id:i})}}).element),window.siyuan.menus.menu.append(new MenuItem({accelerator:window.siyuan.config.keymap.general.enterBack.custom,label:window.siyuan.languages.enterBack,click:()=>{enterBack(t,i)}}).element)),!t.disabled){window.siyuan.menus.menu.append(new MenuItem({icon:"iconBefore",label:window.siyuan.languages["insert-before"],accelerator:window.siyuan.config.keymap.editor.general.insertBefore.custom,click(){hideElements(["select"],t),countBlockWord([],t.block.rootID),insertEmptyBlock(t,"beforebegin",i)}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAfter",label:window.siyuan.languages["insert-after"],accelerator:window.siyuan.config.keymap.editor.general.insertAfter.custom,click(){hideElements(["select"],t),countBlockWord([],t.block.rootID),insertEmptyBlock(t,"afterend",i)}}).element);const p=o.lastElementChild.querySelector(".protyle-attr--refcount");p&&p.textContent&&transferBlockRef(i)}if(window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.jumpToParentNext,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,click(){hideElements(["select"],t),jumpToParentNext(t,o)}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),r!=="NodeThematicBreak"&&(window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.fold,accelerator:`${updateHotkeyTip(window.siyuan.config.keymap.editor.general.collapse.custom)}/${updateHotkeyTip("\u2325Click")}`,click(){setFold(t,o),focusBlock(o)}}).element),t.disabled||window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+updateHotkeyTip("\u21E7Click"),click(){openAttr(o,"bookmark",t)}}).element)),!t.disabled){const p=new MenuItem({label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{this.showMobileAppearance(t)}}).element;window.siyuan.menus.menu.append(p),isMobile()||p.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign([o],t),this.genWidths([o],t)}window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),!["NodeThematicBreak","NodeBlockQueryEmbed","NodeIFrame","NodeHTMLBlock","NodeWidget","NodeVideo","NodeAudio"].includes(r)&&((s=getContenteditableElement(o))==null?void 0:s.textContent.trim())!==""&&(r!=="NodeCodeBlock"||r==="NodeCodeBlock"&&!o.getAttribute("data-subtype"))&&window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.wechatReminder,icon:"iconMp",click(){openWechatNotify(o)}}).element),r!=="NodeThematicBreak"&&(window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,iconHTML:'<svg class="b3-menu__icon" style="color:var(--b3-theme-primary)"><use xlink:href="#iconRiffCard"></use></svg>',icon:"iconRiffCard",click(){quickMakeCard(t,[o])}}).element),window.siyuan.config.flashcard.deck&&window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.addToDeck,icon:"iconRiffCard",click(){makeCard(t.app,[o.getAttribute("data-node-id")])}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element)),(a=t==null?void 0:t.app)!=null&&a.plugins&&emitOpenMenu({plugins:t.app.plugins,type:"click-blockicon",detail:{protyle:t,blockElements:[o]},separatorPosition:"bottom"});let g=o.getAttribute("updated")||"";return g&&(g=`${window.siyuan.languages.modifiedAt} ${dayjs(g).format("YYYY-MM-DD HH:mm:ss")}<br>`),window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,type:"readonly",label:`${g}${window.siyuan.languages.createdAt} ${dayjs(i.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu}genHeadingTransform(t,n,s){return{iconHTML:"",icon:"iconHeading"+s,label:window.siyuan.languages["heading"+s],click(){fetchPost("/api/block/getHeadingLevelTransaction",{id:n,level:s},a=>{a.data.doOperations.forEach((i,l)=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`).forEach(o=>{o.outerHTML=i.data}),t.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`).forEach(o=>{mathRender(o)}),l===0&&focusBlock(t.wysiwyg.element.querySelector(`[data-node-id="${i.id}"]`),t.wysiwyg.element,!0)}),transaction(t,a.data.doOperations,a.data.undoOperations)})}}}genClick(t,n,s){updateBatchTransaction(t,n,s),focusBlock(t[0])}genAlign(t,n){window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.layout,type:"submenu",submenu:[{label:window.siyuan.languages.alignLeft,icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click:()=>{this.genClick(t,n,s=>{s.classList.contains("av")?s.style.justifyContent="":s.style.textAlign="left"})}},{label:window.siyuan.languages.alignCenter,icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{this.genClick(t,n,s=>{s.classList.contains("av")?s.style.justifyContent="center":s.style.textAlign="center"})}},{label:window.siyuan.languages.alignRight,icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{this.genClick(t,n,s=>{s.classList.contains("av")?s.style.justifyContent="flex-end":s.style.textAlign="right"})}},{label:window.siyuan.languages.justify,icon:"iconMenu",click:()=>{this.genClick(t,n,s=>{s.style.textAlign="justify"})}},{type:"separator"},{label:window.siyuan.languages.ltr,icon:"iconLtr",click:()=>{this.genClick(t,n,s=>{s.style.direction="ltr"})}},{label:window.siyuan.languages.rtl,icon:"iconRtl",click:()=>{this.genClick(t,n,s=>{s.classList.contains("av")||(s.style.direction="rtl")})}},{type:"separator"},{label:window.siyuan.languages.clearFontStyle,icon:"iconTrashcan",click:()=>{this.genClick(t,n,s=>{s.classList.contains("av")?s.style.justifyContent="":(s.style.textAlign="",s.style.direction="")})}}]}).element)}genWidths(t,n){const s=[];["25%","33%","50%","67%","75%"].forEach(i=>{s.push({label:i,click:()=>{this.genClick(t,n,l=>{l.style.width=i,l.style.flex="none"})}})}),s.push({type:"separator"});let a=100;if(t.length===1){const i=t[0].style.width;i.endsWith("%")&&(a=parseInt(i))}window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.width,submenu:s.concat([{label:`<div aria-label="${a}%" class="b3-tooltips b3-tooltips__n${isMobile()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${a}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind(i){const l=i.querySelector("input");l.addEventListener("input",()=>{t.forEach(c=>{c.style.width=l.value+"%",c.style.flex="none"}),l.parentElement.setAttribute("aria-label",`${l.value}%`)});const o=[],r=[];t.forEach(c=>{o.push({action:"update",id:c.getAttribute("data-node-id"),data:c.outerHTML})}),l.addEventListener("change",()=>{t.forEach(c=>{r.push({action:"update",id:c.getAttribute("data-node-id"),data:c.outerHTML})}),transaction(n,r,o),window.siyuan.menus.menu.remove(),focusBlock(t[0])})}},{type:"separator"},{label:window.siyuan.languages.clearFontStyle,icon:"iconTrashcan",click:()=>{this.genClick(t,n,i=>{i.style.width&&(i.style.width="",i.style.flex="")})}}])}).element)}genCopyTextRef(t){return isNotEditBlock(t[0])?!1:{accelerator:window.siyuan.config.keymap.editor.general.copyText.custom,label:window.siyuan.languages.copyText,click(){t[0].setAttribute("data-reftext","true"),focusByRange(getEditorRange(t[0])),document.execCommand("copy")}}}render(t,n,s,a){const i=s.parentElement.querySelector(".protyle-title__input");if(i&&i.getAttribute("data-render")!=="true")return;const l=s.parentElement.parentElement.querySelector(".protyle-select");if(l&&!l.classList.contains("fn__none"))return;let o="",r=n,c=0,f=0,u,d=!1;for(;r;){const k=!d||d&&r.getAttribute("fold")==="1";if(!hasClosestByAttribute(r.parentElement,"data-type","NodeBlockQueryEmbed")){let v;k&&(v=r.getAttribute("data-type"));const S=r.getAttribute("data-node-id");if(v==="NodeAttributeView"&&a){const C=hasClosestByClassName(a,"av__row");if(C&&!C.classList.contains("av__row--header")){n=C,o=`<button data-type="NodeAttributeViewRowMenu" data-node-id="${S}" data-row-id="${C.dataset.id}" class="ariaLabel" data-position="right" aria-label="${window.siyuan.languages.rowTip}"><svg><use xlink:href="#iconDrag"></use></svg><span ${t.disabled?"":'draggable="true" class="fn__grab"'}></span></button>`,t.disabled||(o=`<button data-type="NodeAttributeViewRow" data-node-id="${S}" data-row-id="${C.dataset.id}" class="ariaLabel" data-position="right" aria-label="${isMac()?window.siyuan.languages.addBelowAbove:window.siyuan.languages.addBelowAbove.replace("\u2325","Alt+")}"><svg><use xlink:href="#iconAdd"></use></svg></button>${o}`);break}}if(f===0){if(["NodeBlockquote","NodeList","NodeSuperBlock"].includes(v))return;const C=getTopAloneElement(r);u=C.querySelector(".li")||C.querySelector(".list"),hasClosestByAttribute(u,"data-type","NodeBlockQueryEmbed")&&(u=void 0),!C.isSameNode(r)&&v!=="NodeHeading"&&(r=C,v=r.getAttribute("data-type"))}v==="NodeListItem"&&f===1&&!k&&(o=""),f+=1;const w=`<button class="ariaLabel" data-position="right" aria-label="${this.gutterTip}" 
data-type="${v}" data-subtype="${r.getAttribute("data-subtype")}" data-node-id="${r.getAttribute("data-node-id")}">
    <svg><use xlink:href="#${getIconByType(v,r.getAttribute("data-subtype"))}"></use></svg>
    <span ${t.disabled?"":'draggable="true"'}></span>
</button>`;k&&(o=w+o);let _="";if(v==="NodeListItem"&&r.childElementCount>3||v==="NodeHeading"){const C=r.getAttribute("fold");_=`<button class="ariaLabel" data-position="right" aria-label="${window.siyuan.languages.fold}" 
data-type="fold"><svg style="width:10px${C&&C==="1"?"":";transform:rotate(90deg)"}"><use xlink:href="#iconPlay"></use></svg></button>`}(v==="NodeListItem"||v==="NodeList")&&(u=r,v==="NodeListItem"&&r.childElementCount>3&&(o=w+_)),v==="NodeHeading"&&(o=o+_),v==="NodeBlockquote"&&(c+=8),r.previousElementSibling&&r.previousElementSibling.getAttribute("data-node-id")&&(d=!0)}const A=hasClosestBlock(r.parentElement);if(A)r=A;else break}let g=!0;const p=this.element.querySelectorAll("button");if(p.length!==o.split("</button>").length-1?g=!1:Array.from(p).find(k=>{const E=k.getAttribute("data-node-id");if(E&&o.indexOf(E)===-1)return g=!1,!0;const A=k.getAttribute("data-row-id");if(A&&o.indexOf(A)===-1||!A&&o.indexOf("NodeAttributeViewRowMenu")>-1)return g=!1,!0}),g&&this.element.childElementCount>0){this.element.classList.remove("fn__none");return}this.element.innerHTML=o,this.element.classList.remove("fn__none"),this.element.style.width="";const b=s.parentElement.getBoundingClientRect().top;let m=n.getBoundingClientRect(),h=0;u?(m=u.firstElementChild.getBoundingClientRect(),c=0):r.getAttribute("data-type")==="NodeBlockQueryEmbed"?(m=r.getBoundingClientRect(),c=0):n.classList.contains("av__row")||(m.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8||m.height>Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&m.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)*2+8?h=(m.height-this.element.clientHeight)/2:(r.getAttribute("data-type")==="NodeAttributeView"||n.getAttribute("data-type")==="NodeAttributeView")&&b<m.top&&(h=8)),this.element.style.top=`${Math.max(m.top,b)+h}px`;let y=m.left-this.element.clientWidth-c;(r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&this.element.childElementCount===1||n.classList.contains("av__row"))&&(y=r.getBoundingClientRect().left-this.element.clientWidth-c),this.element.style.left=`${y}px`,y<this.element.parentElement.getBoundingClientRect().left?(this.element.style.width="24px",this.element.style.left=`${m.left-this.element.clientWidth-c/2+3}px`,o="",Array.from(this.element.children).reverse().forEach((k,E)=>{E!==0&&(k.firstElementChild.style.height="14px"),o+=k.outerHTML}),this.element.innerHTML=o):this.element.querySelectorAll("svg").forEach(k=>{k.style.height=""})}}const vi=(e,t)=>{if(window.siyuan.config.fileTree.removeDocWithoutConfirm){fetchPost("/api/filetree/removeDoc",{notebook:e,path:t});return}fetchPost("/api/block/getDocInfo",{id:getDisplayName(t,!0,!0)},n=>{const s=escapeHtml(n.data.name);let a=`${window.siyuan.languages.confirmDelete} <b>${s}</b>?`;n.data.subFileCount>0&&(a=`${window.siyuan.languages.confirmDelete} <b>${s}</b> ${window.siyuan.languages.andSubFile.replace("x",n.data.subFileCount)}?`),confirmDialog(window.siyuan.languages.deleteOpConfirm,a,()=>{fetchPost("/api/filetree/removeDoc",{notebook:e,path:t})})})},Ld=e=>{if(e.length===1){const t=hasTopClosestByTag(e[0],"UL");if(t){const n=t.getAttribute("data-url");e[0].getAttribute("data-type")==="navigation-file"?vi(n,e[0].getAttribute("data-path")):confirmDialog(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${Lute.EscapeHTMLStr(getNotebookName(n))}</b>?`,()=>{fetchPost("/api/notebook/removeNotebook",{notebook:n,callback:Constants.CB_MOUNT_REMOVE})})}}else{const t=[];if(e.forEach(n=>{n.getAttribute("data-path")!=="/"&&t.push(n.getAttribute("data-path"))}),t.length===0){showMessage(window.siyuan.languages.notBatchRemove);return}confirmDialog(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.confirmRemoveAll.replace("${count}",t.length),()=>{fetchPost("/api/filetree/removeDocs",{paths:t})})}};var Dt=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const Ei=(e,t)=>`<span class="ft__error">1</span>
<span class="fn__space"></span>/<span class="fn__space"></span>
<span class="ariaLabel ft__primary" aria-label="${window.siyuan.languages.flashcardNewCard}">${e}</span>
<span class="fn__space"></span>+<span class="fn__space"></span>
<span class="ariaLabel ft__success" aria-label="${window.siyuan.languages.flashcardReviewCard}">${t}</span>`,ki=e=>{let t;return t=`<div class="toolbar toolbar--border">
    <svg class="toolbar__icon"><use xlink:href="#iconRiffCard"></use></svg>
    <span class="fn__flex-1 fn__flex-center toolbar__text">${window.siyuan.languages.riffCard}</span>
    <div data-type="count" class="${e.cardsData.cards.length===0?"fn__none":"fn__flex"}">${Ei(e.cardsData.unreviewedNewCardCount,e.cardsData.unreviewedOldCardCount)}</span></div>
    <svg class="toolbar__icon" data-id="${e.id||""}" data-cardtype="${e.cardType}" data-type="filter"><use xlink:href="#iconFilter"></use></svg>
    <svg class="toolbar__icon" data-type="close"><use xlink:href="#iconCloseRound"></use></svg>
</div>`,`<div class="card__main">
    ${t}
    <div class="card__block fn__flex-1 ${e.cardsData.cards.length===0?"fn__none":""} 
${window.siyuan.config.flashcard.mark?"card__block--hidemark":""} 
${window.siyuan.config.flashcard.superBlock?"card__block--hidesb":""} 
${window.siyuan.config.flashcard.heading?"card__block--hideh":""} 
${window.siyuan.config.flashcard.list?"card__block--hideli":""}" data-type="render"></div>
    <div class="card__empty card__empty--space${e.cardsData.cards.length===0?"":" fn__none"}" data-type="empty">
        <div>\u{1F52E}</div>
        ${window.siyuan.languages.noDueCard}
    </div>
    <div class="fn__flex card__action${e.cardsData.cards.length===0?" fn__none":""}">
        <button class="b3-button b3-button--cancel" disabled="disabled" data-type="-2" style="width: 25%;min-width: 86px;display: flex">
            <svg><use xlink:href="#iconLeft"></use></svg>
            (p)
        </button>
        <span class="fn__space"></span>
        <button data-type="-1" class="b3-button fn__flex-1">${window.siyuan.languages.cardShowAnswer} (${window.siyuan.languages.space} / Enter)</button>
    </div>
    <div class="fn__flex card__action fn__none">
        <div>
            <span>${window.siyuan.languages.nextRound}</span>
            <button data-type="-3" aria-label="0" class="b3-button b3-button--cancel b3-tooltips__n b3-tooltips">
                <div>\u{1F4A4}</div>
                ${window.siyuan.languages.skip} (0)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="1" aria-label="1 / j" class="b3-button b3-button--error b3-tooltips__n b3-tooltips">
                <div>\u{1F648}</div>
                ${window.siyuan.languages.cardRatingAgain} (1)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="2" aria-label="2 / k" class="b3-button b3-button--warning b3-tooltips__n b3-tooltips">
                <div>\u{1F62C}</div>
                ${window.siyuan.languages.cardRatingHard} (2)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="3" aria-label="3 / l / ${window.siyuan.languages.space} / Enter" class="b3-button b3-button--info b3-tooltips__n b3-tooltips">
                <div>\u{1F60A}</div>
                ${window.siyuan.languages.cardRatingGood} (3)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="4" aria-label="4 / ;" class="b3-button b3-button--success b3-tooltips__n b3-tooltips">
                <div>\u{1F308}</div>
                ${window.siyuan.languages.cardRatingEasy} (4)
            </button>
        </div>
    </div>
</div>`},Ci=e=>Dt(void 0,null,function*(){for(let o=0;o<e.app.plugins.length;o++)e.cardsData=yield e.app.plugins[o].updateCards(e.cardsData);window.siyuan.storage[Constants.LOCAL_FLASHCARD].fullscreen&&fullscreen(e.element.querySelector(".card__main"),e.element.querySelector('[data-type="fullscreen"]'));let t=0;typeof e.index=="number"&&(t=e.index);const n=new Protyle(e.app,e.element.querySelector("[data-type='render']"),{blockId:"",action:[Constants.CB_GET_ALL],render:{background:!1,title:!1,gutter:!0,breadcrumbDocName:!0},typewriterMode:!1});window.siyuan.mobile&&(window.siyuan.mobile.popEditor=n),e.cardsData.cards.length>0&&fetchPost("/api/block/getDocInfo",{id:e.cardsData.cards[t].blockID},o=>{n.protyle.wysiwyg.renderCustom(o.data.ial),fetchPost("/api/filetree/getDoc",{id:e.cardsData.cards[t].blockID,mode:0,size:Constants.SIZE_GET_MAX},r=>{onGet({updateReadonly:!0,data:r,protyle:n.protyle,action:r.data.rootID===r.data.id?[Constants.CB_GET_HTML]:[Constants.CB_GET_ALL,Constants.CB_GET_HTML]})})}),e.element.setAttribute("data-key",Constants.DIALOG_OPENCARD);const s=e.element.querySelector('[data-type="count"] span');s.innerHTML=(t+1).toString();const a=e.element.querySelectorAll(".card__action");e.index===0?a[0].firstElementChild.setAttribute("disabled","disabled"):a[0].firstElementChild.removeAttribute("disabled");const i=e.element.querySelector('[data-type="filter"]'),l=()=>{const o=i.getAttribute("data-cardtype");fetchPost(o==="all"?"/api/riff/getRiffDueCards":o==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:i.getAttribute("data-id"),deckID:i.getAttribute("data-id"),notebook:i.getAttribute("data-id")},r=>Dt(void 0,null,function*(){t=0,e.cardsData=r.data;for(let c=0;c<e.app.plugins.length;c++)e.cardsData=yield e.app.plugins[c].updateCards(e.cardsData);e.cardsData.cards.length>0?$t({countElement:s,editor:n,actionElements:a,index:t,blocks:e.cardsData.cards}):va(s,n,a)}))};return e.element.addEventListener("click",o=>{const r=o.target;let c="";if(typeof o.detail=="string")o.detail==="1"||o.detail==="j"?c="1":o.detail==="2"||o.detail==="k"?c="2":o.detail==="3"||o.detail==="l"?c="3":o.detail==="4"||o.detail===";"?c="4":o.detail===" "||o.detail==="enter"?c="-1":o.detail==="p"?c="-2":o.detail==="0"&&(c="-3");else{if(hasClosestByAttribute(r,"data-type","fullscreen")){fullscreen(e.element.querySelector(".card__main"),e.element.querySelector('[data-type="fullscreen"]')),resize(n.protyle),window.siyuan.storage[Constants.LOCAL_FLASHCARD].fullscreen=!window.siyuan.storage[Constants.LOCAL_FLASHCARD].fullscreen,setStorageVal(Constants.LOCAL_FLASHCARD,window.siyuan.storage[Constants.LOCAL_FLASHCARD]),o.stopPropagation(),o.preventDefault();return}if(hasClosestByAttribute(r,"data-type","close")){e.dialog&&e.dialog.destroy(),o.stopPropagation(),o.preventDefault();return}const d=hasClosestByAttribute(r,"data-type","filter");if(d){fetchPost("/api/riff/getRiffDecks",{},p=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,label:window.siyuan.languages.all,click(){i.setAttribute("data-id",""),i.setAttribute("data-cardtype","all"),l()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,label:window.siyuan.languages.fileTree,click(){movePathTo((m,h)=>{i.setAttribute("data-id",m[0]==="/"?h[0]:getDisplayName(m[0],!0,!0)),i.setAttribute("data-cardtype",m[0]==="/"?"notebook":"doc"),l()},[],void 0,window.siyuan.languages.specifyPath,!0)}}).element),(e.title||p.data.length>0)&&window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),e.title&&(window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,label:escapeHtml(e.title),click(){i.setAttribute("data-id",e.id),i.setAttribute("data-cardtype",e.cardType),l()}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element)),p.data.forEach(m=>{window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,label:escapeHtml(m.name),click(){i.setAttribute("data-id",m.id),i.setAttribute("data-cardtype","all"),l()}}).element)});const b=d.getBoundingClientRect();window.siyuan.menus.menu.popup({x:b.left,y:b.bottom})}),o.stopPropagation(),o.preventDefault();return}if(hasClosestByAttribute(r,"data-type","newround")){l(),o.stopPropagation(),o.preventDefault();return}}if(!c){const f=hasClosestByClassName(r,"b3-button");f&&(c=f.getAttribute("data-type"))}if(!(!c||!e.cardsData.cards[t])){if(o.preventDefault(),o.stopPropagation(),hideElements(["toolbar","hint","util","gutter"],n.protyle),c==="-1")if(a[0].classList.contains("fn__none"))c="3";else{n.protyle.element.classList.remove("card__block--hidemark","card__block--hideli","card__block--hidesb","card__block--hideh"),a[0].classList.add("fn__none"),a[1].querySelectorAll(".b3-button").forEach((f,u)=>{f.previousElementSibling.textContent=e.cardsData.cards[t].nextDues[u]}),a[1].classList.remove("fn__none");return}else if(c==="-2"){if(a[0].classList.contains("fn__none"))return;t>0&&(t--,$t({countElement:s,editor:n,actionElements:a,index:t,blocks:e.cardsData.cards}));return}["1","2","3","4","-3"].includes(c)&&a[0].classList.contains("fn__none")&&fetchPost(c==="-3"?"/api/riff/skipReviewRiffCard":"/api/riff/reviewRiffCard",{deckID:e.cardsData.cards[t].deckID,cardID:e.cardsData.cards[t].cardID,rating:parseInt(c),reviewedCards:e.cardsData.cards},()=>{if(c!=="-3"&&(window.siyuan.config.sync.provider!==0&&isPaidUser()||window.siyuan.config.sync.provider===0&&!needSubscribe(""))&&window.siyuan.config.repo.key&&window.siyuan.config.sync.enabled&&document.getElementById("toolbarSync").classList.remove("fn__none"),t++,t>e.cardsData.cards.length-1){const f=i.getAttribute("data-cardtype");fetchPost(f==="all"?"/api/riff/getRiffDueCards":f==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:i.getAttribute("data-id"),deckID:i.getAttribute("data-id"),notebook:i.getAttribute("data-id"),reviewedCards:e.cardsData.cards},u=>Dt(void 0,null,function*(){t=0,e.cardsData=u.data;for(let d=0;d<e.app.plugins.length;d++)e.cardsData=yield e.app.plugins[d].updateCards(e.cardsData);e.cardsData.cards.length===0?e.cardsData.unreviewedCount>0?Li(s,n,a,u.data.unreviewedCount):va(s,n,a):$t({countElement:s,editor:n,actionElements:a,index:t,blocks:e.cardsData.cards})}));return}$t({countElement:s,editor:n,actionElements:a,index:t,blocks:e.cardsData.cards})})}}),n}),Sd=e=>{fetchPost("/api/riff/getRiffDueCards",{deckID:""},t=>{Ai(e,t.data,"all")})},Ai=(e,t,n,s,a)=>Dt(void 0,null,function*(){if(window.siyuan.dialogs.find(c=>{if(c.element.getAttribute("data-key")===Constants.DIALOG_OPENCARD)return c.destroy(),!0}))return;let l;getSelection().rangeCount>0&&(l=getSelection().getRangeAt(0));const o=new Dialog({positionId:Constants.DIALOG_OPENCARD,content:ki({id:s,cardType:n,cardsData:t,isTab:!1}),width:isMobile()?"100vw":"80vw",height:isMobile()?"100vh":"70vh",destroyCallback(){r&&(r.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null)),l&&focusByRange(l)}});o.element.querySelector(".b3-dialog__scrim").style.backgroundColor="var(--b3-theme-background)",o.element.querySelector(".b3-dialog__container").style.maxWidth="1024px";const r=yield Ci({app:e,element:o.element,cardsData:t,title:a,id:s,cardType:n,dialog:o});o.editor=r}),$t=e=>{e.editor.protyle.element.classList.add("card__block--hide"),window.siyuan.config.flashcard.superBlock&&e.editor.protyle.element.classList.add("card__block--hidesb"),window.siyuan.config.flashcard.heading&&e.editor.protyle.element.classList.add("card__block--hideh"),window.siyuan.config.flashcard.list&&e.editor.protyle.element.classList.add("card__block--hideli"),window.siyuan.config.flashcard.mark&&e.editor.protyle.element.classList.add("card__block--hidemark"),e.actionElements[0].classList.remove("fn__none"),e.actionElements[1].classList.add("fn__none"),e.editor.protyle.element.classList.remove("fn__none"),e.editor.protyle.element.nextElementSibling.classList.add("fn__none"),e.countElement.innerHTML=(e.index+1).toString(),e.countElement.parentElement.classList.remove("fn__none"),e.index===0?e.actionElements[0].firstElementChild.setAttribute("disabled","disabled"):e.actionElements[0].firstElementChild.removeAttribute("disabled"),fetchPost("/api/block/getDocInfo",{id:e.blocks[e.index].blockID},t=>{e.editor.protyle.wysiwyg.renderCustom(t.data.ial),fetchPost("/api/filetree/getDoc",{id:e.blocks[e.index].blockID,mode:0,size:Constants.SIZE_GET_MAX},n=>{onGet({updateReadonly:!0,data:n,protyle:e.editor.protyle,action:n.data.rootID===n.data.id?[Constants.CB_GET_HTML]:[Constants.CB_GET_ALL,Constants.CB_GET_HTML]})})})},va=(e,t,n)=>{e.parentElement.classList.add("fn__none"),t.protyle.element.classList.add("fn__none");const s=t.protyle.element.nextElementSibling;s.innerHTML=`<div>\u{1F52E}</div>${window.siyuan.languages.noDueCard}`,s.classList.remove("fn__none"),n[0].classList.add("fn__none"),n[1].classList.add("fn__none")},Li=(e,t,n,s)=>{e.parentElement.classList.add("fn__none"),t.protyle.element.classList.add("fn__none");const a=t.protyle.element.nextElementSibling;a.innerHTML=`<div>\u267B\uFE0F </div>
<span>${window.siyuan.languages.continueReview2.replace("${count}",s)}</span>
<div class="fn__hr"></div>
<button data-type="newround" class="b3-button fn__size200">${window.siyuan.languages.continueReview1}</button>`,a.classList.remove("fn__none"),n[0].classList.add("fn__none"),n[1].classList.add("fn__none")};let wt,_t=!1;const gn=(e,t,n)=>{const s=e.querySelector('[data-type="docprevious"]'),a=e.querySelector('[data-type="docnext"]');e.setAttribute("data-page",t.toString()),t>1?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled");const i=e.querySelector('.b3-select[data-type="opselect"]'),l=e.querySelector(".b3-list--background");e.querySelector('.history__text[data-type="docPanel"]').classList.add("fn__none"),e.querySelector('.history__text[data-type="mdPanel"]').classList.remove("fn__none"),fetchPost("/api/history/searchHistory",{query:n,page:t,op:i.value,type:3},o=>{if(t<o.data.pageCount?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),a.nextElementSibling.nextElementSibling.textContent=`${t}/${o.data.pageCount||1}`,o.data.histories.length===0){l.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let r="";o.data.histories.forEach(c=>{r+=`<li class="b3-list-item b3-list-item--hide-action" data-created="${c}">
    <span class="b3-list-item__text">${dayjs(parseInt(c)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),l.innerHTML=r})},xd=e=>{const t=`<div class="fn__flex-column" style="height: 100%;">
        <div class="block__icons">
            ${isMobile()?"":e.pathString}
            <span class="fn__space"></span>
            <div class="fn__flex-1"></div>
            <select data-type="opselect" class="b3-select">
                <option value="all" selected>${window.siyuan.languages.allOp}</option>
                <option value="clean">clean</option>
                <option value="update">update</option>
                <option value="delete">delete</option>
                <option value="format">format</option>
                <option value="sync">sync</option>
                <option value="replace">replace</option>
            </select>
            <span class="fn__space"></span>
            <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__s" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href="#iconLeft"></use></svg></span>
            <span class="fn__space"></span>
            <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__s" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href="#iconRight"></use></svg></span>
            <span class="fn__space"></span>
            <span>1/1</span>
            ${isMobile()?'<span class="fn__space"></span><span data-type="close" class="block__icon block__icon--show"><svg><use xlink:href="#iconClose"></use></svg></span>':""}
        </div>
        <div class="fn__flex fn__flex-1 history__panel">
            <ul class="b3-list b3-list--background" style="overflow:auto;">
                <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
            </ul>
            <textarea class="fn__flex-1 history__text fn__none" readonly data-type="mdPanel"></textarea>
            <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
        </div>
</div>`,n=new Dialog({content:t,width:isMobile()?"100vw":"90vw",height:isMobile()?"100vh":"80vh",destroyCallback(){wt=void 0}});n.element.setAttribute("data-key",Constants.DIALOG_HISTORYDOC);const s=n.element.querySelector(".b3-select");s.addEventListener("change",()=>{gn(n.element,1,e.id)});const a=n.element.querySelector('.history__text[data-type="docPanel"]'),i=n.element.querySelector('.history__text[data-type="mdPanel"]');gn(n.element,1,e.id),wt=new Protyle(e.app,a,{blockId:"",history:{created:""},action:[Constants.CB_GET_HISTORY],render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(wt.protyle),n.element.addEventListener("click",l=>{let o=l.target;for(;o&&!o.isEqualNode(n.element);){const r=o.getAttribute("data-type");if(r==="close")n.destroy();else if(r==="rollback"&&!_t){Ea(o.parentElement,s.value,e.id,c=>{_t=!1,confirmDialog("\u26A0\uFE0F "+window.siyuan.languages.rollback,`${window.siyuan.languages.rollbackConfirm.replace("${date}",o.parentElement.textContent.trim())}`,()=>{fetchPost("/api/history/rollbackDocHistory",{notebook:e.notebookId,historyPath:c})})}),l.stopPropagation(),l.preventDefault();break}else if(o.classList.contains("b3-list-item")&&!_t){Ea(o,s.value,e.id,c=>{var f;fetchPost("/api/history/getDocHistoryContent",{historyPath:c},u=>{u.data.isLargeDoc?(i.value=u.data.content,i.classList.remove("fn__none"),a.classList.add("fn__none")):(i.classList.add("fn__none"),a.classList.remove("fn__none"),onGet({data:u,protyle:wt.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]})),_t=!1}),(f=o.parentElement.querySelector(".b3-list-item--focus"))==null||f.classList.remove("b3-list-item--focus"),o.classList.add("b3-list-item--focus")}),l.stopPropagation(),l.preventDefault();break}else if((r==="docprevious"||r==="docnext")&&o.getAttribute("disabled")!=="disabled"){const c=parseInt(n.element.getAttribute("data-page"));gn(n.element,r==="docprevious"?c-1:c+1,e.id),l.stopPropagation(),l.preventDefault();break}o=o.parentElement}})},Ea=(e,t,n,s)=>{_t=!0;const a=e.getAttribute("data-path");a&&s(a);const i=e.getAttribute("data-created");wt.protyle.options.history.created=i,fetchPost("/api/history/getHistoryItems",{query:n,op:t,type:3,created:i},l=>{s(l.data.items[0].path)})},Td=e=>{const t=`<div class="fn__flex">${escapeHtml(e.name)}
<div class="fn__space"></div>
<button class="b3-button b3-button--small">${window.siyuan.languages.copy} ID</button></div>`,n=`<div class="b3-dialog__content" style="background-color: var(--b3-theme-background);">
<div class="b3-label">
    ${window.siyuan.languages.fileTree12}
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree13}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="docCreateSavePath" value="">
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree5}
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree6}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="refCreateSavePath" value="${window.siyuan.config.fileTree.refCreateSavePath}">
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree11}
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree14}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteSavePath" value="">
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree15}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteTemplatePath" value="${e.conf.dailyNoteTemplatePath}">
</div></div>`;if(isMobile())openModel({title:t,icon:"iconSettings",html:`<div>${n}</div>`,bindEvent(){ka(document.querySelector("#model"),e)}});else{const s=new Dialog({width:"80vw",title:t,content:n});s.element.setAttribute("data-key",Constants.DIALOG_NOTEBOOKCONF),ka(s.element,e)}},ka=(e,t)=>{e.querySelector(".b3-button--small").addEventListener("click",()=>{writeText(t.box),showMessage(window.siyuan.languages.copied)});const n=e.querySelector("#dailyNoteSavePath");n.value=t.conf.dailyNoteSavePath;const s=e.querySelector("#docCreateSavePath");s.value=t.conf.docCreateSavePath;const a=e.querySelector("#refCreateSavePath");a.value=t.conf.refCreateSavePath;const i=e.querySelector("#dailyNoteTemplatePath");i.value=t.conf.dailyNoteTemplatePath,e.querySelectorAll("input").forEach(l=>{l.addEventListener("change",()=>{fetchPost("/api/notebook/setNotebookConf",{notebook:t.box,conf:{refCreateSavePath:a.value,docCreateSavePath:s.value,dailyNoteSavePath:n.value,dailyNoteTemplatePath:i.value}})})})};var Ca=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const Aa=(e,t)=>{if(!Array.from(e).find(i=>{if(i.getAttribute("data-type")==="navigation-file")return!0}))return window.siyuan.menus.menu;window.siyuan.menus.menu.append(movePathToMenu(getTopPaths(Array.from(e)))),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{deleteFiles(Array.from(e))}}).element);const s=[];if(e.forEach(i=>{const l=i.getAttribute("data-node-id");l&&s.push(l)}),s.length===0)return window.siyuan.menus.menu;window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element);const a=[{iconHTML:Constants.ZWSP,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{transaction(void 0,[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:s}],[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:s}])}},{iconHTML:Constants.ZWSP,label:`${window.siyuan.languages.cancel} <b>${window.siyuan.languages.quickMakeCard}</b>`,click:()=>{transaction(void 0,[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:s}],[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:s}])}}];return window.siyuan.config.flashcard.deck&&a.push({iconHTML:Constants.ZWSP,label:window.siyuan.languages.addToDeck,click:()=>{makeCard(t,s)}}),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.riffCard,icon:"iconRiffCard",submenu:a}).element),t.plugins&&emitOpenMenu({plugins:t.plugins,type:"open-menu-doctree",detail:{elements:e,type:"docs"},separatorPosition:"top"}),window.siyuan.menus.menu},Id=(e,t)=>{window.siyuan.menus.menu.remove();const n=hasClosestByTag(t,"DIV");if(!n)return window.siyuan.menus.menu;t.classList.contains("b3-list-item--focus")||(n.querySelectorAll(".b3-list-item--focus").forEach(l=>{l.classList.remove("b3-list-item--focus"),l.removeAttribute("select-end"),l.removeAttribute("select-start")}),t.classList.add("b3-list-item--focus"));const s=n.querySelectorAll(".b3-list-item--focus");if(s.length>1)return Aa(s,e);const a=t.parentElement.getAttribute("data-url"),i=getNotebookName(a);if(!window.siyuan.config.readonly){window.siyuan.menus.menu.append(renameMenu({path:"/",notebookId:a,name:i,type:"notebook"})),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.config,icon:"iconSettings",click:()=>{fetchPost("/api/notebook/getNotebookConf",{notebook:a},o=>{onGetnotebookconf(o.data)})}}).element);const l=Si("notebook",parseInt(t.parentElement.getAttribute("data-sortmode")),o=>(fetchPost("/api/notebook/setNotebookConf",{notebook:a,conf:{sortMode:o}},()=>{var r;t.parentElement.setAttribute("data-sortmode",o.toString());let c;c=window.siyuan.mobile.files;const f=t.querySelector(".b3-list-item__arrow--open");f&&(f.classList.remove("b3-list-item__arrow--open"),(r=t.nextElementSibling)==null||r.remove(),c.getLeaf(t,a))}),!0));window.siyuan.menus.menu.append(new MenuItem({icon:"iconSort",label:window.siyuan.languages.sort,type:"submenu",submenu:l}).element)}return window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:[{iconHTML:Constants.ZWSP,label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{fetchPost("/api/riff/getNotebookRiffDueCards",{notebook:a},l=>{openCardByData(e,l.data,"notebook",a,i)}),closePanel()}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.manage,click:()=>{viewCards(e,a,i,"Notebook"),closePanel()}}]}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.search,accelerator:window.siyuan.config.keymap.general.search.custom,icon:"iconSearch",click(){const l=window.siyuan.storage[Constants.LOCAL_SEARCHDATA];popSearch(e,{removed:l.removed,sort:l.sort,group:l.group,hasReplace:!1,method:l.method,hPath:getNotebookName(a),idPath:[a],k:l.k,r:l.r,page:1,types:Object.assign({},l.types),replaceTypes:Object.assign({},l.replaceTypes)})}}).element),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",click(){const l=window.siyuan.storage[Constants.LOCAL_SEARCHDATA];popSearch(e,{removed:l.removed,sort:l.sort,group:l.group,hasReplace:!0,method:l.method,hPath:getNotebookName(a),idPath:[a],k:l.k,r:l.r,page:1,types:Object.assign({},l.types),replaceTypes:Object.assign({},l.replaceTypes)})}}).element),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.close,icon:"iconClose",click:()=>{fetchPost("/api/notebook/closeNotebook",{notebook:a})}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{deleteFiles(Array.from(n.querySelectorAll(".b3-list-item--focus")))}}).element)),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),La(a,"/"),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{label:"Markdown",icon:"iconMarkdown",click:()=>{const l=showMessage(window.siyuan.languages.exporting,-1);fetchPost("/api/export/batchExportMd",{notebook:a,path:"/"},o=>{hideMessage(l),openByMobile(o.data.zip)})}},{label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const l=showMessage(window.siyuan.languages.exporting,-1);fetchPost("/api/export/exportNotebookSY",{id:a},o=>{hideMessage(l),openByMobile(o.data.zip)})}}]}).element),e.plugins&&emitOpenMenu({plugins:e.plugins,type:"open-menu-doctree",detail:{elements:s,type:"notebook"},separatorPosition:"top"}),window.siyuan.menus.menu},Md=(e,t,n,s)=>{window.siyuan.menus.menu.remove();const a=hasClosestByTag(s,"DIV");if(!a)return window.siyuan.menus.menu;s.classList.contains("b3-list-item--focus")||(a.querySelectorAll(".b3-list-item--focus").forEach(r=>{r.classList.remove("b3-list-item--focus"),r.removeAttribute("select-end"),r.removeAttribute("select-start")}),s.classList.add("b3-list-item--focus"));const i=a.querySelectorAll(".b3-list-item--focus");if(i.length>1)return Aa(i,e);const l=s.getAttribute("data-node-id");let o=s.getAttribute("data-name");if(o=getDisplayName(o,!1,!0),!window.siyuan.config.readonly){let r,c;window.siyuan.config.fileTree.sort===6&&(window.siyuan.menus.menu.append(new MenuItem({icon:"iconBefore",label:window.siyuan.languages.newDocAbove,click:()=>{const u=[];Array.from(s.parentElement.children).forEach(d=>{d.tagName==="LI"&&(d.isSameNode(s)&&u.push(void 0),u.push(d.getAttribute("data-path")))}),newFile({app:e,notebookId:t,currentPath:pathPosix().dirname(n),paths:u,useSavePath:!1})}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAfter",label:window.siyuan.languages.newDocBelow,click:()=>{const u=[];Array.from(s.parentElement.children).forEach(d=>{d.tagName==="LI"&&(u.push(d.getAttribute("data-path")),d.isSameNode(s)&&u.push(void 0))}),newFile({app:e,notebookId:t,currentPath:pathPosix().dirname(n),paths:u,useSavePath:!1})}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element)),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:copySubMenu(l,!1).concat([{label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){fetchPost("/api/filetree/duplicateDoc",{id:l})}}])}).element),window.siyuan.menus.menu.append(movePathToMenu(getTopPaths(Array.from(a.querySelectorAll(".b3-list-item--focus"))))),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{deleteFiles(Array.from(a.querySelectorAll(".b3-list-item--focus")))}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(renameMenu({path:n,notebookId:t,name:o,type:"file"})),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.attr,icon:"iconAttr",click(){fetchPost("/api/block/getDocInfo",{id:l},u=>{openFileAttr(u.data.ial)})}}).element);const f=[{iconHTML:Constants.ZWSP,label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{fetchPost("/api/riff/getTreeRiffDueCards",{rootID:l},u=>{openCardByData(e,u.data,"doc",l,o)}),closePanel()}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.manage,click:()=>{fetchPost("/api/filetree/getHPathByID",{id:l},u=>{viewCards(e,l,pathPosix().join(getNotebookName(t),u.data),"Tree")}),closePanel()}},{iconHTML:Constants.ZWSP,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{transaction(void 0,[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:[l]}],[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:[l]}])}},{iconHTML:Constants.ZWSP,label:`${window.siyuan.languages.cancel} <b>${window.siyuan.languages.quickMakeCard}</b>`,click:()=>{transaction(void 0,[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:[l]}],[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:[l]}])}}];window.siyuan.config.flashcard.deck&&f.push({iconHTML:Constants.ZWSP,label:window.siyuan.languages.addToDeck,click:()=>{makeCard(e,[l])}}),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:f}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,click(){return Ca(this,null,function*(){const u=getDisplayName(n,!1,!0),d=yield fetchSyncPost("/api/filetree/getHPathByPath",{notebook:t,path:u+".sy"}),g=window.siyuan.storage[Constants.LOCAL_SEARCHDATA];popSearch(e,{removed:g.removed,sort:g.sort,group:g.group,hasReplace:!1,method:g.method,hPath:pathPosix().join(getNotebookName(t),d.data),idPath:[pathPosix().join(t,u)],k:g.k,r:g.r,page:1,types:Object.assign({},g.types),replaceTypes:Object.assign({},g.replaceTypes)})})}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",click(){return Ca(this,null,function*(){const u=getDisplayName(n,!1,!0),d=yield fetchSyncPost("/api/filetree/getHPathByPath",{notebook:t,path:u+".sy"}),g=window.siyuan.storage[Constants.LOCAL_SEARCHDATA];popSearch(e,{removed:g.removed,sort:g.sort,group:g.group,hasReplace:!0,method:g.method,hPath:pathPosix().join(getNotebookName(t),d.data),idPath:[pathPosix().join(t,u)],k:g.k,r:g.r,page:1,types:Object.assign({},g.types),replaceTypes:Object.assign({},g.replaceTypes)})})}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element)}return openEditorTab(e,l,t,n),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){openDocHistory({app:e,id:l,notebookId:t,pathString:o})}}).element),La(t,n),window.siyuan.menus.menu.append(exportMd(l)),e.plugins&&emitOpenMenu({plugins:e.plugins,type:"open-menu-doctree",detail:{elements:i,type:"doc"},separatorPosition:"top"}),window.siyuan.menus.menu},La=(e,t)=>{window.siyuan.config.readonly||window.siyuan.menus.menu.append(new MenuItem({icon:"iconDownload",label:window.siyuan.languages.import,submenu:[{icon:"iconSiYuan",label:'SiYuan .sy.zip<input class="b3-form__upload" type="file" accept="application/zip">',bind:n=>{n.querySelector(".b3-form__upload").addEventListener("change",s=>{const a=new FormData;a.append("file",s.target.files[0]),a.append("notebook",e),a.append("toPath",t),fetchPost("/api/import/importSY",a,()=>{var i;let l;l=window.siyuan.mobile.files;const o=l.element.querySelector(`[data-path="${t}"]`),r=o.querySelector(".b3-list-item__arrow--open");r&&(r.classList.remove("b3-list-item__arrow--open"),(i=o.nextElementSibling)==null||i.remove()),l.getLeaf(o,e),window.siyuan.menus.menu.remove()})})}}]}).element)},Si=(e,t,n)=>{const s=[{icon:t===0?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{n(0)}},{icon:t===1?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{n(1)}},{icon:t===4?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{n(4)}},{icon:t===5?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{n(5)}},{type:"separator"},{icon:t===9?"iconSelect":void 0,label:window.siyuan.languages.createdASC,click:()=>{n(9)}},{icon:t===10?"iconSelect":void 0,label:window.siyuan.languages.createdDESC,click:()=>{n(10)}},{icon:t===2?"iconSelect":void 0,label:window.siyuan.languages.modifiedASC,click:()=>{n(2)}},{icon:t===3?"iconSelect":void 0,label:window.siyuan.languages.modifiedDESC,click:()=>{n(3)}},{type:"separator"},{icon:t===7?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{n(7)}},{icon:t===8?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{n(8)}},{type:"separator"},{icon:t===11?"iconSelect":void 0,label:window.siyuan.languages.docSizeASC,click:()=>{n(11)}},{icon:t===12?"iconSelect":void 0,label:window.siyuan.languages.docSizeDESC,click:()=>{n(12)}},{type:"separator"},{icon:t===13?"iconSelect":void 0,label:window.siyuan.languages.subDocCountASC,click:()=>{n(13)}},{icon:t===14?"iconSelect":void 0,label:window.siyuan.languages.subDocCountDESC,click:()=>{n(14)}},{type:"separator"},{icon:t===6?"iconSelect":void 0,label:window.siyuan.languages.customSort,click:()=>{n(6)}}];return e==="notebook"&&s.push({icon:t===15?"iconSelect":void 0,label:window.siyuan.languages.sortByFiletree,click:()=>{n(15)}}),s};var xi=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const Dd=(e,t)=>{if(hideTooltip(),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="titleMenu"){window.siyuan.menus.menu.remove();return}fetchPost("/api/block/getDocInfo",{id:e.block.rootID},n=>{var s;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","titleMenu"),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:copySubMenu(e.block.rootID)}).element),e.disabled||(window.siyuan.menus.menu.append(movePathToMenu([e.path])),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click:()=>{deleteFile(e.notebookId,e.path)}}).element)),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+updateHotkeyTip("\u21E7Click"),click(){openFileAttr(n.data.ial,"bookmark",e)}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.wechatReminder,icon:"iconMp",click(){openFileWechatNotify(e)}}).element);const a=[{iconHTML:Constants.ZWSP,label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{fetchPost("/api/riff/getTreeRiffDueCards",{rootID:e.block.rootID},i=>{openCardByData(e.app,i.data,"doc",e.block.rootID,i.data.name)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.manage,click:()=>{fetchPost("/api/filetree/getHPathByID",{id:e.block.rootID},i=>{viewCards(e.app,e.block.rootID,pathPosix().join(getNotebookName(e.notebookId),i.data),"Tree")})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,click:()=>{var i;let l=(i=e.title)==null?void 0:i.element;l||(l=document.createElement("div"),l.setAttribute("data-node-id",e.block.rootID),l.setAttribute(Constants.CUSTOM_RIFF_DECKS,n.data.ial[Constants.CUSTOM_RIFF_DECKS])),quickMakeCard(e,[l])}}];window.siyuan.config.flashcard.deck&&a.push({iconHTML:Constants.ZWSP,label:window.siyuan.languages.addToDeck,click:()=>{makeCard(e.app,[e.block.rootID])}}),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:a}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,click(){return xi(this,null,function*(){const i=getDisplayName(e.path,!1,!0),l=yield fetchSyncPost("/api/filetree/getHPathByPath",{notebook:e.notebookId,path:i+".sy"}),o=window.siyuan.storage[Constants.LOCAL_SEARCHDATA];popSearch(e.app,{removed:o.removed,sort:o.sort,group:o.group,hasReplace:!1,method:o.method,hPath:pathPosix().join(getNotebookName(e.notebookId),l.data),idPath:[pathPosix().join(e.notebookId,i)],k:o.k,r:o.r,page:1,types:Object.assign({},o.types),replaceTypes:Object.assign({},o.replaceTypes)})})}}).element),e.disabled||transferBlockRef(e.block.rootID),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),e.disabled||window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){openDocHistory({app:e.app,id:e.block.rootID,notebookId:e.notebookId,pathString:n.data.name})}}).element),genImportMenu(e.notebookId,e.path),window.siyuan.menus.menu.append(exportMd(e.block.showAll?e.block.id:e.block.rootID)),(s=e==null?void 0:e.app)!=null&&s.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"click-editortitleicon",detail:{protyle:e,data:n.data},separatorPosition:"top"}),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,type:"readonly",label:`${window.siyuan.languages.modifiedAt} ${dayjs(n.data.ial.updated).format("YYYY-MM-DD HH:mm:ss")}<br>
${window.siyuan.languages.createdAt} ${dayjs(n.data.ial.id.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu.fullscreen()})};var Ti=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});class $d{constructor(t){const n=document.createElement("div");n.className="protyle-breadcrumb",n.innerHTML=`${isMobile()?`<button class="protyle-breadcrumb__icon" data-type="mobile-menu">${window.siyuan.languages.breadcrumb}</button>`:'<div class="protyle-breadcrumb__bar"></div>'}
<span class="protyle-breadcrumb__space"></span>
<button class="protyle-breadcrumb__icon fn__none ariaLabel" aria-label="${updateHotkeyTip(window.siyuan.config.keymap.editor.general.exitFocus.custom)}" data-type="exit-focus">${window.siyuan.languages.exitFocus}</button>
<button class="block__icon block__icon--show fn__flex-center ariaLabel${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.lockEdit}" data-type="readonly"><svg><use xlink:href="#iconUnlock"></use></svg></button>
<span class="fn__space${window.siyuan.config.readonly?" fn__none":""}"></span>
<button class="block__icon block__icon--show fn__flex-center ariaLabel" data-type="doc" aria-label="${isMac()?window.siyuan.languages.gutterTip2:window.siyuan.languages.gutterTip2.replace("\u21E7","Shift+")}"><svg><use xlink:href="#iconFile"></use></svg></button>
<span class="fn__space"></span>
<button class="block__icon block__icon--show fn__flex-center ariaLabel" data-type="more" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></button>
<button class="block__icon block__icon--show fn__flex-center fn__none ariaLabel" style="margin-left: 8px" data-type="context" aria-label="${window.siyuan.languages.context}"><svg><use xlink:href="#iconAlignCenter"></use></svg></button>`,this.element=n.firstElementChild,n.addEventListener("click",s=>{let a=s.target;for(;a&&!a.isEqualNode(n);){const i=a.getAttribute("data-node-id"),l=a.getAttribute("data-type");if(i){s.preventDefault();break}else if(l==="mobile-menu"){this.genMobileMenu(t),s.preventDefault(),s.stopPropagation();break}else if(l==="doc"){if(window.siyuan.shiftIsPressed)fetchPost("/api/block/getDocInfo",{id:t.block.rootID},o=>{openFileAttr(o.data.ial,"bookmark",t)});else{const o=a.getBoundingClientRect();openTitleMenu(t,{x:o.right,y:o.bottom,isLeft:!0})}s.stopPropagation(),s.preventDefault();break}else if(l==="more"){const o=a.getBoundingClientRect();this.showMenu(t,{x:o.right,y:o.bottom,isLeft:!0}),s.stopPropagation(),s.preventDefault();break}else if(l==="readonly"){updateReadonly(a,t),s.stopPropagation(),s.preventDefault();break}else if(l==="exit-focus"){zoomOut({protyle:t,id:t.block.rootID,focusId:t.block.id}),s.stopPropagation(),s.preventDefault();break}else if(l==="context"){s.stopPropagation(),s.preventDefault(),a.classList.contains("block__icon--active")?(zoomOut({protyle:t,id:t.options.blockId}),a.classList.remove("block__icon--active")):(fetchPost("/api/filetree/getDoc",{id:t.options.blockId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},o=>{onGet({data:o,protyle:t,action:[Constants.CB_GET_HL]})}),a.classList.add("block__icon--active"));break}a=a.parentElement}}),n.addEventListener("mouseleave",()=>{t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(s=>{s.classList.remove("protyle-wysiwyg--hl")})}),this.element.addEventListener("mouseover",s=>{if(!t.selectElement.classList.contains("fn__none"))return;const a=s.target,i=hasClosestByAttribute(a,"data-node-id",null);if(i){t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(o=>{o.classList.remove("protyle-wysiwyg--hl")});const l=t.wysiwyg.element.querySelector(`[data-node-id="${i.getAttribute("data-node-id")}"]`);l&&l.classList.add("protyle-wysiwyg--hl")}}),this.element.addEventListener("mousewheel",s=>{this.element.scrollLeft=this.element.scrollLeft+s.deltaY},{passive:!0})}startRecord(t){this.messageId=showMessage(`<div class="fn__flex fn__flex-wrap">
<span class="fn__flex-center">${window.siyuan.languages.recording}</span><span class="fn__space"></span>
<button class="b3-button b3-button--white">${window.siyuan.languages.endRecord}</button></div>`,-1),document.querySelector(`#message [data-id="${this.messageId}"] button`).addEventListener("click",()=>{this.mediaRecorder.stopRecording(),hideMessage(this.messageId);const n=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});uploadFiles(t,[n])}),this.mediaRecorder.startRecordingNewWavFile()}genMobileMenu(t){const n=new Menu("breadcrumb-mobile-path");let s;if(getSelection().rangeCount>0){const i=getSelection().getRangeAt(0);!t.wysiwyg.element.isEqualNode(i.startContainer)&&!t.wysiwyg.element.contains(i.startContainer)?s=getNoContainerElement(t.wysiwyg.element.firstElementChild)||t.wysiwyg.element.firstElementChild:s=hasClosestBlock(i.startContainer)}s||(s=getNoContainerElement(t.wysiwyg.element.firstElementChild)||t.wysiwyg.element.firstElementChild);const a=s.getAttribute("data-node-id");fetchPost("/api/block/getBlockBreadcrumb",{id:a,excludeTypes:[]},i=>{i.data.forEach(l=>{let o=!1;(!t.block.showAll&&l.id===t.block.parentID||t.block.showAll&&l.id===t.block.id)&&(o=!0),n.addItem({current:o,icon:getIconByType(l.type,l.subType),label:l.name,click(){zoomOut({protyle:t,id:l.id,focusId:a})}})}),n.fullscreen()})}toggleExit(t){const n=this.element.parentElement.querySelector('[data-type="exit-focus"]');t?n.classList.add("fn__none"):n.classList.remove("fn__none")}showMenu(t,n){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="breadcrumbMore"){window.siyuan.menus.menu.remove();return}let s;const a=hasClosestBlock(getEditorRange(t.element).startContainer);a&&(s=a.getAttribute("data-node-id")),fetchPost("/api/block/getTreeStat",{id:s||(t.block.showAll?t.block.id:t.block.rootID)},i=>{var l,o,r;if(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","breadcrumbMore"),!t.contentElement.classList.contains("fn__none")&&!t.disabled){let c="";c='<input class="b3-form__upload" type="file" multiple="multiple"',t.options.upload.accept?c+=` accept="${t.options.upload.accept}">`:c+=">";const f=new MenuItem({icon:"iconDownload",label:`${window.siyuan.languages.insertAsset}${c}`}).element;f.querySelector("input").addEventListener("change",u=>{u.target.files.length!==0&&(uploadFiles(t,u.target.files,u.target),window.siyuan.menus.menu.remove())}),window.siyuan.menus.menu.append(f),isInAndroid()||window.siyuan.menus.menu.append(new MenuItem({current:this.mediaRecorder&&this.mediaRecorder.isRecording,icon:"iconRecord",label:(l=this.mediaRecorder)!=null&&l.isRecording?window.siyuan.languages.endRecord:window.siyuan.languages.startRecord,click:()=>Ti(this,null,function*(){if(!this.mediaRecorder){navigator.mediaDevices.getUserMedia({audio:!0}).then(u=>{this.mediaRecorder=new RecordMedia(u),this.mediaRecorder.recorder.onaudioprocess=d=>{if(!this.mediaRecorder.isRecording)return;const g=d.inputBuffer.getChannelData(0),p=d.inputBuffer.getChannelData(1);this.mediaRecorder.cloneChannelData(g,p)},this.startRecord(t)}).catch(()=>{showMessage(window.siyuan.languages["record-tip"])});return}if(this.mediaRecorder.isRecording){this.mediaRecorder.stopRecording(),hideMessage(this.messageId);const u=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});uploadFiles(t,[u])}else hideMessage(this.messageId),this.startRecord(t)})}).element)}if(t.disabled||(window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.netImg2LocalAsset,icon:"iconImgDown",accelerator:window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,click(){net2LocalAssets(t,"Img")}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.netAssets2LocalAssets,icon:"iconTransform",accelerator:window.siyuan.config.keymap.editor.general.netAssets2LocalAssets.custom,click(){net2LocalAssets(t,"Assets")}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.uploadAssets2CDN,icon:"iconCloudSucc",click(){needSubscribe()||confirmDialog("\u{1F4E6} "+window.siyuan.languages.uploadAssets2CDN,window.siyuan.languages.uploadAssets2CDNConfirmTip,()=>{fetchPost("/api/asset/uploadCloud",{id:t.block.parentID})})}}).element),window.siyuan.user&&window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.share2Liandi,icon:"iconLiandi",click(){confirmDialog("\u{1F680} "+window.siyuan.languages.share2Liandi,window.siyuan.languages.share2LiandiConfirmTip,()=>{fetchPost("/api/export/export2Liandi",{id:t.block.parentID})})}}).element)),(o=t.scroll)!=null&&o.element.classList.contains("fn__none")||window.siyuan.menus.menu.append(new MenuItem({current:t.scroll.keepLazyLoad,label:window.siyuan.languages.keepLazyLoad,click:()=>{t.scroll.keepLazyLoad=!t.scroll.keepLazyLoad}}).element),window.siyuan.menus.menu.element.lastElementChild.childElementCount>0&&window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconRefresh",accelerator:window.siyuan.config.keymap.editor.general.refresh.custom,label:window.siyuan.languages.refresh,click:()=>{reloadProtyle(t,!isMobile())}}).element),t.disabled||window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.optimizeTypography,accelerator:window.siyuan.config.keymap.editor.general.optimizeTypography.custom,icon:"iconFormat",click:()=>{hideElements(["toolbar"],t),fetchPost("/api/format/autoSpace",{id:t.block.rootID})}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconEdit",label:window.siyuan.languages["edit-mode"],type:"submenu",submenu:[{current:!t.contentElement.classList.contains("fn__none"),label:window.siyuan.languages.wysiwyg,accelerator:window.siyuan.config.keymap.editor.general.wysiwyg.custom,click:()=>{setEditMode(t,"wysiwyg"),t.scroll.lastScrollTop=0,fetchPost("/api/filetree/getDoc",{id:t.block.parentID,size:window.siyuan.config.editor.dynamicLoadBlocks},c=>{onGet({data:c,protyle:t})}),saveLayout()}},{current:!t.preview.element.classList.contains("fn__none"),icon:"iconPreview",label:window.siyuan.languages.preview,accelerator:window.siyuan.config.keymap.editor.general.preview.custom,click:()=>{setEditMode(t,"preview"),window.siyuan.menus.menu.remove(),saveLayout()}}]}).element),!window.siyuan.config.editor.readOnly&&!window.siyuan.config.readonly){const c=t.wysiwyg.element.getAttribute(Constants.CUSTOM_SY_READONLY);window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.editReadonly,icon:"iconLock",type:"submenu",submenu:[{iconHTML:"",current:c==="true",label:window.siyuan.languages.enable,click(){fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{[Constants.CUSTOM_SY_READONLY]:"true"}})}},{iconHTML:"",current:!c||c==="false",label:window.siyuan.languages.disable,click(){fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{[Constants.CUSTOM_SY_READONLY]:"false"}})}}]}).element)}(r=t==null?void 0:t.app)!=null&&r.plugins&&emitOpenMenu({plugins:t.app.plugins,type:"open-menu-breadcrumbmore",detail:{protyle:t,data:i.data},separatorPosition:"top"}),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,type:"readonly",label:`<div class="fn__flex">${window.siyuan.languages.runeCount}<span class="fn__space fn__flex-1"></span>${i.data.runeCount}</div>
<div class="fn__flex">${window.siyuan.languages.wordCount}<span class="fn__space fn__flex-1"></span>${i.data.wordCount}</div>
<div class="fn__flex">${window.siyuan.languages.linkCount}<span class="fn__space fn__flex-1"></span>${i.data.linkCount}</div>
<div class="fn__flex">${window.siyuan.languages.imgCount}<span class="fn__space fn__flex-1"></span>${i.data.imageCount}</div>
<div class="fn__flex">${window.siyuan.languages.refCount}<span class="fn__space fn__flex-1"></span>${i.data.refCount}</div>`}).element),window.siyuan.menus.menu.fullscreen()})}render(t,n=!1){var s;if(isMobile())return;let a,i;getSelection().rangeCount>0&&(a=getSelection().getRangeAt(0),!t.wysiwyg.element.isEqualNode(a.startContainer)&&!t.wysiwyg.element.contains(a.startContainer)?t.element.id==="searchPreview"?i=hasClosestBlock(t.wysiwyg.element.querySelector('[data-type="search-mark"]')):i=getNoContainerElement(t.wysiwyg.element.firstElementChild)||t.wysiwyg.element.firstElementChild:i=hasClosestBlock(a.startContainer)),i||(i=getNoContainerElement(t.wysiwyg.element.firstElementChild)||t.wysiwyg.element.firstElementChild);const l=i.getAttribute("data-node-id");if(l===this.id&&!n){t.breadcrumb.element.querySelectorAll(".protyle-breadcrumb__item--active").forEach(c=>{c.classList.remove("protyle-breadcrumb__item--active")});const r=t.breadcrumb.element.querySelector(`[data-node-id="${t.block.showAll?t.block.id:t.block.parentID}"]`);r&&r.classList.add("protyle-breadcrumb__item--active");return}this.id=l;const o=[];(s=this.element.parentElement)!=null&&s.parentElement&&this.element.parentElement.parentElement.classList.contains("card__block")&&o.push("NodeTextMark-mark"),fetchPost("/api/block/getBlockBreadcrumb",{id:l,excludeTypes:o},r=>{let c="";r.data.forEach((d,g)=>{let p=!1;(!t.block.showAll&&d.id===t.block.parentID||t.block.showAll&&d.id===t.block.id)&&(p=!0),g===0&&!t.options.render.breadcrumbDocName?c+=`<span class="protyle-breadcrumb__item${p?" protyle-breadcrumb__item--active":""}" data-node-id="${d.id}"${r.data.length===1?' style="max-width:none"':""}>
    <svg class="popover__block" data-id="${d.id}"><use xlink:href="#${getIconByType(d.type,d.subType)}"></use></svg>
</span>`:c+=`<span class="protyle-breadcrumb__item${p?" protyle-breadcrumb__item--active":""}" data-node-id="${d.id}"${r.data.length===1||g===0?' style="max-width:none"':""}>
    <svg class="popover__block" data-id="${d.id}"><use xlink:href="#${getIconByType(d.type,d.subType)}"></use></svg>
    <span class="protyle-breadcrumb__text" title="${d.name}">${d.name}</span>
</span>`,g!==r.data.length-1&&(c+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>')}),this.element.classList.remove("protyle-breadcrumb__bar--nowrap"),this.element.innerHTML=c;const f=Array.from(this.element.querySelectorAll(".protyle-breadcrumb__text"));if(f.length===0)return;let u=!1;for(;this.element.scrollHeight>30&&!u&&f.length>1;)f.find((d,g)=>{if(g>0){if(!d.classList.contains("protyle-breadcrumb__text--ellipsis"))return d.classList.add("protyle-breadcrumb__text--ellipsis"),!0;g===f.length-1&&d.classList.contains("protyle-breadcrumb__text--ellipsis")&&(u=!0)}});this.element.classList.add("protyle-breadcrumb__bar--nowrap"),this.element.lastElementChild&&(this.element.scrollLeft=this.element.lastElementChild.offsetLeft-this.element.clientWidth+14)})}hide(){isMobile()||(this.element.classList.add("protyle-breadcrumb__bar--hide"),window.siyuan.hideBreadcrumb=!0)}}var Sa=(e,t,n)=>new Promise((s,a)=>{var i=r=>{try{o(n.next(r))}catch(c){a(c)}},l=r=>{try{o(n.throw(r))}catch(c){a(c)}},o=r=>r.done?s(r.value):Promise.resolve(r.value).then(i,l);o((n=n.apply(e,t)).next())});const Ht=null;class Hd{constructor(t){this.transparentData="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",this.element=document.createElement("div"),this.element.className="protyle-background",this.element.innerHTML=`<div class="protyle-background__img">
    <img class="fn__none">
    <div class="protyle-icons">
        <span class="protyle-icon protyle-icon--first b3-tooltips b3-tooltips__sw" style="position: relative" aria-label="${window.siyuan.languages.upload}"><input type="file" style="position: absolute;width: 22px;height: 100%;top: 0;left: 0;opacity: .001;overflow: hidden;cursor: pointer;"><svg><use xlink:href="#iconUpload"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__sw" data-type="link" aria-label="${window.siyuan.languages.link}"><svg><use xlink:href="#iconLink"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__sw" data-type="asset" aria-label="${window.siyuan.languages.assets}"><svg><use xlink:href="#iconImage"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__sw" data-type="show-random" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__sw fn__none" data-type="position" aria-label="${window.siyuan.languages.dragPosition}"><svg><use xlink:href="#iconMove"></use></svg></span>
        <span class="protyle-icon protyle-icon--last b3-tooltips b3-tooltips__sw" data-type="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    </div>
    <div class="protyle-icons fn__none"><span class="protyle-icon protyle-icon--text">${window.siyuan.languages.dragPosition}</span></div>
    <div class="protyle-icons fn__none" style="opacity: .86;">
        <span class="protyle-icon protyle-icon--first" data-type="cancel">${window.siyuan.languages.cancel}</span>
        <span class="protyle-icon protyle-icon--last" data-type="confirm">${window.siyuan.languages.confirm}</span>
    </div>
</div>
<div class="b3-chips"></div>
<div class="protyle-background__iconw">
    <div class="protyle-background__icon" data-menu="true" data-type="open-emoji"></div>
    <div class="protyle-icons fn__flex-center">
        <span class="protyle-icon protyle-icon--first b3-tooltips b3-tooltips__s" data-menu="true" data-type="tag" aria-label="${window.siyuan.languages.addTag}"><svg><use xlink:href="#iconTags"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__s" data-type="icon" aria-label="${window.siyuan.languages.randomIcon}"><svg><use xlink:href="#iconEmoji"></use></svg></span>
        <span class="protyle-icon protyle-icon--last b3-tooltips b3-tooltips__s" data-type="random" aria-label="${window.siyuan.languages.titleBg}"><svg><use xlink:href="#iconImage"></use></svg></span>
    </div>
</div>`,this.tagsElement=this.element.querySelector(".b3-chips"),this.iconElement=this.element.querySelector(".protyle-background__icon"),this.imgElement=this.element.firstElementChild.firstElementChild,this.element.addEventListener("dragover",n=>Sa(this,null,function*(){n.preventDefault()})),this.element.addEventListener("drop",n=>Sa(this,null,function*(){n.dataTransfer.types[0]==="Files"&&n.dataTransfer.files[0].type.indexOf("image")!==-1&&uploadFiles(t,[n.dataTransfer.files[0]],void 0,s=>{const a=JSON.parse(s),i=`background-image:url("${a.data.succMap[Object.keys(a.data.succMap)[0]]}")`;this.ial["title-img"]=i,this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":i}})})})),this.imgElement.addEventListener("mousedown",n=>{if(n.preventDefault(),!this.element.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none"))return;const s=n.clientY,a=document,i=this.imgElement.naturalHeight*this.imgElement.clientWidth/this.imgElement.naturalWidth-this.imgElement.clientHeight;let l=parseFloat(this.imgElement.style.objectPosition.substring(7))||50;this.imgElement.style.objectPosition.endsWith("px")&&(l=-parseInt(this.imgElement.style.objectPosition.substring(7))/i*100),a.onmousemove=o=>{this.imgElement.style.objectPosition=`center ${((s-o.clientY)/i*100+l).toFixed(2)}%`,n.preventDefault()},a.onmouseup=()=>{a.onmousemove=null,a.onmouseup=null,a.ondragstart=null,a.onselectstart=null,a.onselect=null}}),this.element.querySelector("input").addEventListener("change",n=>{n.target.files.length!==0&&uploadFiles(t,n.target.files,n.target,s=>{const a=JSON.parse(s),i=`background-image:url("${a.data.succMap[Object.keys(a.data.succMap)[0]]}")`;this.ial["title-img"]=i,this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":i}})})}),this.element.addEventListener(getEventName(),n=>{if(t.disabled)return;let s=n.target;for(hideElements(["gutter"],t);s&&!s.isEqualNode(this.element);){const a=s.getAttribute("data-type");if(s.tagName==="IMG"){const i=s.getAttribute("src");n.detail>1&&!i.startsWith("data:image/png;base64")&&previewImage(i),window.siyuan.menus.menu.remove(),n.preventDefault(),n.stopPropagation();break}else if(a==="position"){const i=this.element.firstElementChild.querySelectorAll(".protyle-icons");i[0].classList.add("fn__none"),i[1].classList.remove("fn__none"),i[2].classList.remove("fn__none"),this.imgElement.style.cursor="move",n.preventDefault(),n.stopPropagation();break}else if(a==="cancel"||a==="confirm"){this.imgElement.style.cursor="";const i=this.element.firstElementChild.querySelectorAll(".protyle-icons");if(i[0].classList.remove("fn__none"),i[1].classList.add("fn__none"),i[2].classList.add("fn__none"),a==="confirm"){const l=`background-image:url("${this.imgElement.getAttribute("src")}");object-position:${this.imgElement.style.objectPosition}`;this.ial["title-img"]=l,fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":l}})}else this.render(this.ial,t.block.rootID);n.preventDefault(),n.stopPropagation();break}else if(a==="open-emoji"){const i=this.iconElement.getBoundingClientRect();openEmojiPanel(t.block.rootID,"doc",{x:i.left,y:i.bottom,h:i.height,w:i.width}),n.preventDefault(),n.stopPropagation();break}else if(a==="show-random"){let i="";Ht.forEach((o,r)=>{i+=`<div data-index="${r}" style="height: 148px;width: 148px;${o}" class="b3-card"></div>`});const l=new Dialog({title:window.siyuan.languages.random,content:`<div class="b3-cards" style="margin-right: 0">${i}</div>`,width:isMobile()?"92vw":"912px",height:isMobile()?"80vh":"70vh"});l.element.setAttribute("data-key",Constants.DIALOG_BACKGROUNDRANDOM),l.element.addEventListener("click",o=>{const r=o.target;r.classList.contains("b3-card")&&(this.ial["title-img"]=Ht[parseInt(r.getAttribute("data-index"))],this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),l.destroy())}),n.preventDefault(),n.stopPropagation();break}else if(a==="random"){this.ial["title-img"]=Ht[getRandom(0,Ht.length-1)],this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),n.preventDefault(),n.stopPropagation();break}else if(a==="asset"){const i=s.getBoundingClientRect();assetMenu(t,{x:s.parentElement.getBoundingClientRect().right,y:i.bottom+8,isLeft:!0},l=>{this.ial["title-img"]=`background-image:url("${l}")`,this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),window.siyuan.menus.menu.remove()},Constants.SIYUAN_ASSETS_IMAGE),n.preventDefault(),n.stopPropagation();break}else if(a==="remove"){delete this.ial["title-img"],this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":""}}),n.preventDefault(),n.stopPropagation();break}else if(a==="icon"){const i=getRandomEmoji();i&&(updateFileTreeEmoji(i,t.block.rootID),updateOutlineEmoji(i,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{icon:i}}),t.model&&t.model.parent.setDocIcon(i)),n.preventDefault(),n.stopPropagation();break}else if(a==="tag"){this.openTag(t),n.preventDefault(),n.stopPropagation();break}else if(a==="link"){const i=new Dialog({title:window.siyuan.languages.link,width:isMobile()?"92vw":"520px",content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" value="${this.imgElement.src.startsWith("data:")?"":this.imgElement.getAttribute("src")}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`});i.element.setAttribute("data-key",Constants.DIALOG_BACKGROUNDLINK);const l=i.element.querySelectorAll(".b3-button");l[0].addEventListener("click",()=>{i.destroy()}),l[1].addEventListener("click",()=>{const o=`background-image:url("${i.element.querySelector("input").value}");`;this.ial["title-img"]=o,this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),i.destroy()}),i.element.querySelector("input").focus(),n.preventDefault(),n.stopPropagation();break}else if(a==="open-search"){const i=window.siyuan.storage[Constants.LOCAL_SEARCHDATA];popSearch(t.app,{removed:i.removed,sort:i.sort,group:i.group,hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${s.textContent}#`,r:"",page:1,types:Object.assign({},i.types),replaceTypes:Object.assign({},i.replaceTypes)}),n.preventDefault(),n.stopPropagation();break}else if(a==="remove-tag"){s.parentElement.remove(),this.removeTag(t),n.preventDefault(),n.stopPropagation();break}s=s.parentElement}})}removeTag(t){const n=this.getTags();fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{tags:n.toString()}}),n.length===0?delete this.ial.tags:this.ial.tags=n.toString(),this.render(this.ial,t.block.rootID)}render(t,n){var s;const a=t["title-img"],i=t.icon,l=t.tags;if(this.ial=t,this.element.setAttribute("data-node-id",n),l){let o="";const r=["secondary","primary","info","success","warning","error","pink"];l.split(",").forEach((c,f)=>{o+=`<div class="b3-chip b3-chip--middle b3-chip--pointer b3-chip--${r[f%7]}" data-type="open-search">${c}<svg class="b3-chip__close" data-type="remove-tag"><use xlink:href="#iconCloseRound"></use></svg></div>`}),this.tagsElement.innerHTML=o}else this.tagsElement.innerHTML="";if(i?(this.iconElement.classList.remove("fn__none"),this.iconElement.innerHTML=unicode2Emoji(i)):this.iconElement.classList.add("fn__none"),a)if(this.imgElement.classList.remove("fn__none"),this.imgElement.setAttribute("style",Lute.UnEscapeHTMLStr(a)),a.indexOf("url(")>-1){const o=this.imgElement.style.backgroundPosition||this.imgElement.style.objectPosition,r=(s=this.imgElement.style.backgroundImage)==null?void 0:s.replace(/^url\(["']?/,"").replace(/["']?\)$/,"");this.imgElement.removeAttribute("style"),this.imgElement.setAttribute("src",r),this.imgElement.style.objectPosition=o,this.element.querySelector('[data-type="position"]').classList.remove("fn__none")}else this.imgElement.setAttribute("src",this.transparentData),this.element.querySelector('[data-type="position"]').classList.add("fn__none");else this.imgElement.classList.add("fn__none");a?this.element.style.minHeight=isMobile()?"200px":"30vh":i?this.element.style.minHeight=this.tagsElement.clientHeight+56+"px":l?this.element.style.minHeight=this.tagsElement.clientHeight+"px":this.element.style.minHeight="0"}openTag(t){fetchPost("/api/search/searchTag",{k:""},n=>{let s="";n.data.tags.forEach((o,r)=>{s+=`<div class="b3-list-item${r===0?" b3-list-item--focus":""}">${o}</div>`}),window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.lastElementChild.innerHTML=`<div class="fn__flex-column" style="max-height:50vh;margin: 0 -8px"><input style="margin: 0px 8px 4px 8px" class="b3-text-field"/>
<div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${s}</div>
</div>`;const a=window.siyuan.menus.menu.element.querySelector(".b3-list--background"),i=window.siyuan.menus.menu.element.querySelector("input");i.addEventListener("keydown",o=>{if(o.stopPropagation(),!o.isComposing)if(upDownHint(a,o),o.key==="Enter"){const r=a.querySelector(".b3-list-item--focus");r?this.addTags(r.textContent,t):this.addTags(i.value,t),window.siyuan.menus.menu.remove()}else o.key==="Escape"&&window.siyuan.menus.menu.remove()}),i.addEventListener("input",o=>{o.stopPropagation(),fetchPost("/api/search/searchTag",{k:i.value},r=>{let c="",f=!1;r.data.tags.forEach(u=>{c+=`<div class="b3-list-item">${u}</div>`,u===`<mark>${r.data.k}</mark>`&&(f=!0)}),!f&&r.data.k&&(c=`<div class="b3-list-item"><mark>${r.data.k}</mark></div>`+c),a.innerHTML=c,a.firstElementChild.classList.add("b3-list-item--focus")})}),a.addEventListener("click",o=>{const r=o.target,c=hasClosestByClassName(r,"b3-list-item");c&&this.addTags(c.textContent,t)});const l=this.iconElement.nextElementSibling.getBoundingClientRect();window.siyuan.menus.menu.popup({x:l.left,y:l.top+l.height}),i.focus()})}getTags(t){const n=[];return this.tagsElement.querySelectorAll(".b3-chip").forEach(s=>{const a=s.textContent.trim();t&&a===t&&s.remove(),n.push(a)}),n}addTags(t,n){const s=this.getTags(t);if(s.includes(t)){this.removeTag(n);return}s.push(t),fetchPost("/api/attr/setBlockAttrs",{id:n.block.rootID,attrs:{tags:s.toString()}}),this.ial.tags=s.toString(),this.render(this.ial,n.block.rootID)}}class Nd{constructor(t,n,s){this.version=Constants.SIYUAN_VERSION;let a=s;t.plugins.forEach(o=>{o.protyleOptions&&(a=merge(a,o.protyleOptions))});const l=new Options(a).merge();if(this.protyle={getInstance:()=>this,app:t,transactionTime:new Date().getTime(),id:genUUID(),disabled:!1,updated:!1,element:n,options:l,block:{}},this.protyle.hint=new Hint(this.protyle),l.render.breadcrumb&&(this.protyle.breadcrumb=new Breadcrumb(this.protyle)),l.render.background&&(this.protyle.background=new Background(this.protyle)),this.protyle.element.innerHTML="",this.protyle.element.classList.add("protyle"),l.render.breadcrumb&&this.protyle.element.appendChild(this.protyle.breadcrumb.element.parentElement),this.protyle.undo=new Undo,this.protyle.wysiwyg=new WYSIWYG(this.protyle),this.protyle.toolbar=new Toolbar(this.protyle),this.protyle.scroll=new Scroll(this.protyle),this.protyle.options.render.gutter&&(this.protyle.gutter=new Gutter(this.protyle)),(l.upload.url||l.upload.handler)&&(this.protyle.upload=new Upload),this.init(),l.action.includes(Constants.CB_GET_HISTORY))this.protyle.contentElement.classList.add("protyle-content--transition");else{if(this.protyle.ws=new Model({app:t,id:this.protyle.id,type:"protyle",msgCallback:o=>{switch(o.cmd){case"reload":o.data===this.protyle.block.rootID&&reloadProtyle(this.protyle,!1);break;case"refreshAttributeView":Array.from(this.protyle.wysiwyg.element.querySelectorAll(`[data-av-id="${o.data.id}"]`)).forEach(r=>{r.removeAttribute("data-render"),avRender(r,this.protyle)});break;case"addLoading":o.data===this.protyle.block.rootID&&addLoading(this.protyle,o.msg);break;case"transactions":o.data[0].doOperations.forEach(r=>{!this.protyle.preview.element.classList.contains("fn__none")&&r.action!=="updateAttrs"?this.protyle.preview.render(this.protyle):onTransaction(this.protyle,r,!1)});break;case"readonly":window.siyuan.config.editor.readOnly=o.data,setReadonlyByConfig(this.protyle,!0);break;case"heading2doc":case"li2doc":this.protyle.block.rootID===o.data.srcRootBlockID&&(this.protyle.block.showAll&&o.cmd==="heading2doc"&&!this.protyle.options.backlinkData?fetchPost("/api/filetree/getDoc",{id:this.protyle.block.rootID,size:window.siyuan.config.editor.dynamicLoadBlocks},r=>{onGet({data:r,protyle:this.protyle})}):reloadProtyle(this.protyle,!1));break;case"rename":this.protyle.path===o.data.path&&(this.protyle.model&&this.protyle.model.parent.updateTitle(o.data.title),this.protyle.background&&(this.protyle.background.ial.title=o.data.title)),this.protyle.options.render.title&&this.protyle.block.parentID===o.data.id&&(getSelection().rangeCount>0&&this.protyle.title.editElement.contains(getSelection().getRangeAt(0).startContainer)||this.protyle.title.setTitle(o.data.title)),this.protyle.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${o.data.id}"]`).forEach(r=>{r.getAttribute("data-subtype")==="d"&&(r.textContent=o.data.refText)});break;case"moveDoc":this.protyle.path===o.data.fromPath&&(this.protyle.path=o.data.newPath,this.protyle.notebookId=o.data.toNotebook);break;case"unmount":this.protyle.notebookId===o.data.box&&setEmpty(t);break;case"removeDoc":o.data.ids.includes(this.protyle.block.rootID)&&(setEmpty(t),delete window.siyuan.storage[Constants.LOCAL_FILEPOSITION][this.protyle.block.rootID],setStorageVal(Constants.LOCAL_FILEPOSITION,window.siyuan.storage[Constants.LOCAL_FILEPOSITION]));break}}}),s.backlinkData){this.protyle.block.rootID=s.blockId,renderBacklink(this.protyle,s.backlinkData);return}if(!s.blockId){removeLoading(this.protyle);return}this.protyle.options.mode!=="preview"&&s.rootId&&window.siyuan.storage[Constants.LOCAL_FILEPOSITION][s.rootId]&&(l.action.includes(Constants.CB_GET_SCROLL)||l.action.includes(Constants.CB_GET_ROOTSCROLL)&&s.rootId===s.blockId)?getDocByScroll({protyle:this.protyle,scrollAttr:window.siyuan.storage[Constants.LOCAL_FILEPOSITION][s.rootId],mergedOptions:l,cb:()=>{this.afterOnGet(l)}}):this.getDoc(l)}}getDoc(t){var n;fetchPost("/api/filetree/getDoc",{id:t.blockId,isBacklink:t.action.includes(Constants.CB_GET_BACKLINK),mode:t.action&&t.action.includes(Constants.CB_GET_CONTEXT)?3:0,size:(n=t.action)!=null&&n.includes(Constants.CB_GET_ALL)?Constants.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks},s=>{onGet({data:s,protyle:this.protyle,action:t.action,afterCB:()=>{this.afterOnGet(t)}})})}afterOnGet(t){this.protyle.model,resize(this.protyle),this.protyle.wysiwyg.element.addEventListener("focusin",()=>{}),t.after&&t.after(this),this.protyle.contentElement.classList.add("protyle-content--transition")}init(){this.protyle.lute=setLute({emojiSite:this.protyle.options.hint.emojiPath,emojis:this.protyle.options.hint.emoji,headingAnchor:!1,listStyle:this.protyle.options.preview.markdown.listStyle,paragraphBeginningSpace:this.protyle.options.preview.markdown.paragraphBeginningSpace,sanitize:this.protyle.options.preview.markdown.sanitize}),this.protyle.preview=new Preview(this.protyle),initUI(this.protyle)}focus(){this.protyle.wysiwyg.element.focus()}isUploading(){return this.protyle.upload.isUploading}clearStack(){this.protyle.undo.clear()}destroy(){destroy(this.protyle)}resize(){resize(this.protyle)}reload(t){reloadProtyle(this.protyle,t)}insert(t,n=!1,s=!1){insertHTML(t,this.protyle,n,s)}transaction(t,n){transaction(this.protyle,t,n)}turnIntoOneTransaction(t,n,s){turnsIntoOneTransaction({protyle:this.protyle,selectsElement:t,type:n,level:s})}turnIntoTransaction(t,n,s){turnsIntoTransaction({protyle:this.protyle,nodeElement:t,type:n,level:s})}updateTransaction(t,n,s){updateTransaction(this.protyle,t,n,s)}updateBatchTransaction(t,n){updateBatchTransaction(t,this.protyle,n)}getRange(t){return getEditorRange(t)}hasClosestBlock(t){return hasClosestBlock(t)}focusBlock(t,n=!0){return focusBlock(t,void 0,n)}}const Bd=()=>window.siyuan.mobile.popEditor||window.siyuan.mobile.editor,Pd=(e,t,n=[Constants.CB_GET_HL])=>{if(window.siyuan.storage[Constants.LOCAL_DOCINFO]={id:t},setStorageVal(Constants.LOCAL_DOCINFO,window.siyuan.storage[Constants.LOCAL_DOCINFO]),window.siyuan.mobile.editor){saveScroll(window.siyuan.mobile.editor.protyle),hideElements(["toolbar","hint","util"],window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.contentElement.classList.contains("fn__none")&&setEditMode(window.siyuan.mobile.editor.protyle,"wysiwyg");let s;if(Array.from(window.siyuan.mobile.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${t}"]`)).find(a=>{if(!hasClosestByAttribute(a.parentElement,"data-type","NodeBlockQueryEmbed"))return s=a,!0}),s){pushBack(),scrollCenter(window.siyuan.mobile.editor.protyle,s,!0),closePanel();return}}fetchPost("/api/block/getBlockInfo",{id:t},s=>{if(s.code===3){showMessage(s.msg);return}const a={blockId:t,rootId:s.data.rootID,action:n,render:{scroll:!0,background:!0,gutter:!0},typewriterMode:!0,preview:{actions:["mp-wechat","zhihu"]}};window.siyuan.mobile.editor?(pushBack(),addLoading(window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.block.rootID!==s.data.rootID&&(window.siyuan.mobile.editor.protyle.wysiwyg.element.innerHTML=""),n.includes(Constants.CB_GET_SCROLL)&&window.siyuan.storage[Constants.LOCAL_FILEPOSITION][s.data.rootID]?getDocByScroll({protyle:window.siyuan.mobile.editor.protyle,scrollAttr:window.siyuan.storage[Constants.LOCAL_FILEPOSITION][s.data.rootID],mergedOptions:a}):fetchPost("/api/filetree/getDoc",{id:t,size:n.includes(Constants.CB_GET_ALL)?Constants.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks,mode:n.includes(Constants.CB_GET_CONTEXT)?3:0},i=>{onGet({data:i,protyle:window.siyuan.mobile.editor.protyle,action:n})}),window.siyuan.mobile.editor.protyle.undo.clear()):window.siyuan.mobile.editor=new Protyle(e,document.getElementById("editor"),a),document.getElementById("toolbarName").value=s.data.rootTitle==="Untitled"?"":s.data.rootTitle,setEditor(),closePanel()})},Rd=(e,t,n=!1)=>{if(!t){if(e.includes("dialog"))for(let s=0;s<window.siyuan.dialogs.length;s++)window.siyuan.dialogs[s].destroy(),s--;return}if(e.includes("hint")&&(clearTimeout(t.hint.timeId),t.hint.element.classList.add("fn__none")),t.gutter&&e.includes("gutter")&&(t.gutter.element.classList.add("fn__none"),t.gutter.element.innerHTML="",t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(s=>{s.classList.remove("protyle-wysiwyg--hl")})),t.toolbar&&e.includes("toolbar")&&(t.toolbar.element.classList.add("fn__none"),t.toolbar.element.style.display=""),t.toolbar&&e.includes("util")){const s=t.toolbar.subElement.querySelector('[data-type="pin"]');(n||!s||s&&s.getAttribute("aria-label")===window.siyuan.languages.pin)&&(t.toolbar.subElement.classList.add("fn__none"),t.toolbar.subElementCloseCB&&(t.toolbar.subElementCloseCB(),t.toolbar.subElementCloseCB=void 0))}e.includes("select")&&t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(s=>{s.classList.remove("protyle-wysiwyg--select"),s.removeAttribute("select-start"),s.removeAttribute("select-end")})},Od=e=>{if(e.includes("toolbar")&&document.querySelectorAll(".protyle-toolbar").forEach(t=>{t.classList.add("fn__none"),t.style.display=""}),e.includes("util")){const t=getCurrentEditor();t&&(t.protyle.toolbar.subElement.classList.add("fn__none"),t.protyle.toolbar.subElementCloseCB&&(t.protyle.toolbar.subElementCloseCB(),t.protyle.toolbar.subElementCloseCB=void 0))}e.includes("pdfutil")&&document.querySelectorAll(".pdf__util").forEach(t=>{t.classList.add("fn__none")}),e.includes("gutter")&&document.querySelectorAll(".protyle-gutters").forEach(t=>{t.classList.add("fn__none"),t.innerHTML=""})},Ii=(e,t)=>{if(!t){if(getSelection().rangeCount===0)return!1;t=getSelection().getRangeAt(0)}const n=t.commonAncestorContainer;return e.isEqualNode(n)||e.contains(n)},qd=e=>{const t=hasClosestByAttribute(e.startContainer,"data-type","NodeTable");if(e.toString()!==""&&t&&e.commonAncestorContainer.nodeType!==3){const n=e.commonAncestorContainer.tagName;if(n!=="TH"&&n!=="TD"){const s=hasClosestByMatchTag(e.startContainer,"TD")||hasClosestByMatchTag(e.startContainer,"TH"),a=hasClosestByMatchTag(e.endContainer,"TD")||hasClosestByMatchTag(e.endContainer,"TH");if(!s&&!a){const i=t.querySelector("th")||t.querySelector("td");e.setStart(i.firstChild,0),e.setEnd(i.lastChild,i.lastChild.textContent.length)}else s&&!s.contains(e.endContainer)&&Bt(s,e,!1)}}},Fd=(e,t,n)=>{const s=getContenteditableElement(t);if(s){let l;if(s.tagName==="TABLE"){const o=hasClosestByMatchTag(n.startContainer,"TD")||hasClosestByMatchTag(n.startContainer,"TH");if(o&&(l=xa(o,t,n),l.start!==0||l.end!==o.textContent.length))return n.setStart(o.firstChild,0),n.setEndAfter(o.lastChild),e.toolbar.render(e,n),countSelectWord(n,e.block.rootID),!0}else if(l=xa(s,t,n),l.start!==0||l.end!==s.textContent.length){let o=s.firstChild;for(;o;)if(o.nodeType===3){if(o.textContent!==""){n.setStart(o,0);break}o=o.nextSibling}else{if(o.classList.contains("render-node")||o.classList.contains("img")){n.setStartBefore(o);break}o=o.firstChild}let r=s.lastChild;for(;r;)if(r.nodeType===3){if(r.textContent!==""){n.setEnd(r,r.textContent.length);break}r=r.previousSibling}else{if(r.classList.contains("render-node")||r.classList.contains("img")||r.tagName==="BR"){n.setEndAfter(r);break}r=r.lastChild}return Xe(n),e.toolbar.render(e,n),countSelectWord(n,e.block.rootID),!0}}n.collapse(!0);const a=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.wysiwyg.element.childElementCount===a.length&&a[0].parentElement.isSameNode(e.wysiwyg.element))return!0;hideElements(["select"],e);const i=[];Array.from(e.wysiwyg.element.children).forEach(l=>{l.classList.add("protyle-wysiwyg--select"),i.push(l.getAttribute("data-node-id"))}),countBlockWord(i,e.block.rootID)},Yd=(e,t)=>{const n=document.caretRangeFromPoint(e,t),s=hasClosestByAttribute(n.startContainer,"data-type","img");return s&&(n.setStart(s.nextSibling,0),n.collapse()),n},vt=e=>{let t;if(getSelection().rangeCount>0&&(t=getSelection().getRangeAt(0),e.isSameNode(t.startContainer)||e.contains(t.startContainer)))return t;e.focus({preventScroll:!0});let n;return e.classList.contains("table")?n=e.querySelector("th")||e.querySelector("td"):(n=ce(e),n?n.tagName==="TABLE"&&(n=n.querySelector("th")||e.querySelector("td")):n=e),t=n.ownerDocument.createRange(),t.setStart(n||e,0),t.collapse(!0),t},Wd=(e,t)=>{var n,s;if(t||(t=vt(e)),!e.contains(t.startContainer))return{left:0,top:0};let a;if(t.getClientRects().length===0)if(t.startContainer.nodeType===3){const i=(n=t.startContainer.parentElement)==null?void 0:n.getClientRects(),l=(s=t.startContainer.previousElementSibling)==null?void 0:s.getClientRects();if(i.length>0||l.length>0)i.length===0||l&&l.length>0&&i[0].top<l[l.length-1].bottom?a={left:l[l.length-1].left,top:l[l.length-1].bottom}:a=i[0];else return{left:0,top:0}}else{const i=t.startContainer.children;if(i[t.startOffset]&&i[t.startOffset].getClientRects().length>0)a=i[t.startOffset].getClientRects()[0];else if(t.startContainer.childNodes.length>0){const l=t.cloneRange();t.selectNode(t.startContainer.childNodes[Math.max(0,t.startOffset-1)]),a=t.getClientRects()[0],t.setEnd(l.endContainer,l.endOffset),t.setStart(l.startContainer,l.startOffset)}else a=t.startContainer.getClientRects()[0];if(!a){let l=t.startContainer.childNodes[t.startOffset];if(l||(l=t.startContainer.childNodes[t.startOffset-1]),!l)a=t.getBoundingClientRect();else{for(;!l.getClientRects||l.getClientRects&&l.getClientRects().length===0;)l=l.parentElement;a=l.getClientRects()[0]}}}else{const i=t.getClientRects();return{left:i[i.length-1].left,top:i[0].top}}return{left:a.left,top:a.top}},xa=(e,t,n)=>{const s={end:0,start:0};if(!n){if(getSelection().rangeCount===0)return s;n=window.getSelection().getRangeAt(0)}if(t&&!Ii(t,n))return s;const a=n.cloneRange();return e.childNodes[0]&&e.childNodes[0].childNodes[0]?a.setStart(e.childNodes[0].childNodes[0],0):a.selectNodeContents(e),a.setEnd(n.startContainer,n.startOffset),s.start=a.toString().length,s.end=s.start+n.toString().length,s};function Nt(e,t,n,s){if(!t)return!1;if(n(t))return!0;for(let a=0,i=t.childNodes.length;a<i;a++)if(Nt(t,t.childNodes[a],n,!0))return!0;if(!s){let a=t;for(;a&&a!==e;){let i=a.nextSibling;for(;i;){if(Nt(e,i,n,!0))return!0;i=i.nextSibling}a=a.parentNode}}return!1}const Bt=(e,t,n=!0)=>{if(!e)return t;let s=e.lastChild;for(;s&&s.nodeType!==3;)s=s.lastChild;return s?(n?t.setStart(s,s.textContent.length):t.setEnd(s,s.textContent.length),t):(t.selectNodeContents(e),t)},Mi=(e,t)=>{if(!e)return t;let n=e.firstChild;for(;n&&n.nodeType!==3&&!n.classList.contains("render-node");){if(n.classList.contains("img"))return t.setStartBefore(n),t;n=n.firstChild}return n?(n.nodeType!==3&&n.classList.contains("render-node")?t.setStartBefore(n):t.setStart(n,0),t):(t.selectNodeContents(e),t)},Di=(e,t,n)=>{if(!e)return!1;const s=ce(e);if(s)e=s;else if(de(e)||e.classList.contains("av"))return Pt(e);let a;Nt(e,e.firstChild,o=>{if(o.nodeType===Node.TEXT_NODE){const r=o.data.length;return t<=r?(a=o,!0):(t-=r,n-=r,!1)}});let i;a&&Nt(e,a,o=>{if(o.nodeType===Node.TEXT_NODE){const r=o.data.length;return n<=r?(i=o,!0):(n-=r,!1)}});const l=document.createRange();return a?t<a.data.length?l.setStart(a,t):l.setStartAfter(a):t===0?l.setStart(e,0):Bt(ce(e),l),i?n<i.data.length?l.setEnd(i,n):l.setEndAfter(i):n===0?l.setEnd(e,0):Bt(ce(e),l,!1),Xe(l),l},jd=(e,t)=>{var n;const s=e.querySelectorAll("wbr");if(s.length===0)return;s.forEach((i,l)=>{l!==0&&i.remove()});const a=s[0];if(!a.previousElementSibling)a.previousSibling?t.setStart(a.previousSibling,a.previousSibling.textContent.length):a.nextSibling?a.nextSibling.nodeType===3?t.setStart(a.nextSibling,0):t.setStartAfter(a):t.setStart(a.parentElement,0);else{const i=hasPreviousSibling(a);i&&a.previousElementSibling.isSameNode(i)?((n=a.previousElementSibling.lastChild)==null?void 0:n.nodeType)===3?t.setStart(a.previousElementSibling.lastChild,a.previousElementSibling.lastChild.textContent.length):i.nodeType!==3&&i.classList.contains("img")?t.setStartAfter(i):t.setStartBefore(a):t.setStart(a.previousSibling,a.previousSibling.textContent.length)}t.collapse(!0),a.remove(),Xe(t)},Xe=e=>{if(!e)return;const t=e.startContainer.childNodes[e.startOffset];if(t&&t.nodeType!==3&&["INPUT","TEXTAREA"].includes(t.tagName)){t.focus();return}const n=window.getSelection();n.removeAllRanges(),n.addRange(e)},Pt=(e,t,n=!0)=>{var s,a,i;if(!e)return!1;if(e.classList.contains("render-node")||e.classList.contains("iframe")||e.classList.contains("hr")){const o=document.createRange(),r=e.getAttribute("data-type");let c=!1;return r==="NodeThematicBreak"?(o.selectNodeContents(e.firstElementChild),c=!0):r==="NodeBlockQueryEmbed"?((s=e.lastElementChild.previousElementSibling)!=null&&s.firstChild?(o.selectNodeContents(e.lastElementChild.previousElementSibling.firstChild),o.collapse(!0)):(o.selectNodeContents(e),o.collapse(!0)),c=!0):["NodeMathBlock","NodeHTMLBlock"].includes(r)?((i=(a=e.lastElementChild.previousElementSibling)==null?void 0:a.lastElementChild)!=null&&i.firstChild?(o.selectNodeContents(e.lastElementChild.previousElementSibling.lastElementChild.firstChild),o.collapse(!0)):e.lastElementChild.previousElementSibling&&(o.selectNodeContents(e.lastElementChild.previousElementSibling),o.collapse(!0)),c=!0):r==="NodeIFrame"||r==="NodeWidget"?(o.setStart(e,0),c=!0):r==="NodeVideo"?(o.setStart(e.firstElementChild,0),c=!0):r==="NodeAudio"?(o.setStart(e.firstElementChild.lastChild,0),c=!0):r==="NodeCodeBlock"&&(o.selectNodeContents(e),o.collapse(!0),c=!0),c?(Xe(o),o):($i(e),!1)}else if(e.classList.contains("av")){const o=e.querySelector(".av__title");if(o){const r=document.createRange();return r.selectNodeContents(o),r.collapse(),Xe(r),r}else return!1}let l;if(n?l=ce(e):Array.from(e.querySelectorAll('[contenteditable="true"]')).reverse().find(o=>{if(o.getBoundingClientRect().width>0)return l=o,!0}),l){if(l.tagName==="TABLE")if(n)l=l.querySelector("th, td");else{const r=l.querySelectorAll("th, td");l=r[r.length-1]}let o;if(n)o=Mi(l,vt(l)),o.collapse(!0);else{let r=!1;if(l.classList.contains("hljs")){let c=l.lastChild;c||(l.innerHTML=`
`,c=l.lastChild),c.textContent===""&&c.nodeType===3&&(c=qe(l.lastChild)),c&&c.textContent.endsWith(`
`)&&(o=vt(l),o.setStart(c,c.textContent.length-1),r=!0)}r||(o=Bt(l,vt(l))),o.collapse(!1)}return Xe(o),o}else t&&t.focus();return!1},$i=e=>{if(e.getAttribute("data-node-id")){let n,s;e.nextElementSibling&&!e.nextElementSibling.classList.contains("protyle-attr")?(s=!0,n=X(e)):e.previousElementSibling&&(s=!1,n=Z(e)),n||(n=e),Pt(n,void 0,s);return}const t=vt(e);e.nextSibling?(t.selectNodeContents(e.nextSibling),t.collapse(!0)):e.previousSibling&&(t.selectNodeContents(e.previousSibling),t.collapse(!1)),Xe(t)},Hi=(e,t=L.PROTYLE_CDN)=>{let n,s=!1;e.classList.contains("code-block")?n=e.querySelectorAll("[spellcheck]"):e.classList.contains("item__readme")?(n=e.querySelectorAll("pre code"),n.forEach(a=>{a.parentElement.setAttribute("lineNumber","false")})):e.classList.contains("b3-typography")?(n=e.querySelectorAll(".code-block code"),s=!0):n=e.querySelectorAll(".code-block [spellcheck]"),n.length!==0&&(aa(t),J(`${t}/js/highlight.js/highlight.min.js?v=11.7.0`,"protyleHljsScript").then(()=>{J(`${t}/js/highlight.js/third-languages.js?v=1.0.1`,"protyleHljsThirdScript").then(()=>{n.forEach(a=>{var i,l;const o=a.parentElement.querySelectorAll(".protyle-icon");if(o.length===2&&(o[0].setAttribute("aria-label",window.siyuan.languages.copy),o[1].setAttribute("aria-label",window.siyuan.languages.more)),a.getAttribute("data-render")==="true")return;const r=a.querySelector("wbr");let c=0;if(r){let m=r.previousSibling;for(;m;){for(c+=m.textContent.length;!m.previousSibling&&m.parentElement.tagName!=="DIV";)m=m.parentElement;m=m.previousSibling}r.remove()}let f;s?f=a.parentElement.getAttribute("data-language"):a.previousElementSibling?f=a.previousElementSibling.firstElementChild.textContent:f=a.className.replace("language-",""),window.hljs.getLanguage(f)||(f="plaintext"),a.classList.add("hljs"),a.setAttribute("data-render","true");const u=a.parentElement.getAttribute("linewrap"),d=a.parentElement.getAttribute("ligatures"),g=a.parentElement.getAttribute("linenumber");u==="true"||u!=="false"&&window.siyuan.config.editor.codeLineWrap?(a.style.setProperty("white-space","pre-wrap"),a.style.setProperty("word-break","break-all")):(a.style.setProperty("white-space","pre"),a.style.setProperty("word-break","initial")),d==="true"||d!=="false"&&window.siyuan.config.editor.codeLigatures?a.style.fontVariantLigatures="normal":a.style.fontVariantLigatures="none";const p=a.parentElement.querySelector(".protyle-action__language");!s&&(g==="true"||g!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum)?(a.classList.add("protyle-linenumber"),Ni(a),p&&(p.style.marginLeft="3.6em")):(i=a.nextElementSibling)!=null&&i.classList.contains("protyle-linenumber__rows")&&(a.classList.remove("protyle-linenumber"),a.nextElementSibling.remove(),p&&(p.style.marginLeft=""));const b=N(a,"search__layout",!0);if(b&&a.parentElement.getAttribute("data-node-id")===((l=b.querySelector("#searchList > .b3-list-item--focus"))==null?void 0:l.getAttribute("data-node-id"))){const m=a.querySelector('span[data-type="search-mark"]');m&&m.scrollIntoView()}a.innerHTML=window.hljs.highlight(a.textContent+(a.textContent.endsWith(`
`)?"":`
`),{language:f,ignoreIllegals:!0}).value,r&&getSelection().rangeCount>0&&Di(a,c,c)})})}))},Ni=e=>{var t;if(e.parentElement.getAttribute("lineNumber")==="false")return;e.classList.add("protyle-linenumber"),e.parentElement.style.lineHeight=`${((parseInt(e.parentElement.style.fontSize)||window.siyuan.config.editor.fontSize)*1.625*.85).toFixed(0)}px`;const n=document.createElement("div");n.className="hljs protyle-linenumber",n.setAttribute("style",`box-sizing: border-box;width: calc(100% - 3.6em);position: absolute;padding-top:0 !important;padding-bottom:0 !important;min-height:auto !important;white-space:${e.style.whiteSpace};word-break:${e.style.wordBreak};font-variant-ligatures:${e.style.fontVariantLigatures};`),n.setAttribute("contenteditable","true"),e.insertAdjacentElement("afterend",n);let s="";const a=e.textContent.split(/\r\n|\r|\n|\u2028|\u2029/g);a[a.length-1]===""&&a.length>1&&a.pop();const i=e.style.wordBreak==="break-all";a.map(l=>{let o="";i&&(n.textContent=l||`
`,o=` style="height:${n.clientHeight}px;"`),s+=`<span${o}></span>`}),n.remove(),(t=e.nextElementSibling)!=null&&t.classList.contains("protyle-linenumber__rows")?e.nextElementSibling.innerHTML=s:e.insertAdjacentHTML("afterend",`<span contenteditable="false" class="protyle-linenumber__rows">${s}</span>`)},Bi=e=>{let t=[];e.getAttribute("data-type")==="NodeHTMLBlock"?t=[e]:t=Array.from(e.querySelectorAll('[data-type="NodeHTMLBlock"]')),t.length!==0&&t.length>0&&t.forEach(n=>{n.firstElementChild.firstElementChild.setAttribute("aria-label",window.siyuan.languages.edit),n.firstElementChild.lastElementChild.setAttribute("aria-label",window.siyuan.languages.more)})};class Se{}Se.graphvizRender=lt,Se.highlightRender=Hi,Se.mathRender=Ya,Se.mermaidRender=Wa,Se.flowchartRender=Ua,Se.chartRender=Fa,Se.abcRender=Oa,Se.mindmapRender=ja,Se.plantumlRender=Va,Se.avRender=Wn,Se.htmlRender=Bi,window.Protyle=Se;const Pi=Se})(),kt=kt.default,kt})())});Oi();})();
